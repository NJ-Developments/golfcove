<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Cove - Customers & Members</title>
    <link rel="icon" type="image/png" href="images/golfCoveLogo6.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Unified Config & Core -->
    <script src="js/config-unified.js"></script>
    <script src="js/core.js"></script>
    <script src="js/services-unified.js"></script>
    <!-- Feature Modules -->
    <script src="js/firebase-sync.js"></script>
    <script src="js/validation-schemas.js"></script>
    <script src="js/customer-manager.js"></script>
    <script src="js/customers.js"></script>
    <script src="js/membership-system.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }
        
        /* Header */
        .header { background: #4a90a4; color: #fff; padding: 0 20px; display: flex; align-items: center; justify-content: space-between; height: 56px; position: sticky; top: 0; z-index: 100; }
        .header-left { display: flex; align-items: center; gap: 30px; }
        .header-logo { display: flex; align-items: center; gap: 10px; font-size: 1.2rem; font-weight: 700; text-decoration: none; color: #fff; }
        .header-logo img { height: 32px; }
        .header-nav { display: flex; gap: 3px; }
        .header-nav a { color: rgba(255,255,255,0.85); text-decoration: none; padding: 8px 14px; border-radius: 6px; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .header-nav a:hover { background: rgba(255,255,255,0.15); color: #fff; }
        .header-nav a.active { background: rgba(255,255,255,0.2); color: #fff; }
        .header-right { display: flex; align-items: center; gap: 15px; font-size: 13px; }
        
        /* Main Layout */
        .main { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        /* Search Section */
        .search-section { background: #fff; border-radius: 16px; padding: 24px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); }
        .search-row { display: flex; gap: 15px; align-items: center; }
        .search-box { flex: 1; position: relative; }
        .search-box input { width: 100%; padding: 14px 20px 14px 50px; border: 2px solid #e0e0e0; border-radius: 12px; font-size: 16px; transition: all 0.2s; }
        .search-box input:focus { border-color: #4a90a4; outline: none; box-shadow: 0 0 0 3px rgba(74,144,164,0.1); }
        .search-box i { position: absolute; left: 18px; top: 50%; transform: translateY(-50%); color: #999; font-size: 18px; }
        .search-filters { display: flex; gap: 8px; }
        .filter-chip { padding: 10px 16px; border: 1px solid #e0e0e0; background: #fff; border-radius: 20px; font-size: 13px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .filter-chip:hover { background: #f5f5f5; }
        .filter-chip.active { background: #4a90a4; color: #fff; border-color: #4a90a4; }
        .filter-chip .count { background: rgba(0,0,0,0.1); padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: 600; }
        .filter-chip.active .count { background: rgba(255,255,255,0.2); }
        .btn-new { padding: 14px 24px; background: #27ae60; color: #fff; border: none; border-radius: 12px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .btn-new:hover { background: #219a52; transform: translateY(-1px); }
        
        /* Results Grid */
        .results-info { padding: 10px 0; color: #666; font-size: 13px; }
        .customer-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 16px; }
        
        /* Customer Card */
        .customer-card { background: #fff; border-radius: 16px; overflow: hidden; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .customer-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.1); }
        .customer-card.selected { border-color: #4a90a4; box-shadow: 0 0 0 3px rgba(74,144,164,0.2); }
        
        .card-header { padding: 20px; display: flex; align-items: center; gap: 15px; }
        .card-avatar { width: 56px; height: 56px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; color: #fff; background: #bdc3c7; flex-shrink: 0; }
        .card-avatar.member { background: linear-gradient(135deg, #f1c40f 0%, #e67e22 100%); }
        .card-avatar.eagle { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); }
        .card-avatar.birdie { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
        .card-avatar.par { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .card-info { flex: 1; min-width: 0; }
        .card-name { font-size: 18px; font-weight: 600; color: #333; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .card-contact { font-size: 13px; color: #888; margin-top: 4px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
        .card-contact span { display: flex; align-items: center; gap: 4px; }
        
        /* Member Badge */
        .member-badge { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
        .member-badge.eagle { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: #fff; }
        .member-badge.birdie { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: #fff; }
        .member-badge.par { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: #fff; }
        .member-badge.expired { background: #e74c3c; color: #fff; }
        .member-badge.expiring { background: #f39c12; color: #fff; }
        
        /* Card Body - Quick Stats */
        .card-body { padding: 0 20px 15px; display: flex; gap: 20px; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 18px; font-weight: 700; color: #333; }
        .stat-label { font-size: 11px; color: #999; text-transform: uppercase; }
        
        /* Card Footer - Actions */
        .card-footer { padding: 12px 20px; background: #f8f9fa; display: flex; gap: 8px; border-top: 1px solid #eee; }
        .card-btn { flex: 1; padding: 8px; border: none; background: #fff; border-radius: 8px; font-size: 12px; cursor: pointer; transition: all 0.15s; display: flex; align-items: center; justify-content: center; gap: 5px; color: #666; border: 1px solid #e0e0e0; }
        .card-btn:hover { background: #4a90a4; color: #fff; border-color: #4a90a4; }
        .card-btn.primary { background: #4a90a4; color: #fff; border-color: #4a90a4; }
        .card-btn.primary:hover { background: #3d7a8c; }
        
        /* Customer Detail Modal - Clean Minimal Design */
        .detail-overlay { position: fixed; inset: 0; background: rgba(15,23,42,0.4); display: flex; align-items: center; justify-content: center; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.2s ease; }
        .detail-overlay.open { opacity: 1; visibility: visible; }
        .detail-panel { width: 420px; max-width: 90vw; max-height: 85vh; background: #fff; border-radius: 16px; overflow: hidden; transform: translateY(10px); transition: transform 0.2s ease; box-shadow: 0 20px 60px rgba(0,0,0,0.15); display: flex; flex-direction: column; }
        .detail-overlay.open .detail-panel { transform: translateY(0); }
        
        .detail-header { padding: 24px 24px 20px; border-bottom: 1px solid #f1f5f9; display: flex; align-items: flex-start; gap: 16px; flex-shrink: 0; }
        .detail-close { position: absolute; top: 16px; right: 16px; background: none; border: none; color: #94a3b8; width: 32px; height: 32px; border-radius: 8px; cursor: pointer; font-size: 18px; transition: all 0.15s; }
        .detail-close:hover { background: #f1f5f9; color: #475569; }
        .detail-avatar { width: 56px; height: 56px; border-radius: 14px; background: #e2e8f0; display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: 600; color: #475569; flex-shrink: 0; }
        .detail-avatar.member { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #fff; }
        .detail-header-info { flex: 1; min-width: 0; }
        .detail-name { font-size: 20px; font-weight: 600; color: #1e293b; margin-bottom: 4px; }
        .detail-meta { font-size: 13px; color: #64748b; }
        .detail-badge { display: inline-flex; align-items: center; gap: 4px; font-size: 11px; font-weight: 600; padding: 4px 10px; border-radius: 20px; margin-top: 8px; }
        .detail-badge.member { background: #fef3c7; color: #b45309; }
        .detail-badge.nonmember { background: #f1f5f9; color: #64748b; }
        
        .detail-content { flex: 1; overflow-y: auto; padding: 4px 0; }
        
        .detail-section { padding: 14px 24px; }
        .detail-section-title { font-size: 11px; text-transform: uppercase; color: #94a3b8; margin-bottom: 10px; font-weight: 600; letter-spacing: 0.5px; }
        
        /* Quick Actions Row */
        .quick-actions { display: flex; gap: 8px; padding: 0 24px 12px; }
        .quick-action { display: flex; align-items: center; gap: 6px; padding: 8px 14px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 13px; color: #475569; cursor: pointer; transition: all 0.15s; text-decoration: none; }
        .quick-action:hover { background: #3b82f6; color: #fff; border-color: #3b82f6; }
        .quick-action i { font-size: 12px; }
        
        .info-row { display: flex; justify-content: space-between; align-items: center; padding: 6px 0; }
        .info-label { color: #64748b; font-size: 14px; }
        .info-value { color: #1e293b; font-weight: 500; font-size: 14px; }
        .info-value a { color: #3b82f6; text-decoration: none; }
        .info-value a:hover { text-decoration: underline; }
        
        /* Stats Row */
        .stats-row { display: flex; gap: 12px; margin-top: 4px; }
        .stat-box { flex: 1; background: #f8fafc; border-radius: 10px; padding: 12px; text-align: center; }
        .stat-box-value { font-size: 18px; font-weight: 600; color: #1e293b; }
        .stat-box-label { font-size: 11px; color: #94a3b8; text-transform: uppercase; margin-top: 2px; }
        
        .membership-card { background: #f8fafc; border-radius: 12px; padding: 14px 16px; margin-top: 4px; display: flex; align-items: center; justify-content: space-between; }
        .membership-card.active { background: linear-gradient(135deg, #fef3c7, #fde68a); }
        .membership-info { flex: 1; }
        .membership-tier { font-size: 15px; font-weight: 600; color: #1e293b; margin-bottom: 2px; }
        .membership-status { font-size: 12px; color: #64748b; }
        .membership-dates { display: flex; gap: 16px; margin-top: 8px; font-size: 11px; color: #64748b; }
        .membership-dates strong { color: #1e293b; }
        .membership-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .membership-action { padding: 8px 14px; background: #10b981; color: #fff; border: none; border-radius: 8px; font-size: 12px; font-weight: 500; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
        .membership-action:hover { background: #059669; }
        .membership-action.upgrade { background: #f59e0b; }
        .membership-action.upgrade:hover { background: #d97706; }
        .cancel-membership-btn:hover { background: #b91c1c !important; }
        
        .notes-field { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 14px; resize: none; font-family: inherit; color: #334155; background: #fafafa; }
        .notes-field:focus { border-color: #3b82f6; outline: none; background: #fff; }
        .notes-field::placeholder { color: #94a3b8; }
        
        .detail-actions { padding: 16px 24px 20px; border-top: 1px solid #f1f5f9; display: flex; gap: 8px; flex-shrink: 0; background: #fff; }
        .action-btn { flex: 1; padding: 10px 12px; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; transition: all 0.15s; }
        .action-btn.primary { background: #3b82f6; color: #fff; }
        .action-btn.primary:hover { background: #2563eb; }
        .action-btn.success { background: #10b981; color: #fff; }
        .action-btn.success:hover { background: #059669; }
        .action-btn.secondary { background: #f1f5f9; color: #475569; }
        .action-btn.secondary:hover { background: #e2e8f0; }
        .action-btn.danger { background: #fee2e2; color: #dc2626; }
        .action-btn.danger:hover { background: #fecaca; }
        
        /* Membership Card - Keep it minimal */
        
        /* Modal */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 200; opacity: 0; visibility: hidden; transition: all 0.2s; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: #fff; border-radius: 20px; width: 90%; max-width: 480px; overflow: hidden; transform: scale(0.95); transition: transform 0.2s; }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 20px 24px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .modal-header h3 { font-size: 18px; font-weight: 600; display: flex; align-items: center; gap: 10px; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #999; padding: 5px; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; background: #f8f9fa; display: flex; justify-content: flex-end; gap: 10px; }
        
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; font-size: 13px; color: #666; margin-bottom: 6px; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px 14px; border: 1px solid #ddd; border-radius: 10px; font-size: 15px; transition: all 0.2s; }
        .form-group input:focus, .form-group select:focus { border-color: #4a90a4; outline: none; box-shadow: 0 0 0 3px rgba(74,144,164,0.1); }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        
        .modal-btn { padding: 12px 24px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .modal-btn.cancel { background: #f0f0f0; color: #666; }
        .modal-btn.save { background: #27ae60; color: #fff; }
        .modal-btn:hover { filter: brightness(0.95); }
        
        /* Toast */
        .toast { position: fixed; bottom: 24px; right: 24px; padding: 14px 24px; background: #333; color: #fff; border-radius: 12px; font-size: 14px; z-index: 999; opacity: 0; transform: translateY(20px); transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        
        /* Empty State */
        .empty-state { text-align: center; padding: 80px 20px; }
        .empty-state i { font-size: 64px; color: #ddd; margin-bottom: 20px; }
        .empty-state h3 { color: #999; font-size: 18px; font-weight: 500; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .search-row { flex-direction: column; }
            .search-filters { flex-wrap: wrap; }
            .customer-grid { grid-template-columns: 1fr; }
            .detail-panel { width: 100%; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="header-logo">
                <img src="images/golfCoveLogo6.png" alt="Golf Cove">
                <span>Golf Cove</span>
            </a>
            <nav class="header-nav">
                <a href="admin-pos.html"><i class="fas fa-calendar-alt"></i> Tee Sheet</a>
                <a href="sales.html"><i class="fas fa-cash-register"></i> Sales</a>
                <a href="customers.html" class="active"><i class="fas fa-users"></i> Customers</a>
            </nav>
        </div>
        <div class="header-right">
            <span id="currentTime">--:--</span>
            <i class="fas fa-user-circle" style="font-size: 22px;"></i>
        </div>
    </header>

    <main class="main">
        <!-- Search Section -->
        <section class="search-section">
            <div class="search-row">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="searchInput" placeholder="Search by name, email, or phone..." oninput="searchCustomers()">
                </div>
                <div class="search-filters">
                    <button class="filter-chip active" data-filter="all" onclick="setFilter('all', this)">
                        All <span class="count" id="countAll">0</span>
                    </button>
                    <button class="filter-chip" data-filter="member" onclick="setFilter('member', this)">
                        <i class="fas fa-crown"></i> Members <span class="count" id="countMembers">0</span>
                    </button>
                    <button class="filter-chip" data-filter="vip" onclick="setFilter('vip', this)">
                        <i class="fas fa-star"></i> VIP <span class="count" id="countVIP">0</span>
                    </button>
                    <button class="filter-chip" data-filter="expiring" onclick="setFilter('expiring', this)">
                        <i class="fas fa-exclamation-triangle"></i> Expiring <span class="count" id="countExpiring">0</span>
                    </button>
                    <button class="filter-chip" data-filter="expired" onclick="setFilter('expired', this)">
                        <i class="fas fa-times-circle"></i> Expired <span class="count" id="countExpired">0</span>
                    </button>
                </div>
                <button class="btn-new" onclick="showModal('newCustomer')" style="margin-right:8px;">
                    <i class="fas fa-plus"></i> New Customer
                </button>
                <button class="btn-new" onclick="showMembershipReport()" style="background:#9b59b6;">
                    <i class="fas fa-chart-bar"></i> Report
                </button>
            </div>
        </section>

        <!-- Results -->
        <div class="results-info" id="resultsInfo">Loading...</div>
        
        <div class="customer-grid" id="customerGrid">
            <!-- Cards rendered here -->
        </div>
        
        <div class="empty-state" id="emptyState" style="display:none;">
            <i class="fas fa-users"></i>
            <h3>No customers found</h3>
        </div>
    </main>

    <!-- Customer Detail Modal (Clean Design) -->
    <div class="detail-overlay" id="detailOverlay" onclick="if(event.target === this) closeDetail()">
        <div class="detail-panel" id="detailPanel">
            <button class="detail-close" onclick="closeDetail()"><i class="fas fa-times"></i></button>
            
            <div class="detail-header" id="detailHeader">
                <div class="detail-avatar" id="detailAvatar">JD</div>
                <div class="detail-header-info">
                    <div class="detail-name" id="detailName">John Doe</div>
                    <div class="detail-meta" id="detailMeta">Customer since Jan 2024</div>
                    <div class="detail-badge nonmember" id="detailBadge">Non-Member</div>
                </div>
            </div>
            
            <!-- Quick Actions -->
            <div class="quick-actions">
                <a class="quick-action" id="quickEmailLink" href="#"><i class="fas fa-envelope"></i> Email</a>
                <a class="quick-action" id="quickPhoneLink" href="#"><i class="fas fa-phone"></i> Call</a>
                <a class="quick-action" onclick="quickBook()"><i class="fas fa-calendar-plus"></i> Book</a>
            </div>
            
            <div class="detail-content">
                <div class="detail-section">
                    <div class="detail-section-title">Activity</div>
                    <div class="stats-row">
                        <div class="stat-box">
                            <div class="stat-box-value" id="detailVisits">0</div>
                            <div class="stat-box-label">Visits</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value" id="detailSpent">$0</div>
                            <div class="stat-box-label">Spent</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-box-value" id="detailLastVisit">-</div>
                            <div class="stat-box-label">Last Visit</div>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section" id="membershipSection">
                    <div class="detail-section-title">Membership</div>
                    <div class="membership-card" id="membershipCard">
                        <div class="membership-info">
                            <div class="membership-tier" id="memberTier">Non-Member</div>
                            <div class="membership-status" id="memberStatus">No active membership</div>
                            <div class="membership-dates" id="memberDates" style="display:none;">
                                <span>Since <strong id="memberSince">-</strong></span>
                                <span>Expires <strong id="memberExpires">-</strong></span>
                            </div>
                        </div>
                        <div class="membership-actions">
                            <button class="membership-action" id="membershipBtn" onclick="showModal('addMembership')">Add</button>
                            <button class="membership-action cancel-membership-btn" id="cancelMembershipBtn" onclick="cancelMembership(selectedCustomer)" style="display:none; background:#dc3545;">Cancel</button>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">Contact</div>
                    <div class="info-row">
                        <span class="info-label">Email</span>
                        <span class="info-value"><a href="#" id="detailEmail">-</a></span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Phone</span>
                        <span class="info-value"><a href="#" id="detailPhone">-</a></span>
                    </div>
                </div>
                
                <div class="detail-section">
                    <div class="detail-section-title">Notes</div>
                    <textarea class="notes-field" id="detailNotes" rows="2" placeholder="Add a note..." onchange="saveNotes()"></textarea>
                </div>
            </div>
            
            <div class="detail-actions">
                <button class="action-btn secondary" onclick="editCustomer()" style="flex:2;"><i class="fas fa-edit"></i> Edit Customer</button>
                <button class="action-btn danger" onclick="deleteCustomer()"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <!-- New Customer Modal -->
    <div class="modal-overlay" id="modal-newCustomer">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-user-plus" style="color:#27ae60;"></i> New Customer</h3>
                <button class="modal-close" onclick="hideModal('newCustomer')">&times;</button>
            </div>
            <form onsubmit="createCustomer(event)">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name *</label>
                            <input type="text" id="newFirstName" required placeholder="John">
                        </div>
                        <div class="form-group">
                            <label>Last Name *</label>
                            <input type="text" id="newLastName" required placeholder="Smith">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="newEmail" placeholder="john@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="newPhone" placeholder="(203) 555-1234" oninput="formatPhone(this)">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-btn cancel" onclick="hideModal('newCustomer')">Cancel</button>
                    <button type="submit" class="modal-btn save"><i class="fas fa-plus"></i> Create</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Membership Modal -->
    <div class="modal-overlay" id="modal-addMembership">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-crown" style="color:#f1c40f;"></i> Membership</h3>
                <button class="modal-close" onclick="hideModal('addMembership')">&times;</button>
            </div>
            <form onsubmit="addMembership(event)">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Membership Tier *</label>
                        <select id="membershipTier" required>
                            <option value="">Select tier...</option>
                            <optgroup label="Individual">
                                <option value="par">Par - $99/mo (10% F&B discount)</option>
                                <option value="birdie">Birdie - $149/mo (Unlimited play + 10% off)</option>
                                <option value="eagle">Eagle - $199/mo (Premium + 15% off)</option>
                            </optgroup>
                            <optgroup label="Family">
                                <option value="family_par">Family Par - $149/mo</option>
                                <option value="family_birdie">Family Birdie - $199/mo</option>
                                <option value="family_eagle">Family Eagle - $249/mo</option>
                            </optgroup>
                            <optgroup label="Business">
                                <option value="corporate">Corporate - Custom</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="membershipStart">
                        </div>
                        <div class="form-group">
                            <label>Duration</label>
                            <select id="membershipDuration">
                                <option value="1">1 Month</option>
                                <option value="3">3 Months</option>
                                <option value="6">6 Months</option>
                                <option value="12" selected>12 Months (Annual)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-btn cancel" onclick="hideModal('addMembership')">Cancel</button>
                    <button type="submit" class="modal-btn save"><i class="fas fa-crown"></i> Activate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Customer Modal -->
    <div class="modal-overlay" id="modal-editCustomer">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-edit" style="color:#4a90a4;"></i> Edit Customer</h3>
                <button class="modal-close" onclick="hideModal('editCustomer')">&times;</button>
            </div>
            <form onsubmit="saveCustomer(event)">
                <div class="modal-body">
                    <div class="form-row">
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="editFirstName">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="editLastName">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="editEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="editPhone" oninput="formatPhone(this)">
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <input type="text" id="editAddress" placeholder="123 Main St">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="editCity">
                        </div>
                        <div class="form-group">
                            <label>State / Zip</label>
                            <div style="display:flex;gap:8px;">
                                <input type="text" id="editState" placeholder="CT" style="width:60px;">
                                <input type="text" id="editZip" placeholder="06XXX">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="modal-btn cancel" onclick="hideModal('editCustomer')">Cancel</button>
                    <button type="submit" class="modal-btn save"><i class="fas fa-save"></i> Save</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ============ CONSTANTS ============
        const FUNCTIONS_URL = 'https://us-central1-golfcove.cloudfunctions.net';
        
        // ============ STATE ============
        let customers = [];
        let selectedCustomerId = null;
        let currentFilter = 'all';
        let isLoading = false;
        
        // ============ INIT ============
        async function init() {
            updateClock();
            setInterval(updateClock, 1000);
            
            // Load customers from Stripe
            await loadCustomersFromStripe();
        }
        
        async function loadCustomersFromStripe() {
            if (isLoading) return;
            isLoading = true;
            
            const grid = document.getElementById('customerGrid');
            grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #888;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 12px;">Loading customers from Stripe...</p></div>';
            
            try {
                const response = await fetch(`${FUNCTIONS_URL}/getStripeCustomers?limit=100`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Transform Stripe customers to our format
                customers = data.customers.map(c => {
                    const nameParts = (c.name || '').split(' ');
                    const firstName = nameParts[0] || '';
                    const lastName = nameParts.slice(1).join(' ') || '';
                    
                    // Check for active subscription
                    const activeSub = c.subscriptions?.find(s => s.status === 'active');
                    const memberType = c.metadata?.tier || (activeSub ? getMemberTypeFromPlan(activeSub.plan) : null);
                    
                    return {
                        id: c.id,
                        stripeId: c.id,
                        firstName,
                        lastName,
                        email: c.email || '',
                        phone: c.phone || '',
                        isMember: !!activeSub,
                        memberType: memberType,
                        memberExpires: activeSub ? new Date(activeSub.currentPeriodEnd * 1000).toISOString().split('T')[0] : null,
                        memberSince: c.created ? new Date(c.created * 1000).toISOString().split('T')[0] : null,
                        subscriptions: c.subscriptions || []
                    };
                });
                
                renderCustomers();
                updateCounts();
                showToast(`Loaded ${customers.length} customers from Stripe`, 'success');
                
            } catch (error) {
                console.error('Failed to load customers:', error);
                grid.innerHTML = `<div style="text-align: center; padding: 40px; color: #e74c3c;"><i class="fas fa-exclamation-triangle fa-2x"></i><p style="margin-top: 12px;">Failed to load customers: ${error.message}</p><button class="btn btn-primary" onclick="loadCustomersFromStripe()" style="margin-top: 12px;"><i class="fas fa-sync"></i> Retry</button></div>`;
            }
            
            isLoading = false;
        }
        
        function getMemberTypeFromPlan(planName) {
            if (!planName) return null;
            const lower = planName.toLowerCase();
            if (lower.includes('eagle')) return 'eagle';
            if (lower.includes('birdie')) return 'birdie';
            if (lower.includes('par')) return 'par';
            return null;
        }
        
        // ============ RENDER ============
        function renderCustomers() {
            const grid = document.getElementById('customerGrid');
            const empty = document.getElementById('emptyState');
            const search = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = customers.filter(c => {
                const name = `${c.firstName} ${c.lastName}`.toLowerCase();
                const matchSearch = !search || name.includes(search) || (c.email && c.email.includes(search)) || (c.phone && c.phone.includes(search));
                
                if (currentFilter === 'member') return matchSearch && c.isMember && !isExpired(c);
                if (currentFilter === 'vip') return matchSearch && c.isMember && !isExpired(c) && (c.memberType === 'eagle' || c.memberType === 'birdie' || c.memberType === 'family_eagle' || c.memberType === 'family_birdie');
                if (currentFilter === 'expiring') return matchSearch && isExpiringSoon(c);
                if (currentFilter === 'expired') return matchSearch && c.isMember && isExpired(c);
                return matchSearch;
            });
            
            // Sort: VIP first, then members, then by name
            filtered.sort((a, b) => {
                const aVIP = a.isMember && !isExpired(a) && (a.memberType === 'eagle' || a.memberType === 'birdie' || a.memberType === 'family_eagle' || a.memberType === 'family_birdie');
                const bVIP = b.isMember && !isExpired(b) && (b.memberType === 'eagle' || b.memberType === 'birdie' || b.memberType === 'family_eagle' || b.memberType === 'family_birdie');
                if (aVIP && !bVIP) return -1;
                if (!aVIP && bVIP) return 1;
                if (a.isMember && !b.isMember) return -1;
                if (!a.isMember && b.isMember) return 1;
                return `${a.firstName} ${a.lastName}`.localeCompare(`${b.firstName} ${b.lastName}`);
            });
            
            document.getElementById('resultsInfo').textContent = `Showing ${filtered.length} of ${customers.length} customers`;
            
            if (filtered.length === 0) {
                grid.innerHTML = '';
                empty.style.display = 'block';
                return;
            }
            
            empty.style.display = 'none';
            grid.innerHTML = filtered.map(c => renderCard(c)).join('');
        }
        
        function renderCard(c) {
            const initials = ((c.firstName || '')[0] || '') + ((c.lastName || '')[0] || '');
            const expired = isExpired(c);
            const expiring = isExpiringSoon(c);
            const isActive = c.isMember && !expired;
            
            let avatarClass = '';
            let badgeHtml = '';
            
            if (c.isMember) {
                if (expired) {
                    badgeHtml = '<span class="member-badge expired">Expired</span>';
                } else if (expiring) {
                    avatarClass = c.memberType || 'member';
                    badgeHtml = `<span class="member-badge expiring"><i class="fas fa-clock"></i> Expiring</span>`;
                } else {
                    avatarClass = c.memberType || 'member';
                    badgeHtml = `<span class="member-badge ${c.memberType}"><i class="fas fa-crown"></i> ${getTierName(c.memberType)}</span>`;
                }
            }
            
            const selected = selectedCustomerId === c.id ? 'selected' : '';
            
            return `
                <div class="customer-card ${selected}" onclick="selectCustomer(${c.id})">
                    <div class="card-header">
                        <div class="card-avatar ${avatarClass}">${initials.toUpperCase()}</div>
                        <div class="card-info">
                            <div class="card-name">${c.firstName} ${c.lastName} ${badgeHtml}</div>
                            <div class="card-contact">
                                ${c.email ? `<span><i class="fas fa-envelope"></i> ${c.email}</span>` : ''}
                                ${c.phone ? `<span><i class="fas fa-phone"></i> ${c.phone}</span>` : ''}
                                ${!c.email && !c.phone ? '<span style="color:#ccc;">No contact info</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="card-footer">
                        <button class="card-btn" onclick="event.stopPropagation(); quickAction('book', ${c.id})"><i class="fas fa-calendar-plus"></i> Book</button>
                        <button class="card-btn" onclick="event.stopPropagation(); quickAction('email', ${c.id})"><i class="fas fa-envelope"></i> Email</button>
                        <button class="card-btn primary" onclick="event.stopPropagation(); selectCustomer(${c.id})"><i class="fas fa-eye"></i> View</button>
                    </div>
                </div>
            `;
        }
        
        function updateCounts() {
            document.getElementById('countAll').textContent = customers.length;
            document.getElementById('countMembers').textContent = customers.filter(c => c.isMember && !isExpired(c)).length;
            document.getElementById('countVIP').textContent = customers.filter(c => c.isMember && !isExpired(c) && (c.memberType === 'eagle' || c.memberType === 'birdie' || c.memberType === 'family_eagle' || c.memberType === 'family_birdie')).length;
            document.getElementById('countExpiring').textContent = customers.filter(c => isExpiringSoon(c)).length;
            document.getElementById('countExpired').textContent = customers.filter(c => c.isMember && isExpired(c)).length;
        }
        
        // ============ CUSTOMER DETAIL ============
        function selectCustomer(id) {
            selectedCustomerId = id;
            const c = customers.find(x => x.id === id);
            if (!c) return;
            
            renderCustomers(); // Update selection highlight
            
            // Header - clean design
            const initials = ((c.firstName || '')[0] || '') + ((c.lastName || '')[0] || '');
            const isMember = c.isMember && !isExpired(c);
            
            const avatar = document.getElementById('detailAvatar');
            avatar.textContent = initials.toUpperCase();
            avatar.className = 'detail-avatar' + (isMember ? ' member' : '');
            
            document.getElementById('detailName').textContent = `${c.firstName} ${c.lastName}`;
            document.getElementById('detailMeta').textContent = c.createdAt ? `Customer since ${formatDate(c.createdAt)}` : '';
            
            // Badge
            const badge = document.getElementById('detailBadge');
            if (isMember) {
                badge.className = 'detail-badge member';
                badge.innerHTML = '<i class="fas fa-crown"></i> ' + getTierName(c.memberType);
            } else if (c.isMember && isExpired(c)) {
                badge.className = 'detail-badge nonmember';
                badge.textContent = 'Membership Expired';
            } else {
                badge.className = 'detail-badge nonmember';
                badge.textContent = 'Non-Member';
            }
            
            // Contact
            const emailEl = document.getElementById('detailEmail');
            const phoneEl = document.getElementById('detailPhone');
            emailEl.textContent = c.email || '-';
            emailEl.href = c.email ? `mailto:${c.email}` : '#';
            phoneEl.textContent = c.phone || '-';
            phoneEl.href = c.phone ? `tel:${c.phone.replace(/\D/g, '')}` : '#';
            
            // Quick action links
            document.getElementById('quickEmailLink').href = c.email ? `mailto:${c.email}` : '#';
            document.getElementById('quickEmailLink').style.opacity = c.email ? '1' : '0.5';
            document.getElementById('quickPhoneLink').href = c.phone ? `tel:${c.phone.replace(/\D/g, '')}` : '#';
            document.getElementById('quickPhoneLink').style.opacity = c.phone ? '1' : '0.5';
            
            // Membership card
            const memberCard = document.getElementById('membershipCard');
            const memberDates = document.getElementById('memberDates');
            const memberBtn = document.getElementById('membershipBtn');
            const cancelBtn = document.getElementById('cancelMembershipBtn');
            
            if (c.isMember) {
                const expired = isExpired(c);
                memberCard.className = 'membership-card' + (expired ? '' : ' active');
                document.getElementById('memberTier').textContent = getTierName(c.memberType);
                document.getElementById('memberStatus').textContent = expired ? 'Membership expired' : 'Active membership';
                document.getElementById('memberSince').textContent = formatDate(c.memberSince);
                document.getElementById('memberExpires').textContent = formatDate(c.memberExpires);
                memberDates.style.display = 'flex';
                memberBtn.textContent = expired ? 'Renew' : 'Upgrade';
                memberBtn.className = 'membership-action' + (expired ? '' : ' upgrade');
                cancelBtn.style.display = expired ? 'none' : 'inline-block';
            } else {
                memberCard.className = 'membership-card';
                document.getElementById('memberTier').textContent = 'Non-Member';
                document.getElementById('memberStatus').textContent = 'No active membership';
                memberDates.style.display = 'none';
                memberBtn.textContent = 'Add';
                memberBtn.className = 'membership-action';
                cancelBtn.style.display = 'none';
            }
            
            // Activity stats
            const transactions = JSON.parse(localStorage.getItem('gc_transactions') || '[]');
            const custTrans = transactions.filter(t => t.customer && t.customer.toLowerCase() === `${c.firstName} ${c.lastName}`.toLowerCase());
            const totalSpent = custTrans.reduce((s, t) => s + (t.amount || 0), 0);
            document.getElementById('detailVisits').textContent = c.visitCount || custTrans.length || 0;
            document.getElementById('detailSpent').textContent = totalSpent >= 1000 ? '$' + (totalSpent/1000).toFixed(1) + 'k' : '$' + totalSpent.toFixed(0);
            document.getElementById('detailLastVisit').textContent = c.lastVisit ? formatShortDate(c.lastVisit) : '-';
            
            // Notes
            document.getElementById('detailNotes').value = c.notes || '';
            
            // Open modal
            document.getElementById('detailOverlay').classList.add('open');
        }
        
        function closeDetail() {
            document.getElementById('detailOverlay').classList.remove('open');
            selectedCustomerId = null;
            renderCustomers();
        }
        
        // ============ ACTIONS ============
        async function createCustomer(e) {
            e.preventDefault();
            
            const firstName = document.getElementById('newFirstName').value.trim();
            const lastName = document.getElementById('newLastName').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const phone = document.getElementById('newPhone').value.trim();
            
            if (!email) {
                showToast('Email is required to create a customer in Stripe', 'error');
                return;
            }
            
            try {
                // Create customer in Stripe
                const response = await fetch(`${FUNCTIONS_URL}/createStripeCustomer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: `${firstName} ${lastName}`.trim(),
                        email,
                        phone,
                        metadata: { source: 'admin_panel' }
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                hideModal('newCustomer');
                e.target.reset();
                showToast(`${firstName} ${lastName} added to Stripe!`, 'success');
                
                // Reload customers from Stripe
                await loadCustomersFromStripe();
                
            } catch (error) {
                console.error('Create customer error:', error);
                showToast('Failed to create customer: ' + error.message, 'error');
            }
        }
        
        function addMembership(e) {
            e.preventDefault();
            if (!selectedCustomerId) return;
            const c = customers.find(x => x.id === selectedCustomerId);
            if (!c) return;
            
            const tier = document.getElementById('membershipTier').value;
            const start = document.getElementById('membershipStart').value || new Date().toISOString().split('T')[0];
            const duration = parseInt(document.getElementById('membershipDuration').value);
            
            const expires = new Date(start);
            expires.setMonth(expires.getMonth() + duration);
            
            c.isMember = true;
            c.memberType = tier;
            c.memberSince = start;
            c.memberExpires = expires.toISOString().split('T')[0];
            
            localStorage.setItem('gc_customers', JSON.stringify(customers));
            hideModal('addMembership');
            selectCustomer(selectedCustomerId);
            updateCounts();
            showToast('Membership activated!', 'success');
        }
        
        function editCustomer() {
            if (!selectedCustomerId) return;
            const c = customers.find(x => x.id === selectedCustomerId);
            if (!c) return;
            
            document.getElementById('editFirstName').value = c.firstName || '';
            document.getElementById('editLastName').value = c.lastName || '';
            document.getElementById('editEmail').value = c.email || '';
            document.getElementById('editPhone').value = c.phone || '';
            document.getElementById('editAddress').value = c.address || '';
            document.getElementById('editCity').value = c.city || '';
            document.getElementById('editState').value = c.state || '';
            document.getElementById('editZip').value = c.zip || '';
            
            showModal('editCustomer');
        }
        
        async function saveCustomer(e) {
            e.preventDefault();
            if (!selectedCustomerId) return;
            const c = customers.find(x => x.id === selectedCustomerId);
            if (!c) return;
            
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            
            try {
                // Update in Stripe
                const response = await fetch(`${FUNCTIONS_URL}/updateStripeCustomer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        customerId: c.stripeId || c.id,
                        name: `${firstName} ${lastName}`.trim(),
                        email,
                        phone
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                hideModal('editCustomer');
                showToast('Customer updated in Stripe!', 'success');
                
                // Reload from Stripe
                await loadCustomersFromStripe();
                selectCustomer(selectedCustomerId);
                
            } catch (error) {
                console.error('Update customer error:', error);
                showToast('Failed to update: ' + error.message, 'error');
            }
        }
        
        function saveNotes() {
            // Notes are stored locally for now (could add to Stripe metadata)
            if (!selectedCustomerId) return;
            const c = customers.find(x => x.id === selectedCustomerId);
            if (!c) return;
            c.notes = document.getElementById('detailNotes').value;
            // Notes stored in memory only - would need Stripe metadata update for persistence
            showToast('Notes saved locally', 'success');
        }
        
        async function deleteCustomer() {
            if (!selectedCustomerId) return;
            if (!confirm('Delete this customer from Stripe? This cannot be undone.')) return;
            
            const c = customers.find(x => x.id === selectedCustomerId);
            if (!c) return;
            
            try {
                const response = await fetch(`${FUNCTIONS_URL}/deleteStripeCustomer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customerId: c.stripeId || c.id })
                });
                
                const data = await response.json();
                if (data.error) throw new Error(data.error);
                
                closeDetail();
                showToast('Customer deleted from Stripe', 'success');
                await loadCustomersFromStripe();
                
            } catch (error) {
                console.error('Delete customer error:', error);
                showToast('Failed to delete: ' + error.message, 'error');
            }
        }
        
        function quickAction(action, id) {
            const c = customers.find(x => x.id === id);
            if (!c) return;
            
            if (action === 'book') {
                window.location.href = `admin-pos.html?book=${c.firstName}+${c.lastName}`;
            } else if (action === 'email' && c.email) {
                window.location.href = `mailto:${c.email}`;
            } else if (action === 'email') {
                showToast('No email address', 'error');
            }
        }
        
        function quickBook() {
            if (!selectedCustomerId) return;
            const c = customers.find(x => x.id === selectedCustomerId);
            if (c) window.location.href = `admin-pos.html?book=${c.firstName}+${c.lastName}`;
        }
        
        function quickEmail() {
            if (!selectedCustomerId) return;
            const c = customers.find(x => x.id === selectedCustomerId);
            if (c && c.email) window.location.href = `mailto:${c.email}`;
            else showToast('No email address', 'error');
        }
        
        // ============ FILTERS & SEARCH ============
        function searchCustomers() {
            renderCustomers();
        }
        
        function setFilter(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            renderCustomers();
        }
        
        // ============ HELPERS ============
        function isExpired(c) {
            if (!c.isMember || !c.memberExpires) return false;
            return new Date(c.memberExpires) < new Date();
        }
        
        function isExpiringSoon(c) {
            if (!c.isMember || !c.memberExpires) return false;
            const exp = new Date(c.memberExpires);
            const soon = new Date();
            soon.setDate(soon.getDate() + 30);
            return exp <= soon && exp >= new Date();
        }
        
        function getTierName(type) {
            const names = { par: 'Par', birdie: 'Birdie', eagle: 'Eagle', family_par: 'Family Par', family_birdie: 'Family Birdie', family_eagle: 'Family Eagle', corporate: 'Corporate', monthly: 'Monthly', annual: 'Annual' };
            return names[type] || 'Member';
        }
        
        function formatDate(str) {
            if (!str) return '-';
            return new Date(str).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function formatShortDate(str) {
            if (!str) return '-';
            const d = new Date(str);
            const now = new Date();
            const diff = Math.floor((now - d) / (1000 * 60 * 60 * 24));
            if (diff === 0) return 'Today';
            if (diff === 1) return 'Yesterday';
            if (diff < 7) return diff + 'd ago';
            if (diff < 30) return Math.floor(diff / 7) + 'w ago';
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }
        
        function formatPhone(input) {
            let v = input.value.replace(/\D/g, '').slice(0, 10);
            if (v.length >= 6) input.value = `(${v.slice(0,3)}) ${v.slice(3,6)}-${v.slice(6)}`;
            else if (v.length >= 3) input.value = `(${v.slice(0,3)}) ${v.slice(3)}`;
        }
        
        function updateClock() {
            document.getElementById('currentTime').textContent = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
        }
        
        // ============ MEMBERSHIP MANAGEMENT ============
        function cancelMembership() {
            if (!selectedCustomerId) return;
            const c = customers.find(x => x.id === selectedCustomerId);
            if (!c || !c.isMember) return;
            
            if (!confirm(`Cancel ${c.firstName}'s ${getTierName(c.memberType)} membership?`)) return;
            
            c.isMember = false;
            c.memberExpires = new Date().toISOString().split('T')[0];
            localStorage.setItem('gc_customers', JSON.stringify(customers));
            
            selectCustomer(selectedCustomerId);
            updateCounts();
            renderCustomers();
            showToast('Membership cancelled', 'error');
        }
        
        function showMembershipReport() {
            const total = customers.length;
            const activeMembers = customers.filter(c => c.isMember && !isExpired(c));
            const expiring = customers.filter(c => isExpiringSoon(c));
            const expired = customers.filter(c => c.isMember && isExpired(c));
            
            // By tier
            const byTier = {};
            activeMembers.forEach(c => {
                const tier = c.memberType || 'unknown';
                byTier[tier] = (byTier[tier] || 0) + 1;
            });
            
            // Monthly revenue estimate
            const tierPrices = { par: 99, birdie: 149, eagle: 199, family_par: 149, family_birdie: 199, family_eagle: 249, corporate: 500, monthly: 79, annual: 799 };
            let monthlyRevenue = 0;
            activeMembers.forEach(c => {
                monthlyRevenue += tierPrices[c.memberType] || 100;
            });
            
            let tierRows = Object.entries(byTier).map(([tier, count]) => 
                `<tr><td style="padding:8px;text-transform:capitalize;">${getTierName(tier)}</td><td style="padding:8px;text-align:right;font-weight:600;">${count}</td></tr>`
            ).join('');
            
            const html = `
                <div style="padding:24px;">
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:#e8f5e9;padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:28px;font-weight:700;color:#27ae60;">${activeMembers.length}</div>
                            <div style="font-size:12px;color:#666;">Active Members</div>
                        </div>
                        <div style="background:#fff3e0;padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:28px;font-weight:700;color:#f39c12;">${expiring.length}</div>
                            <div style="font-size:12px;color:#666;">Expiring Soon</div>
                        </div>
                        <div style="background:#ffebee;padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:28px;font-weight:700;color:#e74c3c;">${expired.length}</div>
                            <div style="font-size:12px;color:#666;">Expired</div>
                        </div>
                        <div style="background:#e3f2fd;padding:15px;border-radius:12px;text-align:center;">
                            <div style="font-size:28px;font-weight:700;color:#3498db;">$${monthlyRevenue.toLocaleString()}</div>
                            <div style="font-size:12px;color:#666;">Monthly Revenue</div>
                        </div>
                    </div>
                    
                    <h4 style="margin-bottom:10px;color:#333;">Membership by Tier</h4>
                    <table style="width:100%;border-collapse:collapse;background:#f8f9fa;border-radius:8px;overflow:hidden;">
                        <thead><tr style="background:#4a90a4;color:#fff;"><th style="padding:10px;text-align:left;">Tier</th><th style="padding:10px;text-align:right;">Count</th></tr></thead>
                        <tbody>${tierRows || '<tr><td colspan="2" style="padding:10px;text-align:center;color:#999;">No members</td></tr>'}</tbody>
                    </table>
                    
                    ${expiring.length > 0 ? `
                    <h4 style="margin:20px 0 10px;color:#333;">Expiring in 30 Days</h4>
                    <div style="max-height:150px;overflow-y:auto;">
                        ${expiring.map(c => `<div style="display:flex;justify-content:space-between;padding:8px;background:#fff;border-radius:6px;margin-bottom:4px;">
                            <span>${c.firstName} ${c.lastName}</span>
                            <span style="color:#f39c12;font-size:13px;">${formatDate(c.memberExpires)}</span>
                        </div>`).join('')}
                    </div>
                    ` : ''}
                </div>
            `;
            
            // Create modal
            const overlay = document.createElement('div');
            overlay.id = 'reportOverlay';
            overlay.className = 'modal-overlay active';
            overlay.innerHTML = `
                <div class="modal" style="max-width:600px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-chart-bar" style="color:#9b59b6;"></i> Membership Report</h3>
                        <button class="modal-close" onclick="document.getElementById('reportOverlay').remove()">&times;</button>
                    </div>
                    ${html}
                </div>
            `;
            document.body.appendChild(overlay);
        }
        
        // ============ MODALS ============
        function showModal(name) {
            document.getElementById('modal-' + name).classList.add('active');
            if (name === 'addMembership') {
                document.getElementById('membershipStart').valueAsDate = new Date();
            }
        }
        
        function hideModal(name) {
            document.getElementById('modal-' + name).classList.remove('active');
        }
        
        function showToast(msg, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = msg;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeDetail();
                const report = document.getElementById('reportOverlay');
                if (report) report.remove();
            }
        });
        
        // Init
        init();
    </script>
</body>
</html>
