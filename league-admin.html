<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>League Admin - Golf Cove</title>
    <link rel="icon" type="image/png" href="images/golfcovelogo.png">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        /* Admin Layout */
        .admin-wrapper {
            display: flex;
            min-height: calc(100vh - 120px);
            background: #f8f9fa;
        }
        
        /* Sidebar */
        .admin-sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid #e5e7eb;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            height: calc(100vh - 120px);
            overflow-y: auto;
            box-shadow: 2px 0 8px rgba(0,0,0,0.03);
        }
        .admin-sidebar.mobile-open {
            display: block;
        }
        
        /* League Info in Sidebar */
        .league-info {
            padding: 30px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(55,178,74,0.15);
        }
        .league-info h2 {
            font-size: 20px;
            margin-bottom: 6px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .league-info .season {
            font-size: 13px;
            opacity: 0.85;
            font-weight: 500;
        }
        
        /* Admin Sidebar Nav Menu */
        .admin-sidebar .admin-nav {
            padding: 20px 0;
        }
        .admin-sidebar .nav-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 15px 24px;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.25s ease;
            font-size: 14px;
            font-weight: 600;
            border-left: 4px solid transparent;
            margin: 2px 0;
        }
        .admin-sidebar .nav-item:hover {
            background: #f9fafb;
            color: #374151;
            transform: translateX(2px);
        }
        .admin-sidebar .nav-item.active {
            background: linear-gradient(90deg, #e8f5e9 0%, #f0f9f1 100%);
            color: #37b24a;
            border-left-color: #37b24a;
            font-weight: 700;
        }
        .admin-sidebar .nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }
        .admin-sidebar .nav-divider {
            height: 1px;
            background: #eee;
            margin: 10px 20px;
        }
        .nav-item.danger {
            color: #dc3545;
        }
        .nav-item.danger:hover {
            background: #fff5f5;
        }
        .nav-item.back-link {
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            color: #37b24a;
            font-weight: 600;
        }
        .nav-item.back-link:hover {
            background: #e8f5e9;
        }
        
        /* Main Content */
        .admin-main {
            flex: 1;
            background: linear-gradient(to bottom, #f8f9fa 0%, #f1f3f5 100%);
            min-height: calc(100vh - 120px);
        }
        .main-content {
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* Mobile sidebar toggle */
        .mobile-admin-toggle {
            display: none;
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background: #37b24a;
            color: #fff;
            border: none;
            border-radius: 50%;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(55,178,74,0.4);
            z-index: 100;
        }
        .mobile-sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 150;
        }
        .mobile-sidebar-overlay.open {
            display: block;
        }
        
        /* Page Sections */
        .page-section {
            display: none;
            max-width: 800px;
            margin: 0 auto;
        }
        .page-section.active {
            display: block;
        }
        .page-title {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: -0.5px;
        }
        .page-title i {
            color: #37b24a;
            font-size: 30px;
        }
        
        /* Cards */
        .card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.08);
            padding: 28px;
            margin-bottom: 24px;
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }
        .card:hover {
            box-shadow: 0 8px 24px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }
        .card h3 {
            font-size: 17px;
            color: #1f2937;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
        }
        .card h3 i {
            color: #37b24a;
            font-size: 20px;
        }
        
        /* Team Cards */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .team-card {
            background: linear-gradient(135deg, #ffffff 0%, #f9fafb 100%);
            border-radius: 14px;
            padding: 20px;
            border-left: 5px solid #37b24a;
            box-shadow: 0 3px 12px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
        }
        .team-card:hover {
            box-shadow: 0 6px 20px rgba(55,178,74,0.15);
            transform: translateY(-4px);
        }
        .team-card .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .team-card .team-name {
            font-weight: 700;
            font-size: 15px;
        }
        .team-card .delete-btn {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            padding: 5px;
        }
        .team-card .delete-btn:hover {
            color: #dc3545;
        }
        .team-card .player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        .team-card .player:last-child {
            border-bottom: none;
        }
        .team-card .player-name {
            color: #333;
        }
        .team-card .player-meta {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .team-card .hcp {
            color: #888;
            font-size: 12px;
        }
        .team-card .pin {
            font-family: monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }
        .team-card .add-player-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 12px;
            margin-top: 12px;
            background: #fff;
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            color: #6b7280;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .team-card .add-player-btn:hover {
            border-color: #37b24a;
            background: #f0fdf4;
            color: #37b24a;
            transform: scale(1.02);
        }
        
        /* Add Team */
        .add-team-card {
            background: #fff;
            border: 3px dashed #d1d5db;
            border-radius: 14px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 180px;
        }
        .add-team-card:hover {
            border-color: #37b24a;
            background: linear-gradient(135deg, #f0fdf4 0%, #f8fff9 100%);
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(55,178,74,0.15);
        }
        .add-team-card i {
            font-size: 40px;
            color: #d1d5db;
            margin-bottom: 12px;
            transition: all 0.3s ease;
        }
        .add-team-card:hover i {
            color: #37b24a;
            transform: scale(1.1);
        }
        
        /* QR Section */
        .qr-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            border-radius: 12px;
        }
        .qr-display #qrcode {
            display: inline-block;
            padding: 20px;
            background: #fff;
            border-radius: 14px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            margin-bottom: 20px;
            border: 2px solid #e5e7eb;
        }
        .qr-display #qrcode img {
            display: block;
        }
        .qr-display .url {
            font-family: monospace;
            font-size: 12px;
            color: #666;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 6px;
            word-break: break-all;
            margin: 15px 0;
        }
        
        /* Round Status */
        .round-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background: linear-gradient(135deg, #37b24a, #2d9440);
            border-radius: 10px;
            color: #fff;
            margin-bottom: 20px;
        }
        .round-status h3 {
            font-size: 18px;
            margin-bottom: 4px;
            color: #fff;
        }
        .round-status p {
            opacity: 0.9;
            font-size: 14px;
        }
        .round-status .score-count {
            text-align: right;
        }
        .round-status .big {
            font-size: 32px;
            font-weight: 700;
        }
        .round-status .label {
            font-size: 12px;
            opacity: 0.8;
        }
        
        /* Rounds List */
        .round-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .round-item h4 {
            font-size: 15px;
            margin-bottom: 2px;
        }
        .round-item p {
            font-size: 13px;
            color: #888;
        }
        .round-item .actions {
            display: flex;
            gap: 8px;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 18px;
            background: #37b24a;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { background: #2d9440; }
        .btn-sm { padding: 8px 14px; font-size: 13px; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-outline {
            background: transparent;
            border: 2px solid #37b24a;
            color: #37b24a;
        }
        .btn-outline:hover {
            background: #37b24a;
            color: #fff;
        }
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #37b24a;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Print Options */
        .print-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .print-grid select {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        /* Par Grid */
        .par-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 8px;
        }
        .par-grid .hole {
            text-align: center;
        }
        .par-grid label {
            display: block;
            font-size: 11px;
            color: #888;
            margin-bottom: 4px;
        }
        .par-grid input {
            width: 100%;
            padding: 10px 5px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
        }
        .par-grid input:focus {
            outline: none;
            border-color: #37b24a;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 200;
            justify-content: center;
            align-items: center;
        }
        .modal.open { display: flex; }
        .modal-content {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            width: 90%;
            max-width: 450px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .modal-header h3 {
            font-size: 18px;
        }
        .modal-header .close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #888;
        }
        .empty-state i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }
        
        /* Setup Form */
        .setup-container {
            max-width: 500px;
            margin: 60px auto;
            padding: 20px;
        }
        .setup-card {
            background: #fff;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .setup-card h1 {
            text-align: center;
            color: #37b24a;
            margin-bottom: 25px;
            font-size: 24px;
        }
        
        /* Desktop/Mobile */
        @media (min-width: 768px) {
            .admin-sidebar {
                display: block !important;
            }
            .mobile-admin-toggle {
                display: none !important;
            }
        }
        @media (max-width: 767px) {
            .admin-sidebar {
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                bottom: 0;
                z-index: 200;
                box-shadow: 4px 0 20px rgba(0,0,0,0.2);
            }
            .admin-sidebar.mobile-open {
                display: block;
            }
            .mobile-admin-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .main-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-left">
                <a href="tel:2033905994"><i class="fas fa-phone"></i> 203.390.5994</a>
                <a href="https://maps.google.com/?q=336+State+Street,+North+Haven,+CT+06473" target="_blank"><i class="fas fa-map-marker-alt"></i> 336 STATE STREET, NORTH HAVEN, CT</a>
            </div>
            <div class="top-bar-right">
                <div class="social-links">
                    <a href="https://www.facebook.com/golfcove/" target="_blank"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/golfcovect/" target="_blank"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-main">
            <div class="logo">
                <a href="index.html">
                    <img src="images/golfcovelogo.png" alt="Golf Cove Logo">
                </a>
            </div>
            <nav class="main-nav" id="mainNav">
                <ul class="nav-menu">
                    <li><a href="index.html">Home</a></li>
                    <li><a href="pricing.html">Pricing</a></li>
                    <li><a href="lessons-leagues.html">Lessons & Leagues</a></li>
                    <li><a href="tournaments.html">Standings</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle Menu">
                <span></span><span></span><span></span>
            </button>
        </div>
    </header>

    <!-- Admin Layout -->
    <div class="admin-wrapper" id="adminWrapper" style="display: none;">
        <!-- Sidebar -->
        <aside class="admin-sidebar" id="adminSidebar">
            <div class="league-info">
                <h2 id="sidebarLeagueName">Golf Cove League</h2>
                <div class="season" id="sidebarSeason">Fall 2025</div>
            </div>
            <div class="admin-nav">
                <a href="tournaments.html" class="nav-item back-link">
                    <i class="fas fa-arrow-left"></i> View Leaderboard
                </a>
                <div class="nav-item active" data-section="dashboard" onclick="showSection('dashboard')">
                    <i class="fas fa-home"></i> Dashboard
                </div>
                <div class="nav-item" data-section="teams" onclick="showSection('teams')">
                    <i class="fas fa-users"></i> Teams
                </div>
                <div class="nav-item" data-section="rounds" onclick="showSection('rounds')">
                    <i class="fas fa-flag"></i> Rounds
                </div>
                <div class="nav-item" data-section="print" onclick="showSection('print')">
                    <i class="fas fa-print"></i> Print
                </div>
                <div class="nav-divider"></div>
                <div class="nav-item" data-section="settings" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Settings
                </div>
                <div class="nav-item danger" onclick="resetLeague()">
                    <i class="fas fa-trash"></i> Reset League
                </div>
                <div class="admin-nav-divider"></div>
                <div class="nav-item danger" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i> Sign Out
                </div>
            </div>
        </aside>
        
        <!-- Mobile overlay -->
        <div class="mobile-sidebar-overlay" id="mobileSidebarOverlay" onclick="toggleMobileSidebar()"></div>
        
        <!-- Main Content Area -->
        <main class="admin-main">
            <div class="main-content">
        
                <!-- Dashboard Section -->
                <div class="page-section active" id="section-dashboard">
                    <h1 class="page-title"><i class="fas fa-home"></i> Dashboard</h1>
            
            <div id="currentRoundStatus"></div>
            
            <div class="card">
                <h3><i class="fas fa-chart-bar"></i> Quick Stats</h3>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 28px; font-weight: 700; color: #37b24a;" id="statTeams">0</div>
                        <div style="font-size: 13px; color: #888;">Teams</div>
                    </div>
                    <div>
                        <div style="font-size: 28px; font-weight: 700; color: #37b24a;" id="statPlayers">0</div>
                        <div style="font-size: 13px; color: #888;">Players</div>
                    </div>
                    <div>
                        <div style="font-size: 28px; font-weight: 700; color: #37b24a;" id="statRounds">0</div>
                        <div style="font-size: 13px; color: #888;">Rounds</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Teams Section -->
        <div class="page-section" id="section-teams">
            <h1 class="page-title"><i class="fas fa-users"></i> Teams</h1>
            <div class="team-grid" id="teamGrid"></div>
        </div>
        
        <!-- Rounds Section -->
        <div class="page-section" id="section-rounds">
            <h1 class="page-title"><i class="fas fa-flag"></i> Rounds</h1>
            
            <div class="card">
                <h3><i class="fas fa-plus-circle"></i> Add New Round</h3>
                <form onsubmit="addRound(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Round Name</label>
                            <input type="text" id="roundName" required placeholder="Week 1">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Start Date</label>
                            <input type="date" id="roundStartDate" required>
                        </div>
                        <div class="form-group">
                            <label>End Date</label>
                            <input type="date" id="roundEndDate" required>
                        </div>
                    </div>
                    <button type="submit" class="btn"><i class="fas fa-plus"></i> Add Round</button>
                </form>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-list"></i> All Rounds</h3>
                <div id="roundsList"></div>
            </div>
        </div>
        
        <!-- Print Section -->
        <div class="page-section" id="section-print">
            <h1 class="page-title"><i class="fas fa-print"></i> Print</h1>
            
            <div class="card">
                <h3><i class="fas fa-id-card"></i> Print Scorecards</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Print blank scorecards for teams or generic use.</p>
                <div class="print-grid">
                    <select id="printTeamSelect" onchange="updatePrintPreview()">
                        <option value="">Select a Team</option>
                    </select>
                </div>
                <div id="printPreview" style="display:none; margin: 20px 0;">
                    <p style="font-size: 13px; color: #666; margin-bottom: 15px; text-align: center; font-weight: 600;">Scorecard Preview:</p>
                    <div id="scorecardPreviewContainer"></div>
                    <div id="teamQRPreview" style="display: none;"></div>
                </div>
                <button class="btn" onclick="printScorecards()" id="printBtn" disabled><i class="fas fa-print"></i> Print Scorecards</button>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-qrcode"></i> General Scoring Link</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">A general link for anyone to enter scores (useful for posting online).</p>
                <div id="generalQRCode" style="text-align: center; margin: 15px 0;"></div>
                <p style="text-align: center; font-size: 12px; color: #888; word-break: break-all;" id="generalQRUrl"></p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                    <button class="btn btn-sm" onclick="copyGeneralUrl()"><i class="fas fa-copy"></i> Copy Link</button>
                </div>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-key"></i> Print Player PINs</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Print a sheet with each player's personal PIN for score entry.</p>
                <button class="btn" onclick="printPinSheet()"><i class="fas fa-print"></i> Print PIN Sheet</button>
            </div>
            
            <div class="card">
                <h3><i class="fas fa-download"></i> Export Data</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Download all league data as a JSON file.</p>
                <button class="btn btn-secondary" onclick="exportData()"><i class="fas fa-download"></i> Export JSON</button>
            </div>
        </div>
        
        <!-- Settings Section -->
        <div class="page-section" id="section-settings">
            <h1 class="page-title"><i class="fas fa-cog"></i> Settings</h1>
            
            <div class="card">
                <h3><i class="fas fa-golf-ball"></i> Course Pars</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Set the par for each hole.</p>
                <div id="parInputsContainer"></div>
                <button class="btn" onclick="savePars()" style="margin-top: 15px;"><i class="fas fa-check"></i> Save Pars</button>
            </div>
        </div>
        
            </div><!-- end main-content -->
        </main>
    </div><!-- end admin-wrapper -->
    
    <!-- Mobile FAB for sidebar -->
    <button class="mobile-admin-toggle" id="mobileAdminToggle" onclick="toggleMobileSidebar()">
        <i class="fas fa-bars"></i>
    </button>
    
    <!-- Logout Button (Desktop) -->
    <button id="desktopLogoutBtn" onclick="handleLogout()" style="position: fixed; top: 80px; right: 20px; background: #e74c3c; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; display: none; align-items: center; gap: 8px; transition: all 0.3s; z-index: 150; box-shadow: 0 2px 10px rgba(231,76,60,0.3);" onmouseover="this.style.background='#c0392b'" onmouseout="this.style.background='#e74c3c'">
        <i class="fas fa-sign-out-alt"></i> <span>Sign Out</span>
    </button>

    <!-- Login Screen -->
    <div class="setup-container" id="loginContainer">
        <div class="setup-card" style="max-width: 400px;">
            <div style="text-align: center; margin-bottom: 25px;">
                <img src="images/golfcovelogo.png" alt="Golf Cove" style="height: 50px; margin-bottom: 15px;">
                <h1 style="font-size: 22px;"><i class="fas fa-shield-alt"></i> Secure Admin Access</h1>
                <p style="color: #666; font-size: 14px; margin-top: 8px;">Sign in with your admin account</p>
            </div>
            <form onsubmit="handleLogin(event)">
                <div class="form-group" style="margin-bottom: 15px;">
                    <input type="email" id="adminEmail" required placeholder="Email Address" 
                           style="text-align: center; font-size: 16px;">
                </div>
                <div class="form-group">
                    <input type="password" id="adminPassword" required placeholder="Password" 
                           style="text-align: center; font-size: 16px; letter-spacing: 2px;">
                </div>
                <div id="loginError" style="color: #e53935; text-align: center; margin-bottom: 15px; display: none;">
                    <i class="fas fa-exclamation-circle"></i> <span id="loginErrorText">Invalid credentials</span>
                </div>
                <button type="submit" id="loginButton" class="btn btn-block">
                    <i class="fas fa-sign-in-alt"></i> Sign In Securely
                </button>
            </form>
            <a href="tournaments.html" class="back-link" style="display: block; text-align: center; margin-top: 20px; color: #37b24a; text-decoration: none;">
                <i class="fas fa-arrow-left"></i> Back to Standings
            </a>
        </div>
    </div>

    <!-- Setup Form (shown when no league exists) -->
    <div class="setup-container" id="setupContainer" style="display: none;">
        <div class="setup-card">
            <h1><i class="fas fa-trophy"></i> Create League</h1>
            <form onsubmit="createLeague(event)">
                <div class="form-group">
                    <label>League Name</label>
                    <input type="text" id="leagueName" required placeholder="Golf Cove Fall League">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Season</label>
                        <input type="text" id="season" required placeholder="Fall 2025">
                    </div>
                    <div class="form-group">
                        <label>Holes</label>
                        <select id="holes">
                            <option value="9">9 Holes</option>
                            <option value="18" selected>18 Holes</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Course Name</label>
                    <input type="text" id="courseName" required placeholder="Golf Cove">
                </div>
                <button type="submit" class="btn btn-block" style="margin-top: 10px;">
                    <i class="fas fa-check"></i> Create League
                </button>
            </form>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div class="modal" id="addPlayerModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add Player to <span id="modalTeamName"></span></h3>
                <button class="close" onclick="closeModal('addPlayerModal')">&times;</button>
            </div>
            <form onsubmit="addPlayerToTeam(event)">
                <input type="hidden" id="addPlayerTeamId">
                <div class="form-group">
                    <label>Player Name</label>
                    <input type="text" id="addPlayerName" required placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label>Handicap</label>
                    <input type="number" id="addPlayerHcp" value="0" min="0" max="54">
                </div>
                <button type="submit" class="btn btn-block"><i class="fas fa-plus"></i> Add Player</button>
            </form>
        </div>
    </div>
    
    <!-- Add Team Modal -->
    <div class="modal" id="addTeamModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Team</h3>
                <button class="close" onclick="closeModal('addTeamModal')">&times;</button>
            </div>
            <form onsubmit="addTeam(event)">
                <div class="form-group">
                    <label>Team Name</label>
                    <input type="text" id="newTeamName" required placeholder="Team Alpha">
                </div>
                <button type="submit" class="btn btn-block"><i class="fas fa-plus"></i> Create Team</button>
            </form>
        </div>
    </div>

    <!-- View Scores Modal -->
    <div class="modal" id="scoresModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="scoresModalTitle">Round Scores</h3>
                <button class="close" onclick="closeModal('scoresModal')">&times;</button>
            </div>
            <div id="scoresModalContent"></div>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8SH5Eh7OhIFLUkL2hjZS23uXkCsDJXGc",
            authDomain: "golfcove.firebaseapp.com",
            databaseURL: "https://golfcove-default-rtdb.firebaseio.com",
            projectId: "golfcove",
            storageBucket: "golfcove.firebasestorage.app",
            messagingSenderId: "284762891644",
            appId: "1:284762891644:web:424223b102f08a230f70f9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const leagueRef = db.ref('league');
        
        let league = null;
        let currentUser = null;
        
        // Rate limiting
        const rateLimits = {
            lastRequest: 0,
            requestCount: 0,
            windowStart: Date.now(),
            maxRequests: 100,
            windowMs: 60000 // 1 minute
        };
        
        function checkRateLimit() {
            const now = Date.now();
            if (now - rateLimits.windowStart > rateLimits.windowMs) {
                rateLimits.requestCount = 0;
                rateLimits.windowStart = now;
            }
            rateLimits.requestCount++;
            if (rateLimits.requestCount > rateLimits.maxRequests) {
                throw new Error('Rate limit exceeded. Please wait before making more requests.');
            }
            const timeSinceLastRequest = now - rateLimits.lastRequest;
            if (timeSinceLastRequest < 100) { // Minimum 100ms between requests
                return false;
            }
            rateLimits.lastRequest = now;
            return true;
        }
        
        function generatePin() {
            // Generate unique 4-digit PIN
            const existingPins = new Set((league?.players || []).map(p => p.pin).filter(Boolean));
            let pin;
            let attempts = 0;
            do {
                pin = String(Math.floor(1000 + Math.random() * 9000));
                attempts++;
            } while (existingPins.has(pin) && attempts < 100);
            return pin;
        }
        
        // Authentication handlers
        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('adminEmail').value;
            const password = document.getElementById('adminPassword').value;
            const loginButton = document.getElementById('loginButton');
            const errorDiv = document.getElementById('loginError');
            const errorText = document.getElementById('loginErrorText');
            
            loginButton.disabled = true;
            loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Signing in...';
            errorDiv.style.display = 'none';
            
            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                // Success handled by onAuthStateChanged
            } catch (error) {
                console.error('Login error:', error);
                let message = 'Invalid credentials';
                if (error.code === 'auth/user-not-found') message = 'No admin account found';
                else if (error.code === 'auth/wrong-password') message = 'Incorrect password';
                else if (error.code === 'auth/invalid-email') message = 'Invalid email format';
                else if (error.code === 'auth/too-many-requests') message = 'Too many attempts. Please try later.';
                else if (error.code === 'auth/network-request-failed') message = 'Network error. Check connection.';
                
                errorText.textContent = message;
                errorDiv.style.display = 'block';
                loginButton.disabled = false;
                loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Sign In Securely';
                document.getElementById('adminPassword').value = '';
            }
        }
        
        async function handleLogout() {
            if (confirm('Are you sure you want to sign out?')) {
                try {
                    await auth.signOut();
                    document.getElementById('loginContainer').style.display = 'flex';
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error signing out. Please try again.');
                }
            }
        }
        
        // Monitor auth state
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('desktopLogoutBtn').style.display = 'flex';
                initAdmin();
            } else {
                currentUser = null;
                document.getElementById('loginContainer').style.display = 'flex';
                document.getElementById('desktopLogoutBtn').style.display = 'none';
                setTimeout(() => {
                    document.getElementById('adminEmail')?.focus();
                }, 100);
            }
        });
        
        function init() {
            // Auth state handled by onAuthStateChanged listener
        }
        
        function initAdmin() {
            // Listen for real-time updates from Firebase
            leagueRef.on('value', (snapshot) => {
                league = snapshot.val();
                
                // Ensure arrays exist (Firebase returns undefined for empty arrays)
                if (league) {
                    league.teams = league.teams || [];
                    league.players = league.players || [];
                    league.rounds = league.rounds || [];
                    league.scores = league.scores || {};
                }
                
                // Migration for old data
                if (league && league.teams.length === 0) {
                    const teamNames = [...new Set(league.players.filter(p => p.team).map(p => p.team))];
                    teamNames.forEach(name => {
                        const teamId = 't' + Date.now() + Math.random().toString(36).substr(2, 5);
                        league.teams.push({ id: teamId, name });
                        league.players.forEach(p => {
                            if (p.team === name) p.teamId = teamId;
                        });
                    });
                    league.players.forEach(p => {
                        if (!p.pin) p.pin = generatePin();
                    });
                    save();
                }
                
                if (league) {
                    document.getElementById('setupContainer').style.display = 'none';
                    document.getElementById('adminWrapper').style.display = 'flex';
                    document.getElementById('mobileAdminToggle').style.display = '';
                    renderAll();
                } else {
                    document.getElementById('setupContainer').style.display = 'block';
                    document.getElementById('adminWrapper').style.display = 'none';
                    document.getElementById('mobileAdminToggle').style.display = 'none';
                }
            });
        }
        
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('adminSidebar');
            const overlay = document.getElementById('mobileSidebarOverlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('open');
        }
        
        function createLeague(e) {
            e.preventDefault();
            const name = document.getElementById('leagueName').value.trim();
            const season = document.getElementById('season').value.trim();
            const courseName = document.getElementById('courseName').value.trim();
            const holes = parseInt(document.getElementById('holes').value);
            
            league = {
                id: 'league_' + Date.now(),
                name, season,
                course: { name: courseName, holes, pars: Array(holes).fill(4) },
                teams: [], players: [], rounds: [], scores: {},
                createdAt: new Date().toISOString()
            };
            save();
            initAdmin();
        }
        
        function renderAll() {
            document.getElementById('sidebarLeagueName').textContent = league.name;
            document.getElementById('sidebarSeason').textContent = league.season;
            document.getElementById('statTeams').textContent = league.teams.length;
            document.getElementById('statPlayers').textContent = league.players.length;
            document.getElementById('statRounds').textContent = league.rounds.length;
            
            document.getElementById('roundName').value = 'Week ' + (league.rounds.length + 1);
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(nextWeek.getDate() + 7);
            document.getElementById('roundStartDate').valueAsDate = today;
            document.getElementById('roundEndDate').valueAsDate = nextWeek;
            
            renderCurrentRound();
            renderTeams();
            renderRounds();
            renderPrintOptions();
            renderParInputs();
        }
        
        function renderCurrentRound() {
            const container = document.getElementById('currentRoundStatus');
            
            if (league.rounds.length === 0) {
                container.innerHTML = `
                    <div class="card">
                        <div class="empty-state">
                            <i class="fas fa-flag"></i>
                            <p>No rounds yet. Create your first round to get started.</p>
                            <button class="btn" onclick="showSection('rounds')" style="margin-top: 15px;">
                                <i class="fas fa-plus"></i> Add Round
                            </button>
                        </div>
                    </div>
                `;
                document.getElementById('qrCard').style.display = 'none';
                return;
            }
            
            const round = league.rounds[league.rounds.length - 1];
            const scored = league.players.filter(p => (league.scores || {})[round.id]?.[p.id]?.submitted).length;
            const total = league.players.length;
            
            const startDate = round.startDate ? new Date(round.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
            const endDate = round.endDate ? new Date(round.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
            const dateDisplay = startDate && endDate ? `${startDate} - ${endDate}` : (round.date ? new Date(round.date).toLocaleDateString() : 'No date');
            
            container.innerHTML = `
                <div class="round-status">
                    <div>
                        <h3>${round.name}</h3>
                        <p>${dateDisplay}</p>
                    </div>
                    <div class="score-count">
                        <div class="big">${scored}/${total}</div>
                        <div class="label">scores submitted</div>
                    </div>
                </div>
            `;
            
            // Update general QR code
            updateGeneralQR();
        }
        
        function updateGeneralQR() {
            const round = league.rounds[league.rounds.length - 1];
            if (!round) return;
            
            const url = window.location.origin + window.location.pathname.replace('league-admin.html', '') + 'score.html?r=' + round.id;
            document.getElementById('generalQRUrl').textContent = url;
            
            const qrContainer = document.getElementById('generalQRCode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: url,
                width: 120,
                height: 120,
                colorDark: '#333333',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }
        
        function updatePrintPreview() {
            const teamId = document.getElementById('printTeamSelect').value;
            const preview = document.getElementById('printPreview');
            const btn = document.getElementById('printBtn');
            const previewContainer = document.getElementById('scorecardPreviewContainer');
            
            const round = league.rounds[league.rounds.length - 1];
            if (!round) {
                if (teamId) {
                    alert('Create a round first');
                    preview.style.display = 'none';
                    btn.disabled = true;
                }
                return;
            }
            
            // Show preview even when no team selected (blank preview)
            const isBlank = !teamId || teamId === 'blank';
            const team = (teamId && teamId !== 'blank') ? league.teams.find(t => t.id === teamId) : null;
            const holes = league.course?.holes || 18;
            const pars = league.course?.pars || Array(holes).fill(4);
            const frontNine = Math.min(9, holes);
            const has18 = holes >= 18;
            
            // Generate QR code for team (hidden, just for print function to access)
            let qrImg = '';
            if (!isBlank) {
                const url = window.location.origin + window.location.pathname.replace('league-admin.html', '') + 'score.html?r=' + round.id + '&t=' + teamId;
                const qrContainer = document.getElementById('teamQRPreview');
                qrContainer.innerHTML = '';
                new QRCode(qrContainer, {
                    text: url,
                    width: 100,
                    height: 100,
                    colorDark: '#333333',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                // Wait a moment for QR to render, then get the image
                setTimeout(() => {
                    qrImg = document.querySelector('#teamQRPreview img')?.src || '';
                }, 100);
            }
            
            // Build scorecard preview HTML
            let frontPars = '', backPars = '', frontTotal = 0, backTotal = 0;
            
            if (isBlank) {
                // For blank scorecards, show empty par cells
                for (let h = 0; h < frontNine; h++) { 
                    frontPars += `<td></td>`; 
                }
                if (has18) {
                    for (let h = 9; h < holes; h++) { 
                        backPars += `<td></td>`; 
                    }
                }
                frontTotal = '';
                backTotal = '';
            } else {
                // For team scorecards, show actual pars
                for (let h = 0; h < frontNine; h++) { 
                    frontPars += `<td>${pars[h]}</td>`; 
                    frontTotal += pars[h]; 
                }
                if (has18) {
                    for (let h = 9; h < holes; h++) { 
                        backPars += `<td>${pars[h]}</td>`; 
                        backTotal += pars[h]; 
                    }
                }
            }
            
            const logoPath = 'images/golfcovelogo.png';
            const teamInfo = isBlank ? '' : `<div class="team-info">${team.name}</div>`;
            const qrSection = !isBlank ? `<div class="qr-container"><div class="qr-placeholder">QR</div></div>` : '';
            const totalPar = isBlank ? '' : (frontTotal + backTotal);
            
            previewContainer.innerHTML = `
                <style>
                    #scorecardPreviewContainer .scorecard {
                        background: #fff;
                        border: 2px solid #000;
                        padding: 15px;
                        max-width: 100%;
                        margin: 0 auto;
                        font-family: 'Arial', sans-serif;
                    }
                    #scorecardPreviewContainer .top-section {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 10px;
                        padding-bottom: 10px;
                        border-bottom: 2px solid #000;
                        position: relative;
                    }
                    #scorecardPreviewContainer .center-header {
                        flex: 1;
                        text-align: center;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                    }
                    #scorecardPreviewContainer .logo {
                        height: 50px;
                        width: auto;
                    }
                    #scorecardPreviewContainer .league-title {
                        font-size: 14px;
                        font-weight: bold;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    #scorecardPreviewContainer .tournament-details {
                        font-size: 10px;
                        color: #666;
                        font-weight: 600;
                    }
                    #scorecardPreviewContainer .team-info {
                        font-size: 11px;
                        font-weight: bold;
                        color: #37b24a;
                    }
                    #scorecardPreviewContainer .qr-container {
                        position: absolute;
                        right: 0;
                        top: 0;
                    }
                    #scorecardPreviewContainer .qr-placeholder {
                        width: 55px;
                        height: 55px;
                        background: #e0e0e0;
                        border: 1px solid #000;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        font-size: 11px;
                        font-weight: bold;
                        color: #666;
                    }
                    #scorecardPreviewContainer .score-grid {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 10px;
                    }
                    #scorecardPreviewContainer .score-grid td {
                        border: 1px solid #000;
                        text-align: center;
                        padding: 5px 2px;
                        font-size: 10px;
                    }
                    #scorecardPreviewContainer .name-cell {
                        background: #333;
                        color: #fff;
                        font-weight: bold;
                        font-size: 9px;
                        text-transform: uppercase;
                        width: 80px;
                        text-align: left;
                        padding-left: 4px;
                    }
                    #scorecardPreviewContainer .label-cell {
                        background: #333;
                        color: #fff;
                        font-weight: bold;
                        font-size: 9px;
                        text-transform: uppercase;
                        width: 50px;
                    }
                    #scorecardPreviewContainer .holes-row td {
                        font-weight: bold;
                        font-size: 9px;
                        background: #f5f5f5;
                    }
                    #scorecardPreviewContainer .par-row td {
                        background: #f5f5f5;
                        font-weight: 600;
                    }
                    #scorecardPreviewContainer .player-row td {
                        height: 22px;
                        background: #fff;
                    }
                    #scorecardPreviewContainer .player-row .name-cell {
                        background: #fff;
                        color: #000;
                        border-right: 2px solid #000;
                        font-weight: normal;
                    }
                    #scorecardPreviewContainer .total-cell {
                        background: #e8e8e8 !important;
                        font-weight: bold;
                    }
                    #scorecardPreviewContainer .bottom-row {
                        display: flex;
                        gap: 25px;
                        padding-top: 8px;
                        border-top: 1px solid #000;
                        font-size: 9px;
                    }
                    #scorecardPreviewContainer .bottom-row .field {
                        display: flex;
                        gap: 5px;
                    }
                    #scorecardPreviewContainer .bottom-row .field span {
                        font-weight: bold;
                    }
                    #scorecardPreviewContainer .qr-text {
                        font-size: 8px;
                        color: #333;
                        margin-top: 3px;
                        line-height: 1.2;
                        font-weight: bold;
                    }
                    #scorecardPreviewContainer .player-info {
                        margin-bottom: 15px;
                        padding: 12px;
                        background: #f9f9f9;
                        border: 2px solid #000;
                    }
                    #scorecardPreviewContainer .info-row {
                        display: flex;
                        gap: 25px;
                        justify-content: space-between;
                    }
                    #scorecardPreviewContainer .info-item {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    }
                    #scorecardPreviewContainer .info-item .label {
                        font-size: 10px;
                        font-weight: bold;
                        color: #000;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    #scorecardPreviewContainer .info-item .value {
                        font-size: 11px;
                        color: #333;
                        border-bottom: 1px solid #000;
                    }
                    #scorecardPreviewContainer .score-table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 15px;
                        border: 2px solid #000;
                    }
                    #scorecardPreviewContainer .score-table th,
                    #scorecardPreviewContainer .score-table td {
                        padding: 7px 3px;
                        text-align: center;
                        border: 1px solid #000;
                        font-size: 10px;
                    }
                    #scorecardPreviewContainer .score-table thead {
                        background: #37b24a;
                        color: #fff;
                    }
                    #scorecardPreviewContainer .hole-label {
                        background: #1a1a1a !important;
                        font-weight: bold;
                        font-size: 9px;
                        text-transform: uppercase;
                    }
                    #scorecardPreviewContainer .hole-num {
                        font-weight: bold;
                        min-width: 28px;
                    }
                    #scorecardPreviewContainer .subtotal {
                        background: #2d9440 !important;
                        font-weight: bold;
                    }
                    #scorecardPreviewContainer .total {
                        background: #1a6b2e !important;
                        font-weight: bold;
                    }
                    #scorecardPreviewContainer .hcp-col,
                    #scorecardPreviewContainer .net-col {
                        background: #1a6b2e !important;
                        font-weight: bold;
                    }
                    #scorecardPreviewContainer .row-label {
                        background: #333 !important;
                        color: #fff !important;
                        font-weight: bold;
                        text-transform: uppercase;
                        font-size: 9px;
                        letter-spacing: 0.5px;
                    }
                    #scorecardPreviewContainer .par-row td {
                        background: #f5f5f5;
                        font-weight: 600;
                        color: #000;
                        font-size: 11px;
                    }
                    #scorecardPreviewContainer .par-row .row-label {
                        background: #666 !important;
                        color: #fff !important;
                    }
                    #scorecardPreviewContainer .score-row td {
                        background: #fff;
                        height: 30px;
                    }
                    #scorecardPreviewContainer .score-row .row-label {
                        background: #333 !important;
                        color: #fff !important;
                    }
                    #scorecardPreviewContainer .subtotal-cell {
                        background: #e8f5e9 !important;
                        font-weight: 600;
                    }
                    #scorecardPreviewContainer .total-cell {
                        background: #c8e6c9 !important;
                        font-weight: bold;
                    }
                    #scorecardPreviewContainer .empty-cell {
                        background: #fff !important;
                    }
                    #scorecardPreviewContainer .card-footer {
                        display: flex;
                        justify-content: space-between;
                        padding-top: 12px;
                        border-top: 2px solid #000;
                        gap: 20px;
                    }
                    #scorecardPreviewContainer .footer-item {
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    }
                    #scorecardPreviewContainer .footer-label {
                        font-size: 9px;
                        font-weight: bold;
                        color: #000;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    #scorecardPreviewContainer .footer-line {
                        font-size: 10px;
                        color: #333;
                        border-bottom: 1px solid #000;
                    }
                </style>
                <div class="scorecard">
                    <div class="top-section">
                        <div class="center-header">
                            <img src="${logoPath}" alt="Golf Cove" class="logo">
                            <div class="league-title">${league.name || 'League Name'}</div>
                            <div class="tournament-details">${round.name} - ${new Date(round.date).toLocaleDateString()}</div>
                            ${teamInfo}
                        </div>
                        ${qrSection}
                    </div>
                    <table class="score-grid">
                        <tr class="holes-row">
                            <td class="name-cell">NAME</td>
                            ${Array.from({length:frontNine},(_,i)=>`<td>${i+1}</td>`).join('')}
                            <td class="total-cell">OUT</td>
                            ${has18?Array.from({length:holes-9},(_,i)=>`<td>${i+10}</td>`).join(''):''}
                            ${has18?'<td class="total-cell">IN</td>':''}
                            <td class="total-cell">TOT</td>
                            <td class="total-cell">HCP</td>
                            <td class="total-cell">NET</td>
                        </tr>
                        <tr class="par-row">
                            <td class="label-cell" style="background:#666;text-align:center;">PAR</td>
                            ${frontPars}
                            <td class="total-cell">${frontTotal}</td>
                            ${has18?backPars:''}
                            ${has18?`<td class="total-cell">${backTotal}</td>`:''}
                            <td class="total-cell">${totalPar}</td>
                            <td></td>
                            <td></td>
                        </tr>
                        ${Array.from({length:6},()=>`
                        <tr class="player-row">
                            <td class="name-cell"></td>
                            ${Array.from({length:frontNine},()=>'<td></td>').join('')}
                            <td class="total-cell"></td>
                            ${has18?Array.from({length:holes-9},()=>'<td></td>').join(''):''}
                            ${has18?'<td class="total-cell"></td>':''}
                            <td class="total-cell"></td>
                            <td></td>
                            <td></td>
                        </tr>`).join('')}
                    </table>
                    <div class="bottom-row">
                        <div class="field"><span>SCORER:</span> _________________</div>
                        <div class="field"><span>ATTEST:</span> _________________</div>
                        <div class="field"><span>DATE:</span> __________</div>
                    </div>
                </div>
            `;
            
            preview.style.display = 'block';
            btn.disabled = false; // Enable button for both blank and team scorecards
        }
        
        function copyGeneralUrl() {
            const url = document.getElementById('generalQRUrl').textContent;
            navigator.clipboard.writeText(url);
            alert('Link copied!');
        }
        
        function renderTeams() {
            const container = document.getElementById('teamGrid');
            
            let html = league.teams.map(team => {
                const players = league.players.filter(p => p.teamId === team.id);
                return `
                    <div class="team-card">
                        <div class="team-header">
                            <span class="team-name">${team.name}</span>
                            <button class="delete-btn" onclick="deleteTeam('${team.id}')"><i class="fas fa-times"></i></button>
                        </div>
                        ${players.length === 0 ? '<p style="color: #999; font-size: 13px;">No players yet</p>' : 
                            players.map(p => `
                                <div class="player">
                                    <span class="player-name">${p.name}</span>
                                    <div class="player-meta">
                                        <span class="hcp">HCP ${p.handicap}</span>
                                        <span class="pin">${p.pin}</span>
                                        <button class="delete-btn" onclick="deletePlayer('${p.id}')"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>
                            `).join('')
                        }
                        <button class="add-player-btn" onclick="openAddPlayerModal('${team.id}', '${team.name.replace(/'/g, "\\'")}')">
                            <i class="fas fa-plus"></i> Add Player
                        </button>
                    </div>
                `;
            }).join('');
            
            html += `
                <div class="add-team-card" onclick="openModal('addTeamModal')">
                    <i class="fas fa-plus"></i>
                    <span style="color: #888;">Add Team</span>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function renderRounds() {
            const container = document.getElementById('roundsList');
            
            if (league.rounds.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fas fa-flag"></i><p>No rounds yet</p></div>';
                return;
            }
            
            container.innerHTML = league.rounds.slice().reverse().map(r => {
                const scored = league.players.filter(p => (league.scores || {})[r.id]?.[p.id]?.submitted).length;
                const startDate = r.startDate ? new Date(r.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'N/A';
                const endDate = r.endDate ? new Date(r.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
                const dateDisplay = r.startDate && r.endDate ? `${startDate} - ${endDate}` : (r.date ? new Date(r.date).toLocaleDateString() : 'No date');
                const status = r.finalized ? '<span style=\"color: #888; font-size: 12px;\"> Finalized</span>' : '';\n                return `
                    <div class="round-item">
                        <div>
                            <h4>${r.name}</h4>
                            <p>${dateDisplay}  ${scored}/${league.players.length} scores ${status}</p>
                        </div>
                        <div class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="viewRoundScores('${r.id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRound('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderPrintOptions() {
            const select = document.getElementById('printTeamSelect');
            select.innerHTML = '<option value="">Select a Team</option>' + 
                league.teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            
            // Show blank preview by default
            updatePrintPreview();
        }
        
        function renderParInputs() {
            const container = document.getElementById('parInputsContainer');
            const holes = league.course?.holes || 18;
            const pars = league.course?.pars || Array(holes).fill(4);
            
            let html = '<div class="par-grid">';
            for (let i = 0; i < Math.min(9, holes); i++) {
                html += `<div class="hole"><label>H${i + 1}</label><input type="number" min="3" max="6" value="${pars[i]}" id="par${i}"></div>`;
            }
            html += '</div>';
            
            if (holes > 9) {
                html += '<div class="par-grid" style="margin-top: 15px;">';
                for (let i = 9; i < holes; i++) {
                    html += `<div class="hole"><label>H${i + 1}</label><input type="number" min="3" max="6" value="${pars[i]}" id="par${i}"></div>`;
                }
                html += '</div>';
            }
            
            container.innerHTML = html;
        }
        
        // Navigation
        function toggleSidebar() {
            document.getElementById('adminSidebar').classList.toggle('mobile-open');
        }
        
        function showSection(section) {
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('section-' + section).classList.add('active');
            document.querySelector(`[data-section="${section}"]`).classList.add('active');
            
            // Close sidebar on mobile
            document.getElementById('adminSidebar').classList.remove('mobile-open');
            document.getElementById('mobileSidebarOverlay').classList.remove('open');
        }
        
        // Teams
        function addTeam(e) {
            e.preventDefault();
            const name = document.getElementById('newTeamName').value.trim();
            if (!name) return;
            
            league.teams.push({ id: 't' + Date.now() + Math.random().toString(36).substr(2, 5), name });
            document.getElementById('newTeamName').value = '';
            save();
            closeModal('addTeamModal');
            renderAll();
        }
        
        function deleteTeam(id) {
            if (!confirm('Delete this team?')) return;
            league.players.forEach(p => { if (p.teamId === id) p.teamId = null; });
            league.teams = league.teams.filter(t => t.id !== id);
            save();
            renderAll();
        }
        
        // Players
        function openAddPlayerModal(teamId, teamName) {
            document.getElementById('addPlayerTeamId').value = teamId;
            document.getElementById('modalTeamName').textContent = teamName;
            document.getElementById('addPlayerName').value = '';
            document.getElementById('addPlayerHcp').value = '0';
            openModal('addPlayerModal');
        }
        
        function addPlayerToTeam(e) {
            e.preventDefault();
            const teamId = document.getElementById('addPlayerTeamId').value;
            const name = document.getElementById('addPlayerName').value.trim();
            const handicap = parseInt(document.getElementById('addPlayerHcp').value) || 0;
            
            if (!name) return;
            
            league.players.push({
                id: 'p' + Date.now() + Math.random().toString(36).substr(2, 5),
                name, teamId, handicap,
                pin: generatePin()
            });
            save();
            closeModal('addPlayerModal');
            renderAll();
        }
        
        function deletePlayer(id) {
            if (!confirm('Remove this player?')) return;
            league.players = league.players.filter(p => p.id !== id);
            save();
            renderAll();
        }
        
        // Rounds
        function addRound(e) {
            e.preventDefault();
            const name = document.getElementById('roundName').value.trim();
            const startDate = document.getElementById('roundStartDate').value;
            const endDate = document.getElementById('roundEndDate').value;
            
            if (new Date(endDate) < new Date(startDate)) {
                alert('End date must be after start date');
                return;
            }
            
            league.rounds.push({
                id: 'r' + Date.now() + Math.random().toString(36).substr(2, 5),
                name,
                startDate,
                endDate,
                finalized: false,
                createdAt: new Date().toISOString()
            });
            save();
            renderAll();
        }
        
        function deleteRound(id) {
            if (!confirm('Delete this round and all scores?')) return;
            league.rounds = league.rounds.filter(r => r.id !== id);
            if (league.scores) delete league.scores[id];
            save();
            renderAll();
        }
        
        function viewRoundScores(roundId) {
            const round = league.rounds.find(r => r.id === roundId);
            if (!round) return;
            
            document.getElementById('scoresModalTitle').textContent = round.name + ' Scores';
            
            const holes = league.course?.holes || 18;
            const scores = league.players.map(p => {
                const ps = (league.scores || {})[roundId]?.[p.id];
                const handicap = p.handicap || 0;
                if (!ps || !ps.submitted) return { name: p.name, handicap, gross: null };
                let gross = 0;
                let holesPlayed = 0;
                for (let h = 1; h <= holes; h++) {
                    if (ps[h] && ps[h] > 0) {
                        gross += ps[h];
                        holesPlayed++;
                    }
                }
                return { name: p.name, handicap, gross, net: gross - handicap, holesPlayed };
            }).sort((a, b) => {
                if (a.gross === null) return 1;
                if (b.gross === null) return -1;
                return a.net - b.net;
            });
            
            document.getElementById('scoresModalContent').innerHTML = scores.map(s => `
                <div class="round-item">
                    <div>
                        <h4>${s.name}</h4>
                        <p>HCP ${s.handicap}</p>
                    </div>
                    ${s.gross !== null ? `
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; color: #37b24a;">${s.gross}${s.holesPlayed < holes ? ` <span style="font-size:12px;color:#888">(${s.holesPlayed}h)</span>` : ''}</div>
                            <div style="font-size: 12px; color: #888;">Net: ${s.net}</div>
                        </div>
                    ` : '<span style="color: #999;">No score</span>'}
                </div>
            `).join('');
            
            openModal('scoresModal');
        }
        
        // Settings
        function savePars() {
            const holes = league.course?.holes || 18;
            const pars = [];
            for (let i = 0; i < holes; i++) {
                pars.push(parseInt(document.getElementById('par' + i).value) || 4);
            }
            league.course.pars = pars;
            save();
            alert('Pars saved!');
        }
        
        // QR & URLs
        function copyUrl() {
            navigator.clipboard.writeText(document.getElementById('scoringUrl').textContent);
            alert('Link copied!');
        }
        
        function printQR() {
            const round = league.rounds[league.rounds.length - 1];
            const url = document.getElementById('scoringUrl').textContent;
            const qrImg = document.querySelector('#qrcode img')?.src || '';
            
            const w = window.open('', '_blank');
            w.document.write(`
                <!DOCTYPE html><html><head><title>QR Code</title>
                <style>body{font-family:Arial;text-align:center;padding:40px;}h1{color:#37b24a;}</style>
                </head><body>
                <h1> ${league.name}</h1>
                <h2>${round.name} - ${new Date(round.date).toLocaleDateString()}</h2>
                <img src="${qrImg}" width="250" height="250" style="margin:30px;">
                <p>Scan to enter your score</p>
                <p style="font-family:monospace;background:#f5f5f5;padding:10px;border-radius:5px;">${url}</p>
                </body></html>
            `);
            w.document.close();
            setTimeout(() => w.print(), 250);
        }
        
        // Print Functions
        function printPinSheet() {
            if (league.players.length === 0) { alert('No players'); return; }
            const w = window.open('', '_blank');
            w.document.write(`
                <!DOCTYPE html><html><head><title>Player PINs</title>
                <style>body{font-family:Arial;padding:30px;}h1{color:#37b24a;}table{width:100%;border-collapse:collapse;}th,td{padding:10px 15px;text-align:left;border-bottom:1px solid #ddd;}th{background:#f5f5f5;}.pin{font-family:monospace;font-size:18px;font-weight:bold;}</style>
                </head><body>
                <h1> ${league.name}</h1>
                <h2>Player PINs</h2>
                <table><tr><th>Player</th><th>Team</th><th>PIN</th></tr>
                ${league.players.map(p => {
                    const team = league.teams.find(t => t.id === p.teamId);
                    return `<tr><td>${p.name}</td><td>${team?.name || '-'}</td><td class="pin">${p.pin}</td></tr>`;
                }).join('')}
                </table>
                </body></html>
            `);
            w.document.close();
            setTimeout(() => w.print(), 250);
        }
        
        function printScorecards() {
            const teamId = document.getElementById('printTeamSelect').value;
            
            if (league.rounds.length === 0) { alert('Create a round first'); return; }
            
            const round = league.rounds[league.rounds.length - 1];
            const isBlank = !teamId;
            const team = teamId ? league.teams.find(t => t.id === teamId) : null;
            const holes = league.course?.holes || 18;
            const pars = league.course?.pars || Array(holes).fill(4);
            const frontNine = Math.min(9, holes);
            const has18 = holes >= 18;
            
            // Get the team-specific QR code (empty for blank cards)
            const qrImg = isBlank ? '' : (document.querySelector('#teamQRPreview img')?.src || '');
            
            const players = isBlank ? [] : league.players.filter(p => p.teamId === teamId);
            
            // Print enough blank scorecards for the team (or 5 for blank option)
            const cardCount = isBlank ? 5 : Math.max(players.length, 5);
            
            const buildCard = () => {
                let frontPars = '', backPars = '', frontTotal = 0, backTotal = 0;
                for (let h = 0; h < frontNine; h++) { frontPars += `<td>${pars[h]}</td>`; frontTotal += pars[h]; }
                if (has18) for (let h = 9; h < holes; h++) { backPars += `<td>${pars[h]}</td>`; backTotal += pars[h]; }
                
                const logoPath = window.location.origin + window.location.pathname.replace('league-admin.html', '') + 'images/golfcovelogo.png';
                
                const teamInfo = isBlank ? '' : `<div class="team-info">${team.name}</div>`;
                const qrSection = qrImg ? `<div class="qr-container"><img src="${qrImg}" class="qr-img"></div>` : '';
                
                return `
                    <div class="scorecard">
                        <div class="top-section">
                            <div class="center-header">
                                <img src="${logoPath}" class="logo">
                                <div class="league-title">${league.name}</div>
                                <div class="tournament-details">${round.name} - ${new Date(round.date).toLocaleDateString()}</div>
                                ${teamInfo}
                            </div>
                            ${qrSection}
                        </div>
                        
                        <table class="score-grid">
                            <tr class="holes-row">
                                <td class="name-cell">NAME</td>
                                ${Array.from({length:frontNine},(_,i)=>`<td>${i+1}</td>`).join('')}
                                <td class="total-cell">OUT</td>
                                ${has18?Array.from({length:holes-9},(_,i)=>`<td>${i+10}</td>`).join(''):''}
                                ${has18?'<td class="total-cell">IN</td>':''}
                                <td class="total-cell">TOT</td>
                                <td class="total-cell">HCP</td>
                                <td class="total-cell">NET</td>
                            </tr>
                            <tr class="par-row">
                                <td class="label-cell" style="background:#666;text-align:center;">PAR</td>
                                ${frontPars}
                                <td class="total-cell">${frontTotal}</td>
                                ${has18?backPars:''}
                                ${has18?`<td class="total-cell">${backTotal}</td>`:''}
                                <td class="total-cell">${frontTotal+backTotal}</td>
                                <td></td>
                                <td></td>
                            </tr>
                            ${Array.from({length:6},()=>`
                            <tr class="player-row">
                                <td class="name-cell"></td>
                                ${Array.from({length:frontNine},()=>'<td></td>').join('')}
                                <td class="total-cell"></td>
                                ${has18?Array.from({length:holes-9},()=>'<td></td>').join(''):''}
                                ${has18?'<td class="total-cell"></td>':''}
                                <td class="total-cell"></td>
                                <td></td>
                                <td></td>
                            </tr>`).join('')}
                        </table>
                        
                        <div class="bottom-row">
                            <div class="field"><span>SCORER:</span> _____________________</div>
                            <div class="field"><span>ATTEST:</span> _____________________</div>
                            <div class="field"><span>DATE:</span> _____________</div>
                        </div>
                    </div>
                `;
            };
            
            const w = window.open('', '_blank');
            const title = isBlank ? 'Blank Scorecards' : `Blank Scorecards - ${team.name}`;
            w.document.write(`
                <!DOCTYPE html><html><head><title>${title}</title>
                <style>
                    @page { size: landscape; margin: 0.5cm; }
                    * { margin: 0; padding: 0; box-sizing: border-box; }
                    body {
                        font-family: 'Arial', 'Helvetica', sans-serif;
                        padding: 10px;
                        background: #fff;
                    }
                    .scorecard {
                        border: 2px solid #000;
                        padding: 12px;
                        margin-bottom: 15px;
                        page-break-inside: avoid;
                        page-break-after: always;
                    }
                    .scorecard:last-child { page-break-after: auto; }
                    
                    .top-section {
                        display: flex;
                        justify-content: space-between;
                        align-items: flex-start;
                        margin-bottom: 8px;
                        padding-bottom: 8px;
                        border-bottom: 2px solid #000;
                        position: relative;
                    }
                    .center-header {
                        flex: 1;
                        text-align: center;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 4px;
                    }
                    .logo {
                        height: 50px;
                        width: auto;
                    }
                    .league-title {
                        font-size: 14px;
                        font-weight: bold;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                    }
                    .tournament-details {
                        font-size: 10px;
                        color: #666;
                        font-weight: 600;
                    }
                    .team-info {
                        font-size: 11px;
                        font-weight: bold;
                        color: #37b24a;
                    }
                    .qr-container {
                        position: absolute;
                        right: 0;
                        top: 0;
                    }
                    .qr-img {
                        width: 55px;
                        height: 55px;
                        border: 1px solid #000;
                    }
                    
                    .score-grid {
                        width: 100%;
                        border-collapse: collapse;
                        margin-bottom: 8px;
                    }
                    .score-grid td {
                        border: 1px solid #000;
                        text-align: center;
                        padding: 4px 2px;
                        font-size: 10px;
                    }
                    .name-cell {
                        background: #333;
                        color: #fff;
                        font-weight: bold;
                        font-size: 9px;
                        text-transform: uppercase;
                        width: 80px;
                        text-align: left;
                        padding-left: 4px;
                    }
                    .label-cell {
                        background: #333;
                        color: #fff;
                        font-weight: bold;
                        font-size: 9px;
                        text-transform: uppercase;
                        width: 50px;
                    }
                    .holes-row td {
                        font-weight: bold;
                        font-size: 9px;
                        background: #f5f5f5;
                    }
                    .par-row td {
                        background: #f5f5f5;
                        font-weight: 600;
                    }
                    .player-row td {
                        height: 22px;
                        background: #fff;
                    }
                    .player-row .name-cell {
                        background: #fff;
                        color: #000;
                        border-right: 2px solid #000;
                        font-weight: normal;
                    }
                    .total-cell {
                        background: #e8e8e8 !important;
                        font-weight: bold;
                    }
                    
                    .bottom-row {
                        display: flex;
                        gap: 30px;
                        padding-top: 6px;
                        border-top: 1px solid #000;
                        font-size: 9px;
                    }
                    .bottom-row .field {
                        display: flex;
                        gap: 5px;
                    }
                    .bottom-row .field span {
                        font-weight: bold;
                    }
                    
                    @media print {
                        body { padding: 0; }
                        .scorecard { border-width: 1px; }
                    }
                </style></head><body>${Array.from({length: cardCount}, () => buildCard()).join('')}</body></html>
            `);
            w.document.close();
            setTimeout(() => w.print(), 300);
        }
        
        function exportData() {
            const blob = new Blob([JSON.stringify(league, null, 2)], { type: 'application/json' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = league.name.replace(/\s+/g, '_') + '_export.json';
            a.click();
        }
        
        function resetLeague() {
            if (!confirm('Delete the entire league? This cannot be undone!')) return;
            if (!confirm('Are you absolutely sure?')) return;
            leagueRef.remove();
            league = null;
        }
        
        // Modal helpers
        function openModal(id) { document.getElementById(id).classList.add('open'); }
        function closeModal(id) { document.getElementById(id).classList.remove('open'); }
        
        function save() {
            if (!currentUser) {
                alert('You must be signed in to make changes.');
                return;
            }
            try {
                if (!checkRateLimit()) {
                    console.warn('Request throttled - please slow down');
                    return;
                }
                leagueRef.set(league);
            } catch (error) {
                alert(error.message);
            }
        }
        
        init();
    </script>
    <script src="js/main.js"></script>
</body>
</html>

