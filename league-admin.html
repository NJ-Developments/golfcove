<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League Admin - Golf Cove</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        .admin-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .admin-header h1 {
            color: #37b24a;
            font-size: 28px;
            margin-bottom: 5px;
        }
        .admin-header .season {
            color: #666;
            font-size: 16px;
        }
        
        /* Grid Layout */
        .admin-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .admin-grid {
                grid-template-columns: 1fr;
            }
        }
        .full-width {
            grid-column: 1 / -1;
        }
        
        /* Cards */
        .card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            padding: 20px;
        }
        .card h2 {
            font-size: 16px;
            color: #333;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .card h2 i {
            color: #37b24a;
        }
        
        /* Team Cards */
        .team-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #37b24a;
        }
        .team-card .team-name {
            font-weight: 700;
            font-size: 15px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .team-card .team-name button {
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 14px;
        }
        .team-card .team-name button:hover {
            color: #dc3545;
        }
        .team-card .players {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .team-card .player {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #555;
        }
        .team-card .player .hcp {
            color: #888;
            font-size: 12px;
        }
        .team-card .player .pin {
            font-family: monospace;
            background: #e9ecef;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
            color: #666;
        }
        
        /* Add Team Form */
        .add-team-form {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        .add-team-form input {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .add-team-form input:focus {
            outline: none;
            border-color: #37b24a;
        }
        
        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 10px 16px;
            background: #37b24a;
            color: #fff;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
        }
        .btn:hover {
            background: #2d9440;
        }
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }
        .btn-secondary {
            background: #6c757d;
        }
        .btn-secondary:hover {
            background: #5a6268;
        }
        .btn-danger {
            background: #dc3545;
        }
        .btn-danger:hover {
            background: #c82333;
        }
        .btn-outline {
            background: transparent;
            border: 2px solid #37b24a;
            color: #37b24a;
        }
        .btn-outline:hover {
            background: #37b24a;
            color: #fff;
        }
        
        /* QR Section */
        .qr-section {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .qr-section #qrcode {
            display: inline-block;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .qr-section #qrcode img {
            display: block;
        }
        .qr-section .url {
            font-family: monospace;
            font-size: 11px;
            color: #666;
            word-break: break-all;
            margin: 10px 0;
        }
        .qr-actions {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 10px;
        }
        
        /* Round Status */
        .round-status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .round-status .info h3 {
            margin: 0 0 4px 0;
            font-size: 16px;
        }
        .round-status .info p {
            margin: 0;
            color: #666;
            font-size: 13px;
        }
        .round-status .score-count {
            text-align: right;
        }
        .round-status .score-count .big {
            font-size: 24px;
            font-weight: 700;
            color: #37b24a;
        }
        .round-status .score-count .label {
            font-size: 12px;
            color: #888;
        }
        
        /* Print Options */
        .print-options {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .print-options select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 13px;
            min-width: 150px;
        }
        
        /* Rounds List */
        .round-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .round-item h4 {
            margin: 0 0 2px 0;
            font-size: 14px;
        }
        .round-item p {
            margin: 0;
            color: #888;
            font-size: 12px;
        }
        .round-item .actions {
            display: flex;
            gap: 6px;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .quick-action {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .quick-action:hover {
            border-color: #37b24a;
            background: #fff;
        }
        .quick-action i {
            font-size: 24px;
            color: #37b24a;
        }
        .quick-action span {
            font-size: 13px;
            font-weight: 600;
            color: #333;
        }
        
        /* Empty State */
        .empty {
            text-align: center;
            color: #888;
            padding: 30px;
            font-size: 14px;
        }
        
        /* Form Groups */
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #37b24a;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Danger Zone */
        .danger-zone {
            border: 2px solid #dc3545;
            background: #fff5f5;
        }
        .danger-zone h2 {
            color: #dc3545;
        }
        .danger-zone h2 i {
            color: #dc3545;
        }
        
        /* Back Link */
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #37b24a;
            text-decoration: none;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 14px;
        }
        
        /* Setup Form */
        .setup-form, .dashboard {
            display: none;
        }
        .setup-form.active, .dashboard.active {
            display: block;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.open {
            display: flex;
        }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-content h3 {
            margin: 0 0 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-content .close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        /* Par Inputs */
        .par-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(55px, 1fr));
            gap: 8px;
        }
        .par-inputs > div {
            text-align: center;
        }
        .par-inputs label {
            font-size: 11px;
            color: #666;
        }
        .par-inputs input {
            width: 100%;
            padding: 8px;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-left">
                <a href="tel:2033905994"><i class="fas fa-phone"></i> 203.390.5994</a>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-main">
            <div class="logo">
                <a href="index.html">
                    <img src="images/golfcovelogo.png" alt="Golf Cove Logo">
                </a>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <a href="tournaments.html" class="back-link"><i class="fas fa-arrow-left"></i> Back to Leaderboard</a>

        <!-- Setup Form (shown if no league) -->
        <div class="setup-form" id="setupForm">
            <div class="admin-header">
                <h1><i class="fas fa-trophy"></i> Create Your League</h1>
            </div>

            <div class="card">
                <form onsubmit="createLeague(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>League Name</label>
                            <input type="text" id="leagueName" required placeholder="Golf Cove Fall League">
                        </div>
                        <div class="form-group">
                            <label>Season</label>
                            <input type="text" id="season" required placeholder="Fall 2025">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Course Name</label>
                            <input type="text" id="courseName" required placeholder="Golf Cove">
                        </div>
                        <div class="form-group">
                            <label>Holes</label>
                            <select id="holes">
                                <option value="9">9 Holes</option>
                                <option value="18" selected>18 Holes</option>
                            </select>
                        </div>
                    </div>

                    <button type="submit" class="btn" style="width: 100%; justify-content: center; margin-top: 10px;">
                        <i class="fas fa-check"></i> Create League
                    </button>
                </form>
            </div>
        </div>

        <!-- Dashboard (shown if league exists) -->
        <div class="dashboard" id="dashboard">
            <div class="admin-header">
                <h1 id="leagueTitle">League Admin</h1>
                <p class="season" id="leagueSeason"></p>
            </div>

            <div class="admin-grid">
                
                <!-- Teams Section -->
                <div class="card full-width">
                    <h2><i class="fas fa-users"></i> Teams</h2>
                    <div id="teamsList"></div>
                    <form class="add-team-form" onsubmit="addTeam(event)">
                        <input type="text" id="newTeamName" placeholder="New team name..." required>
                        <button type="submit" class="btn"><i class="fas fa-plus"></i> Add Team</button>
                    </form>
                </div>

                <!-- Current Round -->
                <div class="card">
                    <h2><i class="fas fa-flag"></i> Current Round</h2>
                    <div id="currentRound">
                        <div class="empty">No rounds yet</div>
                    </div>
                </div>

                <!-- QR Code -->
                <div class="card" id="qrCard" style="display: none;">
                    <h2><i class="fas fa-qrcode"></i> Scoring Link</h2>
                    <div class="qr-section">
                        <div id="qrcode"></div>
                        <div class="url" id="scoringUrl"></div>
                        <div class="qr-actions">
                            <button class="btn btn-sm" onclick="copyUrl()"><i class="fas fa-copy"></i> Copy</button>
                            <button class="btn btn-sm btn-secondary" onclick="printQR()"><i class="fas fa-print"></i> Print</button>
                        </div>
                    </div>
                </div>

                <!-- Print Scorecards -->
                <div class="card">
                    <h2><i class="fas fa-print"></i> Print Scorecards</h2>
                    <div class="print-options">
                        <select id="printTeamSelect">
                            <option value="">Blank Cards</option>
                        </select>
                        <select id="printCount">
                            <option value="2">2 Cards</option>
                            <option value="4">4 Cards</option>
                            <option value="1">1 Card</option>
                        </select>
                        <button class="btn" onclick="printScorecards()"><i class="fas fa-print"></i> Print</button>
                    </div>
                </div>

                <!-- Add Round -->
                <div class="card">
                    <h2><i class="fas fa-plus-circle"></i> New Round</h2>
                    <form onsubmit="addRound(event)">
                        <div class="form-group">
                            <label>Round Name</label>
                            <input type="text" id="roundName" required placeholder="Week 1">
                        </div>
                        <div class="form-group">
                            <label>Date</label>
                            <input type="date" id="roundDate" required>
                        </div>
                        <button type="submit" class="btn"><i class="fas fa-plus"></i> Add Round</button>
                    </form>
                </div>

                <!-- All Rounds -->
                <div class="card">
                    <h2><i class="fas fa-list"></i> All Rounds</h2>
                    <div id="roundsList"></div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <h2><i class="fas fa-bolt"></i> Quick Actions</h2>
                    <div class="quick-actions">
                        <div class="quick-action" onclick="openParModal()">
                            <i class="fas fa-golf-ball"></i>
                            <span>Edit Pars</span>
                        </div>
                        <div class="quick-action" onclick="printPinSheet()">
                            <i class="fas fa-key"></i>
                            <span>Print PINs</span>
                        </div>
                        <div class="quick-action" onclick="viewAllScores()">
                            <i class="fas fa-chart-bar"></i>
                            <span>Leaderboard</span>
                        </div>
                        <div class="quick-action" onclick="exportData()">
                            <i class="fas fa-download"></i>
                            <span>Export</span>
                        </div>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card danger-zone">
                    <h2><i class="fas fa-exclamation-triangle"></i> Danger Zone</h2>
                    <p style="color: #666; font-size: 13px; margin-bottom: 15px;">Delete all league data and start fresh.</p>
                    <button class="btn btn-danger" onclick="resetLeague()">
                        <i class="fas fa-trash"></i> Reset League
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- Add Player Modal -->
    <div class="modal" id="addPlayerModal">
        <div class="modal-content">
            <h3>
                <span>Add Player to <span id="modalTeamName"></span></span>
                <button class="close" onclick="closeAddPlayerModal()">&times;</button>
            </h3>
            <form onsubmit="addPlayerToTeam(event)">
                <input type="hidden" id="addPlayerTeamId">
                <div class="form-group">
                    <label>Player Name</label>
                    <input type="text" id="addPlayerName" required placeholder="John Smith">
                </div>
                <div class="form-group">
                    <label>Handicap</label>
                    <input type="number" id="addPlayerHcp" value="0" min="0" max="54">
                </div>
                <button type="submit" class="btn" style="width: 100%; justify-content: center;">
                    <i class="fas fa-plus"></i> Add Player
                </button>
            </form>
        </div>
    </div>

    <!-- Par Modal -->
    <div class="modal" id="parModal">
        <div class="modal-content">
            <h3>
                <span>Set Course Pars</span>
                <button class="close" onclick="closeParModal()">&times;</button>
            </h3>
            <p style="color: #666; margin-bottom: 15px; font-size: 13px;">Enter the par for each hole:</p>
            <div class="par-inputs" id="parInputs"></div>
            <button class="btn" style="width: 100%; justify-content: center; margin-top: 20px;" onclick="savePars()">
                <i class="fas fa-check"></i> Save Pars
            </button>
        </div>
    </div>

    <!-- View Scores Modal -->
    <div class="modal" id="scoresModal">
        <div class="modal-content">
            <h3>
                <span id="scoresModalTitle">Round Scores</span>
                <button class="close" onclick="closeScoresModal()">&times;</button>
            </h3>
            <div id="scoresModalContent"></div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        let league = null;

        // Generate a random 4-digit PIN
        function generatePin() {
            return String(Math.floor(1000 + Math.random() * 9000));
        }

        function init() {
            league = JSON.parse(localStorage.getItem('golfcove_league') || 'null');
            
            // Migration: ensure teams array exists
            if (league && !league.teams) {
                league.teams = [];
                // Migrate existing players' team field to new structure
                const teamNames = [...new Set(league.players.filter(p => p.team).map(p => p.team))];
                teamNames.forEach(name => {
                    const teamId = 't' + Date.now() + Math.random().toString(36).substr(2, 5);
                    league.teams.push({ id: teamId, name });
                    league.players.forEach(p => {
                        if (p.team === name) p.teamId = teamId;
                    });
                });
                // Add PINs to players without them
                league.players.forEach(p => {
                    if (!p.pin) p.pin = generatePin();
                });
                save();
            }

            if (league) {
                document.getElementById('setupForm').classList.remove('active');
                document.getElementById('dashboard').classList.add('active');
                renderDashboard();
            } else {
                document.getElementById('setupForm').classList.add('active');
                document.getElementById('dashboard').classList.remove('active');
            }
        }

        function createLeague(e) {
            e.preventDefault();

            const name = document.getElementById('leagueName').value.trim();
            const season = document.getElementById('season').value.trim();
            const courseName = document.getElementById('courseName').value.trim();
            const holes = parseInt(document.getElementById('holes').value);

            league = {
                id: 'league_' + Date.now(),
                name,
                season,
                course: { name: courseName, holes, pars: Array(holes).fill(4) },
                teams: [],
                players: [],
                rounds: [],
                scores: {},
                createdAt: new Date().toISOString()
            };

            save();
            init();
        }

        function renderDashboard() {
            document.getElementById('leagueTitle').textContent = league.name;
            document.getElementById('leagueSeason').textContent = league.season;
            
            // Set default round name and date
            document.getElementById('roundName').value = 'Week ' + (league.rounds.length + 1);
            document.getElementById('roundDate').valueAsDate = new Date();

            renderTeams();
            renderCurrentRound();
            renderRounds();
            updatePrintOptions();
        }

        function renderTeams() {
            const container = document.getElementById('teamsList');
            
            if (league.teams.length === 0) {
                container.innerHTML = '<div class="empty">No teams yet. Add your first team below.</div>';
                return;
            }

            container.innerHTML = league.teams.map(team => {
                const teamPlayers = league.players.filter(p => p.teamId === team.id);
                return `
                    <div class="team-card">
                        <div class="team-name">
                            <span>${team.name}</span>
                            <button onclick="deleteTeam('${team.id}')" title="Delete team"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="players">
                            ${teamPlayers.length === 0 ? '<span style="color: #999; font-size: 13px;">No players</span>' : 
                                teamPlayers.map(p => `
                                    <div class="player">
                                        <span>${p.name} <span class="hcp">HCP ${p.handicap}</span></span>
                                        <span>
                                            <span class="pin">${p.pin}</span>
                                            <button onclick="deletePlayer('${p.id}')" style="background: none; border: none; color: #dc3545; cursor: pointer; margin-left: 8px;"><i class="fas fa-times"></i></button>
                                        </span>
                                    </div>
                                `).join('')
                            }
                        </div>
                        <button class="btn btn-sm btn-outline" style="margin-top: 10px;" onclick="openAddPlayerModal('${team.id}', '${team.name}')">
                            <i class="fas fa-plus"></i> Add Player
                        </button>
                    </div>
                `;
            }).join('');
        }

        function renderCurrentRound() {
            const container = document.getElementById('currentRound');
            
            if (league.rounds.length === 0) {
                container.innerHTML = '<div class="empty">No rounds yet. Create one to get started.</div>';
                document.getElementById('qrCard').style.display = 'none';
                return;
            }

            const round = league.rounds[league.rounds.length - 1];
            const scored = league.players.filter(p => league.scores[round.id]?.[p.id]?.submitted).length;
            const total = league.players.length;

            container.innerHTML = `
                <div class="round-status">
                    <div class="info">
                        <h3>${round.name}</h3>
                        <p>${new Date(round.date).toLocaleDateString()}</p>
                    </div>
                    <div class="score-count">
                        <div class="big">${scored}/${total}</div>
                        <div class="label">scores in</div>
                    </div>
                </div>
            `;

            // Show QR code
            const url = window.location.origin + window.location.pathname.replace('league-admin.html', '') + 'score.html?r=' + round.id;
            document.getElementById('scoringUrl').textContent = url;
            document.getElementById('qrCard').style.display = 'block';
            
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: url,
                width: 150,
                height: 150,
                colorDark: '#333333',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function renderRounds() {
            const container = document.getElementById('roundsList');
            
            if (league.rounds.length === 0) {
                container.innerHTML = '<div class="empty">No rounds</div>';
                return;
            }

            container.innerHTML = league.rounds.slice().reverse().map(r => {
                const scored = league.players.filter(p => league.scores[r.id]?.[p.id]?.submitted).length;
                return `
                    <div class="round-item">
                        <div>
                            <h4>${r.name}</h4>
                            <p>${new Date(r.date).toLocaleDateString()} • ${scored}/${league.players.length}</p>
                        </div>
                        <div class="actions">
                            <button class="btn btn-sm btn-secondary" onclick="viewRoundScores('${r.id}')"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-danger" onclick="deleteRound('${r.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updatePrintOptions() {
            const select = document.getElementById('printTeamSelect');
            select.innerHTML = '<option value="">Blank Cards</option>' + 
                league.teams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        // Team functions
        function addTeam(e) {
            e.preventDefault();
            const name = document.getElementById('newTeamName').value.trim();
            if (!name) return;

            league.teams.push({
                id: 't' + Date.now(),
                name
            });

            document.getElementById('newTeamName').value = '';
            save();
            renderTeams();
            updatePrintOptions();
        }

        function deleteTeam(id) {
            if (!confirm('Delete this team and unassign its players?')) return;
            
            // Unassign players from this team
            league.players.forEach(p => {
                if (p.teamId === id) p.teamId = null;
            });
            
            league.teams = league.teams.filter(t => t.id !== id);
            save();
            renderTeams();
            updatePrintOptions();
        }

        // Player functions
        function openAddPlayerModal(teamId, teamName) {
            document.getElementById('addPlayerTeamId').value = teamId;
            document.getElementById('modalTeamName').textContent = teamName;
            document.getElementById('addPlayerName').value = '';
            document.getElementById('addPlayerHcp').value = '0';
            document.getElementById('addPlayerModal').classList.add('open');
        }

        function closeAddPlayerModal() {
            document.getElementById('addPlayerModal').classList.remove('open');
        }

        function addPlayerToTeam(e) {
            e.preventDefault();
            
            const teamId = document.getElementById('addPlayerTeamId').value;
            const name = document.getElementById('addPlayerName').value.trim();
            const handicap = parseInt(document.getElementById('addPlayerHcp').value) || 0;

            if (!name) return;

            league.players.push({
                id: 'p' + Date.now(),
                name,
                teamId,
                handicap,
                pin: generatePin()
            });

            save();
            closeAddPlayerModal();
            renderTeams();
        }

        function deletePlayer(id) {
            if (!confirm('Remove this player?')) return;
            league.players = league.players.filter(p => p.id !== id);
            save();
            renderTeams();
        }

        // Round functions
        function addRound(e) {
            e.preventDefault();
            
            const name = document.getElementById('roundName').value.trim();
            const date = document.getElementById('roundDate').value;

            league.rounds.push({
                id: 'r' + Date.now(),
                name,
                date,
                createdAt: new Date().toISOString()
            });

            save();
            renderDashboard();
        }

        function deleteRound(id) {
            if (!confirm('Delete this round and all its scores?')) return;
            league.rounds = league.rounds.filter(r => r.id !== id);
            delete league.scores[id];
            save();
            renderDashboard();
        }

        function viewRoundScores(roundId) {
            const round = league.rounds.find(r => r.id === roundId);
            if (!round) return;

            document.getElementById('scoresModalTitle').textContent = round.name + ' Scores';
            
            const holes = league.course?.holes || 18;
            const pars = league.course?.pars || Array(holes).fill(4);
            const totalPar = pars.reduce((a, b) => a + b, 0);

            const scores = league.players.map(p => {
                const ps = league.scores[roundId]?.[p.id];
                if (!ps || !ps.submitted) return { name: p.name, team: league.teams.find(t => t.id === p.teamId)?.name, handicap: p.handicap, gross: null };
                
                let gross = 0;
                for (let h = 1; h <= holes; h++) {
                    gross += ps[h] || 0;
                }
                return { name: p.name, team: league.teams.find(t => t.id === p.teamId)?.name, handicap: p.handicap, gross, net: gross - p.handicap };
            }).sort((a, b) => {
                if (a.gross === null) return 1;
                if (b.gross === null) return -1;
                return a.net - b.net;
            });

            document.getElementById('scoresModalContent').innerHTML = scores.map(s => `
                <div class="round-item">
                    <div>
                        <h4>${s.name}</h4>
                        <p>${s.team || 'No team'} • HCP ${s.handicap}</p>
                    </div>
                    ${s.gross !== null ? `
                        <div style="text-align: right;">
                            <div style="font-size: 18px; font-weight: 700; color: #37b24a;">${s.gross}</div>
                            <div style="font-size: 12px; color: #666;">Net: ${s.net}</div>
                        </div>
                    ` : '<span style="color: #999;">No score</span>'}
                </div>
            `).join('');

            document.getElementById('scoresModal').classList.add('open');
        }

        function closeScoresModal() {
            document.getElementById('scoresModal').classList.remove('open');
        }

        // QR functions
        function copyUrl() {
            const url = document.getElementById('scoringUrl').textContent;
            navigator.clipboard.writeText(url);
            alert('Link copied!');
        }

        function printQR() {
            const lastRound = league.rounds[league.rounds.length - 1];
            const url = document.getElementById('scoringUrl').textContent;
            const qrImg = document.querySelector('#qrcode img')?.src || '';
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Scoring QR - ${league.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 40px; }
                        h1 { color: #37b24a; margin-bottom: 10px; }
                        h2 { color: #333; font-weight: normal; margin-bottom: 30px; }
                        .qr { margin: 30px auto; }
                        .url { font-family: monospace; background: #f5f5f5; padding: 10px 20px; border-radius: 5px; display: inline-block; margin-top: 20px; font-size: 12px; }
                        .instructions { margin-top: 30px; color: #666; font-size: 14px; }
                    </style>
                </head>
                <body>
                    <h1>⛳ ${league.name}</h1>
                    <h2>${lastRound.name} - ${new Date(lastRound.date).toLocaleDateString()}</h2>
                    <div class="qr"><img src="${qrImg}" width="250" height="250"></div>
                    <p class="instructions">Scan to enter your score</p>
                    <div class="url">${url}</div>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        }

        // Par functions
        function openParModal() {
            const holes = league.course?.holes || 18;
            const pars = league.course?.pars || Array(holes).fill(4);
            
            let html = '';
            for (let i = 0; i < holes; i++) {
                html += `
                    <div>
                        <label>H${i + 1}</label>
                        <input type="number" min="3" max="6" value="${pars[i]}" id="par${i}">
                    </div>
                `;
            }
            
            document.getElementById('parInputs').innerHTML = html;
            document.getElementById('parModal').classList.add('open');
        }

        function closeParModal() {
            document.getElementById('parModal').classList.remove('open');
        }

        function savePars() {
            const holes = league.course?.holes || 18;
            const pars = [];
            
            for (let i = 0; i < holes; i++) {
                pars.push(parseInt(document.getElementById('par' + i).value) || 4);
            }
            
            league.course.pars = pars;
            save();
            closeParModal();
            alert('Pars saved!');
        }

        // Print PIN sheet
        function printPinSheet() {
            if (league.players.length === 0) {
                alert('No players to print PINs for');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Player PINs - ${league.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 30px; }
                        h1 { color: #37b24a; margin-bottom: 5px; }
                        h2 { color: #666; font-weight: normal; margin-bottom: 30px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #ddd; }
                        th { background: #f5f5f5; font-weight: 600; }
                        .pin { font-family: monospace; font-size: 18px; font-weight: bold; letter-spacing: 2px; }
                        .team { color: #37b24a; font-size: 12px; }
                        .note { margin-top: 30px; color: #888; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <h1>⛳ ${league.name}</h1>
                    <h2>Player PINs - Keep Confidential</h2>
                    <table>
                        <tr>
                            <th>Player</th>
                            <th>Team</th>
                            <th>PIN</th>
                        </tr>
                        ${league.players.map(p => {
                            const team = league.teams.find(t => t.id === p.teamId);
                            return `
                                <tr>
                                    <td>${p.name}</td>
                                    <td class="team">${team?.name || '-'}</td>
                                    <td class="pin">${p.pin}</td>
                                </tr>
                            `;
                        }).join('')}
                    </table>
                    <p class="note">Each player uses their PIN to submit scores. Do not share PINs between players.</p>
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 250);
        }

        // Print scorecards
        function printScorecards() {
            const teamId = document.getElementById('printTeamSelect').value;
            const count = parseInt(document.getElementById('printCount').value);
            
            if (league.rounds.length === 0) {
                alert('Please create a round first');
                return;
            }

            const round = league.rounds[league.rounds.length - 1];
            const holes = league.course?.holes || 18;
            const pars = league.course?.pars || Array(holes).fill(4);
            const frontNine = Math.min(9, holes);
            const has18 = holes >= 18;
            
            const qrImg = document.querySelector('#qrcode img')?.src || '';
            
            let players = [];
            if (teamId) {
                // Print for specific team
                players = league.players.filter(p => p.teamId === teamId);
            } else {
                // Blank cards
                for (let i = 0; i < count; i++) {
                    players.push({ name: '', teamId: null, handicap: '' });
                }
            }

            if (players.length === 0) {
                alert('No players found for this team');
                return;
            }

            const buildCard = (player) => {
                const team = player.teamId ? league.teams.find(t => t.id === player.teamId) : null;
                let frontPars = '', backPars = '';
                let frontParTotal = 0, backParTotal = 0;
                
                for (let h = 0; h < frontNine; h++) {
                    frontPars += `<td>${pars[h]}</td>`;
                    frontParTotal += pars[h];
                }
                if (has18) {
                    for (let h = 9; h < holes; h++) {
                        backPars += `<td>${pars[h]}</td>`;
                        backParTotal += pars[h];
                    }
                }
                
                const totalPar = frontParTotal + backParTotal;
                
                return `
                    <div class="scorecard">
                        <div class="card-header">
                            <div class="header-left">
                                <h1>⛳ ${league.course?.name || 'Golf Cove'}</h1>
                                <h2>${league.name}</h2>
                                <p class="round-info">${round.name} • ${new Date(round.date).toLocaleDateString()}</p>
                            </div>
                            <div class="qr-section">
                                <img src="${qrImg}" class="qr-code" alt="QR">
                                <p class="qr-label">Scan to enter score</p>
                            </div>
                        </div>
                        
                        <div class="player-row">
                            <div class="field"><span class="label">Player:</span><span class="value">${player.name || ''}</span><span class="underline"></span></div>
                            <div class="field"><span class="label">Team:</span><span class="value">${team?.name || ''}</span><span class="underline"></span></div>
                            <div class="field small"><span class="label">HCP:</span><span class="value">${player.handicap !== '' ? player.handicap : ''}</span><span class="underline short"></span></div>
                        </div>
                        
                        <table class="score-grid">
                            <thead>
                                <tr>
                                    <th class="row-label">HOLE</th>
                                    ${Array.from({length: frontNine}, (_, i) => `<th>${i + 1}</th>`).join('')}
                                    <th class="subtotal">OUT</th>
                                    ${has18 ? Array.from({length: holes - 9}, (_, i) => `<th>${i + 10}</th>`).join('') : ''}
                                    ${has18 ? '<th class="subtotal">IN</th>' : ''}
                                    <th class="total">TOT</th>
                                    <th class="total">HCP</th>
                                    <th class="total net">NET</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="par-row">
                                    <td class="row-label">PAR</td>
                                    ${frontPars}
                                    <td class="subtotal">${frontParTotal}</td>
                                    ${has18 ? backPars : ''}
                                    ${has18 ? `<td class="subtotal">${backParTotal}</td>` : ''}
                                    <td class="total">${totalPar}</td>
                                    <td class="total"></td>
                                    <td class="total net"></td>
                                </tr>
                                <tr class="score-row">
                                    <td class="row-label">SCORE</td>
                                    ${Array.from({length: frontNine}, () => '<td class="input-cell"></td>').join('')}
                                    <td class="subtotal input-cell"></td>
                                    ${has18 ? Array.from({length: holes - 9}, () => '<td class="input-cell"></td>').join('') : ''}
                                    ${has18 ? '<td class="subtotal input-cell"></td>' : ''}
                                    <td class="total input-cell"></td>
                                    <td class="total input-cell"></td>
                                    <td class="total net input-cell"></td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div class="footer-row">
                            <div class="sig-field"><span class="label">Scorer:</span><span class="sig-line"></span></div>
                            <div class="sig-field"><span class="label">Attest:</span><span class="sig-line"></span></div>
                            <div class="sig-field"><span class="label">Date:</span><span class="sig-line short"></span></div>
                        </div>
                    </div>
                `;
            };
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Scorecards - ${league.name}</title>
                    <style>
                        * { margin: 0; padding: 0; box-sizing: border-box; }
                        body { font-family: Arial, sans-serif; padding: 15px; background: #fff; }
                        .scorecard { border: 3px solid #333; padding: 20px; margin-bottom: 20px; page-break-inside: avoid; background: #fff; }
                        .card-header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 3px solid #37b24a; padding-bottom: 15px; margin-bottom: 15px; }
                        .header-left h1 { color: #37b24a; font-size: 28px; margin-bottom: 2px; }
                        .header-left h2 { font-size: 18px; color: #333; font-weight: normal; margin-bottom: 5px; }
                        .round-info { font-size: 14px; color: #666; }
                        .qr-section { text-align: center; }
                        .qr-code { width: 100px; height: 100px; border: 2px solid #333; }
                        .qr-label { font-size: 10px; color: #666; margin-top: 5px; }
                        .player-row { display: flex; gap: 30px; margin-bottom: 15px; }
                        .player-row .field { display: flex; align-items: baseline; gap: 8px; }
                        .player-row .label { font-weight: bold; font-size: 12px; }
                        .player-row .value { font-size: 14px; min-width: 80px; }
                        .player-row .underline { flex: 1; border-bottom: 1px solid #333; min-width: 100px; }
                        .player-row .underline.short { min-width: 40px; }
                        .player-row .field.small { flex: 0 0 auto; }
                        .score-grid { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 11px; }
                        .score-grid th, .score-grid td { border: 2px solid #333; padding: 8px 4px; text-align: center; min-width: 28px; }
                        .score-grid th { background: #f0f0f0; font-weight: bold; }
                        .score-grid .row-label { background: #333; color: #fff; font-weight: bold; width: 55px; }
                        .score-grid .subtotal { background: #e0e0e0; font-weight: bold; }
                        .score-grid .total { background: #c0c0c0; font-weight: bold; }
                        .score-grid .net { background: #37b24a; color: #fff; }
                        .score-grid .par-row td { background: #f8f8f8; font-size: 12px; }
                        .score-grid .par-row .row-label { background: #666; }
                        .score-grid .score-row td.input-cell { background: #fff; height: 35px; }
                        .score-grid .score-row .net.input-cell { background: #e8f5e9; }
                        .footer-row { display: flex; gap: 40px; padding-top: 10px; border-top: 1px solid #ccc; }
                        .sig-field { display: flex; align-items: baseline; gap: 8px; }
                        .sig-field .label { font-weight: bold; font-size: 11px; }
                        .sig-line { border-bottom: 1px solid #333; min-width: 120px; }
                        .sig-line.short { min-width: 80px; }
                        @media print { body { padding: 0; } .scorecard { margin-bottom: 15px; page-break-after: always; } .scorecard:last-child { page-break-after: auto; } }
                    </style>
                </head>
                <body>
                    ${players.map(p => buildCard(p)).join('')}
                </body>
                </html>
            `);
            printWindow.document.close();
            setTimeout(() => printWindow.print(), 300);
        }

        function viewAllScores() {
            window.location.href = 'tournaments.html';
        }

        function exportData() {
            const data = JSON.stringify(league, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${league.name.replace(/\s+/g, '_')}_export.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function resetLeague() {
            if (!confirm('Delete the entire league? This cannot be undone!')) return;
            if (!confirm('Are you absolutely sure?')) return;
            
            localStorage.removeItem('golfcove_league');
            league = null;
            init();
        }

        function save() {
            localStorage.setItem('golfcove_league', JSON.stringify(league));
        }

        init();
    </script>
</body>
</html>
