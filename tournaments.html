<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>League Standings - Golf Cove</title>
    <meta name="description" content="View live league standings, scores, and weekly results from Golf Cove leagues.">
    <link rel="icon" type="image/png" href="images/golfcovelogo.png">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        /* Hero Banner */
        .league-hero {
            background: linear-gradient(135deg, rgba(51,51,51,0.95) 0%, rgba(55,178,74,0.9) 100%), 
                        url('images/gallery-1.jpg') center/cover;
            padding: 80px 20px;
            text-align: center;
            color: #fff;
        }
        .league-hero h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .league-hero .season-badge {
            display: inline-block;
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            padding: 8px 20px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
        }
        .join-league-btn {
            display: inline-block;
            background: #fff;
            color: #37b24a;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 15px;
            font-weight: 600;
            text-decoration: none;
            margin-bottom: 15px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .join-league-btn:hover {
            background: #37b24a;
            color: #fff;
            transform: translateY(-2px);
        }
        .join-league-btn i { margin-right: 8px; }
        .league-hero .stats-grid {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin-top: 30px;
        }
        .league-hero .stat {
            text-align: center;
        }
        .league-hero .stat-num {
            font-size: 48px;
            font-weight: 800;
            line-height: 1;
        }
        .league-hero .stat-label {
            font-size: 14px;
            opacity: 0.85;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Live Banner */
        .live-banner {
            background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
            color: #fff;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 900px;
            margin: -30px auto 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(238,90,90,0.4);
            position: relative;
            z-index: 10;
        }
        .live-banner .live-dot {
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin-right: 12px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        .live-banner .info {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 16px;
        }
        .live-banner .count {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Main Container */
        .league-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        /* Standings Card */
        .standings-card {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 4px 25px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 30px;
        }
        .standings-header {
            background: linear-gradient(135deg, #333 0%, #444 100%);
            color: #fff;
            padding: 25px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .standings-header h2 {
            font-size: 22px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .standings-header .trophy {
            font-size: 28px;
        }

        /* Controls */
        .controls-panel {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        .controls-row:last-child { margin-bottom: 0; }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-group label {
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            min-width: 160px;
            cursor: pointer;
        }
        .filter-select:focus {
            border-color: #37b24a;
            outline: none;
        }

        .view-toggle {
            display: flex;
            background: #e9ecef;
            border-radius: 8px;
            padding: 4px;
        }
        .view-btn {
            padding: 10px 18px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: #666;
            transition: all 0.2s;
        }
        .view-btn.active {
            background: #37b24a;
            color: #fff;
            box-shadow: 0 2px 8px rgba(55,178,74,0.3);
        }
        .view-btn:hover:not(.active) {
            background: #ddd;
        }

        .export-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 18px;
            background: #217346;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            margin-left: auto;
            transition: all 0.2s;
        }
        .export-btn:hover {
            background: #1a5c38;
            transform: translateY(-1px);
        }

        /* Table */
        .standings-table {
            width: 100%;
            border-collapse: collapse;
        }
        .standings-table th {
            background: #f8f9fa;
            padding: 14px 16px;
            text-align: left;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #666;
            border-bottom: 2px solid #e9ecef;
        }
        .standings-table th.highlight {
            background: #37b24a;
            color: #fff;
        }
        .standings-table td {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }
        .standings-table tbody tr {
            cursor: pointer;
            transition: background 0.15s;
        }
        .standings-table tbody tr:hover {
            background: #f8fff9;
        }

        /* Position Badges */
        .pos-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-weight: 700;
            font-size: 14px;
        }
        .pos-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: #fff; box-shadow: 0 2px 8px rgba(255,215,0,0.4); }
        .pos-2 { background: linear-gradient(135deg, #C0C0C0, #A0A0A0); color: #fff; }
        .pos-3 { background: linear-gradient(135deg, #CD7F32, #A0522D); color: #fff; }
        .pos-other { background: #f0f0f0; color: #666; }

        .player-info {
            display: flex;
            flex-direction: column;
        }
        .player-name {
            font-weight: 600;
            color: #333;
        }
        .player-team {
            font-size: 12px;
            color: #37b24a;
            margin-top: 2px;
        }
        .player-hcp {
            color: #999;
            font-size: 12px;
        }

        .score-cell {
            font-weight: 700;
            font-size: 18px;
        }
        .score-cell.net { color: #37b24a; }
        .score-cell.gross { color: #333; }
        
        /* Trend indicators */
        .trend-up { color: #37b24a; font-weight: bold; }
        .trend-down { color: #e74c3c; font-weight: bold; }
        .trend-flat { color: #95a5a6; }
        
        /* To-par styling */
        .to-par { font-weight: 600; }
        .to-par.over { color: #e74c3c; }
        .to-par.under { color: #37b24a; }
        .to-par.even { color: #333; }
        
        /* Stats summary in expanded row */
        .stats-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px 15px;
            background: #f0f7f0;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .stats-summary span { color: #555; }
        .stats-summary strong { color: #37b24a; }

        /* Expand Row */
        .expand-row {
            display: none;
            background: #fafafa;
        }
        .expand-row.open { display: table-row; }
        .expand-row td {
            padding: 20px !important;
        }
        .round-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .round-chip {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 13px;
        }
        .round-chip .week { font-weight: 600; color: #333; }
        .round-chip .scores { color: #666; margin-top: 3px; }
        .round-chip .net-val { color: #37b24a; font-weight: 600; }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 80px 30px;
        }
        .empty-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }
        .empty-state h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .empty-state p {
            color: #888;
            margin-bottom: 30px;
        }

        /* Action Buttons */
        .action-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .league-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 28px;
            background: #37b24a;
            color: #fff;
            text-decoration: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            transition: all 0.2s;
            border: none;
            cursor: pointer;
        }
        .league-btn:hover {
            background: #2d9440;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(55,178,74,0.3);
        }
        .league-btn-outline {
            background: transparent;
            border: 2px solid #37b24a;
            color: #37b24a;
        }
        .league-btn-outline:hover {
            background: #37b24a;
            color: #fff;
        }

        /* Admin Link */
        .admin-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        .admin-footer a {
            color: #999;
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .admin-footer a:hover { color: #37b24a; }

        /* Refresh indicator */
        .refresh-note {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }
        .refresh-note i { margin-right: 5px; }

        /* No league setup - full page state */
        .setup-prompt {
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        .setup-card {
            text-align: center;
            background: #fff;
            padding: 60px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 500px;
        }
        .setup-card .icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #37b24a, #2d9440);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
        }
        .setup-card .icon i {
            font-size: 40px;
            color: #fff;
        }
        .setup-card h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #333;
        }
        .setup-card p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .league-hero { padding: 50px 20px; }
            .league-hero h1 { font-size: 28px; }
            .league-hero .stats-grid { gap: 25px; }
            .league-hero .stat-num { font-size: 32px; }
            .live-banner { flex-direction: column; gap: 10px; text-align: center; margin: -20px 15px 20px; }
            .controls-row { flex-direction: column; align-items: stretch; }
            .view-toggle { justify-content: center; }
            .export-btn { margin: 0; justify-content: center; }
            .standings-table th, .standings-table td { padding: 12px 10px; font-size: 13px; }
            .pos-badge { width: 28px; height: 28px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-left">
                <a href="tel:2033905994"><i class="fas fa-phone"></i> 203.390.5994</a>
                <a href="https://maps.google.com/?q=336+State+Street,+North+Haven,+CT+06473" target="_blank"><i class="fas fa-map-marker-alt"></i> 336 STATE STREET, NORTH HAVEN, CT</a>
            </div>
            <div class="top-bar-right">
                <div class="social-links">
                    <a href="https://www.facebook.com/golfcove/" target="_blank"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/golfcovect/" target="_blank"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-main">
            <div class="logo">
                <a href="index.html">
                    <img src="images/golfCoveLogo6.png" alt="Golf Cove Logo" width="200" height="75">
                </a>
            </div>
            <nav class="main-nav" id="mainNav">
                <ul class="nav-menu">
                    <li><a href="pricing.html">Pricing</a></li>
                    <li><a href="memberships.html">Memberships</a></li>
                    <li class="dropdown">
                        <a href="lessons-leagues.html">Lessons & Leagues <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="lessons-leagues.html">Lessons & Leagues</a></li>
                            <li><a href="pinseeker.html">PinSeeker at Golf Cove</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="private-events.html">Private Events <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="private-events.html">Private Events</a></li>
                            <li><a href="concierge.html">The Cove Concierge</a></li>
                        </ul>
                    </li>
                    <li><a href="multisport.html">MultiSport Arcade</a></li>
                    <li><a href="gift-cards.html">Gift Cards</a></li>
                    <li><a href="tournaments.html" class="active">Tournaments</a></li>
                    <li><a href="menu.html">Menu</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="https://golfcove.globalitllc.com/booking#" class="btn-book" target="_blank">RESERVE A ROOM</a></li>
                </ul>
            </nav>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle Menu">
                <span></span><span></span><span></span>
            </button>
        </div>
    </header>

    <main id="app">
        <!-- Content loaded by JS -->
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-simple">
            <div class="footer-social-center">
                <a href="https://www.facebook.com/golfcove/" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.instagram.com/golfcovect/" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            </div>
            <p class="footer-social-text">Please visit our facebook and instagram pages frequently for events, updates and promotions!</p>
            <p class="footer-address"><a href="https://maps.google.com/?q=336+State+Street,+North+Haven,+CT+06473" target="_blank">336 State Street, North Haven, CT 06473</a> | Phone: <a href="tel:2033905994">203.390.5994</a></p>
            <p class="footer-copyright">¬© 2025 Golf Cove | <a href="contact.html">Contact Us</a> | <a href="sitemap.html">Site Map</a></p>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8SH5Eh7OhIFLUkL2hjZS23uXkCsDJXGc",
            authDomain: "golfcove.firebaseapp.com",
            databaseURL: "https://golfcove-default-rtdb.firebaseio.com",
            projectId: "golfcove",
            storageBucket: "golfcove.firebasestorage.app",
            messagingSenderId: "284762891644",
            appId: "1:284762891644:web:424223b102f08a230f70f9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const leagueRef = db.ref('league');
        
        let currentView = 'cumulative-net';
        let currentTeamFilter = '';
        let cachedLeague = null;
        let cachedStandings = null;

        // Default demo league shown when no league exists
        const defaultLeague = {
            name: 'Golf Cove League',
            season: 'Winter 2025',
            course: { name: 'Golf Cove', holes: 18, pars: Array(18).fill(4) },
            teams: [{ id: 't1', name: 'Demo Team' }],
            players: [
                { id: 'p1', name: 'Javi', teamId: 't1', handicap: 10 }
            ],
            rounds: [],
            scores: {}
        };

        function init() {
            const app = document.getElementById('app');
            app.innerHTML = '<div style="text-align:center;padding:60px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:#37b24a;"></i><p style="margin-top:15px;color:#666;">Loading standings...</p></div>';
            
            // Timeout fallback - if Firebase doesn't respond in 5 seconds, show default
            const timeout = setTimeout(() => {
                console.log('Firebase timeout - using default league');
                renderLeague(defaultLeague);
            }, 5000);
            
            // Listen for real-time updates from Firebase
            leagueRef.on('value', (snapshot) => {
                clearTimeout(timeout);
                console.log('Firebase connected! Data:', snapshot.val());
                let league = snapshot.val();
                
                // Use default league if none exists
                if (!league) {
                    league = defaultLeague;
                } else {
                    // Ensure arrays exist (Firebase returns undefined for empty arrays)
                    league.players = league.players || [];
                    league.rounds = league.rounds || [];
                    league.teams = league.teams || [];
                    league.scores = league.scores || {};
                }
                
                renderLeague(league);
            }, (error) => {
                clearTimeout(timeout);
                console.error('Firebase error:', error);
                // Fallback to default league on error
                renderLeague(defaultLeague);
            });
        }
        
        function renderLeague(league) {
            const app = document.getElementById('app');
            
            cachedLeague = league;
            cachedStandings = calculateStandings(league);
            const hasScores = cachedStandings.some(s => s.roundsPlayed > 0);

            // Check for live round
            const today = new Date().toISOString().split('T')[0];
            const activeRound = (league.rounds || []).find(r => r.date === today);
            let liveBannerHTML = '';
            
            if (activeRound) {
                const submittedCount = (league.players || []).filter(p => 
                    league.scores?.[activeRound.id]?.[p.id]?.submitted
                ).length;
                
                if (submittedCount < (league.players || []).length) {
                    liveBannerHTML = `
                        <div class="live-banner">
                            <div class="info">
                                <span class="live-dot"></span>
                                <strong>${activeRound.name} IN PROGRESS</strong>
                            </div>
                            <div class="count">${submittedCount}/${(league.players || []).length} scores submitted</div>
                        </div>
                    `;
                }
            }

            app.innerHTML = `
                <div class="league-hero">
                    <h1>üèÜ ${league.name}</h1>
                    <div class="season-badge"><i class="fas fa-calendar-alt"></i> ${league.season}</div>
                    <a href="score.html" class="join-league-btn"><i class="fas fa-user-plus"></i> Join League / Enter Score</a>
                    <div class="stats-grid">
                        <div class="stat">
                            <div class="stat-num">${league.teams?.length || 0}</div>
                            <div class="stat-label">Teams</div>
                        </div>
                        <div class="stat">
                            <div class="stat-num">${(league.players || []).length}</div>
                            <div class="stat-label">Players</div>
                        </div>
                        <div class="stat">
                            <div class="stat-num">${(league.rounds || []).length}</div>
                            <div class="stat-label">Rounds</div>
                        </div>
                    </div>
                </div>

                <div class="league-container">
                    ${liveBannerHTML}

                    <div class="standings-card">
                        <div class="standings-header">
                            <h2><span class="trophy">üèÜ</span> Leaderboard</h2>
                        </div>

                        ${hasScores ? `
                        <div class="controls-panel">
                            <div class="controls-row">
                                <div class="filter-group">
                                    <label><i class="fas fa-filter"></i> Team:</label>
                                    <select class="filter-select" id="teamFilter" onchange="filterByTeam(this.value)">
                                        <option value="">All Teams</option>
                                        ${(league.teams || []).map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                                    </select>
                                </div>
                                <div class="view-toggle">
                                    <button class="view-btn active" data-view="cumulative-net">Net</button>
                                    <button class="view-btn" data-view="cumulative-gross">Gross</button>
                                    <button class="view-btn" data-view="by-round">By Week</button>
                                </div>
                                <button class="export-btn" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export
                                </button>
                            </div>
                        </div>
                        ` : ''}

                        <div id="standingsContent">
                            ${hasScores ? renderTable(cachedStandings, league, 'cumulative-net') : `
                                <div class="empty-state">
                                    <i class="fas fa-hourglass-half"></i>
                                    <h2>Waiting for Scores</h2>
                                    <p>Standings will appear once the first round is complete.</p>
                                </div>
                            `}
                        </div>
                    </div>

                    <div class="action-row">
                        <a href="score.html" class="league-btn"><i class="fas fa-pencil-alt"></i> Enter My Score</a>
                    </div>

                    <div class="admin-footer">
                        <a href="league-admin.html"><i class="fas fa-cog"></i> League Admin</a>
                    </div>

                    <div class="refresh-note">
                        <i class="fas fa-sync-alt"></i> Auto-refreshes every 30 seconds
                    </div>
                </div>
            `;

            // Attach view toggle handlers
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => setView(btn.dataset.view));
            });
        }

        function calculateStandings(league) {
            const holes = league.course?.holes || 18;
            const frontNine = Math.min(9, holes);
            const players = league.players || [];
            const rounds = league.rounds || [];
            const coursePar = (league.course?.pars || []).reduce((a, b) => a + b, 0) || (holes * 4);
            
            return players.map(player => {
                let totalGross = 0, totalOut = 0, totalIn = 0, roundsPlayed = 0;
                let roundDetails = [];
                let bestGross = null, worstGross = null, bestNet = null;
                let allGross = [], allNet = [];

                rounds.forEach(round => {
                    const ps = league.scores?.[round.id]?.[player.id];
                    if (ps && ps.submitted) {
                        let gross = 0, out = 0, inScore = 0;
                        
                        for (let h = 1; h <= frontNine; h++) {
                            const score = ps[h] || 0;
                            out += score; gross += score;
                        }
                        for (let h = frontNine + 1; h <= holes; h++) {
                            const score = ps[h] || 0;
                            inScore += score; gross += score;
                        }
                        
                        const net = gross - (player.handicap || 0);
                        totalGross += gross; totalOut += out; totalIn += inScore; roundsPlayed++;
                        roundDetails.push({ name: round.name, date: round.date, out, in: inScore, gross, net });
                        
                        allGross.push(gross);
                        allNet.push(net);
                        if (bestGross === null || gross < bestGross) bestGross = gross;
                        if (worstGross === null || gross > worstGross) worstGross = gross;
                        if (bestNet === null || net < bestNet) bestNet = net;
                    }
                });

                const totalNet = totalGross - ((player.handicap || 0) * roundsPlayed);
                const avgGross = roundsPlayed > 0 ? (totalGross / roundsPlayed).toFixed(1) : null;
                const avgNet = roundsPlayed > 0 ? (totalNet / roundsPlayed).toFixed(1) : null;
                const toPar = roundsPlayed > 0 ? totalGross - (coursePar * roundsPlayed) : null;
                
                // Calculate trend (last 3 rounds vs previous 3)
                let trend = null;
                if (allNet.length >= 2) {
                    const recent = allNet.slice(-Math.min(3, allNet.length));
                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    if (allNet.length >= 4) {
                        const older = allNet.slice(-6, -3);
                        if (older.length > 0) {
                            const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
                            trend = olderAvg - recentAvg; // positive = improving
                        }
                    }
                }
                
                return {
                    id: player.id, name: player.name, teamId: player.teamId || null,
                    handicap: player.handicap || 0, totalOut, totalIn, totalGross, totalNet,
                    roundsPlayed, roundDetails, bestGross, worstGross, bestNet, avgGross, avgNet,
                    toPar, trend, coursePar
                };
            });
        }

        function filterByTeam(teamId) {
            currentTeamFilter = teamId;
            updateStandings();
        }

        function updateStandings() {
            let filtered = cachedStandings;
            if (currentTeamFilter) filtered = cachedStandings.filter(s => s.teamId === currentTeamFilter);
            document.getElementById('standingsContent').innerHTML = renderTable(filtered, cachedLeague, currentView);
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            updateStandings();
        }

        function sortStandings(standings, view) {
            return [...standings].sort((a, b) => {
                if (a.roundsPlayed === 0) return 1;
                if (b.roundsPlayed === 0) return -1;
                return view === 'cumulative-gross' ? a.totalGross - b.totalGross : a.totalNet - b.totalNet;
            });
        }

        function renderTable(standings, league, view = 'cumulative-net') {
            const sorted = sortStandings(standings, view);
            const holes = league.course?.holes || 18;
            const has18 = holes >= 18;
            
            const getTeamName = (teamId) => (league.teams || []).find(t => t.id === teamId)?.name || '';

            let headers, renderRow;
            
            // Helper for trend arrow
            const getTrendIcon = (trend) => {
                if (trend === null) return '';
                if (trend > 1) return '<span class="trend-up" title="Improving">‚Üë</span>';
                if (trend < -1) return '<span class="trend-down" title="Declining">‚Üì</span>';
                return '<span class="trend-flat" title="Steady">‚Üí</span>';
            };
            
            const formatToPar = (toPar) => {
                if (toPar === null) return '-';
                if (toPar === 0) return 'E';
                return toPar > 0 ? `+${toPar}` : toPar;
            };

            if (view === 'cumulative-gross') {
                headers = `<th style="width:50px">#</th><th>Player</th><th>Rounds</th><th>Best</th><th>Avg</th><th class="highlight">Total</th>`;
                renderRow = (s, pos) => `
                    <td><span class="pos-badge ${pos <= 3 ? 'pos-' + pos : 'pos-other'}">${pos || '-'}</span></td>
                    <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                    <td>${s.roundsPlayed}</td>
                    <td>${s.bestGross || '-'}</td>
                    <td>${s.avgGross || '-'}</td>
                    <td><span class="score-cell gross">${s.roundsPlayed > 0 ? s.totalGross : '-'}</span></td>
                `;
            } else if (view === 'by-round') {
                const roundHeaders = (league.rounds || []).map(r => `<th>${r.name.replace('Week ', 'W')}</th>`).join('');
                headers = `<th style="width:50px">#</th><th>Player</th>${roundHeaders}<th class="highlight">Net</th>`;
                renderRow = (s, pos) => {
                    const cells = (league.rounds || []).map(r => {
                        const rd = s.roundDetails.find(d => d.name === r.name);
                        return `<td style="${rd ? '' : 'color:#ccc'}">${rd ? rd.net : '-'}</td>`;
                    }).join('');
                    return `
                        <td><span class="pos-badge ${pos <= 3 ? 'pos-' + pos : 'pos-other'}">${pos || '-'}</span></td>
                        <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                        ${cells}
                        <td><span class="score-cell net">${s.roundsPlayed > 0 ? s.totalNet : '-'}</span></td>
                    `;
                };
            } else {
                headers = `<th style="width:50px">#</th><th>Player</th><th>HCP</th><th>Rnds</th><th>Best</th><th>Avg</th><th>To Par</th><th class="highlight">Net</th><th></th>`;
                renderRow = (s, pos) => `
                    <td><span class="pos-badge ${pos <= 3 ? 'pos-' + pos : 'pos-other'}">${pos || '-'}</span></td>
                    <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                    <td>${s.handicap}</td>
                    <td>${s.roundsPlayed}</td>
                    <td>${s.bestNet || '-'}</td>
                    <td>${s.avgNet || '-'}</td>
                    <td class="to-par ${s.toPar !== null ? (s.toPar > 0 ? 'over' : s.toPar < 0 ? 'under' : 'even') : ''}">${formatToPar(s.toPar)}</td>
                    <td><span class="score-cell net">${s.roundsPlayed > 0 ? s.totalNet : '-'}</span></td>
                    <td>${getTrendIcon(s.trend)}</td>
                `;
            }

            return `
                <table class="standings-table">
                    <thead><tr>${headers}</tr></thead>
                    <tbody>
                        ${sorted.map((s, i) => {
                            const pos = s.roundsPlayed > 0 ? i + 1 : null;
                            return `
                                <tr onclick="toggleDetails('${s.id}')">${renderRow(s, pos)}</tr>
                                <tr class="expand-row" id="details-${s.id}">
                                    <td colspan="10">
                                        <div class="round-breakdown">
                                            ${s.roundDetails.length > 0 ? `
                                                <div class="stats-summary">
                                                    <span><strong>Best:</strong> ${s.bestGross}</span>
                                                    <span><strong>Worst:</strong> ${s.worstGross}</span>
                                                    <span><strong>Avg:</strong> ${s.avgGross}</span>
                                                    ${s.trend !== null ? `<span><strong>Trend:</strong> ${s.trend > 0 ? '‚Üë Improving' : s.trend < 0 ? '‚Üì Declining' : '‚Üí Steady'}</span>` : ''}
                                                </div>
                                                ${s.roundDetails.map(r => `
                                                <div class="round-chip">
                                                    <div class="week">${r.name}</div>
                                                    <div class="scores">${has18 ? `OUT ${r.out} ‚Ä¢ IN ${r.in} ‚Ä¢ ` : ''}Gross ${r.gross} ‚Üí <span class="net-val">Net ${r.net}</span></div>
                                                </div>
                                            `).join('')}` : '<span style="color:#999">No rounds played yet</span>'}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function toggleDetails(playerId) {
            document.getElementById('details-' + playerId)?.classList.toggle('open');
        }

        function exportToExcel() {
            if (!cachedLeague || !cachedStandings) return;
            const league = cachedLeague;
            const standings = sortStandings(cachedStandings, currentView);
            
            let csv = [`${league.name} - ${league.season}`, `Exported: ${new Date().toLocaleDateString()}`, ''];
            csv.push(['Pos', 'Player', 'Team', 'HCP', 'Rounds', 'Gross', 'Net'].join(','));
            
            standings.forEach((s, i) => {
                const teamName = (league.teams || []).find(t => t.id === s.teamId)?.name || '';
                csv.push([s.roundsPlayed > 0 ? i + 1 : '-', `"${s.name}"`, `"${teamName}"`, s.handicap, s.roundsPlayed, s.totalGross || '-', s.totalNet || '-'].join(','));
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${league.name.replace(/\s+/g, '_')}_Standings.csv`;
            link.click();
        }

        init();
        setInterval(init, 30000);
    </script>
</body>
</html>

