<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Cove - New Haven</title>
    <meta name="description" content="View live league standings, scores, and weekly results from Golf Cove leagues.">
    <link rel="icon" type="image/png" href="images/golfCoveLogo6.png">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        /* Hero Banner */
        .league-hero {
            background: linear-gradient(135deg, rgba(26,26,26,0.92) 0%, rgba(55,178,74,0.88) 100%), 
                        url('images/gallery-1.jpg') center/cover;
            padding: 100px 20px 70px;
            text-align: center;
            color: #fff;
            position: relative;
            overflow: hidden;
        }
        .league-hero::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 100px;
            background: linear-gradient(to top, rgba(0,0,0,0.3), transparent);
        }
        .league-hero h1 {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 12px;
            text-shadow: 0 4px 12px rgba(0,0,0,0.5);
            letter-spacing: -0.5px;
            position: relative;
            z-index: 1;
            color: #fff !important;
        }
        .hero-subtitle {
            font-size: 20px;
            font-weight: 700;
            margin: 20px 0 8px;
            color: #fff;
            position: relative;
            z-index: 1;
        }
        .hero-dates {
            font-size: 15px;
            color: rgba(255,255,255,0.9);
            margin-bottom: 15px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }
        .view-schedule-btn {
            display: inline-block;
            background: rgba(255,255,255,0.15);
            color: #fff;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 13px;
            font-weight: 600;
            text-decoration: none;
            margin-bottom: 20px;
            transition: all 0.2s;
            border: 1px solid rgba(255,255,255,0.3);
            position: relative;
            z-index: 1;
        }
        .view-schedule-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }
        .view-schedule-btn i { 
            margin-right: 6px;
            font-size: 12px;
        }
        .join-league-btn {
            display: inline-block;
            background: #fff;
            color: #37b24a;
            padding: 14px 32px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: 700;
            text-decoration: none;
            margin-top: 10px;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative;
            z-index: 1;
        }
        .join-league-btn:hover {
            background: #37b24a;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        }
        .join-league-btn i { margin-right: 8px; }
        .league-hero .stats-grid {
            display: flex;
            justify-content: center;
            gap: 50px;
            margin-top: 40px;
            position: relative;
            z-index: 1;
        }
        .league-hero .stat {
            text-align: center;
            position: relative;
        }
        .league-hero .stat::before {
            content: '';
            position: absolute;
            inset: -10px;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            z-index: -1;
        }
        .league-hero .stat-num {
            font-size: 56px;
            font-weight: 900;
            line-height: 1;
            background: linear-gradient(135deg, #fff, #d4f4dd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .league-hero .stat-label {
            font-size: 13px;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
            margin-top: 8px;
        }

        /* Live Banner */
        .live-banner {
            background: linear-gradient(90deg, #ff6b6b, #ee5a5a);
            color: #fff;
            padding: 15px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            max-width: 900px;
            margin: -30px auto 30px;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(238,90,90,0.4);
            position: relative;
            z-index: 10;
        }
        .live-banner .live-dot {
            width: 12px;
            height: 12px;
            background: #fff;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
            margin-right: 12px;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        .live-banner .info {
            display: flex;
            align-items: center;
            font-weight: 600;
            font-size: 16px;
        }
        .live-banner .count {
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
        }

        /* Main Container */
        .league-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px 80px;
        }

        /* Standings Card */
        .standings-card {
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.12);
            overflow: hidden;
            margin-bottom: 40px;
            border: 1px solid rgba(55,178,74,0.1);
        }
        .standings-header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #fff;
            padding: 30px 35px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }
        .standings-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #37b24a, #2d9440, #37b24a);
        }
        .standings-header h2 {
            font-size: 24px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 700;
            letter-spacing: -0.3px;
        }
        .standings-header .trophy {
            font-size: 32px;
            filter: drop-shadow(0 2px 8px rgba(255,215,0,0.5));
        }

        /* Controls */
        .controls-panel {
            padding: 25px 30px;
            background: linear-gradient(to bottom, #f8fafb 0%, #f1f3f5 100%);
            border-bottom: 2px solid #e9ecef;
        }
        .controls-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 18px;
        }
        .controls-row:last-child { margin-bottom: 0; }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #fff;
            padding: 4px 16px 4px 4px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .filter-group label {
            font-size: 12px;
            font-weight: 700;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .filter-group label i {
            color: #37b24a;
        }
        .filter-select {
            padding: 10px 14px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            background: transparent;
            min-width: 160px;
            cursor: pointer;
            color: #333;
        }
        .filter-select:focus {
            outline: 2px solid #37b24a;
            outline-offset: 2px;
        }

        .view-toggle {
            display: flex;
            background: #fff;
            border-radius: 10px;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .view-btn {
            padding: 11px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            color: #666;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .view-btn i {
            font-size: 12px;
        }
        .view-btn.active {
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            color: #fff;
            box-shadow: 0 4px 12px rgba(55,178,74,0.4);
            transform: translateY(-1px);
        }
        .view-btn:hover:not(.active) {
            background: #f0f0f0;
            color: #37b24a;
        }

        .export-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 11px 20px;
            background: linear-gradient(135deg, #217346 0%, #1a5c38 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            margin-left: auto;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 10px rgba(33,115,70,0.3);
        }
        .export-btn:hover {
            background: linear-gradient(135deg, #1a5c38 0%, #145229 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(33,115,70,0.4);
        }
        .export-btn i {
            font-size: 15px;
        }

        /* Table */
        .standings-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .standings-table th {
            background: linear-gradient(to bottom, #f8fafb 0%, #f1f3f5 100%);
            padding: 18px 20px;
            text-align: left;
            font-size: 11px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #555;
            border-bottom: 3px solid #e0e0e0;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .standings-table th.highlight {
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            color: #fff;
            box-shadow: 0 2px 8px rgba(55,178,74,0.2);
        }
        .standings-table td {
            padding: 20px;
            border-bottom: 1px solid #f5f5f5;
            font-size: 15px;
            font-weight: 500;
        }
        .standings-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }
        .standings-table tbody tr:hover {
            background: linear-gradient(to right, #f8fff9, #ffffff);
            transform: scale(1.01);
            box-shadow: 0 2px 12px rgba(55,178,74,0.08);
        }
        .standings-table tbody tr:active {
            transform: scale(0.99);
        }

        /* Position Badges */
        .pos-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 38px;
            height: 38px;
            border-radius: 50%;
            font-weight: 800;
            font-size: 15px;
            position: relative;
            transition: transform 0.2s;
        }
        .standings-table tbody tr:hover .pos-badge {
            transform: scale(1.1) rotate(-5deg);
        }
        .pos-1 { 
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); 
            color: #fff; 
            box-shadow: 0 4px 15px rgba(255,215,0,0.5), inset 0 1px 0 rgba(255,255,255,0.3);
            border: 2px solid rgba(255,255,255,0.4);
        }
        .pos-2 { 
            background: linear-gradient(135deg, #E8E8E8 0%, #A8A8A8 100%); 
            color: #fff; 
            box-shadow: 0 4px 12px rgba(192,192,192,0.4), inset 0 1px 0 rgba(255,255,255,0.4);
            border: 2px solid rgba(255,255,255,0.3);
        }
        .pos-3 { 
            background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); 
            color: #fff; 
            box-shadow: 0 4px 12px rgba(205,127,50,0.4), inset 0 1px 0 rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.2);
        }
        .pos-other { 
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); 
            color: #666; 
            font-weight: 700;
            border: 2px solid #e0e0e0;
        }

        .player-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .player-name {
            font-weight: 700;
            color: #1a1a1a;
            font-size: 15px;
            letter-spacing: -0.2px;
        }
        .player-team {
            font-size: 12px;
            color: #37b24a;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .player-team::before {
            content: 'üë•';
            font-size: 10px;
        }
        .player-hcp {
            color: #999;
            font-size: 12px;
            font-weight: 500;
        }

        .score-cell {
            font-weight: 800;
            font-size: 20px;
            letter-spacing: -0.5px;
        }
        .score-cell.net { 
            color: #37b24a; 
            background: linear-gradient(135deg, #e8f5ea 0%, #f0f9f1 100%);
            padding: 6px 12px;
            border-radius: 8px;
            display: inline-block;
        }
        .score-cell.gross { 
            color: #1a1a1a;
            font-weight: 700;
        }
        
        /* Trend indicators */
        .trend-up { 
            color: #37b24a; 
            font-weight: 900; 
            font-size: 20px;
            filter: drop-shadow(0 2px 4px rgba(55,178,74,0.3));
        }
        .trend-down { 
            color: #e74c3c; 
            font-weight: 900; 
            font-size: 20px;
            filter: drop-shadow(0 2px 4px rgba(231,76,60,0.3));
        }
        .trend-flat { 
            color: #95a5a6; 
            font-weight: 700;
            font-size: 18px;
        }
        
        /* Stats summary in expanded row */
        .stats-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 25px;
            padding: 15px 20px;
            background: linear-gradient(135deg, #e8f5ea 0%, #f0f9f1 100%);
            border-radius: 12px;
            margin-bottom: 15px;
            font-size: 14px;
            border-left: 4px solid #37b24a;
            box-shadow: 0 2px 8px rgba(55,178,74,0.1);
        }
        .stats-summary span { 
            color: #555; 
            font-weight: 500;
        }
        .stats-summary strong { 
            color: #37b24a; 
            font-weight: 700;
            font-size: 16px;
        }

        /* Expand Row */
        .expand-row {
            display: none;
            background: linear-gradient(to bottom, #fafbfc 0%, #f5f6f7 100%);
            border-top: 2px solid #e0e0e0;
        }
        .expand-row.open { 
            display: table-row;
            animation: expandRow 0.3s ease;
        }
        @keyframes expandRow {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .expand-row td {
            padding: 25px !important;
        }
        .round-breakdown {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }
        .round-chip {
            background: #fff;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            padding: 14px 18px;
            font-size: 13px;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.04);
        }
        .round-chip:hover {
            border-color: #37b24a;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(55,178,74,0.15);
        }
        .round-chip .week { 
            font-weight: 700; 
            color: #1a1a1a;
            font-size: 14px;
            margin-bottom: 6px;
        }
        .round-chip .scores { 
            color: #666; 
            font-size: 12px;
            font-weight: 500;
        }
        .round-chip .net-val { 
            color: #37b24a; 
            font-weight: 700;
            font-size: 13px;
        }

        /* Loading Skeleton */
        .skeleton-loader {
            padding: 30px;
        }
        .skeleton-row {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 12px;
        }
        .skeleton-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 50%, #e9ecef 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }
        .skeleton-text {
            flex: 1;
            height: 16px;
            border-radius: 8px;
            background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 50%, #e9ecef 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }
        .skeleton-text-short {
            width: 60px;
            height: 16px;
            border-radius: 8px;
            background: linear-gradient(90deg, #e9ecef 25%, #f8f9fa 50%, #e9ecef 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 80px 30px;
        }
        .empty-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }
        .empty-state h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .empty-state p {
            color: #888;
            margin-bottom: 30px;
        }

        /* Action Buttons */
        .action-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 40px;
        }
        .league-btn {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 16px 32px;
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(55,178,74,0.3);
            position: relative;
            overflow: hidden;
        }
        .league-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        .league-btn:hover::before {
            width: 300px;
            height: 300px;
        }
        .league-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(55,178,74,0.4);
        }
        .league-btn i {
            font-size: 18px;
            position: relative;
            z-index: 1;
        }
        .league-btn span {
            position: relative;
            z-index: 1;
        }
        .league-btn:hover {
            background: #2d9440;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(55,178,74,0.3);
        }
        .league-btn-outline {
            background: transparent;
            border: 2px solid #37b24a;
            color: #37b24a;
        }
        .league-btn-outline:hover {
            background: #37b24a;
            color: #fff;
        }

        /* Admin Link */
        .admin-footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }
        .admin-footer a {
            color: #999;
            text-decoration: none;
            font-size: 14px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }
        .admin-footer a:hover { color: #37b24a; }

        /* Create Team Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
            backdrop-filter: blur(4px);
        }
        .modal-overlay.open {
            display: flex;
        }
        .modal-content {
            background: #fff;
            border-radius: 20px;
            max-width: 550px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0,0,0,0.4);
            animation: modalSlideIn 0.3s ease-out;
        }
        @keyframes modalSlideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            background: linear-gradient(135deg, #059669, #047857);
            color: #fff;
            padding: 25px 30px;
            border-radius: 20px 20px 0 0;
            position: relative;
        }
        .modal-header h2 {
            font-size: 24px;
            margin: 0 0 5px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .modal-header p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }
        .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.2);
            border: none;
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }
        .modal-body {
            padding: 30px;
        }
        .membership-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
        }
        .membership-option {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        .membership-option:hover {
            border-color: #059669;
            background: #f0fdf4;
        }
        .membership-option.selected {
            border-color: #059669;
            background: #ecfdf5;
            box-shadow: 0 0 0 3px rgba(5, 150, 105, 0.15);
        }
        .membership-option .option-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .membership-option .option-title {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .membership-option .option-price {
            font-size: 24px;
            font-weight: 800;
            color: #059669;
        }
        .membership-option .option-desc {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
        .membership-option .check-icon {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 24px;
            height: 24px;
            border: 2px solid #ddd;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .membership-option.selected .check-icon {
            background: #059669;
            border-color: #059669;
            color: #fff;
        }
        .membership-option .check-icon i {
            font-size: 12px;
            opacity: 0;
        }
        .membership-option.selected .check-icon i {
            opacity: 1;
        }
        .modal-btn {
            width: 100%;
            padding: 16px 30px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .modal-btn-primary {
            background: linear-gradient(135deg, #059669, #047857);
            color: #fff;
        }
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(5, 150, 105, 0.3);
        }
        .modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }
        .modal-footer-note {
            text-align: center;
            margin-top: 15px;
            font-size: 13px;
            color: #888;
        }
        .modal-footer-note i {
            margin-right: 5px;
            color: #059669;
        }
        .benefits-list {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px 20px;
            margin-top: 10px;
        }
        .benefits-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 13px;
            color: #555;
        }
        .benefits-list li i {
            color: #059669;
            font-size: 12px;
        }
        .create-team-btn {
            background: linear-gradient(135deg, #059669 0%, #047857 100%) !important;
            box-shadow: 0 4px 15px rgba(5, 150, 105, 0.3);
        }
        .create-team-btn:hover {
            background: linear-gradient(135deg, #047857 0%, #065f46 100%) !important;
        }

        /* Refresh indicator */
        .refresh-note {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 20px;
        }
        .refresh-note i { margin-right: 5px; }

        /* No league setup - full page state */
        .setup-prompt {
            min-height: 60vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }
        .setup-card {
            text-align: center;
            background: #fff;
            padding: 60px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 500px;
        }
        .setup-card .icon {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #37b24a, #2d9440);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 25px;
        }
        .setup-card .icon i {
            font-size: 40px;
            color: #fff;
        }
        .setup-card h2 {
            font-size: 28px;
            margin-bottom: 15px;
            color: #333;
        }
        .setup-card p {
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        @media (max-width: 768px) {
            .league-hero { padding: 60px 20px 50px; }
            .league-hero h1 { font-size: 32px; }
            .hero-subtitle { font-size: 16px; }
            .hero-dates { font-size: 13px; }
            .league-hero .stats-grid { gap: 30px; flex-wrap: wrap; }
            .league-hero .stat-num { font-size: 42px; }
            .controls-row { flex-direction: column; align-items: stretch; gap: 15px; }
            .filter-group { justify-content: space-between; }
            .view-btn { padding: 10px 12px; font-size: 12px; }
            .view-toggle { justify-content: center; width: 100%; }
            .view-btn { flex: 1; }
            .export-btn { margin: 0; justify-content: center; width: 100%; }
            .standings-table th { padding: 14px 12px; font-size: 10px; }
            .standings-table td { padding: 16px 12px; font-size: 14px; }
            .pos-badge { width: 34px; height: 34px; font-size: 13px; }
            .player-name { font-size: 14px; }
            .score-cell { font-size: 18px; }
            .score-cell.net { padding: 5px 10px; }
            .standings-header { padding: 22px 20px; }
            .standings-header h2 { font-size: 20px; }
            .controls-panel { padding: 20px; }
            .round-chip { padding: 12px 15px; }
            .league-btn { width: 100%; justify-content: center; }
        }
        @media (max-width: 600px) {
            .controls-panel { padding: 16px; }
            .controls-row { width: 100%; }
            .filter-group,
            .view-toggle,
            .export-btn { width: 100%; }
            .view-toggle { flex-wrap: wrap; }
            .view-btn { flex: 1 1 calc(50% - 8px); min-width: 140px; }
        }
        /* Prevent leaderboard from being clipped on small screens */
        #standingsContent {
            overflow-x: auto;
        }
        .standings-table {
            min-width: 720px;
        }
        @media (max-width: 600px) {
            .standings-table { min-width: 620px; }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="top-bar">
        <div class="container">
            <div class="top-bar-left">
                <a href="tel:2033905994"><i class="fas fa-phone"></i> 203.390.5994</a>
                <a href="https://maps.google.com/?q=336+State+Street,+North+Haven,+CT+06473" target="_blank"><i class="fas fa-map-marker-alt"></i> 336 STATE STREET, NORTH HAVEN, CT</a>
            </div>
            <div class="top-bar-right">
                <div class="social-links">
                    <a href="https://www.facebook.com/golfcove/" target="_blank"><i class="fab fa-facebook-f"></i></a>
                    <a href="https://www.instagram.com/golfcovect/" target="_blank"><i class="fab fa-instagram"></i></a>
                </div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="header-main">
            <div class="logo">
                <a href="index.html">
                    <img src="images/golfCoveLogo6.png" alt="Golf Cove Logo" width="200" height="75">
                </a>
            </div>
            <nav class="main-nav" id="mainNav">
                <ul class="nav-menu">
                    <li><a href="pricing.html">Pricing</a></li>
                    <li><a href="memberships.html">Memberships</a></li>
                    <li class="dropdown">
                        <a href="lessons-leagues.html" class="active">Lessons & Leagues <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="lessons-leagues.html">Lessons & Leagues</a></li>
                            <li><a href="pinseeker.html">PinSeeker at Golf Cove</a></li>
                        </ul>
                    </li>
                    <li class="dropdown">
                        <a href="private-events.html">Private Events <i class="fas fa-chevron-down"></i></a>
                        <ul class="dropdown-menu">
                            <li><a href="private-events.html">Private Events</a></li>
                            <li><a href="concierge.html">The Cove Concierge</a></li>
                        </ul>
                    </li>
                    <li><a href="multisport.html">MultiSport Arcade</a></li>
                    <li><a href="gift-cards.html">Gift Cards</a></li>
                    <li><a href="menu.html">Menu</a></li>
                    <li><a href="contact.html">Contact</a></li>
                    <li><a href="https://918booking.com/emb-bookings?course=7" class="btn-book" target="_blank">RESERVE A ROOM</a></li>
                </ul>
            </nav>
            <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="Toggle Menu">
                <span></span><span></span><span></span>
            </button>
        </div>
    </header>

    <main id="app">
        <!-- Content loaded by JS -->
    </main>

    <!-- Footer -->
    <footer>
        <div class="footer-simple">
            <div class="footer-social-center">
                <a href="https://www.facebook.com/golfcove/" target="_blank" aria-label="Facebook"><i class="fab fa-facebook-f"></i></a>
                <a href="https://www.instagram.com/golfcovect/" target="_blank" aria-label="Instagram"><i class="fab fa-instagram"></i></a>
            </div>
            <p class="footer-social-text">Please visit our facebook and instagram pages frequently for events, updates and promotions!</p>
            <p class="footer-address"><a href="https://maps.google.com/?q=336+State+Street,+North+Haven,+CT+06473" target="_blank">336 State Street, North Haven, CT 06473</a> | Phone: <a href="tel:2033905994">203.390.5994</a></p>
            <p class="footer-copyright">¬© 2025 Golf Cove | <a href="contact.html">Contact Us</a> | <a href="sitemap.html">Site Map</a></p>
        </div>
    </footer>

    <script src="js/main.js"></script>
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8SH5Eh7OhIFLUkL2hjZS23uXkCsDJXGc",
            authDomain: "golfcove.firebaseapp.com",
            databaseURL: "https://golfcove-default-rtdb.firebaseio.com",
            projectId: "golfcove",
            storageBucket: "golfcove.firebasestorage.app",
            messagingSenderId: "284762891644",
            appId: "1:284762891644:web:424223b102f08a230f70f9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const leagueRef = db.ref('league');
        
        // Default to Teams view for 2-man scramble format
        let currentView = 'team-standings';
        let currentTeamFilter = '';
        let minRoundsFilter = 0;
        let cachedLeague = null;
        let cachedStandings = null;

        // Default demo league shown when no league exists
        const defaultLeague = {
            name: 'Golf Cove League',
            course: { name: 'Golf Cove', holes: 9 },
            teams: [{ id: 't1', name: 'Demo Team' }],
            players: [
                { id: 'p1', name: 'Javi', teamId: 't1', handicap: 10 }
            ],
            rounds: [],
            scores: {}
        };

        function init() {
            const app = document.getElementById('app');
            app.innerHTML = '<div style="text-align:center;padding:60px;"><i class="fas fa-spinner fa-spin fa-2x" style="color:#37b24a;"></i><p style="margin-top:15px;color:#666;">Loading standings...</p></div>';
            
            // Timeout fallback - if Firebase doesn't respond in 5 seconds, show default
            const timeout = setTimeout(() => {
                console.log('Firebase timeout - using default league');
                renderLeague(defaultLeague);
            }, 5000);
            
            // Listen for real-time updates from Firebase
            leagueRef.on('value', (snapshot) => {
                clearTimeout(timeout);
                console.log('Firebase connected! Data:', snapshot.val());
                let league = snapshot.val();
                
                // Use default league if none exists
                if (!league) {
                    league = defaultLeague;
                } else {
                    // Ensure arrays exist (Firebase returns undefined for empty arrays)
                    league.players = league.players || [];
                    league.rounds = league.rounds || [];
                    league.teams = league.teams || [];
                    league.scores = league.scores || {};
                }
                
                renderLeague(league);
            }, (error) => {
                clearTimeout(timeout);
                console.error('Firebase error:', error);
                // Fallback to default league on error
                renderLeague(defaultLeague);
            });
        }
        
        function renderLeague(league) {
            const app = document.getElementById('app');
            
            // Show loading skeleton initially
            if (!cachedLeague) {
                app.innerHTML = `
                    <div class="league-hero">
                        <h1>üèÜ Loading League...</h1>
                    </div>
                    <div class="league-container">
                        <div class="standings-card">
                            <div class="skeleton-loader">
                                ${Array.from({length: 8}, () => `
                                    <div class="skeleton-row">
                                        <div class="skeleton-circle"></div>
                                        <div class="skeleton-text"></div>
                                        <div class="skeleton-text-short"></div>
                                        <div class="skeleton-text-short"></div>
                                        <div class="skeleton-text-short"></div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            cachedLeague = league;
            cachedStandings = calculateStandings(league);
            const hasPlayers = (league.players || []).length > 0;

            // Find current round based on today's date
            const today = new Date();
            today.setHours(0, 0, 0, 0); // Reset time to midnight for accurate date comparison
            
            const rounds = league.rounds || [];
            let currentRound = null;
            
            // First, try to find a round whose date range includes today
            for (const round of rounds) {
                if (round.startDate && round.endDate) {
                    const start = new Date(round.startDate);
                    const end = new Date(round.endDate);
                    start.setHours(0, 0, 0, 0);
                    end.setHours(23, 59, 59, 999);
                    
                    if (today >= start && today <= end) {
                        currentRound = round;
                        break;
                    }
                }
            }
            
            // If no current round found, use the most recent one (last in array)
            if (!currentRound && rounds.length > 0) {
                currentRound = rounds[rounds.length - 1];
            }
            
            let roundInfoHTML = '';
            const seasonBadge = league.season ? `<div class="season-badge"><i class="fas fa-calendar-alt"></i> ${league.season}</div>` : '';
            
            if (currentRound) {
                const startDate = currentRound.startDate ? new Date(currentRound.startDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
                const endDate = currentRound.endDate ? new Date(currentRound.endDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : '';
                const dateDisplay = startDate && endDate ? `${startDate} - ${endDate}` : '';
                
                roundInfoHTML = `
                    <div class="hero-subtitle">${currentRound.name}${(currentRound.course || league.course?.name) ? ' &bull; ' + (currentRound.course || league.course?.name) : ''}</div>
                    ${dateDisplay ? `<div class="hero-dates">${dateDisplay}</div>` : ''}
                `;
            }

            app.innerHTML = `
                <div class="league-hero">
                    <h1> ${league.name}</h1>
                    ${seasonBadge}
                    ${roundInfoHTML}
                    <div class="hero-actions" style="display:flex; flex-direction:column; gap:10px; align-items:center; max-width:320px; margin: 0 auto;">
                        <button onclick="openCreateTeamModal()" class="join-league-btn create-team-btn" style="width:100%; text-align:center; border:none;"><i class="fas fa-plus-circle"></i> Create a Team</button>
                        <a href="score.html" class="join-league-btn" style="width:100%; text-align:center;"><i class="fas fa-users"></i> Enter Team Score</a>
                        <a href="schedule.html" class="view-schedule-btn" style="width:100%; text-align:center;"><i class="fas fa-calendar-alt"></i> View Schedule</a>
                    </div>
                    <div style="font-size: 14px; color: rgba(255,255,255,0.85); margin-top: 15px; margin-bottom: 10px;"><i class="fas fa-golf-ball"></i> 2-Man Scramble Format</div>
                    <div class="stats-grid">
                        <div class="stat" style="border-left: 4px solid #37b24a; padding-left: 20px;">
                            <div class="stat-num" style="color: #37b24a;">${league.teams?.length || 0}</div>
                            <div class="stat-label"><i class="fas fa-users"></i> Teams</div>
                        </div>
                        <div class="stat" style="border-left: 4px solid #FF9800; padding-left: 20px;">
                            <div class="stat-num" style="color: #FF9800;">${(league.rounds || []).length}</div>
                            <div class="stat-label"><i class="fas fa-flag"></i> Rounds</div>
                        </div>
                    </div>
                </div>

                <div class="league-container">
                    <div class="standings-card">
                        <div class="standings-header">
                            <h2><span class="trophy"></span> Leaderboard</h2>
                        </div>

                        ${hasPlayers ? `
                        <div class="controls-panel">
                            <div class="controls-row">
                                <div class="filter-group">
                                    <label><i class="fas fa-flag-checkered"></i> Min Rounds:</label>
                                    <select class="filter-select" id="roundFilter" onchange="filterByRounds(this.value)">
                                        <option value="0">All Teams</option>
                                        <option value="1">1+ rounds</option>
                                        <option value="3">3+ rounds</option>
                                        <option value="5">5+ rounds</option>
                                    </select>
                                </div>
                                <div class="view-toggle">
                                    <button class="view-btn ${currentView === 'team-standings' ? 'active' : ''}" data-view="team-standings" title="Team leaderboard - combined net scores for 2-person teams"><i class="fas fa-trophy"></i> Teams</button>
                                    <button class="view-btn ${currentView === 'by-round' ? 'active' : ''}" data-view="by-round" title="Week by week breakdown - see round-by-round performance"><i class="fas fa-calendar-week"></i> By Week</button>
                                    <button class="view-btn ${currentView === 'cumulative-net' ? 'active' : ''}" data-view="cumulative-net" title="Individual player net scores"><i class="fas fa-user"></i> Players</button>
                                </div>
                                <button class="export-btn" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel"></i> Export
                                </button>
                            </div>
                        </div>
                        ` : ''}

                        <div id="standingsContent">
                            ${hasPlayers ? renderTable(cachedStandings, league, currentView) : `
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h2>No Players Yet</h2>
                                    <p>Be the first to join the league!</p>
                                </div>
                            `}
                        </div>
                    </div>

                    <div class="action-row">
                        <a href="score.html" class="league-btn"><i class="fas fa-users"></i> Enter Team Score</a>
                        <a href="schedule.html" class="league-btn" style="background: linear-gradient(135deg, #1976d2 0%, #1565c0 100%);"><i class="fas fa-calendar-alt"></i> View Schedule</a>
                    </div>

                    <div class="admin-footer">
                        <a href="league-admin.html"><i class="fas fa-cog"></i> League Admin</a>
                    </div>

                <div class="refresh-note">
                    <i class="fas fa-sync-alt"></i> Auto-refreshes every 30 seconds
                </div>
            </div>
        `;

            // Attach view toggle handlers
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', () => setView(btn.dataset.view));
            });
        }

        function calculateStandings(league) {
            const holes = 9; // Front 9 only
            const frontNine = 9;
            const players = league.players || [];
            const rounds = league.rounds || [];
            
            return players.map(player => {
                let totalGross = 0, totalOut = 0, totalIn = 0, roundsPlayed = 0;
                let roundDetails = [];
                let bestGross = null, worstGross = null, bestNet = null;
                let allGross = [], allNet = [];

                rounds.forEach(round => {
                    const ps = league.scores?.[round.id]?.[player.id];
                    if (ps && ps.submitted) {
                        let gross = 0;
                        let holesPlayed = 0;
                        
                        for (let h = 1; h <= frontNine; h++) {
                            const score = ps[h];
                            if (score && score > 0) {
                                gross += score; holesPlayed++;
                            }
                        }
                        
                        // Only count rounds where player actually played (at least 50% of holes)
                        if (holesPlayed >= Math.ceil(frontNine / 2)) {
                            const net = gross - (player.handicap || 0);
                            totalGross += gross; roundsPlayed++;
                            roundDetails.push({ name: round.name, date: round.date, gross, net, holesPlayed });
                            
                            allGross.push(gross);
                            allNet.push(net);
                            if (bestGross === null || gross < bestGross) bestGross = gross;
                            if (worstGross === null || gross > worstGross) worstGross = gross;
                            if (bestNet === null || net < bestNet) bestNet = net;
                        }
                    }
                });

                const totalNet = totalGross - ((player.handicap || 0) * roundsPlayed);
                const avgGross = roundsPlayed > 0 ? Math.round((totalGross / roundsPlayed) * 10) / 10 : null;
                const avgNet = roundsPlayed > 0 ? Math.round((totalNet / roundsPlayed) * 10) / 10 : null;
                
                // Calculate trend (last 3 rounds vs previous 3)
                let trend = null;
                if (allNet.length >= 2) {
                    const recent = allNet.slice(-Math.min(3, allNet.length));
                    const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
                    if (allNet.length >= 4) {
                        const older = allNet.slice(-6, -3);
                        if (older.length > 0) {
                            const olderAvg = older.reduce((a, b) => a + b, 0) / older.length;
                            trend = olderAvg - recentAvg; // positive = improving
                        }
                    }
                }
                
                return {
                    id: player.id, name: player.name, teamId: player.teamId || null,
                    handicap: player.handicap || 0, totalGross, totalNet,
                    roundsPlayed, roundDetails, bestGross, worstGross, bestNet, avgGross, avgNet,
                    trend
                };
            });
        }

        function filterByTeam(teamId) {
            currentTeamFilter = teamId;
            updateStandings();
        }

        function filterByRounds(value) {
            minRoundsFilter = parseInt(value, 10) || 0;
            updateStandings();
        }

        function updateStandings() {
            let filtered = cachedStandings;
            if (currentTeamFilter) filtered = cachedStandings.filter(s => s.teamId === currentTeamFilter);
            if (minRoundsFilter) filtered = filtered.filter(s => s.roundsPlayed >= minRoundsFilter);
            document.getElementById('standingsContent').innerHTML = renderTable(filtered, cachedLeague, currentView);

            // Sync round filter select with state
            const roundFilter = document.getElementById('roundFilter');
            if (roundFilter && roundFilter.value !== String(minRoundsFilter)) {
                roundFilter.value = String(minRoundsFilter);
            }
        }

        function setView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            updateStandings();
        }

        function sortStandings(standings, view) {
            return [...standings].sort((a, b) => {
                if (a.roundsPlayed === 0) return 1;
                if (b.roundsPlayed === 0) return -1;
                
                const tieBreakNet = () => {
                    // Tie-breakers: more rounds, then best net, then avg net
                    if (a.roundsPlayed !== b.roundsPlayed) return b.roundsPlayed - a.roundsPlayed;
                    if (a.bestNet !== null && b.bestNet !== null && a.bestNet !== b.bestNet) return a.bestNet - b.bestNet;
                    const avgA = a.avgNet !== null ? a.avgNet : 999;
                    const avgB = b.avgNet !== null ? b.avgNet : 999;
                    return avgA - avgB;
                };
                
                if (view === 'cumulative-gross') {
                    if (a.totalGross !== b.totalGross) return a.totalGross - b.totalGross;
                    return tieBreakNet();
                } else if (view === 'average') {
                    // Sort by average net score (lower is better)
                    const avgA = a.avgNet !== null ? a.avgNet : 999;
                    const avgB = b.avgNet !== null ? b.avgNet : 999;
                    if (avgA !== avgB) return avgA - avgB;
                    return tieBreakNet();
                } else if (view === 'recent-form') {
                    // Sort by last 3 rounds total
                    const recentA = a.roundDetails.slice(-3).reduce((sum, r) => sum + r.net, 0);
                    const recentB = b.roundDetails.slice(-3).reduce((sum, r) => sum + r.net, 0);
                    if (recentA !== recentB) return recentA - recentB;
                    return tieBreakNet();
                } else if (view === 'team-standings') {
                    return tieBreakNet();
                } else {
                    // Net default
                    if (a.totalNet !== b.totalNet) return a.totalNet - b.totalNet;
                    return tieBreakNet();
                }
            });
        }

        function renderTable(standings, league, view = 'cumulative-net') {
            const sorted = sortStandings(standings, view);
            
            const getTeamName = (teamId) => (league.teams || []).find(t => t.id === teamId)?.name || '';

            let headers, renderRow;
            
            // Helper for trend arrow
            const getTrendIcon = (trend) => {
                if (trend === null) return '';
                if (trend > 1) return '<span class="trend-up" title="Improving">‚Üë</span>';
                if (trend < -1) return '<span class="trend-down" title="Declining">‚Üì</span>';
                return '<span class="trend-flat" title="Steady">‚Üí</span>';
            };

            if (view === 'cumulative-gross') {
                headers = `<th style="width:50px">#</th><th style="text-align:left">Player</th><th>Rounds</th><th>Best</th><th>Avg</th><th class="highlight">Gross Total</th>`;
                renderRow = (s, posDisplay, posNum) => `
                    <td><span class="pos-badge ${posNum && posNum <= 3 ? 'pos-' + posNum : 'pos-other'}">${posDisplay || '-'}</span></td>
                    <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                    <td>${s.roundsPlayed}</td>
                    <td>${s.bestGross !== null ? s.bestGross : '-'}</td>
                    <td>${s.avgGross !== null ? s.avgGross : '-'}</td>
                    <td><span class="score-cell gross">${s.roundsPlayed > 0 ? s.totalGross : '-'}</span></td>
                `;
            } else if (view === 'by-round') {
                const roundHeaders = (league.rounds || []).map(r => `<th>${r.name.replace('Week ', 'W')}</th>`).join('');
                headers = `<th style="width:50px">#</th><th style="text-align:left">Player</th>${roundHeaders}<th class="highlight">Net Total</th>`;
                renderRow = (s, posDisplay, posNum) => {
                    const cells = (league.rounds || []).map(r => {
                        const rd = s.roundDetails.find(d => d.name === r.name);
                        return `<td style="${rd ? '' : 'color:#ccc;opacity:0.5'}">${rd ? rd.net : '-'}</td>`;
                    }).join('');
                    return `
                        <td><span class="pos-badge ${posNum && posNum <= 3 ? 'pos-' + posNum : 'pos-other'}">${posDisplay || '-'}</span></td>
                        <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                        ${cells}
                        <td><span class="score-cell net">${s.roundsPlayed > 0 ? s.totalNet : '-'}</span></td>
                    `;
                };
            } else if (view === 'recent-form') {
                // Show last 3 rounds with detailed analysis
                headers = `<th style="width:50px">#</th><th style="text-align:left">Player</th><th>Last 3 Scores</th><th>Recent Avg</th><th>Overall Avg</th><th>Momentum</th><th class="highlight">3-Round Total</th>`;
                renderRow = (s, posDisplay, posNum) => {
                    const recentRounds = s.roundDetails.slice(-3);
                    const recentCount = recentRounds.length;
                    
                    if (recentCount === 0) {
                        return `
                            <td><span class="pos-badge pos-other">-</span></td>
                            <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                            <td colspan="5" style="text-align:center;color:#999;">No recent rounds</td>
                        `;
                    }
                    
                    const recentTotal = recentRounds.reduce((sum, r) => sum + r.net, 0);
                    const recentAvg = Math.round((recentTotal / recentCount) * 10) / 10;
                    
                    // Show individual scores for last 3 rounds
                    const scoresList = recentRounds.map(r => r.net).join(', ');
                    
                    // Calculate momentum: recent avg vs overall avg
                    const overallAvg = s.avgNet;
                    let momentum = '';
                    let momentumClass = '';
                    if (overallAvg !== null && recentCount >= 2) {
                        const diff = overallAvg - recentAvg;
                        if (diff > 0.5) {
                            momentum = `‚Üë ${Math.abs(diff).toFixed(1)}`;
                            momentumClass = 'style="color:#27ae60;font-weight:700;"';
                        } else if (diff < -0.5) {
                            momentum = `‚Üì ${Math.abs(diff).toFixed(1)}`;
                            momentumClass = 'style="color:#e74c3c;font-weight:700;"';
                        } else {
                            momentum = '‚Üí Steady';
                            momentumClass = 'style="color:#95a5a6;"';
                        }
                    } else {
                        momentum = '-';
                    }
                    
                    return `
                        <td><span class="pos-badge ${posNum && posNum <= 3 ? 'pos-' + posNum : 'pos-other'}">${posDisplay || '-'}</span></td>
                        <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                        <td style="font-size:12px;color:#666;">${scoresList}</td>
                        <td style="font-weight:600;">${recentAvg}</td>
                        <td>${overallAvg !== null ? overallAvg : '-'}</td>
                        <td ${momentumClass}>${momentum}</td>
                        <td><span class="score-cell net" style="font-size:16px;font-weight:700;">${recentTotal}</span></td>
                    `;
                };
            } else if (view === 'average') {
                // Sort by best average net score - most fair for players with different round counts
                headers = `<th style="width:50px">#</th><th style="text-align:left">Player</th><th>HCP</th><th>Rnds</th><th>Best/Worst</th><th class="highlight">Avg Net</th><th>Consistency</th><th>Total</th>`;
                renderRow = (s, posDisplay, posNum) => {
                    // Calculate standard deviation for consistency
                    let consistency = '-';
                    if (s.roundDetails.length >= 3) {
                        const netScores = s.roundDetails.map(r => r.net);
                        const avg = netScores.reduce((a, b) => a + b, 0) / netScores.length;
                        const variance = netScores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / netScores.length;
                        const stdDev = Math.sqrt(variance);
                        
                        if (stdDev < 2) {
                            consistency = '<span style="color:#27ae60;font-weight:600;" title="Very consistent scoring">‚òÖ‚òÖ‚òÖ</span>';
                        } else if (stdDev < 4) {
                            consistency = '<span style="color:#f39c12;font-weight:600;" title="Moderately consistent">‚òÖ‚òÖ</span>';
                        } else {
                            consistency = '<span style="color:#e74c3c;font-weight:600;" title="Variable scoring">‚òÖ</span>';
                        }
                    } else if (s.roundDetails.length > 0) {
                        consistency = '<span style="color:#95a5a6;">N/A</span>';
                    }
                    
                    const bestWorst = (s.bestNet !== null && s.roundDetails.length > 1) ? 
                        `${s.bestNet} / ${Math.max(...s.roundDetails.map(r => r.net))}` : 
                        (s.bestNet !== null ? `${s.bestNet}` : '-');
                    
                    return `
                        <td><span class="pos-badge ${posNum && posNum <= 3 ? 'pos-' + posNum : 'pos-other'}">${posDisplay || '-'}</span></td>
                        <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                        <td>${s.handicap}</td>
                        <td>${s.roundsPlayed}</td>
                        <td style="font-size:12px;color:#666;">${bestWorst}</td>
                        <td><span class="score-cell net" style="font-size:16px;font-weight:700;">${s.avgNet !== null ? s.avgNet : '-'}</span></td>
                        <td style="text-align:center;">${consistency}</td>
                        <td style="color:#888;">${s.roundsPlayed > 0 ? s.totalNet : '-'}</td>
                    `;
                };
            } else if (view === 'team-standings') {
                // Calculate team totals (combine both players' net scores)
                const teamScores = {};
                const teams = league.teams || [];
                
                teams.forEach(team => {
                    const teamPlayers = sorted.filter(s => s.teamId === team.id);
                    if (teamPlayers.length === 0) return;
                    
                    // Calculate team totals per round - ONLY count rounds where BOTH players played
                    const teamRounds = {};
                    teamPlayers.forEach(player => {
                        player.roundDetails.forEach(rd => {
                            if (!teamRounds[rd.name]) teamRounds[rd.name] = [];
                            teamRounds[rd.name].push(rd.net);
                        });
                    });
                    
                    // Sum both players' scores for each round where both played
                    let teamTotal = 0;
                    let roundsPlayed = 0;
                    const teamRoundScores = [];
                    
                    Object.entries(teamRounds).forEach(([roundName, roundScores]) => {
                        // Only count if both team members played this round
                        if (roundScores.length === 2) {
                            const roundTotal = roundScores.reduce((a, b) => a + b, 0);
                            teamTotal += roundTotal;
                            teamRoundScores.push(roundTotal);
                            roundsPlayed++;
                        }
                    });
                    
                    const avgPerRound = roundsPlayed > 0 ? Math.round((teamTotal / roundsPlayed) * 10) / 10 : null;
                    const bestRound = teamRoundScores.length > 0 ? Math.min(...teamRoundScores) : null;
                    
                    // Calculate team consistency
                    let consistency = '-';
                    if (teamRoundScores.length >= 3) {
                        const avg = teamTotal / roundsPlayed;
                        const variance = teamRoundScores.reduce((sum, score) => sum + Math.pow(score - avg, 2), 0) / teamRoundScores.length;
                        const stdDev = Math.sqrt(variance);
                        
                        if (stdDev < 4) {
                            consistency = '<span style="color:#27ae60;font-weight:600;" title="Very consistent team">‚òÖ‚òÖ‚òÖ</span>';
                        } else if (stdDev < 7) {
                            consistency = '<span style="color:#f39c12;font-weight:600;" title="Moderately consistent">‚òÖ‚òÖ</span>';
                        } else {
                            consistency = '<span style="color:#e74c3c;font-weight:600;" title="Variable performance">‚òÖ</span>';
                        }
                    }
                    
                    // Check if team is complete (has 2 players)
                    const isComplete = teamPlayers.length === 2;
                    const playerNames = isComplete ? 
                        teamPlayers.map(p => p.name).join(' & ') : 
                        `${teamPlayers.map(p => p.name).join(', ')} <span style="color:#e74c3c;font-size:11px;">(Incomplete)</span>`;
                    
                    teamScores[team.id] = {
                        teamId: team.id,
                        teamName: team.name,
                        playerCount: teamPlayers.length,
                        players: playerNames,
                        totalNet: teamTotal,
                        roundsPlayed,
                        avgPerRound,
                        bestRound,
                        consistency,
                        isComplete
                    };
                });
                
                // Sort teams by total net (complete teams first, then by score)
                const sortedTeams = Object.values(teamScores).sort((a, b) => {
                    if (!a.isComplete && b.isComplete) return 1;
                    if (a.isComplete && !b.isComplete) return -1;
                    if (a.roundsPlayed === 0 && b.roundsPlayed > 0) return 1;
                    if (b.roundsPlayed === 0 && a.roundsPlayed > 0) return -1;
                    return a.totalNet - b.totalNet;
                });
                
                headers = `<th style="width:50px">#</th><th style="text-align:left">Team</th><th style="text-align:left">Players</th><th>Rnds</th><th>Best Rnd</th><th>Avg/Rnd</th><th>Consistency</th><th class="highlight">Team Total</th>`;
                
                let pos = 1;
                return `
                    <table class="standings-table">
                        <thead><tr>${headers}</tr></thead>
                        <tbody>
                            ${sortedTeams.map((team, idx) => {
                                const posDisplay = (team.roundsPlayed === 0 || !team.isComplete) ? '-' : 
                                    (idx > 0 && sortedTeams[idx - 1].totalNet === team.totalNet && sortedTeams[idx - 1].isComplete) ? 
                                    `T${pos}` : (pos = idx + 1);
                                const posNum = (team.roundsPlayed === 0 || !team.isComplete) ? null : pos;
                                
                                return `
                                    <tr style="${!team.isComplete ? 'opacity:0.6;' : ''}">
                                        <td><span class="pos-badge ${posNum && posNum <= 3 ? 'pos-' + posNum : 'pos-other'}">${posDisplay}</span></td>
                                        <td style="text-align:left"><div class="player-info"><span class="player-name" style="font-weight:700;color:#37b24a;">${team.teamName}</span></div></td>
                                        <td style="text-align:left;font-size:13px;color:#666;">${team.players}</td>
                                        <td>${team.roundsPlayed}</td>
                                        <td style="font-weight:600;color:#2c3e50;">${team.bestRound !== null ? team.bestRound : '-'}</td>
                                        <td style="font-weight:600;">${team.avgPerRound !== null ? team.avgPerRound : '-'}</td>
                                        <td style="text-align:center;">${team.consistency}</td>
                                        <td><span class="score-cell net" style="font-size:18px;font-weight:700;">${team.roundsPlayed > 0 ? team.totalNet : '-'}</span></td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                // Default Net view with key league metrics: gross/net, rounds, average
                headers = `<th style="width:50px">#</th><th style="text-align:left">Player</th><th title="Rounds completed">Rnds</th><th title="Total gross strokes">Gross</th><th class="highlight" title="Total net strokes (after handicap)">Net</th><th title="Average net per round">Avg Net</th><th style="width:40px"></th>`;
                renderRow = (s, posDisplay, posNum) => `
                    <td><span class="pos-badge ${posNum && posNum <= 3 ? 'pos-' + posNum : 'pos-other'}">${posDisplay || '-'}</span></td>
                    <td><div class="player-info"><span class="player-name">${s.name}</span>${s.teamId ? `<span class="player-team">${getTeamName(s.teamId)}</span>` : ''}</div></td>
                    <td>${s.roundsPlayed}</td>
                    <td>${s.roundsPlayed > 0 ? s.totalGross : '-'}</td>
                    <td><span class="score-cell net">${s.roundsPlayed > 0 ? s.totalNet : '-'}</span></td>
                    <td>${s.avgNet !== null ? s.avgNet : '-'}</td>
                    <td style="text-align:center">${getTrendIcon(s.trend)}</td>
                `;
            }

            // Calculate positions with tie handling
            const getPosition = (sorted, index, view) => {
                if (sorted[index].roundsPlayed === 0) return null;
                
                let scoreKey, currentScore;
                if (view === 'cumulative-gross') {
                    scoreKey = 'totalGross';
                    currentScore = sorted[index][scoreKey];
                } else if (view === 'average') {
                    scoreKey = 'avgNet';
                    currentScore = sorted[index][scoreKey];
                } else if (view === 'recent-form') {
                    currentScore = sorted[index].roundDetails.slice(-3).reduce((sum, r) => sum + r.net, 0);
                } else {
                    scoreKey = 'totalNet';
                    currentScore = sorted[index][scoreKey];
                }
                
                if (currentScore === null || currentScore === undefined) return null;
                
                // Find first player with this score
                for (let i = 0; i < index; i++) {
                    if (sorted[i].roundsPlayed > 0) {
                        let compareScore;
                        if (view === 'recent-form') {
                            compareScore = sorted[i].roundDetails.slice(-3).reduce((sum, r) => sum + r.net, 0);
                        } else if (view === 'average') {
                            compareScore = sorted[i].avgNet;
                        } else {
                            compareScore = sorted[i][scoreKey];
                        }
                        
                        if (compareScore === currentScore) {
                            // Same position as earlier player with same score
                            return getPosition(sorted, i, view);
                        }
                    }
                }
                
                // Count how many players with scores are before this one
                let pos = 1;
                for (let i = 0; i < index; i++) {
                    if (sorted[i].roundsPlayed > 0) pos++;
                }
                return pos;
            };

            return `
                <table class="standings-table">
                    <thead><tr>${headers}</tr></thead>
                    <tbody>
                        ${sorted.map((s, i) => {
                            const pos = getPosition(sorted, i, view);
                            const isTied = pos !== null && sorted.filter((x, j) => j !== i && x.roundsPlayed > 0 && 
                                (view === 'cumulative-gross' ? x.totalGross : x.totalNet) === (view === 'cumulative-gross' ? s.totalGross : s.totalNet)
                            ).length > 0;
                            const posDisplay = pos ? (isTied ? `T${pos}` : pos) : null;
                            return `
                                <tr onclick="toggleDetails('${s.id}')">${renderRow(s, posDisplay, pos)}</tr>
                                <tr class="expand-row" id="details-${s.id}">
                                    <td colspan="10">
                                        <div class="round-breakdown">
                                            ${s.roundDetails.length > 0 ? `
                                                <div class="stats-summary">
                                                    <span><strong>Best:</strong> ${s.bestGross}</span>
                                                    <span><strong>Worst:</strong> ${s.worstGross}</span>
                                                    <span><strong>Avg:</strong> ${s.avgGross}</span>
                                                    ${s.trend !== null ? `<span><strong>Trend:</strong> ${s.trend > 0 ? '‚Üë Improving' : s.trend < 0 ? '‚Üì Declining' : '‚Üí Steady'}</span>` : ''}
                                                </div>
                                                ${s.roundDetails.map(r => `
                                                <div class="round-chip">
                                                    <div class="week">${r.name}</div>
                                                    <div class="scores">Gross ${r.gross} ‚Üí <span class="net-val">Net ${r.net}</span></div>
                                                </div>
                                            `).join('')}` : '<span style="color:#999">No rounds played yet</span>'}
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function toggleDetails(playerId) {
            document.getElementById('details-' + playerId)?.classList.toggle('open');
        }

        function exportToExcel() {
            if (!cachedLeague || !cachedStandings) return;
            const league = cachedLeague;
            const standings = sortStandings(cachedStandings, currentView);
            const scoreKey = currentView === 'cumulative-gross' ? 'totalGross' : 'totalNet';
            
            // Calculate positions with ties for export
            const getExportPos = (index) => {
                if (standings[index].roundsPlayed === 0) return '-';
                const currentScore = standings[index][scoreKey];
                for (let i = 0; i < index; i++) {
                    if (standings[i].roundsPlayed > 0 && standings[i][scoreKey] === currentScore) {
                        return getExportPos(i);
                    }
                }
                let pos = 1;
                for (let i = 0; i < index; i++) {
                    if (standings[i].roundsPlayed > 0) pos++;
                }
                const isTied = standings.some((x, j) => j !== index && x.roundsPlayed > 0 && x[scoreKey] === currentScore);
                return isTied ? `T${pos}` : pos;
            };
            
            let csv = [`${league.name}`, `Exported: ${new Date().toLocaleDateString()}`, ''];
            csv.push(['Pos', 'Player', 'Team', 'HCP', 'Rounds', 'Gross', 'Net'].join(','));
            
            standings.forEach((s, i) => {
                const teamName = (league.teams || []).find(t => t.id === s.teamId)?.name || '';
                csv.push([getExportPos(i), `"${s.name}"`, `"${teamName}"`, s.handicap, s.roundsPlayed, s.totalGross || '-', s.totalNet || '-'].join(','));
            });
            
            const blob = new Blob([csv.join('\n')], { type: 'text/csv' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${league.name.replace(/\s+/g, '_')}_Standings.csv`;
            link.click();
        }

        init();
        setInterval(init, 30000);

        // =====================
        // Create Team Modal
        // =====================
        let selectedMembershipTier = null;

        function openCreateTeamModal() {
            document.getElementById('createTeamModal').classList.add('open');
            document.body.style.overflow = 'hidden';
        }

        function closeCreateTeamModal() {
            document.getElementById('createTeamModal').classList.remove('open');
            document.body.style.overflow = '';
            selectedMembershipTier = null;
            document.querySelectorAll('.membership-option').forEach(opt => opt.classList.remove('selected'));
            document.getElementById('purchaseBtn').disabled = true;
        }

        function selectMembershipOption(tier, element) {
            selectedMembershipTier = tier;
            document.querySelectorAll('.membership-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            document.getElementById('purchaseBtn').disabled = false;
        }

        async function proceedToPurchase() {
            if (!selectedMembershipTier) {
                alert('Please select a membership option');
                return;
            }

            const btn = document.getElementById('purchaseBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Redirecting...';

            // Redirect to membership signup with the tier pre-selected and source flag
            const tierParam = selectedMembershipTier === 'team' ? 'league-team' : 'league-player';
            window.location.href = `membership-signup.html?tier=${tierParam}&type=league&source=createTeam`;
        }

        // Close modal on overlay click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeCreateTeamModal();
            }
        });

        // Close modal on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeCreateTeamModal();
            }
        });
    </script>

    <!-- Create Team Modal -->
    <div class="modal-overlay" id="createTeamModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-trophy"></i> Join the League</h2>
                <p>Purchase a league membership to create your team</p>
                <button class="modal-close" onclick="closeCreateTeamModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="membership-options">
                    <!-- League Player Option -->
                    <div class="membership-option" onclick="selectMembershipOption('player', this)">
                        <div class="check-icon"><i class="fas fa-check"></i></div>
                        <div class="option-header">
                            <div class="option-title">
                                <i class="fas fa-user" style="color: #059669;"></i>
                                League Player
                            </div>
                            <div class="option-price">$400</div>
                        </div>
                        <div class="option-desc">
                            Single player registration for the full season. Perfect if you have a teammate who will register separately.
                        </div>
                        <ul class="benefits-list">
                            <li><i class="fas fa-check"></i> Full season access</li>
                            <li><i class="fas fa-check"></i> 5% off all purchases</li>
                            <li><i class="fas fa-check"></i> League events & standings</li>
                        </ul>
                    </div>

                    <!-- League Team Option -->
                    <div class="membership-option" onclick="selectMembershipOption('team', this)">
                        <div class="check-icon"><i class="fas fa-check"></i></div>
                        <div class="option-header">
                            <div class="option-title">
                                <i class="fas fa-users" style="color: #059669;"></i>
                                League Team
                            </div>
                            <div class="option-price">$800</div>
                        </div>
                        <div class="option-desc">
                            Register both players at once! Includes 2 player spots and team registration for the full season.
                        </div>
                        <ul class="benefits-list">
                            <li><i class="fas fa-check"></i> Full season for 2 players</li>
                            <li><i class="fas fa-check"></i> 10% off all purchases</li>
                            <li><i class="fas fa-check"></i> Priority league scheduling</li>
                            <li><i class="fas fa-check"></i> Team standings & stats</li>
                        </ul>
                    </div>
                </div>

                <button class="modal-btn modal-btn-primary" id="purchaseBtn" onclick="proceedToPurchase()" disabled>
                    <i class="fas fa-credit-card"></i> Continue to Checkout
                </button>

                <div class="modal-footer-note">
                    <i class="fas fa-shield-alt"></i> Secure payment powered by Stripe
                </div>
            </div>
        </div>
    </div>
</body>
</html>



