<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Bay - Golf Cove</title>
    <meta name="description" content="Book a golf simulator bay at Golf Cove. Easy online reservations.">
    <link rel="icon" type="image/png" href="images/golfCoveLogo6.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #4a90a4;
            --success: #27ae60;
            --danger: #e74c3c;
            --text: #333;
            --text-light: #666;
            --bg: #f5f7f9;
            --card: #fff;
            --border: #e0e0e0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        /* Header */
        .header {
            background: var(--primary);
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #fff;
            font-size: 24px;
        }
        
        .header a {
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            font-size: 14px;
        }
        
        /* Progress Steps */
        .progress-bar {
            display: flex;
            justify-content: center;
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid var(--border);
        }
        
        .step {
            display: flex;
            align-items: center;
            color: var(--text-light);
        }
        
        .step.active {
            color: var(--primary);
        }
        
        .step.completed {
            color: var(--success);
        }
        
        .step-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .step.active .step-number {
            background: var(--primary);
            color: #fff;
        }
        
        .step.completed .step-number {
            background: var(--success);
            color: #fff;
        }
        
        .step-connector {
            width: 60px;
            height: 2px;
            background: var(--border);
            margin: 0 15px;
        }
        
        .step-connector.completed {
            background: var(--success);
        }
        
        /* Main Container */
        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Step Sections */
        .step-section {
            display: none;
            background: #fff;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .step-section.active {
            display: block;
        }
        
        .step-section h2 {
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        /* Date Picker */
        .date-selector {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .date-btn {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            min-width: 80px;
            transition: all 0.2s;
        }
        
        .date-btn:hover {
            border-color: var(--accent);
        }
        
        .date-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }
        
        .date-btn .day-name {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .date-btn .day-num {
            font-size: 20px;
            font-weight: 600;
        }
        
        /* Time Grid */
        .time-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .time-btn {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        
        .time-btn:hover:not(.unavailable) {
            border-color: var(--accent);
        }
        
        .time-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }
        
        .time-btn.unavailable {
            background: #f5f5f5;
            color: #999;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        /* Duration Selector */
        .duration-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .duration-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .duration-btn:hover {
            border-color: var(--accent);
        }
        
        .duration-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }
        
        .duration-btn .price {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Room Selector */
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }
        
        .room-btn {
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        
        .room-btn:hover:not(.unavailable) {
            border-color: var(--accent);
        }
        
        .room-btn.selected {
            border-color: var(--success);
            background: #e8f5e9;
        }
        
        .room-btn.unavailable {
            background: #ffebee;
            border-color: var(--danger);
            cursor: not-allowed;
        }
        
        .room-btn .room-name {
            font-weight: 600;
        }
        
        .room-btn .room-type {
            font-size: 12px;
            color: var(--text-light);
        }
        
        .room-btn .room-status {
            margin-top: 8px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
        }
        
        .room-btn.unavailable .room-status {
            background: var(--danger);
            color: #fff;
        }
        
        .room-btn:not(.unavailable) .room-status {
            background: var(--success);
            color: #fff;
        }
        
        /* Member Lookup */
        .member-lookup {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .member-lookup h3 {
            margin-bottom: 12px;
        }
        
        .lookup-row {
            display: flex;
            gap: 10px;
        }
        
        .lookup-row input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
        }
        
        .lookup-row button {
            padding: 12px 20px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }
        
        .member-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .member-result.found {
            display: block;
            background: #e8f5e9;
            border: 1px solid var(--success);
        }
        
        .member-result.not-found {
            display: block;
            background: #fff3e0;
            border: 1px solid #ff9800;
        }
        
        .member-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .member-badge.eagle { background: #ffd700; color: #333; }
        .member-badge.birdie { background: #27ae60; color: #fff; }
        .member-badge.par { background: #3498db; color: #fff; }
        
        /* Form Fields */
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 16px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        @media (max-width: 600px) {
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        /* Summary */
        .booking-summary {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        
        .summary-row:last-child {
            border-bottom: none;
            font-weight: 600;
            font-size: 18px;
        }
        
        .summary-row .discount {
            color: var(--success);
        }
        
        .original-price {
            text-decoration: line-through;
            color: #999;
            margin-right: 8px;
        }
        
        /* Buttons */
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        
        .btn-primary:hover {
            background: var(--primary-light);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #fff;
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        .btn-success {
            background: var(--success);
            color: #fff;
        }
        
        .button-row {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Messages */
        .error-message {
            background: #ffebee;
            color: var(--danger);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
        
        .success-message {
            background: #e8f5e9;
            color: var(--success);
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="index.html"><i class="fas fa-arrow-left"></i> Back to Home</a>
        <h1>Book a Simulator Bay</h1>
    </header>
    
    <!-- Progress Steps -->
    <div class="progress-bar">
        <div class="step active" id="step1-indicator">
            <div class="step-number">1</div>
            <span>Select Time</span>
        </div>
        <div class="step-connector" id="connector1"></div>
        <div class="step" id="step2-indicator">
            <div class="step-number">2</div>
            <span>Your Details</span>
        </div>
        <div class="step-connector" id="connector2"></div>
        <div class="step" id="step3-indicator">
            <div class="step-number">3</div>
            <span>Payment</span>
        </div>
    </div>
    
    <div class="container">
        <!-- Step 1: Select Date, Time, Room -->
        <div class="step-section active" id="step1">
            <h2><i class="fas fa-calendar-alt"></i> Select Date & Time</h2>
            
            <!-- Date Selection -->
            <h3 style="margin-bottom:12px;">Choose a Date</h3>
            <div class="date-selector" id="dateSelector"></div>
            
            <!-- Duration Selection -->
            <h3 style="margin-bottom:12px;">Select Duration</h3>
            <div class="duration-selector">
                <button class="duration-btn selected" data-duration="1" onclick="selectDuration(1)">
                    <div>1 Hour</div>
                    <div class="price">$45</div>
                </button>
                <button class="duration-btn" data-duration="2" onclick="selectDuration(2)">
                    <div>2 Hours</div>
                    <div class="price">$80</div>
                </button>
                <button class="duration-btn" data-duration="3" onclick="selectDuration(3)">
                    <div>3 Hours</div>
                    <div class="price">$110</div>
                </button>
                <button class="duration-btn" data-duration="4" onclick="selectDuration(4)">
                    <div>4 Hours</div>
                    <div class="price">$140</div>
                </button>
            </div>
            
            <!-- Time Selection -->
            <h3 style="margin-bottom:12px;">Choose a Start Time</h3>
            <div class="time-grid" id="timeGrid"></div>
            
            <!-- Room Selection -->
            <h3 style="margin-bottom:12px;">Select a Room</h3>
            <div class="room-grid" id="roomGrid"></div>
            
            <div class="button-row">
                <span></span>
                <button class="btn btn-primary" onclick="goToStep2()" id="continueBtn" disabled>
                    Continue <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
        
        <!-- Step 2: Customer Details & Member Lookup -->
        <div class="step-section" id="step2">
            <h2><i class="fas fa-user"></i> Your Details</h2>
            
            <!-- Member Lookup -->
            <div class="member-lookup">
                <h3><i class="fas fa-star" style="color:#f1c40f"></i> Are you a member?</h3>
                <p style="color:var(--text-light);margin-bottom:12px;">Enter your email or phone to apply your member discount</p>
                <div class="lookup-row">
                    <input type="text" id="memberSearch" placeholder="Email or phone number">
                    <button onclick="lookupMember()"><i class="fas fa-search"></i> Look Up</button>
                </div>
                <div class="member-result" id="memberResult"></div>
            </div>
            
            <!-- Customer Form -->
            <div class="form-row">
                <div class="form-group">
                    <label>Your Name *</label>
                    <input type="text" id="customerName" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="customerEmail" placeholder="you@email.com" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="customerPhone" placeholder="(555) 555-5555">
                </div>
                <div class="form-group">
                    <label>Number of Players</label>
                    <select id="playerCount">
                        <option value="1">1 Player</option>
                        <option value="2" selected>2 Players</option>
                        <option value="3">3 Players</option>
                        <option value="4">4 Players</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label>Special Requests (Optional)</label>
                <textarea id="notes" placeholder="Any special requests or notes..." rows="3"></textarea>
            </div>
            
            <!-- Booking Summary -->
            <div class="booking-summary" id="bookingSummary">
                <h3 style="margin-bottom:12px;">Booking Summary</h3>
                <div class="summary-row">
                    <span>Date</span>
                    <span id="summaryDate">-</span>
                </div>
                <div class="summary-row">
                    <span>Time</span>
                    <span id="summaryTime">-</span>
                </div>
                <div class="summary-row">
                    <span>Room</span>
                    <span id="summaryRoom">-</span>
                </div>
                <div class="summary-row" id="memberDiscountRow" style="display:none;">
                    <span>Member Discount</span>
                    <span class="discount" id="summaryDiscount">-</span>
                </div>
                <div class="summary-row">
                    <span>Total</span>
                    <span id="summaryTotal">-</span>
                </div>
            </div>
            
            <div class="button-row">
                <button class="btn btn-secondary" onclick="goToStep1()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn btn-success" onclick="proceedToPayment()" id="paymentBtn">
                    <i class="fas fa-lock"></i> Proceed to Payment
                </button>
            </div>
        </div>
        
        <!-- Step 3: Payment Processing -->
        <div class="step-section" id="step3">
            <div class="loading" id="paymentLoading">
                <div class="spinner"></div>
                <h3>Redirecting to Secure Payment...</h3>
                <p>You'll be redirected to Stripe to complete your payment.</p>
            </div>
            <div id="paymentError" style="display:none;">
                <div class="error-message" id="paymentErrorMessage"></div>
                <button class="btn btn-secondary" onclick="goToStep2()">
                    <i class="fas fa-arrow-left"></i> Go Back
                </button>
            </div>
        </div>
    </div>
    
    <!-- Scripts -->
    <script src="js/booking-unified.js"></script>
    <script src="js/stripe-checkout.js"></script>
    <script>
        // ============ CONFIGURATION ============
        const FIREBASE_URL = 'https://golfcove-default-rtdb.firebaseio.com';
        
        const ROOMS = [
            { id: 1, name: 'Room 1', type: 'Members Only' },
            { id: 2, name: 'Room 2', type: 'Members Only' },
            { id: 3, name: 'Room 3', type: 'Golf & Menu' },
            { id: 4, name: 'Room 4', type: 'Golf + Menu' },
            { id: 5, name: 'Room 5', type: 'Golf + Music' },
            { id: 6, name: 'Room 6', type: 'Members Only' }
        ];
        
        const PRICING = {
            1: 45,
            2: 80,
            3: 110,
            4: 140
        };
        
        const MEMBER_TIERS = {
            'par': { name: 'Par Member', discount: 0.10, unlimited: false },
            'birdie': { name: 'Birdie Member', discount: 1.0, unlimited: true },
            'eagle': { name: 'Eagle Member', discount: 1.0, unlimited: true },
            'family_par': { name: 'Family Par', discount: 0.10, unlimited: false },
            'family_birdie': { name: 'Family Birdie', discount: 1.0, unlimited: true },
            'family_eagle': { name: 'Family Eagle', discount: 1.0, unlimited: true },
            'corporate': { name: 'Corporate', discount: 1.0, unlimited: true }
        };
        
        const TIME_SLOTS = [];
        for (let h = 9; h <= 21; h++) {
            TIME_SLOTS.push({
                hour: h,
                label: h > 12 ? `${h-12}:00 PM` : (h === 12 ? '12:00 PM' : `${h}:00 AM`)
            });
        }
        
        // ============ STATE ============
        let selectedDate = new Date();
        let selectedTime = null;
        let selectedRoom = null;
        let selectedDuration = 1;
        let currentMember = null;
        let existingBookings = [];
        
        // ============ INITIALIZATION ============
        document.addEventListener('DOMContentLoaded', () => {
            renderDates();
            renderTimeSlots();
            loadBookingsAndRenderRooms();
            
            // Initialize Stripe checkout
            if (typeof GolfCoveCheckout !== 'undefined') {
                GolfCoveCheckout.init();
            }
        });
        
        // ============ DATE SELECTION ============
        function renderDates() {
            const container = document.getElementById('dateSelector');
            container.innerHTML = '';
            
            const today = new Date();
            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                
                const isSelected = date.toDateString() === selectedDate.toDateString();
                const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                
                container.innerHTML += `
                    <button class="date-btn ${isSelected ? 'selected' : ''}" 
                            onclick="selectDate('${date.toISOString()}')">
                        <div class="day-name">${dayNames[date.getDay()]}</div>
                        <div class="day-num">${date.getDate()}</div>
                    </button>
                `;
            }
        }
        
        function selectDate(dateStr) {
            selectedDate = new Date(dateStr);
            selectedTime = null;
            selectedRoom = null;
            renderDates();
            loadBookingsAndRenderRooms();
            updateContinueButton();
        }
        
        // ============ DURATION SELECTION ============
        function selectDuration(hours) {
            selectedDuration = hours;
            selectedRoom = null; // Reset room selection when duration changes
            
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.duration) === hours);
            });
            
            loadBookingsAndRenderRooms();
            updateContinueButton();
        }
        
        // ============ TIME SELECTION ============
        function renderTimeSlots() {
            const container = document.getElementById('timeGrid');
            container.innerHTML = TIME_SLOTS.map(slot => `
                <button class="time-btn" data-hour="${slot.hour}" onclick="selectTime(${slot.hour})">
                    ${slot.label}
                </button>
            `).join('');
        }
        
        function selectTime(hour) {
            selectedTime = hour;
            selectedRoom = null; // Reset room when time changes
            
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.toggle('selected', parseInt(btn.dataset.hour) === hour);
            });
            
            loadBookingsAndRenderRooms();
            updateContinueButton();
        }
        
        // ============ ROOM SELECTION ============
        async function loadBookingsAndRenderRooms() {
            const dateStr = selectedDate.toISOString().split('T')[0];
            
            try {
                const response = await fetch(`${FIREBASE_URL}/bookings.json`);
                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        existingBookings = Object.entries(data)
                            .map(([key, val]) => ({ ...val, _key: key }))
                            .filter(b => b.date === dateStr && b.status !== 'cancelled');
                    } else {
                        existingBookings = [];
                    }
                }
            } catch (e) {
                console.error('Failed to load bookings:', e);
                existingBookings = [];
            }
            
            renderRooms();
        }
        
        function renderRooms() {
            const container = document.getElementById('roomGrid');
            
            if (!selectedTime) {
                container.innerHTML = '<p style="color:var(--text-light);grid-column:1/-1;">Please select a time first</p>';
                return;
            }
            
            container.innerHTML = ROOMS.map(room => {
                const isAvailable = checkRoomAvailability(room.id, selectedTime, selectedDuration);
                const isSelected = selectedRoom === room.id;
                
                return `
                    <button class="room-btn ${isAvailable ? '' : 'unavailable'} ${isSelected ? 'selected' : ''}" 
                            onclick="${isAvailable ? `selectRoom(${room.id})` : ''}"
                            ${!isAvailable ? 'disabled' : ''}>
                        <div class="room-name">${room.name}</div>
                        <div class="room-type">${room.type}</div>
                        <div class="room-status">${isAvailable ? 'Available' : 'Booked'}</div>
                    </button>
                `;
            }).join('');
        }
        
        function checkRoomAvailability(roomId, startHour, duration) {
            // Check if any existing booking overlaps with requested time
            for (const booking of existingBookings) {
                if (booking.roomId !== roomId) continue;
                
                const bookingStart = parseInt(booking.time?.split(':')[0]) || 0;
                const bookingEnd = bookingStart + (booking.duration || 1);
                const requestEnd = startHour + duration;
                
                // Check for overlap
                if (startHour < bookingEnd && requestEnd > bookingStart) {
                    return false;
                }
            }
            return true;
        }
        
        function selectRoom(roomId) {
            selectedRoom = roomId;
            renderRooms();
            updateContinueButton();
        }
        
        function updateContinueButton() {
            const btn = document.getElementById('continueBtn');
            btn.disabled = !(selectedTime && selectedRoom);
        }
        
        // ============ NAVIGATION ============
        function goToStep1() {
            setActiveStep(1);
        }
        
        function goToStep2() {
            if (!selectedTime || !selectedRoom) {
                alert('Please select a time and room');
                return;
            }
            setActiveStep(2);
            updateSummary();
        }
        
        function setActiveStep(step) {
            // Hide all sections
            document.querySelectorAll('.step-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active', 'completed'));
            document.querySelectorAll('.step-connector').forEach(c => c.classList.remove('completed'));
            
            // Show current section
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update indicators
            for (let i = 1; i <= 3; i++) {
                const indicator = document.getElementById(`step${i}-indicator`);
                if (i < step) {
                    indicator.classList.add('completed');
                } else if (i === step) {
                    indicator.classList.add('active');
                }
            }
            
            // Update connectors
            if (step > 1) document.getElementById('connector1').classList.add('completed');
            if (step > 2) document.getElementById('connector2').classList.add('completed');
        }
        
        // ============ MEMBER LOOKUP ============
        async function lookupMember() {
            const searchValue = document.getElementById('memberSearch').value.trim();
            const resultDiv = document.getElementById('memberResult');
            
            if (!searchValue) {
                alert('Please enter an email or phone number');
                return;
            }
            
            resultDiv.className = 'member-result';
            resultDiv.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Looking up...';
            resultDiv.style.display = 'block';
            
            try {
                // Search customers in Firebase
                const response = await fetch(`${FIREBASE_URL}/customers.json`);
                let members = [];
                
                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        members = Object.entries(data)
                            .map(([key, val]) => ({ ...val, id: key }))
                            .filter(c => c.isMember && (
                                c.email?.toLowerCase() === searchValue.toLowerCase() ||
                                c.phone?.replace(/\D/g, '') === searchValue.replace(/\D/g, '')
                            ));
                    }
                }
                
                // Also check members collection
                if (members.length === 0) {
                    const membersResponse = await fetch(`${FIREBASE_URL}/members.json`);
                    if (membersResponse.ok) {
                        const membersData = await membersResponse.json();
                        if (membersData) {
                            members = Object.entries(membersData)
                                .map(([key, val]) => ({ ...val, id: key, isMember: true }))
                                .filter(m => 
                                    m.email?.toLowerCase() === searchValue.toLowerCase() ||
                                    m.phone?.replace(/\D/g, '') === searchValue.replace(/\D/g, '')
                                );
                        }
                    }
                }
                
                if (members.length > 0) {
                    const member = members[0];
                    currentMember = member;
                    
                    const tier = MEMBER_TIERS[member.memberType] || MEMBER_TIERS['par'];
                    const tierClass = member.memberType?.includes('eagle') ? 'eagle' : 
                                     member.memberType?.includes('birdie') ? 'birdie' : 'par';
                    
                    // Auto-fill form
                    if (member.firstName || member.lastName) {
                        document.getElementById('customerName').value = 
                            `${member.firstName || ''} ${member.lastName || ''}`.trim();
                    }
                    if (member.email) document.getElementById('customerEmail').value = member.email;
                    if (member.phone) document.getElementById('customerPhone').value = member.phone;
                    
                    resultDiv.className = 'member-result found';
                    resultDiv.innerHTML = `
                        <i class="fas fa-check-circle" style="color:var(--success)"></i>
                        <strong>${member.firstName || ''} ${member.lastName || ''}</strong>
                        <span class="member-badge ${tierClass}">${tier.name}</span>
                        <br><br>
                        ${tier.unlimited ? 
                            '<strong style="color:var(--success)">âœ¨ UNLIMITED PLAY - This booking is FREE!</strong>' : 
                            `<strong>${Math.round(tier.discount * 100)}% member discount applied</strong>`}
                    `;
                    
                    updateSummary();
                } else {
                    currentMember = null;
                    resultDiv.className = 'member-result not-found';
                    resultDiv.innerHTML = `
                        <i class="fas fa-info-circle" style="color:#ff9800"></i>
                        No member found with that email or phone.
                        <a href="membership-signup.html" style="color:var(--accent)">Become a member</a>
                    `;
                    updateSummary();
                }
            } catch (e) {
                console.error('Member lookup error:', e);
                resultDiv.className = 'member-result not-found';
                resultDiv.innerHTML = 'Error looking up member. Please try again.';
            }
        }
        
        // ============ SUMMARY ============
        function updateSummary() {
            const room = ROOMS.find(r => r.id === selectedRoom);
            const basePrice = PRICING[selectedDuration];
            
            // Format time
            const startTime = selectedTime > 12 ? `${selectedTime-12}:00 PM` : 
                             (selectedTime === 12 ? '12:00 PM' : `${selectedTime}:00 AM`);
            const endHour = selectedTime + selectedDuration;
            const endTime = endHour > 12 ? `${endHour-12}:00 PM` : 
                           (endHour === 12 ? '12:00 PM' : `${endHour}:00 AM`);
            
            document.getElementById('summaryDate').textContent = 
                selectedDate.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });
            document.getElementById('summaryTime').textContent = `${startTime} - ${endTime}`;
            document.getElementById('summaryRoom').textContent = room?.name || '-';
            
            // Calculate member discount
            let finalPrice = basePrice;
            const discountRow = document.getElementById('memberDiscountRow');
            
            if (currentMember && currentMember.memberType) {
                const tier = MEMBER_TIERS[currentMember.memberType];
                if (tier) {
                    if (tier.unlimited) {
                        discountRow.style.display = 'flex';
                        document.getElementById('summaryDiscount').textContent = '-$' + basePrice.toFixed(2) + ' (FREE)';
                        finalPrice = 0;
                    } else if (tier.discount > 0) {
                        const discount = basePrice * tier.discount;
                        discountRow.style.display = 'flex';
                        document.getElementById('summaryDiscount').textContent = '-$' + discount.toFixed(2);
                        finalPrice = basePrice - discount;
                    }
                }
            } else {
                discountRow.style.display = 'none';
            }
            
            // Show total
            if (finalPrice === 0) {
                document.getElementById('summaryTotal').innerHTML = 
                    `<span class="original-price">$${basePrice.toFixed(2)}</span> <strong style="color:var(--success)">FREE</strong>`;
            } else if (finalPrice < basePrice) {
                document.getElementById('summaryTotal').innerHTML = 
                    `<span class="original-price">$${basePrice.toFixed(2)}</span> $${finalPrice.toFixed(2)}`;
            } else {
                document.getElementById('summaryTotal').textContent = '$' + finalPrice.toFixed(2);
            }
        }
        
        // ============ PAYMENT ============
        async function proceedToPayment() {
            const customerName = document.getElementById('customerName').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            
            if (!customerName || !customerEmail) {
                alert('Please enter your name and email');
                return;
            }
            
            // Validate email
            if (!/\S+@\S+\.\S+/.test(customerEmail)) {
                alert('Please enter a valid email address');
                return;
            }
            
            setActiveStep(3);
            
            const room = ROOMS.find(r => r.id === selectedRoom);
            const basePrice = PRICING[selectedDuration];
            let finalPrice = basePrice;
            
            // Calculate member discount
            if (currentMember && currentMember.memberType) {
                const tier = MEMBER_TIERS[currentMember.memberType];
                if (tier?.unlimited) {
                    finalPrice = 0;
                } else if (tier?.discount > 0) {
                    finalPrice = basePrice - (basePrice * tier.discount);
                }
            }
            
            // Format time for booking
            const timeStr = selectedTime < 10 ? `0${selectedTime}:00` : `${selectedTime}:00`;
            
            // Build booking data
            const bookingData = {
                roomId: selectedRoom,
                date: selectedDate.toISOString().split('T')[0],
                time: timeStr,
                duration: selectedDuration,
                customerName: customerName,
                customerEmail: customerEmail,
                customerPhone: document.getElementById('customerPhone').value,
                guests: parseInt(document.getElementById('playerCount').value),
                notes: document.getElementById('notes').value,
                
                // Member info
                isMember: !!currentMember,
                memberId: currentMember?.id || null,
                memberType: currentMember?.memberType || null,
                
                // Pricing
                originalPrice: basePrice,
                totalPrice: finalPrice,
                memberDiscount: basePrice - finalPrice,
                
                // URLs
                successUrl: `${window.location.origin}/booking-confirmed.html`,
                cancelUrl: window.location.href
            };
            
            try {
                if (finalPrice === 0) {
                    // Free booking for unlimited members - save directly
                    await saveBookingToFirebase(bookingData);
                    window.location.href = `booking-confirmed.html?free=true&room=${room.name}`;
                } else {
                    // Paid booking - redirect to Stripe
                    if (typeof GolfCoveCheckout !== 'undefined') {
                        await GolfCoveCheckout.checkout('booking', bookingData);
                    } else {
                        // Fallback - save booking and show success
                        await saveBookingToFirebase(bookingData);
                        window.location.href = `booking-confirmed.html?room=${room.name}`;
                    }
                }
            } catch (error) {
                console.error('Payment error:', error);
                document.getElementById('paymentLoading').style.display = 'none';
                document.getElementById('paymentError').style.display = 'block';
                document.getElementById('paymentErrorMessage').textContent = 
                    'Payment failed: ' + (error.message || 'Unknown error. Please try again.');
            }
        }
        
        async function saveBookingToFirebase(bookingData) {
            const booking = {
                id: 'bk_' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
                ...bookingData,
                status: 'confirmed',
                source: 'online',
                createdAt: new Date().toISOString()
            };
            
            const response = await fetch(`${FIREBASE_URL}/bookings.json`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(booking)
            });
            
            if (!response.ok) {
                throw new Error('Failed to save booking');
            }
            
            // Track member usage if applicable
            if (currentMember?.id) {
                await trackMemberBooking(currentMember.id, booking);
            }
            
            return booking;
        }
        
        async function trackMemberBooking(memberId, booking) {
            try {
                const response = await fetch(`${FIREBASE_URL}/member_usage/${memberId}.json`);
                let usage = response.ok ? await response.json() || {} : {};
                
                if (!usage.bookings) usage.bookings = [];
                usage.bookings.push({
                    bookingId: booking.id,
                    date: booking.date,
                    duration: booking.duration,
                    savings: booking.memberDiscount || 0,
                    timestamp: new Date().toISOString()
                });
                
                usage.totalHours = (usage.totalHours || 0) + booking.duration;
                usage.totalSavings = (usage.totalSavings || 0) + (booking.memberDiscount || 0);
                
                await fetch(`${FIREBASE_URL}/member_usage/${memberId}.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(usage)
                });
            } catch (e) {
                console.warn('Failed to track member usage:', e);
            }
        }
    </script>
</body>
</html>
