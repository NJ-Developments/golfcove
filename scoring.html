<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Scoring - Golf Cove</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .scoring-header {
            background: #37b24a;
            color: #fff;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .scoring-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .scoring-header p {
            font-size: 13px;
            opacity: 0.9;
        }
        .player-selector {
            background: #fff;
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }
        .player-selector label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            font-weight: 600;
        }
        .player-selector select {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .player-selector select:focus {
            border-color: #37b24a;
            outline: none;
        }
        .hole-navigation {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px 20px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
        }
        .hole-dots {
            display: flex;
            gap: 6px;
            justify-content: center;
            padding: 10px 20px;
            background: #fff;
            flex-wrap: wrap;
        }
        .hole-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #e0e0e0;
            background: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: #999;
            cursor: pointer;
            transition: all 0.2s;
        }
        .hole-dot.completed {
            background: #37b24a;
            border-color: #37b24a;
            color: #fff;
        }
        .hole-dot.current {
            border-color: #37b24a;
            color: #37b24a;
            transform: scale(1.15);
        }
        .hole-dot.over-par {
            background: #ffebee;
            border-color: #f44336;
            color: #f44336;
        }
        .hole-dot.under-par {
            background: #e8f5e9;
            border-color: #37b24a;
            color: #37b24a;
        }
        .hole-nav-btn {
            width: 50px;
            height: 50px;
            border: none;
            background: #f0f0f0;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #333;
            transition: background 0.2s;
        }
        .hole-nav-btn:hover {
            background: #e0e0e0;
        }
        .hole-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        .hole-info {
            text-align: center;
        }
        .hole-number {
            font-size: 32px;
            font-weight: 700;
            color: #333;
        }
        .hole-par {
            font-size: 14px;
            color: #666;
        }
        .score-input-container {
            padding: 30px 20px;
            background: #fff;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .score-display {
            text-align: center;
            margin-bottom: 25px;
        }
        .score-value {
            font-size: 72px;
            font-weight: 700;
            color: #333;
            line-height: 1;
        }
        .score-label {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        .score-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .score-btn {
            width: 70px;
            height: 70px;
            border: none;
            border-radius: 50%;
            font-size: 32px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .score-btn:active {
            transform: scale(0.95);
        }
        .score-btn.minus {
            background: #ff6b6b;
            color: #fff;
        }
        .score-btn.plus {
            background: #37b24a;
            color: #fff;
        }
        .quick-scores {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            margin-top: 25px;
        }
        .quick-score-btn {
            padding: 15px;
            border: 2px solid #e0e0e0;
            background: #fff;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-score-btn:hover {
            border-color: #37b24a;
            background: #e8f5e9;
        }
        .quick-score-btn.active {
            border-color: #37b24a;
            background: #37b24a;
            color: #fff;
        }
        .score-status {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            font-weight: 600;
        }
        .score-status.eagle { color: #ffd700; }
        .score-status.birdie { color: #37b24a; }
        .score-status.par { color: #333; }
        .score-status.bogey { color: #ff9800; }
        .score-status.double { color: #f44336; }
        .scorecard-summary {
            margin: 15px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .scorecard-header {
            background: #333;
            color: #fff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .scorecard-header h3 {
            font-size: 16px;
            font-weight: 600;
        }
        .total-score {
            font-size: 24px;
            font-weight: 700;
        }
        .scorecard-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            text-align: center;
            font-size: 12px;
        }
        .scorecard-grid > div {
            padding: 10px 5px;
            border-bottom: 1px solid #e0e0e0;
            border-right: 1px solid #e0e0e0;
        }
        .scorecard-grid > div:nth-child(9n) {
            border-right: none;
        }
        .scorecard-grid .hole-num {
            background: #f5f5f5;
            font-weight: 600;
            color: #666;
        }
        .scorecard-grid .par-row {
            background: #f9f9f9;
            color: #888;
        }
        .scorecard-grid .score-cell {
            font-weight: 600;
            font-size: 14px;
        }
        .scorecard-grid .under-par {
            color: #37b24a;
        }
        .scorecard-grid .over-par {
            color: #f44336;
        }
        .submit-section {
            padding: 20px;
            margin: 15px;
            background: #fff;
            border-radius: 12px;
            text-align: center;
        }
        .submit-btn {
            width: 100%;
            padding: 18px;
            background: #37b24a;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .view-leaderboard {
            display: block;
            text-align: center;
            padding: 15px;
            color: #37b24a;
            text-decoration: none;
            font-weight: 600;
            margin-top: 10px;
        }
        .error-state {
            text-align: center;
            padding: 60px 20px;
        }
        .error-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }
        .error-state h2 {
            color: #333;
            margin-bottom: 10px;
        }
        .error-state p {
            color: #666;
        }
        .syncing {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
        }
        .syncing.show {
            display: block;
            animation: fadeIn 0.3s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateX(-50%) translateY(10px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Content loaded by JavaScript based on URL params -->
    </div>

    <div class="syncing" id="syncIndicator">
        <i class="fas fa-sync fa-spin"></i> Syncing...
    </div>

    <script>
        // Tournament Scoring App
        const app = {
            tournamentId: null,
            playerId: null,
            tournament: null,
            currentHole: 1,
            scores: {},

            init() {
                // Get tournament ID from URL
                const params = new URLSearchParams(window.location.search);
                this.tournamentId = params.get('t');
                this.playerId = params.get('p');

                if (!this.tournamentId) {
                    this.showError('No tournament specified', 'Please scan a valid QR code to access scoring.');
                    return;
                }

                this.loadTournament();
            },

            loadTournament() {
                const tournaments = JSON.parse(localStorage.getItem('golfcove_tournaments') || '[]');
                this.tournament = tournaments.find(t => t.id === this.tournamentId);

                if (!this.tournament) {
                    this.showError('Tournament not found', 'This tournament may have been deleted or the link is invalid.');
                    return;
                }

                // Load existing scores
                const allScores = JSON.parse(localStorage.getItem('golfcove_scores') || '{}');
                this.scores = allScores[this.tournamentId] || {};

                this.render();
            },

            showError(title, message) {
                document.getElementById('app').innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h2>${title}</h2>
                        <p>${message}</p>
                        <a href="tournaments.html" style="display: inline-block; margin-top: 20px; padding: 12px 24px; background: #37b24a; color: #fff; text-decoration: none; border-radius: 8px;">Go to Tournaments</a>
                    </div>
                `;
            },

            render() {
                const t = this.tournament;
                const course = this.getCourse();
                const holes = course ? course.holes : 18;

                document.getElementById('app').innerHTML = `
                    <div class="scoring-header">
                        <h1>${t.name}</h1>
                        <p>${course ? course.name : 'Unknown Course'} • ${new Date(t.date).toLocaleDateString()}</p>
                    </div>

                    <div class="player-selector">
                        <label>Select Player</label>
                        <select id="playerSelect" onchange="app.selectPlayer(this.value)">
                            <option value="">Choose your name...</option>
                            ${t.players.map(p => `
                                <option value="${p.id}" ${p.id === this.playerId ? 'selected' : ''}>${p.name} (HCP: ${p.handicap || 0})</option>
                            `).join('')}
                        </select>
                    </div>

                    <div id="scoringArea" style="display: ${this.playerId ? 'block' : 'none'}">
                        ${this.renderSeasonStandings()}
                        
                        <div class="hole-dots">
                            ${Array.from({length: holes}, (_, i) => i + 1).map(h => {
                                const score = this.getScore(h);
                                const par = this.getParForHole(h);
                                let dotClass = '';
                                if (h === this.currentHole) dotClass = 'current';
                                else if (score) {
                                    if (score < par) dotClass = 'completed under-par';
                                    else if (score > par) dotClass = 'completed over-par';
                                    else dotClass = 'completed';
                                }
                                return `<div class="hole-dot ${dotClass}" onclick="app.goToHole(${h})">${h}</div>`;
                            }).join('')}
                        </div>

                        <div class="hole-navigation">
                            <button class="hole-nav-btn" onclick="app.prevHole()" ${this.currentHole === 1 ? 'disabled' : ''}>
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="hole-info">
                                <div class="hole-number">Hole ${this.currentHole}</div>
                                <div class="hole-par">Par ${this.getParForHole(this.currentHole)}</div>
                            </div>
                            <button class="hole-nav-btn" onclick="app.nextHole()" ${this.currentHole === holes ? 'disabled' : ''}>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>

                        <div class="score-input-container" ${this.isSubmitted() ? 'style="opacity: 0.6; pointer-events: none;"' : ''}>
                            <div class="score-display">
                                <div class="score-value" id="currentScore">${this.getScore(this.currentHole) || '-'}</div>
                                <div class="score-label">Strokes</div>
                                <div class="score-status" id="scoreStatus">${this.getScoreStatus(this.currentHole)}</div>
                            </div>
                            <div class="score-buttons">
                                <button class="score-btn minus" onclick="app.adjustScore(-1)">−</button>
                                <button class="score-btn plus" onclick="app.adjustScore(1)">+</button>
                            </div>
                            <div class="quick-scores">
                                ${[1,2,3,4,5,6,7,8,9].map(n => `
                                    <button class="quick-score-btn ${this.getScore(this.currentHole) === n ? 'active' : ''}" onclick="app.setScore(${n})">${n}</button>
                                `).join('')}
                            </div>
                        </div>

                        ${this.renderScorecard()}

                        <div class="submit-section">
                            ${this.isSubmitted() ? `
                                <div style="background: #e8f5e9; color: #2e7d32; padding: 20px; border-radius: 8px; text-align: center;">
                                    <i class="fas fa-check-circle" style="font-size: 32px; margin-bottom: 10px;"></i>
                                    <div style="font-weight: 600;">Scores Submitted!</div>
                                    <div style="font-size: 14px; margin-top: 5px;">Your round has been recorded.</div>
                                </div>
                            ` : `
                                <button class="submit-btn" onclick="app.submitScores()" id="submitBtn">
                                    Submit Final Scores
                                </button>
                            `}
                            <a href="leaderboard.html?t=${this.tournamentId}" class="view-leaderboard">
                                <i class="fas fa-trophy"></i> View Live Leaderboard
                            </a>
                        </div>
                    </div>
                `;
            },

            getCourse() {
                const courses = JSON.parse(localStorage.getItem('golfcove_courses') || '[]');
                return courses.find(c => c.id === this.tournament.courseId);
            },

            getParForHole(hole) {
                const course = this.getCourse();
                if (course && course.pars && course.pars[hole - 1]) {
                    return course.pars[hole - 1];
                }
                return 4; // Default par
            },

            getScore(hole) {
                if (!this.playerId) return null;
                const playerScores = this.scores[this.playerId] || {};
                return playerScores[hole] || null;
            },

            setScore(score) {
                if (!this.playerId || this.isSubmitted()) return;
                
                if (!this.scores[this.playerId]) {
                    this.scores[this.playerId] = {};
                }
                this.scores[this.playerId][this.currentHole] = score;
                this.saveScores();
                this.render();
            },

            adjustScore(delta) {
                if (this.isSubmitted()) return;
                const current = this.getScore(this.currentHole) || this.getParForHole(this.currentHole);
                const newScore = Math.max(1, Math.min(15, current + delta));
                this.setScore(newScore);
            },

            saveScores() {
                const allScores = JSON.parse(localStorage.getItem('golfcove_scores') || '{}');
                allScores[this.tournamentId] = this.scores;
                localStorage.setItem('golfcove_scores', JSON.stringify(allScores));
                
                // Show sync indicator
                const sync = document.getElementById('syncIndicator');
                sync.classList.add('show');
                setTimeout(() => sync.classList.remove('show'), 1000);
            },

            getScoreStatus(hole) {
                const score = this.getScore(hole);
                if (!score) return '';
                const par = this.getParForHole(hole);
                const diff = score - par;
                
                if (diff <= -2) return '<span class="eagle">Eagle or better!</span>';
                if (diff === -1) return '<span class="birdie">Birdie!</span>';
                if (diff === 0) return '<span class="par">Par</span>';
                if (diff === 1) return '<span class="bogey">Bogey</span>';
                if (diff === 2) return '<span class="double">Double Bogey</span>';
                return '<span class="double">+' + diff + '</span>';
            },

            renderSeasonStandings() {
                // Check if this tournament is part of a league
                if (!this.tournament.leagueId) return '';
                
                const leagues = JSON.parse(localStorage.getItem('golfcove_leagues') || '[]');
                const league = leagues.find(l => l.id === this.tournament.leagueId);
                if (!league) return '';

                const tournaments = JSON.parse(localStorage.getItem('golfcove_tournaments') || '[]')
                    .filter(t => t.leagueId === league.id && t.id !== this.tournamentId);
                const allScores = JSON.parse(localStorage.getItem('golfcove_scores') || '{}');

                // Calculate standings
                const standings = league.players.map(player => {
                    let totalNet = 0;
                    let roundsPlayed = 0;

                    tournaments.forEach(t => {
                        const tournamentScores = allScores[t.id] || {};
                        const tPlayer = t.players.find(p => p.name === player.name);
                        if (!tPlayer) return;
                        
                        const ps = tournamentScores[tPlayer.id];
                        if (ps && ps.submitted) {
                            const gross = Object.keys(ps)
                                .filter(k => k !== 'submitted' && k !== 'submittedAt')
                                .reduce((sum, h) => sum + (ps[h] || 0), 0);
                            totalNet += gross - (tPlayer.handicap || 0);
                            roundsPlayed++;
                        }
                    });

                    return { name: player.name, totalNet, roundsPlayed };
                }).filter(p => p.roundsPlayed > 0)
                  .sort((a, b) => a.totalNet - b.totalNet)
                  .slice(0, 5);

                if (standings.length === 0) return '';

                return \`
                    <div style="background: linear-gradient(135deg, #37b24a, #2d9940); color: #fff; padding: 12px 15px; margin: 10px; border-radius: 8px;">
                        <div style="font-size: 12px; opacity: 0.9; margin-bottom: 8px;">\${league.name} Standings</div>
                        <div style="display: flex; gap: 15px; overflow-x: auto; font-size: 13px;">
                            \${standings.map((s, i) => \`
                                <div style="white-space: nowrap;">
                                    <strong>\${i + 1}.</strong> \${s.name} <span style="opacity: 0.8;">(\${s.totalNet})</span>
                                </div>
                            \`).join('')}
                        </div>
                    </div>
                \`;
            },

            isSubmitted() {
                if (!this.playerId) return false;
                const playerScores = this.scores[this.playerId] || {};
                return playerScores.submitted === true;
            },

            prevHole() {
                if (this.currentHole > 1) {
                    this.currentHole--;
                    this.render();
                }
            },

            nextHole() {
                const course = this.getCourse();
                const holes = course ? course.holes : 18;
                if (this.currentHole < holes) {
                    this.currentHole++;
                    this.render();
                }
            },

            goToHole(hole) {
                this.currentHole = hole;
                this.render();
            },

            selectPlayer(playerId) {
                this.playerId = playerId;
                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('p', playerId);
                window.history.pushState({}, '', url);
                this.render();
            },

            getTotalScore() {
                if (!this.playerId) return 0;
                const playerScores = this.scores[this.playerId] || {};
                return Object.values(playerScores).reduce((sum, s) => sum + (s || 0), 0);
            },

            getTotalPar() {
                const course = this.getCourse();
                if (!course || !course.pars) return 72;
                
                const playerScores = this.scores[this.playerId] || {};
                let totalPar = 0;
                Object.keys(playerScores).forEach(hole => {
                    totalPar += this.getParForHole(parseInt(hole));
                });
                return totalPar;
            },

            renderScorecard() {
                const course = this.getCourse();
                const holes = course ? course.holes : 18;
                const front9 = [];
                const back9 = [];

                for (let i = 1; i <= 9; i++) {
                    front9.push({
                        hole: i,
                        par: this.getParForHole(i),
                        score: this.getScore(i)
                    });
                }

                if (holes === 18) {
                    for (let i = 10; i <= 18; i++) {
                        back9.push({
                            hole: i,
                            par: this.getParForHole(i),
                            score: this.getScore(i)
                        });
                    }
                }

                const frontTotal = front9.reduce((sum, h) => sum + (h.score || 0), 0);
                const backTotal = back9.reduce((sum, h) => sum + (h.score || 0), 0);
                const total = frontTotal + backTotal;

                return `
                    <div class="scorecard-summary">
                        <div class="scorecard-header">
                            <h3>Scorecard</h3>
                            <div class="total-score">${total || '-'}</div>
                        </div>
                        <div class="scorecard-grid">
                            ${front9.map(h => `<div class="hole-num">${h.hole}</div>`).join('')}
                            ${front9.map(h => `<div class="par-row">${h.par}</div>`).join('')}
                            ${front9.map(h => `<div class="score-cell ${h.score && h.score < h.par ? 'under-par' : h.score && h.score > h.par ? 'over-par' : ''}">${h.score || '-'}</div>`).join('')}
                        </div>
                        ${holes === 18 ? `
                        <div class="scorecard-grid">
                            ${back9.map(h => `<div class="hole-num">${h.hole}</div>`).join('')}
                            ${back9.map(h => `<div class="par-row">${h.par}</div>`).join('')}
                            ${back9.map(h => `<div class="score-cell ${h.score && h.score < h.par ? 'under-par' : h.score && h.score > h.par ? 'over-par' : ''}">${h.score || '-'}</div>`).join('')}
                        </div>
                        ` : ''}
                    </div>
                `;
            },

            submitScores() {
                const course = this.getCourse();
                const holes = course ? course.holes : 18;
                const playerScores = this.scores[this.playerId] || {};
                const completed = Object.keys(playerScores).length;

                if (completed < holes) {
                    if (!confirm(`You've only entered scores for ${completed} of ${holes} holes. Submit anyway?`)) {
                        return;
                    }
                }

                // Mark as submitted
                const allScores = JSON.parse(localStorage.getItem('golfcove_scores') || '{}');
                if (!allScores[this.tournamentId]) {
                    allScores[this.tournamentId] = {};
                }
                allScores[this.tournamentId][this.playerId] = {
                    ...playerScores,
                    submitted: true,
                    submittedAt: new Date().toISOString()
                };
                localStorage.setItem('golfcove_scores', JSON.stringify(allScores));

                alert('Scores submitted successfully!');
                window.location.href = `leaderboard.html?t=${this.tournamentId}`;
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>
