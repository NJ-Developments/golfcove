<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Cove - POS System</title>
    <link rel="icon" type="image/png" href="images/golfCoveLogo6.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://js.stripe.com/terminal/v1/"></script>
    <!-- Unified config and services - LOAD FIRST -->
    <script src="js/config-unified.js"></script>
    <script src="js/core.js"></script>
    <script src="js/services-unified.js"></script>
    <script src="js/menu-data.js"></script>
    <!-- Payment System (load before payment-processor) -->
    <script src="js/stripe-terminal.js"></script>
    <script src="js/stripe-checkout.js"></script>
    <script src="js/payment-service.js"></script>
    <!-- Legacy modules (will use unified config) -->
    <script src="js/firebase-sync.js"></script>
    <script src="js/pin-system.js"></script>
    <script src="js/membership-system.js"></script>
    <script src="js/validation-schemas.js"></script>
    <script src="js/customer-manager.js"></script>
    <script src="js/customers.js"></script>
    <script src="js/booking-system.js"></script>
    <script src="js/tabs-sync.js"></script>
    <script src="js/tabs-manager.js"></script>
    <script src="js/teesheet-manager.js"></script>
    <script src="js/payment-processor.js"></script>
    <script src="js/cash-drawer.js"></script>
    <script>
        // ============ TAX HELPERS - Use Unified Config ============
        // These helpers ensure tax rate comes from a single source
        function getTaxRate() {
            return window.GolfCoveConfig?.pricing?.taxRate ?? 0.0635;
        }
        function getTaxRatePercent() {
            return (getTaxRate() * 100).toFixed(2).replace(/\.?0+$/, '');
        }
        function getTaxLabel() {
            return `Tax (${getTaxRatePercent()}%)`;
        }
        function calculateTax(amount) {
            return amount * getTaxRate();
        }
        function formatCurrency(amount) {
            return '$' + (amount || 0).toFixed(2);
        }
        // Update tax labels on page load
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('[data-tax-label]').forEach(el => {
                el.textContent = getTaxLabel();
            });
        });
    </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; padding-bottom: 28px; }
        
        /* Header - foreUP style */
        .header { background: #4a90a4; color: #fff; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-logo { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 18px; }
        .header-logo img { height: 35px; }
        .header-nav { display: flex; gap: 5px; }
        .header-nav a { color: #fff; text-decoration: none; padding: 8px 16px; border-radius: 4px; font-size: 14px; transition: background 0.2s; }
        .header-nav a:hover, .header-nav a.active { background: rgba(255,255,255,0.2); }
        .header-stats { display: flex; gap: 25px; font-size: 13px; }
        .header-stat { text-align: center; }
        .header-stat .value { font-size: 18px; font-weight: 700; }
        .header-stat .label { opacity: 0.8; font-size: 11px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .header-user { display: flex; align-items: center; gap: 8px; }

        /* Status Bar - Fixed at bottom */
        .status-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 28px; background: #2c3e50; color: #fff; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; font-size: 11px; z-index: 9000; }
        .status-left, .status-right { display: flex; align-items: center; gap: 15px; }
        .status-item { display: flex; align-items: center; gap: 5px; opacity: 0.9; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #95a5a6; }
        .status-dot.green { background: #27ae60; }
        .status-dot.yellow { background: #f39c12; }
        .status-dot.red { background: #e74c3c; }

        /* Sub-header */
        .sub-header { background: #fff; border-bottom: 1px solid #ddd; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; }
        .sub-header-left { display: flex; align-items: center; gap: 15px; }
        .date-nav { display: flex; align-items: center; gap: 10px; }
        .date-nav button { background: #4a90a4; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .date-nav button:hover { background: #3d7a8a; }
        .date-display { font-size: 18px; font-weight: 600; }
        .weather { display: flex; align-items: center; gap: 8px; color: #666; }
        .sub-header-right { display: flex; gap: 10px; }
        .sub-header-right button { background: #fff; border: 1px solid #ddd; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .sub-header-right button:hover { background: #f5f5f5; }

        /* Main Layout */
        .main-layout { display: flex; height: calc(100vh - 110px); }
        
        /* Sidebar */
        .sidebar { width: 220px; background: #fff; border-right: 1px solid #ddd; padding: 15px; overflow-y: auto; }
        .sidebar-section { margin-bottom: 20px; }
        .sidebar-title { font-size: 12px; color: #666; text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
        .search-box { position: relative; margin-bottom: 15px; }
        .search-box input { width: 100%; padding: 10px 10px 10px 35px; border: 1px solid #ddd; border-radius: 6px; font-size: 13px; }
        .search-box i { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #999; }
        .sidebar-btn { display: flex; align-items: center; gap: 10px; width: 100%; padding: 10px 12px; background: #f8f9fa; border: none; border-radius: 6px; cursor: pointer; font-size: 13px; margin-bottom: 5px; color: #333; transition: all 0.2s; }
        .sidebar-btn:hover { background: #e9ecef; }
        .sidebar-btn.active { background: #4a90a4; color: #fff; }
        .sidebar-btn i { width: 18px; }
        
        /* Calendar */
        .mini-calendar { background: #f8f9fa; border-radius: 8px; padding: 10px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: 600; font-size: 13px; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; text-align: center; font-size: 11px; }
        .calendar-day { padding: 5px; border-radius: 4px; cursor: pointer; }
        .calendar-day:hover { background: #e9ecef; }
        .calendar-day.today { background: #4a90a4; color: #fff; }
        .calendar-day.header { font-weight: 600; color: #666; }

        /* Tee Sheet Content */
        .content { flex: 1; overflow: auto; padding: 20px; background: #f0f2f5; }
        
        /* Room/Bay Columns */
        .rooms-container { display: flex; gap: 15px; min-width: max-content; }
        .room-column { background: #fff; border-radius: 8px; width: 280px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .room-header { background: #2c3e50; color: #fff; padding: 12px 15px; border-radius: 8px 8px 0 0; display: flex; align-items: center; gap: 10px; }
        .room-header .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #27ae60; }
        .room-header h3 { font-size: 15px; font-weight: 600; }
        .room-slots { padding: 10px; }
        
        /* Time Slots */
        .time-slot { display: flex; align-items: stretch; margin-bottom: 2px; min-height: 45px; }
        .time-label { width: 70px; padding: 8px 10px; font-size: 12px; color: #666; display: flex; align-items: center; }
        .slot-content { flex: 1; background: #f8f9fa; border-radius: 6px; margin: 2px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .slot-content:hover { border-color: #4a90a4; }
        .slot-content.booked { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); color: #fff; justify-content: flex-start; padding: 8px 12px; }
        .slot-content.booked.checked-in { background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); }
        .slot-content.booked .booking-info { display: flex; flex-direction: column; }
        .slot-content.booked .customer-name { font-weight: 600; font-size: 13px; }
        .slot-content.booked .booking-details { font-size: 11px; opacity: 0.9; }
        .slot-content.available { background: #e8f5e9; border: 1px dashed #81c784; }
        .slot-content .player-count { background: rgba(255,255,255,0.3); padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: auto; }

        /* Food & Beverage Floor Plan */
        .fnb-container { padding: 20px; }
        .fnb-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .fnb-tab { padding: 10px 20px; background: #fff; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .fnb-tab.active { background: #4a90a4; color: #fff; border-color: #4a90a4; }
        .floor-plan { background: #fff; border-radius: 8px; padding: 30px; min-height: 500px; position: relative; }
        .table-item { position: absolute; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .table-item:hover { transform: scale(1.05); }
        .table-item.circle { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #666; background: #fff; }
        .table-item.rectangle { width: 80px; height: 50px; border-radius: 8px; border: 2px solid #666; background: #fff; }
        .table-item.diamond { width: 60px; height: 60px; border: 2px solid #666; background: #fff; transform: rotate(45deg); }
        .table-item.diamond span { transform: rotate(-45deg); }
        .table-item.active { background: #3498db; border-color: #3498db; color: #fff; }
        .table-item span { font-size: 12px; font-weight: 600; }

        /* Tabs List */
        .tabs-list { background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .tabs-list h3 { margin-bottom: 15px; font-size: 16px; display: flex; align-items: center; gap: 10px; }
        .tabs-table { width: 100%; border-collapse: collapse; }
        .tabs-table th, .tabs-table td { padding: 10px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        .tabs-table th { font-weight: 600; color: #666; }
        .tab-row { cursor: pointer; }
        .tab-row:hover { background: #f8f9fa; }

        /* Sales Panel */
        .sales-panel { width: 400px; background: #fff; border-left: 1px solid #ddd; display: flex; flex-direction: column; }
        .sales-header { padding: 15px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        .sales-header h3 { font-size: 16px; }
        .sales-total { font-size: 24px; font-weight: 700; color: #27ae60; }
        
        /* Category Buttons */
        .category-buttons { padding: 10px; border-bottom: 1px solid #ddd; display: flex; flex-wrap: wrap; gap: 5px; }
        .cat-btn { padding: 8px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; font-weight: 500; }
        .cat-btn.beverage { background: #e3f2fd; color: #1976d2; }
        .cat-btn.food { background: #fff3e0; color: #f57c00; }
        .cat-btn.merch { background: #f3e5f5; color: #7b1fa2; }
        .cat-btn.beer { background: #fff8e1; color: #ff8f00; }
        .cat-btn.wine { background: #fce4ec; color: #c2185b; }
        .cat-btn.cocktails { background: #e8f5e9; color: #388e3c; }
        .cat-btn.rental { background: #e0f2f1; color: #00796b; }
        .cat-btn.active { filter: brightness(0.9); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Mini Items Grid */
        .pos-items-mini { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 6px; 
            padding: 10px; 
            max-height: 180px; 
            overflow-y: auto; 
            border-bottom: 1px solid #eee;
        }
        .pos-items-mini .pos-item { 
            padding: 8px 5px; 
            font-size: 11px; 
            border-radius: 6px;
            background: #f8f9fa;
            border: 1px solid #eee;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .pos-items-mini .pos-item:hover { background: #e9ecef; border-color: #4a90a4; }
        .pos-items-mini .pos-item i { font-size: 16px; display: block; margin-bottom: 3px; }
        .pos-items-mini .item-name { font-size: 10px; line-height: 1.2; margin-bottom: 2px; }
        .pos-items-mini .item-price { font-size: 10px; font-weight: 600; color: #27ae60; }

        /* Cart Items */
        .cart-items { flex: 1; overflow-y: auto; padding: 15px; max-height: 200px; }
        .cart-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px; }
        .cart-item-info { flex: 1; }
        .cart-item-name { font-weight: 500; font-size: 14px; }
        .cart-item-price { color: #666; font-size: 13px; }
        .cart-item-total { font-weight: 600; font-size: 14px; min-width: 60px; text-align: right; }
        .cart-item-remove { background: none; border: none; color: #e74c3c; cursor: pointer; padding: 5px; }
        .cart-empty { text-align: center; color: #999; padding: 40px; }
        
        /* Quantity Controls */
        .qty-controls { display: flex; align-items: center; gap: 5px; }
        .qty-btn { width: 24px; height: 24px; border-radius: 4px; border: 1px solid #ddd; background: #f8f9fa; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .qty-btn:hover { background: #e9ecef; }
        .qty-value { width: 25px; text-align: center; font-weight: 600; }

        /* Cart Footer */
        .cart-footer { padding: 15px; border-top: 1px solid #ddd; }
        .cart-totals { margin-bottom: 15px; }
        .cart-row { display: flex; justify-content: space-between; padding: 5px 0; font-size: 14px; }
        .cart-row.total { font-size: 18px; font-weight: 700; border-top: 2px solid #ddd; padding-top: 10px; margin-top: 10px; }
        .payment-buttons { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .pay-btn { padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px; }
        .pay-btn.pay-now { background: #27ae60; color: #fff; }
        .pay-btn.credit { background: #3498db; color: #fff; }
        .pay-btn.cash { background: #f39c12; color: #fff; }
        .pay-btn:hover { filter: brightness(0.9); }

        /* Recent Transactions */
        .recent-trans { padding: 15px; border-top: 1px solid #ddd; max-height: 200px; overflow-y: auto; }
        .recent-trans h4 { font-size: 13px; color: #666; margin-bottom: 10px; }
        .trans-item { display: flex; justify-content: space-between; padding: 8px; background: #f8f9fa; border-radius: 4px; margin-bottom: 5px; font-size: 12px; }
        .trans-time { color: #666; }
        .trans-amount { font-weight: 600; }

        /* Suspended Sales */
        .suspended-sales { padding: 15px; border-top: 1px solid #ddd; }
        .suspended-sales h4 { font-size: 13px; color: #666; margin-bottom: 10px; }
        .suspended-item { background: #e74c3c; color: #fff; padding: 10px; border-radius: 6px; margin-bottom: 5px; cursor: pointer; display: flex; justify-content: space-between; }
        .suspended-item:hover { filter: brightness(0.9); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; }
        .modal { background: #fff; border-radius: 12px; padding: 25px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
        .modal h3 { margin-bottom: 20px; font-size: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 13px; color: #666; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .modal-buttons button { flex: 1; padding: 12px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        .btn-cancel { background: #f8f9fa; border: 1px solid #ddd; color: #666; }
        .btn-save { background: #4a90a4; border: none; color: #fff; }
        
        /* POS Items Grid */
        .pos-items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .pos-item { background: #fff; border-radius: 10px; padding: 20px 15px; text-align: center; cursor: pointer; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: 2px solid transparent; }
        .pos-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-color: #4a90a4; }
        .pos-item:active { transform: translateY(0); }
        .pos-item i { font-size: 28px; margin-bottom: 10px; display: block; }
        .pos-item .item-name { font-weight: 600; font-size: 14px; margin-bottom: 5px; }
        .pos-item .item-price { color: #27ae60; font-weight: 700; font-size: 16px; }
        .pos-item.rental { background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); }
        .pos-item.rental i { color: #388e3c; }
        .pos-item.food { background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); }
        .pos-item.food i { color: #f57c00; }
        .pos-item.beer { background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%); }
        .pos-item.beer i { color: #ff8f00; }
        .pos-item.wine { background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%); }
        .pos-item.wine i { color: #c2185b; }
        .pos-item.cocktails { background: linear-gradient(135deg, #e0f7fa 0%, #b2ebf2 100%); }
        .pos-item.cocktails i { color: #00838f; }
        .pos-item.beverage { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); }
        .pos-item.beverage i { color: #1976d2; }
        .pos-item.merch { background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%); }
        .pos-item.merch i { color: #7b1fa2; }
        
        /* Notification Toast */
        .toast { position: fixed; bottom: 30px; right: 30px; background: #2c3e50; color: #fff; padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 2000; transform: translateY(100px); opacity: 0; transition: all 0.3s; }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        
        /* Delete Booking Button */
        .delete-booking-btn { background: #e74c3c; color: #fff; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px; }
        .delete-booking-btn:hover { background: #c0392b; }
        
        /* Booking Detail Modal */
        .booking-detail { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .booking-detail-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; }
        .booking-detail-row:last-child { border-bottom: none; }
        .booking-detail-label { color: #666; font-size: 13px; }
        .booking-detail-value { font-weight: 600; font-size: 14px; }
        
        /* Current Time Display */
        .current-time { font-size: 14px; font-weight: 600; color: #fff; opacity: 0.9; }
        
        /* Print Styles */
        @media print {
            .sidebar, .sales-panel, .sub-header-right, .header-nav { display: none !important; }
            .main-layout { display: block; height: auto; }
            .content { padding: 0; }
            .header { background: #333 !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
            .room-column { break-inside: avoid; page-break-inside: avoid; margin-bottom: 20px; }
            .rooms-container { flex-wrap: wrap; }
        }
        
        /* Responsive Adjustments */
        @media (max-width: 1200px) {
            .header-stats { display: none; }
            .sidebar { width: 180px; }
            .sales-panel { width: 350px; }
        }
        @media (max-width: 900px) {
            .sidebar { display: none; }
            .sales-panel { width: 300px; }
        }
        
        /* Floor Plan Labels */
        .floor-label { position: absolute; font-size: 11px; color: #999; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Pulse Animation for Available Slots */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .slot-content.available:hover { animation: pulse 1s infinite; }
        
        /* Drag-and-drop prep styles */
        .slot-content.drag-over { background: #d4edda !important; border: 2px dashed #27ae60 !important; }
        .slot-content.booked { cursor: grab; }
        .slot-content.booked:active { cursor: grabbing; }
        
        /* Room status colors */
        .room-header .status-dot.available { background: #27ae60; }
        .room-header .status-dot.occupied { background: #e74c3c; }
        .room-header .status-dot.partial { background: #f39c12; }
        
        /* Better Table Active State */
        .table-item.has-tab { background: #e74c3c !important; border-color: #c0392b !important; color: #fff !important; }
        .table-item.has-tab.diamond { background: #e74c3c !important; }
        
        /* PIN Shake Animation */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }
        
        /* PIN Button Hover */
        .pin-btn:hover { background: #e9ecef !important; }
        .pin-btn:active { transform: scale(0.95); }
        
        /* Quick Search Overlay - Hidden by default */
        .quick-search-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            align-items: flex-start;
            justify-content: center;
            padding-top: 100px;
        }
        .quick-search-overlay.active { display: flex; }
        .quick-search-box {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 500px;
            max-width: 90%;
            overflow: hidden;
        }
        .quick-search-input {
            width: 100%;
            padding: 18px 20px;
            border: none;
            font-size: 16px;
            outline: none;
            border-bottom: 1px solid #eee;
        }
        .quick-search-results {
            max-height: 350px;
            overflow-y: auto;
        }
        .quick-search-results .search-result {
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        .quick-search-results .search-result:hover { background: #f5f7fa; }
        .quick-search-results .search-result i { color: #4a90a4; width: 20px; text-align: center; }
        .quick-search-results .search-result .result-text { flex: 1; }
        .quick-search-results .search-result .result-label { font-size: 11px; color: #999; margin-left: auto; }
        
        /* Keyboard Shortcuts Panel - Hidden by default */
        .shortcut-hint {
            display: none;
            position: fixed;
            bottom: 40px;
            right: 20px;
            background: #2c3e50;
            color: #fff;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 9998;
            font-size: 13px;
            min-width: 200px;
        }
        .shortcut-hint.visible { display: block; }
        .shortcut-hint h4 { margin: 0 0 10px; font-size: 14px; display: flex; align-items: center; gap: 8px; }
        .shortcut-hint .shortcut { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .shortcut-hint .shortcut:last-child { border-bottom: none; }
        .shortcut-hint .key { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-family: monospace; font-size: 11px; }
    </style>
</head>
<body>
    <!-- Quick Search Overlay (Ctrl+K) -->
    <div class="quick-search-overlay" id="quickSearchOverlay" onclick="closeQuickSearch()">
        <div class="quick-search-box" onclick="event.stopPropagation()">
            <input type="text" class="quick-search-input" id="quickSearchInput" placeholder="Search customers, bookings, items..." oninput="handleQuickSearch(this.value)" onkeydown="handleQuickSearchKey(event)">
            <div class="quick-search-results" id="quickSearchResults">
                <div style="padding:20px;text-align:center;color:#999;">Type to search...</div>
            </div>
        </div>
    </div>
    
    <!-- Keyboard Shortcuts Panel -->
    <div class="shortcut-hint" id="shortcutHint">
        <h4><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h4>
        <div class="shortcut"><span class="key">Ctrl+K</span><span>Quick Search</span></div>
        <div class="shortcut"><span class="key">Esc</span><span>Close Modal</span></div>
        <div class="shortcut"><span class="key">?</span><span>Toggle This Help</span></div>
    </div>

    <!-- PIN Lock Screen -->
    <div id="lockScreen" style="position:fixed;top:0;left:0;right:0;bottom:0;background:linear-gradient(135deg, #2c3e50 0%, #4a90a4 100%);display:flex;align-items:center;justify-content:center;z-index:99999;">
        <div style="background:#fff;border-radius:16px;padding:40px;text-align:center;box-shadow:0 20px 60px rgba(0,0,0,0.3);max-width:400px;width:90%;">
            <img src="images/golfCoveLogo6.png" alt="Golf Cove" style="height:60px;margin-bottom:20px;">
            <h2 style="margin:0 0 5px;color:#2c3e50;">Golf Cove POS</h2>
            <p style="color:#666;margin:0 0 25px;font-size:14px;">Enter your PIN to unlock</p>
            
            <div id="pinDisplay" style="display:flex;justify-content:center;gap:10px;margin-bottom:20px;">
                <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid #4a90a4;background:#fff;"></div>
                <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid #4a90a4;background:#fff;"></div>
                <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid #4a90a4;background:#fff;"></div>
                <div class="pin-dot" style="width:16px;height:16px;border-radius:50%;border:2px solid #4a90a4;background:#fff;"></div>
            </div>
            
            <div id="pinError" style="color:#e74c3c;font-size:13px;margin-bottom:15px;display:none;">Incorrect PIN. Try again.</div>
            
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;max-width:240px;margin:0 auto;">
                <button onclick="enterPin(1)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">1</button>
                <button onclick="enterPin(2)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">2</button>
                <button onclick="enterPin(3)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">3</button>
                <button onclick="enterPin(4)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">4</button>
                <button onclick="enterPin(5)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">5</button>
                <button onclick="enterPin(6)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">6</button>
                <button onclick="enterPin(7)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">7</button>
                <button onclick="enterPin(8)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">8</button>
                <button onclick="enterPin(9)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">9</button>
                <button onclick="clearPin()" class="pin-btn" style="padding:20px;font-size:16px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#fff3e0;cursor:pointer;color:#f57c00;"><i class="fas fa-backspace"></i></button>
                <button onclick="enterPin(0)" class="pin-btn" style="padding:20px;font-size:24px;font-weight:600;border:1px solid #ddd;border-radius:10px;background:#f8f9fa;cursor:pointer;">0</button>
                <button onclick="submitPin()" class="pin-btn" style="padding:20px;font-size:16px;font-weight:600;border:1px solid #27ae60;border-radius:10px;background:#27ae60;color:#fff;cursor:pointer;"><i class="fas fa-check"></i></button>
            </div>
            
            <p style="color:#999;font-size:11px;margin-top:20px;">Contact manager if you forgot your PIN</p>
        </div>
    </div>
    
    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-left">
            <div class="status-item"><span class="status-dot" id="statusDotSync"></span><span id="statusSyncText">Synced</span></div>
            <div class="status-item"><span class="status-dot" id="statusDotReader"></span><span id="statusReaderText">Reader</span></div>
            <div class="status-item"><i class="fas fa-receipt"></i> <span id="statusTabsCount">0</span> open tabs</div>
            <div class="status-item"><i class="fas fa-calendar"></i> <span id="statusBookingsCount">0</span> bookings today</div>
        </div>
        <div class="status-right">
            <div class="status-item"><i class="fas fa-keyboard"></i> Press <strong>?</strong> for shortcuts</div>
            <div class="status-item" id="statusClock">--:-- --</div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="header-logo" style="text-decoration:none; color:#fff;">
                <img src="images/golfCoveLogo6.png" alt="Golf Cove">
                <span>Golf Cove</span>
            </a>
            <nav class="header-nav">
                <a href="#" class="active" onclick="showPage('teesheet', this); return false;"><i class="fas fa-calendar-alt"></i> Tee Sheet</a>
                <a href="sales.html"><i class="fas fa-cash-register"></i> Sales</a>
                <a href="customers.html"><i class="fas fa-users"></i> Customers</a>
            </nav>
        </div>
        <div class="header-stats">
            <div class="header-stat"><div class="value" id="statBookings">12</div><div class="label">Bookings</div></div>
            <div class="header-stat"><div class="value" id="statOccupancy">45%</div><div class="label">Occupancy</div></div>
            <div class="header-stat"><div class="value" id="statNoShows">0</div><div class="label">No Shows</div></div>
            <div class="header-stat"><div class="value" id="statCheckedIn">4</div><div class="label">Checked-In</div></div>
            <div class="header-stat"><div class="value" id="statRevenue">$485.00</div><div class="label">Revenue</div></div>
        </div>
        <div class="header-right">
            <button onclick="showCloudSync()" id="cloudSyncBtn" style="background:none;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:5px;" title="Cloud Sync"><i class="fas fa-cloud"></i> <span id="syncStatusText">Sync</span></button>
            <button onclick="lockPOS()" style="background:none;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:5px;" title="Lock POS"><i class="fas fa-lock"></i></button>
            <button onclick="showReaderSetup()" id="readerStatusBtn" style="background:none;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:5px;" title="Card Reader"><i class="fas fa-credit-card"></i> <span id="readerStatusText">Reader</span></button>
            <button onclick="showSettings()" style="background:none;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:5px;" title="Settings"><i class="fas fa-cog"></i></button>
            <button onclick="showMigrationWizard()" style="background:none;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;margin-right:10px;" title="Setup & Migration"><i class="fas fa-magic"></i> Setup</button>
            <div class="current-time" id="currentTime">--:-- --</div>
            <div class="header-user" id="currentUserDisplay">
                <i class="fas fa-user-circle" style="font-size: 24px;"></i>
                <span id="currentUserName">EJ Sattelberger</span>
            </div>
        </div>
    </header>

    <!-- Sub-header -->
    <div class="sub-header">
        <div class="sub-header-left">
            <div class="date-nav">
                <button onclick="changeDate(-1)"><i class="fas fa-chevron-left"></i></button>
                <button class="today-btn" onclick="goToToday()">Today</button>
                <button onclick="changeDate(1)"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="date-display" id="currentDateDisplay">Mon, Dec 8</div>
            <div class="weather">
                <i class="fas fa-cloud-sun"></i>
                <span>23¬∞F</span>
            </div>
        </div>
        <div class="sub-header-right">
            <button onclick="showModal('booking')"><i class="fas fa-plus"></i> New Booking</button>
            <button onclick="window.print()"><i class="fas fa-print"></i> Print</button>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" placeholder="Search customers..." id="customerSearch">
            </div>

            <div class="sidebar-section">
                <button class="sidebar-btn" onclick="showModal('booking')"><i class="fas fa-plus"></i> New Booking</button>
                <button class="sidebar-btn" onclick="showModal('newTab')"><i class="fas fa-receipt"></i> New Tab</button>
            </div>
            
            <div class="sidebar-section">
                <div class="sidebar-title">Today's Summary</div>
                <div style="background:#f8f9fa;border-radius:8px;padding:12px;font-size:12px;">
                    <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Sales:</span><strong id="summaryTodaySales">$0.00</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Transactions:</span><strong id="summaryTodayTrans">0</strong></div>
                    <div style="display:flex;justify-content:space-between;padding:4px 0;"><span>Open Tabs:</span><strong id="summaryOpenTabs">0</strong></div>
                </div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Notes</div>
                <textarea style="width:100%; height:60px; border:1px solid #ddd; border-radius:6px; padding:8px; font-size:12px; resize:none;" placeholder="Daily notes..." id="dailyNotes" onblur="saveDailyNotes()"></textarea>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">December 2025</div>
                <div class="mini-calendar">
                    <div class="calendar-header">
                        <button onclick="changeMonth(-1)" style="background:none;border:none;cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
                        <span id="calendarMonth">December 2025</span>
                        <button onclick="changeMonth(1)" style="background:none;border:none;cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid"></div>
                </div>
            </div>
        </aside>

        <!-- Content Area -->
        <main class="content" id="mainContent">
            <!-- Tee Sheet Page -->
            <div id="page-teesheet" class="page-content">
                <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:15px;padding:10px 15px;background:#fff;border-radius:8px;box-shadow:0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <button onclick="changeTeeSheetDate(-1)" style="background:#f0f2f5;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
                        <input type="date" id="teeSheetDate" onchange="renderTeeSheet()" style="padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                        <button onclick="changeTeeSheetDate(1)" style="background:#f0f2f5;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
                        <button onclick="goToToday()" style="background:#4a90a4;color:#fff;border:none;padding:8px 15px;border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;">Today</button>
                    </div>
                    <div style="display:flex;align-items:center;gap:15px;">
                        <span style="font-size:12px;color:#666;"><i class="fas fa-circle" style="color:#27ae60;font-size:8px;"></i> Available</span>
                        <span style="font-size:12px;color:#666;"><i class="fas fa-circle" style="color:#4a90a4;font-size:8px;"></i> Booked</span>
                        <span style="font-size:12px;color:#666;"><i class="fas fa-circle" style="color:#9b59b6;font-size:8px;"></i> VIP</span>
                        <span style="font-size:12px;color:#666;"><i class="fas fa-check-circle" style="color:#27ae60;font-size:10px;"></i> Checked In</span>
                    </div>
                </div>
                <div class="rooms-container" id="roomsContainer"></div>
            </div>

            <!-- Open Tabs Page - Quick view with link to full POS -->
            <div id="page-fnb" class="page-content" style="display:none;">
                <div class="fnb-container">
                    <!-- Summary Stats -->
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px;">
                        <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size:12px;color:#888;text-transform:uppercase;">Open Tabs</div>
                            <div id="fnbTabCount" style="font-size:28px;font-weight:700;color:#4a90a4;">0</div>
                        </div>
                        <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size:12px;color:#888;text-transform:uppercase;">Tab Total</div>
                            <div id="fnbTabTotal" style="font-size:28px;font-weight:700;color:#27ae60;">$0.00</div>
                        </div>
                        <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size:12px;color:#888;text-transform:uppercase;">Today's Sales</div>
                            <div id="fnbTodaySales" style="font-size:28px;font-weight:700;color:#2ecc71;">$0.00</div>
                        </div>
                        <div style="background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);">
                            <div style="font-size:12px;color:#888;text-transform:uppercase;">Transactions</div>
                            <div id="fnbTransCount" style="font-size:28px;font-weight:700;color:#3498db;">0</div>
                        </div>
                    </div>
                    
                    <!-- Action Bar -->
                    <div style="display:flex;gap:10px;margin-bottom:20px;">
                        <a href="sales.html" style="padding:12px 24px;background:#27ae60;color:#fff;border-radius:8px;text-decoration:none;font-weight:600;display:flex;align-items:center;gap:8px;">
                            <i class="fas fa-cash-register"></i> Open Full POS
                        </a>
                        <button onclick="showModal('newTab')" style="padding:12px 24px;background:#4a90a4;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;">
                            <i class="fas fa-plus"></i> New Tab
                        </button>
                        <button onclick="refreshTabsView()" style="padding:12px 24px;background:#95a5a6;color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;">
                            <i class="fas fa-sync"></i> Refresh
                        </button>
                    </div>
                    
                    <!-- Open Tabs Table -->
                    <div class="tabs-list" style="background:#fff;border-radius:10px;box-shadow:0 2px 8px rgba(0,0,0,0.08);overflow:hidden;">
                        <h3 style="padding:15px 20px;margin:0;border-bottom:1px solid #eee;display:flex;align-items:center;gap:10px;">
                            <i class="fas fa-receipt" style="color:#4a90a4;"></i> Open Tabs
                        </h3>
                        <table class="tabs-table" style="width:100%;border-collapse:collapse;">
                            <thead>
                                <tr style="background:#f8f9fa;">
                                    <th style="padding:12px 15px;text-align:left;font-weight:600;color:#555;">LOCATION</th>
                                    <th style="padding:12px 15px;text-align:left;font-weight:600;color:#555;">CUSTOMER</th>
                                    <th style="padding:12px 15px;text-align:left;font-weight:600;color:#555;">ITEMS</th>
                                    <th style="padding:12px 15px;text-align:right;font-weight:600;color:#555;">AMOUNT</th>
                                    <th style="padding:12px 15px;text-align:center;font-weight:600;color:#555;">ACTION</th>
                                </tr>
                            </thead>
                            <tbody id="openTabsBody"></tbody>
                        </table>
                        <div id="noTabsMessage" style="padding:40px;text-align:center;color:#888;display:none;">
                            <i class="fas fa-check-circle" style="font-size:40px;color:#27ae60;margin-bottom:10px;display:block;"></i>
                            No open tabs - all tabs have been closed
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Sales Panel (Right Side) - Quick Add for Tee Sheet/F&B -->
        <aside class="sales-panel" id="sidebarSalesPanel">
            <div class="sales-header">
                <h3><i class="fas fa-shopping-cart"></i> Quick Add</h3>
                <div class="sales-total">$<span id="totalAmount">0.00</span></div>
            </div>

            <div class="category-buttons">
                <button class="cat-btn beverage active" onclick="filterItems('all', this)">All</button>
                <button class="cat-btn rental" onclick="filterItems('rental', this)">Rentals</button>
                <button class="cat-btn food" onclick="filterItems('food', this)">Food</button>
                <button class="cat-btn beer" onclick="filterItems('beer', this)">Beer</button>
                <button class="cat-btn wine" onclick="filterItems('wine', this)">Wine</button>
                <button class="cat-btn cocktails" onclick="filterItems('cocktails', this)">Cocktails</button>
                <button class="cat-btn beverage" onclick="filterItems('beverage', this)">N/A Drinks</button>
                <button class="cat-btn merch" onclick="filterItems('merch', this)">Merch</button>
            </div>
            
            <div class="pos-items-mini" id="salesItems"></div>

            <div class="cart-items" id="cartItems">
                <div class="cart-empty"><i class="fas fa-shopping-cart" style="font-size:40px;margin-bottom:10px;"></i><p>No items in cart</p></div>
            </div>

            <div class="cart-footer">
                <div class="cart-totals">
                    <div class="cart-row"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
                    <div class="cart-row" id="discountRow" style="display:none;color:#27ae60;"><span>Discount</span><span id="discountAmount">-$0.00</span></div>
                    <div class="cart-row"><span data-tax-label>Tax (6.35%)</span><span id="taxAmount">$0.00</span></div>
                    <div class="cart-row total"><span>Total:</span><span id="totalDue">$0.00</span></div>
                </div>
                <div class="payment-buttons" style="display:flex;gap:5px;flex-wrap:wrap;">
                    <button class="pay-btn" onclick="applyDiscount()" style="flex:1;min-width:45%;background:#f39c12;"><i class="fas fa-percent"></i> Discount</button>
                    <button class="pay-btn" onclick="clearCart()" style="flex:1;min-width:45%;background:#95a5a6;"><i class="fas fa-trash"></i> Clear</button>
                    <button class="pay-btn pay-now" onclick="processPayment('quick')" style="flex:1;min-width:100%;"><i class="fas fa-credit-card"></i> Pay Now</button>
                </div>
            </div>
            
            <div class="recent-trans">
                <h4>Recent Transactions</h4>
                <div id="recentTrans"></div>
            </div>
        </aside>
    </div>

    <!-- Booking Modal -->
    <div class="modal-overlay" id="modal-booking">
        <div class="modal" style="max-width:600px;">
            <h3><i class="fas fa-calendar-plus"></i> New Reservation</h3>
            <form id="bookingForm" onsubmit="handleCreateBooking(event)">
                <!-- Customer Selection Section -->
                <div class="form-group" style="position:relative;">
                    <label>Customer *</label>
                    <input type="text" id="bookingCustomer" required placeholder="Search by name, phone, or email..." autocomplete="off">
                    <div id="bookingCustomerAutocomplete" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:0 0 8px 8px;max-height:250px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                    <input type="hidden" id="bookingCustomerId" value="">
                </div>
                
                <!-- Quick Customer Selection -->
                <div id="quickCustomerSelect" style="margin-bottom:15px;">
                    <!-- VIP Members -->
                    <div style="margin-bottom:10px;">
                        <label style="font-size:11px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">‚≠ê VIP Members</label>
                        <div id="vipMembersList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:5px;"></div>
                    </div>
                    <!-- Recent Customers -->
                    <div>
                        <label style="font-size:11px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">üïê Recent Customers</label>
                        <div id="recentCustomersList" style="display:flex;flex-wrap:wrap;gap:6px;margin-top:5px;"></div>
                    </div>
                </div>
                
                <!-- Member Badge Display -->
                <div id="bookingMemberBadge" style="display:none;background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;padding:10px 15px;border-radius:8px;margin-bottom:15px;font-size:13px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span><i class="fas fa-crown"></i> <span id="bookingMemberText">VIP Member</span></span>
                        <span id="bookingMemberDiscount" style="font-weight:700;"></span>
                    </div>
                    <div id="bookingMemberBenefits" style="font-size:11px;opacity:0.9;margin-top:5px;"></div>
                </div>
                
                <!-- Room & Time -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Room *</label>
                        <select id="bookingRoom" onchange="checkBookingAvailability()">
                            <option value="1">Room 1</option>
                            <option value="2">Room 2</option>
                            <option value="3">Room 3</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Date *</label>
                        <input type="date" id="bookingDate" onchange="checkBookingAvailability()">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Time *</label>
                        <select id="bookingTime" onchange="checkBookingAvailability()">
                            <option value="9:00am">9:00 AM</option>
                            <option value="10:00am">10:00 AM</option>
                            <option value="11:00am">11:00 AM</option>
                            <option value="12:00pm">12:00 PM</option>
                            <option value="1:00pm">1:00 PM</option>
                            <option value="2:00pm">2:00 PM</option>
                            <option value="3:00pm">3:00 PM</option>
                            <option value="4:00pm">4:00 PM</option>
                            <option value="5:00pm">5:00 PM</option>
                            <option value="6:00pm">6:00 PM</option>
                            <option value="7:00pm">7:00 PM</option>
                            <option value="8:00pm">8:00 PM</option>
                            <option value="9:00pm">9:00 PM</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Duration *</label>
                        <select id="bookingDuration" onchange="updateBookingPrice()">
                            <option value="1">1 Hour</option>
                            <option value="2">2 Hours</option>
                            <option value="3">3 Hours</option>
                            <option value="4">4 Hours</option>
                        </select>
                    </div>
                </div>
                
                <!-- Availability Check -->
                <div id="availabilityCheck" style="display:none;padding:10px;border-radius:6px;margin-bottom:15px;font-size:12px;">
                </div>
                
                <!-- Players & Contact -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Players</label>
                        <select id="bookingPlayers">
                            <option value="1">1 Player</option>
                            <option value="2">2 Players</option>
                            <option value="3">3 Players</option>
                            <option value="4">4 Players</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="bookingPhone" placeholder="(203) 555-0123">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="bookingEmail" placeholder="email@example.com">
                    </div>
                </div>
                
                <!-- Booking Source -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Booking Source</label>
                        <select id="bookingSource">
                            <option value="walk-in">Walk-In</option>
                            <option value="phone">Phone</option>
                            <option value="online">Online</option>
                            <option value="member">Member Portal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Notes</label>
                        <input type="text" id="bookingNotes" placeholder="Special requests...">
                    </div>
                </div>
                
                <!-- Pricing Summary -->
                <div id="bookingPriceSummary" style="background:#f8f9fa;padding:12px 15px;border-radius:8px;margin:15px 0;font-size:13px;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                        <span>Base Price:</span>
                        <span id="bookingBasePrice">$45.00</span>
                    </div>
                    <div id="bookingPeakRow" style="display:none;justify-content:space-between;margin-bottom:5px;color:#e67e22;">
                        <span>Peak Hour Surcharge:</span>
                        <span>+$10.00</span>
                    </div>
                    <div id="bookingDiscountRow" style="display:none;justify-content:space-between;margin-bottom:5px;color:#27ae60;">
                        <span id="bookingDiscountLabel">Member Discount:</span>
                        <span id="bookingDiscountAmount">-$0.00</span>
                    </div>
                    <div style="display:flex;justify-content:space-between;font-weight:700;font-size:15px;border-top:1px solid #ddd;padding-top:8px;margin-top:8px;">
                        <span>Total:</span>
                        <span id="bookingTotalPrice" style="color:#27ae60;">$45.00</span>
                    </div>
                </div>
                
                <!-- Recurring Option -->
                <div style="margin-bottom:15px;">
                    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;">
                        <input type="checkbox" id="bookingRecurring" onchange="toggleRecurringOptions()">
                        <span>Make this a recurring booking</span>
                    </label>
                    <div id="recurringOptions" style="display:none;margin-top:10px;padding:10px;background:#e3f2fd;border-radius:6px;">
                        <div class="form-row">
                            <div class="form-group" style="margin-bottom:0;">
                                <label style="font-size:11px;">Repeat</label>
                                <select id="recurringType" style="font-size:12px;">
                                    <option value="weekly">Weekly</option>
                                    <option value="biweekly">Every 2 Weeks</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom:0;">
                                <label style="font-size:11px;">For</label>
                                <select id="recurringCount" style="font-size:12px;">
                                    <option value="4">4 weeks</option>
                                    <option value="8">8 weeks</option>
                                    <option value="12">12 weeks</option>
                                    <option value="26">6 months</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="hideModal('booking')">Cancel</button>
                    <button type="button" class="btn-save" style="background:#f39c12;" onclick="addToWaitlistFromModal()"><i class="fas fa-clock"></i> Add to Waitlist</button>
                    <button type="submit" class="btn-save"><i class="fas fa-check"></i> Create Booking</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New Tab Modal -->
    <div class="modal-overlay" id="modal-newTab">
        <div class="modal" style="max-width:500px;">
            <h3><i class="fas fa-receipt"></i> New Tab</h3>
            <form onsubmit="createTab(event)">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <div style="position:relative;">
                        <input type="text" id="tabCustomer" required placeholder="Search or enter customer name" oninput="searchTabCustomers(this.value)" autocomplete="off">
                        <input type="hidden" id="tabCustomerId">
                        <div id="tabCustomerResults" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.15);"></div>
                    </div>
                </div>
                
                <!-- Member Quick Select -->
                <div class="form-group">
                    <label style="font-size:11px;color:#666;">Quick Select - Members</label>
                    <div id="tabMemberQuickSelect" style="display:flex;flex-wrap:wrap;gap:5px;margin-top:5px;"></div>
                </div>
                
                <!-- Member Status Display -->
                <div id="tabMemberStatus" style="display:none;padding:12px;background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);border-radius:8px;margin-bottom:15px;border-left:4px solid #9b59b6;">
                    <div style="display:flex;align-items:center;gap:10px;">
                        <i class="fas fa-crown" style="font-size:24px;color:#f1c40f;"></i>
                        <div>
                            <div style="font-weight:600;color:#333;font-size:14px;" id="tabMemberName">Member Name</div>
                            <div style="font-size:12px;color:#666;">
                                <span id="tabMemberTier" style="background:#9b59b6;color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;text-transform:uppercase;"></span>
                                <span id="tabMemberDiscount" style="color:#27ae60;font-weight:600;margin-left:8px;"></span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Table/Location</label>
                    <select id="tabTable">
                        <option value="Tab">Open Tab</option>
                        <option value="Room 1">Room 1</option>
                        <option value="Room 2">Room 2</option>
                        <option value="Room 3">Room 3</option>
                        <option value="Bar">Bar</option>
                        <option value="Lounge">Lounge</option>
                        <optgroup label="Floor Tables">
                            <option value="Table 1">Table 1</option>
                            <option value="Table 2">Table 2</option>
                            <option value="Table 3">Table 3</option>
                            <option value="Table 4">Table 4</option>
                            <option value="Table 5">Table 5</option>
                            <option value="Table 6">Table 6</option>
                            <option value="Table 7">Table 7</option>
                            <option value="Table 8">Table 8</option>
                            <option value="Table 9">Table 9</option>
                            <option value="Table 10">Table 10</option>
                            <option value="Table 11">Table 11</option>
                            <option value="Table 12">Table 12</option>
                            <option value="Table 13">Table 13</option>
                            <option value="Table 14">Table 14</option>
                            <option value="Table 15">Table 15</option>
                        </optgroup>
                    </select>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="hideModal('newTab')">Cancel</button>
                    <button type="submit" class="btn-save">Create Tab</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Booking Detail Modal -->
    <div class="modal-overlay" id="modal-bookingDetail">
        <div class="modal">
            <h3><i class="fas fa-calendar-check"></i> Reservation Details</h3>
            <div id="bookingPriorityBadge" style="display:none;text-align:center;margin-bottom:15px;"></div>
            <div class="booking-detail">
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Customer</span>
                    <span class="booking-detail-value" id="detailCustomer">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Room/Bay</span>
                    <span class="booking-detail-value" id="detailRoom">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Time</span>
                    <span class="booking-detail-value" id="detailTime">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Duration</span>
                    <span class="booking-detail-value" id="detailDuration">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Players</span>
                    <span class="booking-detail-value" id="detailPlayers">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Status</span>
                    <span class="booking-detail-value" id="detailStatus">-</span>
                </div>
                <div class="booking-detail-row" id="detailPriceRow">
                    <span class="booking-detail-label">Total Price</span>
                    <span class="booking-detail-value" id="detailPrice" style="font-weight:700;color:#27ae60;">-</span>
                </div>
                <div class="booking-detail-row" id="detailDepositRow" style="display:none;">
                    <span class="booking-detail-label">Deposit Paid</span>
                    <span class="booking-detail-value" id="detailDeposit" style="color:#3498db;">-</span>
                </div>
                <div class="booking-detail-row" id="detailBalanceRow" style="display:none;border-top:2px solid #eee;padding-top:10px;margin-top:5px;">
                    <span class="booking-detail-label">Balance Due</span>
                    <span class="booking-detail-value" id="detailBalance" style="font-weight:700;color:#e74c3c;">-</span>
                </div>
                <div class="booking-detail-row" id="detailNotesRow" style="display:none;">
                    <span class="booking-detail-label">Notes</span>
                    <span class="booking-detail-value" id="detailNotes" style="font-style:italic;">-</span>
                </div>
            </div>
            <div class="modal-buttons" style="flex-wrap:wrap;" id="bookingDetailButtons">
                <button type="button" class="btn-cancel" onclick="hideModal('bookingDetail')" style="flex:1;min-width:100px;">Close</button>
                <button type="button" id="btnNoShow" style="flex:1;min-width:100px;background:#f39c12;border:none;color:#fff;padding:12px;border-radius:6px;font-weight:600;cursor:pointer;" onclick="markNoShow()"><i class="fas fa-user-slash"></i> No Show</button>
                <button type="button" id="btnReschedule" style="flex:1;min-width:100px;background:#9b59b6;border:none;color:#fff;padding:12px;border-radius:6px;font-weight:600;cursor:pointer;" onclick="rescheduleBooking()"><i class="fas fa-calendar-alt"></i> Reschedule</button>
                <button type="button" id="btnCancelBooking" class="delete-booking-btn" onclick="deleteBooking()" style="flex:1;min-width:100px;"><i class="fas fa-trash"></i> Cancel</button>
                <button type="button" id="btnCheckIn" class="btn-save" onclick="checkInBooking()" style="flex:1;min-width:100px;"><i class="fas fa-check"></i> Check In</button>
                <button type="button" id="btnCheckOut" class="btn-save" onclick="checkOutBooking()" style="flex:1;min-width:100px;display:none;background:#27ae60;"><i class="fas fa-sign-out-alt"></i> Check Out</button>
            </div>
        </div>
    </div>

    <!-- Tab Detail Modal -->
    <div class="modal-overlay" id="modal-tabDetail">
        <div class="modal" style="max-width:450px;">
            <h3><i class="fas fa-receipt"></i> Tab Details</h3>
            <div class="booking-detail">
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Tab #</span>
                    <span class="booking-detail-value" id="tabDetailId">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Customer</span>
                    <span class="booking-detail-value" id="tabDetailCustomer">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Location</span>
                    <span class="booking-detail-value" id="tabDetailTable">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Subtotal</span>
                    <span class="booking-detail-value" id="tabDetailSubtotal">-</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label" data-tax-label>Tax (6.35%)</span>
                    <span class="booking-detail-value" id="tabDetailTax">-</span>
                </div>
                <div class="booking-detail-row" style="font-weight:700;font-size:16px;border-top:2px solid #eee;padding-top:10px;margin-top:5px;">
                    <span class="booking-detail-label">Total</span>
                    <span class="booking-detail-value" id="tabDetailAmount" style="color:#27ae60;">-</span>
                </div>
            </div>
            <div id="tabItemsList" style="max-height:150px;overflow-y:auto;margin:15px 0;padding:10px;background:#f8f9fa;border-radius:6px;font-size:13px;"></div>
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="hideModal('tabDetail')">Close</button>
                <button type="button" class="delete-booking-btn" onclick="closeTab()"><i class="fas fa-credit-card"></i> Pay & Close</button>
                <button type="button" class="btn-save" onclick="addToTabFromCurrent()"><i class="fas fa-plus"></i> Add Items</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div class="modal-overlay" id="modal-payment">
        <div class="modal" style="max-width:400px;">
            <h3><i class="fas fa-credit-card"></i> Process Payment</h3>
            <div class="booking-detail">
                <div class="booking-detail-row">
                    <span class="booking-detail-label">Subtotal</span>
                    <span class="booking-detail-value" id="paySubtotal">$0.00</span>
                </div>
                <div class="booking-detail-row" id="payDiscountRow" style="display:none;color:#27ae60;">
                    <span class="booking-detail-label">Discount</span>
                    <span class="booking-detail-value" id="payDiscount">-$0.00</span>
                </div>
                <div class="booking-detail-row">
                    <span class="booking-detail-label" data-tax-label>Tax (6.35%)</span>
                    <span class="booking-detail-value" id="payTax">$0.00</span>
                </div>
                <div class="booking-detail-row" style="font-weight:700;font-size:18px;border-top:2px solid #eee;padding-top:10px;margin-top:5px;">
                    <span class="booking-detail-label">Total Due</span>
                    <span class="booking-detail-value" id="payTotal" style="color:#27ae60;">$0.00</span>
                </div>
            </div>
            <div style="margin:20px 0;">
                <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;">Payment Method</label>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <button type="button" class="pay-method-btn active" onclick="selectPayMethod('card', this)" style="flex:1;min-width:calc(50% - 5px);padding:15px 10px;border:2px solid #4a90a4;background:#4a90a4;color:#fff;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">
                        <i class="fas fa-credit-card"></i> Card<br><span style="font-size:10px;opacity:0.8;font-weight:400;">(External Terminal)</span>
                    </button>
                    <button type="button" class="pay-method-btn" onclick="selectPayMethod('cash', this)" style="flex:1;min-width:calc(50% - 5px);padding:15px 10px;border:2px solid #ddd;background:#fff;color:#333;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">
                        <i class="fas fa-money-bill-wave"></i> Cash
                    </button>
                    <button type="button" class="pay-method-btn" onclick="selectPayMethod('giftcard', this)" style="flex:1;min-width:calc(50% - 5px);padding:15px 10px;border:2px solid #ddd;background:#fff;color:#333;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">
                        <i class="fas fa-gift"></i> Gift Card
                    </button>
                    <button type="button" class="pay-method-btn" onclick="selectPayMethod('tab', this)" style="flex:1;min-width:calc(50% - 5px);padding:15px 10px;border:2px solid #ddd;background:#fff;color:#333;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;">
                        <i class="fas fa-receipt"></i> Add to Tab
                    </button>
                </div>
            </div>
            <div id="cardSection" style="display:block;margin:15px 0;padding:15px;background:#e3f2fd;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:10px;color:#1565c0;">
                    <i class="fas fa-info-circle" style="font-size:18px;"></i>
                    <div>
                        <div style="font-weight:600;font-size:13px;" id="cardSectionTitle">Process on External Terminal</div>
                        <div style="font-size:12px;opacity:0.8;" id="cardSectionDesc">Complete the card payment on your card reader, then click "Complete Payment" to record the transaction.</div>
                    </div>
                </div>
                <div id="stripeTerminalActions" style="display:none;margin-top:10px;">
                    <button type="button" onclick="initiateStripePayment()" id="stripePayBtn" style="width:100%;padding:12px;background:#635bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
                        <i class="fas fa-credit-card"></i> Charge Card on Reader
                    </button>
                    <div id="stripePaymentStatus" style="display:none;margin-top:10px;padding:12px;border-radius:6px;text-align:center;"></div>
                </div>
            </div>
            <div id="giftcardSection" style="display:none;margin:15px 0;padding:15px;background:#fff3e0;border-radius:8px;">
                <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;">Gift Card Number</label>
                <input type="text" id="giftCardNumber" placeholder="Enter gift card code" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:14px;text-transform:uppercase;" oninput="this.value = this.value.toUpperCase()">
                <button type="button" onclick="lookupGiftCard()" style="margin-top:10px;width:100%;padding:10px;background:#f57c00;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-search"></i> Check Balance</button>
                <div id="giftCardInfo" style="display:none;margin-top:10px;padding:10px;background:#e8f5e9;border-radius:6px;"></div>
            </div>
            <div id="tabSection" style="display:none;margin:15px 0;padding:15px;background:#f3e5f5;border-radius:8px;">
                <div style="display:flex;align-items:center;gap:10px;color:#7b1fa2;">
                    <i class="fas fa-info-circle" style="font-size:18px;"></i>
                    <div>
                        <div style="font-weight:600;font-size:13px;">Add to Customer Tab</div>
                        <div style="font-size:12px;opacity:0.8;">This will add the items to the customer's open tab for payment later.</div>
                    </div>
                </div>
            </div>
            <div id="cashSection" style="display:none;margin:15px 0;padding:15px;background:#f8f9fa;border-radius:8px;">
                <label style="display:block;margin-bottom:8px;font-weight:600;font-size:13px;">Cash Tendered</label>
                <input type="number" id="cashTendered" placeholder="0.00" step="0.01" min="0" oninput="calculateChange()" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;text-align:right;">
                <div style="display:flex;gap:5px;margin-top:10px;flex-wrap:wrap;">
                    <button type="button" onclick="quickCash(20)" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$20</button>
                    <button type="button" onclick="quickCash(50)" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$50</button>
                    <button type="button" onclick="quickCash(100)" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$100</button>
                    <button type="button" onclick="quickCash('exact')" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">Exact</button>
                </div>
                <div id="changeSection" style="display:none;margin-top:15px;padding:12px;background:#e8f5e9;border-radius:6px;text-align:center;">
                    <span style="font-size:13px;color:#666;">Change Due:</span>
                    <span id="changeAmount" style="font-size:20px;font-weight:700;color:#27ae60;margin-left:10px;">$0.00</span>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="cancelPayment()">Cancel</button>
                <button type="button" class="btn-save" id="completePayBtn" onclick="completePayment()"><i class="fas fa-check"></i> Complete Payment</button>
            </div>
        </div>
    </div>

    <!-- Global Lookup Modal -->
    <div class="modal-overlay" id="modal-lookup">
        <div class="modal" style="max-width:600px;">
            <h3><i class="fas fa-search"></i> Quick Lookup <span style="font-size:11px;opacity:0.7;margin-left:10px;">Ctrl+K</span></h3>
            <div style="margin-bottom:15px;">
                <input type="text" id="globalSearchInput" placeholder="Search customers, bookings, transactions..." 
                    style="width:100%;padding:15px;border:2px solid #4a90a4;border-radius:8px;font-size:16px;"
                    oninput="performGlobalSearch(this.value)" autofocus>
            </div>
            <div id="globalSearchResults" style="max-height:400px;overflow-y:auto;">
                <div style="text-align:center;color:#999;padding:40px;">
                    <i class="fas fa-search" style="font-size:40px;margin-bottom:10px;display:block;"></i>
                    Start typing to search...
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn-cancel" onclick="hideModal('lookup')">Close</button>
            </div>
        </div>
    </div>

    <script>
        // ============ DATA ============
        let currentDate = new Date();
        let selectedDate = currentDate.toISOString().split('T')[0]; // YYYY-MM-DD format
        let cart = [];
        let currentDiscount = 0;
        let currentCartCustomer = null;  // Track customer for member discount
        let memberDiscountApplied = false; // Track if auto-discount was applied
        let selectedBookingId = null;
        let selectedTabId = null;
        let bookings = JSON.parse(localStorage.getItem('gc_bookings') || '[]');
        let transactions = JSON.parse(localStorage.getItem('gc_transactions') || '[]');
        let openTabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
        
        // ============ PIN LOCK SYSTEM ============
        let currentPin = '';
        let currentEmployee = null;
        let isLocked = true;
        
        // Default employees (will be synced from Firebase)
        const defaultEmployees = [
            { id: 'EMP-DEFAULT-1', name: 'Manager', pin: '9999', role: 'manager', isActive: true },
            { id: 'EMP-DEFAULT-2', name: 'Staff', pin: '8888', role: 'staff', isActive: true }
        ];
        
        // Load employees from centralized storage (synced with Firebase)
        function loadEmployees() {
            let stored = JSON.parse(localStorage.getItem('gc_employees') || 'null');
            if (!stored || stored.length === 0) {
                localStorage.setItem('gc_employees', JSON.stringify(defaultEmployees));
                return defaultEmployees;
            }
            return stored.filter(e => e.isActive !== false);
        }
        
        let employees = loadEmployees();
        
        function enterPin(num) {
            if (currentPin.length < 4) {
                currentPin += num.toString();
                updatePinDisplay();
            }
        }
        
        function clearPin() {
            if (currentPin.length > 0) {
                currentPin = currentPin.slice(0, -1);
                updatePinDisplay();
            }
        }
        
        function updatePinDisplay() {
            const dots = document.querySelectorAll('#pinDisplay .pin-dot');
            dots.forEach((dot, i) => {
                if (i < currentPin.length) {
                    dot.style.background = '#4a90a4';
                } else {
                    dot.style.background = '#fff';
                }
            });
            document.getElementById('pinError').style.display = 'none';
        }
        
        function submitPin() {
            // Refresh employees list (may have been updated from Firebase)
            employees = loadEmployees();
            const employee = employees.find(e => e.pin === currentPin);
            
            if (employee) {
                currentEmployee = employee;
                isLocked = false;
                document.getElementById('lockScreen').style.display = 'none';
                document.getElementById('currentUserName').textContent = employee.name;
                showToast(`Welcome, ${employee.name}!`, 'success');
                
                // Timeclock disabled - TODO: Re-enable when moved to Firebase
                console.log('Timeclock disabled - clock in:', employee.name);
            } else {
                document.getElementById('pinError').style.display = 'block';
                currentPin = '';
                updatePinDisplay();
                
                // Shake animation
                const pinDisplay = document.getElementById('pinDisplay');
                pinDisplay.style.animation = 'shake 0.3s';
                setTimeout(() => pinDisplay.style.animation = '', 300);
            }
        }
        
        function lockPOS() {
            isLocked = true;
            currentPin = '';
            updatePinDisplay();
            document.getElementById('lockScreen').style.display = 'flex';
            document.getElementById('pinError').style.display = 'none';
            
            if (currentEmployee) {
                // Timeclock disabled - TODO: Re-enable when moved to Firebase
                console.log('Timeclock disabled - lock:', currentEmployee.name);
            }
        }
        
        // Handle keyboard input for PIN
        document.addEventListener('keydown', function(e) {
            if (!isLocked) return;
            
            if (e.key >= '0' && e.key <= '9') {
                enterPin(parseInt(e.key));
            } else if (e.key === 'Backspace') {
                clearPin();
            } else if (e.key === 'Enter') {
                submitPin();
            }
        });
        
        // ============ GLOBAL KEYBOARD SHORTCUTS ============
        document.addEventListener('keydown', function(e) {
            // Skip if locked or in input/textarea
            if (isLocked) return;
            const isInput = ['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName);
            
            // Ctrl+K - Quick Search (safe, doesn't conflict)
            if (e.ctrlKey && e.key === 'k') {
                e.preventDefault();
                openQuickSearch();
                return;
            }
            
            // Escape - Close modals
            if (e.key === 'Escape') {
                closeQuickSearch();
                closeAllModals();
                return;
            }
            
            // Skip character shortcuts if in input
            if (isInput) return;
            
            // ? - Toggle shortcut help
            if (e.key === '?') {
                toggleShortcutHelp();
                return;
            }
        });
        
        function toggleShortcutHelp() {
            const panel = document.getElementById('shortcutHint');
            if (panel) panel.classList.toggle('visible');
        }
        
        function closeAllModals() {
            document.querySelectorAll('.modal-overlay.active').forEach(m => m.classList.remove('active'));
        }
        
        // ============ QUICK SEARCH SYSTEM ============
        let quickSearchIndex = 0;
        let quickSearchResults = [];
        
        function openQuickSearch() {
            const overlay = document.getElementById('quickSearchOverlay');
            overlay.classList.add('active');
            const input = document.getElementById('quickSearchInput');
            input.value = '';
            input.focus();
            document.getElementById('quickSearchResults').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Type to search customers, bookings, menu items...</div>';
        }
        
        function closeQuickSearch() {
            document.getElementById('quickSearchOverlay').classList.remove('active');
        }
        
        function handleQuickSearch(query) {
            if (!query || query.length < 2) {
                document.getElementById('quickSearchResults').innerHTML = '<div style="padding:20px;text-align:center;color:#999;">Type to search...</div>';
                return;
            }
            
            query = query.toLowerCase();
            quickSearchResults = [];
            
            // Search customers
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            customers.forEach(c => {
                const fullName = getCustomerFullName(c).toLowerCase();
                const phone = (c.phone || '').toLowerCase();
                const email = (c.email || '').toLowerCase();
                if (fullName.includes(query) || phone.includes(query) || email.includes(query)) {
                    quickSearchResults.push({
                        type: 'customer',
                        icon: c.isMember ? 'fa-crown' : 'fa-user',
                        title: getCustomerFullName(c),
                        subtitle: c.isMember ? `Member - ${c.memberType?.replace('_', ' ')}` : (c.phone || c.email || 'Customer'),
                        action: () => { closeQuickSearch(); selectBookingCustomer(c.id); showModal('booking'); },
                        actionText: 'New Booking'
                    });
                }
            });
            
            // Search bookings for today
            const today = new Date().toISOString().split('T')[0];
            const bookingsToday = bookings.filter(b => b.date === today || b.date === document.getElementById('teeSheetDate')?.value);
            bookingsToday.forEach(b => {
                if ((b.customer || '').toLowerCase().includes(query)) {
                    quickSearchResults.push({
                        type: 'booking',
                        icon: 'fa-calendar-check',
                        title: b.customer,
                        subtitle: `${b.time} - Room ${b.roomId}`,
                        action: () => { closeQuickSearch(); selectBooking(b.id); },
                        actionText: 'View'
                    });
                }
            });
            
            // Search menu items
            items.forEach(item => {
                if (item.name.toLowerCase().includes(query)) {
                    quickSearchResults.push({
                        type: 'item',
                        icon: item.icon,
                        title: item.name,
                        subtitle: `$${item.price.toFixed(2)} - ${item.category}`,
                        action: () => { closeQuickSearch(); addToCart(item.name, item.price); },
                        actionText: 'Add to Cart'
                    });
                }
            });
            
            // Search open tabs
            openTabs.forEach(tab => {
                if ((tab.customer || '').toLowerCase().includes(query)) {
                    quickSearchResults.push({
                        type: 'tab',
                        icon: 'fa-receipt',
                        title: tab.customer,
                        subtitle: `Tab - $${tab.amount.toFixed(2)}`,
                        action: () => { closeQuickSearch(); selectTab(tab.id); },
                        actionText: 'View Tab'
                    });
                }
            });
            
            // Render results
            quickSearchIndex = 0;
            renderQuickSearchResults();
        }
        
        function renderQuickSearchResults() {
            const container = document.getElementById('quickSearchResults');
            if (quickSearchResults.length === 0) {
                container.innerHTML = '<div style="padding:20px;text-align:center;color:#999;">No results found</div>';
                return;
            }
            
            container.innerHTML = quickSearchResults.slice(0, 10).map((r, i) => `
                <div class="quick-search-item ${i === quickSearchIndex ? 'selected' : ''}" onclick="quickSearchResults[${i}].action()" onmouseenter="quickSearchIndex=${i};renderQuickSearchResults()">
                    <i class="fas ${r.icon}"></i>
                    <div class="item-info">
                        <div class="item-title">${r.title}</div>
                        <div class="item-subtitle">${r.subtitle}</div>
                    </div>
                    <span class="item-action">${r.actionText}</span>
                </div>
            `).join('');
        }
        
        function handleQuickSearchKey(e) {
            if (e.key === 'ArrowDown') {
                e.preventDefault();
                quickSearchIndex = Math.min(quickSearchIndex + 1, Math.min(quickSearchResults.length - 1, 9));
                renderQuickSearchResults();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                quickSearchIndex = Math.max(quickSearchIndex - 1, 0);
                renderQuickSearchResults();
            } else if (e.key === 'Enter' && quickSearchResults.length > 0) {
                e.preventDefault();
                quickSearchResults[quickSearchIndex].action();
            } else if (e.key === 'Escape') {
                closeQuickSearch();
            }
        }
        
        // ============ STATUS BAR UPDATES ============
        function updateStatusBar() {
            // Sync status
            const syncDot = document.getElementById('statusDotSync');
            const syncText = document.getElementById('statusSyncText');
            if (syncDot && syncText) {
                const lastSync = localStorage.getItem('gc_last_sync');
                if (lastSync) {
                    const syncAge = Date.now() - new Date(lastSync).getTime();
                    if (syncAge < 60000) {
                        syncDot.className = 'status-dot green';
                        syncText.textContent = 'Synced';
                    } else if (syncAge < 300000) {
                        syncDot.className = 'status-dot yellow';
                        syncText.textContent = 'Synced ' + Math.floor(syncAge / 60000) + 'm ago';
                    } else {
                        syncDot.className = 'status-dot red';
                        syncText.textContent = 'Sync needed';
                    }
                } else {
                    syncDot.className = 'status-dot yellow';
                    syncText.textContent = 'Not synced';
                }
            }
            
            // Reader status
            const readerDot = document.getElementById('statusDotReader');
            const readerText = document.getElementById('statusReaderText');
            if (readerDot && readerText) {
                if (typeof connectedReader !== 'undefined' && connectedReader) {
                    readerDot.className = 'status-dot green';
                    readerText.textContent = 'Reader OK';
                } else {
                    readerDot.className = 'status-dot red';
                    readerText.textContent = 'No Reader';
                }
            }
            
            // Tabs count
            const tabsCount = document.getElementById('statusTabsCount');
            if (tabsCount) {
                tabsCount.textContent = openTabs.length;
            }
            
            // Bookings today count
            const bookingsCount = document.getElementById('statusBookingsCount');
            if (bookingsCount) {
                const today = new Date().toISOString().split('T')[0];
                const todayBookings = bookings.filter(b => b.date === today && b.status !== 'cancelled');
                bookingsCount.textContent = todayBookings.length;
            }
            
            // Clock
            const clock = document.getElementById('statusClock');
            if (clock) {
                clock.textContent = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            }
        }
        
        // Update status bar every 10 seconds
        setInterval(updateStatusBar, 10000);
        
        // Add shake animation style
        const shakeStyle = document.createElement('style');
        shakeStyle.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-10px); }
                75% { transform: translateX(10px); }
            }
            .pin-btn:hover { background: #e9ecef !important; }
            .pin-btn:active { transform: scale(0.95); }
        `;
        document.head.appendChild(shakeStyle);

        const rooms = [
            { id: 1, name: 'Room 1' },
            { id: 2, name: 'Room 2' },
            { id: 3, name: 'Room 3' }
        ];

        const timeSlots = ['9:00am', '10:00am', '11:00am', '12:00pm', '1:00pm', '2:00pm', '3:00pm', '4:00pm', '5:00pm', '6:00pm', '7:00pm', '8:00pm'];

        // Use unified menu from menu-data.js
        const items = window.GolfCoveMenu ? GolfCoveMenu.getAllItems() : [];

        const floorPlanTables = [
            { id: 1, type: 'circle', x: 50, y: 50 },
            { id: 2, type: 'circle', x: 150, y: 50 },
            { id: 3, type: 'circle', x: 250, y: 50 },
            { id: 4, type: 'circle', x: 350, y: 50 },
            { id: 5, type: 'circle', x: 50, y: 150 },
            { id: 6, type: 'circle', x: 150, y: 150 },
            { id: 7, type: 'diamond', x: 300, y: 150 },
            { id: 8, type: 'diamond', x: 400, y: 150 },
            { id: 9, type: 'diamond', x: 500, y: 150 },
            { id: 10, type: 'rectangle', x: 50, y: 350 },
            { id: 11, type: 'rectangle', x: 150, y: 350 },
            { id: 12, type: 'rectangle', x: 250, y: 350 },
            { id: 13, type: 'circle', x: 400, y: 350 },
            { id: 14, type: 'circle', x: 500, y: 350 },
            { id: 15, type: 'circle', x: 600, y: 350 },
        ];

        // Sample bookings - with proper date, status, and roomId fields
        if (bookings.length === 0) {
            const today = new Date().toISOString().split('T')[0];
            bookings = [
                { id: 1, room: 1, roomId: 1, time: '10:00am', date: today, customer: 'Mike Johnson', players: 2, duration: 1, status: 'confirmed' },
                { id: 2, room: 1, roomId: 1, time: '11:00am', date: today, customer: 'Alex Qi', players: 4, duration: 2, status: 'confirmed' },
                { id: 3, room: 2, roomId: 2, time: '12:00pm', date: today, customer: 'Sarah Wilson', players: 1, duration: 1, status: 'confirmed' },
                { id: 4, room: 2, roomId: 2, time: '1:00pm', date: today, customer: 'Tom Brown', players: 2, duration: 1, status: 'confirmed' },
                { id: 5, room: 3, roomId: 3, time: '1:00pm', date: today, customer: 'Chris Lee', players: 1, duration: 1, status: 'confirmed' },
                { id: 6, room: 3, roomId: 3, time: '2:00pm', date: today, customer: 'Ryan Smith', players: 1, duration: 1, status: 'confirmed' },
                { id: 7, room: 1, roomId: 1, time: '5:00pm', date: today, customer: 'Nick Piselli', players: 1, duration: 1, status: 'confirmed' },
                { id: 8, room: 2, roomId: 2, time: '4:00pm', date: today, customer: 'Brett Huck', players: 1, duration: 1, status: 'confirmed' },
                { id: 9, room: 3, roomId: 3, time: '4:00pm', date: today, customer: 'Dylan Vasp', players: 1, duration: 1, status: 'confirmed' },
            ];
            localStorage.setItem('gc_bookings', JSON.stringify(bookings));
        }

        // Sample tabs
        if (openTabs.length === 0) {
            openTabs = [
                { id: 53, customer: 'Ryan Handyman', employee: 'EJ Sattelberger', amount: 45.00, subtotal: 42.30, items: [], table: 'Tab', createdAt: new Date().toISOString() },
                { id: 63, customer: 'Adam', employee: 'GC TABS', amount: 12.00, subtotal: 11.28, items: [], table: 'Tab', createdAt: new Date().toISOString() },
                { id: 35, customer: 'Vinny', employee: 'GC TABS', amount: 28.00, subtotal: 26.33, items: [], table: 'Tab', createdAt: new Date().toISOString() },
                { id: 36, customer: 'EJ', employee: 'GC TABS', amount: 0, subtotal: 0, items: [], table: 'Tab', createdAt: new Date().toISOString() },
            ];
            localStorage.setItem('gc_tabs', JSON.stringify(openTabs));
        }

        // Sample transactions
        if (transactions.length === 0) {
            const today = new Date().toISOString();
            transactions = [
                { id: 26762, customer: 'Qi**', amount: 0, subtotal: 0, tax: 0, items: [], itemCount: 0, method: 'card', time: '6:18PM', date: today, discount: 0, isReturn: false, register: 'POS-1' },
                { id: 26761, customer: 'No Customer', amount: 94.48, subtotal: 88.84, tax: 5.64, items: [], itemCount: 2, method: 'card', time: '6:14PM', date: today, discount: 0, isReturn: false, register: 'POS-1' },
                { id: 26760, customer: 'No Customer', amount: 53.18, subtotal: 50.00, tax: 3.18, items: [], itemCount: 1, method: 'cash', time: '5:17PM', date: today, discount: 0, isReturn: false, register: 'POS-1', tip: 1.00 },
                { id: 26759, customer: 'No Customer', amount: 14.60, subtotal: 13.73, tax: 0.87, items: [], itemCount: 1, method: 'card', time: '3:55PM', date: today, discount: 0, isReturn: false, register: 'POS-1' },
                { id: 26758, customer: 'No Customer', amount: 0, subtotal: 0, tax: 0, items: [], itemCount: 0, method: 'cash', time: '3:12PM', date: today, discount: 0, isReturn: false, register: 'POS-1' },
            ];
        }
        
        // ============ TAB LOADING & SYNCHRONIZATION ============
        function loadTabs() {
            // Try TabsSync first (Firebase-synced), fallback to localStorage
            if (typeof TabsSync !== 'undefined') {
                try {
                    const syncedTabs = TabsSync.getAllTabs();
                    if (syncedTabs && syncedTabs.length > 0) {
                        openTabs = syncedTabs;
                        return;
                    }
                } catch (e) {
                    console.warn('TabsSync error, falling back to localStorage:', e);
                }
            }
            
            // Load from localStorage
            try {
                const stored = localStorage.getItem('gc_tabs');
                if (stored) {
                    openTabs = JSON.parse(stored);
                    // Normalize tab data structure
                    openTabs = openTabs.map(tab => ({
                        ...tab,
                        id: tab.id || Date.now(),
                        customer: tab.customer || 'Guest',
                        amount: tab.amount || tab.total || 0,
                        subtotal: tab.subtotal || 0,
                        items: tab.items || [],
                        table: tab.table || 'Tab',
                        createdAt: tab.createdAt || tab.openedAt || new Date().toISOString()
                    }));
                }
            } catch (e) {
                console.error('Error loading tabs:', e);
                openTabs = [];
            }
        }
        
        function saveTabs() {
            try {
                localStorage.setItem('gc_tabs', JSON.stringify(openTabs));
                // Sync to Firebase if available
                if (typeof TabsSync !== 'undefined' && TabsSync.syncToServer) {
                    TabsSync.syncToServer();
                }
            } catch (e) {
                console.error('Error saving tabs:', e);
            }
        }

        // ============ RENDER FUNCTIONS ============
        function renderTeeSheet() {
            const container = document.getElementById('roomsContainer');
            if (!container) {
                console.error('roomsContainer not found');
                return;
            }
            
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const selectedDate = document.getElementById('teeSheetDate')?.value || new Date().toISOString().split('T')[0];
            
            // Get all bookings for the selected date from the booking system
            let allBookings = [];
            try {
                if (typeof GolfCoveBooking !== 'undefined' && GolfCoveBooking.getForDate) {
                    allBookings = GolfCoveBooking.getForDate(selectedDate) || [];
                } else {
                    // Fallback to localStorage
                    const storedBookings = JSON.parse(localStorage.getItem('gc_bookings') || '[]');
                    allBookings = storedBookings.filter(b => b.date === selectedDate && b.status !== 'cancelled');
                }
            } catch (e) {
                console.error('Error loading bookings:', e);
                allBookings = [];
            }
            
            container.innerHTML = rooms.map(room => {
                // Get bookings for this room using either roomId or room
                const roomBookings = allBookings.filter(b => (b.roomId || b.room) === room.id);
                const bookedCount = roomBookings.length;
                const checkedInCount = roomBookings.filter(b => b.status === 'checked-in' || b.status === 'checked_in' || b.checkedIn).length;
                let statusClass = 'available';
                if (bookedCount > 0 && checkedInCount === bookedCount) statusClass = 'occupied';
                else if (bookedCount > 0) statusClass = 'partial';
                
                return `
                <div class="room-column">
                    <div class="room-header">
                        <span class="status-dot ${statusClass}"></span>
                        <h3>${room.name}</h3>
                        <span style="font-size:11px;color:#888;margin-left:auto;">${bookedCount} bookings</span>
                    </div>
                    <div class="room-slots">
                        ${timeSlots.map(time => {
                            const booking = roomBookings.find(b => b.time === time);
                            
                            // Check VIP/member status
                            let memberBadge = '';
                            let isVIP = false;
                            if (booking) {
                                if (booking.priority === 'vip') {
                                    isVIP = true;
                                    memberBadge = '<span style="background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;font-size:8px;padding:1px 4px;border-radius:6px;margin-left:4px;">‚≠ê VIP</span>';
                                } else if (booking.priority === 'member') {
                                    memberBadge = '<span style="background:#27ae60;color:#fff;font-size:8px;padding:1px 4px;border-radius:6px;margin-left:4px;">M</span>';
                                } else {
                                    // Fallback to customer lookup
                                    const customer = allCustomers.find(c => 
                                        `${c.firstName} ${c.lastName}`.toLowerCase() === booking.customer.toLowerCase()
                                    );
                                    if (customer && customer.isMember && customer.memberExpires && new Date(customer.memberExpires) > new Date()) {
                                        isVIP = customer.memberType && (customer.memberType.includes('eagle') || customer.memberType.includes('birdie'));
                                        if (isVIP) {
                                            memberBadge = '<span style="background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;font-size:8px;padding:1px 4px;border-radius:6px;margin-left:4px;">‚≠ê VIP</span>';
                                        } else if (customer.memberType) {
                                            memberBadge = '<span style="background:#27ae60;color:#fff;font-size:8px;padding:1px 4px;border-radius:6px;margin-left:4px;">M</span>';
                                        }
                                    }
                                }
                            }
                            
                            // Status icon
                            const isCheckedIn = booking && (booking.status === 'checked-in' || booking.status === 'checked_in' || booking.checkedIn);
                            const statusIcon = isCheckedIn ? ' <i class="fas fa-check-circle" style="color:#27ae60;"></i>' : '';
                            
                            return `
                                <div class="time-slot">
                                    <div class="time-label">${time}</div>
                                    <div class="slot-content ${booking ? (isCheckedIn ? 'booked checked-in' : 'booked') : 'available'}${isVIP ? ' vip-booking' : ''}" onclick="${booking ? `selectBooking(${booking.id})` : `quickBook(${room.id}, '${time}')`}" style="${isVIP ? 'background:linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);box-shadow:0 2px 8px rgba(155,89,182,0.4);' : ''}">
                                        ${booking ? `
                                            <div class="booking-info">
                                                <span class="customer-name">${booking.customer}${memberBadge}${statusIcon}</span>
                                                <span class="booking-details">${booking.duration}hr</span>
                                            </div>
                                            <span class="player-count">${booking.players}<i class="fas fa-user" style="margin-left:3px;font-size:10px;"></i></span>
                                        ` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `}).join('');
            updateStats();
        }

        function renderFloorPlan() {
            // Floor plan removed for simplicity - function kept for compatibility
            return;
        }

        function renderOpenTabs() {
            const tbody = document.getElementById('openTabsBody');
            const noTabsMsg = document.getElementById('noTabsMessage');
            if (!tbody) return;
            
            // Ensure openTabs is loaded
            if (!openTabs || !Array.isArray(openTabs)) {
                loadTabs();
            }
            
            // Update summary stats
            const tabCount = openTabs.length;
            const tabTotal = openTabs.reduce((sum, t) => sum + (t.amount || t.total || 0), 0);
            const todaySales = transactions.reduce((sum, t) => sum + (t.amount || 0), 0);
            const transCount = transactions.length;
            
            const fnbTabCountEl = document.getElementById('fnbTabCount');
            const fnbTabTotalEl = document.getElementById('fnbTabTotal');
            const fnbTodaySalesEl = document.getElementById('fnbTodaySales');
            const fnbTransCountEl = document.getElementById('fnbTransCount');
            
            if (fnbTabCountEl) fnbTabCountEl.textContent = tabCount;
            if (fnbTabTotalEl) fnbTabTotalEl.textContent = '$' + tabTotal.toFixed(2);
            if (fnbTodaySalesEl) fnbTodaySalesEl.textContent = '$' + todaySales.toFixed(2);
            if (fnbTransCountEl) fnbTransCountEl.textContent = transCount;
            
            if (openTabs.length === 0) {
                tbody.innerHTML = '';
                if (noTabsMsg) noTabsMsg.style.display = 'block';
            } else {
                if (noTabsMsg) noTabsMsg.style.display = 'none';
                tbody.innerHTML = openTabs.map(tab => {
                    // Check if customer is a member
                    let memberBadge = '';
                    let rowStyle = '';
                    
                    if (tab.isMember && tab.memberType) {
                        const tierColors = {
                            'par': '#3498db',
                            'birdie': '#9b59b6', 
                            'eagle': '#f1c40f',
                            'family_par': '#3498db',
                            'family_birdie': '#9b59b6',
                            'family_eagle': '#f1c40f',
                            'corporate': '#2c3e50',
                            'monthly': '#27ae60',
                            'annual': '#27ae60'
                        };
                        const tierColor = tierColors[tab.memberType] || '#9b59b6';
                        const discounts = { 'par': '10%', 'birdie': '10%', 'eagle': '15%', 'family_par': '10%', 'family_birdie': '10%', 'family_eagle': '15%', 'corporate': '20%' };
                        const discount = discounts[tab.memberType] || '10%';
                        
                        memberBadge = `
                            <span style="display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg, ${tierColor} 0%, ${tierColor}dd 100%);color:#fff;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:600;text-transform:uppercase;margin-left:8px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                                <i class="fas fa-crown" style="font-size:9px;color:#f1c40f;"></i>
                                ${tab.memberType.replace('_', ' ')} (${discount} OFF)
                            </span>
                        `;
                        rowStyle = 'background:linear-gradient(135deg, #fef9e7 0%, #f8f4e8 100%);';
                    }
                    
                    const itemCount = tab.items ? tab.items.length : 0;
                    const tabAmount = tab.amount || tab.total || 0;
                    
                    return `
                    <tr class="tab-row" style="${rowStyle}border-bottom:1px solid #eee;">
                        <td style="padding:12px 15px;">${tab.table || 'Tab'}</td>
                        <td style="padding:12px 15px;display:flex;align-items:center;flex-wrap:wrap;">${tab.customer || 'Guest'}${memberBadge}</td>
                        <td style="padding:12px 15px;color:#666;">${itemCount} item${itemCount !== 1 ? 's' : ''}</td>
                        <td style="padding:12px 15px;font-weight:600;color:#27ae60;text-align:right;">$${tabAmount.toFixed(2)}</td>
                        <td style="padding:12px 15px;text-align:center;">
                            <button onclick="selectTab(${tab.id})" style="background:#4a90a4;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;margin-right:5px;"><i class="fas fa-plus"></i> Add Items</button>
                            <button onclick="closeTabWithPayment(${tab.id})" style="background:#27ae60;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:11px;"><i class="fas fa-check"></i> Close</button>
                        </td>
                    </tr>
                `}).join('');
            }
            
            // Update sidebar summary
            const openTabsCount = document.getElementById('summaryOpenTabs');
            if (openTabsCount) openTabsCount.textContent = openTabs.length;
        }
        
        // Refresh tabs view (for manual refresh button)
        function refreshTabsView() {
            loadTabs();
            renderOpenTabs();
            showToast('Tabs refreshed', 'success');
        }
        
        // Close tab with payment from tabs view
        function closeTabWithPayment(tabId) {
            const tab = openTabs.find(t => t.id == tabId);
            if (!tab) {
                showToast('Tab not found', 'error');
                return;
            }
            
            // Switch to this tab and open payment modal
            selectTab(tabId);
            setTimeout(() => {
                processPayment('quick');
            }, 100);
        }

        function renderCart() {
            const container = document.getElementById('cartItems');
            if (!container) return;
            
            if (cart.length === 0) {
                container.innerHTML = '<div class="cart-empty"><i class="fas fa-shopping-cart" style="font-size:40px;margin-bottom:10px;"></i><p>No items in cart</p></div>';
            } else {
                container.innerHTML = cart.map((item, i) => {
                    const price = item.price || 0;
                    const qty = item.qty || 1;
                    return `
                    <div class="cart-item">
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name || 'Item'}</div>
                            <div class="cart-item-price">$${price.toFixed(2)} each</div>
                        </div>
                        <div class="qty-controls">
                            <button class="qty-btn" onclick="changeQty(${i}, -1)">-</button>
                            <span class="qty-value">${qty}</span>
                            <button class="qty-btn" onclick="changeQty(${i}, 1)">+</button>
                        </div>
                        <div class="cart-item-total">$${(price * qty).toFixed(2)}</div>
                        <button class="cart-item-remove" onclick="removeFromCart(${i})"><i class="fas fa-trash"></i></button>
                    </div>
                `}).join('');
            }
            updateTotals();
        }

        function renderRecentTrans() {
            document.getElementById('recentTrans').innerHTML = transactions.slice(0, 5).map((t, i) => `
                <div class="trans-item" onclick="showTransactionDetail(${i})" style="cursor:pointer;">
                    <span class="trans-time">${t.time}</span>
                    <span>${t.customer}</span>
                    <span class="trans-amount">$${t.amount.toFixed(2)}</span>
                    <span>#${t.id}</span>
                </div>
            `).join('');
        }
        
        function showTransactionDetail(index) {
            const trans = transactions[index];
            if (!trans) return;
            
            // Build detailed modal
            const itemsHtml = trans.items && trans.items.length > 0 
                ? trans.items.map(i => `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #eee;"><span>${i.qty || 1}x ${i.name}</span><span>$${((i.price || 0) * (i.qty || 1)).toFixed(2)}</span></div>`).join('')
                : '<div style="color:#999;">No item details</div>';
            
            const html = `
                <div id="transDetailModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:95%;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                            <h3 style="margin:0;"><i class="fas fa-receipt"></i> Transaction #${trans.id}</h3>
                            <button onclick="document.getElementById('transDetailModal').remove()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="color:#666;">Customer</span>
                                <span style="font-weight:600;">${trans.customer}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="color:#666;">Date/Time</span>
                                <span>${trans.date || 'N/A'} ${trans.time}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="color:#666;">Payment Method</span>
                                <span>${trans.paymentMethod || trans.method || 'Card'}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span style="color:#666;">Employee</span>
                                <span>${trans.employee || trans.processedBy || 'Staff'}</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;font-size:13px;color:#666;">Items</h4>
                            ${itemsHtml}
                        </div>
                        
                        <div style="border-top:2px solid #333;padding-top:10px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                <span>Subtotal</span>
                                <span>$${(trans.subtotal || trans.amount / (1 + getTaxRate())).toFixed(2)}</span>
                            </div>
                            ${trans.discount ? `<div style="display:flex;justify-content:space-between;margin-bottom:5px;color:#27ae60;"><span>Discount</span><span>-$${trans.discount.toFixed(2)}</span></div>` : ''}
                            <div style="display:flex;justify-content:space-between;margin-bottom:5px;">
                                <span>${getTaxLabel()}</span>
                                <span>$${(trans.tax || trans.amount * getTaxRate() / (1 + getTaxRate())).toFixed(2)}</span>
                            </div>
                            ${trans.tip ? `<div style="display:flex;justify-content:space-between;margin-bottom:5px;color:#9b59b6;"><span>Tip</span><span>$${trans.tip.toFixed(2)}</span></div>` : ''}
                            <div style="display:flex;justify-content:space-between;font-weight:700;font-size:18px;margin-top:10px;">
                                <span>Total</span>
                                <span style="color:#27ae60;">$${trans.amount.toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:10px;margin-top:20px;">
                            <button onclick="document.getElementById('transDetailModal').remove()" style="flex:1;padding:12px;background:#f0f0f0;border:none;border-radius:6px;cursor:pointer;">Close</button>
                            <button onclick="printReceipt(transactions[${index}]); document.getElementById('transDetailModal').remove();" style="flex:1;padding:12px;background:#4a90a4;color:#fff;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-print"></i> Print Receipt</button>
                            <button onclick="refundTransaction(${index})" style="padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;"><i class="fas fa-undo"></i></button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function refundTransaction(index) {
            const trans = transactions[index];
            if (!trans) return;
            
            if (!confirm(`Refund $${trans.amount.toFixed(2)} to ${trans.customer}?\\n\\nThis action cannot be undone.`)) return;
            
            // Record refund
            const refund = {
                id: Date.now(),
                originalId: trans.id,
                customer: trans.customer,
                amount: -trans.amount,
                items: trans.items,
                type: 'refund',
                reason: prompt('Refund reason:') || 'Customer request',
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: new Date().toISOString().split('T')[0],
                processedBy: currentEmployee ? currentEmployee.name : 'Staff'
            };
            
            transactions.unshift(refund);
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            
            // Update customer stats (subtract refund)
            if (trans.customer && trans.customer !== 'Walk-in') {
                const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                const customer = customers.find(c => getCustomerFullName(c).toLowerCase() === trans.customer.toLowerCase());
                if (customer) {
                    customer.totalSpent = (customer.totalSpent || 0) - trans.amount;
                    localStorage.setItem('gc_customers', JSON.stringify(customers));
                }
            }
            
            // Close modal and refresh
            const modal = document.getElementById('transDetailModal');
            if (modal) modal.remove();
            
            renderRecentTrans();
            showToast(`Refund of $${trans.amount.toFixed(2)} processed`, 'success');
        }

        function renderSuspendedSales() {
            const container = document.getElementById('suspendedSales');
            if (!container) return; // Element doesn't exist in current layout
            
            const suspended = JSON.parse(localStorage.getItem('gc_suspended') || '[]');
            if (suspended.length === 0) {
                // Sample data if empty
                const sampleSuspended = [
                    { id: 9991, customer: 'Brett Huck', amount: 69.13, items: [] },
                    { id: 9972, customer: 'Dylan Vasp', amount: 42.54, items: [] },
                    { id: 9962, customer: 'Robert Nea', amount: 53.18, items: [] },
                ];
                container.innerHTML = sampleSuspended.map(s => `
                    <div class="suspended-item" onclick="resumeSale(${s.id})">
                        <div><strong>SIM: #${s.id}</strong><br>${s.customer}</div>
                        <div>$${s.amount.toFixed(2)}</div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = suspended.map(s => `
                    <div class="suspended-item" onclick="resumeSale(${s.id})">
                        <div><strong>Sale #${s.id}</strong><br>${s.customer}</div>
                        <div>$${s.amount.toFixed(2)}</div>
                    </div>
                `).join('');
            }
        }
        
        function renderSalesItems(filter = 'all') {
            const container = document.getElementById('salesItems');
            if (!container) return;
            const filteredItems = filter === 'all' ? items : items.filter(i => i.category === filter);
            
            container.innerHTML = filteredItems.map(item => `
                <div class="pos-item ${item.category}" onclick="addToCart('${item.name}', ${item.price})">
                    <i class="fas ${item.icon}"></i>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                </div>
            `).join('');
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const days = ['SU', 'MO', 'TU', 'WE', 'TH', 'FR', 'SA'];
            const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const today = new Date();
            
            let html = days.map(d => `<div class="calendar-day header">${d}</div>`).join('');
            for (let i = 0; i < firstDay; i++) html += '<div class="calendar-day"></div>';
            for (let i = 1; i <= daysInMonth; i++) {
                const isToday = i === today.getDate() && currentDate.getMonth() === today.getMonth() && currentDate.getFullYear() === today.getFullYear();
                html += `<div class="calendar-day ${isToday ? 'today' : ''}" onclick="selectDate(${i})">${i}</div>`;
            }
            grid.innerHTML = html;
            document.getElementById('calendarMonth').textContent = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        }

        // ============ CART FUNCTIONS ============
        function addToCart(name, price) {
            const existing = cart.find(i => i.name === name);
            if (existing) existing.qty++;
            else cart.push({ name, price, qty: 1 });
            
            // Reapply member discount if customer is a member
            if (memberDiscountApplied && currentCartCustomer) {
                applyMemberDiscount();
            }
            
            renderCart();
            showToast(`Added: ${name}`);
        }

        function removeFromCart(index) {
            const item = cart[index];
            cart.splice(index, 1);
            
            // Reapply member discount for remaining items
            if (memberDiscountApplied && currentCartCustomer && cart.length > 0) {
                applyMemberDiscount();
            } else if (cart.length === 0) {
                currentDiscount = 0;
            }
            
            renderCart();
            if (item) showToast(`Removed: ${item.name}`);
        }
        
        function clearCart() {
            if (cart.length === 0) return;
            cart = [];
            currentDiscount = 0;
            currentCartCustomer = null;
            memberDiscountApplied = false;
            updateCartMemberBadge(false);
            document.getElementById('customerSearch').value = '';
            renderCart();
            showToast('Cart cleared');
        }
        
        function changeQty(index, delta) {
            cart[index].qty += delta;
            if (cart[index].qty <= 0) {
                cart.splice(index, 1);
            }
            
            // Reapply member discount when quantity changes
            if (memberDiscountApplied && currentCartCustomer && cart.length > 0) {
                applyMemberDiscount();
            } else if (cart.length === 0) {
                currentDiscount = 0;
            } else {
                const newSubtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
                if (currentDiscount > newSubtotal) {
                    currentDiscount = newSubtotal;
                    showToast('Discount adjusted to match subtotal', 'error');
                }
            }
            renderCart();
        }
        
        // Phone number formatting
        function formatPhoneNumber(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length > 10) value = value.slice(0, 10);
            if (value.length >= 6) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3,6)}-${value.slice(6)}`;
            } else if (value.length >= 3) {
                input.value = `(${value.slice(0,3)}) ${value.slice(3)}`;
            } else if (value.length > 0) {
                input.value = `(${value}`;
            }
        }
        
        // Customer database
        let customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
        
        // Helper to get full name from customer object (handles both old and new formats)
        function getCustomerFullName(c) {
            if (c.firstName && c.lastName) return `${c.firstName} ${c.lastName}`;
            if (c.firstName) return c.firstName;
            if (c.name) return c.name;
            return 'Unknown';
        }
        
        function saveCustomer(name, phone, email) {
            if (!name) return;
            // Split name into firstName/lastName for consistency
            const nameParts = name.trim().split(/\s+/);
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            
            const existing = customers.find(c => {
                const fullName = getCustomerFullName(c).toLowerCase();
                return fullName === name.toLowerCase();
            });
            
            if (existing) {
                // Migrate old format to new format if needed
                if (existing.name && !existing.firstName) {
                    const parts = existing.name.trim().split(/\s+/);
                    existing.firstName = parts[0] || '';
                    existing.lastName = parts.slice(1).join(' ') || '';
                    delete existing.name;
                }
                if (phone) existing.phone = phone;
                if (email) existing.email = email;
            } else {
                customers.push({
                    id: Date.now(),
                    firstName: firstName,
                    lastName: lastName,
                    phone: phone || '',
                    email: email || '',
                    isMember: false,
                    memberType: null,
                    priceClass: 'Regular',
                    visitCount: 0,
                    totalSpent: 0,
                    createdAt: new Date().toISOString()
                });
            }
            localStorage.setItem('gc_customers', JSON.stringify(customers));
        }
        
        // Update customer stats after a transaction
        function updateCustomerStats(customerName, amount) {
            if (!customerName || customerName === 'Walk-In' || customerName === 'Walk-in') return;
            
            const customer = customers.find(c => {
                const fullName = getCustomerFullName(c).toLowerCase();
                return fullName === customerName.toLowerCase();
            });
            
            if (customer) {
                customer.totalSpent = (customer.totalSpent || 0) + amount;
                customer.visitCount = (customer.visitCount || 0) + 1;
                customer.lastVisit = new Date().toISOString();
                localStorage.setItem('gc_customers', JSON.stringify(customers));
            }
        }

        function updateTotals() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discountedSubtotal = subtotal - currentDiscount;
            const tax = calculateTax(discountedSubtotal);
            const total = discountedSubtotal + tax;
            
            document.getElementById('subtotal').textContent = formatCurrency(subtotal);
            document.getElementById('taxAmount').textContent = formatCurrency(tax);
            document.getElementById('totalDue').textContent = formatCurrency(total);
            document.getElementById('totalAmount').textContent = total.toFixed(2);
            
            // Update tax label dynamically
            document.querySelectorAll('[data-tax-label]').forEach(el => {
                el.textContent = getTaxLabel();
            });
            
            // Show/hide discount row
            const discountRow = document.getElementById('discountRow');
            if (currentDiscount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('discountAmount').textContent = '-' + formatCurrency(currentDiscount);
            } else {
                discountRow.style.display = 'none';
            }
        }
        
        function applyDiscount() {
            if (cart.length === 0) return showToast('Add items first', 'error');
            const discountType = prompt('Enter discount:\\n- Percentage (e.g., "10%")\\n- Dollar amount (e.g., "5")\\n- Or cancel');
            if (!discountType) return;
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            if (discountType.includes('%')) {
                const pct = parseFloat(discountType.replace('%', ''));
                if (isNaN(pct) || pct < 0 || pct > 100) {
                    return showToast('Invalid percentage (0-100)', 'error');
                }
                currentDiscount = subtotal * (pct / 100);
                showToast(`${pct}% discount applied`);
            } else {
                const dollarAmount = parseFloat(discountType);
                if (isNaN(dollarAmount) || dollarAmount < 0) {
                    return showToast('Invalid amount', 'error');
                }
                if (dollarAmount > subtotal) {
                    return showToast('Discount cannot exceed subtotal', 'error');
                }
                currentDiscount = dollarAmount;
                showToast(`$${currentDiscount.toFixed(2)} discount applied`);
            }
            updateTotals();
        }

        let currentPayMethod = 'card';
        let currentPayTotal = 0;
        let payingTabId = null; // Track if we're paying a tab
        
        function cancelPayment() {
            // If we were paying a tab, restore the tab (don't close it)
            if (payingTabId) {
                // Clear the cart since we loaded tab items into it
                cart = [];
                currentDiscount = 0;
                currentCartCustomer = null;
                currentCartCustomerIsMember = false;
                memberDiscountApplied = false;
                updateCartMemberBadge(false);
                document.getElementById('customerSearch').value = '';
                renderCart();
                payingTabId = null;
                showToast('Payment cancelled - tab kept open', 'info');
            }
            hideModal('payment');
        }
        
        function processPayment(method) {
            if (cart.length === 0) return showToast('Cart is empty', 'error');
            
            // Calculate totals
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discountedSubtotal = subtotal - currentDiscount;
            const tax = calculateTax(discountedSubtotal);
            currentPayTotal = discountedSubtotal + tax;
            
            // Populate payment modal
            document.getElementById('paySubtotal').textContent = formatCurrency(subtotal);
            document.getElementById('payTax').textContent = formatCurrency(tax);
            document.getElementById('payTotal').textContent = formatCurrency(currentPayTotal);
            
            if (currentDiscount > 0) {
                document.getElementById('payDiscountRow').style.display = 'flex';
                document.getElementById('payDiscount').textContent = '-$' + currentDiscount.toFixed(2);
            } else {
                document.getElementById('payDiscountRow').style.display = 'none';
            }
            
            // Reset payment modal state
            currentPayMethod = 'card';
            document.getElementById('cashSection').style.display = 'none';
            document.getElementById('cardSection').style.display = 'block';
            document.getElementById('giftcardSection').style.display = 'none';
            document.getElementById('tabSection').style.display = 'none';
            document.getElementById('cashTendered').value = '';
            document.getElementById('changeSection').style.display = 'none';
            document.getElementById('giftCardNumber').value = '';
            document.getElementById('giftCardInfo').style.display = 'none';
            
            // Hide Tab button if we're paying a tab (can't add tab to tab)
            const tabPayBtn = document.querySelector('.pay-method-btn[onclick*="tab"]');
            if (tabPayBtn) {
                tabPayBtn.style.display = payingTabId ? 'none' : 'flex';
            }
            
            // Reset button states
            document.querySelectorAll('.pay-method-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = '#fff';
                btn.style.color = '#333';
                btn.style.borderColor = '#ddd';
            });
            const cardBtn = document.querySelector('.pay-method-btn');
            if (cardBtn) {
                cardBtn.classList.add('active');
                cardBtn.style.background = '#4a90a4';
                cardBtn.style.color = '#fff';
                cardBtn.style.borderColor = '#4a90a4';
            }
            
            showModal('payment');
        }
        
        function selectPayMethod(method, btn) {
            currentPayMethod = method;
            document.querySelectorAll('.pay-method-btn').forEach(b => {
                b.classList.remove('active');
                b.style.background = '#fff';
                b.style.color = '#333';
                b.style.borderColor = '#ddd';
            });
            btn.classList.add('active');
            btn.style.background = '#4a90a4';
            btn.style.color = '#fff';
            btn.style.borderColor = '#4a90a4';
            
            // Hide all payment sections
            document.getElementById('cashSection').style.display = 'none';
            document.getElementById('cardSection').style.display = 'none';
            document.getElementById('giftcardSection').style.display = 'none';
            document.getElementById('tabSection').style.display = 'none';
            
            // Show relevant section
            if (method === 'cash') {
                document.getElementById('cashSection').style.display = 'block';
            } else if (method === 'card') {
                document.getElementById('cardSection').style.display = 'block';
                updateCardSectionUI();
            } else if (method === 'giftcard') {
                document.getElementById('giftcardSection').style.display = 'block';
            } else if (method === 'tab') {
                document.getElementById('tabSection').style.display = 'block';
            }
        }
        
        // Update card section based on Stripe Terminal connection status
        function updateCardSectionUI() {
            const titleEl = document.getElementById('cardSectionTitle');
            const descEl = document.getElementById('cardSectionDesc');
            const actionsEl = document.getElementById('stripeTerminalActions');
            const cardSection = document.getElementById('cardSection');
            
            if (connectedReader) {
                // Stripe Terminal connected
                titleEl.textContent = 'Stripe Terminal Connected';
                descEl.textContent = 'Click the button below to charge the card on your reader.';
                cardSection.style.background = '#ede7f6';
                cardSection.querySelector('i').style.color = '#635bff';
                actionsEl.style.display = 'block';
            } else if (localStorage.getItem('gc_stripe_pk')) {
                // Stripe configured but no reader connected
                titleEl.textContent = 'No Card Reader Connected';
                descEl.innerHTML = 'Connect a Stripe Terminal reader or process payment on your external terminal. <a href="#" onclick="showReaderSetup(); return false;" style="color:#1565c0;">Connect Reader</a>';
                cardSection.style.background = '#fff3e0';
                actionsEl.style.display = 'none';
            } else {
                // No Stripe configured - external terminal mode
                titleEl.textContent = 'Process on External Terminal';
                descEl.textContent = 'Complete the card payment on your card reader, then click "Complete Payment" to record the transaction.';
                cardSection.style.background = '#e3f2fd';
                actionsEl.style.display = 'none';
            }
        }
        
        // Initiate payment on Stripe Terminal
        let stripePaymentInProgress = false;
        
        async function initiateStripePayment() {
            if (stripePaymentInProgress) return;
            
            const btn = document.getElementById('stripePayBtn');
            const statusEl = document.getElementById('stripePaymentStatus');
            
            stripePaymentInProgress = true;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Waiting for card...';
            statusEl.style.display = 'block';
            statusEl.style.background = '#fff3e0';
            statusEl.innerHTML = '<i class="fas fa-hand-pointer"></i> Present card on reader...';
            
            const amountCents = Math.round(currentPayTotal * 100);
            const description = `Golf Cove POS - ${document.getElementById('customerSearch').value || 'Walk-In'}`;
            
            const result = await processStripeTerminalPayment(amountCents, description);
            
            if (result.success) {
                statusEl.style.background = '#e8f5e9';
                statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:#27ae60;"></i> Payment successful!';
                btn.innerHTML = '<i class="fas fa-check"></i> Card Charged';
                btn.style.background = '#27ae60';
                
                // Auto-complete the payment
                setTimeout(() => {
                    completePaymentWithStripe(result.paymentIntentId);
                }, 1000);
            } else if (result.fallback) {
                // No reader - fall back to manual mode
                statusEl.style.display = 'none';
                btn.innerHTML = '<i class="fas fa-credit-card"></i> Charge Card on Reader';
                btn.disabled = false;
                stripePaymentInProgress = false;
                showToast('No reader connected. Process on external terminal.', 'info');
            } else {
                statusEl.style.background = '#ffebee';
                statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> ' + (result.error || 'Payment failed');
                btn.innerHTML = '<i class="fas fa-redo"></i> Try Again';
                btn.disabled = false;
                stripePaymentInProgress = false;
            }
        }
        
        // Complete payment after successful Stripe charge
        function completePaymentWithStripe(paymentIntentId) {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discountedSubtotal = subtotal - currentDiscount;
            const tax = calculateTax(discountedSubtotal);
            
            const cartItems = [...cart];
            transactions.unshift({
                id: 26763 + transactions.length,
                customer: document.getElementById('customerSearch').value || 'Walk-In',
                amount: currentPayTotal,
                subtotal: discountedSubtotal,
                tax: tax,
                items: cartItems,
                itemDetails: cartItems.map(i => ({ name: i.name, qty: i.qty, price: i.price, discount: i.discount || 0 })),
                itemCount: cart.reduce((sum, item) => sum + item.qty, 0),
                method: 'stripe',
                methodDisplay: 'Stripe Terminal',
                stripePaymentIntentId: paymentIntentId,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: new Date().toISOString(),
                discount: currentDiscount,
                isReturn: false,
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            });
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            
            // Update daily sales tracking for analytics
            const today = new Date().toDateString();
            const dailySales = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            if (!dailySales[today]) {
                dailySales[today] = { total: 0, count: 0, cash: 0, card: 0, giftcard: 0 };
            }
            dailySales[today].total += currentPayTotal;
            dailySales[today].count += 1;
            dailySales[today].card = (dailySales[today].card || 0) + currentPayTotal;
            localStorage.setItem('gc_daily_sales', JSON.stringify(dailySales));
            
            // Update customer stats
            const customerName = document.getElementById('customerSearch').value;
            if (customerName) {
                updateCustomerStats(customerName, currentPayTotal);
            }
            
            // If we were paying a tab, finalize the tab close
            if (payingTabId) {
                finalizeTabClose(payingTabId, 'stripe');
                payingTabId = null;
                selectedTabId = null;
            }
            
            // Ask to print receipt
            if (confirm('Print receipt?')) {
                printReceipt(transactions[0]);
            }
            
            hideModal('payment');
            cart = [];
            currentDiscount = 0;
            currentCartCustomer = null;
            currentCartCustomerIsMember = false;
            memberDiscountApplied = false;
            stripePaymentInProgress = false;
            
            // Reset button state
            const btn = document.getElementById('stripePayBtn');
            btn.innerHTML = '<i class="fas fa-credit-card"></i> Charge Card on Reader';
            btn.style.background = '#635bff';
            btn.disabled = false;
            document.getElementById('stripePaymentStatus').style.display = 'none';
            
            document.getElementById('customerSearch').value = '';
            renderCart();
            renderRecentTrans();
            showToast(`Payment of $${currentPayTotal.toFixed(2)} processed via Stripe Terminal!`, 'success');
        }
        
        function lookupGiftCard() {
            const code = document.getElementById('giftCardNumber').value.trim();
            if (!code) {
                showToast('Please enter a gift card code', 'error');
                return;
            }
            
            // Look up gift card from local storage
            const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '[]');
            const card = giftCards.find(gc => gc.code.toUpperCase() === code.toUpperCase());
            
            const infoDiv = document.getElementById('giftCardInfo');
            if (card) {
                if (card.balance <= 0) {
                    infoDiv.innerHTML = `<div style="color:#e74c3c;"><i class="fas fa-times-circle"></i> This gift card has no remaining balance.</div>`;
                } else if (card.balance < currentPayTotal) {
                    infoDiv.innerHTML = `
                        <div style="color:#f57c00;">
                            <i class="fas fa-exclamation-triangle"></i> <strong>Balance: $${card.balance.toFixed(2)}</strong><br>
                            <span style="font-size:12px;">This will cover $${card.balance.toFixed(2)} of the $${currentPayTotal.toFixed(2)} total. Remaining $${(currentPayTotal - card.balance).toFixed(2)} will need another payment method.</span>
                        </div>`;
                } else {
                    infoDiv.innerHTML = `<div style="color:#27ae60;"><i class="fas fa-check-circle"></i> <strong>Balance: $${card.balance.toFixed(2)}</strong> - Sufficient for this purchase!</div>`;
                }
                infoDiv.style.display = 'block';
            } else {
                infoDiv.innerHTML = `<div style="color:#e74c3c;"><i class="fas fa-times-circle"></i> Gift card not found. Please check the code.</div>`;
                infoDiv.style.display = 'block';
            }
        }
        
        function quickCash(amount) {
            if (amount === 'exact') {
                document.getElementById('cashTendered').value = currentPayTotal.toFixed(2);
            } else {
                document.getElementById('cashTendered').value = amount.toFixed(2);
            }
            calculateChange();
        }
        
        function calculateChange() {
            const tendered = parseFloat(document.getElementById('cashTendered').value) || 0;
            const changeSection = document.getElementById('changeSection');
            
            if (tendered >= currentPayTotal) {
                const change = tendered - currentPayTotal;
                document.getElementById('changeAmount').textContent = '$' + change.toFixed(2);
                changeSection.style.display = 'block';
            } else {
                changeSection.style.display = 'none';
            }
        }
        
        function completePayment() {
            // Validate based on payment method
            if (currentPayMethod === 'cash') {
                const tendered = parseFloat(document.getElementById('cashTendered').value) || 0;
                if (tendered < currentPayTotal) {
                    return showToast('Insufficient cash tendered', 'error');
                }
            }
            
            if (currentPayMethod === 'giftcard') {
                const code = document.getElementById('giftCardNumber').value.trim();
                if (!code) {
                    return showToast('Please enter a gift card code', 'error');
                }
                // Process gift card payment
                const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '[]');
                const cardIndex = giftCards.findIndex(gc => gc.code.toUpperCase() === code.toUpperCase());
                if (cardIndex === -1) {
                    return showToast('Gift card not found', 'error');
                }
                if (giftCards[cardIndex].balance <= 0) {
                    return showToast('Gift card has no balance', 'error');
                }
                
                // Check if gift card balance covers the full amount
                const cardBalance = giftCards[cardIndex].balance;
                if (cardBalance < currentPayTotal) {
                    const remaining = currentPayTotal - cardBalance;
                    const usePartial = confirm(`Gift card balance ($${cardBalance.toFixed(2)}) is less than the total ($${currentPayTotal.toFixed(2)}).\n\nRemaining amount needed: $${remaining.toFixed(2)}\n\nWould you like to:\n- OK: Use gift card for $${cardBalance.toFixed(2)} and pay remaining $${remaining.toFixed(2)} another way\n- Cancel: Cancel and choose a different payment method`);
                    
                    if (!usePartial) {
                        return; // User cancelled - don't process partial payment
                    }
                    
                    // Deduct full gift card balance
                    giftCards[cardIndex].balance = 0;
                    giftCards[cardIndex].lastUsed = new Date().toISOString();
                    localStorage.setItem('gc_gift_cards', JSON.stringify(giftCards));
                    
                    // Record partial payment and prompt for remainder
                    showToast(`Gift card applied: $${cardBalance.toFixed(2)}. Collect remaining $${remaining.toFixed(2)} via another method.`, 'warning');
                    
                    // Update the payment total to show remaining amount
                    currentPayTotal = remaining;
                    document.getElementById('payTotal').textContent = formatCurrency(remaining);
                    
                    // Switch to another payment method for the remainder
                    document.getElementById('giftCardNumber').value = '';
                    selectPaymentMethod('card'); // Default to card for remainder
                    return; // Don't complete sale yet - need remaining payment
                }
                
                // Full payment covered by gift card
                giftCards[cardIndex].balance -= currentPayTotal;
                giftCards[cardIndex].lastUsed = new Date().toISOString();
                localStorage.setItem('gc_gift_cards', JSON.stringify(giftCards));
                showToast(`Gift card payment successful. Remaining balance: $${giftCards[cardIndex].balance.toFixed(2)}`, 'success');
            }
            
            if (currentPayMethod === 'tab') {
                // Add to customer's tab instead of completing payment
                const customerName = document.getElementById('customerSearch').value;
                if (!customerName) {
                    return showToast('Please select a customer to add to tab', 'error');
                }
                addToTabFromCart(customerName);
                hideModal('payment');
                return;
            }
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discountedSubtotal = subtotal - currentDiscount;
            const tax = calculateTax(discountedSubtotal);
            
            // Friendly method names for display
            const methodNames = {
                'card': 'Card (External Terminal)',
                'cash': 'Cash',
                'giftcard': 'Gift Card',
                'tab': 'Tab'
            };
            
            const cartItems = [...cart];
            transactions.unshift({
                id: 26763 + transactions.length,
                customer: document.getElementById('customerSearch').value || 'Walk-In',
                customerId: currentCartCustomer ? currentCartCustomer.id : null,
                isMember: currentCartCustomer ? GolfCoveMembership.isActiveMember(currentCartCustomer) : false,
                memberType: currentCartCustomer ? currentCartCustomer.memberType : null,
                amount: currentPayTotal,
                subtotal: discountedSubtotal,
                tax: tax,
                items: cartItems,
                itemDetails: cartItems.map(i => ({ name: i.name, qty: i.qty, price: i.price, discount: i.discount || 0 })),
                itemCount: cart.reduce((sum, item) => sum + item.qty, 0),
                method: currentPayMethod,
                methodDisplay: methodNames[currentPayMethod] || currentPayMethod,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: new Date().toISOString(),
                discount: currentDiscount,
                discountType: memberDiscountApplied ? 'member' : (currentDiscount > 0 ? 'manual' : null),
                isReturn: false,
                register: localStorage.getItem('gc_register_id') || 'POS-1',
                giftCardCode: currentPayMethod === 'giftcard' ? document.getElementById('giftCardNumber').value.trim() : null,
                employee: currentEmployee ? currentEmployee.name : null
            });
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            
            // Update daily sales tracking for analytics
            const today = new Date().toDateString();
            const dailySales = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            if (!dailySales[today]) {
                dailySales[today] = { total: 0, count: 0, cash: 0, card: 0, giftcard: 0 };
            }
            dailySales[today].total += currentPayTotal;
            dailySales[today].count += 1;
            if (currentPayMethod === 'cash') {
                dailySales[today].cash = (dailySales[today].cash || 0) + currentPayTotal;
                // Kick physical drawer on cash sale
                if (window.CashDrawer) {
                    CashDrawer.kick();
                }
            } else if (currentPayMethod === 'card') {
                dailySales[today].card = (dailySales[today].card || 0) + currentPayTotal;
            } else if (currentPayMethod === 'giftcard') {
                dailySales[today].giftcard = (dailySales[today].giftcard || 0) + currentPayTotal;
            }
            localStorage.setItem('gc_daily_sales', JSON.stringify(dailySales));
            
            // Update customer stats
            const customerName = document.getElementById('customerSearch').value;
            if (customerName) {
                updateCustomerStats(customerName, currentPayTotal);
            }
            
            // If we were paying a tab, finalize the tab close
            if (payingTabId) {
                finalizeTabClose(payingTabId, currentPayMethod);
                payingTabId = null;
                selectedTabId = null;
            }
            
            // Ask to print receipt
            if (confirm('Print receipt?')) {
                printReceipt(transactions[0]);
            }
            
            hideModal('payment');
            cart = [];
            currentDiscount = 0;
            currentCartCustomer = null;
            currentCartCustomerIsMember = false;
            memberDiscountApplied = false;
            updateCartMemberBadge(false);
            document.getElementById('customerSearch').value = '';
            renderCart();
            renderRecentTrans();
            showToast(`Payment of $${currentPayTotal.toFixed(2)} processed via ${methodNames[currentPayMethod] || currentPayMethod}!`, 'success');
        }
        
        async function addToTabFromCart(customerName) {
            if (cart.length === 0) {
                showToast('Add items to cart first', 'error');
                return;
            }
            
            const employeeName = getCurrentUserName();
            
            // Format cart items for TabsSync
            const items = cart.map(item => ({
                name: item.name,
                price: parseFloat(item.price) || 0,
                qty: parseInt(item.qty) || 1,
                category: item.category || 'misc'
            }));
            
            try {
                // Use TabsSync for synced tab management
                if (typeof TabsSync !== 'undefined') {
                    const existingTab = TabsSync.getTabByCustomer(customerName);
                    
                    if (existingTab) {
                        await TabsSync.addItemsToTab(existingTab.id, items, employeeName);
                        showToast(`${items.length} item(s) added to ${customerName}'s tab!`, 'success');
                    } else {
                        // Look up customer for member info
                        let customerId = null;
                        if (typeof GolfCoveCustomers !== 'undefined') {
                            const parts = customerName.trim().split(' ');
                            if (parts.length >= 2) {
                                const customer = GolfCoveCustomers.getByName(parts[0], parts.slice(1).join(' '));
                                if (customer) customerId = customer.id;
                            }
                        }
                        
                        await TabsSync.createTab(customerName, customerId, items, employeeName);
                        showToast(`Tab started for ${customerName}!`, 'success');
                    }
                    
                    // Reload tabs from TabsSync
                    openTabs = TabsSync.getAllTabs();
                } else {
                    // Fallback to local storage
                    let tab = openTabs.find(t => t.customer && t.customer.toLowerCase() === customerName.toLowerCase());
                    if (!tab) {
                        const itemsTotal = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                        tab = {
                            id: Date.now().toString(),
                            customer: customerName,
                            items: items,
                            subtotal: itemsTotal,
                            total: itemsTotal * (1 + getTaxRate()),
                            amount: itemsTotal * (1 + getTaxRate()),
                            createdAt: new Date().toISOString(),
                            openedBy: employeeName
                        };
                        openTabs.push(tab);
                    } else {
                        items.forEach(item => {
                            const existing = tab.items.find(i => i.name === item.name && i.price === item.price);
                            if (existing) {
                                existing.qty += item.qty;
                            } else {
                                tab.items.push({...item});
                            }
                        });
                        tab.subtotal = tab.items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                        tab.total = tab.subtotal * (1 + getTaxRate());
                        tab.amount = tab.total;
                    }
                    saveTabs();
                    showToast(`Items added to ${customerName}'s tab!`, 'success');
                }
                
                cart = [];
                currentDiscount = 0;
                renderCart();
                renderOpenTabs();
            } catch (error) {
                console.error('Error adding to tab:', error);
                showToast('Failed to add items to tab', 'error');
            }
        }
        
        function printReceipt(transaction) {
            const receiptWindow = window.open('', '_blank', 'width=400,height=600');
            const now = new Date();
            const dateStr = now.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
            
            const itemsHtml = transaction.items ? transaction.items.map(item => 
                '<tr><td style="padding:5px 0;">' + item.name + '</td><td style="padding:5px 0;text-align:center;">' + item.qty + '</td><td style="padding:5px 0;text-align:right;">$' + (item.price * item.qty).toFixed(2) + '</td></tr>'
            ).join('') : '<tr><td colspan="3">Items not recorded</td></tr>';
            
            const subtotal = transaction.items ? transaction.items.reduce((sum, i) => sum + i.price * i.qty, 0) : transaction.amount / (1 + getTaxRate());
            const discount = transaction.discount || 0;
            const discountedSubtotal = subtotal - discount;
            const tax = calculateTax(discountedSubtotal);
            
            // Show discount with type (member vs manual)
            const discountLabel = transaction.discountType === 'member' ? 'Member Discount:' : 'Discount:';
            const discountHtml = discount > 0 ? '<div style="color:green;"><span>' + discountLabel + '</span><span>-$' + discount.toFixed(2) + '</span></div>' : '';
            
            // Show member badge if applicable
            const memberBadge = transaction.isMember ? '<span style="background:#f1c40f;color:#333;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:bold;">MEMBER</span>' : '';
            
            const receiptHtml = '<!DOCTYPE html><html><head><title>Receipt #' + transaction.id + '</title>' +
                '<style>body { font-family: "Courier New", monospace; padding: 20px; max-width: 300px; margin: 0 auto; font-size: 12px; }' +
                '.header { text-align: center; margin-bottom: 20px; } .header h1 { font-size: 18px; margin: 0; } .header p { margin: 5px 0; color: #666; }' +
                '.divider { border-top: 1px dashed #333; margin: 10px 0; } table { width: 100%; }' +
                '.totals { margin-top: 10px; } .totals div { display: flex; justify-content: space-between; padding: 3px 0; }' +
                '.totals .total { font-weight: bold; font-size: 14px; border-top: 1px solid #333; padding-top: 5px; margin-top: 5px; }' +
                '.footer { text-align: center; margin-top: 20px; font-size: 11px; color: #666; }' +
                '@media print { body { padding: 0; } }</style></head><body>' +
                '<div class="header"><h1>GOLF COVE</h1><p>Indoor Golf & Bar</p><p>' + dateStr + ' ' + transaction.time + '</p><p>Receipt #' + transaction.id + '</p></div>' +
                '<div class="divider"></div><p><strong>Customer:</strong> ' + transaction.customer + ' ' + memberBadge + '</p>' +
                (transaction.employee ? '<p style="color:#666;font-size:10px;">Served by: ' + transaction.employee + '</p>' : '') +
                '<div class="divider"></div>' +
                '<table><thead><tr><th style="text-align:left;">Item</th><th style="text-align:center;">Qty</th><th style="text-align:right;">Price</th></tr></thead>' +
                '<tbody>' + itemsHtml + '</tbody></table><div class="divider"></div>' +
                '<div class="totals"><div><span>Subtotal:</span><span>$' + subtotal.toFixed(2) + '</span></div>' + discountHtml +
                '<div><span>' + getTaxLabel() + ':</span><span>$' + tax.toFixed(2) + '</span></div>' +
                '<div class="total"><span>TOTAL:</span><span>$' + transaction.amount.toFixed(2) + '</span></div>' +
                '<div><span>Method:</span><span>' + (transaction.methodDisplay || transaction.method || 'Card') + '</span></div></div>' +
                '<div class="divider"></div><div class="footer"><p>Thank you for visiting Golf Cove!</p><p>336 State Street, North Haven, CT</p><p>www.golfcovect.com</p></div>' +
                '<scr' + 'ipt>window.print(); setTimeout(function() { window.close(); }, 500);</scr' + 'ipt>' +
                '</bo' + 'dy></ht' + 'ml>';
            
            receiptWindow.document.write(receiptHtml);
            receiptWindow.document.close();
        }

        function filterItems(category, el) {
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
            if (el) el.classList.add('active');
            renderSalesItems(category);
        }
        
        function suspendSale() {
            if (cart.length === 0) return showToast('Cart is empty', 'error');
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const total = subtotal * (1 + getTaxRate());
            const suspended = JSON.parse(localStorage.getItem('gc_suspended') || '[]');
            suspended.push({
                id: Date.now(),
                customer: document.getElementById('customerSearch').value || 'No Customer',
                amount: total,
                items: [...cart]
            });
            localStorage.setItem('gc_suspended', JSON.stringify(suspended));
            cart = [];
            currentDiscount = 0;
            renderCart();
            renderSuspendedSales();
            showToast('Sale suspended');
        }
        
        function resumeSale(id) {
            const suspended = JSON.parse(localStorage.getItem('gc_suspended') || '[]');
            const sale = suspended.find(s => s.id === id);
            if (sale && sale.items) {
                cart = [...sale.items];
                renderCart();
                // Remove from suspended
                localStorage.setItem('gc_suspended', JSON.stringify(suspended.filter(s => s.id !== id)));
                renderSuspendedSales();
                showToast('Sale resumed');
            }
        }
        
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ============ BOOKING FUNCTIONS (Using GolfCoveBooking System) ============
        let selectedBookingMemberType = null;
        
        function handleCreateBooking(e) {
            e.preventDefault();
            
            const customerName = document.getElementById('bookingCustomer').value;
            const room = parseInt(document.getElementById('bookingRoom').value);
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const duration = parseInt(document.getElementById('bookingDuration').value);
            const players = parseInt(document.getElementById('bookingPlayers').value);
            const phone = document.getElementById('bookingPhone').value || '';
            const email = document.getElementById('bookingEmail').value || '';
            const notes = document.getElementById('bookingNotes').value || '';
            const source = document.getElementById('bookingSource').value;
            const isRecurring = document.getElementById('bookingRecurring').checked;
            
            // Save customer to database
            saveCustomer(customerName, phone, email);
            
            const bookingData = {
                customer: customerName,
                room: room,
                date: date,
                time: time,
                duration: duration,
                players: players,
                phone: phone,
                email: email,
                notes: notes,
                source: source,
                memberType: selectedBookingMemberType,
                createdBy: currentEmployee ? currentEmployee.name : 'POS'
            };
            
            let result;
            if (isRecurring) {
                const recurringType = document.getElementById('recurringType').value;
                const recurringCount = parseInt(document.getElementById('recurringCount').value);
                result = GolfCoveBooking.createRecurringBooking(bookingData, { 
                    type: recurringType, 
                    count: recurringCount 
                });
                if (result.success) {
                    showToast(`Created ${result.created} recurring bookings for ${customerName}`, 'success');
                }
            } else {
                result = GolfCoveBooking.createBooking(bookingData);
                if (result.success) {
                    showToast(`Booking created for ${customerName}`, 'success');
                    
                    // Add rental to cart for immediate payment option
                    const pricing = result.booking.price || 45;
                    if (confirm(`Add Room ${room} rental ($${pricing.toFixed(2)}) to cart for payment?`)) {
                        addToCart(`Room ${room} - ${duration}hr`, pricing);
                    }
                }
            }
            
            if (!result.success) {
                showToast(result.error || 'Failed to create booking', 'error');
                return;
            }
            
            // Refresh bookings from storage
            bookings = JSON.parse(localStorage.getItem('gc_bookings') || '[]');
            
            hideModal('booking');
            renderTeeSheet();
            
            // Offer email confirmation
            if (email && confirm('Send confirmation email to ' + email + '?')) {
                sendConfirmationEmail(result.booking || result.bookings[0]);
            }
            
            document.getElementById('bookingForm').reset();
            selectedBookingMemberType = null;
            document.getElementById('bookingMemberBadge').style.display = 'none';
        }
        
        function checkBookingAvailability() {
            const room = parseInt(document.getElementById('bookingRoom').value);
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const duration = parseInt(document.getElementById('bookingDuration').value);
            
            if (!date || !time) return;
            
            const checkDiv = document.getElementById('availabilityCheck');
            const isAvailable = GolfCoveBooking.isSlotAvailable(room, date, time, duration);
            
            if (isAvailable) {
                checkDiv.style.display = 'block';
                checkDiv.style.background = '#e8f5e9';
                checkDiv.style.color = '#2e7d32';
                checkDiv.innerHTML = '<i class="fas fa-check-circle"></i> Time slot is available!';
            } else {
                checkDiv.style.display = 'block';
                checkDiv.style.background = '#ffebee';
                checkDiv.style.color = '#c62828';
                checkDiv.innerHTML = '<i class="fas fa-times-circle"></i> Time slot is not available. Try another time or add to waitlist.';
            }
            
            updateBookingPrice();
        }
        
        function updateBookingPrice() {
            const duration = parseInt(document.getElementById('bookingDuration').value);
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            
            if (!date || !time) return;
            
            const pricing = GolfCoveBooking.calculatePrice(duration, date, time, selectedBookingMemberType);
            
            document.getElementById('bookingBasePrice').textContent = '$' + (pricing.basePrice - pricing.peakSurcharge).toFixed(2);
            
            // Peak surcharge
            const peakRow = document.getElementById('bookingPeakRow');
            if (pricing.peakSurcharge > 0) {
                peakRow.style.display = 'flex';
            } else {
                peakRow.style.display = 'none';
            }
            
            // Member discount
            const discountRow = document.getElementById('bookingDiscountRow');
            if (pricing.memberDiscount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('bookingDiscountAmount').textContent = '-$' + pricing.memberDiscount.toFixed(2);
            } else {
                discountRow.style.display = 'none';
            }
            
            document.getElementById('bookingTotalPrice').textContent = '$' + pricing.finalPrice.toFixed(2);
        }
        
        function toggleRecurringOptions() {
            const isRecurring = document.getElementById('bookingRecurring').checked;
            document.getElementById('recurringOptions').style.display = isRecurring ? 'block' : 'none';
        }
        
        function addToWaitlistFromModal() {
            const customerName = document.getElementById('bookingCustomer').value;
            const room = parseInt(document.getElementById('bookingRoom').value);
            const date = document.getElementById('bookingDate').value;
            const time = document.getElementById('bookingTime').value;
            const duration = parseInt(document.getElementById('bookingDuration').value);
            const phone = document.getElementById('bookingPhone').value || '';
            const email = document.getElementById('bookingEmail').value || '';
            
            if (!customerName) {
                showToast('Please enter customer name', 'error');
                return;
            }
            
            const result = GolfCoveBooking.addToWaitlist({
                customer: customerName,
                room: room,
                date: date,
                time: time,
                duration: duration,
                phone: phone,
                email: email
            });
            
            if (result.success) {
                showToast(`${customerName} added to waitlist`, 'success');
                hideModal('booking');
                document.getElementById('bookingForm').reset();
            } else {
                showToast('Failed to add to waitlist', 'error');
            }
        }
        
        async function sendConfirmationEmail(booking) {
            if (!booking.email) {
                showToast('No email address for this booking', 'error');
                return;
            }
            
            try {
                // Try to send via backend API
                const response = await fetch('/api/sendBookingConfirmation', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ booking })
                });
                
                if (response.ok) {
                    showToast('Confirmation email sent!', 'success');
                } else {
                    // Fallback to mailto if API fails
                    fallbackMailto(booking);
                }
            } catch (error) {
                // Fallback to mailto if API unavailable
                fallbackMailto(booking);
            }
        }
        
        function fallbackMailto(booking) {
            const subject = encodeURIComponent('Golf Cove Booking Confirmation');
            const dateStr = new Date(booking.date).toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
            const body = encodeURIComponent(
                `Hi ${booking.customer},\n\n` +
                `Your booking at Golf Cove is confirmed!\n\n` +
                `Details:\n` +
                `- Bay: Bay ${booking.room}\n` +
                `- Date: ${dateStr}\n` +
                `- Time: ${booking.time}\n` +
                `- Duration: ${booking.duration} hour(s)\n` +
                `- Players: ${booking.players}\n` +
                `- Total: $${(booking.price || 0).toFixed(2)}\n\n` +
                `See you soon!\n` +
                `Golf Cove Team\n\n` +
                `---\n` +
                `Need to cancel or reschedule? Reply to this email or call us at (203) 390-5994.`
            );
            window.open(`mailto:${booking.email}?subject=${subject}&body=${body}`);
            showToast('Email client opened', 'info');
        }

        function quickBook(room, time) {
            document.getElementById('bookingRoom').value = room;
            document.getElementById('bookingTime').value = time;
            const selectedDate = document.getElementById('teeSheetDate')?.value || new Date().toISOString().split('T')[0];
            document.getElementById('bookingDate').value = selectedDate;
            checkBookingAvailability();
            updateBookingPrice();
            showModal('booking');
        }

        function selectBooking(id) {
            const booking = GolfCoveBooking.get(id);
            if (booking) {
                selectedBookingId = id;
                
                // Basic info
                document.getElementById('detailCustomer').textContent = booking.customer;
                document.getElementById('detailRoom').textContent = GolfCoveBooking.getRoomName(booking.roomId);
                document.getElementById('detailTime').textContent = booking.time + ' - ' + booking.date;
                document.getElementById('detailDuration').textContent = booking.duration + ' hour(s)';
                document.getElementById('detailPlayers').textContent = booking.players + ' player(s)';
                
                // Status with color
                const statusColors = {
                    pending: '#f39c12',
                    confirmed: '#3498db',
                    'checked-in': '#27ae60',
                    completed: '#95a5a6',
                    'no-show': '#e74c3c',
                    cancelled: '#95a5a6'
                };
                const statusEl = document.getElementById('detailStatus');
                statusEl.textContent = booking.status.charAt(0).toUpperCase() + booking.status.slice(1).replace('-', ' ');
                statusEl.style.color = statusColors[booking.status] || '#333';
                
                // Pricing
                const totalPrice = booking.totalPrice || 0;
                const deposit = booking.depositAmount || 0;
                const balance = totalPrice - deposit;
                
                document.getElementById('detailPrice').textContent = '$' + totalPrice.toFixed(2);
                
                if (deposit > 0) {
                    document.getElementById('detailDepositRow').style.display = 'flex';
                    document.getElementById('detailDeposit').textContent = '$' + deposit.toFixed(2);
                    document.getElementById('detailBalanceRow').style.display = 'flex';
                    document.getElementById('detailBalance').textContent = '$' + balance.toFixed(2);
                } else {
                    document.getElementById('detailDepositRow').style.display = 'none';
                    document.getElementById('detailBalanceRow').style.display = 'none';
                }
                
                // Notes
                if (booking.notes) {
                    document.getElementById('detailNotesRow').style.display = 'flex';
                    document.getElementById('detailNotes').textContent = booking.notes;
                } else {
                    document.getElementById('detailNotesRow').style.display = 'none';
                }
                
                // Priority badge
                const badgeEl = document.getElementById('bookingPriorityBadge');
                if (booking.priority === 'vip') {
                    badgeEl.style.display = 'block';
                    badgeEl.innerHTML = '<span style="background:linear-gradient(135deg,#f39c12,#e74c3c);color:#fff;padding:6px 15px;border-radius:20px;font-size:12px;font-weight:700;"><i class="fas fa-crown"></i> VIP MEMBER</span>';
                } else if (booking.priority === 'member') {
                    badgeEl.style.display = 'block';
                    badgeEl.innerHTML = '<span style="background:#27ae60;color:#fff;padding:6px 15px;border-radius:20px;font-size:12px;font-weight:700;"><i class="fas fa-star"></i> MEMBER</span>';
                } else {
                    badgeEl.style.display = 'none';
                }
                
                // Show/hide buttons based on status
                const btnCheckIn = document.getElementById('btnCheckIn');
                const btnCheckOut = document.getElementById('btnCheckOut');
                const btnNoShow = document.getElementById('btnNoShow');
                const btnReschedule = document.getElementById('btnReschedule');
                const btnCancel = document.getElementById('btnCancelBooking');
                
                // Reset all buttons
                btnCheckIn.style.display = 'none';
                btnCheckOut.style.display = 'none';
                btnNoShow.style.display = 'none';
                btnReschedule.style.display = 'none';
                btnCancel.style.display = 'none';
                
                if (booking.status === 'pending' || booking.status === 'confirmed') {
                    btnCheckIn.style.display = 'block';
                    btnNoShow.style.display = 'block';
                    btnReschedule.style.display = 'block';
                    btnCancel.style.display = 'block';
                } else if (booking.status === 'checked-in') {
                    btnCheckOut.style.display = 'block';
                } else {
                    // Completed, no-show, cancelled - just close button shown by default
                }
                
                showModal('bookingDetail');
            }
        }
        
        function deleteBooking() {
            if (!selectedBookingId) return;
            const booking = GolfCoveBooking.get(selectedBookingId);
            if (!booking) return;
            
            if (!confirm(`Cancel booking for ${booking.customer}?\n\nThis action cannot be undone.`)) return;
            
            const result = GolfCoveBooking.cancel(selectedBookingId, 'Cancelled by admin');
            if (result.success) {
                hideModal('bookingDetail');
                renderTeeSheet();
                showToast('Booking cancelled');
            } else {
                showToast(result.error || 'Failed to cancel', 'error');
            }
            selectedBookingId = null;
        }
        
        function checkInBooking() {
            if (!selectedBookingId) return;
            const result = GolfCoveBooking.checkIn(selectedBookingId);
            if (result.success) {
                hideModal('bookingDetail');
                renderTeeSheet();
                updateStats();
                showToast(result.booking.customer + ' checked in!');
            } else {
                showToast(result.error || 'Check-in failed', 'error');
            }
            selectedBookingId = null;
        }
        
        function checkOutBooking() {
            if (!selectedBookingId) return;
            const booking = GolfCoveBooking.get(selectedBookingId);
            if (!booking) return;
            
            const result = GolfCoveBooking.checkOut(selectedBookingId);
            if (result.success) {
                // If there's balance due, prompt for payment
                const balance = (booking.totalPrice || 0) - (booking.depositAmount || 0);
                if (balance > 0) {
                    showToast(`${booking.customer} checked out. Balance due: $${balance.toFixed(2)}`, 'success');
                } else {
                    showToast(`${booking.customer} checked out!`);
                }
                hideModal('bookingDetail');
                renderTeeSheet();
                updateStats();
            } else {
                showToast(result.error || 'Check-out failed', 'error');
            }
            selectedBookingId = null;
        }
        
        function markNoShow() {
            if (!selectedBookingId) return;
            const booking = GolfCoveBooking.get(selectedBookingId);
            if (!booking) return;
            
            if (!confirm(`Mark ${booking.customer} as No Show?\n\nThis will record the no-show and free up the slot.`)) return;
            
            const result = GolfCoveBooking.update(selectedBookingId, { status: 'no-show' });
            if (result.success) {
                // Update customer no-show count
                const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                const customer = customers.find(c => `${c.firstName} ${c.lastName}`.toLowerCase() === booking.customer.toLowerCase());
                if (customer) {
                    customer.noShowCount = (customer.noShowCount || 0) + 1;
                    localStorage.setItem('gc_customers', JSON.stringify(customers));
                }
                
                // Update stats
                const noShowCount = parseInt(document.getElementById('statNoShows').textContent) + 1;
                document.getElementById('statNoShows').textContent = noShowCount;
                
                hideModal('bookingDetail');
                renderTeeSheet();
                showToast(`${booking.customer} marked as No Show`, 'error');
            }
            selectedBookingId = null;
        }
        
        function rescheduleBooking() {
            if (!selectedBookingId) return;
            const booking = GolfCoveBooking.get(selectedBookingId);
            if (!booking) return;
            
            hideModal('bookingDetail');
            
            // Pre-fill booking form with existing data
            document.getElementById('bookingCustomer').value = booking.customer;
            document.getElementById('bookingRoom').value = booking.roomId;
            document.getElementById('bookingDuration').value = booking.duration;
            document.getElementById('bookingPlayers').value = booking.players;
            if (booking.phone) document.getElementById('bookingPhone').value = booking.phone;
            if (booking.notes) document.getElementById('bookingNotes').value = booking.notes;
            if (booking.depositAmount) document.getElementById('bookingDeposit').value = booking.depositAmount;
            
            // Store original booking ID to delete after rescheduling
            window.rescheduleFromId = selectedBookingId;
            
            showModal('booking');
            showToast('Select new date/time for ' + booking.customer, 'success');
        }

        // ============ TAB FUNCTIONS ============
        async function createTab(e) {
            e.preventDefault();
            const tableValue = document.getElementById('tabTable').value;
            const customerName = document.getElementById('tabCustomer').value;
            const customerId = document.getElementById('tabCustomerId').value;
            
            if (!customerName || !customerName.trim()) {
                showToast('Please enter customer name', 'error');
                return;
            }
            
            // Check if table already has a tab
            const existingTab = openTabs.find(t => t.table === tableValue && tableValue !== 'Tab');
            if (existingTab) {
                showToast('This table already has an open tab!', 'error');
                return;
            }
            
            const employeeName = getCurrentUserName();
            
            try {
                if (typeof TabsSync !== 'undefined') {
                    // Use TabsSync for synced tab management
                    const options = { table: tableValue };
                    
                    await TabsSync.createTab(customerName.trim(), customerId || null, [], employeeName, options);
                    
                    // Reload tabs from TabsSync
                    openTabs = TabsSync.getAllTabs();
                } else {
                    // Check if customer is a member
                    let isMember = false;
                    let memberType = null;
                    let memberExpires = null;
                    let memberDiscount = 0;
                    
                    if (customerId) {
                        const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                        const customer = customers.find(c => c.id == customerId);
                        if (customer && customer.isMember) {
                            const expDate = new Date(customer.memberExpires);
                            if (expDate > new Date()) {
                                isMember = true;
                                memberType = customer.memberType;
                                memberExpires = customer.memberExpires;
                                const discounts = { 'par': 10, 'birdie': 10, 'eagle': 15, 'family_par': 10, 'family_birdie': 10, 'family_eagle': 15, 'corporate': 20, 'monthly': 10, 'annual': 10 };
                                memberDiscount = discounts[memberType] || 10;
                            }
                        }
                    }
                    
                    openTabs.push({
                        id: Date.now().toString(),
                        customer: customerName.trim(),
                        customerId: customerId || null,
                        employee: employeeName,
                        amount: 0,
                        subtotal: 0,
                        total: 0,
                        items: [],
                        table: tableValue,
                        isMember: isMember,
                        memberType: memberType,
                        memberExpires: memberExpires,
                        memberDiscount: memberDiscount,
                        createdAt: new Date().toISOString(),
                        openedAt: new Date().toISOString(),
                        openedBy: employeeName
                    });
                    saveTabs();
                }
                
                hideModal('newTab');
                renderOpenTabs();
                renderFloorPlan();
                
                showToast('Tab created for ' + customerName.trim());
                e.target.reset();
                document.getElementById('tabCustomerId').value = '';
                document.getElementById('tabMemberStatus').style.display = 'none';
            } catch (error) {
                console.error('Error creating tab:', error);
                showToast('Failed to create tab', 'error');
            }
        }
        
        // Tab customer search and member detection
        function searchTabCustomers(query) {
            const resultsDiv = document.getElementById('tabCustomerResults');
            if (!query || query.length < 2) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const matches = customers.filter(c => {
                const fullName = `${c.firstName} ${c.lastName}`.toLowerCase();
                return fullName.includes(query.toLowerCase()) || 
                       (c.phone && c.phone.includes(query)) ||
                       (c.email && c.email.toLowerCase().includes(query.toLowerCase()));
            }).slice(0, 8);
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:10px;color:#666;text-align:center;font-size:12px;">No customers found - will create as guest</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            resultsDiv.innerHTML = matches.map(c => {
                const isActive = c.isMember && c.memberExpires && new Date(c.memberExpires) > new Date();
                const memberBadge = isActive ? `<span style="background:linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);color:#fff;padding:2px 6px;border-radius:8px;font-size:9px;margin-left:5px;"><i class="fas fa-crown" style="color:#f1c40f;margin-right:3px;"></i>${c.memberType?.toUpperCase()}</span>` : '';
                return `
                    <div onclick="selectTabCustomer(${c.id})" style="padding:10px;border-bottom:1px solid #eee;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='#fff'">
                        <div>
                            <div style="font-weight:600;">${c.firstName} ${c.lastName}${memberBadge}</div>
                            <div style="font-size:11px;color:#666;">${c.phone || c.email || ''}</div>
                        </div>
                        ${isActive ? '<i class="fas fa-star" style="color:#f1c40f;"></i>' : ''}
                    </div>
                `;
            }).join('');
            resultsDiv.style.display = 'block';
        }
        
        function selectTabCustomer(customerId) {
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            document.getElementById('tabCustomer').value = `${customer.firstName} ${customer.lastName}`;
            document.getElementById('tabCustomerId').value = customerId;
            document.getElementById('tabCustomerResults').style.display = 'none';
            
            // Show member status if applicable
            const isActive = customer.isMember && customer.memberExpires && new Date(customer.memberExpires) > new Date();
            const statusDiv = document.getElementById('tabMemberStatus');
            
            if (isActive) {
                const discounts = { 'par': '10%', 'birdie': '10%', 'eagle': '15%', 'family_par': '10%', 'family_birdie': '10%', 'family_eagle': '15%', 'corporate': '20%', 'monthly': '10%', 'annual': '10%' };
                document.getElementById('tabMemberName').textContent = `${customer.firstName} ${customer.lastName}`;
                document.getElementById('tabMemberTier').textContent = customer.memberType?.replace('_', ' ').toUpperCase();
                document.getElementById('tabMemberDiscount').textContent = `${discounts[customer.memberType] || '10%'} Discount Applied!`;
                statusDiv.style.display = 'block';
            } else {
                statusDiv.style.display = 'none';
            }
        }
        
        function loadTabMemberQuickSelect() {
            const container = document.getElementById('tabMemberQuickSelect');
            if (!container) return;
            
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const activeMembers = customers.filter(c => {
                return c.isMember && c.memberExpires && new Date(c.memberExpires) > new Date();
            }).slice(0, 6);
            
            if (activeMembers.length === 0) {
                container.innerHTML = '<span style="font-size:11px;color:#999;">No active members</span>';
                return;
            }
            
            const tierColors = {
                'par': '#3498db', 'birdie': '#9b59b6', 'eagle': '#f1c40f',
                'family_par': '#3498db', 'family_birdie': '#9b59b6', 'family_eagle': '#f1c40f',
                'corporate': '#2c3e50', 'monthly': '#27ae60', 'annual': '#27ae60'
            };
            
            container.innerHTML = activeMembers.map(c => {
                const color = tierColors[c.memberType] || '#9b59b6';
                return `
                    <button type="button" onclick="selectTabCustomer(${c.id})" style="background:linear-gradient(135deg, ${color} 0%, ${color}dd 100%);color:#fff;border:none;padding:5px 10px;border-radius:15px;font-size:11px;cursor:pointer;display:flex;align-items:center;gap:4px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                        <i class="fas fa-crown" style="font-size:9px;color:#f1c40f;"></i>
                        ${c.firstName} ${c.lastName?.charAt(0)}.
                    </button>
                `;
            }).join('');
        }

        function selectTab(id) {
            // Flexible ID matching (handle both number and string IDs)
            const tab = openTabs.find(t => t.id == id || String(t.id) === String(id));
            if (!tab) {
                showToast('Tab not found', 'error');
                return;
            }
            
            selectedTabId = tab.id;
            const tabIdEl = document.getElementById('tabDetailId');
            if (tabIdEl) tabIdEl.textContent = tab.id;
            
            // Show customer name with member badge if applicable
            const customerEl = document.getElementById('tabDetailCustomer');
            if (customerEl) {
                if (tab.isMember && tab.memberType) {
                    const tierColors = { 'par': '#3498db', 'birdie': '#9b59b6', 'eagle': '#f1c40f', 'family_par': '#3498db', 'family_birdie': '#9b59b6', 'family_eagle': '#f1c40f', 'corporate': '#2c3e50', 'monthly': '#27ae60', 'annual': '#27ae60' };
                    const color = tierColors[tab.memberType] || '#9b59b6';
                    const discount = tab.memberDiscount || 10;
                    customerEl.innerHTML = `${tab.customer || 'Guest'} <span style="background:linear-gradient(135deg, ${color} 0%, ${color}dd 100%);color:#fff;padding:2px 8px;border-radius:10px;font-size:10px;margin-left:5px;"><i class="fas fa-crown" style="color:#f1c40f;margin-right:3px;"></i>${tab.memberType.replace('_', ' ').toUpperCase()} - ${discount}% OFF</span>`;
                } else {
                    customerEl.textContent = tab.customer || 'Guest';
                }
            }
            
            const tableEl = document.getElementById('tabDetailTable');
            if (tableEl) tableEl.textContent = tab.table || 'Tab';
                
            // Calculate subtotal and tax
            const tabAmount = tab.amount || tab.total || 0;
            const subtotal = tab.subtotal || (tabAmount / (1 + getTaxRate()));
            const tax = calculateTax(subtotal);
            
            // Update detail fields if they exist
            const subtotalEl = document.getElementById('tabDetailSubtotal');
            const taxEl = document.getElementById('tabDetailTax');
            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if (taxEl) taxEl.textContent = formatCurrency(tax);
            
            const amountEl = document.getElementById('tabDetailAmount');
            if (amountEl) amountEl.textContent = formatCurrency(tabAmount);
            
            // Show member discount info if applicable
            const memberDiscountRow = document.getElementById('tabDetailMemberDiscount');
            if (memberDiscountRow) {
                if (tab.isMember && tab.memberDiscount > 0) {
                    const discountAmount = (tab.subtotal || 0) * (tab.memberDiscount / 100);
                    memberDiscountRow.innerHTML = `<span style="color:#27ae60;">-$${discountAmount.toFixed(2)} (${tab.memberDiscount}% member discount)</span>`;
                    if (memberDiscountRow.parentElement) memberDiscountRow.parentElement.style.display = 'flex';
                } else {
                    if (memberDiscountRow.parentElement) memberDiscountRow.parentElement.style.display = 'none';
                }
            }
            
            // Render items list
            const itemsListEl = document.getElementById('tabItemsList');
            if (itemsListEl) {
                if (tab.items && tab.items.length > 0) {
                    itemsListEl.innerHTML = tab.items.map(item => `
                        <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #eee;">
                            <span>${item.qty || 1}x ${item.name || 'Item'}</span>
                            <span>$${((item.price || 0) * (item.qty || 1)).toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    itemsListEl.innerHTML = '<div style="color:#999;text-align:center;">No items on this tab yet</div>';
                }
            }
            
            showModal('tabDetail');
        }
        
        function closeTab() {
            if (!selectedTabId) return;
            const tab = openTabs.find(t => t.id == selectedTabId);
            if (!tab) {
                showToast('Tab not found', 'error');
                return;
            }
            
            const tabAmount = tab.amount || tab.total || 0;
            if (tabAmount > 0 || (tab.items && tab.items.length > 0)) {
                // Load tab items into cart and open payment modal
                cart = tab.items ? tab.items.map(i => ({...i})) : [];
                currentDiscount = 0;
                payingTabId = tab.id; // Track that we're paying this tab
                
                // Set customer
                document.getElementById('customerSearch').value = tab.customer;
                
                // Check if customer is a member and apply discount
                if (typeof GolfCoveMembership !== 'undefined') {
                    const customer = GolfCoveMembership.findCustomerByName(tab.customer);
                    if (customer && GolfCoveMembership.isActiveMember(customer)) {
                        currentCartCustomer = customer;
                        currentCartCustomerIsMember = true;
                        const discountResult = GolfCoveMembership.calculateDiscount(cart, customer);
                        if (discountResult.totalDiscount > 0) {
                            currentDiscount = discountResult.totalDiscount;
                            memberDiscountApplied = true;
                        }
                    }
                }
                
                renderCart();
                hideModal('tabDetail');
                
                // Process payment - this will open the payment modal
                processPayment('card');
            } else {
                // No charges - just close the tab
                openTabs = openTabs.filter(t => t.id !== selectedTabId);
                saveTabs();
                hideModal('tabDetail');
                renderOpenTabs();
                renderFloorPlan();
                showToast('Tab closed (no charges)', 'success');
                selectedTabId = null;
            }
        }
        
        // Called after payment is completed to finalize tab closing
        async function finalizeTabClose(tabId, paymentMethod) {
            const employeeName = getCurrentUserName();
            
            try {
                if (typeof TabsSync !== 'undefined') {
                    // Use TabsSync to close the tab
                    await TabsSync.closeTab(tabId, paymentMethod, 0, employeeName);
                    // Reload tabs from TabsSync
                    openTabs = TabsSync.getAllTabs();
                } else {
                    // Fallback to local array
                    openTabs = openTabs.filter(t => String(t.id) !== String(tabId));
                    saveTabs();
                }
                
                renderOpenTabs();
                renderFloorPlan();
            } catch (error) {
                console.error('Error closing tab:', error);
                showToast('Error finalizing tab close', 'error');
            }
        }
        
        async function addToTabFromCurrent() {
            if (!selectedTabId) return showToast('No tab selected', 'error');
            if (cart.length === 0) return showToast('Add items to cart first', 'error');
            
            const employeeName = getCurrentUserName();
            
            // Format cart items for TabsSync
            const items = cart.map(item => ({
                name: item.name,
                price: parseFloat(item.price) || 0,
                qty: parseInt(item.qty) || 1,
                category: item.category || 'misc'
            }));
            
            const itemCount = items.reduce((sum, i) => sum + i.qty, 0);
            const cartTotal = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
            const cartTax = calculateTax(cartTotal);
            
            try {
                let tab = null;
                
                if (typeof TabsSync !== 'undefined') {
                    // Use TabsSync for synced tab management
                    tab = TabsSync.getTab(selectedTabId);
                    if (!tab) {
                        showToast('Tab not found', 'error');
                        return;
                    }
                    
                    await TabsSync.addItemsToTab(selectedTabId, items, employeeName);
                    
                    // Reload tabs from TabsSync
                    openTabs = TabsSync.getAllTabs();
                } else {
                    // Fallback to local storage
                    tab = openTabs.find(t => String(t.id) === String(selectedTabId));
                    if (!tab) {
                        showToast('Tab not found', 'error');
                        return;
                    }
                    
                    if (!tab.items) tab.items = [];
                    items.forEach(item => {
                        const existing = tab.items.find(i => i.name === item.name && i.price === item.price);
                        if (existing) {
                            existing.qty += item.qty;
                        } else {
                            tab.items.push({...item});
                        }
                    });
                    
                    tab.subtotal = tab.items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                    tab.total = tab.subtotal * (1 + getTaxRate());
                    tab.amount = tab.total;
                    saveTabs();
                }
                
                cart = [];
                currentDiscount = 0;
                renderCart();
                hideModal('tabDetail');
                renderOpenTabs();
                renderFloorPlan();
                showToast(`${itemCount} item${itemCount > 1 ? 's' : ''} ($${(cartTotal + cartTax).toFixed(2)}) added to ${tab?.customer || 'tab'}'s tab`);
                selectedTabId = null;
            } catch (error) {
                console.error('Error adding to tab:', error);
                showToast('Failed to add items to tab', 'error');
            }
        }

        function selectTable(id) {
            const tab = openTabs.find(t => t.table === `Table ${id}`);
            if (tab) {
                selectTab(tab.id);
            } else {
                // Create new tab for this table
                document.getElementById('tabTable').value = `Table ${id}`;
                showModal('newTab');
            }
        }

        // ============ NAVIGATION ============
        function showPage(page, el) {
            document.querySelectorAll('.page-content').forEach(p => p.style.display = 'none');
            document.getElementById('page-' + page).style.display = 'block';
            document.querySelectorAll('.header-nav a').forEach(a => a.classList.remove('active'));
            if (el) el.classList.add('active');
        }

        function switchFnbTab(tab, el) {
            document.querySelectorAll('.fnb-tab').forEach(t => t.classList.remove('active'));
            if (el) el.classList.add('active');
            // Could switch between different floor layouts in the future
            showToast(`Viewing ${tab === 'lounge' ? 'Golf Cove Lounge' : 'Golf Cove Rooms'}`);
        }

        function showModal(name) {
            document.getElementById('modal-' + name).classList.add('active');
            if (name === 'booking') {
                document.getElementById('bookingDate').valueAsDate = new Date();
                document.getElementById('bookingCustomerId').value = '';
                populateBookingCustomerOptions();
            }
            if (name === 'newTab') {
                document.getElementById('tabCustomerId').value = '';
                document.getElementById('tabMemberStatus').style.display = 'none';
                loadTabMemberQuickSelect();
            }
        }

        function hideModal(name) {
            document.getElementById('modal-' + name).classList.remove('active');
        }
        
        // Populate VIP members and recent customers for quick selection
        function populateBookingCustomerOptions() {
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const now = new Date();
            
            // Get active VIP members (Eagle & Birdie)
            const vipMembers = allCustomers.filter(c => {
                if (!c.isMember || !c.memberExpires) return false;
                if (new Date(c.memberExpires) <= now) return false;
                return c.memberType && (c.memberType.includes('eagle') || c.memberType.includes('birdie'));
            }).slice(0, 8);
            
            // Get recent customers (by last visit or creation date)
            const recentCustomers = [...allCustomers]
                .sort((a, b) => new Date(b.lastVisit || b.createdAt || 0) - new Date(a.lastVisit || a.createdAt || 0))
                .filter(c => !vipMembers.find(v => v.id === c.id))
                .slice(0, 6);
            
            // Render VIP Members
            const vipList = document.getElementById('vipMembersList');
            if (vipMembers.length > 0) {
                vipList.innerHTML = vipMembers.map(c => {
                    const tierColors = {
                        'eagle': '#9b59b6', 'family_eagle': '#9b59b6',
                        'birdie': '#f39c12', 'family_birdie': '#f39c12'
                    };
                    const color = tierColors[c.memberType] || '#9b59b6';
                    return `<button type="button" class="quick-customer-btn" style="background:${color};color:#fff;border:none;padding:6px 12px;border-radius:15px;font-size:12px;cursor:pointer;display:flex;align-items:center;gap:5px;transition:all 0.2s;"
                            onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)';"
                            onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none';"
                            onclick="quickSelectBookingCustomer(${c.id})">
                        <i class="fas fa-crown" style="font-size:10px;"></i>
                        ${c.firstName} ${c.lastName[0]}.
                    </button>`;
                }).join('');
                vipList.parentElement.style.display = 'block';
            } else {
                vipList.innerHTML = '<span style="font-size:11px;color:#999;">No VIP members yet</span>';
            }
            
            // Render Recent Customers
            const recentList = document.getElementById('recentCustomersList');
            if (recentCustomers.length > 0) {
                recentList.innerHTML = recentCustomers.map(c => {
                    const isMember = c.isMember && c.memberExpires && new Date(c.memberExpires) > now;
                    const bgColor = isMember ? '#27ae60' : '#4a90a4';
                    return `<button type="button" class="quick-customer-btn" style="background:${bgColor};color:#fff;border:none;padding:6px 12px;border-radius:15px;font-size:12px;cursor:pointer;transition:all 0.2s;"
                            onmouseover="this.style.transform='scale(1.05)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.2)';"
                            onmouseout="this.style.transform='scale(1)';this.style.boxShadow='none';"
                            onclick="quickSelectBookingCustomer(${c.id})">
                        ${c.firstName} ${c.lastName[0]}.
                        ${isMember ? '<i class="fas fa-check-circle" style="font-size:10px;margin-left:2px;"></i>' : ''}
                    </button>`;
                }).join('');
                recentList.parentElement.style.display = 'block';
            } else {
                recentList.innerHTML = '<span style="font-size:11px;color:#999;">No recent customers</span>';
            }
        }
        
        // Quick select a customer from the button lists
        function quickSelectBookingCustomer(customerId) {
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = allCustomers.find(c => c.id === customerId);
            
            if (!customer) return;
            
            const name = `${customer.firstName} ${customer.lastName}`;
            document.getElementById('bookingCustomer').value = name;
            document.getElementById('bookingCustomerId').value = customerId;
            
            // Auto-fill phone and email if available
            if (customer.phone) document.getElementById('bookingPhone').value = customer.phone;
            if (customer.email) document.getElementById('bookingEmail').value = customer.email;
            
            const now = new Date();
            const isMember = customer.isMember && customer.memberExpires && new Date(customer.memberExpires) > now;
            
            if (isMember) {
                selectBookingCustomer(name, true, customer.memberType);
                updateBookingMemberBadge(customer);
            } else {
                selectedBookingCustomerTier = null;
                document.getElementById('bookingMemberBadge').style.display = 'none';
            }
            
            updateBookingPrice();
            showToast(`Selected: ${name}`, 'success');
        }
        
        // Update the member badge in booking modal
        function updateBookingMemberBadge(customer) {
            const badge = document.getElementById('bookingMemberBadge');
            const now = new Date();
            const isMember = customer && customer.isMember && customer.memberExpires && new Date(customer.memberExpires) > now;
            
            if (!isMember) {
                badge.style.display = 'none';
                return;
            }
            
            const tierDisplay = {
                'eagle': { name: 'Eagle Member', color: 'linear-gradient(135deg,#9b59b6,#8e44ad)', discount: '20%' },
                'family_eagle': { name: 'Eagle Family', color: 'linear-gradient(135deg,#9b59b6,#8e44ad)', discount: '20%' },
                'birdie': { name: 'Birdie Member', color: 'linear-gradient(135deg,#f1c40f,#e67e22)', discount: '15%' },
                'family_birdie': { name: 'Birdie Family', color: 'linear-gradient(135deg,#f1c40f,#e67e22)', discount: '15%' },
                'par': { name: 'Par Member', color: 'linear-gradient(135deg,#27ae60,#1e8449)', discount: '10%' },
                'family_par': { name: 'Par Family', color: 'linear-gradient(135deg,#27ae60,#1e8449)', discount: '10%' }
            };
            
            const tier = tierDisplay[customer.memberType] || { name: 'Member', color: '#27ae60', discount: '10%' };
            const isVIP = customer.memberType && (customer.memberType.includes('eagle') || customer.memberType.includes('birdie'));
            
            badge.style.background = tier.color;
            badge.style.display = 'block';
            document.getElementById('bookingMemberText').innerHTML = `${isVIP ? '<i class="fas fa-crown"></i> ' : ''}${tier.name}`;
            document.getElementById('bookingMemberDiscount').textContent = `-${tier.discount} off`;
            
            // Show benefits
            const benefitsEl = document.getElementById('bookingMemberBenefits');
            if (benefitsEl) {
                const benefits = [];
                if (isVIP) benefits.push('Priority Booking');
                if (customer.memberType.includes('birdie') || customer.memberType.includes('eagle')) benefits.push('Unlimited Play');
                benefitsEl.textContent = benefits.join(' ‚Ä¢ ');
            }
        }

        // ============ DATE FUNCTIONS ============
        function changeDate(delta) {
            currentDate.setDate(currentDate.getDate() + delta);
            selectedDate = currentDate.toISOString().split('T')[0];
            // Sync tee sheet date picker
            document.getElementById('teeSheetDate').value = selectedDate;
            updateDateDisplay();
            renderTeeSheet();
        }

        function goToToday() {
            currentDate = new Date();
            selectedDate = currentDate.toISOString().split('T')[0];
            // Sync tee sheet date picker
            document.getElementById('teeSheetDate').value = selectedDate;
            updateDateDisplay();
            renderTeeSheet();
            showToast('Viewing today');
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }
        
        function changeTeeSheetDate(delta) {
            const dateInput = document.getElementById('teeSheetDate');
            const current = new Date(dateInput.value);
            current.setDate(current.getDate() + delta);
            dateInput.value = current.toISOString().split('T')[0];
            // Sync currentDate and selectedDate
            currentDate = new Date(current);
            selectedDate = dateInput.value;
            updateDateDisplay();
            renderTeeSheet();
        }
        
        // REMOVED duplicate goToToday - using unified version above

        function selectDate(day) {
            currentDate.setDate(day);
            selectedDate = currentDate.toISOString().split('T')[0];
            // Sync tee sheet date picker
            document.getElementById('teeSheetDate').value = selectedDate;
            updateDateDisplay();
            renderTeeSheet(); // Re-render tee sheet for selected date
            showToast(`Viewing ${currentDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`);
        }

        function updateDateDisplay() {
            document.getElementById('currentDateDisplay').textContent = currentDate.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            renderCalendar();
        }

        function updateStats() {
            const selectedDate = document.getElementById('teeSheetDate')?.value || new Date().toISOString().split('T')[0];
            const dayBookings = GolfCoveBooking.getForDate(selectedDate);
            
            document.getElementById('statBookings').textContent = dayBookings.length;
            document.getElementById('statOccupancy').textContent = Math.round((dayBookings.length / (rooms.length * timeSlots.length)) * 100) + '%';
            const checkedIn = dayBookings.filter(b => b.status === 'checked-in' || b.checkedIn).length;
            document.getElementById('statCheckedIn').textContent = checkedIn;
            const revenue = dayBookings.reduce((sum, b) => sum + (b.totalPrice || (b.duration === 1 ? 45 : b.duration === 2 ? 80 : 110)), 0);
            document.getElementById('statRevenue').textContent = '$' + revenue.toFixed(2);
        }
        
        function resetDemoData() {
            if (!confirm('Reset all data to demo defaults? This cannot be undone.')) return;
            localStorage.removeItem('gc_bookings');
            localStorage.removeItem('gc_tabs');
            localStorage.removeItem('gc_transactions');
            localStorage.removeItem('gc_suspended');
            location.reload();
        }

        // ============ INIT ============
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => { if (e.target === overlay) overlay.classList.remove('active'); });
        });
        
        // Global Search Function
        function performGlobalSearch(query) {
            const resultsDiv = document.getElementById('globalSearchResults');
            if (!query || query.length < 2) {
                resultsDiv.innerHTML = '<div style="text-align:center;color:#999;padding:40px;"><i class="fas fa-search" style="font-size:40px;margin-bottom:10px;display:block;"></i>Start typing to search...</div>';
                return;
            }
            
            const q = query.toLowerCase();
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            let html = '';
            
            // Search customers
            const matchedCustomers = customers.filter(c => 
                `${c.firstName} ${c.lastName}`.toLowerCase().includes(q) ||
                (c.email && c.email.toLowerCase().includes(q)) ||
                (c.phone && c.phone.includes(q))
            ).slice(0, 5);
            
            if (matchedCustomers.length > 0) {
                html += '<div style="padding:8px 12px;background:#f0f2f5;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;"><i class="fas fa-users"></i> Customers</div>';
                matchedCustomers.forEach(c => {
                    const isMember = c.isMember;
                    html += `<div style="padding:12px;border-bottom:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:12px;" onclick="goToCustomer(${c.id})">
                        <div style="width:40px;height:40px;background:#4a90a4;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600;">${c.firstName.charAt(0)}${c.lastName.charAt(0)}</div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">${c.firstName} ${c.lastName} ${isMember ? '<span style="background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;font-size:9px;padding:2px 5px;border-radius:8px;">MEMBER</span>' : ''}</div>
                            <div style="font-size:12px;color:#999;">${c.email || ''} ${c.phone ? '¬∑ ' + c.phone : ''}</div>
                        </div>
                        <i class="fas fa-arrow-right" style="color:#ccc;"></i>
                    </div>`;
                });
            }
            
            // Search bookings using booking system
            const allBookings = GolfCoveBooking.getAll();
            const matchedBookings = allBookings.filter(b => 
                b.customer.toLowerCase().includes(q) ||
                b.time.toLowerCase().includes(q) ||
                (b.date && b.date.includes(q))
            ).slice(0, 5);
            
            if (matchedBookings.length > 0) {
                html += '<div style="padding:8px 12px;background:#f0f2f5;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;"><i class="fas fa-calendar"></i> Bookings</div>';
                matchedBookings.forEach(b => {
                    const roomName = GolfCoveBooking.getRoomName(b.roomId || b.room);
                    const statusColor = b.status === 'checked-in' ? '#27ae60' : b.status === 'cancelled' ? '#e74c3c' : '#3498db';
                    html += `<div style="padding:12px;border-bottom:1px solid #eee;cursor:pointer;display:flex;align-items:center;gap:12px;" onclick="selectBooking(${b.id}); hideModal('lookup');">
                        <div style="width:40px;height:40px;background:${statusColor};border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-golf-ball"></i></div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">${b.customer} ${b.priority === 'vip' ? '<span style="background:linear-gradient(135deg,#f39c12,#e74c3c);color:#fff;font-size:9px;padding:2px 5px;border-radius:8px;">VIP</span>' : ''}</div>
                            <div style="font-size:12px;color:#999;">${roomName} ¬∑ ${b.date} ${b.time} ¬∑ ${b.players} players</div>
                        </div>
                        <i class="fas fa-arrow-right" style="color:#ccc;"></i>
                    </div>`;
                });
            }
            
            // Search transactions
            const matchedTrans = transactions.filter(t =>
                t.customer.toLowerCase().includes(q) ||
                t.id.toString().includes(q)
            ).slice(0, 5);
            
            if (matchedTrans.length > 0) {
                html += '<div style="padding:8px 12px;background:#f0f2f5;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;"><i class="fas fa-receipt"></i> Transactions</div>';
                matchedTrans.forEach(t => {
                    html += `<div style="padding:12px;border-bottom:1px solid #eee;display:flex;align-items:center;gap:12px;">
                        <div style="width:40px;height:40px;background:#3498db;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;"><i class="fas fa-receipt"></i></div>
                        <div style="flex:1;">
                            <div style="font-weight:600;">#${t.id} - ${t.customer}</div>
                            <div style="font-size:12px;color:#999;">${t.time} ¬∑ $${t.amount.toFixed(2)}</div>
                        </div>
                    </div>`;
                });
            }
            
            if (!html) {
                html = '<div style="text-align:center;color:#999;padding:40px;"><i class="fas fa-search" style="font-size:40px;margin-bottom:10px;display:block;opacity:0.3;"></i>No results found</div>';
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function goToCustomer(id) {
            hideModal('lookup');
            window.location.href = `customers.html?id=${id}`;
        }

        // Update clock every second
        function updateClock() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }
        updateClock();
        setInterval(updateClock, 1000);

        // Customer search with autocomplete using customer database
        const customerSearch = document.getElementById('customerSearch');
        
        // Create autocomplete dropdown
        const autocompleteDiv = document.createElement('div');
        autocompleteDiv.id = 'customerAutocomplete';
        autocompleteDiv.style.cssText = 'position:absolute;top:100%;left:0;right:0;background:#fff;border:1px solid #ddd;border-radius:0 0 8px 8px;max-height:200px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.15);';
        customerSearch.parentElement.style.position = 'relative';
        customerSearch.parentElement.appendChild(autocompleteDiv);
        
        customerSearch.addEventListener('input', function() {
            const val = this.value.toLowerCase().trim();
            if (val.length < 2) {
                autocompleteDiv.style.display = 'none';
                return;
            }
            
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const matches = allCustomers.filter(c => {
                const fullName = `${c.firstName} ${c.lastName}`.toLowerCase();
                return fullName.includes(val) || (c.email && c.email.toLowerCase().includes(val));
            }).slice(0, 8);
            
            if (matches.length === 0) {
                autocompleteDiv.style.display = 'none';
                return;
            }
            
            autocompleteDiv.innerHTML = matches.map(c => {
                const isMember = c.isMember && c.memberExpires && new Date(c.memberExpires) > new Date();
                const tierColors = {
                    'eagle': 'linear-gradient(135deg, #9b59b6, #8e44ad)',
                    'family_eagle': 'linear-gradient(135deg, #9b59b6, #8e44ad)',
                    'birdie': 'linear-gradient(135deg, #f1c40f, #e67e22)',
                    'family_birdie': 'linear-gradient(135deg, #f1c40f, #e67e22)',
                    'par': 'linear-gradient(135deg, #27ae60, #1e8449)',
                    'family_par': 'linear-gradient(135deg, #27ae60, #1e8449)'
                };
                const tierNames = {
                    'eagle': '‚≠ê EAGLE',
                    'family_eagle': '‚≠ê EAGLE',
                    'birdie': 'üèÜ BIRDIE',
                    'family_birdie': 'üèÜ BIRDIE',
                    'par': 'PAR',
                    'family_par': 'PAR'
                };
                const tierBg = isMember ? (tierColors[c.memberType] || '#27ae60') : '#4a90a4';
                const tierName = isMember ? (tierNames[c.memberType] || 'MEMBER') : '';
                const isVIP = c.memberType && (c.memberType.includes('eagle') || c.memberType.includes('birdie'));
                
                return `
                    <div style="padding:10px 15px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid #eee;${isVIP ? 'background:#fffdf5;' : ''}" 
                         onmouseover="this.style.background='${isVIP ? '#fff9e6' : '#f5f6fa'}'" 
                         onmouseout="this.style.background='${isVIP ? '#fffdf5' : '#fff'}'"
                         onclick="selectCustomerFromSearch('${c.firstName} ${c.lastName}', ${c.isMember}, '${c.memberType || ''}')">
                        <div style="width:32px;height:32px;border-radius:50%;background:${tierBg};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;">
                            ${(c.firstName[0] || '') + (c.lastName[0] || '')}
                        </div>
                        <div style="flex:1;">
                            <div style="font-weight:600;color:#333;display:flex;align-items:center;gap:6px;">
                                ${c.firstName} ${c.lastName}
                                ${isMember ? `<span style="background:${tierBg};color:#fff;font-size:9px;padding:2px 6px;border-radius:10px;font-weight:700;">${tierName}</span>` : ''}
                            </div>
                            <div style="font-size:12px;color:#999;">${c.phone || c.email || 'No contact'}</div>
                        </div>
                        ${isVIP ? '<i class="fas fa-crown" style="color:#f1c40f;"></i>' : ''}
                    </div>
                `;
            }).join('');
            autocompleteDiv.style.display = 'block';
        });
        
        customerSearch.addEventListener('blur', function() {
            setTimeout(() => { autocompleteDiv.style.display = 'none'; }, 200);
        });
        
        function selectCustomerFromSearch(name, isMember, tierType) {
            customerSearch.value = name;
            autocompleteDiv.style.display = 'none';
            
            // Find full customer record using membership system
            if (typeof GolfCoveMembership !== 'undefined') {
                currentCartCustomer = GolfCoveMembership.findCustomerByName(name);
                
                if (currentCartCustomer && GolfCoveMembership.isActiveMember(currentCartCustomer)) {
                    const tier = GolfCoveMembership.getMemberTier(currentCartCustomer);
                    const tierName = tier ? tier.name : 'Member';
                    const discountPct = tier && tier.benefits ? tier.benefits.discountPercent : 10;
                    
                    showToast(`${tierName}: ${name} - ${discountPct}% discount on F&B!`, 'success');
                    
                    // Show member indicator in cart header
                    updateCartMemberBadge(true, tierName, discountPct);
                    
                    // Auto-apply member discount if cart has items
                    if (cart.length > 0) {
                        applyMemberDiscount();
                    }
                    memberDiscountApplied = true;
                } else {
                    updateCartMemberBadge(false);
                    memberDiscountApplied = false;
                }
            } else if (isMember) {
                showToast(`Member: ${name}`, 'success');
            }
        }
        
        // Apply automatic member discount
        function applyMemberDiscount() {
            if (!currentCartCustomer || typeof GolfCoveMembership === 'undefined') return;
            if (!GolfCoveMembership.isActiveMember(currentCartCustomer)) return;
            
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const discount = GolfCoveMembership.calculateDiscount(currentCartCustomer, subtotal, 'fnb');
            
            if (discount > 0) {
                currentDiscount = discount;
                updateTotals();
            }
        }
        
        // Update cart header to show member badge
        function updateCartMemberBadge(isMember, tierName = '', discountPct = 0) {
            const cartHeader = document.querySelector('.cart-panel h3');
            if (!cartHeader) return;
            
            // Remove existing badge
            const existingBadge = cartHeader.querySelector('.cart-member-badge');
            if (existingBadge) existingBadge.remove();
            
            if (isMember && tierName) {
                const badge = document.createElement('span');
                badge.className = 'cart-member-badge';
                badge.style.cssText = 'background:linear-gradient(135deg,#f1c40f,#e67e22);color:#fff;font-size:10px;padding:3px 8px;border-radius:10px;margin-left:10px;font-weight:600;';
                badge.textContent = `${tierName} (-${discountPct}%)`;
                cartHeader.appendChild(badge);
            }
        }
        
        // Booking customer autocomplete
        const bookingCustomerInput = document.getElementById('bookingCustomer');
        const bookingAutocomplete = document.getElementById('bookingCustomerAutocomplete');
        
        bookingCustomerInput.addEventListener('input', function() {
            const val = this.value.toLowerCase().trim();
            if (val.length < 2) {
                bookingAutocomplete.style.display = 'none';
                return;
            }
            
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const cleanedPhone = val.replace(/\D/g, '');
            
            const matches = allCustomers.filter(c => {
                const fullName = `${c.firstName} ${c.lastName}`.toLowerCase();
                const email = (c.email || '').toLowerCase();
                const phone = (c.phone || '').replace(/\D/g, '');
                return fullName.includes(val) || 
                       email.includes(val) || 
                       (cleanedPhone.length >= 3 && phone.includes(cleanedPhone));
            }).slice(0, 8);
            
            if (matches.length === 0) {
                // Show "Add New Customer" option
                bookingAutocomplete.innerHTML = `
                    <div style="padding:12px;text-align:center;color:#666;">
                        <div style="font-size:13px;">No customers found for "${val}"</div>
                        <button type="button" onclick="createQuickCustomerFromBooking('${val}')" 
                                style="margin-top:8px;background:#27ae60;color:#fff;border:none;padding:8px 16px;border-radius:6px;cursor:pointer;font-size:12px;">
                            <i class="fas fa-plus"></i> Add as New Customer
                        </button>
                    </div>
                `;
                bookingAutocomplete.style.display = 'block';
                return;
            }
            
            bookingAutocomplete.innerHTML = matches.map(c => {
                const now = new Date();
                const isMember = c.isMember && c.memberExpires && new Date(c.memberExpires) > now;
                const tierColors = {
                    'eagle': 'linear-gradient(135deg, #9b59b6, #8e44ad)',
                    'family_eagle': 'linear-gradient(135deg, #9b59b6, #8e44ad)',
                    'birdie': 'linear-gradient(135deg, #f1c40f, #e67e22)',
                    'family_birdie': 'linear-gradient(135deg, #f1c40f, #e67e22)',
                    'par': 'linear-gradient(135deg, #27ae60, #1e8449)',
                    'family_par': 'linear-gradient(135deg, #27ae60, #1e8449)'
                };
                const tierNames = {
                    'eagle': '‚≠ê EAGLE',
                    'family_eagle': '‚≠ê EAGLE',
                    'birdie': 'üèÜ BIRDIE',
                    'family_birdie': 'üèÜ BIRDIE',
                    'par': 'PAR',
                    'family_par': 'PAR'
                };
                const tierBg = isMember ? (tierColors[c.memberType] || 'linear-gradient(135deg, #27ae60, #1e8449)') : '#4a90a4';
                const tierName = isMember ? (tierNames[c.memberType] || 'MEMBER') : '';
                const isVIP = c.memberType && (c.memberType.includes('eagle') || c.memberType.includes('birdie'));
                
                // Contact info display
                const contactInfo = c.phone || c.email || 'No contact';
                const visitInfo = c.visitCount ? `${c.visitCount} visits` : '';
                
                return `
                    <div style="padding:10px 12px;cursor:pointer;display:flex;align-items:center;gap:10px;border-bottom:1px solid #eee;${isVIP ? 'background:#fffdf5;' : ''}" 
                         onmouseover="this.style.background='${isVIP ? '#fff9e6' : '#f5f6fa'}'" 
                         onmouseout="this.style.background='${isVIP ? '#fffdf5' : '#fff'}'"
                         onclick="selectBookingCustomerById(${c.id})">
                        <div style="width:36px;height:36px;border-radius:50%;background:${tierBg};color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:12px;${isVIP ? 'box-shadow:0 2px 8px rgba(0,0,0,0.2);' : ''}">
                            ${(c.firstName[0] || '') + (c.lastName[0] || '')}
                        </div>
                        <div style="flex:1;min-width:0;">
                            <div style="font-weight:600;color:#333;font-size:13px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                                ${c.firstName} ${c.lastName}
                                ${isMember ? `<span style="background:${tierBg};color:#fff;font-size:9px;padding:2px 6px;border-radius:8px;font-weight:700;">${tierName}</span>` : ''}
                            </div>
                            <div style="font-size:11px;color:#666;display:flex;gap:8px;">
                                <span>${contactInfo}</span>
                                ${visitInfo ? `<span style="color:#999;">‚Ä¢ ${visitInfo}</span>` : ''}
                            </div>
                        </div>
                        ${isVIP ? '<i class="fas fa-crown" style="color:#f1c40f;font-size:16px;"></i>' : ''}
                    </div>
                `;
            }).join('');
            bookingAutocomplete.style.display = 'block';
        });
        
        bookingCustomerInput.addEventListener('blur', function() {
            setTimeout(() => { bookingAutocomplete.style.display = 'none'; }, 250);
        });
        
        // Select customer by ID (new unified function)
        function selectBookingCustomerById(customerId) {
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = allCustomers.find(c => c.id === customerId);
            
            if (!customer) return;
            
            const name = `${customer.firstName} ${customer.lastName}`;
            bookingCustomerInput.value = name;
            document.getElementById('bookingCustomerId').value = customerId;
            bookingAutocomplete.style.display = 'none';
            
            // Auto-fill contact info
            if (customer.phone) document.getElementById('bookingPhone').value = customer.phone;
            if (customer.email) document.getElementById('bookingEmail').value = customer.email;
            
            const now = new Date();
            const isMember = customer.isMember && customer.memberExpires && new Date(customer.memberExpires) > now;
            
            if (isMember) {
                selectedBookingCustomerTier = customer.memberType;
                updateBookingMemberBadge(customer);
                const isVIP = customer.memberType && (customer.memberType.includes('eagle') || customer.memberType.includes('birdie'));
                showToast(`${isVIP ? '‚≠ê VIP ' : ''}${name} selected`, 'success');
            } else {
                selectedBookingCustomerTier = null;
                document.getElementById('bookingMemberBadge').style.display = 'none';
            }
            
            updateBookingPrice();
        }
        
        // Create quick customer from booking modal
        function createQuickCustomerFromBooking(searchVal) {
            // Try to parse as name
            const parts = searchVal.trim().split(' ');
            const firstName = parts[0] || 'Guest';
            const lastName = parts.slice(1).join(' ') || '';
            
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const newCustomer = {
                id: Date.now(),
                firstName: firstName.charAt(0).toUpperCase() + firstName.slice(1).toLowerCase(),
                lastName: lastName ? lastName.charAt(0).toUpperCase() + lastName.slice(1).toLowerCase() : '',
                email: '',
                phone: '',
                isMember: false,
                memberType: null,
                visitCount: 0,
                totalSpent: 0,
                createdAt: new Date().toISOString(),
                source: 'booking'
            };
            
            allCustomers.push(newCustomer);
            localStorage.setItem('gc_customers', JSON.stringify(allCustomers));
            
            // Select the new customer
            selectBookingCustomerById(newCustomer.id);
            showToast(`Created new customer: ${newCustomer.firstName} ${newCustomer.lastName}`, 'success');
        }
        
        let selectedBookingCustomerTier = null;
        // Note: selectedBookingMemberType is declared earlier in the file (line ~2717)
        
        // Legacy function for autocomplete selections by name
        // DEPRECATED: Use selectBookingCustomerById when possible
        function selectBookingCustomerByName(name, isMember, tierType) {
            bookingCustomerInput.value = name;
            bookingAutocomplete.style.display = 'none';
            selectedBookingCustomerTier = tierType;
            // IMPORTANT: Also set selectedBookingMemberType for pricing consistency
            selectedBookingMemberType = tierType;
            
            if (isMember) {
                const isVIP = tierType && (tierType.includes('eagle') || tierType.includes('birdie'));
                const tierDisplay = {
                    'eagle': 'Eagle Member',
                    'family_eagle': 'Eagle Family Member',
                    'birdie': 'Birdie Member',
                    'family_birdie': 'Birdie Family Member',
                    'par': 'Par Member',
                    'family_par': 'Par Family Member'
                };
                const displayName = tierDisplay[tierType] || 'Member';
                
                if (isVIP) {
                    showToast(`‚≠ê VIP ${displayName}: ${name} - Priority booking!`, 'success');
                } else {
                    showToast(`${displayName} selected: ${name}`, 'success');
                }
                
                // Show member badge
                document.getElementById('bookingMemberBadge').style.display = 'block';
                document.getElementById('bookingMemberText').textContent = displayName;
                const discounts = { 'par': '10%', 'birdie': '10%', 'eagle': '15%', 'family_par': '10%', 'family_birdie': '10%', 'family_eagle': '15%' };
                document.getElementById('bookingMemberDiscount').textContent = (discounts[tierType] || '10%') + ' OFF';
            } else {
                selectedBookingMemberType = null;
                document.getElementById('bookingMemberBadge').style.display = 'none';
            }
            
            updateBookingPrice();
        }
        
        // Wrapper function for backward compatibility - routes to ID-based or name-based
        function selectBookingCustomer(firstArg, isMember, tierType) {
            // Check if first argument is a customer ID (number) or name (string with spaces)
            if (typeof firstArg === 'number' || (typeof firstArg === 'string' && !firstArg.includes(' ') && !isNaN(parseInt(firstArg)))) {
                // It's an ID - use the ID-based selector (defined later in the file)
                selectBookingCustomerById(parseInt(firstArg));
            } else {
                // It's a name - use the name-based selector
                selectBookingCustomerByName(firstArg, isMember, tierType);
            }
        }

        // Initialize tee sheet date picker
        document.getElementById('teeSheetDate').value = new Date().toISOString().split('T')[0];
        
        // Load tabs before rendering
        loadTabs();
        
        renderTeeSheet();
        renderFloorPlan();
        renderOpenTabs();
        renderCart();
        renderRecentTrans();
        renderSuspendedSales();
        renderCalendar();
        renderSalesItems();
        updateDateDisplay();
        updateDailySummary();
        loadDailyNotes();
        
        // Update daily summary every 30 seconds
        setInterval(updateDailySummary, 30000);
        
        // Daily Summary Functions
        function updateDailySummary() {
            const today = new Date().toDateString();
            const todaysTrans = transactions.filter(t => new Date(t.date || Date.now()).toDateString() === today);
            const todaysSales = todaysTrans.reduce((sum, t) => sum + t.amount, 0);
            const openTabCount = openTabs.length;
            
            document.getElementById('summaryTodaySales').textContent = '$' + todaysSales.toFixed(2);
            document.getElementById('summaryTodayTrans').textContent = todaysTrans.length;
            document.getElementById('summaryOpenTabs').textContent = openTabCount;
        }
        
        function saveDailyNotes() {
            const notes = document.getElementById('dailyNotes').value;
            const today = new Date().toDateString();
            localStorage.setItem('gc_daily_notes_' + today, notes);
        }
        
        function loadDailyNotes() {
            const today = new Date().toDateString();
            const notes = localStorage.getItem('gc_daily_notes_' + today) || '';
            document.getElementById('dailyNotes').value = notes;
        }
        
        // Check for quickbook customer from customers page
        const quickbookCustomer = localStorage.getItem('gc_quickbook_customer');
        if (quickbookCustomer) {
            try {
                const customer = JSON.parse(quickbookCustomer);
                document.getElementById('bookingCustomer').value = `${customer.firstName} ${customer.lastName}`;
                showModal('booking');
                showToast(`Creating booking for ${customer.firstName} ${customer.lastName}`);
            } catch (e) {}
            localStorage.removeItem('gc_quickbook_customer');
        }
        
        // Show welcome toast on load
        setTimeout(() => showToast('POS System Ready', 'success'), 500);
        
        // ============ DATA IMPORT/EXPORT FOR TEE SHEET ============
        function showDataImportModal() {
            const html = `
                <div id="dataImportModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:800px;width:95%;max-height:90vh;overflow-y:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h3 style="margin:0;"><i class="fas fa-database"></i> Import/Export Data</h3>
                            <button onclick="closeDataImportModal()" style="border:none;background:none;font-size:24px;cursor:pointer;color:#999;">&times;</button>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:15px;margin-bottom:20px;">
                            <div onclick="selectImportType('bookings')" class="import-card" id="import-bookings" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;">
                                <i class="fas fa-calendar-alt" style="font-size:30px;color:#27ae60;margin-bottom:10px;display:block;"></i>
                                <strong>Bookings</strong>
                                <div style="font-size:11px;color:#666;">Tee times, reservations</div>
                            </div>
                            <div onclick="selectImportType('customers')" class="import-card" id="import-customers" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;">
                                <i class="fas fa-users" style="font-size:30px;color:#3498db;margin-bottom:10px;display:block;"></i>
                                <strong>Customers</strong>
                                <div style="font-size:11px;color:#666;">Customer database</div>
                            </div>
                            <div onclick="selectImportType('members')" class="import-card" id="import-members" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;">
                                <i class="fas fa-id-card" style="font-size:30px;color:#f1c40f;margin-bottom:10px;display:block;"></i>
                                <strong>Members</strong>
                                <div style="font-size:11px;color:#666;">Membership data</div>
                            </div>
                            <div onclick="selectImportType('transactions')" class="import-card" id="import-transactions" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;">
                                <i class="fas fa-receipt" style="font-size:30px;color:#9b59b6;margin-bottom:10px;display:block;"></i>
                                <strong>Transactions</strong>
                                <div style="font-size:11px;color:#666;">Historical sales</div>
                            </div>
                        </div>
                        
                        <div id="importUploadSection" style="display:none;">
                            <div style="border:2px dashed #ccc;border-radius:10px;padding:40px;text-align:center;margin-bottom:15px;background:#fafafa;" 
                                 ondrop="handleImportFileDrop(event)" ondragover="event.preventDefault();this.style.borderColor='#27ae60';this.style.background='#e8f5e9'" ondragleave="this.style.borderColor='#ccc';this.style.background='#fafafa'">
                                <i class="fas fa-cloud-upload-alt" style="font-size:40px;color:#ccc;margin-bottom:10px;"></i>
                                <div style="margin-bottom:10px;color:#666;">Drag & drop CSV or JSON file here</div>
                                <input type="file" id="importFileInput" accept=".csv,.json" style="display:none;" onchange="handleImportFileSelect(event)">
                                <button onclick="document.getElementById('importFileInput').click()" style="padding:10px 25px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                    <i class="fas fa-folder-open"></i> Choose File
                                </button>
                            </div>
                            
                            <div id="importMappingSection" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                                <h4 style="margin:0 0 10px;"><i class="fas fa-link"></i> Field Mapping</h4>
                                <div id="mappingFields"></div>
                            </div>
                            
                            <div id="importPreviewSection" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;max-height:250px;overflow:auto;">
                                <h4 style="margin:0 0 10px;"><i class="fas fa-eye"></i> Preview</h4>
                                <div id="previewTable"></div>
                            </div>
                            
                            <div style="display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap;">
                                <label style="flex:1;min-width:150px;display:flex;align-items:center;gap:8px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateHandling" value="skip" checked> Skip duplicates
                                </label>
                                <label style="flex:1;min-width:150px;display:flex;align-items:center;gap:8px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateHandling" value="update"> Update existing
                                </label>
                                <label style="flex:1;min-width:150px;display:flex;align-items:center;gap:8px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateHandling" value="create"> Create all new
                                </label>
                            </div>
                            
                            <div style="background:#e8f5e9;padding:12px;border-radius:8px;margin-bottom:15px;display:flex;align-items:center;gap:10px;">
                                <i class="fas fa-download" style="color:#27ae60;"></i>
                                <span style="flex:1;font-size:13px;">Need a template?</span>
                                <button onclick="downloadImportTemplate()" style="padding:8px 15px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                                    <i class="fas fa-file-download"></i> Download Template
                                </button>
                            </div>
                        </div>
                        
                        <div style="border-top:1px solid #eee;padding-top:15px;margin-top:15px;">
                            <h4 style="margin:0 0 15px;"><i class="fas fa-download"></i> Export Data</h4>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <button onclick="exportDataType('bookings')" style="padding:10px 15px;background:#fff;border:1px solid #27ae60;color:#27ae60;border-radius:6px;cursor:pointer;font-size:13px;"><i class="fas fa-calendar"></i> Bookings</button>
                                <button onclick="exportDataType('customers')" style="padding:10px 15px;background:#fff;border:1px solid #3498db;color:#3498db;border-radius:6px;cursor:pointer;font-size:13px;"><i class="fas fa-users"></i> Customers</button>
                                <button onclick="exportDataType('transactions')" style="padding:10px 15px;background:#fff;border:1px solid #9b59b6;color:#9b59b6;border-radius:6px;cursor:pointer;font-size:13px;"><i class="fas fa-receipt"></i> Transactions</button>
                                <button onclick="exportAllDataBackup()" style="padding:10px 15px;background:#e74c3c;border:none;color:#fff;border-radius:6px;cursor:pointer;font-size:13px;"><i class="fas fa-archive"></i> Full Backup</button>
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:10px;margin-top:20px;">
                            <button onclick="closeDataImportModal()" style="flex:1;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button id="executeImportBtn" onclick="executeDataImport()" style="flex:1;padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;display:none;"><i class="fas fa-check"></i> Import Data</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        let selectedImportType = null;
        let pendingImportData = null;
        let importFieldMapping = {};
        
        function selectImportType(type) {
            selectedImportType = type;
            document.querySelectorAll('.import-card').forEach(c => c.style.borderColor = '#ddd');
            document.getElementById('import-' + type).style.borderColor = '#27ae60';
            document.getElementById('importUploadSection').style.display = 'block';
            document.getElementById('importMappingSection').style.display = 'none';
            document.getElementById('importPreviewSection').style.display = 'none';
            document.getElementById('executeImportBtn').style.display = 'none';
            pendingImportData = null;
        }
        
        function handleImportFileDrop(e) {
            e.preventDefault();
            e.target.style.borderColor = '#ccc';
            e.target.style.background = '#fafafa';
            const file = e.dataTransfer.files[0];
            if (file) processImportFile(file);
        }
        
        function handleImportFileSelect(e) {
            const file = e.target.files[0];
            if (file) processImportFile(file);
        }
        
        function processImportFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let data;
                
                if (file.name.endsWith('.json')) {
                    try {
                        data = JSON.parse(content);
                        if (!Array.isArray(data)) data = [data];
                    } catch (err) {
                        return showToast('Invalid JSON file', 'error');
                    }
                } else {
                    data = parseCSVForImport(content);
                }
                
                if (!data || data.length === 0) {
                    return showToast('No data found in file', 'error');
                }
                
                pendingImportData = data;
                showFieldMapping(data);
                showToast(`Found ${data.length} records`, 'success');
            };
            reader.readAsText(file);
        }
        
        function parseCSVForImport(content) {
            const lines = content.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = parseCSVLineAdmin(lines[0]);
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLineAdmin(lines[i]);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim().toLowerCase().replace(/\s+/g, '_')] = values[idx] || '';
                });
                rows.push(row);
            }
            return rows;
        }
        
        function parseCSVLineAdmin(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') inQuotes = !inQuotes;
                else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function showFieldMapping(data) {
            const sample = data[0];
            const fileFields = Object.keys(sample);
            
            const expectedFields = {
                bookings: ['date', 'time', 'customer', 'players', 'room', 'bay', 'notes', 'status'],
                customers: ['first_name', 'last_name', 'email', 'phone', 'address', 'city', 'state', 'zip'],
                members: ['first_name', 'last_name', 'email', 'member_type', 'member_since', 'expires', 'passes_remaining'],
                transactions: ['date', 'time', 'customer', 'amount', 'method', 'items', 'tax']
            };
            
            const fields = expectedFields[selectedImportType] || [];
            importFieldMapping = {};
            
            // Auto-detect
            fields.forEach(field => {
                const found = fileFields.find(f => {
                    const fLower = f.toLowerCase();
                    return fLower === field || fLower.includes(field) || field.includes(fLower);
                });
                if (found) importFieldMapping[field] = found;
            });
            
            let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
            fields.forEach(field => {
                html += `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <label style="min-width:100px;font-weight:600;font-size:13px;">${field}:</label>
                        <select id="mapping_${field}" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px;font-size:13px;">
                            <option value="">-- Skip --</option>
                            ${fileFields.map(f => `<option value="${f}" ${importFieldMapping[field] === f ? 'selected' : ''}>${f}</option>`).join('')}
                        </select>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('mappingFields').innerHTML = html;
            document.getElementById('importMappingSection').style.display = 'block';
            
            // Show preview
            showImportPreview(data.slice(0, 5));
        }
        
        function showImportPreview(data) {
            if (!data.length) return;
            
            let html = `<div style="font-size:12px;color:#666;margin-bottom:8px;">Showing ${Math.min(5, data.length)} of ${pendingImportData.length} records</div>`;
            html += '<table style="width:100%;border-collapse:collapse;font-size:11px;">';
            html += '<tr style="background:#e9ecef;">' + Object.keys(data[0]).slice(0, 6).map(k => `<th style="padding:6px;border:1px solid #ddd;text-align:left;">${k}</th>`).join('') + '</tr>';
            data.forEach(row => {
                html += '<tr>' + Object.values(row).slice(0, 6).map(v => `<td style="padding:6px;border:1px solid #ddd;">${String(v).substring(0, 25)}</td>`).join('') + '</tr>';
            });
            html += '</table>';
            
            document.getElementById('previewTable').innerHTML = html;
            document.getElementById('importPreviewSection').style.display = 'block';
            document.getElementById('executeImportBtn').style.display = 'block';
        }
        
        function executeDataImport() {
            if (!pendingImportData || !selectedImportType) {
                return showToast('No data to import', 'error');
            }
            
            const duplicateHandling = document.querySelector('input[name="duplicateHandling"]:checked').value;
            
            // Gather current mapping
            const expectedFields = {
                bookings: ['date', 'time', 'customer', 'players', 'room', 'bay', 'notes', 'status'],
                customers: ['first_name', 'last_name', 'email', 'phone', 'address', 'city', 'state', 'zip'],
                members: ['first_name', 'last_name', 'email', 'member_type', 'member_since', 'expires', 'passes_remaining'],
                transactions: ['date', 'time', 'customer', 'amount', 'method', 'items', 'tax']
            };
            
            const mapping = {};
            (expectedFields[selectedImportType] || []).forEach(field => {
                const sel = document.getElementById('mapping_' + field);
                if (sel && sel.value) mapping[field] = sel.value;
            });
            
            let imported = 0, skipped = 0, updated = 0;
            
            if (selectedImportType === 'bookings') {
                pendingImportData.forEach(row => {
                    const booking = {
                        id: bookings.length + imported + 1,
                        date: row[mapping.date] || new Date().toISOString().split('T')[0],
                        time: row[mapping.time] || '9:00 AM',
                        customer: row[mapping.customer] || 'Imported Customer',
                        players: parseInt(row[mapping.players]) || 1,
                        room: parseInt(row[mapping.room]) || parseInt(row[mapping.bay]) || 1,
                        notes: row[mapping.notes] || '',
                        status: row[mapping.status] || 'booked',
                        imported: true,
                        importDate: new Date().toISOString()
                    };
                    
                    // Check for duplicate (same customer, date, time)
                    const existing = bookings.findIndex(b => 
                        b.customer.toLowerCase() === booking.customer.toLowerCase() &&
                        b.date === booking.date &&
                        b.time === booking.time
                    );
                    
                    if (existing >= 0) {
                        if (duplicateHandling === 'skip') return skipped++;
                        if (duplicateHandling === 'update') {
                            bookings[existing] = { ...bookings[existing], ...booking, id: bookings[existing].id };
                            return updated++;
                        }
                    }
                    
                    bookings.push(booking);
                    imported++;
                });
                localStorage.setItem('gc_bookings', JSON.stringify(bookings));
                renderTeeSheet();
            }
            
            else if (selectedImportType === 'customers' || selectedImportType === 'members') {
                let customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                
                pendingImportData.forEach(row => {
                    const firstName = row[mapping.first_name] || '';
                    const lastName = row[mapping.last_name] || '';
                    const email = row[mapping.email] || '';
                    
                    if (!firstName && !lastName && !email) return skipped++;
                    
                    const customer = {
                        id: Date.now() + imported,
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        phone: row[mapping.phone] || '',
                        address: row[mapping.address] || '',
                        city: row[mapping.city] || '',
                        state: row[mapping.state] || '',
                        zip: row[mapping.zip] || '',
                        isMember: selectedImportType === 'members' || row[mapping.member_type] ? true : false,
                        memberType: row[mapping.member_type] || '',
                        memberSince: row[mapping.member_since] || null,
                        memberExpires: row[mapping.expires] || null,
                        passesRemaining: parseInt(row[mapping.passes_remaining]) || 0,
                        imported: true,
                        importDate: new Date().toISOString()
                    };
                    
                    const existing = customers.findIndex(c => 
                        (email && c.email && c.email.toLowerCase() === email.toLowerCase()) ||
                        (`${c.firstName} ${c.lastName}`.toLowerCase() === `${firstName} ${lastName}`.toLowerCase())
                    );
                    
                    if (existing >= 0) {
                        if (duplicateHandling === 'skip') return skipped++;
                        if (duplicateHandling === 'update') {
                            customers[existing] = { ...customers[existing], ...customer, id: customers[existing].id };
                            return updated++;
                        }
                    }
                    
                    customers.push(customer);
                    imported++;
                });
                
                localStorage.setItem('gc_customers', JSON.stringify(customers));
            }
            
            else if (selectedImportType === 'transactions') {
                pendingImportData.forEach(row => {
                    const amount = parseFloat(row[mapping.amount]) || 0;
                    const trans = {
                        id: transactions.length + imported + 26763,
                        date: row[mapping.date] || new Date().toISOString(),
                        time: row[mapping.time] || '12:00 PM',
                        customer: row[mapping.customer] || 'Imported',
                        amount: amount,
                        subtotal: amount / (1 + getTaxRate()) || 0,
                        tax: parseFloat(row[mapping.tax]) || (amount * getTaxRate() / (1 + getTaxRate())) || 0,
                        method: row[mapping.method] || 'cash',
                        items: [],
                        itemCount: 0,
                        discount: 0,
                        isReturn: false,
                        imported: true,
                        importDate: new Date().toISOString(),
                        register: 'IMPORT'
                    };
                    
                    transactions.push(trans);
                    imported++;
                });
                
                localStorage.setItem('gc_transactions', JSON.stringify(transactions));
                renderRecentTrans();
            }
            
            // Log import history
            const history = JSON.parse(localStorage.getItem('gc_import_history') || '[]');
            history.unshift({
                type: selectedImportType,
                date: new Date().toISOString(),
                imported,
                skipped,
                updated,
                total: pendingImportData.length
            });
            localStorage.setItem('gc_import_history', JSON.stringify(history.slice(0, 50)));
            
            closeDataImportModal();
            showToast(`Import complete: ${imported} added, ${updated} updated, ${skipped} skipped`, 'success');
        }
        
        function downloadImportTemplate() {
            const templates = {
                bookings: 'date,time,customer,players,room,notes,status\n2024-01-15,9:00 AM,John Doe,4,1,"Birthday party",booked\n2024-01-15,10:00 AM,Jane Smith,2,2,"",confirmed',
                customers: 'first_name,last_name,email,phone,address,city,state,zip\nJohn,Doe,john@email.com,555-1234,123 Main St,Hartford,CT,06101\nJane,Smith,jane@email.com,555-5678,456 Oak Ave,West Hartford,CT,06107',
                members: 'first_name,last_name,email,member_type,member_since,expires,passes_remaining\nJohn,Doe,john@email.com,Gold,2024-01-01,2025-01-01,10\nJane,Smith,jane@email.com,Silver,2024-06-01,2025-06-01,5',
                transactions: 'date,time,customer,amount,method,items,tax\n2024-01-15,10:30 AM,John Doe,45.75,card,"Hot Dog x2, Beer x1",2.75\n2024-01-15,11:00 AM,Jane Smith,12.50,cash,"Soda x2",0.75'
            };
            
            const content = templates[selectedImportType] || '';
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedImportType}_template.csv`;
            a.click();
            showToast('Template downloaded', 'success');
        }
        
        function exportDataType(type) {
            let data, filename;
            
            if (type === 'bookings') {
                let csv = 'date,time,customer,players,room,notes,status\n';
                bookings.forEach(b => {
                    csv += `"${b.date || ''}","${b.time}","${b.customer}",${b.players},${b.room},"${b.notes || ''}","${b.status || 'booked'}"\n`;
                });
                data = csv;
                filename = `bookings_${new Date().toISOString().split('T')[0]}.csv`;
            }
            else if (type === 'customers') {
                const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                let csv = 'first_name,last_name,email,phone,is_member,member_type,member_expires\n';
                customers.forEach(c => {
                    csv += `"${c.firstName || ''}","${c.lastName || ''}","${c.email || ''}","${c.phone || ''}",${c.isMember ? 'true' : 'false'},"${c.memberType || ''}","${c.memberExpires || ''}"\n`;
                });
                data = csv;
                filename = `customers_${new Date().toISOString().split('T')[0]}.csv`;
            }
            else if (type === 'transactions') {
                let csv = 'id,date,time,customer,amount,method\n';
                transactions.forEach(t => {
                    csv += `${t.id},"${t.date || ''}","${t.time}","${t.customer}",${t.amount.toFixed(2)},"${t.method}"\n`;
                });
                data = csv;
                filename = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
            }
            
            const blob = new Blob([data], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            showToast(`${type} exported`, 'success');
        }
        
        function exportAllDataBackup() {
            const backup = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                bookings: bookings,
                customers: JSON.parse(localStorage.getItem('gc_customers') || '[]'),
                transactions: transactions,
                openTabs: openTabs,
                suspended: JSON.parse(localStorage.getItem('gc_suspended') || '[]'),
                settings: {
                    stripePK: localStorage.getItem('gc_stripe_pk'),
                    stripeLocation: localStorage.getItem('gc_stripe_location'),
                    registerId: localStorage.getItem('gc_register_id')
                }
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `golf_cove_backup_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('Full backup created', 'success');
        }
        
        function closeDataImportModal() {
            const modal = document.getElementById('dataImportModal');
            if (modal) modal.remove();
            pendingImportData = null;
            selectedImportType = null;
            importFieldMapping = {};
        }
        
        // ============ MIGRATION WIZARD ============
        let wizardStep = 1;
        
        function showMigrationWizard() {
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const hasData = customers.length > 0 || bookings.length > 0 || transactions.length > 0;
            
            const html = `
                <div id="migrationWizard" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;border-radius:12px;max-width:800px;width:95%;max-height:90vh;overflow:hidden;display:flex;flex-direction:column;">
                        <div style="background:linear-gradient(135deg, #4a90a4, #2c3e50);color:#fff;padding:20px 25px;">
                            <h2 style="margin:0;"><i class="fas fa-magic"></i> Golf Cove Setup & Migration</h2>
                            <p style="margin:5px 0 0;opacity:0.8;font-size:14px;">Import data from your previous system</p>
                        </div>
                        
                        <div style="padding:25px;overflow-y:auto;flex:1;" id="wizardContent">
                            ${getWizardStep(1, hasData)}
                        </div>
                        
                        <div style="padding:15px 25px;border-top:1px solid #eee;display:flex;justify-content:space-between;background:#f8f9fa;">
                            <button onclick="closeMigrationWizard()" style="padding:10px 20px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;">Close</button>
                            <div id="wizardNavButtons">
                                <button id="wizardNextBtn" onclick="nextWizardStep()" style="padding:10px 25px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                    Get Started <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            wizardStep = 1;
        }
        
        function getWizardStep(step, hasData) {
            if (step === 1) {
                return `
                    <div style="text-align:center;padding:20px 0;">
                        <img src="images/golfCoveLogo6.png" alt="Golf Cove" style="height:80px;margin-bottom:20px;">
                        <h3 style="margin:0 0 10px;">Welcome to Golf Cove POS</h3>
                        <p style="color:#666;margin-bottom:30px;">Let's set up your system and import your data</p>
                        
                        ${hasData ? `
                            <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:20px;text-align:left;">
                                <i class="fas fa-check-circle" style="color:#27ae60;"></i>
                                <strong>Data Already Present</strong>
                                <div style="font-size:13px;color:#666;margin-top:5px;">
                                    You already have data in the system. The wizard will help you add more.
                                </div>
                            </div>
                        ` : ''}
                        
                        <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;text-align:center;margin-top:20px;">
                            <div style="padding:20px;background:#f8f9fa;border-radius:10px;">
                                <i class="fas fa-users" style="font-size:30px;color:#3498db;margin-bottom:10px;display:block;"></i>
                                <strong>Step 1</strong>
                                <div style="font-size:12px;color:#666;">Import Customers</div>
                            </div>
                            <div style="padding:20px;background:#f8f9fa;border-radius:10px;">
                                <i class="fas fa-id-card" style="font-size:30px;color:#f1c40f;margin-bottom:10px;display:block;"></i>
                                <strong>Step 2</strong>
                                <div style="font-size:12px;color:#666;">Import Members</div>
                            </div>
                            <div style="padding:20px;background:#f8f9fa;border-radius:10px;">
                                <i class="fas fa-calendar" style="font-size:30px;color:#27ae60;margin-bottom:10px;display:block;"></i>
                                <strong>Step 3</strong>
                                <div style="font-size:12px;color:#666;">Import Bookings</div>
                            </div>
                        </div>
                    </div>
                `;
            } else if (step === 2) {
                return `
                    <div>
                        <h3><i class="fas fa-users"></i> Step 1: Import Customers</h3>
                        <p style="color:#666;margin-bottom:20px;">Import your customer database from CSV or JSON</p>
                        
                        <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <strong><i class="fas fa-lightbulb"></i> Tip:</strong> Export your customers from your previous system as a CSV file
                        </div>
                        
                        <div style="border:2px dashed #ccc;border-radius:10px;padding:40px;text-align:center;margin-bottom:20px;background:#fafafa;" id="customerDropZone"
                             ondrop="handleWizardDrop(event, 'customers')" ondragover="event.preventDefault();this.style.borderColor='#27ae60'">
                            <i class="fas fa-cloud-upload-alt" style="font-size:50px;color:#ccc;margin-bottom:15px;"></i>
                            <div style="font-size:16px;margin-bottom:10px;">Drag & drop customer file here</div>
                            <input type="file" id="wizardCustomerFile" accept=".csv,.json" style="display:none;" onchange="handleWizardFile(this.files[0], 'customers')">
                            <button onclick="document.getElementById('wizardCustomerFile').click()" style="padding:12px 25px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                <i class="fas fa-folder-open"></i> Choose File
                            </button>
                        </div>
                        
                        <div id="wizardCustomerPreview"></div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;">
                            <strong>Expected CSV Format:</strong>
                            <code style="display:block;margin-top:10px;background:#fff;padding:10px;border-radius:4px;font-size:12px;">
                                first_name,last_name,email,phone,member,member_type,expires
                            </code>
                        </div>
                    </div>
                `;
            } else if (step === 3) {
                return `
                    <div>
                        <h3><i class="fas fa-id-card"></i> Step 2: Import Memberships</h3>
                        <p style="color:#666;margin-bottom:20px;">Import membership data (can also update existing customers)</p>
                        
                        <div style="border:2px dashed #ccc;border-radius:10px;padding:40px;text-align:center;margin-bottom:20px;background:#fafafa;"
                             ondrop="handleWizardDrop(event, 'members')" ondragover="event.preventDefault();this.style.borderColor='#f1c40f'">
                            <i class="fas fa-cloud-upload-alt" style="font-size:50px;color:#ccc;margin-bottom:15px;"></i>
                            <div style="font-size:16px;margin-bottom:10px;">Drag & drop membership file here</div>
                            <input type="file" id="wizardMemberFile" accept=".csv,.json" style="display:none;" onchange="handleWizardFile(this.files[0], 'members')">
                            <button onclick="document.getElementById('wizardMemberFile').click()" style="padding:12px 25px;background:#f1c40f;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                <i class="fas fa-folder-open"></i> Choose File
                            </button>
                        </div>
                        
                        <div id="wizardMemberPreview"></div>
                        
                        <p style="color:#888;font-size:13px;"><i class="fas fa-info-circle"></i> This step is optional if membership data was included with customers</p>
                    </div>
                `;
            } else if (step === 4) {
                return `
                    <div>
                        <h3><i class="fas fa-calendar"></i> Step 3: Import Bookings</h3>
                        <p style="color:#666;margin-bottom:20px;">Import existing bookings and reservations</p>
                        
                        <div style="border:2px dashed #ccc;border-radius:10px;padding:40px;text-align:center;margin-bottom:20px;background:#fafafa;"
                             ondrop="handleWizardDrop(event, 'bookings')" ondragover="event.preventDefault();this.style.borderColor='#27ae60'">
                            <i class="fas fa-cloud-upload-alt" style="font-size:50px;color:#ccc;margin-bottom:15px;"></i>
                            <div style="font-size:16px;margin-bottom:10px;">Drag & drop bookings file here</div>
                            <input type="file" id="wizardBookingFile" accept=".csv,.json" style="display:none;" onchange="handleWizardFile(this.files[0], 'bookings')">
                            <button onclick="document.getElementById('wizardBookingFile').click()" style="padding:12px 25px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                <i class="fas fa-folder-open"></i> Choose File
                            </button>
                        </div>
                        
                        <div id="wizardBookingPreview"></div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;">
                            <strong>Expected CSV Format:</strong>
                            <code style="display:block;margin-top:10px;background:#fff;padding:10px;border-radius:4px;font-size:12px;">
                                date,time,customer,players,bay,notes
                            </code>
                        </div>
                    </div>
                `;
            } else if (step === 5) {
                const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                const memberCount = customers.filter(c => c.isMember).length;
                
                return `
                    <div style="text-align:center;padding:20px;">
                        <i class="fas fa-check-circle" style="font-size:80px;color:#27ae60;margin-bottom:20px;"></i>
                        <h2 style="margin:0 0 10px;color:#27ae60;">Setup Complete!</h2>
                        <p style="color:#666;margin-bottom:30px;">Your Golf Cove POS is ready to use</p>
                        
                        <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:30px;">
                            <div style="background:#e8f5e9;padding:20px;border-radius:10px;">
                                <div style="font-size:36px;font-weight:700;color:#27ae60;">${customers.length}</div>
                                <div style="font-size:13px;color:#666;">Customers</div>
                            </div>
                            <div style="background:#fff3cd;padding:20px;border-radius:10px;">
                                <div style="font-size:36px;font-weight:700;color:#f1c40f;">${memberCount}</div>
                                <div style="font-size:13px;color:#666;">Members</div>
                            </div>
                            <div style="background:#e3f2fd;padding:20px;border-radius:10px;">
                                <div style="font-size:36px;font-weight:700;color:#3498db;">${bookings.length}</div>
                                <div style="font-size:13px;color:#666;">Bookings</div>
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:20px;border-radius:8px;text-align:left;">
                            <h4 style="margin:0 0 15px;"><i class="fas fa-rocket"></i> Quick Start Tips</h4>
                            <ul style="margin:0;padding-left:20px;color:#666;">
                                <li>Press <kbd style="background:#e9ecef;padding:2px 6px;border-radius:3px;">Ctrl+K</kbd> for global search</li>
                                <li>Press <kbd style="background:#e9ecef;padding:2px 6px;border-radius:3px;">F2</kbd> to create a new booking</li>
                                <li>Use the Import button to add more data anytime</li>
                                <li>Configure Stripe in Sales ‚Üí Settings (F10) for card payments</li>
                            </ul>
                        </div>
                    </div>
                `;
            }
        }
        
        function nextWizardStep() {
            wizardStep++;
            if (wizardStep > 5) {
                closeMigrationWizard();
                return;
            }
            
            const hasData = JSON.parse(localStorage.getItem('gc_customers') || '[]').length > 0;
            document.getElementById('wizardContent').innerHTML = getWizardStep(wizardStep, hasData);
            
            // Update button
            if (wizardStep === 5) {
                document.getElementById('wizardNextBtn').innerHTML = '<i class="fas fa-check"></i> Finish';
            } else if (wizardStep > 1) {
                document.getElementById('wizardNextBtn').innerHTML = 'Skip & Continue <i class="fas fa-arrow-right"></i>';
            }
        }
        
        function handleWizardDrop(e, type) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) handleWizardFile(file, type);
        }
        
        function handleWizardFile(file, type) {
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                let data;
                if (file.name.endsWith('.json')) {
                    try {
                        data = JSON.parse(e.target.result);
                        if (!Array.isArray(data)) data = data.customers || data.data || [data];
                    } catch (err) {
                        return showToast('Invalid JSON file', 'error');
                    }
                } else {
                    data = parseCSVForImport(e.target.result);
                }
                
                if (!data || data.length === 0) {
                    return showToast('No data found', 'error');
                }
                
                // Process and show preview
                const previewId = 'wizard' + type.charAt(0).toUpperCase() + type.slice(1) + 'Preview';
                const previewDiv = document.getElementById(previewId);
                
                previewDiv.innerHTML = `
                    <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:15px;">
                        <i class="fas fa-check-circle" style="color:#27ae60;"></i>
                        <strong>Found ${data.length} records</strong>
                        <button onclick="importWizardData('${type}')" style="float:right;padding:8px 15px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">
                            <i class="fas fa-upload"></i> Import Now
                        </button>
                    </div>
                    <div style="max-height:150px;overflow:auto;font-size:12px;">
                        <table style="width:100%;border-collapse:collapse;">
                            <tr style="background:#f8f9fa;">
                                ${Object.keys(data[0]).slice(0, 5).map(k => `<th style="padding:5px;border:1px solid #ddd;">${k}</th>`).join('')}
                            </tr>
                            ${data.slice(0, 3).map(row => `
                                <tr>${Object.values(row).slice(0, 5).map(v => `<td style="padding:5px;border:1px solid #ddd;">${String(v).substring(0, 20)}</td>`).join('')}</tr>
                            `).join('')}
                        </table>
                    </div>
                `;
                
                // Store data for import
                window.wizardPendingData = { type, data };
            };
            reader.readAsText(file);
        }
        
        function importWizardData(type) {
            if (!window.wizardPendingData || window.wizardPendingData.type !== type) {
                return showToast('No data to import', 'error');
            }
            
            const data = window.wizardPendingData.data;
            let imported = 0;
            
            if (type === 'customers' || type === 'members') {
                let customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                
                data.forEach(row => {
                    const firstName = row.first_name || row.firstName || row.firstname || '';
                    const lastName = row.last_name || row.lastName || row.lastname || '';
                    const email = row.email || '';
                    
                    if (!firstName && !lastName && !email) return;
                    
                    // Check for duplicate
                    const existing = customers.find(c => 
                        (email && c.email === email) ||
                        (`${c.firstName} ${c.lastName}`.toLowerCase() === `${firstName} ${lastName}`.toLowerCase())
                    );
                    
                    if (existing) {
                        // Update membership info if importing members
                        if (type === 'members') {
                            existing.isMember = true;
                            existing.memberType = row.member_type || row.memberType || existing.memberType;
                            existing.memberExpires = row.expires || row.memberExpires || existing.memberExpires;
                        }
                    } else {
                        customers.push({
                            id: Date.now() + imported,
                            firstName,
                            lastName,
                            email,
                            phone: row.phone || '',
                            isMember: type === 'members' || row.member === 'true' || row.member === 'Yes',
                            memberType: row.member_type || row.memberType || null,
                            memberExpires: row.expires || row.memberExpires || null,
                            priceClass: row.price_class || 'Regular',
                            passes: [],
                            createdAt: new Date().toISOString()
                        });
                        imported++;
                    }
                });
                
                localStorage.setItem('gc_customers', JSON.stringify(customers));
            } else if (type === 'bookings') {
                data.forEach(row => {
                    bookings.push({
                        id: bookings.length + imported + 1,
                        date: row.date || new Date().toISOString().split('T')[0],
                        time: row.time || '9:00 AM',
                        customer: row.customer || row.name || 'Guest',
                        players: parseInt(row.players) || 1,
                        room: parseInt(row.bay || row.room) || 1,
                        notes: row.notes || '',
                        status: 'booked'
                    });
                    imported++;
                });
                localStorage.setItem('gc_bookings', JSON.stringify(bookings));
                renderTeeSheet();
            }
            
            showToast(`Imported ${imported} ${type}!`, 'success');
            window.wizardPendingData = null;
            
            // Update preview
            const previewId = 'wizard' + type.charAt(0).toUpperCase() + type.slice(1) + 'Preview';
            document.getElementById(previewId).innerHTML = `
                <div style="background:#e8f5e9;padding:15px;border-radius:8px;">
                    <i class="fas fa-check-circle" style="color:#27ae60;"></i>
                    <strong>Successfully imported ${imported} records!</strong>
                </div>
            `;
        }
        
        function closeMigrationWizard() {
            const modal = document.getElementById('migrationWizard');
            if (modal) modal.remove();
            wizardStep = 1;
            window.wizardPendingData = null;
        }
        
        // ============ ANALYTICS DASHBOARD ============
        function showAnalytics() {
            const transactions = JSON.parse(localStorage.getItem('gc_transactions') || '[]');
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const dailySales = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            
            // Calculate metrics
            const today = new Date().toDateString();
            const todayData = dailySales[today] || { total: 0, count: 0 };
            
            // Last 7 days
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const key = d.toDateString();
                last7Days.push({
                    date: d.toLocaleDateString('en-US', { weekday: 'short' }),
                    sales: dailySales[key]?.total || 0,
                    count: dailySales[key]?.count || 0
                });
            }
            
            const totalLast7 = last7Days.reduce((sum, d) => sum + d.sales, 0);
            const transLast7 = last7Days.reduce((sum, d) => sum + d.count, 0);
            const avgPerDay = totalLast7 / 7;
            
            // Top customers
            const sortedCustomers = [...customers]
                .filter(c => c.totalSpent > 0)
                .sort((a, b) => (b.totalSpent || 0) - (a.totalSpent || 0))
                .slice(0, 5);
            
            // Members vs non-members
            const memberCount = customers.filter(c => c.isMember).length;
            const nonMemberCount = customers.length - memberCount;
            
            const html = `
                <div id="analyticsModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;overflow:auto;">
                    <div style="background:#fff;padding:30px;border-radius:12px;max-width:900px;width:95%;max-height:90vh;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:25px;">
                            <h2 style="margin:0;color:#2c3e50;"><i class="fas fa-chart-bar"></i> Analytics Dashboard</h2>
                            <button onclick="closeAnalytics()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
                        </div>
                        
                        <!-- Summary Cards -->
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:25px;">
                            <div style="background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:20px;border-radius:10px;">
                                <div style="font-size:12px;opacity:0.8;">Today's Sales</div>
                                <div style="font-size:28px;font-weight:700;">$${todayData.total.toFixed(2)}</div>
                                <div style="font-size:12px;margin-top:5px;">${todayData.count} transactions</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#27ae60,#1e8449);color:#fff;padding:20px;border-radius:10px;">
                                <div style="font-size:12px;opacity:0.8;">7-Day Sales</div>
                                <div style="font-size:28px;font-weight:700;">$${totalLast7.toFixed(2)}</div>
                                <div style="font-size:12px;margin-top:5px;">${transLast7} transactions</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;padding:20px;border-radius:10px;">
                                <div style="font-size:12px;opacity:0.8;">Avg Daily</div>
                                <div style="font-size:28px;font-weight:700;">$${avgPerDay.toFixed(2)}</div>
                                <div style="font-size:12px;margin-top:5px;">per day</div>
                            </div>
                            <div style="background:linear-gradient(135deg,#e67e22,#d35400);color:#fff;padding:20px;border-radius:10px;">
                                <div style="font-size:12px;opacity:0.8;">Total Customers</div>
                                <div style="font-size:28px;font-weight:700;">${customers.length}</div>
                                <div style="font-size:12px;margin-top:5px;">${memberCount} members</div>
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">
                            <!-- Daily Sales Chart -->
                            <div style="background:#f8f9fa;padding:20px;border-radius:10px;">
                                <h4 style="margin:0 0 15px;color:#2c3e50;">Last 7 Days</h4>
                                <div style="display:flex;align-items:flex-end;height:150px;gap:10px;">
                                    ${last7Days.map(d => {
                                        const height = totalLast7 > 0 ? Math.max(10, (d.sales / Math.max(...last7Days.map(x => x.sales))) * 130) : 10;
                                        return `
                                            <div style="flex:1;text-align:center;">
                                                <div style="background:linear-gradient(180deg,#4a90a4,#3d7a8a);height:${height}px;border-radius:4px 4px 0 0;" title="$${d.sales.toFixed(2)}"></div>
                                                <div style="font-size:11px;margin-top:5px;color:#666;">${d.date}</div>
                                                <div style="font-size:10px;color:#999;">$${d.sales.toFixed(0)}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            
                            <!-- Top Customers -->
                            <div style="background:#f8f9fa;padding:20px;border-radius:10px;">
                                <h4 style="margin:0 0 15px;color:#2c3e50;">Top Customers</h4>
                                ${sortedCustomers.length > 0 ? sortedCustomers.map((c, i) => `
                                    <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #e0e0e0;">
                                        <span style="font-size:13px;">${i+1}. ${c.firstName} ${c.lastName}</span>
                                        <strong style="color:#27ae60;">$${(c.totalSpent || 0).toFixed(2)}</strong>
                                    </div>
                                `).join('') : '<p style="color:#666;font-size:13px;">No customer data yet</p>'}
                            </div>
                        </div>
                        
                        <!-- Booking Stats -->
                        <div style="margin-top:20px;background:#f8f9fa;padding:20px;border-radius:10px;">
                            <h4 style="margin:0 0 15px;color:#2c3e50;">Today's Bookings</h4>
                            <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;">
                                <div style="text-align:center;">
                                    <div style="font-size:24px;font-weight:700;color:#3498db;">${bookings.filter(b => b.date === selectedDate).length}</div>
                                    <div style="font-size:12px;color:#666;">Total Bookings</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:24px;font-weight:700;color:#27ae60;">${bookings.filter(b => b.date === selectedDate && b.status === 'checked-in').length}</div>
                                    <div style="font-size:12px;color:#666;">Checked In</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:24px;font-weight:700;color:#e67e22;">${bookings.filter(b => b.date === selectedDate && b.status === 'booked').length}</div>
                                    <div style="font-size:12px;color:#666;">Pending</div>
                                </div>
                                <div style="text-align:center;">
                                    <div style="font-size:24px;font-weight:700;color:#9b59b6;">${bookings.filter(b => b.date === selectedDate).reduce((sum, b) => sum + b.players, 0)}</div>
                                    <div style="font-size:12px;color:#666;">Total Players</div>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top:20px;text-align:right;">
                            <button onclick="exportAnalyticsReport()" style="background:#27ae60;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-download"></i> Export Report</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeAnalytics() {
            const modal = document.getElementById('analyticsModal');
            if (modal) modal.remove();
        }
        
        function exportAnalyticsReport() {
            const transactions = JSON.parse(localStorage.getItem('gc_transactions') || '[]');
            const dailySales = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            
            let csv = 'Date,Total Sales,Transaction Count,Cash,Card\n';
            Object.keys(dailySales).sort().reverse().forEach(date => {
                const d = dailySales[date];
                csv += `"${date}",${d.total.toFixed(2)},${d.count},${(d.cash || 0).toFixed(2)},${(d.card || 0).toFixed(2)}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Report exported', 'success');
        }
        
        // ============ BOOKING UTILITIES ============
        function showBulkBooking() {
            const html = `
                <div id="bulkBookingModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#4a90a4;"><i class="fas fa-calendar-plus"></i> Bulk Booking</h3>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Group/Event Name:</label>
                            <input type="text" id="bulkGroupName" placeholder="e.g., Corporate Outing" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                            <div>
                                <label style="display:block;margin-bottom:5px;font-weight:600;">Date:</label>
                                <input type="date" id="bulkDate" value="${selectedDate}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:5px;font-weight:600;">Players Per Slot:</label>
                                <select id="bulkPlayers" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4" selected>4</option>
                                </select>
                            </div>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px;margin-bottom:15px;">
                            <div>
                                <label style="display:block;margin-bottom:5px;font-weight:600;">Start Time:</label>
                                <select id="bulkStartTime" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    ${generateTimeOptions().map(t => `<option value="${t}">${t}</option>`).join('')}
                                </select>
                            </div>
                            <div>
                                <label style="display:block;margin-bottom:5px;font-weight:600;">End Time:</label>
                                <select id="bulkEndTime" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    ${generateTimeOptions().map(t => `<option value="${t}" ${t === '5:00 PM' ? 'selected' : ''}>${t}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Bays (comma-separated or range like 1-5):</label>
                            <input type="text" id="bulkBays" placeholder="1-5 or 1,3,5" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Contact Email:</label>
                            <input type="email" id="bulkEmail" placeholder="contact@email.com" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeBulkBooking()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="createBulkBooking()" style="flex:1;padding:12px;border:none;background:#4a90a4;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Create Bookings</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function generateTimeOptions() {
            const times = [];
            for (let h = 6; h <= 20; h++) {
                const hour12 = h > 12 ? h - 12 : h;
                const ampm = h >= 12 ? 'PM' : 'AM';
                times.push(`${hour12}:00 ${ampm}`);
                times.push(`${hour12}:30 ${ampm}`);
            }
            return times;
        }
        
        function closeBulkBooking() {
            const modal = document.getElementById('bulkBookingModal');
            if (modal) modal.remove();
        }
        
        function createBulkBooking() {
            const groupName = document.getElementById('bulkGroupName').value || 'Group Booking';
            const date = document.getElementById('bulkDate').value;
            const players = parseInt(document.getElementById('bulkPlayers').value);
            const startTime = document.getElementById('bulkStartTime').value;
            const endTime = document.getElementById('bulkEndTime').value;
            const baysInput = document.getElementById('bulkBays').value;
            const email = document.getElementById('bulkEmail').value;
            
            // Parse bays
            let bays = [];
            if (baysInput.includes('-')) {
                const [start, end] = baysInput.split('-').map(Number);
                for (let i = start; i <= end; i++) bays.push(i);
            } else {
                bays = baysInput.split(',').map(b => parseInt(b.trim())).filter(b => !isNaN(b));
            }
            
            if (bays.length === 0) {
                showToast('Please specify bays', 'error');
                return;
            }
            
            // Generate time slots
            const times = generateTimeOptions();
            const startIdx = times.indexOf(startTime);
            const endIdx = times.indexOf(endTime);
            
            if (startIdx === -1 || endIdx === -1 || startIdx >= endIdx) {
                showToast('Invalid time range', 'error');
                return;
            }
            
            let created = 0;
            for (let t = startIdx; t < endIdx; t++) {
                for (const bay of bays) {
                    // Check if slot is available
                    const existing = bookings.find(b => 
                        b.date === date && b.time === times[t] && b.room === bay
                    );
                    
                    if (!existing) {
                        bookings.push({
                            id: bookings.length + created + 1,
                            date: date,
                            time: times[t],
                            customer: groupName,
                            players: players,
                            room: bay,
                            notes: email ? `Contact: ${email}` : '',
                            status: 'booked',
                            isGroup: true
                        });
                        created++;
                    }
                }
            }
            
            localStorage.setItem('gc_bookings', JSON.stringify(bookings));
            closeBulkBooking();
            renderTeeSheet();
            showToast(`Created ${created} bookings for "${groupName}"`, 'success');
        }
        
        // ============ WAITLIST ============
        function showWaitlist() {
            const waitlist = JSON.parse(localStorage.getItem('gc_waitlist') || '[]');
            
            const html = `
                <div id="waitlistModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:600px;width:95%;max-height:80vh;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h3 style="margin:0;color:#e67e22;"><i class="fas fa-clock"></i> Waitlist</h3>
                            <button onclick="closeWaitlist()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
                        </div>
                        
                        <button onclick="addToWaitlist()" style="width:100%;padding:12px;background:#e67e22;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-bottom:20px;"><i class="fas fa-plus"></i> Add to Waitlist</button>
                        
                        <div id="waitlistEntries">
                            ${waitlist.length > 0 ? waitlist.map((w, i) => `
                                <div style="display:flex;align-items:center;padding:15px;background:#f8f9fa;border-radius:8px;margin-bottom:10px;">
                                    <div style="flex:1;">
                                        <strong>${w.name}</strong> - ${w.players} player(s)
                                        <div style="font-size:12px;color:#666;">${w.phone || 'No phone'} | Requested: ${w.preferredDate || 'Any'} ${w.preferredTime || ''}</div>
                                        ${w.notes ? `<div style="font-size:12px;color:#888;margin-top:3px;">${w.notes}</div>` : ''}
                                    </div>
                                    <button onclick="convertWaitlistToBooking(${i})" style="background:#27ae60;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;margin-right:5px;" title="Convert to booking"><i class="fas fa-check"></i></button>
                                    <button onclick="removeFromWaitlist(${i})" style="background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:4px;cursor:pointer;" title="Remove"><i class="fas fa-times"></i></button>
                                </div>
                            `).join('') : '<p style="color:#666;text-align:center;">No one on waitlist</p>'}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeWaitlist() {
            const modal = document.getElementById('waitlistModal');
            if (modal) modal.remove();
        }
        
        function addToWaitlist() {
            const name = prompt('Customer name:');
            if (!name) return;
            
            const phone = prompt('Phone number:');
            const players = prompt('Number of players:', '2');
            const preferredDate = prompt('Preferred date (YYYY-MM-DD or leave blank):');
            const preferredTime = prompt('Preferred time (e.g., Morning, Afternoon):');
            const notes = prompt('Notes:');
            
            const waitlist = JSON.parse(localStorage.getItem('gc_waitlist') || '[]');
            waitlist.push({
                name,
                phone,
                players: parseInt(players) || 2,
                preferredDate,
                preferredTime,
                notes,
                addedAt: new Date().toISOString()
            });
            localStorage.setItem('gc_waitlist', JSON.stringify(waitlist));
            closeWaitlist();
            showWaitlist();
            showToast('Added to waitlist', 'success');
        }
        
        function removeFromWaitlist(index) {
            if (!confirm('Remove from waitlist?')) return;
            const waitlist = JSON.parse(localStorage.getItem('gc_waitlist') || '[]');
            waitlist.splice(index, 1);
            localStorage.setItem('gc_waitlist', JSON.stringify(waitlist));
            closeWaitlist();
            showWaitlist();
        }
        
        function convertWaitlistToBooking(index) {
            const waitlist = JSON.parse(localStorage.getItem('gc_waitlist') || '[]');
            const entry = waitlist[index];
            
            // Open booking modal with pre-filled data
            const time = prompt('Time for booking:', '9:00 AM');
            const bay = prompt('Bay number:', '1');
            
            if (!time || !bay) return;
            
            bookings.push({
                id: bookings.length + 1,
                date: entry.preferredDate || selectedDate,
                time: time,
                customer: entry.name,
                players: entry.players,
                room: parseInt(bay),
                notes: entry.notes || '',
                status: 'booked'
            });
            
            localStorage.setItem('gc_bookings', JSON.stringify(bookings));
            
            // Remove from waitlist
            waitlist.splice(index, 1);
            localStorage.setItem('gc_waitlist', JSON.stringify(waitlist));
            
            closeWaitlist();
            renderTeeSheet();
            showToast(`Booking created for ${entry.name}`, 'success');
        }
        
        // ============ SETTINGS ============
        function showSettings() {
            const taxRate = localStorage.getItem('gc_tax_rate') || '6.35';
            const registerId = localStorage.getItem('gc_register_id') || 'POS-1';
            
            const html = `
                <div id="settingsModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;overflow:auto;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:95%;margin:20px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="margin:0;color:#4a90a4;"><i class="fas fa-cog"></i> POS Quick Settings</h2>
                            <button onclick="closeSettings()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
                        </div>
                        
                        <!-- Quick POS Settings -->
                        <div style="background:#f8f9fa;padding:15px;border-radius:10px;margin-bottom:15px;">
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">Tax Rate (%)</label>
                                    <input type="number" id="settingTaxRate" value="${taxRate}" step="0.01" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                                </div>
                                <div>
                                    <label style="display:block;margin-bottom:5px;font-weight:600;font-size:12px;color:#666;">Register ID</label>
                                    <input type="text" id="settingRegisterId" value="${registerId}" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;font-size:14px;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div style="display:grid;gap:8px;margin-bottom:15px;">
                            <button onclick="exportAllData(); closeSettings();" style="padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
                                <i class="fas fa-download"></i> Export Data Backup
                            </button>
                            <button onclick="showReaderSetup(); closeSettings();" style="padding:12px;background:#635bff;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
                                <i class="fas fa-credit-card"></i> Card Reader Setup
                            </button>
                            <button onclick="connectCashDrawerFromSettings()" style="padding:12px;background:#1976d2;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:13px;display:flex;align-items:center;justify-content:center;gap:8px;">
                                <i class="fas fa-cash-register"></i> ${window.CashDrawer?.isConnected ? '‚úì Drawer Connected' : 'Connect USB Drawer'}
                            </button>
                        </div>
                        
                        <!-- Admin Panel Link -->
                        <div style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding:15px;border-radius:10px;margin-bottom:15px;">
                            <p style="color:rgba(255,255,255,0.9);font-size:12px;margin:0 0 10px;">Staff management, Stripe keys, data import, and all settings are in the Head Admin panel.</p>
                            <a href="league-admin.html" style="display:block;padding:10px;background:rgba(255,255,255,0.2);color:#fff;border:none;border-radius:6px;text-align:center;text-decoration:none;font-weight:600;font-size:13px;">
                                <i class="fas fa-external-link-alt"></i> Open Head Admin Panel
                            </a>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeSettings()" style="flex:1;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                            <button onclick="saveAllSettings()" style="flex:1;padding:12px;background:#4a90a4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.remove();
        }
        
        function saveAllSettings() {
            localStorage.setItem('gc_tax_rate', document.getElementById('settingTaxRate').value);
            localStorage.setItem('gc_register_id', document.getElementById('settingRegisterId').value);
            
            closeSettings();
            showToast('Settings saved!', 'success');
        }
        
        // Connect USB cash drawer from settings
        async function connectCashDrawerFromSettings() {
            if (typeof CashDrawer === 'undefined') {
                showToast('Cash drawer module not loaded', 'error');
                return;
            }
            
            try {
                await CashDrawer.connect();
                closeSettings();
                showSettings(); // Refresh to update button text
                showToast('Cash drawer connected!', 'success');
            } catch (err) {
                showToast('Failed to connect: ' + err.message, 'error');
            }
        }

        // ============ CLOUD SYNC ============
        let lastSyncTime = localStorage.getItem('gc_last_sync') || null;
        let isSyncing = false;
        
        function showCloudSync() {
            const lastSync = lastSyncTime ? new Date(lastSyncTime).toLocaleString() : 'Never';
            
            const html = `
                <div id="cloudSyncModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:450px;width:95%;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="margin:0;color:#4a90a4;"><i class="fas fa-cloud"></i> Cloud Sync</h2>
                            <button onclick="closeCloudSync()" style="background:none;border:none;font-size:24px;cursor:pointer;color:#666;">&times;</button>
                        </div>
                        
                        <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <p style="margin:0;font-size:13px;color:#1565c0;">
                                <i class="fas fa-info-circle"></i> Sync keeps your data backed up and available across all devices.
                            </p>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                <span style="color:#666;">Last Sync:</span>
                                <strong id="lastSyncDisplay">${lastSync}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;">
                                <span style="color:#666;">Local Records:</span>
                                <strong>${JSON.parse(localStorage.getItem('gc_customers') || '[]').length} customers, ${JSON.parse(localStorage.getItem('gc_bookings') || '[]').length} bookings</strong>
                            </div>
                        </div>
                        
                        <div id="syncProgress" style="display:none;margin-bottom:20px;">
                            <div style="background:#e9ecef;border-radius:4px;height:8px;overflow:hidden;">
                                <div id="syncProgressBar" style="background:#4a90a4;height:100%;width:0%;transition:width 0.3s;"></div>
                            </div>
                            <p id="syncStatus" style="margin:10px 0 0;font-size:12px;color:#666;text-align:center;">Syncing...</p>
                        </div>
                        
                        <div style="display:grid;gap:10px;">
                            <button onclick="uploadToCloud()" id="uploadBtn" style="padding:14px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
                                <i class="fas fa-cloud-upload-alt"></i> Upload to Cloud
                            </button>
                            <button onclick="downloadFromCloud()" id="downloadBtn" style="padding:14px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;font-size:14px;">
                                <i class="fas fa-cloud-download-alt"></i> Download from Cloud
                            </button>
                            <button onclick="closeCloudSync()" style="padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeCloudSync() {
            const modal = document.getElementById('cloudSyncModal');
            if (modal) modal.remove();
        }
        
        async function uploadToCloud() {
            if (isSyncing) return;
            isSyncing = true;
            
            const uploadBtn = document.getElementById('uploadBtn');
            const progressDiv = document.getElementById('syncProgress');
            const progressBar = document.getElementById('syncProgressBar');
            const statusText = document.getElementById('syncStatus');
            
            uploadBtn.disabled = true;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            progressDiv.style.display = 'block';
            
            try {
                // Gather all data
                statusText.textContent = 'Gathering data...';
                progressBar.style.width = '20%';
                
                const data = {
                    customers: JSON.parse(localStorage.getItem('gc_customers') || '[]'),
                    bookings: JSON.parse(localStorage.getItem('gc_bookings') || '[]'),
                    transactions: JSON.parse(localStorage.getItem('gc_transactions') || '[]'),
                    settings: {
                        businessName: localStorage.getItem('gc_business_name'),
                        businessPhone: localStorage.getItem('gc_business_phone'),
                        businessEmail: localStorage.getItem('gc_business_email'),
                        taxRate: localStorage.getItem('gc_tax_rate')
                    }
                };
                
                statusText.textContent = 'Uploading to cloud...';
                progressBar.style.width = '50%';
                
                const response = await fetch('/api/fullSync', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ data })
                });
                
                progressBar.style.width = '90%';
                
                if (response.ok) {
                    const result = await response.json();
                    progressBar.style.width = '100%';
                    statusText.textContent = 'Upload complete!';
                    
                    lastSyncTime = new Date().toISOString();
                    localStorage.setItem('gc_last_sync', lastSyncTime);
                    document.getElementById('lastSyncDisplay').textContent = new Date(lastSyncTime).toLocaleString();
                    document.getElementById('syncStatusText').textContent = 'Synced';
                    
                    showToast(`Synced ${result.synced?.customers || 0} customers, ${result.synced?.bookings || 0} bookings`, 'success');
                } else {
                    throw new Error('Upload failed');
                }
            } catch (error) {
                statusText.textContent = 'Upload failed: ' + error.message;
                showToast('Sync failed. Check your connection.', 'error');
            } finally {
                isSyncing = false;
                uploadBtn.disabled = false;
                uploadBtn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> Upload to Cloud';
            }
        }
        
        async function downloadFromCloud() {
            if (isSyncing) return;
            isSyncing = true;
            
            const downloadBtn = document.getElementById('downloadBtn');
            const progressDiv = document.getElementById('syncProgress');
            const progressBar = document.getElementById('syncProgressBar');
            const statusText = document.getElementById('syncStatus');
            
            downloadBtn.disabled = true;
            downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Downloading...';
            progressDiv.style.display = 'block';
            
            try {
                statusText.textContent = 'Connecting to cloud...';
                progressBar.style.width = '30%';
                
                const response = await fetch('/api/fullPull');
                progressBar.style.width = '70%';
                
                if (response.ok) {
                    const data = await response.json();
                    
                    statusText.textContent = 'Updating local data...';
                    progressBar.style.width = '90%';
                    
                    // Merge cloud data with local (cloud wins for conflicts)
                    if (data.customers?.length) {
                        localStorage.setItem('gc_customers', JSON.stringify(data.customers));
                    }
                    if (data.bookings?.length) {
                        localStorage.setItem('gc_bookings', JSON.stringify(data.bookings));
                    }
                    if (data.transactions?.length) {
                        localStorage.setItem('gc_transactions', JSON.stringify(data.transactions));
                    }
                    if (data.settings) {
                        if (data.settings.businessName) localStorage.setItem('gc_business_name', data.settings.businessName);
                        if (data.settings.taxRate) localStorage.setItem('gc_tax_rate', data.settings.taxRate);
                    }
                    
                    progressBar.style.width = '100%';
                    statusText.textContent = 'Download complete!';
                    
                    lastSyncTime = new Date().toISOString();
                    localStorage.setItem('gc_last_sync', lastSyncTime);
                    document.getElementById('lastSyncDisplay').textContent = new Date(lastSyncTime).toLocaleString();
                    
                    showToast(`Downloaded ${data.customers?.length || 0} customers, ${data.bookings?.length || 0} bookings`, 'success');
                    
                    // Refresh displays
                    setTimeout(() => location.reload(), 1500);
                } else {
                    throw new Error('Download failed');
                }
            } catch (error) {
                statusText.textContent = 'Download failed: ' + error.message;
                showToast('Download failed. Check your connection.', 'error');
            } finally {
                isSyncing = false;
                downloadBtn.disabled = false;
                downloadBtn.innerHTML = '<i class="fas fa-cloud-download-alt"></i> Download from Cloud';
            }
        }
        
        // Auto-sync indicator update
        function updateSyncStatus() {
            const statusText = document.getElementById('syncStatusText');
            if (statusText) {
                if (lastSyncTime) {
                    const lastSync = new Date(lastSyncTime);
                    const hoursSince = (Date.now() - lastSync.getTime()) / (1000 * 60 * 60);
                    if (hoursSince < 1) {
                        statusText.textContent = 'Synced';
                        statusText.parentElement.style.borderColor = '#27ae60';
                    } else if (hoursSince < 24) {
                        statusText.textContent = Math.floor(hoursSince) + 'h ago';
                    } else {
                        statusText.textContent = 'Sync';
                        statusText.parentElement.style.borderColor = '#f39c12';
                    }
                }
            }
        }

        // Employee PIN Login Functions (employees managed in Head Admin panel)
        function updatePinEmployeeButtons() {
            const container = document.getElementById('pinEmployeeButtons');
            if (!container) return;
            
            if (employees.length === 0) {
                container.innerHTML = '<p style="color: rgba(255,255,255,0.5);">No employees configured. <a href="league-admin.html" style="color:#4a90a4;">Add staff in Head Admin</a></p>';
                return;
            }
            
            container.innerHTML = employees.map(emp => `
                <button onclick="selectPinEmployee('${emp.name}')" style="padding: 15px 25px; font-size: 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                    ${emp.name}
                </button>
            `).join('');
        }
        
        function selectPinEmployee(name) {
            selectedPinEmployee = name;
            document.getElementById('pinEmployeeSelect').style.display = 'none';
            document.getElementById('pinEntrySection').style.display = 'block';
            document.getElementById('pinEmployeeName').textContent = name;
            currentPin = '';
            updatePinDisplay();
        }
        
        function backToEmployeeSelect() {
            selectedPinEmployee = null;
            currentPin = '';
            document.getElementById('pinEmployeeSelect').style.display = 'block';
            document.getElementById('pinEntrySection').style.display = 'none';
        }
        
        function exportAllData() {
            const data = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                settings: {
                    businessName: localStorage.getItem('gc_business_name'),
                    businessPhone: localStorage.getItem('gc_business_phone'),
                    businessEmail: localStorage.getItem('gc_business_email'),
                    taxRate: localStorage.getItem('gc_tax_rate')
                },
                bookings: JSON.parse(localStorage.getItem('gc_bookings') || '[]'),
                customers: JSON.parse(localStorage.getItem('gc_customers') || '[]'),
                transactions: JSON.parse(localStorage.getItem('gc_transactions') || '[]'),
                tabs: JSON.parse(localStorage.getItem('gc_tabs') || '[]'),
                inventory: JSON.parse(localStorage.getItem('gc_inventory') || '[]'),
                giftCards: JSON.parse(localStorage.getItem('gc_gift_cards') || '{}')
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `golf-cove-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Data exported successfully!', 'success');
        }
        
        function importDataFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (data.bookings) localStorage.setItem('gc_bookings', JSON.stringify(data.bookings));
                        if (data.customers) localStorage.setItem('gc_customers', JSON.stringify(data.customers));
                        if (data.transactions) localStorage.setItem('gc_transactions', JSON.stringify(data.transactions));
                        if (data.tabs) localStorage.setItem('gc_tabs', JSON.stringify(data.tabs));
                        if (data.inventory) localStorage.setItem('gc_inventory', JSON.stringify(data.inventory));
                        if (data.giftCards) localStorage.setItem('gc_gift_cards', JSON.stringify(data.giftCards));
                        if (data.settings) {
                            if (data.settings.businessName) localStorage.setItem('gc_business_name', data.settings.businessName);
                            if (data.settings.businessPhone) localStorage.setItem('gc_business_phone', data.settings.businessPhone);
                            if (data.settings.taxRate) localStorage.setItem('gc_tax_rate', data.settings.taxRate);
                        }
                        
                        showToast('Data imported! Refreshing...', 'success');
                        setTimeout(() => location.reload(), 1500);
                    } catch (err) {
                        showToast('Invalid file format', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ============ STRIPE TERMINAL INTEGRATION ============
        let stripeTerminal = null;
        let connectedReader = null;
        let currentPaymentIntent = null;
        
        // Initialize Stripe Terminal
        async function initStripeTerminal() {
            const stripePK = localStorage.getItem('gc_stripe_pk');
            if (!stripePK) {
                console.log('Stripe not configured - using external terminal mode');
                return false;
            }
            
            try {
                stripeTerminal = StripeTerminal.create({
                    onFetchConnectionToken: async () => {
                        const response = await fetch('/api/createConnectionToken', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        const data = await response.json();
                        if (data.error) throw new Error(data.error);
                        return data.secret;
                    },
                    onUnexpectedReaderDisconnect: () => {
                        showToast('Card reader disconnected!', 'error');
                        connectedReader = null;
                        updateReaderStatus();
                    }
                });
                
                console.log('Stripe Terminal initialized');
                updateReaderStatus();
                return true;
            } catch (error) {
                console.error('Failed to initialize Stripe Terminal:', error);
                return false;
            }
        }
        
        // Discover available readers
        async function discoverReaders() {
            if (!stripeTerminal) {
                showToast('Stripe Terminal not initialized. Configure Stripe keys in Settings.', 'error');
                return [];
            }
            
            try {
                const config = { simulated: false };
                const discoverResult = await stripeTerminal.discoverReaders(config);
                
                if (discoverResult.error) {
                    showToast('Error discovering readers: ' + discoverResult.error.message, 'error');
                    return [];
                }
                
                return discoverResult.discoveredReaders;
            } catch (error) {
                showToast('Failed to discover readers', 'error');
                return [];
            }
        }
        
        // Connect to a reader
        async function connectToReader(reader) {
            if (!stripeTerminal) return false;
            
            try {
                const connectResult = await stripeTerminal.connectReader(reader);
                
                if (connectResult.error) {
                    showToast('Failed to connect: ' + connectResult.error.message, 'error');
                    return false;
                }
                
                connectedReader = connectResult.reader;
                localStorage.setItem('gc_connected_reader', JSON.stringify({
                    id: reader.id,
                    label: reader.label
                }));
                
                showToast('Connected to ' + (reader.label || 'Card Reader'), 'success');
                updateReaderStatus();
                return true;
            } catch (error) {
                showToast('Connection error: ' + error.message, 'error');
                return false;
            }
        }
        
        // Update reader status in UI
        function updateReaderStatus() {
            const statusEl = document.getElementById('readerStatus');
            if (statusEl) {
                if (connectedReader) {
                    statusEl.innerHTML = '<i class="fas fa-check-circle" style="color:#27ae60;"></i> ' + (connectedReader.label || 'Reader Connected');
                } else {
                    statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> No Reader Connected';
                }
            }
        }
        
        // Process card payment through Stripe Terminal
        async function processStripeTerminalPayment(amountCents, description) {
            if (!stripeTerminal || !connectedReader) {
                // Fall back to external terminal mode
                return { success: false, fallback: true };
            }
            
            try {
                // Create payment intent on server
                const response = await fetch('/api/createPaymentIntent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        amount: amountCents,
                        description: description,
                        metadata: {
                            register: localStorage.getItem('gc_register_id') || 'POS-1'
                        }
                    })
                });
                
                const { clientSecret, paymentIntentId, error } = await response.json();
                if (error) throw new Error(error);
                
                currentPaymentIntent = paymentIntentId;
                
                // Collect payment method from reader
                showToast('Present card on reader...', 'info');
                const collectResult = await stripeTerminal.collectPaymentMethod(clientSecret);
                
                if (collectResult.error) {
                    throw new Error(collectResult.error.message);
                }
                
                // Confirm the payment
                showToast('Processing payment...', 'info');
                const confirmResult = await stripeTerminal.processPayment(collectResult.paymentIntent);
                
                if (confirmResult.error) {
                    throw new Error(confirmResult.error.message);
                }
                
                if (confirmResult.paymentIntent.status === 'succeeded') {
                    return { 
                        success: true, 
                        paymentIntentId: confirmResult.paymentIntent.id,
                        amount: confirmResult.paymentIntent.amount
                    };
                } else {
                    throw new Error('Payment not completed: ' + confirmResult.paymentIntent.status);
                }
                
            } catch (error) {
                showToast('Payment failed: ' + error.message, 'error');
                currentPaymentIntent = null;
                return { success: false, error: error.message };
            }
        }
        
        // Cancel current payment
        async function cancelStripePayment() {
            if (stripeTerminal && currentPaymentIntent) {
                try {
                    await stripeTerminal.cancelCollectPaymentMethod();
                    await fetch('/api/cancelPayment', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ paymentIntentId: currentPaymentIntent })
                    });
                } catch (e) {
                    console.log('Cancel cleanup:', e);
                }
                currentPaymentIntent = null;
            }
        }
        
        // Show reader setup modal
        function showReaderSetup() {
            const isConfigured = !!localStorage.getItem('gc_stripe_pk');
            const savedReader = JSON.parse(localStorage.getItem('gc_connected_reader') || 'null');
            
            const html = `
                <div id="readerSetupModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:95%;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h2 style="margin:0;color:#4a90a4;"><i class="fab fa-stripe"></i> Card Reader Setup</h2>
                            <button onclick="closeReaderSetup()" style="background:none;border:none;font-size:24px;cursor:pointer;">&times;</button>
                        </div>
                        
                        ${!isConfigured ? `
                            <div style="background:#fff3e0;padding:15px;border-radius:8px;margin-bottom:20px;">
                                <i class="fas fa-exclamation-triangle" style="color:#f57c00;"></i>
                                <strong>Stripe Not Configured</strong>
                                <p style="margin:5px 0 0;font-size:13px;">Add your Stripe API keys in Settings first.</p>
                                <button onclick="closeReaderSetup(); showSettings();" style="margin-top:10px;padding:8px 15px;background:#4a90a4;color:#fff;border:none;border-radius:6px;cursor:pointer;">Open Settings</button>
                            </div>
                        ` : `
                            <div style="margin-bottom:20px;">
                                <div id="readerStatus" style="padding:15px;background:#f8f9fa;border-radius:8px;text-align:center;font-size:14px;">
                                    ${connectedReader ? 
                                        `<i class="fas fa-check-circle" style="color:#27ae60;"></i> Connected: ${connectedReader.label || 'Card Reader'}` : 
                                        `<i class="fas fa-times-circle" style="color:#e74c3c;"></i> No Reader Connected`}
                                </div>
                            </div>
                            
                            <div style="display:flex;flex-direction:column;gap:10px;">
                                <button onclick="scanForReaders()" style="padding:12px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                    <i class="fas fa-search"></i> Scan for Readers
                                </button>
                                
                                <div id="readerList" style="display:none;margin:10px 0;"></div>
                                
                                ${savedReader ? `
                                    <button onclick="reconnectSavedReader()" style="padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                        <i class="fas fa-plug"></i> Reconnect to ${savedReader.label || 'Saved Reader'}
                                    </button>
                                ` : ''}
                                
                                <button onclick="useSimulatedReader()" style="padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">
                                    <i class="fas fa-laptop"></i> Use Simulated Reader (Testing)
                                </button>
                            </div>
                            
                            <div style="margin-top:20px;padding:15px;background:#e3f2fd;border-radius:8px;font-size:12px;color:#1565c0;">
                                <strong>Need a card reader?</strong><br>
                                Purchase Stripe Terminal hardware at <a href="https://stripe.com/terminal" target="_blank" style="color:#1565c0;">stripe.com/terminal</a>
                            </div>
                        `}
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeReaderSetup() {
            const modal = document.getElementById('readerSetupModal');
            if (modal) modal.remove();
        }
        
        async function scanForReaders() {
            const listEl = document.getElementById('readerList');
            listEl.innerHTML = '<div style="text-align:center;padding:20px;"><i class="fas fa-spinner fa-spin"></i> Scanning...</div>';
            listEl.style.display = 'block';
            
            const readers = await discoverReaders();
            
            if (readers.length === 0) {
                listEl.innerHTML = '<div style="text-align:center;padding:20px;color:#666;">No readers found. Make sure your reader is powered on and connected to the same network.</div>';
            } else {
                listEl.innerHTML = readers.map(r => `
                    <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:#f8f9fa;border-radius:6px;margin-bottom:8px;">
                        <div>
                            <strong>${r.label || r.id}</strong>
                            <div style="font-size:11px;color:#666;">${r.device_type} ‚Ä¢ ${r.status}</div>
                        </div>
                        <button onclick="selectReader('${r.id}')" style="padding:8px 15px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">Connect</button>
                    </div>
                `).join('');
            }
        }
        
        async function selectReader(readerId) {
            const readers = await discoverReaders();
            const reader = readers.find(r => r.id === readerId);
            if (reader) {
                const success = await connectToReader(reader);
                if (success) closeReaderSetup();
            }
        }
        
        async function reconnectSavedReader() {
            const savedReader = JSON.parse(localStorage.getItem('gc_saved_reader') || 'null');
            if (!savedReader) {
                showToast('No saved reader found', 'error');
                return;
            }
            
            const statusEl = document.getElementById('readerStatus');
            if (statusEl) {
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Reconnecting...';
            }
            
            try {
                if (!stripeTerminal) {
                    await initStripeTerminal();
                }
                
                const discoverResult = await stripeTerminal.discoverReaders({ location: savedReader.location });
                const reader = discoverResult.discoveredReaders.find(r => r.id === savedReader.id);
                
                if (reader) {
                    const connectResult = await stripeTerminal.connectReader(reader);
                    if (!connectResult.error) {
                        connectedReader = connectResult.reader;
                        showToast('Reconnected to ' + (reader.label || 'Card Reader'), 'success');
                        updateReaderStatus();
                        closeReaderSetup();
                    } else {
                        showToast('Failed to reconnect: ' + connectResult.error.message, 'error');
                        if (statusEl) {
                            statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> Connection failed';
                        }
                    }
                } else {
                    showToast('Saved reader not found. Try scanning for readers.', 'error');
                    if (statusEl) {
                        statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> Reader not found';
                    }
                }
            } catch (error) {
                console.error('Reconnect error:', error);
                showToast('Failed to reconnect', 'error');
                if (statusEl) {
                    statusEl.innerHTML = '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> Error reconnecting';
                }
            }
        }
        
        async function useSimulatedReader() {
            if (!stripeTerminal) {
                await initStripeTerminal();
            }
            
            try {
                const discoverResult = await stripeTerminal.discoverReaders({ simulated: true });
                if (discoverResult.discoveredReaders.length > 0) {
                    const reader = discoverResult.discoveredReaders[0];
                    const connectResult = await stripeTerminal.connectReader(reader);
                    if (!connectResult.error) {
                        connectedReader = connectResult.reader;
                        showToast('Simulated reader connected (for testing)', 'success');
                        updateReaderStatus();
                        closeReaderSetup();
                    }
                }
            } catch (error) {
                showToast('Failed to connect simulated reader', 'error');
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize PIN lock screen
            if (employees.length > 0) {
                // Show the lock screen if there are employees
                document.getElementById('lockScreen').style.display = 'flex';
            } else {
                // No employees yet, skip the lock screen
                isLocked = false;
                document.getElementById('lockScreen').style.display = 'none';
            }
            
            // Try to initialize Stripe Terminal
            setTimeout(() => {
                initStripeTerminal();
            }, 1000);
            
            // Update sync status indicator
            updateSyncStatus();
            
            // Initialize status bar
            updateStatusBar();
            
            // Initialize TabsSync for real-time tab updates
            if (typeof TabsSync !== 'undefined') {
                TabsSync.init();
                TabsSync.onUpdate(() => {
                    openTabs = TabsSync.getAllTabs();
                    renderOpenTabs();
                    renderFloorPlan();
                    updateStatusBar();
                });
            }
            
            // Initialize tee sheet with today's date
            const teeSheetDate = document.getElementById('teeSheetDate');
            if (teeSheetDate) {
                teeSheetDate.value = new Date().toISOString().split('T')[0];
            }
            renderTeeSheet();
            
            // Preload quick customer suggestions
            loadQuickCustomerSuggestions();
        });
        
        // ============ QUICK CUSTOMER SUGGESTIONS ============
        function loadQuickCustomerSuggestions() {
            const vipList = document.getElementById('vipMembersList');
            const recentList = document.getElementById('recentCustomersList');
            
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            
            // VIP Members (active members sorted by tier priority)
            const tierPriority = { 'eagle': 1, 'family_eagle': 2, 'birdie': 3, 'family_birdie': 4, 'par': 5, 'family_par': 6 };
            const vipMembers = customers
                .filter(c => c.isMember && c.memberExpires && new Date(c.memberExpires) > new Date())
                .sort((a, b) => (tierPriority[a.memberType] || 99) - (tierPriority[b.memberType] || 99))
                .slice(0, 8);
            
            if (vipList) {
                const tierColors = { 'par': '#3498db', 'birdie': '#9b59b6', 'eagle': '#f1c40f', 'family_par': '#3498db', 'family_birdie': '#9b59b6', 'family_eagle': '#f1c40f' };
                vipList.innerHTML = vipMembers.length > 0 ? vipMembers.map(c => `
                    <button type="button" onclick="selectBookingCustomer(${c.id})" style="background:linear-gradient(135deg, ${tierColors[c.memberType] || '#9b59b6'} 0%, ${tierColors[c.memberType] || '#9b59b6'}dd 100%);color:#fff;border:none;padding:4px 10px;border-radius:12px;font-size:11px;cursor:pointer;display:flex;align-items:center;gap:4px;">
                        <i class="fas fa-crown" style="font-size:9px;color:#f1c40f;"></i>
                        ${c.firstName} ${(c.lastName || '').charAt(0)}.
                    </button>
                `).join('') : '<span style="color:#999;font-size:11px;">No VIP members</span>';
            }
            
            // Recent customers (sorted by last visit)
            const recentCustomers = customers
                .filter(c => c.lastVisit)
                .sort((a, b) => new Date(b.lastVisit) - new Date(a.lastVisit))
                .slice(0, 8);
            
            if (recentList) {
                recentList.innerHTML = recentCustomers.length > 0 ? recentCustomers.map(c => `
                    <button type="button" onclick="selectBookingCustomer(${c.id})" style="background:#f8f9fa;border:1px solid #ddd;padding:4px 10px;border-radius:12px;font-size:11px;cursor:pointer;">
                        ${c.firstName} ${(c.lastName || '').charAt(0)}.
                    </button>
                `).join('') : '<span style="color:#999;font-size:11px;">No recent customers</span>';
            }
        }
        
        // Select customer for booking modal by ID (primary method)
        function selectBookingCustomerById(customerId) {
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = customers.find(c => c.id === customerId);
            if (!customer) return;
            
            const fullName = getCustomerFullName(customer);
            document.getElementById('bookingCustomer').value = fullName;
            document.getElementById('bookingCustomerId').value = customerId;
            
            // Fill in phone/email if available
            if (customer.phone) document.getElementById('bookingPhone').value = customer.phone;
            if (customer.email) document.getElementById('bookingEmail').value = customer.email;
            
            // Show member badge if applicable
            const isActive = customer.isMember && customer.memberExpires && new Date(customer.memberExpires) > new Date();
            if (isActive) {
                selectedBookingMemberType = customer.memberType;
                selectedBookingCustomerTier = customer.memberType; // Sync both variables
                const badge = document.getElementById('bookingMemberBadge');
                const tierNames = { 'par': 'Par Member', 'birdie': 'Birdie Member', 'eagle': 'Eagle Member', 'family_par': 'Family Par', 'family_birdie': 'Family Birdie', 'family_eagle': 'Family Eagle' };
                const discounts = { 'par': '10%', 'birdie': '10%', 'eagle': '15%', 'family_par': '10%', 'family_birdie': '10%', 'family_eagle': '15%' };
                document.getElementById('bookingMemberText').textContent = tierNames[customer.memberType] || 'Member';
                document.getElementById('bookingMemberDiscount').textContent = discounts[customer.memberType] || '10%' + ' OFF';
                document.getElementById('bookingMemberBenefits').textContent = 'Priority booking ‚Ä¢ Member discount applied';
                badge.style.display = 'block';
                updateBookingPrice();
            } else {
                selectedBookingMemberType = null;
                selectedBookingCustomerTier = null; // Sync both variables
                document.getElementById('bookingMemberBadge').style.display = 'none';
            }
            
            // Hide autocomplete dropdown
            document.getElementById('bookingCustomerAutocomplete').style.display = 'none';
        }
    </script>
</body>
</html>