<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Cove - Sales</title>
    <link rel="icon" type="image/png" href="images/golfCoveLogo6.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="js/membership-system.js"></script>
    <script src="js/tabs-sync.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }
        
        /* Header - foreUP style */
        .header { background: #4a9eb4; color: #fff; padding: 8px 15px; display: flex; align-items: center; justify-content: space-between; height: 50px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px; text-decoration: none; color: #fff; }
        .header-logo img { height: 30px; }
        .header-nav { display: flex; gap: 3px; }
        .header-nav a { color: #fff; text-decoration: none; padding: 6px 12px; border-radius: 3px; font-size: 13px; transition: background 0.2s; }
        .header-nav a:hover, .header-nav a.active { background: rgba(255,255,255,0.2); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .header-user { display: flex; align-items: center; gap: 6px; font-size: 13px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 4px; cursor: pointer; }

        /* Main Sales Layout - 3 columns like foreUP */
        .sales-layout {
            display: grid;
            grid-template-columns: 180px 1fr 280px;
            height: calc(100vh - 50px);
            gap: 0;
        }

        /* Left: Categories - foreUP style with subcategories */
        .categories-panel {
            background: #3d8a9a;
            padding: 10px 8px;
            overflow-y: auto;
        }
        .category-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 14px 12px;
            margin-bottom: 4px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: #fff;
            font-size: 14px;
            font-weight: 500;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s;
        }
        .category-btn:hover { background: rgba(255,255,255,0.2); }
        .category-btn.active { background: #5bb5c5; }
        .category-btn i { margin-right: 10px; width: 16px; text-align: center; font-size: 15px; }

        /* Center: Sale Area */
        .sale-area {
            background: #fff;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
        }
        
        /* Sale Header - foreUP style */
        .sale-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #ddd;
            background: #eef2f5;
        }
        .sale-mode-toggle {
            display: flex;
            gap: 0;
        }
        .mode-btn {
            padding: 8px 20px;
            border: 1px solid #ccc;
            background: #fff;
            color: #333;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.15s;
        }
        .mode-btn:first-child { border-radius: 4px 0 0 4px; }
        .mode-btn:last-child { border-radius: 0 4px 4px 0; border-left: none; }
        .mode-btn.active { background: #4a9eb4; color: #fff; border-color: #4a9eb4; }
        .mode-btn.return-btn.active { background: #e74c3c; border-color: #e74c3c; color: #fff; }
        
        .sale-search {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 350px;
            margin: 0 15px;
        }
        .sale-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 13px;
            background: #fff;
        }
        .sale-search input:focus { outline: none; border-color: #4a9eb4; }

        /* Items Table */
        .items-table-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
        }
        .items-table thead {
            background: #f5f6f8;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .items-table th {
            padding: 8px 12px;
            text-align: left;
            font-size: 10px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            border-bottom: 1px solid #ddd;
        }
        .items-table td {
            padding: 8px 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }
        .items-table tr:hover { background: #f8fbfc; }
        
        .item-remove {
            background: #e74c3c;
            color: #fff;
            border: none;
            border-radius: 50%;
            width: 26px;
            height: 26px;
            cursor: pointer;
            font-size: 11px;
            transition: background 0.2s;
        }
        .item-remove:hover { background: #c0392b; }
        
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .qty-btn {
            width: 26px;
            height: 26px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .qty-btn:hover { background: #e9ecef; }
        .qty-value { 
            width: 24px; 
            text-align: center; 
            font-weight: 600;
            font-size: 13px;
        }
        
        .item-total { font-weight: 600; color: #2c3e50; }
        
        .empty-sale {
            text-align: center;
            padding: 40px 20px;
            color: #aaa;
        }
        .empty-sale i { font-size: 36px; margin-bottom: 10px; display: block; color: #ddd; }
        .empty-sale p { font-size: 13px; }

        /* Customer Section */
        .customer-section {
            padding: 8px 15px;
            border-top: 1px solid #eee;
            background: #f8f9fa;
        }
        .customer-section label {
            font-size: 10px;
            font-weight: 600;
            color: #888;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
        }
        .customer-row {
            display: flex;
            gap: 6px;
        }
        .customer-row input {
            flex: 1;
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .customer-row input:focus { outline: none; border-color: #4a9eb4; }
        .add-customer-btn {
            width: 32px;
            background: #4a9eb4;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .add-customer-btn:hover { background: #3d8a9a; }

        /* Totals Section */
        .totals-section {
            padding: 10px 15px;
            border-top: 1px solid #ddd;
            background: #fff;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            color: #555;
        }
        .total-row.grand {
            font-size: 16px;
            font-weight: 700;
            color: #2c3e50;
            border-top: 1px solid #ddd;
            margin-top: 6px;
            padding-top: 10px;
        }
        .discount-row { color: #27ae60; }

        /* Payment Buttons - foreUP style */
        .payment-section {
            padding: 12px 15px;
            background: #f5f7f9;
            border-top: 1px solid #ddd;
        }
        .payment-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .pay-btn {
            flex: 1;
            padding: 18px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .pay-btn i { font-size: 18px; }
        .pay-btn.pay-now { background: #27ae60; color: #fff; }
        .pay-btn.pay-now:hover { background: #219a52; }
        .pay-btn.credit { background: #3498db; color: #fff; }
        .pay-btn.credit:hover { background: #2980b9; }
        .pay-btn.cash { background: #f39c12; color: #fff; }
        .pay-btn.cash:hover { background: #d68910; }
        
        .action-btns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        .action-btn {
            padding: 14px 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-btn:hover { background: #f0f0f0; border-color: #bbb; }
        .action-btn i { font-size: 14px; }
        
        .register-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding-top: 8px;
            border-top: 1px solid #e5e5e5;
        }
        .register-links a {
            color: #666;
            text-decoration: none;
            font-size: 11px;
        }
        .register-links a:hover { color: #4a9eb4; }
        .register-links a i { margin-right: 3px; }

        /* Right: Transactions Panel - foreUP style */
        .transactions-panel {
            background: #f5f7f9;
            color: #333;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ddd;
        }
        .panel-header {
            background: #2c3e50;
            color: #fff;
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .panel-header .register-name { font-weight: 600; font-size: 14px; }
        .panel-header .user-name { font-size: 12px; opacity: 0.8; }
        .panel-section {
            padding: 12px;
            border-bottom: 1px solid #ddd;
        }
        .panel-section h4 {
            font-size: 11px;
            text-transform: uppercase;
            margin-bottom: 10px;
            color: #666;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .trans-item {
            background: #fff;
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: background 0.15s;
            border: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trans-item:hover { background: #f8f9fa; border-color: #ccc; }
        .trans-item .trans-left { flex: 1; }
        .trans-item .trans-time { font-size: 12px; color: #666; }
        .trans-item .trans-customer { font-size: 11px; color: #888; }
        .trans-item .trans-right { text-align: right; }
        .trans-item .trans-amount { font-weight: 600; font-size: 13px; color: #333; }
        .trans-item .trans-id { font-size: 10px; color: #999; }
        .trans-item.return .trans-amount { color: #e74c3c; }
        
        .empty-list { text-align: center; padding: 20px; color: #999; font-size: 12px; }
        
        /* Open Tabs */
        .tab-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: linear-gradient(135deg, #27ae60, #219a52);
            color: #fff;
            border-radius: 6px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tab-item:hover { transform: translateX(-3px); box-shadow: 0 2px 8px rgba(39,174,96,0.3); }
        .tab-customer { font-weight: 600; font-size: 13px; }
        .tab-info { font-size: 11px; opacity: 0.9; margin-top: 2px; }
        .tab-total { font-weight: 700; font-size: 14px; }
        
        .suspended-item {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: #fff;
            padding: 10px 12px;
            border-radius: 4px;
            margin-bottom: 6px;
            cursor: pointer;
            transition: transform 0.15s;
        }
        .suspended-item:hover { transform: translateX(-3px); }
        .suspended-item .susp-header { display: flex; justify-content: space-between; align-items: center; }
        .suspended-item .susp-name { font-weight: 600; font-size: 12px; }
        .suspended-item .susp-amount { font-weight: 600; font-size: 13px; }
        .suspended-item .susp-customer { font-size: 11px; opacity: 0.9; margin-top: 3px; }

        /* Staff Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3d8a9a 0%, #2c3e50 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: #fff;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-box img { height: 60px; margin-bottom: 20px; }
        .login-box h2 { margin: 0 0 30px; color: #2c3e50; font-size: 22px; }
        .pin-display {
            background: #f5f6f8;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 32px;
            letter-spacing: 12px;
            margin-bottom: 20px;
            font-family: monospace;
            min-height: 60px;
        }
        .pin-display.error { border-color: #e74c3c; animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 280px;
            margin: 0 auto;
        }
        .pin-btn {
            padding: 20px;
            font-size: 24px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: #f0f2f5;
            cursor: pointer;
            transition: all 0.15s;
        }
        .pin-btn:hover { background: #e0e3e8; }
        .pin-btn:active { transform: scale(0.95); }
        .pin-btn.clear { background: #e74c3c; color: #fff; font-size: 16px; }
        .pin-btn.clear:hover { background: #c0392b; }
        .pin-btn.enter { background: #27ae60; color: #fff; font-size: 16px; }
        .pin-btn.enter:hover { background: #219a52; }
        .staff-quick-select {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .staff-quick-select p { font-size: 12px; color: #888; margin-bottom: 10px; }
        .staff-avatars {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .staff-avatar {
            width: 60px;
            text-align: center;
            cursor: pointer;
        }
        .staff-avatar .avatar-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #4a9eb4;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            margin: 0 auto 5px;
            transition: transform 0.15s;
        }
        .staff-avatar:hover .avatar-circle { transform: scale(1.1); }
        .staff-avatar .avatar-name { font-size: 11px; color: #666; }

        /* Items Popup Modal */
        .items-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .items-modal.active { opacity: 1; visibility: visible; }
        .items-modal-content {
            background: #fff;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.2s;
        }
        .items-modal.active .items-modal-content { transform: scale(1); }
        .items-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #4a90a4;
            color: #fff;
        }
        .items-modal-header h3 { margin: 0; font-size: 18px; }
        .items-modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }
        .items-modal-close:hover { opacity: 1; }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 20px;
            max-height: calc(80vh - 70px);
            overflow-y: auto;
        }
        .item-card {
            background: #f8f9fa;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        .item-card:hover { border-color: #4a90a4; background: #fff; transform: translateY(-2px); }
        .item-card i { font-size: 28px; color: #4a90a4; margin-bottom: 10px; display: block; }
        .item-card .item-name { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 5px; }
        .item-card .item-price { font-size: 15px; color: #27ae60; font-weight: 700; }
        
        /* Category-specific colors */
        .item-card.rental i { color: #9b59b6; }
        .item-card.food i { color: #e67e22; }
        .item-card.beer i { color: #f39c12; }
        .item-card.wine i { color: #8e44ad; }
        .item-card.cocktails i { color: #e74c3c; }
        .item-card.beverage i { color: #3498db; }
        .item-card.merch i { color: #1abc9c; }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #2c3e50;
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        
        /* Customer Autocomplete */
        .customer-section { position: relative; }
        .customer-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 60px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .customer-autocomplete.show { display: block; }
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #eee;
        }
        .autocomplete-item:hover { background: #f5f6fa; }
        .autocomplete-item .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a90a4;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }
        .autocomplete-item .avatar.member { background: linear-gradient(135deg, #f1c40f, #e67e22); }
        .autocomplete-item .info { flex: 1; }
        .autocomplete-item .name { font-weight: 600; font-size: 14px; }
        .autocomplete-item .meta { font-size: 12px; color: #999; }
        .member-tag { background: linear-gradient(135deg, #f1c40f, #e67e22); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 700; margin-left: 6px; }
        
        /* Return mode styling */
        .return-mode .sale-header { background: #fdf2f2; }
        .return-mode .items-table thead { background: #fdf2f2; }
    </style>
</head>
<body>
    <!-- Staff Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <img src="images/golfCoveLogo6.png" alt="Golf Cove">
            <h2>Staff Login</h2>
            <div class="pin-display" id="pinDisplay">●●●●</div>
            <div class="pin-pad">
                <button class="pin-btn" onclick="enterPin('1')">1</button>
                <button class="pin-btn" onclick="enterPin('2')">2</button>
                <button class="pin-btn" onclick="enterPin('3')">3</button>
                <button class="pin-btn" onclick="enterPin('4')">4</button>
                <button class="pin-btn" onclick="enterPin('5')">5</button>
                <button class="pin-btn" onclick="enterPin('6')">6</button>
                <button class="pin-btn" onclick="enterPin('7')">7</button>
                <button class="pin-btn" onclick="enterPin('8')">8</button>
                <button class="pin-btn" onclick="enterPin('9')">9</button>
                <button class="pin-btn clear" onclick="clearPin()">Clear</button>
                <button class="pin-btn" onclick="enterPin('0')">0</button>
                <button class="pin-btn enter" onclick="submitPin()">Enter</button>
            </div>
            <div class="staff-quick-select">
                <p>Quick Clock In</p>
                <div class="staff-avatars" id="staffAvatars"></div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="header-logo">
                <img src="images/golfCoveLogo6.png" alt="Golf Cove">
                <span>Golf Cove</span>
            </a>
            <nav class="header-nav">
                <a href="admin-pos.html"><i class="fas fa-calendar-alt"></i> Tee Sheet</a>
                <a href="admin-pos.html#fnb"><i class="fas fa-utensils"></i> Food & Beverage</a>
                <a href="sales.html" class="active"><i class="fas fa-cash-register"></i> Sales</a>
                <a href="customers.html"><i class="fas fa-users"></i> Customers</a>
            </nav>
        </div>
        <div class="header-right">
            <div class="header-user" onclick="showUserMenu()">
                <i class="fas fa-user-circle"></i>
                <span id="currentUserName">Staff</span> ▾
            </div>
        </div>
    </header>

    <!-- Main Sales Layout -->
    <div class="sales-layout">
        <!-- Left: Categories -->
        <div class="categories-panel">
            <button class="category-btn active" data-category="all" onclick="selectCategory('all', this)">
                <i class="fas fa-th"></i> All Items
            </button>
            <button class="category-btn" data-category="rental" onclick="selectCategory('rental', this)">
                <i class="fas fa-golf-ball"></i> Rentals
            </button>
            <button class="category-btn" data-category="food" onclick="selectCategory('food', this)">
                <i class="fas fa-utensils"></i> Food
            </button>
            <button class="category-btn" data-category="beer" onclick="selectCategory('beer', this)">
                <i class="fas fa-beer"></i> Beer
            </button>
            <button class="category-btn" data-category="wine" onclick="selectCategory('wine', this)">
                <i class="fas fa-wine-glass-alt"></i> Wine
            </button>
            <button class="category-btn" data-category="cocktails" onclick="selectCategory('cocktails', this)">
                <i class="fas fa-cocktail"></i> Cocktails
            </button>
            <button class="category-btn" data-category="beverage" onclick="selectCategory('beverage', this)">
                <i class="fas fa-coffee"></i> Beverages
            </button>
            <button class="category-btn" data-category="merch" onclick="selectCategory('merch', this)">
                <i class="fas fa-tshirt"></i> Merch
            </button>
            <button class="category-btn" data-category="giftcard" onclick="selectCategory('giftcard', this)">
                <i class="fas fa-gift"></i> Gift Cards
            </button>
        </div>

        <!-- Center: Sale Area -->
        <div class="sale-area" id="saleArea">
            <div class="sale-header">
                <div class="sale-mode-toggle">
                    <button class="mode-btn active" onclick="setMode('sale', this)">Sale</button>
                    <button class="mode-btn return-btn" onclick="setMode('return', this)">Return</button>
                </div>
                <div class="sale-search">
                    <input type="text" id="itemSearch" placeholder="Search items or scan barcode..." onkeyup="searchItems(this.value)">
                </div>
            </div>
            
            <div class="items-table-container">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th style="width:40px;"></th>
                            <th>Item</th>
                            <th style="width:70px;">Price</th>
                            <th style="width:80px;">Qty</th>
                            <th style="width:80px;">Total</th>
                        </tr>
                    </thead>
                    <tbody id="saleItemsBody">
                        <tr class="empty-row">
                            <td colspan="5">
                                <div class="empty-sale">
                                    <i class="fas fa-shopping-cart"></i>
                                    <p>Select a category or search to add items</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="customer-section">
                <label>Customer</label>
                <div class="customer-row">
                    <input type="text" id="customerName" placeholder="Search for customer..." autocomplete="off">
                    <button class="add-customer-btn" onclick="addNewCustomer()"><i class="fas fa-plus"></i></button>
                </div>
                <div class="customer-autocomplete" id="customerAutocomplete"></div>
            </div>
            
            <div class="totals-section">
                <div class="total-row"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
                <div class="total-row discount-row" id="discountRow" style="display:none;"><span>Discount</span><span id="discountAmt">-$0.00</span></div>
                <div class="total-row"><span>Tax (6.35%)</span><span id="taxAmt">$0.00</span></div>
                <div class="total-row grand"><span>Total Due</span><span id="totalDue">$0.00</span></div>
            </div>
            
            <div class="payment-section">
                <div class="payment-btns">
                    <button class="pay-btn pay-now" onclick="processPayment('quick')">
                        <i class="fas fa-bolt"></i> Pay Now
                    </button>
                    <button class="pay-btn credit" onclick="processPayment('card')">
                        <i class="fas fa-credit-card"></i> Card
                    </button>
                    <button class="pay-btn cash" onclick="processPayment('cash')">
                        <i class="fas fa-money-bill"></i> Cash
                    </button>
                </div>
                <div class="action-btns">
                    <button class="action-btn" onclick="suspendSale()"><i class="fas fa-pause"></i> Suspend</button>
                    <button class="action-btn" onclick="startTab()"><i class="fas fa-folder-plus"></i> Tab</button>
                    <button class="action-btn" onclick="applyDiscount()"><i class="fas fa-percent"></i> Disc</button>
                    <button class="action-btn" onclick="clearSale()"><i class="fas fa-trash"></i> Clear</button>
                    <button class="action-btn" onclick="redeemGiftCard()"><i class="fas fa-gift"></i> Gift</button>
                    <button class="action-btn" onclick="showSplitPaymentModal()"><i class="fas fa-divide"></i> Split</button>
                </div>
                <div class="register-links">
                    <a href="#" onclick="showDrawerManagement(); return false;"><i class="fas fa-cash-register"></i> Drawer</a>
                    <a href="#" onclick="showInventory(); return false;"><i class="fas fa-boxes"></i> Inventory</a>
                    <a href="#" onclick="showSettings(); return false;"><i class="fas fa-cog"></i> Settings</a>
                </div>
            </div>
        </div>

        <!-- Right: Transactions Panel -->
        <div class="transactions-panel">
            <div class="panel-header">
                <span class="register-name">Bar</span>
                <span class="user-name" id="panelUserName"><i class="fas fa-user-circle"></i> Staff ▾</span>
            </div>
            <div class="panel-section" style="max-height:200px;overflow-y:auto;">
                <h4><i class="fas fa-folder-open"></i> Open Tabs <span id="tabCount" style="background:#27ae60;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:5px;">0</span></h4>
                <div id="openTabsList"></div>
            </div>
            <div class="panel-section" style="flex:1; overflow-y:auto;">
                <h4><i class="fas fa-history"></i> Recent Transactions</h4>
                <div id="recentTrans"></div>
            </div>
            <div class="panel-section">
                <h4><i class="fas fa-pause-circle"></i> Suspended Sales</h4>
                <div id="suspendedSales"></div>
            </div>
        </div>
    </div>

    <!-- Items Modal -->
    <div class="items-modal" id="itemsModal">
        <div class="items-modal-content">
            <div class="items-modal-header">
                <h3 id="modalTitle">Items</h3>
                <button class="items-modal-close" onclick="closeItemsModal()">&times;</button>
            </div>
            <div class="items-grid" id="itemsGrid"></div>
        </div>
    </div>

    <script>
        // ============ STAFF MANAGEMENT ============
        const defaultStaff = [
            { id: 1, name: 'EJ Sattelberger', pin: '9999', role: 'manager', color: '#3498db' },
            { id: 2, name: 'Manager', pin: '9999', role: 'manager', color: '#e67e22' },
            { id: 3, name: 'Bartender', pin: '9999', role: 'bartender', color: '#9b59b6' },
            { id: 4, name: 'Staff', pin: '9999', role: 'server', color: '#27ae60' }
        ];
        
        // Permissions by role
        const rolePermissions = {
            manager: { 
                canVoid: true, 
                canDiscount: true, 
                canRefund: true, 
                canOpenDrawer: true,
                canViewReports: true,
                canManageStaff: true,
                canCloseRegister: true,
                maxDiscount: 100
            },
            bartender: { 
                canVoid: true, 
                canDiscount: true, 
                canRefund: false, 
                canOpenDrawer: true,
                canViewReports: false,
                canManageStaff: false,
                canCloseRegister: false,
                maxDiscount: 20
            },
            server: { 
                canVoid: false, 
                canDiscount: false, 
                canRefund: false, 
                canOpenDrawer: false,
                canViewReports: false,
                canManageStaff: false,
                canCloseRegister: false,
                maxDiscount: 0
            }
        };
        
        let staff = JSON.parse(localStorage.getItem('gc_employees') || 'null') || defaultStaff;
        // Ensure staff has required properties
        staff = staff.map((s, i) => ({
            id: s.id || i + 1,
            name: s.name || s.firstName + ' ' + (s.lastName || ''),
            pin: s.pin || '9999',
            role: s.role || 'staff',
            color: s.color || ['#3498db', '#e67e22', '#9b59b6', '#27ae60'][i % 4]
        }));
        let currentUser = JSON.parse(sessionStorage.getItem('gc_currentUser') || 'null');
        let enteredPin = '';
        let selectedStaffId = null;
        
        // Check if logged in
        function checkLogin() {
            if (!currentUser) {
                document.getElementById('loginScreen').classList.remove('hidden');
                renderStaffAvatars();
            } else {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('currentUserName').textContent = currentUser.name.split(' ')[0];
                updateRegisterPanel();
            }
        }
        
        // Render staff avatars for quick login
        function renderStaffAvatars() {
            const container = document.getElementById('staffAvatars');
            container.innerHTML = staff.map(s => {
                const initials = s.name.split(' ').map(n => n[0]).join('');
                return '<div class="staff-avatar" onclick="selectStaff(' + s.id + ')">' +
                    '<div class="avatar-circle" style="background:' + s.color + '">' + initials + '</div>' +
                    '<div class="avatar-name">' + s.name.split(' ')[0] + '</div>' +
                '</div>';
            }).join('');
        }
        
        // Select staff for login
        function selectStaff(id) {
            selectedStaffId = id;
            const staffMember = staff.find(s => s.id === id);
            document.querySelectorAll('.staff-avatar').forEach(a => a.style.opacity = '0.5');
            event.currentTarget.style.opacity = '1';
            document.getElementById('pinDisplay').textContent = '____';
            enteredPin = '';
        }
        
        // Enter PIN digit
        function enterPin(digit) {
            if (enteredPin.length < 4) {
                enteredPin += digit;
                updatePinDisplay();
            }
        }
        
        // Clear PIN
        function clearPin() {
            enteredPin = '';
            updatePinDisplay();
        }
        
        // Update PIN display
        function updatePinDisplay() {
            const display = document.getElementById('pinDisplay');
            display.textContent = enteredPin.padEnd(4, '_').split('').join(' ');
            display.classList.remove('error');
        }
        
        // Submit PIN
        function submitPin() {
            if (enteredPin.length !== 4) return;
            
            // Find staff by PIN (or selected staff)
            let staffMember;
            if (selectedStaffId) {
                staffMember = staff.find(s => s.id === selectedStaffId && s.pin === enteredPin);
            } else {
                staffMember = staff.find(s => s.pin === enteredPin);
            }
            
            if (staffMember) {
                currentUser = { ...staffMember, loginTime: new Date().toISOString() };
                sessionStorage.setItem('gc_currentUser', JSON.stringify(currentUser));
                
                // Log clock in
                logTimeEntry('clockIn');
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('currentUserName').textContent = currentUser.name.split(' ')[0];
                updateRegisterPanel();
                showToast('Welcome, ' + currentUser.name.split(' ')[0] + '!', 'success');
            } else {
                document.getElementById('pinDisplay').classList.add('error');
                enteredPin = '';
                setTimeout(() => updatePinDisplay(), 300);
            }
        }
        
        // Update register panel with current user
        function updateRegisterPanel() {
            const userNameEl = document.querySelector('.panel-header .user-name');
            if (userNameEl && currentUser) {
                userNameEl.innerHTML = '<i class="fas fa-user-circle"></i> ' + currentUser.name + ' ▾';
            }
        }
        
        // Show user menu
        function showUserMenu() {
            if (!currentUser) return;
            
            const perms = rolePermissions[currentUser.role] || {};
            let menuHtml = '<div style="padding:15px;">';
            menuHtml += '<div style="text-align:center;margin-bottom:15px;">';
            menuHtml += '<div style="width:60px;height:60px;border-radius:50%;background:' + currentUser.color + ';color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:600;margin:0 auto 10px;">' + currentUser.name.split(' ').map(n => n[0]).join('') + '</div>';
            menuHtml += '<div style="font-weight:600;">' + currentUser.name + '</div>';
            menuHtml += '<div style="font-size:12px;color:#888;text-transform:capitalize;">' + currentUser.role + '</div>';
            menuHtml += '</div>';
            
            menuHtml += '<div style="border-top:1px solid #eee;padding-top:15px;">';
            menuHtml += '<button onclick="clockOut()" style="width:100%;padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-bottom:10px;"><i class="fas fa-sign-out-alt"></i> Clock Out</button>';
            menuHtml += '<button onclick="switchUser()" style="width:100%;padding:12px;background:#3498db;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;"><i class="fas fa-exchange-alt"></i> Switch User</button>';
            
            if (perms.canManageStaff) {
                menuHtml += '<button onclick="showStaffManager()" style="width:100%;padding:12px;background:#9b59b6;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-top:10px;"><i class="fas fa-users-cog"></i> Manage Staff</button>';
            }
            menuHtml += '</div></div>';
            
            showModal('User Menu', menuHtml);
        }
        
        // Clock out
        function clockOut() {
            if (!currentUser) return;
            
            logTimeEntry('clockOut');
            showToast('Clocked out: ' + currentUser.name, 'success');
            
            currentUser = null;
            sessionStorage.removeItem('gc_currentUser');
            closeModal();
            checkLogin();
        }
        
        // Switch user (quick switch without full logout)
        function switchUser() {
            currentUser = null;
            sessionStorage.removeItem('gc_currentUser');
            closeModal();
            checkLogin();
        }
        
        // Log time entry
        function logTimeEntry(type) {
            const timeLog = JSON.parse(localStorage.getItem('gc_timeclock') || '[]');
            timeLog.push({
                staffId: currentUser.id,
                staffName: currentUser.name,
                type: type,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('gc_timeclock', JSON.stringify(timeLog));
        }
        
        // Check permission
        function hasPermission(permission) {
            if (!currentUser) return false;
            const perms = rolePermissions[currentUser.role] || {};
            return perms[permission] || false;
        }
        
        // Get current user's name
        function getCurrentUserName() {
            return currentUser ? currentUser.name : 'Staff';
        }
        
        // Show staff manager (managers only)
        function showStaffManager() {
            if (!hasPermission('canManageStaff')) {
                showToast('Permission denied', 'error');
                return;
            }
            
            let html = '<div style="padding:15px;">';
            html += '<table style="width:100%;border-collapse:collapse;">';
            html += '<tr style="background:#f5f6f8;"><th style="padding:10px;text-align:left;">Name</th><th style="padding:10px;">Role</th><th style="padding:10px;">PIN</th><th style="padding:10px;">Actions</th></tr>';
            
            staff.forEach(s => {
                html += '<tr style="border-bottom:1px solid #eee;">';
                html += '<td style="padding:10px;">' + s.name + '</td>';
                html += '<td style="padding:10px;text-align:center;text-transform:capitalize;">' + s.role + '</td>';
                html += '<td style="padding:10px;text-align:center;font-family:monospace;">' + s.pin + '</td>';
                html += '<td style="padding:10px;text-align:center;">';
                html += '<button onclick="editStaff(' + s.id + ')" style="padding:5px 10px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;"><i class="fas fa-edit"></i></button>';
                html += '<button onclick="resetPin(' + s.id + ')" style="padding:5px 10px;background:#f39c12;color:#fff;border:none;border-radius:4px;cursor:pointer;"><i class="fas fa-key"></i></button>';
                html += '</td></tr>';
            });
            
            html += '</table>';
            html += '<button onclick="addStaffMember()" style="width:100%;padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-top:15px;"><i class="fas fa-plus"></i> Add Staff Member</button>';
            html += '</div>';
            
            closeModal();
            showModal('Staff Management', html, '600px');
        }
        
        // Add new staff member
        function addStaffMember() {
            const name = prompt('Enter staff name:');
            if (!name) return;
            
            const role = prompt('Enter role (manager, bartender, server):') || 'server';
            const pin = prompt('Enter 4-digit PIN:');
            
            if (pin && pin.length === 4 && /^\d+$/.test(pin)) {
                const colors = ['#3498db', '#e67e22', '#9b59b6', '#27ae60', '#e74c3c', '#1abc9c'];
                staff.push({
                    id: Date.now(),
                    name: name,
                    pin: pin,
                    role: role.toLowerCase(),
                    color: colors[staff.length % colors.length]
                });
                localStorage.setItem('gc_staff', JSON.stringify(staff));
                showStaffManager();
                showToast('Staff member added', 'success');
            } else {
                showToast('Invalid PIN - must be 4 digits', 'error');
            }
        }
        
        // Reset PIN
        function resetPin(id) {
            const newPin = prompt('Enter new 4-digit PIN:');
            if (newPin && newPin.length === 4 && /^\d+$/.test(newPin)) {
                const member = staff.find(s => s.id === id);
                if (member) {
                    member.pin = newPin;
                    localStorage.setItem('gc_staff', JSON.stringify(staff));
                    showStaffManager();
                    showToast('PIN updated', 'success');
                }
            } else {
                showToast('Invalid PIN - must be 4 digits', 'error');
            }
        }
        
        // ============ DATA ============
        // Load inventory from localStorage or use defaults
        const defaultItems = [
            // Rentals (services - no inventory tracking)
            { id: 1, name: 'Room 1 Hour', price: 45, category: 'rental', icon: 'fa-door-open', trackInventory: false },
            { id: 2, name: 'Room 2 Hours', price: 80, category: 'rental', icon: 'fa-door-open', trackInventory: false },
            { id: 3, name: 'Room 3 Hours', price: 110, category: 'rental', icon: 'fa-door-open', trackInventory: false },
            { id: 4, name: 'Club Rental', price: 15, category: 'rental', icon: 'fa-golf-ball', trackInventory: false },
            // Food
            { id: 10, name: 'Hot Dog', price: 4.50, category: 'food', icon: 'fa-hotdog', trackInventory: true, stock: 50 },
            { id: 11, name: 'Burger', price: 9.00, category: 'food', icon: 'fa-hamburger', trackInventory: true, stock: 30 },
            { id: 12, name: 'Chicken Tenders', price: 10.00, category: 'food', icon: 'fa-drumstick-bite', trackInventory: true, stock: 40 },
            { id: 13, name: 'Nachos', price: 8.00, category: 'food', icon: 'fa-cheese', trackInventory: true, stock: 25 },
            { id: 14, name: 'Pizza Slice', price: 4.00, category: 'food', icon: 'fa-pizza-slice', trackInventory: true, stock: 40 },
            { id: 15, name: 'Fries', price: 4.00, category: 'food', icon: 'fa-bacon', trackInventory: true, stock: 60 },
            { id: 16, name: 'Mozzarella Sticks', price: 7.00, category: 'food', icon: 'fa-cheese', trackInventory: true, stock: 30 },
            { id: 17, name: 'Wings (6pc)', price: 10.00, category: 'food', icon: 'fa-drumstick-bite', trackInventory: true, stock: 35 },
            // Beer
            { id: 20, name: 'Bud Light', price: 5.00, category: 'beer', icon: 'fa-beer', trackInventory: true, stock: 48 },
            { id: 21, name: 'Coors Light', price: 5.00, category: 'beer', icon: 'fa-beer', trackInventory: true, stock: 48 },
            { id: 22, name: 'Miller Lite', price: 5.00, category: 'beer', icon: 'fa-beer', trackInventory: true, stock: 48 },
            { id: 23, name: 'Corona', price: 6.00, category: 'beer', icon: 'fa-beer', trackInventory: true, stock: 24 },
            { id: 24, name: 'Heineken', price: 6.00, category: 'beer', icon: 'fa-beer', trackInventory: true, stock: 24 },
            { id: 25, name: 'Sam Adams', price: 6.50, category: 'beer', icon: 'fa-beer', trackInventory: true, stock: 24 },
            { id: 26, name: 'Blue Moon', price: 6.50, category: 'beer', icon: 'fa-beer', trackInventory: true, stock: 24 },
            { id: 27, name: 'IPA Draft', price: 7.00, category: 'beer', icon: 'fa-beer', trackInventory: false },
            // Wine
            { id: 30, name: 'House Red', price: 8.00, category: 'wine', icon: 'fa-wine-glass-alt', trackInventory: false },
            { id: 31, name: 'House White', price: 8.00, category: 'wine', icon: 'fa-wine-glass-alt', trackInventory: false },
            { id: 32, name: 'Pinot Grigio', price: 9.00, category: 'wine', icon: 'fa-wine-glass-alt', trackInventory: true, stock: 6 },
            { id: 33, name: 'Chardonnay', price: 9.00, category: 'wine', icon: 'fa-wine-glass-alt', trackInventory: true, stock: 6 },
            { id: 34, name: 'Cabernet', price: 10.00, category: 'wine', icon: 'fa-wine-glass-alt', trackInventory: true, stock: 6 },
            { id: 35, name: 'Merlot', price: 9.00, category: 'wine', icon: 'fa-wine-glass-alt', trackInventory: true, stock: 6 },
            // Cocktails (made to order - no inventory)
            { id: 40, name: 'Margarita', price: 10.00, category: 'cocktails', icon: 'fa-cocktail', trackInventory: false },
            { id: 41, name: 'Vodka Soda', price: 8.00, category: 'cocktails', icon: 'fa-glass-martini-alt', trackInventory: false },
            { id: 42, name: 'Rum & Coke', price: 8.00, category: 'cocktails', icon: 'fa-glass-whiskey', trackInventory: false },
            { id: 43, name: 'Whiskey Sour', price: 10.00, category: 'cocktails', icon: 'fa-glass-whiskey', trackInventory: false },
            { id: 44, name: 'Old Fashioned', price: 12.00, category: 'cocktails', icon: 'fa-glass-whiskey', trackInventory: false },
            { id: 45, name: 'Mojito', price: 10.00, category: 'cocktails', icon: 'fa-cocktail', trackInventory: false },
            { id: 46, name: 'Long Island', price: 12.00, category: 'cocktails', icon: 'fa-cocktail', trackInventory: false },
            // Beverages
            { id: 50, name: 'Soda', price: 2.50, category: 'beverage', icon: 'fa-glass-water', trackInventory: true, stock: 100 },
            { id: 51, name: 'Coffee', price: 3.00, category: 'beverage', icon: 'fa-mug-hot', trackInventory: false },
            { id: 52, name: 'Iced Tea', price: 3.00, category: 'beverage', icon: 'fa-glass-water', trackInventory: false },
            { id: 53, name: 'Lemonade', price: 3.50, category: 'beverage', icon: 'fa-lemon', trackInventory: false },
            { id: 54, name: 'Energy Drink', price: 4.50, category: 'beverage', icon: 'fa-bolt', trackInventory: true, stock: 24 },
            { id: 55, name: 'Water', price: 2.00, category: 'beverage', icon: 'fa-tint', trackInventory: true, stock: 48 },
            // Merchandise
            { id: 60, name: 'Golf Cove Hat', price: 25.00, category: 'merch', icon: 'fa-hat-cowboy', trackInventory: true, stock: 20 },
            { id: 61, name: 'Golf Cove Polo', price: 45.00, category: 'merch', icon: 'fa-tshirt', trackInventory: true, stock: 15 },
            { id: 62, name: 'Golf Balls (sleeve)', price: 12.00, category: 'merch', icon: 'fa-golf-ball', trackInventory: true, stock: 30 },
            { id: 63, name: 'Golf Glove', price: 18.00, category: 'merch', icon: 'fa-hand-paper', trackInventory: true, stock: 12 },
            { id: 64, name: 'Golf Towel', price: 15.00, category: 'merch', icon: 'fa-scroll', trackInventory: true, stock: 25 },
            // Gift Cards
            { id: 70, name: 'Gift Card $25', price: 25.00, category: 'giftcard', icon: 'fa-gift', trackInventory: false },
            { id: 71, name: 'Gift Card $50', price: 50.00, category: 'giftcard', icon: 'fa-gift', trackInventory: false },
            { id: 72, name: 'Gift Card $100', price: 100.00, category: 'giftcard', icon: 'fa-gift', trackInventory: false },
            { id: 73, name: 'Gift Card Custom', price: 0, category: 'giftcard', icon: 'fa-gift', trackInventory: false, customPrice: true }
        ];
        
        // Load items with saved inventory levels
        let items = JSON.parse(localStorage.getItem('gc_inventory') || 'null') || defaultItems;
        
        // Save inventory function
        function saveInventory() {
            localStorage.setItem('gc_inventory', JSON.stringify(items));
        }
        
        // Deduct inventory on sale
        function deductInventory(saleItemList) {
            saleItemList.forEach(saleItem => {
                const item = items.find(i => i.name === saleItem.name);
                if (item && item.trackInventory && item.stock !== undefined) {
                    item.stock = Math.max(0, item.stock - saleItem.qty);
                }
            });
            saveInventory();
            checkLowStock();
        }
        
        // Add inventory (for returns or receiving)
        function addInventory(itemId, qty) {
            const item = items.find(i => i.id === itemId);
            if (item && item.trackInventory) {
                item.stock = (item.stock || 0) + qty;
                saveInventory();
            }
        }
        
        // Check for low stock items
        function checkLowStock() {
            const lowStock = items.filter(i => i.trackInventory && i.stock !== undefined && i.stock <= 5);
            if (lowStock.length > 0) {
                console.log('Low stock items:', lowStock.map(i => `${i.name}: ${i.stock}`));
            }
        }
        
        // State
        let saleItems = [];
        let isReturnMode = false;
        let transactions = JSON.parse(localStorage.getItem('gc_transactions') || '[]');
        let suspendedSales = JSON.parse(localStorage.getItem('gc_suspended') || '[]');
        
        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', () => {
            // Migrate old insecure PINs (1234, 0000, etc.) to 9999
            migrateOldPins();
            
            checkLogin();
            renderTransactions();
            renderSuspended();
            renderOpenTabs();
            updateTabCount();
            
            // Listen for tab changes from other pages
            TabsSync.addListener((event, data, allTabs) => {
                renderOpenTabs();
                updateTabCount();
            });
        });
        
        // Migrate old/insecure PINs to new secure default
        function migrateOldPins() {
            const insecurePins = ['1234', '0000', '1111', '2222', '3333', '4444', '5555', '6666', '7777', '8888'];
            const employees = JSON.parse(localStorage.getItem('gc_employees') || '[]');
            let updated = false;
            
            employees.forEach(emp => {
                if (insecurePins.includes(emp.pin)) {
                    emp.pin = '9999';
                    updated = true;
                }
            });
            
            if (updated) {
                localStorage.setItem('gc_employees', JSON.stringify(employees));
                console.log('Migrated insecure PINs to 9999');
            }
        }
        
        function updateTabCount() {
            const count = TabsSync.getAllTabs().length;
            const el = document.getElementById('tabCount');
            if (el) el.textContent = count;
        }
        
        // ============ CATEGORY & ITEMS ============
        function selectCategory(category, btn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (category === 'all') {
                showItemsModal('All Items', items);
            } else {
                const filtered = items.filter(i => i.category === category);
                const title = category.charAt(0).toUpperCase() + category.slice(1);
                showItemsModal(title, filtered);
            }
        }
        
        function showItemsModal(title, itemList) {
            document.getElementById('modalTitle').textContent = title;
            const grid = document.getElementById('itemsGrid');
            grid.innerHTML = itemList.map(item => `
                <div class="item-card ${item.category}" onclick="addItem('${item.name}', ${item.price})">
                    <i class="fas ${item.icon}"></i>
                    <div class="item-name">${item.name}</div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                </div>
            `).join('');
            document.getElementById('itemsModal').classList.add('active');
        }
        
        function closeItemsModal() {
            document.getElementById('itemsModal').classList.remove('active');
        }
        
        function searchItems(query) {
            if (query.length < 2) return;
            const filtered = items.filter(i => i.name.toLowerCase().includes(query.toLowerCase()));
            if (filtered.length > 0) {
                showItemsModal('Search Results', filtered);
            }
        }
        
        // ============ SALE ITEMS ============
        function addItem(name, price) {
            const existing = saleItems.find(i => i.name === name);
            if (existing) {
                existing.qty++;
            } else {
                saleItems.push({ name, price, qty: 1, discount: 0 });
            }
            renderSaleItems();
            showToast(`Added: ${name}`);
        }
        
        function removeItem(index) {
            const item = saleItems[index];
            saleItems.splice(index, 1);
            renderSaleItems();
            showToast(`Removed: ${item.name}`);
        }
        
        function changeQty(index, delta) {
            saleItems[index].qty += delta;
            if (saleItems[index].qty <= 0) {
                saleItems.splice(index, 1);
            }
            renderSaleItems();
        }
        
        function updateDiscount(index, value) {
            saleItems[index].discount = Math.max(0, Math.min(100, parseFloat(value) || 0));
            renderSaleItems();
        }
        
        function renderSaleItems() {
            const tbody = document.getElementById('saleItemsBody');
            
            if (saleItems.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="5">
                            <div class="empty-sale">
                                <i class="fas fa-shopping-cart"></i>
                                <p>0 Items</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = saleItems.map((item, i) => {
                    const itemTotal = item.price * item.qty * (1 - item.discount / 100);
                    return `
                        <tr>
                            <td><button class="item-remove" onclick="removeItem(${i})"><i class="fas fa-times"></i></button></td>
                            <td>${item.name}</td>
                            <td>$${item.price.toFixed(2)}</td>
                            <td>
                                <div class="qty-controls">
                                    <button class="qty-btn" onclick="changeQty(${i}, -1)">-</button>
                                    <span class="qty-value">${item.qty}</span>
                                    <button class="qty-btn" onclick="changeQty(${i}, 1)">+</button>
                                </div>
                            </td>
                            <td class="item-total">$${itemTotal.toFixed(2)}</td>
                        </tr>
                    `;
                }).join('');
            }
            
            updateTotals();
        }
        
        function updateTotals() {
            const subtotal = saleItems.reduce((sum, item) => {
                return sum + (item.price * item.qty * (1 - item.discount / 100));
            }, 0);
            const tax = subtotal * 0.0635;
            const total = subtotal + tax;
            
            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('taxAmt').textContent = '$' + tax.toFixed(2);
            document.getElementById('totalDue').textContent = '$' + total.toFixed(2);
        }
        
        // ============ MODE ============
        function setMode(mode, btn) {
            isReturnMode = (mode === 'return');
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('saleArea').classList.toggle('return-mode', isReturnMode);
            showToast(isReturnMode ? 'Return mode active' : 'Sale mode active', isReturnMode ? 'error' : 'success');
        }
        
        // ============ PAYMENT ============
        let pendingPaymentTotal = 0;
        let pendingPaymentCustomer = '';
        
        // Stripe Configuration
        const STRIPE_CONFIG = {
            publishableKey: localStorage.getItem('gc_stripe_pk') || '', // Set via settings
            terminalLocationId: localStorage.getItem('gc_stripe_location') || '',
            isTestMode: true
        };
        
        let stripeTerminal = null;
        let discoveredReaders = [];
        let connectedReader = null;
        
        // Initialize Stripe Terminal
        async function initStripeTerminal() {
            if (!STRIPE_CONFIG.publishableKey) {
                console.log('Stripe not configured - using simulation mode');
                return;
            }
            
            try {
                stripeTerminal = StripeTerminal.create({
                    onFetchConnectionToken: fetchConnectionToken,
                    onUnexpectedReaderDisconnect: handleDisconnect
                });
                showToast('Stripe Terminal initialized', 'success');
            } catch (e) {
                console.error('Stripe Terminal init failed:', e);
            }
        }
        
        async function fetchConnectionToken() {
            // In production, this calls your backend
            // For now, return mock or call your API endpoint
            const response = await fetch('/api/stripe/connection-token', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            return data.secret;
        }
        
        function handleDisconnect() {
            showToast('Card reader disconnected', 'error');
            connectedReader = null;
            updateReaderStatus();
        }
        
        async function discoverReaders() {
            if (!stripeTerminal) {
                showToast('Stripe not initialized. Configure API key in settings.', 'error');
                return;
            }
            
            showToast('Searching for card readers...', 'info');
            const config = { simulated: STRIPE_CONFIG.isTestMode };
            
            try {
                const discoverResult = await stripeTerminal.discoverReaders(config);
                if (discoverResult.error) {
                    showToast('Reader discovery failed: ' + discoverResult.error.message, 'error');
                    return;
                }
                
                discoveredReaders = discoverResult.discoveredReaders;
                if (discoveredReaders.length === 0) {
                    showToast('No readers found', 'error');
                    return;
                }
                
                showReaderSelectionModal();
            } catch (e) {
                showToast('Discovery error: ' + e.message, 'error');
            }
        }
        
        function showReaderSelectionModal() {
            const html = discoveredReaders.map((r, i) => 
                `<div style="padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="connectReader(${i})">
                    <div><strong>${r.label || r.serial_number}</strong><br><small style="color:#888;">${r.device_type}</small></div>
                    <i class="fas fa-chevron-right"></i>
                </div>`
            ).join('');
            
            showGenericModal('Select Card Reader', html, 'readerModal');
        }
        
        async function connectReader(index) {
            const reader = discoveredReaders[index];
            hideGenericModal('readerModal');
            showToast('Connecting to reader...', 'info');
            
            try {
                const connectResult = await stripeTerminal.connectReader(reader);
                if (connectResult.error) {
                    showToast('Connection failed: ' + connectResult.error.message, 'error');
                    return;
                }
                
                connectedReader = connectResult.reader;
                showToast('Reader connected: ' + (connectedReader.label || connectedReader.serial_number), 'success');
                updateReaderStatus();
            } catch (e) {
                showToast('Connection error: ' + e.message, 'error');
            }
        }
        
        function updateReaderStatus() {
            const indicator = document.getElementById('readerStatus');
            if (indicator) {
                indicator.innerHTML = connectedReader 
                    ? `<i class="fas fa-check-circle" style="color:#27ae60;"></i> ${connectedReader.label || 'Reader'}`
                    : '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> No reader';
            }
        }
        
        function processPayment(method) {
            if (saleItems.length === 0) {
                return showToast('No items in sale', 'error');
            }
            
            const subtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty * (1 - item.discount / 100)), 0);
            const total = subtotal * 1.0635;
            const customer = document.getElementById('customerName').value || 'Walk-in';
            pendingPaymentTotal = total;
            pendingPaymentCustomer = customer;
            
            // For cash, show cash tendering modal
            if (method === 'cash' && !isReturnMode) {
                showCashModal(total, customer);
                return;
            }
            
            // For card payments via Stripe Terminal
            if (method === 'card' && !isReturnMode) {
                processStripePayment(total, customer);
                return;
            }
            
            completePayment(method, customer, total);
        }
        
        async function processStripePayment(total, customer) {
            // If no Stripe configured or no reader, fall back to manual
            if (!stripeTerminal || !connectedReader) {
                // Simulate/manual card entry
                showManualCardModal(total, customer);
                return;
            }
            
            showToast('Processing card payment...', 'info');
            
            try {
                // Create payment intent on backend (in production)
                // For demo, we simulate this
                const paymentIntentClientSecret = await createPaymentIntent(total, customer);
                
                // Collect payment method
                const collectResult = await stripeTerminal.collectPaymentMethod(paymentIntentClientSecret);
                if (collectResult.error) {
                    showToast('Card read failed: ' + collectResult.error.message, 'error');
                    return;
                }
                
                // Process the payment
                const processResult = await stripeTerminal.processPayment(collectResult.paymentIntent);
                if (processResult.error) {
                    showToast('Payment failed: ' + processResult.error.message, 'error');
                    return;
                }
                
                if (processResult.paymentIntent.status === 'succeeded') {
                    completePayment('card', customer, total, processResult.paymentIntent.id);
                } else {
                    // Capture on backend if needed
                    await capturePayment(processResult.paymentIntent.id);
                    completePayment('card', customer, total, processResult.paymentIntent.id);
                }
            } catch (e) {
                showToast('Payment error: ' + e.message, 'error');
            }
        }
        
        async function createPaymentIntent(amount, customer) {
            // In production, call your backend:
            // const response = await fetch('/api/stripe/create-payment-intent', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ amount: Math.round(amount * 100), customer })
            // });
            // const data = await response.json();
            // return data.client_secret;
            
            // For demo/testing without backend:
            console.log('Would create PaymentIntent for $' + amount.toFixed(2));
            return 'pi_demo_' + Date.now();
        }
        
        async function capturePayment(paymentIntentId) {
            // In production, call your backend to capture
            console.log('Would capture payment:', paymentIntentId);
        }
        
        function showManualCardModal(total, customer) {
            const modalHtml = `
                <div id="manualCardModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;">
                        <h3 style="margin:0 0 15px;color:#3498db;"><i class="fas fa-credit-card"></i> Card Payment</h3>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;">
                            <div style="font-size:1.5em;font-weight:700;">$${total.toFixed(2)}</div>
                            <div style="color:#888;font-size:0.9em;">${customer}</div>
                        </div>
                        <div style="margin-bottom:15px;padding:15px;background:#e3f2fd;border-radius:8px;text-align:center;">
                            <i class="fas fa-info-circle" style="color:#2196f3;"></i>
                            <span style="margin-left:8px;">Process card on external terminal or enter manually</span>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Last 4 digits (optional):</label>
                            <input type="text" id="cardLast4" maxlength="4" pattern="[0-9]*" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;" placeholder="0000">
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Auth Code (optional):</label>
                            <input type="text" id="authCode" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;" placeholder="Authorization code">
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeManualCardModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="submitManualCard('${customer}')" style="flex:1;padding:12px;border:none;background:#3498db;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Approve</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeManualCardModal() {
            const modal = document.getElementById('manualCardModal');
            if (modal) modal.remove();
        }
        
        function submitManualCard(customer) {
            const last4 = document.getElementById('cardLast4').value || '****';
            const authCode = document.getElementById('authCode').value || '';
            closeManualCardModal();
            completePayment('card', customer, pendingPaymentTotal, null, { last4, authCode });
        }
        
        function showCashModal(total, customer) {
            const modalHtml = `
                <div id="cashModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;">
                        <h3 style="margin:0 0 15px;color:#27ae60;"><i class="fas fa-money-bill-wave"></i> Cash Payment</h3>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;font-size:1.3em;font-weight:700;">
                                <span>Total Due:</span><span>$${total.toFixed(2)}</span>
                            </div>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Cash Tendered:</label>
                            <input type="number" id="cashTenderedInput" step="0.01" min="0" style="width:100%;padding:12px;font-size:1.2em;border:2px solid #ddd;border-radius:6px;box-sizing:border-box;" onkeyup="updateCashChange()" autofocus>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:15px;">
                            <button onclick="setCashAmount(20)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$20</button>
                            <button onclick="setCashAmount(50)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$50</button>
                            <button onclick="setCashAmount(100)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$100</button>
                            <button onclick="setCashAmount(${total.toFixed(2)})" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">Exact</button>
                        </div>
                        <div id="changeDisplay" style="display:none;background:#d4edda;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;">
                            <span style="font-size:0.9em;">Change Due:</span>
                            <span id="changeAmount" style="font-size:1.5em;font-weight:700;display:block;">$0.00</span>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeCashModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="submitCashPayment('${customer}')" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Complete</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('cashTenderedInput').focus();
        }
        
        function setCashAmount(amount) {
            document.getElementById('cashTenderedInput').value = parseFloat(amount).toFixed(2);
            updateCashChange();
        }
        
        function updateCashChange() {
            const tendered = parseFloat(document.getElementById('cashTenderedInput').value) || 0;
            const changeDisplay = document.getElementById('changeDisplay');
            if (tendered >= pendingPaymentTotal) {
                const change = tendered - pendingPaymentTotal;
                document.getElementById('changeAmount').textContent = '$' + change.toFixed(2);
                changeDisplay.style.display = 'block';
            } else {
                changeDisplay.style.display = 'none';
            }
        }
        
        function closeCashModal() {
            const modal = document.getElementById('cashModal');
            if (modal) modal.remove();
        }
        
        function submitCashPayment(customer) {
            const tendered = parseFloat(document.getElementById('cashTenderedInput').value) || 0;
            if (tendered < pendingPaymentTotal) {
                showToast('Insufficient cash tendered', 'error');
                return;
            }
            const change = tendered - pendingPaymentTotal;
            closeCashModal();
            completePayment('cash', customer, pendingPaymentTotal, null, { tendered, change });
        }
        
        function completePayment(method, customer, total, stripePaymentId = null, paymentDetails = {}) {
            const now = new Date();
            const subtotal = total / 1.0635;
            const tax = total - subtotal;
            
            const transaction = {
                id: 26763 + transactions.length,
                customer: customer,
                amount: isReturnMode ? -total : total,
                subtotal: subtotal,
                tax: tax,
                method: method,
                time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: now.toISOString(),
                itemCount: saleItems.length,
                itemDetails: saleItems.map(i => ({ name: i.name, qty: i.qty, price: i.price, discount: i.discount })),
                isReturn: isReturnMode,
                stripePaymentId: stripePaymentId,
                paymentDetails: paymentDetails,
                register: localStorage.getItem('gc_register_id') || 'POS-1',
                employee: getCurrentUserName()
            };
            
            transactions.unshift(transaction);
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            
            // Deduct inventory for sold items
            if (!isReturnMode) {
                deductInventory(saleItems);
            }
            
            // Update customer stats if not walk-in
            if (customer !== 'Walk-in') {
                updateCustomerStats(customer, total);
                // Award loyalty points for completed sales
                if (!isReturnMode) {
                    awardLoyaltyPoints(customer, total);
                }
            }
            
            // Update daily sales tracking
            updateDailySales(total, method);
            
            // Update cash drawer if cash payment
            if (method === 'cash' && !isReturnMode) {
                updateCashDrawer(total, 'in');
            } else if (method === 'cash' && isReturnMode) {
                updateCashDrawer(total, 'out');
            }
            
            const actionWord = isReturnMode ? 'Return' : 'Payment';
            showToast(`${actionWord} of $${total.toFixed(2)} processed via ${method}!`, 'success');
            
            // Show print receipt option
            if (!isReturnMode && confirm('Print receipt?')) {
                printReceipt(customer, total, method, [...saleItems], transaction.id);
            }
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderTransactions();
        }
        
        function updateCustomerStats(customerName, amount) {
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = customers.find(c => 
                `${c.firstName} ${c.lastName}`.toLowerCase() === customerName.toLowerCase()
            );
            if (customer) {
                customer.visitCount = (customer.visitCount || 0) + 1;
                customer.totalSpent = (customer.totalSpent || 0) + amount;
                customer.lastVisit = new Date().toISOString();
                localStorage.setItem('gc_customers', JSON.stringify(customers));
            }
        }
        
        function updateDailySales(amount, method) {
            const today = new Date().toDateString();
            const dailyData = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            if (!dailyData[today]) {
                dailyData[today] = { total: 0, count: 0, cash: 0, card: 0, items: 0 };
            }
            dailyData[today].total += amount;
            dailyData[today].count += 1;
            dailyData[today][method] = (dailyData[today][method] || 0) + amount;
            localStorage.setItem('gc_daily_sales', JSON.stringify(dailyData));
        }
        
        function updateCashDrawer(amount, type) {
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            
            if (!drawer[today]) return; // Drawer not opened
            
            if (type === 'in') {
                drawer[today].cashIn = (drawer[today].cashIn || 0) + amount;
            } else {
                drawer[today].cashOut = (drawer[today].cashOut || 0) + amount;
            }
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
        }
        
        function printReceipt(customer, total, method, items, transId) {
            const subtotal = total / 1.0635;
            const tax = total - subtotal;
            const now = new Date();
            
            const receiptWindow = window.open('', '_blank', 'width=350,height=600');
            var html = '<html><head><title>Receipt</title><style>';
            html += 'body { font-family: "Courier New", monospace; font-size: 12px; width: 280px; margin: 0 auto; padding: 10px; }';
            html += '.center { text-align: center; } .bold { font-weight: bold; }';
            html += '.line { border-top: 1px dashed #000; margin: 8px 0; }';
            html += '.row { display: flex; justify-content: space-between; margin: 3px 0; }';
            html += '.total-row { font-size: 14px; font-weight: bold; }';
            html += 'h2 { margin: 5px 0; font-size: 16px; }';
            html += '</style></head><bo' + 'dy>';
            html += '<div class="center"><h2>⛳ GOLF COVE</h2>';
            html += '<p>123 Golf Course Rd<br>Anytown, CT 06000<br>(555) 123-4567</p></div>';
            html += '<div class="line"></div>';
            html += '<div class="row"><span>Date:</span><span>' + now.toLocaleDateString() + '</span></div>';
            html += '<div class="row"><span>Time:</span><span>' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + '</span></div>';
            html += '<div class="row"><span>Customer:</span><span>' + customer + '</span></div>';
            html += '<div class="line"></div>';
            items.forEach(function(item) {
                html += '<div class="row"><span>' + item.name + ' x' + item.qty + '</span><span>$' + (item.price * item.qty * (1 - item.discount/100)).toFixed(2) + '</span></div>';
                if (item.discount > 0) html += '<div style="font-size:10px;color:#666;margin-left:10px;">(' + item.discount + '% disc)</div>';
            });
            html += '<div class="line"></div>';
            html += '<div class="row"><span>Subtotal:</span><span>$' + subtotal.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>Tax (6.35%):</span><span>$' + tax.toFixed(2) + '</span></div>';
            html += '<div class="line"></div>';
            html += '<div class="row total-row"><span>TOTAL:</span><span>$' + total.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>Paid:</span><span>' + method.toUpperCase() + '</span></div>';
            html += '<div class="line"></div>';
            html += '<div class="center" style="margin-top:10px;"><p>Thank you for visiting!</p>';
            html += '<p style="font-size:10px;">⛳ See you on the greens! ⛳</p></div>';
            html += '</bo' + 'dy></ht' + 'ml>';
            receiptWindow.document.write(html);
            receiptWindow.document.close();
            receiptWindow.print();
        }
        
        function applyDiscount() {
            if (saleItems.length === 0) return showToast('Add items first', 'error');
            
            // Check permission
            if (!hasPermission('canDiscount')) {
                return showToast('You do not have permission to apply discounts', 'error');
            }
            
            const maxDisc = rolePermissions[currentUser.role]?.maxDiscount || 0;
            const pct = prompt('Enter discount percentage (max ' + maxDisc + '%):');
            if (pct === null) return;
            
            let discPct = Math.max(0, parseFloat(pct) || 0);
            if (discPct > maxDisc) {
                showToast('Max discount for your role is ' + maxDisc + '%', 'error');
                discPct = maxDisc;
            }
            
            saleItems.forEach(item => item.discount = discPct);
            renderSaleItems();
            showToast(discPct + '% discount applied to all items');
        }
        
        function clearSale() {
            if (saleItems.length === 0) return;
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            showToast('Sale cleared');
        }
        
        // ============ SUSPEND / RESUME ============
        function suspendSale() {
            if (saleItems.length === 0) return showToast('No items to suspend', 'error');
            
            const customer = document.getElementById('customerName').value || 'Walk-in';
            const subtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty * (1 - item.discount / 100)), 0);
            
            suspendedSales.push({
                id: Date.now(),
                customer: customer,
                amount: subtotal * 1.0635,
                items: [...saleItems],
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
            });
            localStorage.setItem('gc_suspended', JSON.stringify(suspendedSales));
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderSuspended();
            showToast('Sale suspended');
        }
        
        function resumeSale(id) {
            const sale = suspendedSales.find(s => s.id === id);
            if (sale) {
                saleItems = sale.items.map(i => ({ ...i }));
                document.getElementById('customerName').value = sale.customer;
                suspendedSales = suspendedSales.filter(s => s.id !== id);
                localStorage.setItem('gc_suspended', JSON.stringify(suspendedSales));
                renderSaleItems();
                renderSuspended();
                showToast('Sale resumed');
            }
        }
        
        // ============ TAB ============
        async function startTab() {
            if (saleItems.length === 0) return showToast('Add items first', 'error');
            
            const customer = document.getElementById('customerName').value || prompt('Customer name for tab:');
            if (!customer) return;
            
            // Format items for TabsSync
            const items = saleItems.map(item => ({
                name: item.name,
                price: item.price * (1 - item.discount / 100),
                qty: item.qty,
                category: item.category
            }));
            
            // Use TabsSync for global tab management
            const employeeName = getCurrentUserName();
            const existingTab = TabsSync.getTabByCustomer(customer);
            
            if (existingTab) {
                // Add to existing tab
                await TabsSync.addItemsToTab(existingTab.id, items, employeeName);
                showToast(`Added ${items.length} item(s) to ${customer}'s tab`);
            } else {
                // Create new tab
                await TabsSync.createTab(customer, null, items, employeeName);
                showToast(`Tab started for ${customer}`);
            }
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderOpenTabs();
        }
        
        // Quick Add to Tab (for single item)
        async function quickAddToTab(itemName, itemPrice, category) {
            // Show tab selector modal
            const tabs = TabsSync.getAllTabs();
            
            let html = '<div style="padding:20px;">';
            html += '<h3 style="margin-bottom:15px;">Add to Tab</h3>';
            html += '<div style="margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:8px;">';
            html += `<strong>${itemName}</strong> - $${itemPrice.toFixed(2)}`;
            html += '</div>';
            
            if (tabs.length > 0) {
                html += '<div style="margin-bottom:15px;">';
                html += '<label style="font-size:13px;color:#666;">Select Tab:</label>';
                html += '<select id="tabSelect" style="width:100%;padding:10px;margin-top:5px;border:1px solid #ddd;border-radius:6px;font-size:14px;">';
                tabs.forEach(t => {
                    html += `<option value="${t.id}">${t.customer} - $${(t.total||0).toFixed(2)} (${t.items?.length||0} items)</option>`;
                });
                html += '<option value="new">+ New Tab</option>';
                html += '</select></div>';
            }
            
            html += '<div style="margin-bottom:15px;" id="newTabNameDiv"' + (tabs.length > 0 ? ' style="display:none;"' : '') + '>';
            html += '<label style="font-size:13px;color:#666;">Customer Name:</label>';
            html += '<input type="text" id="newTabName" placeholder="Customer name" style="width:100%;padding:10px;margin-top:5px;border:1px solid #ddd;border-radius:6px;font-size:14px;">';
            html += '</div>';
            
            html += '<div style="display:flex;gap:10px;">';
            html += '<button onclick="closeQuickTabModal()" style="flex:1;padding:12px;background:#f0f0f0;border:none;border-radius:6px;cursor:pointer;">Cancel</button>';
            html += `<button onclick="confirmAddToTab('${itemName}', ${itemPrice}, '${category}')" style="flex:1;padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">Add to Tab</button>`;
            html += '</div></div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'quickTabModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
            modal.innerHTML = `<div style="background:#fff;border-radius:12px;width:90%;max-width:400px;">${html}</div>`;
            document.body.appendChild(modal);
            
            // Handle select change
            const select = document.getElementById('tabSelect');
            if (select) {
                select.onchange = () => {
                    document.getElementById('newTabNameDiv').style.display = select.value === 'new' ? 'block' : 'none';
                };
            }
        }
        
        function closeQuickTabModal() {
            const modal = document.getElementById('quickTabModal');
            if (modal) modal.remove();
        }
        
        async function confirmAddToTab(itemName, itemPrice, category) {
            const select = document.getElementById('tabSelect');
            const tabId = select ? select.value : 'new';
            const item = { name: itemName, price: itemPrice, qty: 1, category: category };
            const employeeName = getCurrentUserName();
            
            if (tabId === 'new') {
                const customerName = document.getElementById('newTabName').value.trim();
                if (!customerName) return showToast('Enter customer name', 'error');
                await TabsSync.createTab(customerName, null, [item], employeeName);
                showToast(`Tab started for ${customerName}`);
            } else {
                await TabsSync.addItemsToTab(tabId, [item], employeeName);
                const tab = TabsSync.getTab(tabId);
                showToast(`Added to ${tab?.customer}'s tab`);
            }
            
            closeQuickTabModal();
            renderOpenTabs();
        }
        
        // Render Open Tabs
        function renderOpenTabs() {
            const container = document.getElementById('openTabsList');
            if (!container) return;
            
            const tabs = TabsSync.getAllTabs();
            
            if (tabs.length === 0) {
                container.innerHTML = '<div class="empty-list">No open tabs</div>';
                return;
            }
            
            container.innerHTML = tabs.map(t => `
                <div class="tab-item" onclick="selectTab('${t.id}')">
                    <div class="tab-left">
                        <div class="tab-customer">${t.customer}</div>
                        <div class="tab-info">${t.items?.length || 0} items • ${t.openedBy || 'Staff'}</div>
                    </div>
                    <div class="tab-right">
                        <div class="tab-total">$${(t.total || 0).toFixed(2)}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Select/View Tab
        function selectTab(tabId) {
            const tab = TabsSync.getTab(tabId);
            if (!tab) return;
            
            // Load tab items into current sale
            saleItems = (tab.items || []).map((item, i) => ({
                id: Date.now() + i,
                name: item.name,
                price: item.price,
                qty: item.qty || 1,
                discount: 0,
                category: item.category || 'misc'
            }));
            
            document.getElementById('customerName').value = tab.customer;
            renderSaleItems();
            
            // Store active tab ID for closing
            window.activeTabId = tabId;
            showToast(`Loaded ${tab.customer}'s tab`);
        }
        
        // Close Tab (pay and complete)
        async function closeActiveTab(paymentMethod = 'card', tip = 0) {
            if (!window.activeTabId) return;
            
            const employeeName = getCurrentUserName();
            await TabsSync.closeTab(window.activeTabId, paymentMethod, tip, employeeName);
            
            window.activeTabId = null;
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderOpenTabs();
            showToast('Tab closed successfully');
        }
        
        // ============ RENDER PANELS ============
        function renderTransactions() {
            const container = document.getElementById('recentTrans');
            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-list">No transactions yet</div>';
                return;
            }
            container.innerHTML = transactions.slice(0, 8).map(t => `
                <div class="trans-item ${t.isReturn ? 'return' : ''}" onclick="viewTransaction(${t.id})">
                    <div class="trans-left">
                        <div class="trans-time">${t.time}</div>
                        <div class="trans-customer">${t.customer}</div>
                    </div>
                    <div class="trans-right">
                        <div class="trans-amount">${t.isReturn ? '-' : ''}$${Math.abs(t.amount).toFixed(2)}</div>
                        <div class="trans-id">#${t.id}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderSuspended() {
            const container = document.getElementById('suspendedSales');
            if (suspendedSales.length === 0) {
                container.innerHTML = '<div class="empty-list">No suspended sales</div>';
                return;
            }
            container.innerHTML = suspendedSales.map(s => `
                <div class="suspended-item" onclick="resumeSale(${s.id})">
                    <div class="susp-header">
                        <span class="susp-name">${s.time}</span>
                        <span class="susp-amount">$${s.amount.toFixed(2)}</span>
                    </div>
                    <div class="susp-customer">${s.customer} • ${s.items.length} item${s.items.length !== 1 ? 's' : ''}</div>
                </div>
            `).join('');
        }
        
        function viewTransaction(id) {
            const t = transactions.find(tr => tr.id === id);
            if (t) {
                const detailHtml = `
                    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                        <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;" onclick="event.stopPropagation()">
                            <h3 style="margin:0 0 15px;border-bottom:2px solid #4a90a4;padding-bottom:10px;"><i class="fas fa-receipt" style="color:#4a90a4;"></i> Transaction #${t.id}</h3>
                            <div style="display:grid;gap:10px;">
                                <div style="display:flex;justify-content:space-between;"><strong>Customer:</strong><span>${t.customer}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Type:</strong><span style="color:${t.isReturn ? '#e74c3c' : '#27ae60'};font-weight:600;">${t.isReturn ? 'RETURN' : 'SALE'}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Amount:</strong><span style="font-size:1.2em;font-weight:700;">$${Math.abs(t.amount).toFixed(2)}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Time:</strong><span>${t.time}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Items:</strong><span>${t.items || 'N/A'}</span></div>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:20px;">
                                <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                                <button onclick="printTransactionReceipt(${t.id})" style="flex:1;padding:12px;border:none;background:#4a90a4;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Print</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', detailHtml);
            }
        }
        
        function printTransactionReceipt(id) {
            const t = transactions.find(tr => tr.id === id);
            if (!t) return;
            const w = window.open('', '_blank', 'width=400,height=500');
            var html = '<html><head><title>Receipt #' + t.id + '</title><style>body{font-family:monospace;padding:20px;max-width:300px;margin:0 auto;}</style></head><bo' + 'dy>';
            html += '<div style="text-align:center;"><h2>GOLF COVE</h2><p>Indoor Golf & Bar</p></div><hr>';
            html += '<p><strong>Receipt #' + t.id + '</strong></p>';
            html += '<p>Customer: ' + t.customer + '</p>';
            html += '<p>Type: ' + (t.isReturn ? 'RETURN' : 'SALE') + '</p>';
            html += '<p style="font-size:1.3em;"><strong>Total: $' + Math.abs(t.amount).toFixed(2) + '</strong></p>';
            html += '<p>Time: ' + t.time + '</p><hr><p style="text-align:center;">Thank you!</p>';
            html += '<scr' + 'ipt>window.print();setTimeout(()=>window.close(),500);</scr' + 'ipt>';
            html += '</bo' + 'dy></ht' + 'ml>';
            w.document.write(html);
            w.document.close();
        }
        
        // ============ REGISTER FUNCTIONS ============
        function openDrawer() {
            showToast('Cash drawer opened');
            // In a real system, this would send a signal to open the physical drawer
        }
        
        function closeRegister() {
            // Calculate summary
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => {
                // Check if transaction is from today (approximate by checking recent)
                return true; // In production, would filter by actual date
            });
            
            const sales = todayTransactions.filter(t => !t.isReturn);
            const returns = todayTransactions.filter(t => t.isReturn);
            const salesTotal = sales.reduce((sum, t) => sum + t.amount, 0);
            const returnsTotal = returns.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netTotal = salesTotal - returnsTotal;
            
            const cashSales = todayTransactions.filter(t => t.method === 'cash' && !t.isReturn);
            const cardSales = todayTransactions.filter(t => t.method !== 'cash' && !t.isReturn);
            const cashTotal = cashSales.reduce((sum, t) => sum + t.amount, 0);
            const cardTotal = cardSales.reduce((sum, t) => sum + t.amount, 0);
            
            // Calculate tax collected
            const taxCollected = netTotal - (netTotal / 1.0635);
            
            // Calculate average transaction
            const avgTransaction = sales.length > 0 ? salesTotal / sales.length : 0;
            
            const reportHtml = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 15px;border-bottom:2px solid #4a90a4;padding-bottom:10px;"><i class="fas fa-cash-register" style="color:#4a90a4;"></i> Register Close Report</h3>
                        <p style="color:#666;margin-bottom:15px;">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })} at ${new Date().toLocaleTimeString()}</p>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;color:#333;">Transaction Summary</h4>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Sales (${sales.length}):</span><span style="color:#27ae60;">+$${salesTotal.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Returns (${returns.length}):</span><span style="color:#e74c3c;">-$${returnsTotal.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #ddd;margin-top:5px;font-weight:700;font-size:1.1em;"><span>Net Total:</span><span>$${netTotal.toFixed(2)}</span></div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;color:#333;">Payment Breakdown</h4>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span><i class="fas fa-money-bill-wave" style="color:#27ae60;"></i> Cash:</span><span>$${cashTotal.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span><i class="fas fa-credit-card" style="color:#4a90a4;"></i> Card:</span><span>$${cardTotal.toFixed(2)}</span></div>
                        </div>
                        
                        <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;color:#2e7d32;">Additional Details</h4>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Tax Collected (6.35%):</span><span>$${taxCollected.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Avg Transaction:</span><span>$${avgTransaction.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Items Sold:</span><span>${sales.reduce((sum, t) => sum + (t.items || 0), 0)}</span></div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="printCloseReport();this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#4a90a4;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Print</button>
                            <button onclick="confirmCloseRegister();this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#e74c3c;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-door-closed"></i> Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', reportHtml);
        }
        
        function printCloseReport() {
            const sales = transactions.filter(t => !t.isReturn);
            const returns = transactions.filter(t => t.isReturn);
            const salesTotal = sales.reduce((sum, t) => sum + t.amount, 0);
            const returnsTotal = returns.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netTotal = salesTotal - returnsTotal;
            const taxCollected = netTotal - (netTotal / 1.0635);
            
            const w = window.open('', '_blank', 'width=400,height=600');
            var html = '<html><head><title>Register Close Report</title>';
            html += '<style>body{font-family:monospace;padding:20px;max-width:300px;margin:0 auto;font-size:12px;}';
            html += 'h2{text-align:center;margin-bottom:5px;}hr{border:none;border-top:1px dashed #333;margin:10px 0;}';
            html += '.row{display:flex;justify-content:space-between;padding:3px 0;}</style></head>';
            html += '<bo' + 'dy>';
            html += '<h2>GOLF COVE</h2>';
            html += '<p style="text-align:center;margin-bottom:15px;">Register Close Report</p>';
            html += '<p style="text-align:center;">' + new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString() + '</p>';
            html += '<hr>';
            html += '<div class="row"><span>Sales (' + sales.length + '):</span><span>$' + salesTotal.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>Returns (' + returns.length + '):</span><span>-$' + returnsTotal.toFixed(2) + '</span></div>';
            html += '<hr>';
            html += '<div class="row" style="font-weight:bold;"><span>NET TOTAL:</span><span>$' + netTotal.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>Tax Collected:</span><span>$' + taxCollected.toFixed(2) + '</span></div>';
            html += '<hr>';
            html += '<p style="text-align:center;margin-top:20px;">Employee: ' + getCurrentUserName() + '</p>';
            html += '<scr' + 'ipt>window.print();setTimeout(()=>window.close(),500);</scr' + 'ipt>';
            html += '</bo' + 'dy></ht' + 'ml>';
            w.document.write(html);
            w.document.close();
        }
        
        function confirmCloseRegister() {
            // In a real system, this would finalize the register close
            showToast('Register closed for the day', 'success');
            // Could clear transactions or save end-of-day report
        }
        
        function managerOverride() {
            const pin = prompt('Enter manager PIN:');
            if (!pin) return false;
            
            // Validate against actual manager PINs from localStorage
            const employees = JSON.parse(localStorage.getItem('gc_employees') || '[]');
            const manager = employees.find(e => e.pin === pin && (e.role === 'manager' || e.role === 'admin'));
            
            if (manager) {
                showToast('Manager override granted', 'success');
                return true;
            } else {
                showToast('Invalid PIN', 'error');
                return false;
            }
        }
        
        function issueRaincheck() {
            const customer = prompt('Customer name for raincheck:');
            if (customer) {
                showToast(`Raincheck issued to ${customer}`);
            }
        }
        
        function addNewCustomer() {
            const firstName = prompt('First name:');
            if (!firstName) return;
            const lastName = prompt('Last name:');
            if (!lastName) return;
            
            const phone = prompt('Phone number (optional):');
            const email = prompt('Email (optional):');
            
            // Save to customer database with proper structure
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const newCustomer = {
                id: Date.now(),
                firstName: firstName.trim(),
                lastName: lastName.trim(),
                phone: phone || '',
                email: email || '',
                isMember: false,
                memberType: null,
                memberSince: null,
                memberExpires: null,
                priceClass: 'Regular',
                passes: [],
                transactions: [],
                createdAt: new Date().toISOString()
            };
            customers.push(newCustomer);
            localStorage.setItem('gc_customers', JSON.stringify(customers));
            
            document.getElementById('customerName').value = `${firstName} ${lastName}`;
            showToast(`Customer "${firstName} ${lastName}" added`);
        }
        
        // ============ CUSTOMER AUTOCOMPLETE ============
        const customerInput = document.getElementById('customerName');
        const customerAutocomplete = document.getElementById('customerAutocomplete');
        
        customerInput.addEventListener('input', function() {
            const val = this.value.toLowerCase().trim();
            if (val.length < 2) {
                customerAutocomplete.classList.remove('show');
                return;
            }
            
            const allCustomers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const matches = allCustomers.filter(c => {
                const fullName = `${c.firstName} ${c.lastName}`.toLowerCase();
                return fullName.includes(val) || (c.email && c.email.toLowerCase().includes(val)) || (c.phone && c.phone.includes(val));
            }).slice(0, 8);
            
            if (matches.length === 0) {
                customerAutocomplete.classList.remove('show');
                return;
            }
            
            customerAutocomplete.innerHTML = matches.map(c => {
                const isMember = c.isMember && c.memberExpires && new Date(c.memberExpires) > new Date();
                const initials = (c.firstName[0] || '') + (c.lastName[0] || '');
                return `
                    <div class="autocomplete-item" onclick="selectCustomerAutocomplete('${c.firstName} ${c.lastName}', ${isMember})">
                        <div class="avatar ${isMember ? 'member' : ''}">${initials.toUpperCase()}</div>
                        <div class="info">
                            <div class="name">${c.firstName} ${c.lastName}${isMember ? '<span class="member-tag">MEMBER</span>' : ''}</div>
                            <div class="meta">${c.email || c.phone || 'No contact'}</div>
                        </div>
                    </div>
                `;
            }).join('');
            customerAutocomplete.classList.add('show');
        });
        
        customerInput.addEventListener('blur', function() {
            setTimeout(() => customerAutocomplete.classList.remove('show'), 200);
        });
        
        function selectCustomerAutocomplete(name, isMember) {
            customerInput.value = name;
            customerAutocomplete.classList.remove('show');
            if (isMember) {
                showToast(`Member: ${name} - 10% discount applied!`, 'success');
                // Auto-apply member discount
                saleItems.forEach(item => {
                    if (item.discount < 10) item.discount = 10;
                });
                renderSaleItems();
            }
        }
        
        // ============ START TAB ============
        function startTab() {
            if (saleItems.length === 0) {
                // Just create empty tab
                const customer = document.getElementById('customerName').value || 'Walk-in';
                const tabName = prompt('Tab name:', customer);
                if (!tabName) return;
                
                const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                tabs.push({
                    id: Date.now(),
                    customer: tabName,
                    employee: getCurrentUserName(),
                    amount: 0,
                    subtotal: 0,
                    items: [],
                    table: 'Tab',
                    createdAt: new Date().toISOString()
                });
                localStorage.setItem('gc_tabs', JSON.stringify(tabs));
                showToast(`Tab started for ${tabName}`);
                return;
            }
            
            const customer = document.getElementById('customerName').value || 'Walk-in';
            const tabName = prompt('Tab name:', customer);
            if (!tabName) return;
            
            const subtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty * (1 - item.discount / 100)), 0);
            const total = subtotal * 1.0635;
            
            const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
            tabs.push({
                id: Date.now(),
                customer: tabName,
                employee: getCurrentUserName(),
                amount: total,
                subtotal: subtotal,
                items: [...saleItems],
                table: 'Tab',
                createdAt: new Date().toISOString()
            });
            localStorage.setItem('gc_tabs', JSON.stringify(tabs));
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            showToast(`Tab started for ${tabName} - $${total.toFixed(2)}`);
        }
        
        // ============ TOAST ============
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Close modal on background click
        document.getElementById('itemsModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeItemsModal();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeItemsModal();
                closeCashModal();
                closeManualCardModal();
            }
            if (e.key === 'F9') { e.preventDefault(); processPayment('card'); }
            if (e.key === 'F8') { e.preventDefault(); processPayment('cash'); }
            if (e.key === 'F2') { e.preventDefault(); document.getElementById('itemSearch').focus(); }
            if (e.key === 'F4') { e.preventDefault(); clearSale(); }
            if (e.key === 'F7') { e.preventDefault(); applyDiscount(); }
            // Ctrl+N for new customer
            if (e.ctrlKey && e.key === 'n') { e.preventDefault(); addNewCustomer(); }
            // F6 for open price item
            if (e.key === 'F6') { e.preventDefault(); addOpenPriceItem(); }
            // F10 for settings
            if (e.key === 'F10') { e.preventDefault(); showSettings(); }
        });
        
        // Open Price Item (misc charge)
        function addOpenPriceItem() {
            const name = prompt('Item description:');
            if (!name) return;
            const price = parseFloat(prompt('Enter price:'));
            if (isNaN(price) || price <= 0) return showToast('Invalid price', 'error');
            
            saleItems.push({
                id: Date.now(),
                name: name,
                price: price,
                qty: 1,
                discount: 0,
                isCustom: true
            });
            renderSaleItems();
            showToast(`Added: ${name} - $${price.toFixed(2)}`);
        }
        
        // ============ STRIPE SETTINGS ============
        function showSettings() {
            const currentPK = localStorage.getItem('gc_stripe_pk') || '';
            const currentLocation = localStorage.getItem('gc_stripe_location') || '';
            const registerId = localStorage.getItem('gc_register_id') || 'POS-1';
            
            const html = `
                <div id="settingsModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:90%;">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-cog"></i> POS Settings</h3>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Register ID:</label>
                            <input type="text" id="settingsRegisterId" value="${registerId}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 15px;color:#6772e5;"><i class="fab fa-stripe"></i> Stripe Configuration</h4>
                            
                            <div style="margin-bottom:10px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;">Publishable Key:</label>
                                <input type="text" id="settingsStripePK" value="${currentPK}" placeholder="pk_test_..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;font-size:12px;">
                            </div>
                            
                            <div style="margin-bottom:10px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;">Terminal Location ID:</label>
                                <input type="text" id="settingsStripeLocation" value="${currentLocation}" placeholder="tml_..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;font-size:12px;">
                            </div>
                            
                            <button onclick="discoverReaders()" style="width:100%;padding:10px;border:none;background:#6772e5;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">
                                <i class="fas fa-bluetooth"></i> Discover Readers
                            </button>
                        </div>
                        
                        <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 15px;color:#2e7d32;"><i class="fas fa-database"></i> Data Import/Export</h4>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <button onclick="closeSettings();showDataImportModal()" style="flex:1;padding:10px;border:1px solid #27ae60;background:#fff;color:#27ae60;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-upload"></i> Import Data</button>
                                <button onclick="exportAllData()" style="flex:1;padding:10px;border:1px solid #27ae60;background:#fff;color:#27ae60;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-download"></i> Export All</button>
                            </div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                                <button onclick="backupToJSON()" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;"><i class="fas fa-save"></i> Backup</button>
                                <button onclick="restoreFromJSON()" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;"><i class="fas fa-undo"></i> Restore</button>
                            </div>
                        </div>
                        
                        <div style="background:#fff3cd;padding:12px;border-radius:8px;margin-bottom:15px;font-size:13px;">
                            <i class="fas fa-info-circle" style="color:#856404;"></i>
                            For production, you'll need a Stripe account with Terminal enabled. 
                            <a href="https://stripe.com/terminal" target="_blank" style="color:#856404;">Learn more</a>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeSettings()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="saveSettings()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.remove();
        }
        
        function saveSettings() {
            const pk = document.getElementById('settingsStripePK').value.trim();
            const location = document.getElementById('settingsStripeLocation').value.trim();
            const registerId = document.getElementById('settingsRegisterId').value.trim();
            
            localStorage.setItem('gc_stripe_pk', pk);
            localStorage.setItem('gc_stripe_location', location);
            localStorage.setItem('gc_register_id', registerId);
            
            STRIPE_CONFIG.publishableKey = pk;
            STRIPE_CONFIG.terminalLocationId = location;
            
            closeSettings();
            showToast('Settings saved. Reinitializing Stripe...', 'success');
            
            if (pk) {
                initStripeTerminal();
            }
        }
        
        // ============ REFUNDS ============
        function processRefund(transactionId) {
            const trans = transactions.find(t => t.id === transactionId);
            if (!trans) return showToast('Transaction not found', 'error');
            if (trans.isReturn) return showToast('Cannot refund a return', 'error');
            
            if (!confirm(`Refund $${trans.amount.toFixed(2)} to ${trans.customer}?`)) return;
            
            // If Stripe payment, process refund through Stripe
            if (trans.stripePaymentId && trans.method === 'card') {
                processStripeRefund(trans);
            } else {
                completeRefund(trans);
            }
        }
        
        async function processStripeRefund(trans) {
            showToast('Processing Stripe refund...', 'info');
            
            // In production, call your backend:
            // const response = await fetch('/api/stripe/refund', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ paymentIntentId: trans.stripePaymentId, amount: Math.round(trans.amount * 100) })
            // });
            
            // For demo:
            console.log('Would refund Stripe payment:', trans.stripePaymentId);
            completeRefund(trans);
        }
        
        function completeRefund(originalTrans) {
            const refundTrans = {
                id: 26763 + transactions.length,
                customer: originalTrans.customer,
                amount: -originalTrans.amount,
                method: originalTrans.method,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: new Date().toISOString(),
                isReturn: true,
                refundOf: originalTrans.id,
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            };
            
            transactions.unshift(refundTrans);
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            renderTransactions();
            showToast(`Refund of $${originalTrans.amount.toFixed(2)} processed`, 'success');
        }
        
        // ============ INVENTORY MANAGEMENT ============
        function showInventory() {
            const trackedItems = items.filter(i => i.trackInventory);
            const lowStock = trackedItems.filter(i => i.stock <= 5);
            
            let html = `
                <div id="inventoryModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:700px;width:95%;max-height:90vh;overflow-y:auto;">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-boxes"></i> Inventory Management</h3>
                        
                        ${lowStock.length > 0 ? `
                            <div style="background:#f8d7da;padding:12px;border-radius:8px;margin-bottom:15px;">
                                <strong style="color:#721c24;"><i class="fas fa-exclamation-triangle"></i> Low Stock Alert:</strong>
                                <span style="color:#721c24;">${lowStock.map(i => `${i.name} (${i.stock})`).join(', ')}</span>
                            </div>
                        ` : ''}
                        
                        <div style="display:flex;gap:10px;margin-bottom:15px;">
                            <input type="text" id="invSearch" placeholder="Search items..." style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterInventory(this.value)">
                            <select id="invCategory" style="padding:10px;border:1px solid #ddd;border-radius:6px;" onchange="filterInventory(document.getElementById('invSearch').value)">
                                <option value="">All Categories</option>
                                <option value="food">Food</option>
                                <option value="beer">Beer</option>
                                <option value="wine">Wine</option>
                                <option value="beverage">Beverages</option>
                                <option value="merch">Merchandise</option>
                            </select>
                        </div>
                        
                        <table style="width:100%;border-collapse:collapse;" id="invTable">
                            <thead>
                                <tr style="background:#f8f9fa;">
                                    <th style="padding:10px;text-align:left;border-bottom:2px solid #ddd;">Item</th>
                                    <th style="padding:10px;text-align:center;border-bottom:2px solid #ddd;">Category</th>
                                    <th style="padding:10px;text-align:center;border-bottom:2px solid #ddd;">Stock</th>
                                    <th style="padding:10px;text-align:center;border-bottom:2px solid #ddd;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="invBody">
                                ${renderInventoryRows(trackedItems)}
                            </tbody>
                        </table>
                        
                        <div style="display:flex;gap:10px;margin-top:20px;">
                            <button onclick="closeInventory()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                            <button onclick="exportInventory()" style="flex:1;padding:12px;border:none;background:#3498db;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-download"></i> Export CSV</button>
                            <button onclick="resetInventory()" style="flex:1;padding:12px;border:none;background:#e74c3c;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-undo"></i> Reset to Default</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function renderInventoryRows(itemList) {
            return itemList.map(item => {
                const stockClass = item.stock <= 5 ? 'color:#e74c3c;font-weight:bold;' : item.stock <= 10 ? 'color:#f39c12;' : '';
                return `
                    <tr data-category="${item.category}" data-name="${item.name.toLowerCase()}">
                        <td style="padding:10px;border-bottom:1px solid #eee;">${item.name}</td>
                        <td style="padding:10px;border-bottom:1px solid #eee;text-align:center;">${item.category}</td>
                        <td style="padding:10px;border-bottom:1px solid #eee;text-align:center;${stockClass}">${item.stock}</td>
                        <td style="padding:10px;border-bottom:1px solid #eee;text-align:center;">
                            <button onclick="adjustStock(${item.id}, -1)" style="padding:5px 10px;border:none;background:#e74c3c;color:#fff;border-radius:4px;cursor:pointer;">-</button>
                            <button onclick="adjustStock(${item.id}, 1)" style="padding:5px 10px;border:none;background:#27ae60;color:#fff;border-radius:4px;cursor:pointer;margin-left:5px;">+</button>
                            <button onclick="setStock(${item.id})" style="padding:5px 10px;border:none;background:#3498db;color:#fff;border-radius:4px;cursor:pointer;margin-left:5px;">Set</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterInventory(query) {
            const category = document.getElementById('invCategory').value;
            const rows = document.querySelectorAll('#invBody tr');
            rows.forEach(row => {
                const name = row.dataset.name;
                const cat = row.dataset.category;
                const matchesSearch = !query || name.includes(query.toLowerCase());
                const matchesCategory = !category || cat === category;
                row.style.display = matchesSearch && matchesCategory ? '' : 'none';
            });
        }
        
        function adjustStock(itemId, delta) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.stock = Math.max(0, (item.stock || 0) + delta);
                saveInventory();
                // Update display
                const trackedItems = items.filter(i => i.trackInventory);
                document.getElementById('invBody').innerHTML = renderInventoryRows(trackedItems);
            }
        }
        
        function setStock(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            const newStock = prompt(`Set stock for ${item.name}:`, item.stock);
            if (newStock === null) return;
            const qty = parseInt(newStock);
            if (isNaN(qty) || qty < 0) return showToast('Invalid quantity', 'error');
            item.stock = qty;
            saveInventory();
            const trackedItems = items.filter(i => i.trackInventory);
            document.getElementById('invBody').innerHTML = renderInventoryRows(trackedItems);
            showToast(`${item.name} stock set to ${qty}`, 'success');
        }
        
        function closeInventory() {
            const modal = document.getElementById('inventoryModal');
            if (modal) modal.remove();
        }
        
        function exportInventory() {
            const trackedItems = items.filter(i => i.trackInventory);
            let csv = 'Item,Category,Stock,Price\n';
            trackedItems.forEach(i => {
                csv += `"${i.name}","${i.category}",${i.stock},${i.price}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Inventory exported', 'success');
        }
        
        function resetInventory() {
            if (!confirm('Reset all inventory to default levels? This cannot be undone.')) return;
            localStorage.removeItem('gc_inventory');
            items = [...defaultItems];
            closeInventory();
            showInventory();
            showToast('Inventory reset to defaults', 'success');
        }
        
        // ============ DATA IMPORT/EXPORT ============
        function showDataImportModal() {
            const html = `
                <div id="dataImportModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:800px;width:95%;max-height:90vh;overflow-y:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h3 style="margin:0;"><i class="fas fa-upload"></i> Import Data</h3>
                            <button onclick="closeDataImport()" style="border:none;background:none;font-size:20px;cursor:pointer;">×</button>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-bottom:20px;">
                            <div class="import-type-card" onclick="selectImportType('products')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-products">
                                <i class="fas fa-box" style="font-size:30px;color:#3498db;margin-bottom:10px;display:block;"></i>
                                <strong>Products</strong>
                                <div style="font-size:12px;color:#666;">Menu items, merchandise</div>
                            </div>
                            <div class="import-type-card" onclick="selectImportType('inventory')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-inventory">
                                <i class="fas fa-warehouse" style="font-size:30px;color:#27ae60;margin-bottom:10px;display:block;"></i>
                                <strong>Inventory</strong>
                                <div style="font-size:12px;color:#666;">Stock levels only</div>
                            </div>
                            <div class="import-type-card" onclick="selectImportType('transactions')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-transactions">
                                <i class="fas fa-receipt" style="font-size:30px;color:#9b59b6;margin-bottom:10px;display:block;"></i>
                                <strong>Transactions</strong>
                                <div style="font-size:12px;color:#666;">Historical sales</div>
                            </div>
                            <div class="import-type-card" onclick="selectImportType('customers')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-customers">
                                <i class="fas fa-users" style="font-size:30px;color:#e67e22;margin-bottom:10px;display:block;"></i>
                                <strong>Customers</strong>
                                <div style="font-size:12px;color:#666;">Customer list</div>
                            </div>
                        </div>
                        
                        <div id="importUploadArea" style="display:none;">
                            <div style="border:2px dashed #ccc;border-radius:10px;padding:40px;text-align:center;margin-bottom:15px;" 
                                 ondrop="handleFileDrop(event)" ondragover="event.preventDefault();this.style.borderColor='#27ae60'" ondragout="this.style.borderColor='#ccc'">
                                <i class="fas fa-cloud-upload-alt" style="font-size:40px;color:#ccc;margin-bottom:10px;"></i>
                                <div style="margin-bottom:10px;">Drag & drop CSV or JSON file here</div>
                                <input type="file" id="importFileInput" accept=".csv,.json" style="display:none;" onchange="handleFileSelect(event)">
                                <button onclick="document.getElementById('importFileInput').click()" style="padding:10px 20px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">
                                    <i class="fas fa-folder-open"></i> Choose File
                                </button>
                            </div>
                            
                            <div id="importFieldMapping" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                                <h4 style="margin:0 0 10px;">Field Mapping</h4>
                                <div id="fieldMappingContent"></div>
                            </div>
                            
                            <div id="importPreview" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;max-height:300px;overflow:auto;">
                                <h4 style="margin:0 0 10px;">Preview</h4>
                                <div id="previewContent"></div>
                            </div>
                            
                            <div style="display:flex;gap:10px;margin-bottom:15px;">
                                <label style="flex:1;display:flex;align-items:center;gap:5px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateAction" value="skip" checked> Skip duplicates
                                </label>
                                <label style="flex:1;display:flex;align-items:center;gap:5px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateAction" value="update"> Update existing
                                </label>
                                <label style="flex:1;display:flex;align-items:center;gap:5px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateAction" value="create"> Create all new
                                </label>
                            </div>
                        </div>
                        
                        <div id="importTemplates" style="display:none;background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;"><i class="fas fa-file-download"></i> Download Template</h4>
                            <button onclick="downloadTemplate()" style="padding:8px 15px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">
                                <i class="fas fa-download"></i> Download CSV Template
                            </button>
                            <span style="font-size:12px;color:#666;margin-left:10px;">Use this template to format your data correctly</span>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeDataImport()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button id="executeImportBtn" onclick="executeDataImport()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;display:none;">
                                <i class="fas fa-check"></i> Import Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        let selectedImportType = null;
        let pendingImportData = null;
        let detectedMapping = {};
        
        function selectImportType(type) {
            selectedImportType = type;
            document.querySelectorAll('.import-type-card').forEach(c => c.style.borderColor = '#ddd');
            document.getElementById('import-' + type).style.borderColor = '#27ae60';
            document.getElementById('importUploadArea').style.display = 'block';
            document.getElementById('importTemplates').style.display = 'block';
            document.getElementById('importFieldMapping').style.display = 'none';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('executeImportBtn').style.display = 'none';
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) processImportFile(file);
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processImportFile(file);
        }
        
        function processImportFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let data;
                if (file.name.endsWith('.json')) {
                    try {
                        data = JSON.parse(content);
                        if (!Array.isArray(data)) data = [data];
                    } catch (err) {
                        return showToast('Invalid JSON file', 'error');
                    }
                } else {
                    data = parseImportCSV(content);
                }
                
                if (!data || data.length === 0) {
                    return showToast('No data found in file', 'error');
                }
                
                pendingImportData = data;
                detectAndShowMapping(data);
            };
            reader.readAsText(file);
        }
        
        function parseImportCSV(content) {
            const lines = content.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = parseCSVLine(lines[0]);
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim().toLowerCase().replace(/\s+/g, '_')] = values[idx] || '';
                });
                rows.push(row);
            }
            return rows;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function detectAndShowMapping(data) {
            const sample = data[0];
            const keys = Object.keys(sample);
            
            // Expected fields by import type
            const expectedFields = {
                products: ['name', 'price', 'category', 'stock', 'sku', 'description'],
                inventory: ['name', 'sku', 'stock', 'min_stock', 'reorder_qty'],
                transactions: ['date', 'time', 'customer', 'amount', 'method', 'items', 'tax', 'discount'],
                customers: ['first_name', 'last_name', 'email', 'phone', 'member', 'member_type']
            };
            
            detectedMapping = {};
            const expected = expectedFields[selectedImportType] || [];
            
            // Auto-detect mappings
            expected.forEach(field => {
                const found = keys.find(k => {
                    const kLower = k.toLowerCase();
                    return kLower === field || 
                           kLower.includes(field) || 
                           field.includes(kLower) ||
                           kLower.replace(/_/g, '') === field.replace(/_/g, '');
                });
                if (found) detectedMapping[field] = found;
            });
            
            // Show mapping UI
            let mappingHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
            expected.forEach(field => {
                mappingHTML += `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <label style="min-width:100px;font-weight:600;">${field}:</label>
                        <select id="map_${field}" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px;">
                            <option value="">-- Skip --</option>
                            ${keys.map(k => `<option value="${k}" ${detectedMapping[field] === k ? 'selected' : ''}>${k}</option>`).join('')}
                        </select>
                    </div>
                `;
            });
            mappingHTML += '</div>';
            
            document.getElementById('fieldMappingContent').innerHTML = mappingHTML;
            document.getElementById('importFieldMapping').style.display = 'block';
            
            // Show preview
            showImportPreview(data.slice(0, 5));
            document.getElementById('executeImportBtn').style.display = 'block';
        }
        
        function showImportPreview(data) {
            if (!data.length) return;
            
            let html = `<div style="font-size:12px;color:#666;margin-bottom:5px;">Showing ${data.length} of ${pendingImportData.length} records</div>`;
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#e9ecef;">' + Object.keys(data[0]).map(k => `<th style="padding:5px;border:1px solid #ddd;">${k}</th>`).join('') + '</tr>';
            data.forEach(row => {
                html += '<tr>' + Object.values(row).map(v => `<td style="padding:5px;border:1px solid #ddd;">${String(v).substring(0, 30)}</td>`).join('') + '</tr>';
            });
            html += '</table>';
            
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('importPreview').style.display = 'block';
        }
        
        function executeDataImport() {
            if (!pendingImportData || !selectedImportType) {
                return showToast('No data to import', 'error');
            }
            
            const duplicateAction = document.querySelector('input[name="duplicateAction"]:checked').value;
            
            // Gather mapping
            const expectedFields = {
                products: ['name', 'price', 'category', 'stock', 'sku', 'description'],
                inventory: ['name', 'sku', 'stock', 'min_stock', 'reorder_qty'],
                transactions: ['date', 'time', 'customer', 'amount', 'method', 'items', 'tax', 'discount'],
                customers: ['first_name', 'last_name', 'email', 'phone', 'member', 'member_type']
            };
            
            const mapping = {};
            (expectedFields[selectedImportType] || []).forEach(field => {
                const sel = document.getElementById('map_' + field);
                if (sel && sel.value) mapping[field] = sel.value;
            });
            
            let imported = 0, skipped = 0, updated = 0;
            
            if (selectedImportType === 'products') {
                pendingImportData.forEach(row => {
                    const name = row[mapping.name] || '';
                    if (!name) return skipped++;
                    
                    const existing = items.findIndex(i => i.name.toLowerCase() === name.toLowerCase());
                    
                    if (existing >= 0) {
                        if (duplicateAction === 'skip') return skipped++;
                        if (duplicateAction === 'update') {
                            items[existing] = {
                                ...items[existing],
                                price: parseFloat(row[mapping.price]) || items[existing].price,
                                category: row[mapping.category] || items[existing].category,
                                stock: parseInt(row[mapping.stock]) || items[existing].stock,
                                sku: row[mapping.sku] || items[existing].sku
                            };
                            return updated++;
                        }
                    }
                    
                    items.push({
                        name: name,
                        price: parseFloat(row[mapping.price]) || 0,
                        category: row[mapping.category] || 'misc',
                        stock: parseInt(row[mapping.stock]) || 0,
                        trackInventory: true,
                        sku: row[mapping.sku] || ''
                    });
                    imported++;
                });
                saveInventory();
                renderInventoryRows(items);
            }
            
            else if (selectedImportType === 'inventory') {
                pendingImportData.forEach(row => {
                    const name = row[mapping.name] || row[mapping.sku] || '';
                    if (!name) return skipped++;
                    
                    const existing = items.findIndex(i => 
                        i.name.toLowerCase() === name.toLowerCase() ||
                        (i.sku && i.sku.toLowerCase() === name.toLowerCase())
                    );
                    
                    if (existing >= 0) {
                        items[existing].stock = parseInt(row[mapping.stock]) || 0;
                        updated++;
                    } else {
                        skipped++;
                    }
                });
                saveInventory();
            }
            
            else if (selectedImportType === 'transactions') {
                pendingImportData.forEach(row => {
                    const trans = {
                        id: 26763 + transactions.length + imported,
                        customer: row[mapping.customer] || 'Imported',
                        amount: parseFloat(row[mapping.amount]) || 0,
                        method: row[mapping.method] || 'cash',
                        time: row[mapping.time] || '12:00 PM',
                        date: row[mapping.date] || new Date().toISOString(),
                        imported: true,
                        importDate: new Date().toISOString(),
                        register: 'IMPORT'
                    };
                    
                    if (row[mapping.items]) {
                        try {
                            trans.itemList = JSON.parse(row[mapping.items]);
                        } catch (e) {
                            trans.itemList = row[mapping.items];
                        }
                    }
                    
                    transactions.push(trans);
                    imported++;
                });
                localStorage.setItem('gc_transactions', JSON.stringify(transactions));
                renderTransactions();
            }
            
            else if (selectedImportType === 'customers') {
                let customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                pendingImportData.forEach(row => {
                    const firstName = row[mapping.first_name] || '';
                    const lastName = row[mapping.last_name] || '';
                    const email = row[mapping.email] || '';
                    const phone = row[mapping.phone] || '';
                    
                    if (!firstName && !lastName && !email) return skipped++;
                    
                    const fullName = `${firstName} ${lastName}`.trim();
                    const existing = customers.findIndex(c => {
                        const cFullName = c.firstName ? `${c.firstName} ${c.lastName}` : c.name || '';
                        return cFullName.toLowerCase() === fullName.toLowerCase() ||
                            (email && c.email && c.email.toLowerCase() === email.toLowerCase());
                    });
                    
                    if (existing >= 0) {
                        if (duplicateAction === 'skip') return skipped++;
                        if (duplicateAction === 'update') {
                            customers[existing] = {
                                ...customers[existing],
                                firstName: firstName || customers[existing].firstName,
                                lastName: lastName || customers[existing].lastName,
                                email: email || customers[existing].email,
                                phone: phone || customers[existing].phone,
                                isMember: row[mapping.member] === 'true' || row[mapping.member] === '1' || customers[existing].isMember
                            };
                            return updated++;
                        }
                    }
                    
                    customers.push({
                        id: Date.now() + imported,
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        phone: phone,
                        isMember: row[mapping.member] === 'true' || row[mapping.member] === '1',
                        memberType: row[mapping.member_type] || null,
                        priceClass: 'Regular',
                        visitCount: 0,
                        totalSpent: 0,
                        passes: [],
                        imported: true,
                        importDate: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    });
                    imported++;
                });
                localStorage.setItem('gc_customers', JSON.stringify(customers));
            }
            
            // Log import to history
            const history = JSON.parse(localStorage.getItem('gc_import_history') || '[]');
            history.unshift({
                type: selectedImportType,
                date: new Date().toISOString(),
                imported: imported,
                skipped: skipped,
                updated: updated,
                total: pendingImportData.length
            });
            localStorage.setItem('gc_import_history', JSON.stringify(history.slice(0, 50)));
            
            closeDataImport();
            showToast(`Import complete: ${imported} added, ${updated} updated, ${skipped} skipped`, 'success');
        }
        
        function downloadTemplate() {
            const templates = {
                products: 'name,price,category,stock,sku,description\n"Hot Dog",4.50,"food",100,"HD001","Classic hot dog"\n"Draft Beer",6.00,"beer",50,"BER001","16oz draft"',
                inventory: 'name,sku,stock,min_stock,reorder_qty\n"Hot Dog","HD001",100,10,50\n"Draft Beer","BER001",50,20,30',
                transactions: 'date,time,customer,amount,method,items,tax,discount\n"2024-01-15","10:30 AM","John Doe",45.75,"card","[]",2.75,0',
                customers: 'first_name,last_name,email,phone,member,member_type\n"John","Doe","john@email.com","555-1234","true","Gold"\n"Jane","Smith","jane@email.com","555-5678","false",""'
            };
            
            const content = templates[selectedImportType] || '';
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedImportType}_template.csv`;
            a.click();
            showToast('Template downloaded', 'success');
        }
        
        function closeDataImport() {
            const modal = document.getElementById('dataImportModal');
            if (modal) modal.remove();
            pendingImportData = null;
            selectedImportType = null;
            detectedMapping = {};
        }
        
        function exportAllData() {
            const allData = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                products: items,
                transactions: transactions,
                customers: JSON.parse(localStorage.getItem('gc_customers') || '[]'),
                tabs: JSON.parse(localStorage.getItem('gc_tabs') || '[]'),
                bookings: JSON.parse(localStorage.getItem('gc_bookings') || '[]'),
                settings: {
                    stripePK: localStorage.getItem('gc_stripe_pk'),
                    stripeLocation: localStorage.getItem('gc_stripe_location'),
                    registerId: localStorage.getItem('gc_register_id')
                }
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `golf_cove_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('All data exported', 'success');
        }
        
        function backupToJSON() {
            exportAllData();
        }
        
        function restoreFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const data = JSON.parse(evt.target.result);
                        
                        if (!confirm(`This will restore data from ${data.exportDate || 'backup'}. Current data will be replaced. Continue?`)) return;
                        
                        if (data.products) {
                            items = data.products;
                            saveInventory();
                            renderInventoryRows(items);
                        }
                        if (data.transactions) {
                            transactions = data.transactions;
                            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
                            renderTransactions();
                        }
                        if (data.customers) {
                            localStorage.setItem('gc_customers', JSON.stringify(data.customers));
                        }
                        if (data.tabs) {
                            localStorage.setItem('gc_tabs', JSON.stringify(data.tabs));
                        }
                        if (data.bookings) {
                            localStorage.setItem('gc_bookings', JSON.stringify(data.bookings));
                        }
                        if (data.settings) {
                            if (data.settings.stripePK) localStorage.setItem('gc_stripe_pk', data.settings.stripePK);
                            if (data.settings.stripeLocation) localStorage.setItem('gc_stripe_location', data.settings.stripeLocation);
                            if (data.settings.registerId) localStorage.setItem('gc_register_id', data.settings.registerId);
                        }
                        
                        showToast('Data restored successfully', 'success');
                    } catch (err) {
                        showToast('Invalid backup file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ============ HELPER FUNCTIONS ============
        function showGenericModal(title, content, id) {
            const html = `
                <div id="${id}" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="hideGenericModal('${id}')">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 15px;">${title}</h3>
                        ${content}
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function hideGenericModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }
        
        // Last receipt reprint
        let lastReceiptData = null;
        
        function reprintLastReceipt() {
            if (!lastReceiptData) return showToast('No receipt to reprint', 'error');
            printReceipt(lastReceiptData.customer, lastReceiptData.total, lastReceiptData.method, lastReceiptData.items);
        }
        
        // Initialize Stripe on load (if configured)
        if (STRIPE_CONFIG.publishableKey) {
            initStripeTerminal();
        }
        
        // Check low stock on load
        checkLowStock();
        const lowStockItems = items.filter(i => i.trackInventory && i.stock !== undefined && i.stock <= 5);
        if (lowStockItems.length > 0) {
            setTimeout(() => showToast(`⚠️ ${lowStockItems.length} item(s) low on stock`, 'warning'), 2000);
        }
        
        // Show keyboard shortcuts hint on load
        setTimeout(() => {
            showToast('F1: Help | F2: Search | F7: Split Pay | F8: Cash | F9: Card | F10: Settings', 'success');
        }, 1000);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F1') { e.preventDefault(); showKeyboardHelp(); }
            if (e.key === 'F2') { e.preventDefault(); document.getElementById('itemSearch').focus(); }
            if (e.key === 'F7') { e.preventDefault(); showSplitPaymentModal(); }
            if (e.key === 'F8') { e.preventDefault(); processPayment('cash'); }
            if (e.key === 'F9') { e.preventDefault(); processPayment('card'); }
            if (e.key === 'F10') { e.preventDefault(); showSettings(); }
            if (e.key === 'F12') { e.preventDefault(); showEndOfDayReport(); }
            if (e.key === 'Escape') { closeAllModals(); }
        });
        
        function closeAllModals() {
            ['itemsModal', 'settingsModal', 'inventoryModal', 'dataImportModal', 'cashModal', 'manualCardModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal) modal.classList.remove('active') || modal.remove();
            });
        }
        
        function showKeyboardHelp() {
            const html = `
                <div id="helpModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:90%;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                        <table style="width:100%;border-collapse:collapse;">
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F1</kbd></td><td>Show this help</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F2</kbd></td><td>Search items</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F7</kbd></td><td>Split payment</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F8</kbd></td><td>Pay with cash</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F9</kbd></td><td>Pay with card</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F10</kbd></td><td>Settings</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F12</kbd></td><td>End of day report</td></tr>
                            <tr><td style="padding:8px;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">Esc</kbd></td><td>Close modals</td></tr>
                        </table>
                        <button onclick="this.parentElement.parentElement.remove()" style="width:100%;margin-top:15px;padding:12px;background:#4a90a4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        // ============ SPLIT PAYMENT ============
        function showSplitPaymentModal() {
            if (saleItems.length === 0) return showToast('No items in sale', 'error');
            
            const subtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty * (1 - item.discount / 100)), 0);
            const total = subtotal * 1.0635;
            const customer = document.getElementById('customerName').value || 'Walk-in';
            
            const html = `
                <div id="splitPayModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:95%;">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-divide"></i> Split Payment</h3>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;">
                            <div style="font-size:24px;font-weight:700;">$${total.toFixed(2)}</div>
                            <div style="color:#666;">${customer}</div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Card Amount:</label>
                            <input type="number" id="splitCardAmt" step="0.01" min="0" max="${total.toFixed(2)}" value="${(total/2).toFixed(2)}" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;" onkeyup="updateSplitCash()">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Cash Amount:</label>
                            <input type="number" id="splitCashAmt" step="0.01" min="0" value="${(total/2).toFixed(2)}" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;background:#f8f9fa;" readonly>
                        </div>
                        
                        <div style="display:flex;gap:10px;margin-bottom:15px;">
                            <button onclick="setSplitRatio(0.5)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;">50/50</button>
                            <button onclick="setSplitRatio(0.25)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;">25/75</button>
                            <button onclick="setSplitRatio(0.75)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;">75/25</button>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeSplitPayModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="processSplitPayment()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Process Split</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            window.splitPaymentTotal = total;
            window.splitPaymentCustomer = customer;
        }
        
        function updateSplitCash() {
            const cardAmt = parseFloat(document.getElementById('splitCardAmt').value) || 0;
            const cashAmt = Math.max(0, window.splitPaymentTotal - cardAmt);
            document.getElementById('splitCashAmt').value = cashAmt.toFixed(2);
        }
        
        function setSplitRatio(cardRatio) {
            const cardAmt = window.splitPaymentTotal * cardRatio;
            document.getElementById('splitCardAmt').value = cardAmt.toFixed(2);
            updateSplitCash();
        }
        
        function closeSplitPayModal() {
            const modal = document.getElementById('splitPayModal');
            if (modal) modal.remove();
        }
        
        function processSplitPayment() {
            const cardAmt = parseFloat(document.getElementById('splitCardAmt').value) || 0;
            const cashAmt = parseFloat(document.getElementById('splitCashAmt').value) || 0;
            
            if (Math.abs((cardAmt + cashAmt) - window.splitPaymentTotal) > 0.01) {
                return showToast('Split amounts must equal total', 'error');
            }
            
            closeSplitPayModal();
            
            // Process as split payment
            const now = new Date();
            const transaction = {
                id: 26763 + transactions.length,
                customer: window.splitPaymentCustomer,
                amount: window.splitPaymentTotal,
                method: 'split',
                splitDetails: { card: cardAmt, cash: cashAmt },
                time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: now.toISOString(),
                itemCount: saleItems.length,
                itemDetails: saleItems.map(i => ({ name: i.name, qty: i.qty, price: i.price, discount: i.discount })),
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            };
            
            transactions.unshift(transaction);
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            
            if (!isReturnMode) deductInventory(saleItems);
            updateDailySales(cardAmt, 'card');
            updateDailySales(cashAmt, 'cash');
            
            showToast(`Split payment: $${cardAmt.toFixed(2)} card + $${cashAmt.toFixed(2)} cash`, 'success');
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderTransactions();
        }
        
        // ============ END OF DAY REPORT ============
        function showEndOfDayReport() {
            const today = new Date().toDateString();
            const todaysTrans = transactions.filter(t => new Date(t.date).toDateString() === today);
            
            const sales = todaysTrans.filter(t => !t.isReturn);
            const returns = todaysTrans.filter(t => t.isReturn);
            
            const totalSales = sales.reduce((sum, t) => sum + t.amount, 0);
            const totalReturns = returns.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netSales = totalSales - totalReturns;
            
            const cashSales = sales.filter(t => t.method === 'cash').reduce((sum, t) => sum + t.amount, 0);
            const cardSales = sales.filter(t => t.method === 'card').reduce((sum, t) => sum + t.amount, 0);
            const splitSales = sales.filter(t => t.method === 'split').reduce((sum, t) => sum + t.amount, 0);
            
            const html = `
                <div id="eodModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:600px;width:95%;max-height:90vh;overflow-y:auto;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-chart-bar"></i> End of Day Report</h3>
                        <div style="text-align:center;color:#666;margin-bottom:20px;">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        
                        <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:20px;">
                            <div style="background:#e8f5e9;padding:20px;border-radius:10px;text-align:center;">
                                <div style="font-size:28px;font-weight:700;color:#27ae60;">$${totalSales.toFixed(2)}</div>
                                <div style="font-size:12px;color:#666;">Gross Sales</div>
                            </div>
                            <div style="background:#ffebee;padding:20px;border-radius:10px;text-align:center;">
                                <div style="font-size:28px;font-weight:700;color:#e74c3c;">-$${totalReturns.toFixed(2)}</div>
                                <div style="font-size:12px;color:#666;">Returns</div>
                            </div>
                            <div style="background:#e3f2fd;padding:20px;border-radius:10px;text-align:center;">
                                <div style="font-size:28px;font-weight:700;color:#3498db;">$${netSales.toFixed(2)}</div>
                                <div style="font-size:12px;color:#666;">Net Sales</div>
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <h4 style="margin:0 0 15px;"><i class="fas fa-money-bill-wave"></i> Payment Breakdown</h4>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Cash:</span><strong>$${cashSales.toFixed(2)}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Card:</span><strong>$${cardSales.toFixed(2)}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;"><span>Split:</span><strong>$${splitSales.toFixed(2)}</strong></div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <h4 style="margin:0 0 15px;"><i class="fas fa-receipt"></i> Transaction Summary</h4>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Total Transactions:</span><strong>${todaysTrans.length}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Sales:</span><strong>${sales.length}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;"><span>Returns:</span><strong>${returns.length}</strong></div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="printEODReport()" style="flex:1;padding:12px;border:none;background:#3498db;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Print</button>
                            <button onclick="exportEODReport()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-download"></i> Export</button>
                            <button onclick="this.closest('#eodModal').remove()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function printEODReport() {
            window.print();
        }
        
        function exportEODReport() {
            const today = new Date().toDateString();
            const todaysTrans = transactions.filter(t => new Date(t.date).toDateString() === today);
            
            let csv = 'Transaction ID,Time,Customer,Amount,Method,Items\n';
            todaysTrans.forEach(t => {
                csv += `${t.id},"${t.time}","${t.customer}",${t.amount.toFixed(2)},${t.method},${t.itemCount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eod_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Report exported', 'success');
        }
        
        // ============ GIFT CARD SYSTEM ============
        function redeemGiftCard() {
            const html = `
                <div id="giftCardModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:450px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#9b59b6;"><i class="fas fa-gift"></i> Redeem Gift Card</h3>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Gift Card Number:</label>
                            <input type="text" id="giftCardNumber" placeholder="Enter or scan gift card" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:16px;font-family:monospace;" autofocus>
                        </div>
                        
                        <div id="giftCardInfo" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                <span>Balance:</span>
                                <strong id="gcBalance" style="color:#27ae60;">$0.00</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;">
                                <span>Issued:</span>
                                <span id="gcIssued">-</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Amount to Redeem:</label>
                            <input type="number" id="redeemAmount" step="0.01" min="0" placeholder="0.00" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;">
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeGiftCardModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="lookupGiftCard()" style="flex:1;padding:12px;border:none;background:#3498db;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-search"></i> Lookup</button>
                            <button onclick="applyGiftCard()" style="flex:1;padding:12px;border:none;background:#9b59b6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Redeem</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeGiftCardModal() {
            const modal = document.getElementById('giftCardModal');
            if (modal) modal.remove();
        }
        
        function lookupGiftCard() {
            const cardNum = document.getElementById('giftCardNumber').value.trim();
            if (!cardNum) return showToast('Enter gift card number', 'error');
            
            // Load gift cards from storage
            const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '{}');
            const card = giftCards[cardNum];
            
            if (!card) {
                showToast('Gift card not found', 'error');
                document.getElementById('giftCardInfo').style.display = 'none';
                return;
            }
            
            document.getElementById('gcBalance').textContent = '$' + card.balance.toFixed(2);
            document.getElementById('gcIssued').textContent = new Date(card.issued).toLocaleDateString();
            document.getElementById('giftCardInfo').style.display = 'block';
            document.getElementById('redeemAmount').max = card.balance;
        }
        
        function applyGiftCard() {
            const cardNum = document.getElementById('giftCardNumber').value.trim();
            const amount = parseFloat(document.getElementById('redeemAmount').value) || 0;
            
            if (!cardNum || amount <= 0) return showToast('Enter card number and amount', 'error');
            
            const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '{}');
            const card = giftCards[cardNum];
            
            if (!card) return showToast('Gift card not found', 'error');
            if (amount > card.balance) return showToast('Amount exceeds balance', 'error');
            
            // Apply as payment/discount
            card.balance -= amount;
            card.redemptions = card.redemptions || [];
            card.redemptions.push({
                amount: amount,
                date: new Date().toISOString(),
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            });
            
            giftCards[cardNum] = card;
            localStorage.setItem('gc_gift_cards', JSON.stringify(giftCards));
            
            closeGiftCardModal();
            showToast(`Gift card redeemed: $${amount.toFixed(2)} (Remaining: $${card.balance.toFixed(2)})`, 'success');
            
            // Add as negative line item to reduce total
            saleItems.push({
                name: `Gift Card Redemption (${cardNum.slice(-4)})`,
                price: -amount,
                qty: 1,
                discount: 0,
                isGiftCard: true
            });
            renderSaleItems();
        }
        
        // Generate gift card when sold
        function generateGiftCard(amount) {
            const cardNum = 'GC' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '{}');
            
            giftCards[cardNum] = {
                balance: amount,
                originalAmount: amount,
                issued: new Date().toISOString(),
                redemptions: []
            };
            
            localStorage.setItem('gc_gift_cards', JSON.stringify(giftCards));
            
            // Show the card number
            showToast(`Gift Card Created: ${cardNum}`, 'success');
            
            // Print gift card receipt
            if (confirm('Print gift card?')) {
                printGiftCard(cardNum, amount);
            }
            
            return cardNum;
        }
        
        function printGiftCard(cardNum, amount) {
            const w = window.open('', '_blank', 'width=350,height=400');
            var html = '<html><head><title>Gift Card</title><style>';
            html += 'body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }';
            html += '.card { border: 2px solid #9b59b6; border-radius: 12px; padding: 30px; max-width: 280px; margin: 0 auto; }';
            html += '.logo { font-size: 24px; font-weight: bold; color: #4a90a4; margin-bottom: 10px; }';
            html += '.amount { font-size: 36px; font-weight: bold; color: #27ae60; margin: 20px 0; }';
            html += '.number { font-family: monospace; font-size: 18px; background: #f8f9fa; padding: 10px; border-radius: 6px; letter-spacing: 2px; }';
            html += '.footer { margin-top: 20px; font-size: 12px; color: #666; }';
            html += '</style></head><bo' + 'dy>';
            html += '<div class="card">';
            html += '<div class="logo">⛳ GOLF COVE</div>';
            html += '<div style="color:#9b59b6;font-size:14px;">GIFT CARD</div>';
            html += '<div class="amount">$' + amount.toFixed(2) + '</div>';
            html += '<div class="number">' + cardNum + '</div>';
            html += '<div class="footer">Present this card at checkout<br>No expiration</div>';
            html += '</div></bo' + 'dy></ht' + 'ml>';
            w.document.write(html);
            w.document.close();
            w.print();
        }
        
        // ============ QUICK ACTIONS ============
        function issueRaincheck() {
            const customer = prompt('Customer name for raincheck:');
            if (!customer) return;
            
            const reason = prompt('Reason for raincheck:');
            const value = prompt('Value of raincheck ($):');
            
            if (!value || isNaN(parseFloat(value))) return showToast('Invalid value', 'error');
            
            const rainchecks = JSON.parse(localStorage.getItem('gc_rainchecks') || '[]');
            const raincheck = {
                id: 'RC' + Date.now().toString(36).toUpperCase(),
                customer: customer,
                reason: reason || 'Weather',
                value: parseFloat(value),
                issued: new Date().toISOString(),
                redeemed: false,
                issuedBy: 'Staff'
            };
            
            rainchecks.push(raincheck);
            localStorage.setItem('gc_rainchecks', JSON.stringify(rainchecks));
            
            showToast(`Raincheck ${raincheck.id} issued for $${raincheck.value.toFixed(2)}`, 'success');
            
            if (confirm('Print raincheck?')) {
                const w = window.open('', '_blank', 'width=350,height=400');
                var html = '<html><head><title>Raincheck</title><style>';
                html += 'body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }';
                html += '.card { border: 2px dashed #3498db; border-radius: 12px; padding: 30px; max-width: 280px; margin: 0 auto; }';
                html += '.amount { font-size: 32px; font-weight: bold; color: #3498db; margin: 15px 0; }';
                html += '</style></head><bo' + 'dy>';
                html += '<div class="card">';
                html += '<div style="font-size:24px;font-weight:bold;color:#4a90a4;">⛳ GOLF COVE</div>';
                html += '<div style="color:#e74c3c;font-size:16px;margin:10px 0;">RAINCHECK</div>';
                html += '<div class="amount">$' + raincheck.value.toFixed(2) + '</div>';
                html += '<div style="font-family:monospace;font-size:14px;">' + raincheck.id + '</div>';
                html += '<div style="margin-top:15px;font-size:13px;">';
                html += '<strong>' + customer + '</strong><br>';
                html += (reason || 'Weather') + '<br>';
                html += new Date().toLocaleDateString();
                html += '</div>';
                html += '<div style="margin-top:15px;font-size:11px;color:#666;">Valid for 90 days</div>';
                html += '</div></bo' + 'dy></ht' + 'ml>';
                w.document.write(html);
                w.document.close();
                w.print();
            }
        }
        
        // ============ LOYALTY POINTS SYSTEM ============
        function showLoyaltyModal() {
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const currentName = document.getElementById('customerName').value;
            
            // Find customer
            let customer = customers.find(c => 
                `${c.firstName} ${c.lastName}`.toLowerCase() === currentName.toLowerCase()
            );
            
            if (!customer && currentName) {
                showToast('Customer not found in system', 'warning');
            }
            
            const points = customer?.loyaltyPoints || 0;
            const pointsValue = (points / 100).toFixed(2); // 100 points = $1
            
            const html = `
                <div id="loyaltyModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:450px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#9b59b6;"><i class="fas fa-star"></i> Loyalty Points</h3>
                        
                        ${customer ? `
                            <div style="background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;padding:20px;border-radius:10px;margin-bottom:20px;text-align:center;">
                                <div style="font-size:14px;opacity:0.9;">${customer.firstName} ${customer.lastName}</div>
                                <div style="font-size:36px;font-weight:700;margin:10px 0;">${points.toLocaleString()}</div>
                                <div style="font-size:13px;">points = $${pointsValue} value</div>
                            </div>
                            
                            <div style="margin-bottom:15px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;">Redeem Points:</label>
                                <div style="display:flex;gap:10px;">
                                    <input type="number" id="redeemPoints" max="${points}" placeholder="0" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    <button onclick="redeemLoyaltyPoints(${customer.id})" style="background:#9b59b6;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;">Redeem</button>
                                </div>
                                <div style="font-size:12px;color:#666;margin-top:5px;">100 points = $1.00 off</div>
                            </div>
                            
                            <div style="margin-bottom:15px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;">Add Points Manually:</label>
                                <div style="display:flex;gap:10px;">
                                    <input type="number" id="addPoints" placeholder="0" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    <button onclick="addLoyaltyPoints(${customer.id})" style="background:#27ae60;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;">Add</button>
                                </div>
                            </div>
                        ` : `
                            <div style="text-align:center;padding:30px;color:#666;">
                                <i class="fas fa-user-slash" style="font-size:48px;color:#ddd;margin-bottom:15px;"></i>
                                <p>Select a customer to view/redeem loyalty points</p>
                            </div>
                        `}
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <div style="font-size:13px;color:#666;margin-bottom:10px;"><strong>How Points Work:</strong></div>
                            <ul style="font-size:12px;color:#666;margin:0;padding-left:20px;">
                                <li>Earn 1 point per $1 spent</li>
                                <li>Members earn 2x points</li>
                                <li>100 points = $1.00 redemption value</li>
                                <li>Points never expire</li>
                            </ul>
                        </div>
                        
                        <button onclick="closeLoyaltyModal()" style="width:100%;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeLoyaltyModal() {
            const modal = document.getElementById('loyaltyModal');
            if (modal) modal.remove();
        }
        
        function redeemLoyaltyPoints(customerId) {
            const points = parseInt(document.getElementById('redeemPoints').value) || 0;
            if (points <= 0) return showToast('Enter points to redeem', 'error');
            
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) return showToast('Customer not found', 'error');
            if (points > (customer.loyaltyPoints || 0)) return showToast('Insufficient points', 'error');
            
            const dollarValue = points / 100;
            
            customer.loyaltyPoints -= points;
            localStorage.setItem('gc_customers', JSON.stringify(customers));
            
            // Add discount to cart
            saleItems.push({
                name: `Loyalty Points Redemption (${points} pts)`,
                price: -dollarValue,
                qty: 1,
                discount: 0,
                isLoyalty: true
            });
            renderSaleItems();
            
            closeLoyaltyModal();
            showToast(`Redeemed ${points} points for $${dollarValue.toFixed(2)} off!`, 'success');
        }
        
        function addLoyaltyPoints(customerId) {
            const points = parseInt(document.getElementById('addPoints').value) || 0;
            if (points <= 0) return showToast('Enter points to add', 'error');
            
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = customers.find(c => c.id === customerId);
            
            if (!customer) return showToast('Customer not found', 'error');
            
            customer.loyaltyPoints = (customer.loyaltyPoints || 0) + points;
            localStorage.setItem('gc_customers', JSON.stringify(customers));
            
            closeLoyaltyModal();
            showLoyaltyModal();
            showToast(`Added ${points} loyalty points`, 'success');
        }
        
        // Auto-award points on completed sales
        function awardLoyaltyPoints(customerName, total) {
            if (!customerName || customerName === 'Walk-in') return;
            
            const customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
            const customer = customers.find(c => 
                `${c.firstName} ${c.lastName}`.toLowerCase() === customerName.toLowerCase()
            );
            
            if (customer) {
                const basePoints = Math.floor(total);
                const multiplier = customer.isMember ? 2 : 1;
                const earnedPoints = basePoints * multiplier;
                
                customer.loyaltyPoints = (customer.loyaltyPoints || 0) + earnedPoints;
                localStorage.setItem('gc_customers', JSON.stringify(customers));
                
                console.log(`Awarded ${earnedPoints} loyalty points to ${customerName}`);
            }
        }
        
        // ============ CASH DRAWER MANAGEMENT ============
        function showDrawerManagement() {
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            const todayDrawer = drawer[today] || { openingAmount: 0, currentAmount: 0, opened: false };
            
            const html = `
                <div id="drawerModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:450px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#27ae60;"><i class="fas fa-cash-register"></i> Cash Drawer</h3>
                        
                        ${!todayDrawer.opened ? `
                            <div style="background:#e8f5e9;padding:20px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-size:14px;font-weight:600;margin-bottom:15px;">Open Drawer</div>
                                <div style="margin-bottom:15px;">
                                    <label style="display:block;margin-bottom:5px;">Starting Cash Amount:</label>
                                    <input type="number" id="openingCash" step="0.01" value="200.00" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;">
                                </div>
                                <button onclick="openDrawer()" style="width:100%;padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-lock-open"></i> Open Drawer</button>
                            </div>
                        ` : `
                            <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Opening Amount:</span>
                                    <strong>$${todayDrawer.openingAmount.toFixed(2)}</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Cash Sales Today:</span>
                                    <strong style="color:#27ae60;">+$${(todayDrawer.cashIn || 0).toFixed(2)}</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Cash Returns:</span>
                                    <strong style="color:#e74c3c;">-$${(todayDrawer.cashOut || 0).toFixed(2)}</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Pay-ins/Pay-outs:</span>
                                    <span>$${((todayDrawer.payIns || 0) - (todayDrawer.payOuts || 0)).toFixed(2)}</span>
                                </div>
                                <hr style="border:none;border-top:1px solid #ddd;margin:15px 0;">
                                <div style="display:flex;justify-content:space-between;font-size:18px;">
                                    <span>Expected in Drawer:</span>
                                    <strong style="color:#2c3e50;">$${(todayDrawer.openingAmount + (todayDrawer.cashIn || 0) - (todayDrawer.cashOut || 0) + (todayDrawer.payIns || 0) - (todayDrawer.payOuts || 0)).toFixed(2)}</strong>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
                                <button onclick="showPayInOut('in')" style="padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-plus"></i> Pay In</button>
                                <button onclick="showPayInOut('out')" style="padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-minus"></i> Pay Out</button>
                            </div>
                            
                            <button onclick="closeDrawer()" style="width:100%;padding:12px;background:#e67e22;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-bottom:10px;"><i class="fas fa-lock"></i> Close & Count Drawer</button>
                        `}
                        
                        <button onclick="closeDrawerModal()" style="width:100%;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeDrawerModal() {
            const modal = document.getElementById('drawerModal');
            if (modal) modal.remove();
        }
        
        function openDrawer() {
            const amount = parseFloat(document.getElementById('openingCash').value) || 0;
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            
            drawer[today] = {
                opened: true,
                openingAmount: amount,
                cashIn: 0,
                cashOut: 0,
                payIns: 0,
                payOuts: 0,
                openedAt: new Date().toISOString(),
                openedBy: 'Staff'
            };
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
            closeDrawerModal();
            showToast('Drawer opened', 'success');
            showDrawerManagement();
        }
        
        function showPayInOut(type) {
            const amount = prompt(`Enter ${type === 'in' ? 'Pay In' : 'Pay Out'} amount:`);
            if (!amount || isNaN(parseFloat(amount))) return;
            
            const reason = prompt('Reason:') || 'No reason provided';
            
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            
            if (!drawer[today]) return showToast('Drawer not open', 'error');
            
            if (type === 'in') {
                drawer[today].payIns = (drawer[today].payIns || 0) + parseFloat(amount);
            } else {
                drawer[today].payOuts = (drawer[today].payOuts || 0) + parseFloat(amount);
            }
            
            // Log the transaction
            if (!drawer[today].log) drawer[today].log = [];
            drawer[today].log.push({
                type: type === 'in' ? 'Pay In' : 'Pay Out',
                amount: parseFloat(amount),
                reason: reason,
                time: new Date().toISOString()
            });
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
            closeDrawerModal();
            showDrawerManagement();
            showToast(`${type === 'in' ? 'Pay In' : 'Pay Out'} recorded`, 'success');
        }
        
        function closeDrawer() {
            const counted = prompt('Enter actual cash counted in drawer:');
            if (!counted || isNaN(parseFloat(counted))) return;
            
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            const todayDrawer = drawer[today];
            
            if (!todayDrawer) return showToast('Drawer not open', 'error');
            
            const expected = todayDrawer.openingAmount + (todayDrawer.cashIn || 0) - (todayDrawer.cashOut || 0) + (todayDrawer.payIns || 0) - (todayDrawer.payOuts || 0);
            const countedAmount = parseFloat(counted);
            const variance = countedAmount - expected;
            
            todayDrawer.closedAt = new Date().toISOString();
            todayDrawer.countedAmount = countedAmount;
            todayDrawer.expectedAmount = expected;
            todayDrawer.variance = variance;
            todayDrawer.closed = true;
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
            
            closeDrawerModal();
            
            // Show summary
            alert(`DRAWER CLOSED\n\nExpected: $${expected.toFixed(2)}\nCounted: $${countedAmount.toFixed(2)}\nVariance: $${variance.toFixed(2)} ${variance < 0 ? '(SHORT)' : variance > 0 ? '(OVER)' : '(BALANCED)'}`);
            
            showToast('Drawer closed', 'success');
        }
        
        // ============ TRANSACTION LOOKUP ============
        function showTransactionLookup() {
            const html = `
                <div id="transLookupModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:600px;width:95%;max-height:80vh;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h3 style="margin:0;color:#3498db;"><i class="fas fa-search"></i> Transaction Lookup</h3>
                            <button onclick="closeTransLookup()" style="background:none;border:none;font-size:20px;cursor:pointer;">&times;</button>
                        </div>
                        
                        <div style="display:flex;gap:10px;margin-bottom:20px;">
                            <input type="text" id="transSearchInput" placeholder="Search by ID, customer, or amount..." style="flex:1;padding:12px;border:1px solid #ddd;border-radius:6px;" onkeyup="searchTransactions()">
                            <select id="transDateFilter" onchange="searchTransactions()" style="padding:12px;border:1px solid #ddd;border-radius:6px;">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        
                        <div id="transSearchResults" style="max-height:400px;overflow:auto;">
                            <p style="color:#666;text-align:center;">Enter search term</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            searchTransactions(); // Show today's transactions by default
        }
        
        function closeTransLookup() {
            const modal = document.getElementById('transLookupModal');
            if (modal) modal.remove();
        }
        
        function searchTransactions() {
            const query = document.getElementById('transSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('transDateFilter').value;
            
            const now = new Date();
            let filtered = transactions.filter(t => {
                const tDate = new Date(t.date);
                
                switch(dateFilter) {
                    case 'today':
                        if (tDate.toDateString() !== now.toDateString()) return false;
                        break;
                    case 'week':
                        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        if (tDate < weekAgo) return false;
                        break;
                    case 'month':
                        if (tDate.getMonth() !== now.getMonth() || tDate.getFullYear() !== now.getFullYear()) return false;
                        break;
                }
                
                if (query) {
                    return t.id.toString().includes(query) || 
                           t.customer.toLowerCase().includes(query) ||
                           t.amount.toFixed(2).includes(query);
                }
                return true;
            });
            
            const results = document.getElementById('transSearchResults');
            
            if (filtered.length === 0) {
                results.innerHTML = '<p style="color:#666;text-align:center;">No transactions found</p>';
                return;
            }
            
            results.innerHTML = filtered.slice(0, 50).map(t => `
                <div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee;cursor:pointer;" onclick="selectTransaction(${t.id})">
                    <div style="flex:1;">
                        <div style="font-weight:600;">#${t.id} - ${t.customer}</div>
                        <div style="font-size:12px;color:#666;">${new Date(t.date).toLocaleDateString()} ${t.time} | ${t.method} | ${t.itemCount} items</div>
                    </div>
                    <div style="font-weight:700;${t.isReturn ? 'color:#e74c3c;' : 'color:#27ae60;'}">
                        ${t.isReturn ? '-' : ''}$${Math.abs(t.amount).toFixed(2)}
                    </div>
                    <button onclick="event.stopPropagation();processRefund(${t.id})" style="margin-left:10px;background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;" ${t.isReturn ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>Refund</button>
                </div>
            `).join('');
        }
        
        function selectTransaction(id) {
            const t = transactions.find(tr => tr.id === id);
            if (!t) return;
            
            closeTransLookup();
            
            // Show transaction details
            const html = `
                <div id="transDetailModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#3498db;">Transaction #${t.id}</h3>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>Customer:</span><strong>${t.customer}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>Date:</span><span>${new Date(t.date).toLocaleDateString()} ${t.time}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>Method:</span><span>${t.method.toUpperCase()}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:700;margin-top:10px;padding-top:10px;border-top:1px solid #ddd;">
                                <span>Total:</span><span style="${t.isReturn ? 'color:#e74c3c;' : 'color:#27ae60;'}">${t.isReturn ? '-' : ''}$${Math.abs(t.amount).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <strong>Items:</strong>
                            <div style="max-height:150px;overflow:auto;margin-top:8px;">
                                ${t.itemDetails ? t.itemDetails.map(item => `
                                    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #eee;font-size:13px;">
                                        <span>${item.name} x${item.qty}</span>
                                        <span>$${(item.price * item.qty).toFixed(2)}</span>
                                    </div>
                                `).join('') : '<p style="color:#666;">Item details not available</p>'}
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="this.closest('#transDetailModal').remove()" style="flex:1;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                            <button onclick="reprintReceipt(${t.id})" style="flex:1;padding:12px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Reprint</button>
                            ${!t.isReturn ? `<button onclick="processRefund(${t.id})" style="flex:1;padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-undo"></i> Refund</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function processRefund(transId) {
            const t = transactions.find(tr => tr.id === transId);
            if (!t || t.isReturn) return;
            
            if (!confirm(`Process full refund of $${t.amount.toFixed(2)} for ${t.customer}?`)) return;
            
            // Close any open modals
            document.querySelectorAll('#transDetailModal, #transLookupModal').forEach(m => m.remove());
            
            // Create refund transaction
            const refund = {
                id: 26763 + transactions.length,
                customer: t.customer,
                amount: -t.amount,
                subtotal: -t.subtotal,
                tax: -t.tax,
                method: t.method,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: new Date().toISOString(),
                itemCount: t.itemCount,
                itemDetails: t.itemDetails,
                isReturn: true,
                originalTransactionId: t.id,
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            };
            
            transactions.unshift(refund);
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            
            // Update daily sales
            const dailySales = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            const today = new Date().toDateString();
            if (dailySales[today]) {
                dailySales[today].total -= t.amount;
                dailySales[today][t.method] = (dailySales[today][t.method] || 0) - t.amount;
            }
            localStorage.setItem('gc_daily_sales', JSON.stringify(dailySales));
            
            // Mark original as refunded
            t.refunded = true;
            t.refundedAt = new Date().toISOString();
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
            
            renderTransactions();
            showToast(`Refund of $${t.amount.toFixed(2)} processed`, 'success');
            
            if (confirm('Print refund receipt?')) {
                printReceipt(t.customer, t.amount, t.method + ' REFUND', t.itemDetails || [], refund.id);
            }
        }
        
        function reprintReceipt(transId) {
            const t = transactions.find(tr => tr.id === transId);
            if (!t) return;
            
            printReceipt(t.customer, Math.abs(t.amount), t.method + (t.isReturn ? ' REFUND' : ''), t.itemDetails || [], t.id);
        }
    </script>
</body>
</html>