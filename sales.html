<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Golf Cove - Sales</title>
    <link rel="icon" type="image/png" href="images/golfCoveLogo6.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://js.stripe.com/terminal/v1/"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <!-- Unified Config & Core -->
    <script src="js/config-unified.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/core.js"></script>
    <script src="js/services-unified.js"></script>
    <script src="js/menu-data.js"></script>
    <!-- Feature Modules -->
    <script src="js/firebase-sync.js"></script>
    <script src="js/pin-system.js"></script>
    <script src="js/membership-system.js"></script>
    <script src="js/validation-schemas.js"></script>
    <script src="js/customer-manager.js"></script>
    <script src="js/tabs-sync.js"></script>
    <script src="js/cash-drawer.js"></script>
    <script src="js/saved-cards.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        /* CSS Variables for theming */
        :root {
            --bg-primary: #7f8c8d;
            --bg-secondary: #8a9599;
            --bg-panel: #e5e5e5;
            --bg-panel-header: #d5d5d5;
            --border-color: #6b7778;
            --text-primary: #fff;
            --text-secondary: #ddd;
            --text-dark: #333;
            --hover-bg: #6b7778;
        }
        
        /* Light Mode */
        body.light-mode {
            --bg-primary: #f5f5f5;
            --bg-secondary: #e8e8e8;
            --bg-panel: #ffffff;
            --bg-panel-header: #f0f0f0;
            --border-color: #ddd;
            --text-primary: #333;
            --text-secondary: #666;
            --text-dark: #333;
            --hover-bg: #e0e0e0;
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }
        
        /* Header */
        .header { background: #4a9eb4; color: #fff; padding: 8px 15px; display: flex; align-items: center; justify-content: space-between; height: 50px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header-logo { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 16px; text-decoration: none; color: #fff; }
        .header-logo img { height: 30px; }
        .header-nav { display: flex; gap: 3px; }
        .header-nav a { color: #fff; text-decoration: none; padding: 6px 12px; border-radius: 3px; font-size: 13px; transition: background 0.2s; }
        .header-nav a:hover, .header-nav a.active { background: rgba(255,255,255,0.2); }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .header-user { display: flex; align-items: center; gap: 6px; font-size: 13px; background: rgba(255,255,255,0.15); padding: 6px 12px; border-radius: 4px; cursor: pointer; }

        /* Main Sales Layout - 3 columns */
        .sales-layout {
            display: grid;
            grid-template-columns: 180px 1fr 280px;
            height: calc(100vh - 50px);
            gap: 0;
        }

        /* Left: Categories Panel - Neutral grey matching right panel */
        .categories-panel {
            background: #e5e5e5;
            padding: 10px 8px;
            overflow-y: auto;
            border-right: 1px solid #ccc;
        }
        .category-btn {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 4px;
            background: #5dade2;
            border: none;
            border-radius: 4px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            text-align: left;
            cursor: pointer;
            transition: all 0.15s;
        }
        .category-btn:hover { opacity: 0.9; }
        .category-btn.active { box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .category-btn.orange { background: #e67e22; }
        .category-btn.grey { background: #7f8c8d; }
        .category-btn.teal { background: #16a085; }
        .category-btn.purple { background: #8e44ad; }
        .category-btn.amber { background: #d4a017; color: #fff; }
        .category-btn.forest { background: #2d6a4f; color: #fff; }
        .category-btn.red { background: #c0392b; }
        .category-btn.wine { background: #722f37; }
        .category-btn.pink { background: #e91e63; }
        .category-btn.cyan { background: #00bcd4; }

        /* Center: Sale Area - Grey theme */
        .sale-area {
            background: #7f8c8d;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #6b7778;
            border-right: 1px solid #6b7778;
            overflow: hidden;
            position: relative;
            height: 100%;
            min-height: 0; /* Important for flex overflow */
        }
        
        /* Sale Header - Grey theme */
        .sale-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            border-bottom: 1px solid #6b7778;
            background: #8a9599;
        }
        .sale-mode-toggle {
            display: flex;
            gap: 0;
        }
        .mode-btn {
            padding: 8px 20px;
            border: 1px solid #6b7778;
            background: #6b7778;
            color: #fff;
            border-radius: 0;
            cursor: pointer;
            font-weight: 500;
            font-size: 13px;
            transition: all 0.15s;
        }
        .mode-btn:first-child { border-radius: 4px 0 0 4px; }
        .mode-btn:last-child { border-radius: 0 4px 4px 0; border-left: none; }
        .mode-btn.active { background: #4a9eb4; color: #fff; border-color: #4a9eb4; }
        .mode-btn.return-btn.active { background: #e74c3c; border-color: #e74c3c; color: #fff; }
        
        .sale-search {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            max-width: 350px;
            margin: 0 15px;
        }
        .sale-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #6b7778;
            border-radius: 4px;
            font-size: 13px;
            background: #fff;
        }
        .sale-search input:focus { outline: none; border-color: #4a9eb4; }

        /* Items Table - Grey theme */
        .items-table-container {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            background: #7f8c8d;
        }
        .items-table {
            width: 100%;
            border-collapse: collapse;
        }
        .items-table thead {
            background: #8a9599;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        .items-table th {
            padding: 10px 12px;
            text-align: left;
            font-size: 11px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            border-bottom: 2px solid #6b7778;
        }
        .items-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #8a9599;
            font-size: 13px;
            vertical-align: middle;
            color: #fff;
        }
        .items-table tr:hover { background: #6b7778; }
        .items-table tr.taxable-row { background: #5a5850; }
        
        .item-remove {
            background: none;
            color: #e74c3c;
            border: none;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 700;
            transition: all 0.2s;
            padding: 0;
        }
        .item-remove:hover { color: #c0392b; transform: scale(1.1); }
        
        /* Inline editable inputs */
        .inline-input {
            width: 60px;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            text-align: center;
            background: #fff;
        }
        .inline-input:focus { border-color: #4a9eb4; outline: none; box-shadow: 0 0 0 2px rgba(74,158,180,0.2); }
        .inline-input.price-input { width: 70px; text-align: right; }
        .inline-input.qty-input { width: 50px; }
        .inline-input.disc-input { width: 50px; }
        
        /* Disc column header nowrap */
        .items-table th { white-space: nowrap; }
        
        .item-name-cell {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .item-name-cell .item-checkbox {
            width: 16px;
            height: 16px;
            cursor: pointer;
        }
        .item-name-cell .item-name {
            color: #7ec8e8;
            font-weight: 500;
        }
        
        .item-total { font-weight: 600; color: #fff; text-align: right; }
        
        /* Taxable checkbox row */
        .taxable-row-footer {
            background: #5d656d;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #ddd;
            border-bottom: 1px solid #666;
        }
        .taxable-row-footer input[type="checkbox"] { width: 14px; height: 14px; cursor: pointer; }
        
        /* Modal Overlay */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .modal-content {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlide 0.2s ease;
        }
        @keyframes modalSlide {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .modal-header h3 {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
        }
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover { color: #333; }
        .modal-body { padding: 0; }
        
        .empty-sale {
            text-align: center;
            padding: 40px 20px;
            color: #ddd;
        }
        .empty-sale i { font-size: 36px; margin-bottom: 10px; display: block; color: #ccc; }
        .empty-sale p { font-size: 13px; color: #ddd; }

        /* Customer Section - Grey theme */
        .customer-section {
            padding: 8px 15px;
            border-top: 1px solid #8a9599;
            background: #8a9599;
        }
        .customer-section label {
            font-size: 10px;
            font-weight: 600;
            color: #fff;
            text-transform: uppercase;
            display: block;
            margin-bottom: 5px;
        }
        .customer-row {
            display: flex;
            gap: 6px;
        }
        .customer-row input {
            flex: 1;
            padding: 7px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        .customer-row input:focus { outline: none; border-color: #4a9eb4; }
        .add-customer-btn {
            width: 32px;
            background: #4a9eb4;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .add-customer-btn:hover { background: #3d8a9a; }
        
        .customer-count-text { color: #fff; }

        /* Fixed footer wrapper - Grey theme */
        .sale-footer {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            flex-shrink: 0;
            background: #7f8c8d;
            border-top: 2px solid #6b7778;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.2);
        }
        
        /* Totals Section - Grey theme */
        .totals-section {
            padding: 10px 15px;
            background: #7f8c8d;
        }
        .total-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 13px;
            color: #ddd;
        }
        .total-row.grand {
            font-size: 16px;
            font-weight: 700;
            color: #fff;
            border-top: 1px solid #666;
            margin-top: 6px;
            padding-top: 10px;
        }
        .discount-row { color: #27ae60; }

        /* Payment Buttons */
        .payment-section {
            padding: 12px 15px;
            background: #7f8c8d;
            border-top: 1px solid #6b7778;
        }
        .payment-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .pay-btn {
            flex: 1;
            padding: 18px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.15s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .pay-btn i { font-size: 18px; }
        .pay-btn.pay-now { background: #2ecc71; color: #fff; }
        .pay-btn.pay-now:hover { background: #27ae60; }
        .pay-btn.credit { background: #5dade2; color: #fff; }
        .pay-btn.credit:hover { background: #3498db; }
        .pay-btn.cash { background: #f5a623; color: #fff; }
        .pay-btn.cash:hover { background: #e69500; }
        
        .action-btns {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        .action-btn {
            padding: 14px 10px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.15s;
            color: #444;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        .action-btn:hover { background: #f0f0f0; border-color: #bbb; }
        .action-btn i { font-size: 14px; }
        
        .register-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            padding-top: 8px;
            border-top: 1px solid #e5e5e5;
        }
        .register-links a {
            color: #666;
            text-decoration: none;
            font-size: 11px;
        }
        .register-links a:hover { color: #4a9eb4; }
        .register-links a i { margin-right: 3px; }

        /* Right: Transactions Panel - Neutral grey style */
        .transactions-panel {
            background: #e5e5e5;
            color: #333;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #ccc;
        }
        .panel-header {
            background: #4a9eb4;
            color: #fff;
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .panel-header .register-name { font-weight: 600; font-size: 14px; }
        .panel-header .user-name { font-size: 12px; opacity: 0.9; cursor: pointer; }
        .panel-header .user-name:hover { opacity: 1; }
        .panel-section {
            padding: 0;
            border-bottom: none;
            overflow-y: auto;
            position: relative;
            background: #e5e5e5;
        }
        .panel-section h4 {
            font-size: 12px;
            text-transform: none;
            margin: 0;
            padding: 10px 15px;
            background: #d5d5d5;
            color: #444;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid #c0c0c0;
        }
        .panel-section h4 .collapse-icon { margin-left: auto; font-size: 10px; transition: transform 0.2s; }
        .panel-section.collapsed .collapse-icon { transform: rotate(-90deg); }
        .panel-section.collapsed > div:not(:first-child) { display: none !important; }
        
        /* Resizer handle */
        .panel-resizer {
            height: 6px;
            background: #c0c0c0;
            cursor: ns-resize;
            flex-shrink: 0;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .panel-resizer:hover { background: #a0a0a0; }
        .panel-resizer::after {
            content: '';
            width: 30px;
            height: 3px;
            background: rgba(0,0,0,0.15);
            border-radius: 2px;
        }
        .panel-resizer:hover::after { background: rgba(0,0,0,0.3); }
        
        .trans-item {
            background: transparent;
            padding: 8px 15px;
            border-radius: 0;
            margin-bottom: 0;
            cursor: pointer;
            transition: background 0.15s;
            border: none;
            border-bottom: 1px solid #d0d0d0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trans-item:hover { background: rgba(255,255,255,0.5); }
        .trans-item .trans-left { flex: 1; }
        .trans-item .trans-time { font-size: 12px; color: #666; font-weight: 500; }
        .trans-item .trans-customer { font-size: 14px; color: #333; font-weight: 600; margin-top: 2px; }
        .trans-item .trans-right { text-align: right; }
        .trans-item .trans-amount { font-weight: 700; font-size: 15px; color: #333; }
        .trans-item .trans-id { font-size: 11px; color: #5dade2; font-weight: 500; }
        .trans-item.return .trans-amount { color: #e74c3c; }
        
        .empty-list { text-align: center; padding: 20px; color: #999; font-size: 12px; }
        
        /* Open Tabs - ForeUP flat list style */
        .tab-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: transparent;
            color: #333;
            border-radius: 0;
            margin-bottom: 0;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #d0d0d0;
        }
        .tab-item:hover { background: rgba(255,255,255,0.5); }
        .tab-item.vip, .tab-item.member { background: rgba(255,255,255,0.3); }
        .tab-item.vip:hover, .tab-item.member:hover { background: rgba(255,255,255,0.6); }
        .tab-customer { font-weight: 700; font-size: 18px; display: flex; align-items: center; gap: 8px; color: #333; }
        .tab-badge { font-size: 12px; background: rgba(0,0,0,0.12); padding: 4px 10px; border-radius: 10px; font-weight: 700; }
        .tab-info { font-size: 14px; color: #444; margin-top: 4px; font-weight: 600; }
        .tab-discount { font-size: 12px; color: #444; font-weight: 600; }
        .tab-total { font-weight: 800; font-size: 20px; color: #222; }
        .tab-left { flex: 1; }
        .tab-right { text-align: right; }
        
        /* Suspended/Incomplete Sales - ForeUP red header style */
        .suspended-section-header {
            background: #a94442;
            color: #fff;
            padding: 10px 15px;
            font-size: 13px;
            font-weight: 600;
        }
        .suspended-item {
            background: transparent;
            color: #333;
            padding: 10px 15px;
            border-radius: 0;
            margin-bottom: 0;
            cursor: pointer;
            transition: background 0.15s;
            border-bottom: 1px solid #d0d0d0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .suspended-item:hover { background: rgba(255,255,255,0.5); }
        .suspended-item .susp-header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .suspended-item .susp-name { font-weight: 600; font-size: 13px; color: #333; }
        .suspended-item .susp-amount { font-weight: 700; font-size: 15px; color: #333; }
        .suspended-item .susp-customer { font-size: 12px; color: #666; }

        /* Staff Login Screen */
        .login-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #3d8a9a 0%, #2c3e50 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .login-screen.hidden { display: none; }
        .login-box {
            background: #fff;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        .login-box img { height: 60px; margin-bottom: 20px; }
        .login-box h2 { margin: 0 0 30px; color: #2c3e50; font-size: 22px; }
        .pin-display {
            background: #f5f6f8;
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            font-size: 32px;
            letter-spacing: 12px;
            margin-bottom: 20px;
            font-family: monospace;
            min-height: 60px;
        }
        .pin-display.error { border-color: #e74c3c; animation: shake 0.3s; }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .pin-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 280px;
            margin: 0 auto;
        }
        .pin-btn {
            padding: 20px;
            font-size: 24px;
            font-weight: 600;
            border: none;
            border-radius: 10px;
            background: #f0f2f5;
            cursor: pointer;
            transition: all 0.15s;
        }
        .pin-btn:hover { background: #e0e3e8; }
        .pin-btn:active { transform: scale(0.95); }
        .pin-btn.clear { background: #e74c3c; color: #fff; font-size: 16px; }
        .pin-btn.clear:hover { background: #c0392b; }
        .pin-btn.enter { background: #27ae60; color: #fff; font-size: 16px; }
        .pin-btn.enter:hover { background: #219a52; }
        .staff-quick-select {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .staff-quick-select p { font-size: 12px; color: #888; margin-bottom: 10px; }
        .staff-avatars {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        .staff-avatar {
            width: 60px;
            text-align: center;
            cursor: pointer;
        }
        .staff-avatar .avatar-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #4a9eb4;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            margin: 0 auto 5px;
            transition: transform 0.15s;
        }
        .staff-avatar:hover .avatar-circle { transform: scale(1.1); }
        .staff-avatar .avatar-name { font-size: 11px; color: #666; }

        /* Items Popup Modal */
        .items-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .items-modal.active { opacity: 1; visibility: visible; }
        .items-modal-content {
            background: #fff;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            max-height: 80vh;
            overflow: hidden;
            transform: scale(0.9);
            transition: transform 0.2s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .items-modal.active .items-modal-content { transform: scale(1); }
        .items-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #4a9eb4;
            color: #fff;
        }
        .items-modal-header h3 { margin: 0; font-size: 18px; font-weight: 600; }
        .items-modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.8;
        }
        .items-modal-close:hover { opacity: 1; }
        .items-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            padding: 20px;
            max-height: calc(80vh - 70px);
            overflow-y: auto;
            background: #f5f5f5;
        }
        .item-card {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 18px 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .item-card:hover { border-color: #27ae60; background: #f8fff8; }
        .item-card .item-name { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 6px; line-height: 1.3; }
        .item-card .item-price { font-size: 15px; color: #27ae60; font-weight: 700; }
        
        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            background: #2c3e50;
            color: #fff;
            border-radius: 8px;
            font-size: 14px;
            z-index: 2000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        .toast.show { transform: translateY(0); opacity: 1; }
        .toast.success { background: #27ae60; }
        .toast.error { background: #e74c3c; }
        
        /* Customer Autocomplete */
        .customer-section { position: relative; }
        .customer-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 60px;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .customer-autocomplete.show { display: block; }
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #eee;
        }
        .autocomplete-item:hover { background: #f5f6fa; }
        .autocomplete-item .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #4a90a4;
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
        }
        .autocomplete-item .avatar.member { background: linear-gradient(135deg, #d4a017, #b8860b); }
        .autocomplete-item .info { flex: 1; }
        .autocomplete-item .name { font-weight: 600; font-size: 14px; }
        .autocomplete-item .meta { font-size: 12px; color: #999; }
        .member-tag { background: linear-gradient(135deg, #d4a017, #b8860b); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 10px; font-weight: 700; margin-left: 6px; }
        
        /* Return mode styling */
        .return-mode .sale-header { background: #9a6b6b; }
        .return-mode .items-table thead { background: #9a6b6b; }
        .return-mode .sale-area { background: #8b6666; }
        .return-mode .items-table-container { background: #8b6666; }
        .return-mode .sale-footer { background: #8b6666; }
        .return-mode .customer-section { background: #9a6b6b; border-top-color: #9a6b6b; }
        .return-mode .totals-section { background: #8b6666; }
        
        /* Light Mode Overrides */
        body.light-mode .sale-area { background: #f5f5f5; border-color: #ddd; }
        body.light-mode .sale-header { background: #e8e8e8; border-color: #ddd; }
        body.light-mode .mode-btn { background: #ddd; border-color: #ccc; color: #333; }
        body.light-mode .mode-btn.active { background: #4a9eb4; color: #fff; }
        body.light-mode .items-table-container { background: #f5f5f5; }
        body.light-mode .items-table thead { background: #e8e8e8; }
        body.light-mode .items-table th { color: #333; border-color: #ddd; }
        body.light-mode .items-table td { color: #333; border-color: #e0e0e0; }
        body.light-mode .items-table tr:hover { background: #eee; }
        body.light-mode .item-name-cell .item-name { color: #2980b9; }
        body.light-mode .empty-sale { color: #888; }
        body.light-mode .empty-sale i { color: #aaa; }
        body.light-mode .empty-sale p { color: #888; }
        body.light-mode .customer-section { background: #e8e8e8; border-top-color: #ddd; }
        body.light-mode .customer-section label { color: #333; }
        body.light-mode .customer-count-text { color: #666; }
        body.light-mode .sale-footer { background: #f5f5f5; border-color: #ddd; }
        body.light-mode .totals-section { background: #f5f5f5; }
        body.light-mode .total-row { color: #666; }
        body.light-mode .total-row.grand { color: #333; border-color: #ddd; }
        body.light-mode #totalDue, body.light-mode #totalDueLarge, body.light-mode .total-due-label, body.light-mode .total-due-value { color: #333 !important; }
        body.light-mode .action-link { color: #2980b9 !important; }
        body.light-mode .payment-section { background: #f5f5f5; }
        body.light-mode .categories-panel { background: #f0f0f0; }
        body.light-mode .transactions-panel { background: #f5f5f5; }
        body.light-mode .panel-section { background: #f5f5f5; }
        body.light-mode .panel-section h4 { background: #e8e8e8; color: #333; border-color: #ddd; }
        
        /* Light mode return styling */
        body.light-mode.return-mode .sale-area { background: #fdf2f2; }
        body.light-mode.return-mode .sale-header { background: #f5e0e0; }
        body.light-mode.return-mode .items-table-container { background: #fdf2f2; }
        body.light-mode.return-mode .items-table thead { background: #f5e0e0; }
        body.light-mode.return-mode .sale-footer { background: #fdf2f2; }
        body.light-mode.return-mode .customer-section { background: #f5e0e0; }
        body.light-mode.return-mode .totals-section { background: #fdf2f2; }
    </style>
</head>
<body>
    <!-- Staff Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-box">
            <img src="images/golfCoveLogo6.png" alt="Golf Cove">
            <h2>Staff Login</h2>
            <div class="pin-display" id="pinDisplay">●●●●</div>
            <div class="pin-pad">
                <button class="pin-btn" onclick="enterPin('1')">1</button>
                <button class="pin-btn" onclick="enterPin('2')">2</button>
                <button class="pin-btn" onclick="enterPin('3')">3</button>
                <button class="pin-btn" onclick="enterPin('4')">4</button>
                <button class="pin-btn" onclick="enterPin('5')">5</button>
                <button class="pin-btn" onclick="enterPin('6')">6</button>
                <button class="pin-btn" onclick="enterPin('7')">7</button>
                <button class="pin-btn" onclick="enterPin('8')">8</button>
                <button class="pin-btn" onclick="enterPin('9')">9</button>
                <button class="pin-btn clear" onclick="clearPin()">Clear</button>
                <button class="pin-btn" onclick="enterPin('0')">0</button>
                <button class="pin-btn enter" onclick="submitPin()">Enter</button>
            </div>
            <div class="staff-quick-select">
                <p>Quick Clock In</p>
                <div class="staff-avatars" id="staffAvatars"></div>
            </div>
        </div>
    </div>

    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <a href="index.html" class="header-logo">
                <img src="images/golfCoveLogo6.png" alt="Golf Cove">
                <span>Golf Cove</span>
            </a>
            <nav class="header-nav">
                <a href="admin-pos.html"><i class="fas fa-calendar-alt"></i> Tee Sheet</a>
                <a href="sales.html" class="active"><i class="fas fa-cash-register"></i> Sales</a>
                <a href="customers.html"><i class="fas fa-users"></i> Customers</a>
            </nav>
        </div>
        <div class="header-right">
            <button onclick="toggleFullscreen()" id="fullscreenBtn" style="background:rgba(255,255,255,0.15);border:none;color:#fff;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:13px;margin-right:10px;" title="Toggle Fullscreen">
                <i class="fas fa-expand" id="fullscreenIcon"></i>
            </button>
            <button onclick="toggleDarkMode()" id="darkModeBtn" style="background:rgba(255,255,255,0.15);border:none;color:#fff;padding:8px 12px;border-radius:4px;cursor:pointer;font-size:13px;margin-right:10px;" title="Toggle Dark/Light Mode">
                <i class="fas fa-moon" id="darkModeIcon"></i>
            </button>
            <div class="header-user" onclick="showUserMenu()">
                <i class="fas fa-user-circle"></i>
                <span id="currentUserName">Staff</span> ▾
            </div>
        </div>
    </header>

    <!-- Main Sales Layout -->
    <div class="sales-layout">
        <!-- Left: Categories - No icons, color coded -->
        <div class="categories-panel">
            <button class="category-btn active" data-category="all" onclick="selectCategory('all', this)">All Items</button>
            <button class="category-btn purple" data-category="rental" onclick="selectCategory('rental', this)">Rentals</button>
            <button class="category-btn orange" data-category="food" onclick="selectCategory('food', this)">Food</button>
            <button class="category-btn forest" data-category="beer" onclick="selectCategory('beer', this)">Beer</button>
            <button class="category-btn forest" data-category="wine" onclick="selectCategory('wine', this)">Wine</button>
            <button class="category-btn forest" data-category="cocktails" onclick="selectCategory('cocktails', this)">Cocktails</button>
            <button class="category-btn cyan" data-category="beverage" onclick="selectCategory('beverage', this)">Beverages</button>
            <button class="category-btn grey" data-category="merch" onclick="selectCategory('merch', this)">Merch</button>
            <button class="category-btn teal" data-category="giftcard" onclick="selectCategory('giftcard', this)">Gift Cards</button>
            <button class="category-btn red" data-category="membership" onclick="selectCategory('membership', this)">Memberships</button>
        </div>

        <!-- Center: Sale Area -->
        <div class="sale-area" id="saleArea">
            <div class="sale-header">
                <div class="sale-mode-toggle">
                    <button class="mode-btn active" onclick="setMode('sale', this)">Sale</button>
                    <button class="mode-btn return-btn" onclick="setMode('return', this)">Return</button>
                </div>
                <div id="activeTabBanner" style="display:none;background:linear-gradient(135deg,#3498db,#2980b9);color:#fff;padding:8px 15px;border-radius:8px;font-size:13px;font-weight:600;align-items:center;gap:8px;">
                    <i class="fas fa-receipt"></i>
                    <span id="activeTabName">Tab: Customer</span>
                    <span id="activeTabBadge" style="display:none;margin-left:8px;"></span>
                    <button onclick="clearActiveTab()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;padding:4px 10px;border-radius:4px;cursor:pointer;font-size:11px;margin-left:auto;display:flex;align-items:center;gap:4px;">
                        <i class="fas fa-times"></i> Clear
                    </button>
                </div>
                <div class="sale-search">
                    <input type="text" id="itemSearch" placeholder="Search items or scan barcode..." onkeyup="searchItems(this.value)">
                </div>
            </div>
            
            <div class="items-table-container">
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th style="width:70px;">Price</th>
                            <th style="width:45px;">Qty</th>
                            <th style="width:45px;">Disc</th>
                            <th style="width:75px; text-align:right;">Total</th>
                            <th style="width:30px;"></th>
                        </tr>
                    </thead>
                    <tbody id="saleItemsBody">
                        <tr class="empty-row">
                            <td colspan="6">
                                <div class="empty-sale">
                                    <i class="fas fa-shopping-cart"></i>
                                    <p>Select a category or search to add items</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Sticky Payment Footer -->
            <div class="sale-footer">
                <div class="customer-section">
                    <label style="display:flex;align-items:center;justify-content:space-between;">
                        <span style="font-size:13px;font-weight:600;">CUSTOMER</span>
                        <span id="customerCount" class="customer-count-text" style="font-size:12px;font-weight:500;"></span>
                    </label>
                    <div class="customer-row">
                        <input type="text" id="customerName" placeholder="Type to search customers..." autocomplete="off">
                        <button class="add-customer-btn" onclick="refreshCustomers()" title="Refresh from Stripe" id="refreshCustomersBtn"><i class="fas fa-sync-alt"></i></button>
                        <button class="add-customer-btn" onclick="addNewCustomer()" title="Add New Customer"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="customer-autocomplete" id="customerAutocomplete"></div>
                </div>
                
                <div class="totals-section" style="padding:15px;">
                    <div class="total-row" style="display:flex;justify-content:flex-end;gap:30px;font-size:13px;margin-bottom:4px;">
                        <span>Subtotal</span>
                        <span id="subtotal" style="min-width:70px;text-align:right;">$0.00</span>
                    </div>
                    <div class="total-row discount-row" id="discountRow" style="display:none;justify-content:flex-end;gap:30px;font-size:13px;color:#27ae60;margin-bottom:4px;">
                        <span>Discount</span>
                        <span id="discountAmt" style="min-width:70px;text-align:right;">-$0.00</span>
                    </div>
                    <div class="total-row" style="display:flex;justify-content:flex-end;gap:30px;font-size:13px;margin-bottom:10px;">
                        <span data-tax-label>Sales Tax - 6.35%</span>
                        <span id="taxAmt" style="min-width:70px;text-align:right;">$0.00</span>
                    </div>
                    <div class="total-row grand" style="display:flex;justify-content:flex-end;align-items:baseline;gap:20px;">
                        <span style="font-size:14px;font-weight:500;">Total</span>
                        <span id="totalDue" style="font-size:26px;font-weight:700;">$0.00</span>
                    </div>
                </div>
                
                <!-- Payment Section -->
                <div class="payment-section" style="padding:15px;">
                    <!-- Payment buttons - all green -->
                    <div class="payment-btns" style="display:flex;gap:10px;margin-bottom:12px;">
                        <button class="pay-btn" onclick="processPayment('quick')" style="flex:1;padding:14px 20px;background:#2ecc71;color:#fff;border:none;border-radius:4px;font-size:15px;font-weight:600;cursor:pointer;">
                            Pay Now
                        </button>
                        <button class="pay-btn" onclick="processPayment('card')" style="flex:1;padding:14px 20px;background:#2ecc71;color:#fff;border:none;border-radius:4px;font-size:15px;font-weight:600;cursor:pointer;">
                            Credit Card
                        </button>
                        <button class="pay-btn" onclick="processPayment('cash')" style="flex:1;padding:14px 20px;background:#2ecc71;color:#fff;border:none;border-radius:4px;font-size:15px;font-weight:600;cursor:pointer;">
                            Cash
                        </button>
                    </div>
                    
                    <!-- Total Due - Large display like ForeUP -->
                    <div style="display:flex;justify-content:flex-end;align-items:baseline;gap:15px;margin:15px 0;">
                        <span class="total-due-label" style="font-size:20px;font-weight:500;color:#fff;">Total Due:</span>
                        <span id="totalDueLarge" class="total-due-value" style="font-size:36px;font-weight:700;color:#fff;">$0.00</span>
                    </div>
                    
                    <!-- Action links - styled buttons -->
                    <div style="display:flex;gap:10px;margin-bottom:12px;">
                        <button onclick="suspendSale()" style="flex:1;padding:10px 12px;background:#6b7778;border:1px solid #5a6566;border-radius:4px;color:#fff;font-size:12px;font-weight:500;cursor:pointer;">Suspend Sale/Start Tab</button>
                        <button onclick="showDrawerManagement()" style="flex:1;padding:10px 12px;background:#6b7778;border:1px solid #5a6566;border-radius:4px;color:#fff;font-size:12px;font-weight:500;cursor:pointer;">Cash Drawer</button>
                        <button onclick="closeRegister()" style="flex:1;padding:10px 12px;background:#6b7778;border:1px solid #5a6566;border-radius:4px;color:#fff;font-size:12px;font-weight:500;cursor:pointer;">Close Register</button>
                    </div>
                    
                    <!-- Manager Override -->
                    <button onclick="showManagerOverride()" style="width:100%;padding:12px 20px;background:#6b7778;border:1px solid #5a6566;border-radius:4px;cursor:pointer;font-size:14px;font-weight:500;color:#fff;">Manager Override</button>
                </div>
            </div>
        </div>

        <!-- Right: Transactions Panel - ForeUP Style -->
        <div class="transactions-panel" id="transactionsPanel">
            <!-- Open Tabs Section -->
            <div class="panel-section" id="tabsSection" style="flex:2;min-height:80px;">
                <h4 onclick="toggleSection('tabsSection')">
                    Open Tabs 
                    <span id="tabCount" style="background:#27ae60;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:6px;">0</span>
                    <span style="margin-left:auto;font-size:14px;cursor:pointer;">−</span>
                </h4>
                <div id="openTabsList" style="padding:0;"></div>
            </div>
            
            <!-- Resizer 1 -->
            <div class="panel-resizer" data-resize="tabsSection,suspendedSection"></div>
            
            <!-- Suspended/Incomplete Sales Section -->
            <div class="panel-section" id="suspendedSection" style="flex:1;min-height:60px;">
                <div class="suspended-section-header">Incomplete Sales</div>
                <div id="suspendedSales" style="padding:0;"></div>
            </div>
            
            <!-- Resizer 2 -->
            <div class="panel-resizer" data-resize="suspendedSection,transSection"></div>
            
            <!-- Recent Transactions Section -->
            <div class="panel-section" id="transSection" style="flex:2;min-height:80px;background:#e5e5e5;">
                <h4 onclick="toggleSection('transSection')">
                    Recent Transactions
                    <span style="margin-left:auto;font-size:14px;cursor:pointer;">−</span>
                </h4>
                <div id="recentTrans" style="padding:0;"></div>
            </div>
        </div>
    </div>

    <!-- Items Modal -->
    <div class="items-modal" id="itemsModal">
        <div class="items-modal-content">
            <div class="items-modal-header">
                <h3 id="modalTitle">Items</h3>
                <button class="items-modal-close" onclick="closeItemsModal()">&times;</button>
            </div>
            <div class="items-grid" id="itemsGrid"></div>
        </div>
    </div>

    <script>
        // ============ MODAL FUNCTIONS ============
        let currentModal = null;
        
        function showModal(title, content, width = '400px') {
            closeModal(); // Close any existing
            
            const overlay = document.createElement('div');
            overlay.className = 'modal-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) closeModal(); };
            
            overlay.innerHTML = `
                <div class="modal-content" style="width:${width};max-width:95vw;">
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                    <div class="modal-body">${content}</div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            currentModal = overlay;
        }
        
        function closeModal() {
            if (currentModal) {
                currentModal.remove();
                currentModal = null;
            }
            // Also remove any stray overlays
            document.querySelectorAll('.modal-overlay').forEach(el => el.remove());
        }
        
        // ============ TAX HELPER FUNCTIONS ============
        // Centralized tax rate from GolfCoveConfig
        function getTaxRate() {
            return window.GolfCoveConfig?.pricing?.taxRate ?? 0.0635;
        }
        
        function getTaxRatePercent() {
            return (getTaxRate() * 100).toFixed(2).replace(/\.?0+$/, '');
        }
        
        function getTaxLabel() {
            return `Tax (${getTaxRatePercent()}%)`;
        }
        
        function calculateTax(subtotal) {
            return subtotal * getTaxRate();
        }
        
        // Use shared formatCurrency from GolfCoveUtils (with fallback)
        const formatCurrency = (amount) => {
            try {
                return GolfCoveUtils.formatCurrency(amount);
            } catch (e) {
                return '$' + (parseFloat(amount) || 0).toFixed(2);
            }
        };
        
        // ============ MEMBER DISCOUNT HELPERS ============
        // Check if customer is an active member
        function isActiveMember(customer) {
            if (!customer || !customer.isMember) return false;
            if (!customer.memberExpires) return false;
            return new Date(customer.memberExpires) > new Date();
        }
        
        // Use shared utilities from GolfCoveUtils (with fallbacks)
        const getMemberDiscount = (memberType) => {
            try { return GolfCoveUtils.getMemberDiscount(memberType); } 
            catch (e) { return {'eagle': 15, 'birdie': 10, 'par': 10}[memberType] || 10; }
        };
        const getMemberTierName = (memberType) => {
            try { return GolfCoveUtils.getMemberTierName(memberType); } 
            catch (e) { return {'eagle': 'Eagle', 'birdie': 'Birdie', 'par': 'Par'}[memberType] || 'Member'; }
        };
        const getMemberTierColor = (memberType) => {
            try { return GolfCoveUtils.getMemberTierColor(memberType); } 
            catch (e) { return {'eagle': '#d4a017', 'birdie': '#9b59b6', 'par': '#3498db'}[memberType] || '#3498db'; }
        };
        
        // Apply member discount to all items
        function applyMemberDiscountToSale() {
            if (!selectedCustomer || !isActiveMember(selectedCustomer)) return;
            
            const discountPercent = getMemberDiscount(selectedCustomer.memberType);
            saleItems.forEach(item => {
                if (item.discount < discountPercent) {
                    item.discount = discountPercent;
                }
            });
            memberDiscountApplied = true;
            renderSaleItems();
        }
        
        // Load customers from Stripe - always fetch fresh, no local cache
        async function loadCustomers() {
            const countEl = document.getElementById('customerCount');
            const refreshBtn = document.getElementById('refreshCustomersBtn');
            
            if (countEl) countEl.textContent = 'Loading...';
            if (refreshBtn) refreshBtn.querySelector('i').classList.add('fa-spin');
            
            // Always fetch fresh from Stripe API
            try {
                const FUNCTIONS_URL = window.GolfCoveConfig?.stripe?.functionsUrl || 'https://us-central1-golfcove.cloudfunctions.net';
                const response = await fetch(`${FUNCTIONS_URL}/getStripeCustomers`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.customers) {
                        stripeCustomersCache = data.customers.map(c => {
                            // Parse name into first/last (API returns full name)
                            const nameParts = (c.name || '').split(' ');
                            const firstName = nameParts[0] || '';
                            const lastName = nameParts.slice(1).join(' ') || '';
                            
                            // Check for active subscription
                            const activeSub = c.subscriptions?.find(s => s.status === 'active');
                            
                            // Map Stripe plan/product to our tier names
                            let memberType = null;
                            if (activeSub?.plan) {
                                const plan = (activeSub.plan || '').toLowerCase();
                                if (plan.includes('eagle')) memberType = plan.includes('family') ? 'family_eagle' : 'eagle';
                                else if (plan.includes('birdie')) memberType = plan.includes('family') ? 'family_birdie' : 'birdie';
                                else if (plan.includes('par')) memberType = plan.includes('family') ? 'family_par' : 'par';
                                else if (plan.includes('corporate')) memberType = 'corporate';
                                else if (plan.includes('league')) memberType = 'league';
                                else memberType = 'par'; // Default to par for unknown plans
                            } else if (c.metadata?.tier) {
                                memberType = c.metadata.tier;
                            }
                            
                            const isMember = !!activeSub;
                            const memberExpires = activeSub?.currentPeriodEnd 
                                ? new Date(activeSub.currentPeriodEnd * 1000).toISOString().split('T')[0] 
                                : null;
                            
                            return {
                                id: c.id,
                                stripeId: c.id,
                                stripeCustomerId: c.id,
                                firstName,
                                lastName,
                                email: c.email || '',
                                phone: c.phone || '',
                                isMember,
                                memberType,
                                memberExpires,
                                isLeague: c.metadata?.isLeague === 'true',
                                metadata: c.metadata || {}
                            };
                        });
                        console.log(`[Sales] Loaded ${stripeCustomersCache.length} customers from Stripe`);
                        if (countEl) countEl.textContent = `${stripeCustomersCache.length} customers`;
                        return stripeCustomersCache;
                    }
                }
            } catch (e) {
                console.error('[Sales] Could not load customers from Stripe API:', e);
                if (countEl) countEl.textContent = 'Error loading';
            } finally {
                if (refreshBtn) refreshBtn.querySelector('i').classList.remove('fa-spin');
            }
            
            return stripeCustomersCache;
        }
        
        // Refresh customers from Stripe
        async function refreshCustomers() {
            await loadCustomers();
            showToast(`Loaded ${stripeCustomersCache.length} customers from Stripe`, 'success');
        }

        // ============ STAFF MANAGEMENT ============
        // Staff is now loaded from centralized gc_employees (synced with Firebase)
        const defaultStaff = [
            { id: 'EMP-DEFAULT-1', name: 'Manager', pin: '9999', role: 'manager', color: '#3498db', isActive: true },
            { id: 'EMP-DEFAULT-2', name: 'Bartender', pin: '8888', role: 'bartender', color: '#e67e22', isActive: true },
            { id: 'EMP-DEFAULT-3', name: 'Staff', pin: '7777', role: 'server', color: '#27ae60', isActive: true }
        ];
        
        // Permissions by role
        const rolePermissions = {
            admin: {
                canVoid: true,
                canDiscount: true,
                canRefund: true,
                canOpenDrawer: true,
                canViewReports: true,
                canManageStaff: true,
                canCloseRegister: true,
                maxDiscount: 100
            },
            manager: { 
                canVoid: true, 
                canDiscount: true, 
                canRefund: true, 
                canOpenDrawer: true,
                canViewReports: true,
                canManageStaff: true,
                canCloseRegister: true,
                maxDiscount: 100
            },
            bartender: { 
                canVoid: true, 
                canDiscount: true, 
                canRefund: false, 
                canOpenDrawer: true,
                canViewReports: false,
                canManageStaff: false,
                canCloseRegister: false,
                maxDiscount: 20
            },
            server: { 
                canVoid: false, 
                canDiscount: false, 
                canRefund: false, 
                canOpenDrawer: false,
                canViewReports: false,
                canManageStaff: false,
                canCloseRegister: false,
                maxDiscount: 0
            },
            staff: { 
                canVoid: false, 
                canDiscount: false, 
                canRefund: false, 
                canOpenDrawer: false,
                canViewReports: false,
                canManageStaff: false,
                canCloseRegister: false,
                maxDiscount: 0
            }
        };
        
        // Load staff from centralized storage
        function loadStaff() {
            let employees = JSON.parse(localStorage.getItem('gc_employees') || 'null');
            if (!employees || employees.length === 0) {
                employees = defaultStaff;
                localStorage.setItem('gc_employees', JSON.stringify(employees));
            }
            // Ensure staff has required properties and filter active only
            return employees
                .filter(s => s.isActive !== false)
                .map((s, i) => ({
                    id: s.id || 'EMP-' + i,
                    name: s.name || s.displayName || (s.firstName + ' ' + (s.lastName || '')).trim(),
                    pin: s.pin,
                    role: s.role || 'staff',
                    color: s.color || ['#3498db', '#e67e22', '#9b59b6', '#27ae60'][i % 4],
                    isActive: s.isActive !== false
                }));
        }
        
        let staff = loadStaff();
        let currentUser = JSON.parse(sessionStorage.getItem('gc_currentUser') || 'null');
        let enteredPin = '';
        let selectedStaffId = null;
        
        // ============ CUSTOMER & MEMBER STATE ============
        let stripeCustomersCache = []; // In-memory cache of Stripe customers (synced from admin-pos)
        let selectedCustomer = null;   // Currently selected customer object
        let memberDiscountApplied = false; // Track if member discount is active
        
        // Check if logged in
        function checkLogin() {
            // Refresh staff list
            staff = loadStaff();
            
            if (!currentUser) {
                document.getElementById('loginScreen').classList.remove('hidden');
                renderStaffAvatars();
            } else {
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('currentUserName').textContent = currentUser.name.split(' ')[0];
                updateRegisterPanel();
            }
        }
        
        // Render staff avatars for quick login
        function renderStaffAvatars() {
            const container = document.getElementById('staffAvatars');
            container.innerHTML = staff.map(s => {
                const initials = s.name.split(' ').map(n => n[0]).join('');
                return '<div class="staff-avatar" onclick="selectStaff(' + s.id + ')">' +
                    '<div class="avatar-circle" style="background:' + s.color + '">' + initials + '</div>' +
                    '<div class="avatar-name">' + s.name.split(' ')[0] + '</div>' +
                '</div>';
            }).join('');
        }
        
        // Select staff for login
        function selectStaff(id) {
            selectedStaffId = id;
            const staffMember = staff.find(s => s.id === id);
            document.querySelectorAll('.staff-avatar').forEach(a => a.style.opacity = '0.5');
            event.currentTarget.style.opacity = '1';
            document.getElementById('pinDisplay').textContent = '____';
            enteredPin = '';
        }
        
        // Enter PIN digit
        function enterPin(digit) {
            if (enteredPin.length < 4) {
                enteredPin += digit;
                updatePinDisplay();
            }
        }
        
        // Clear PIN
        function clearPin() {
            enteredPin = '';
            updatePinDisplay();
        }
        
        // Update PIN display
        function updatePinDisplay() {
            const display = document.getElementById('pinDisplay');
            display.textContent = enteredPin.padEnd(4, '_').split('').join(' ');
            display.classList.remove('error');
        }
        
        // Submit PIN
        function submitPin() {
            if (enteredPin.length !== 4) return;
            
            // Find staff by PIN (or selected staff)
            let staffMember;
            if (selectedStaffId) {
                staffMember = staff.find(s => s.id === selectedStaffId && s.pin === enteredPin);
            } else {
                staffMember = staff.find(s => s.pin === enteredPin);
            }
            
            if (staffMember) {
                currentUser = { ...staffMember, loginTime: new Date().toISOString() };
                sessionStorage.setItem('gc_currentUser', JSON.stringify(currentUser));
                
                // Log clock in
                logTimeEntry('clockIn');
                
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('currentUserName').textContent = currentUser.name.split(' ')[0];
                updateRegisterPanel();
                showToast('Welcome, ' + currentUser.name.split(' ')[0] + '!', 'success');
            } else {
                document.getElementById('pinDisplay').classList.add('error');
                enteredPin = '';
                setTimeout(() => updatePinDisplay(), 300);
            }
        }
        
        // Update register panel with current user
        function updateRegisterPanel() {
            const userNameEl = document.getElementById('panelUserText');
            if (userNameEl && currentUser) {
                userNameEl.textContent = currentUser.name;
            }
        }
        
        // Toggle section collapse/expand
        function toggleSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) return;
            section.classList.toggle('collapsed');
        }
        
        // ============ RESIZABLE PANEL SYSTEM ============
        (function initResizers() {
            document.querySelectorAll('.panel-resizer').forEach(resizer => {
                let isResizing = false;
                let startY = 0;
                let startHeights = [];
                
                resizer.addEventListener('mousedown', (e) => {
                    isResizing = true;
                    startY = e.clientY;
                    
                    const sections = resizer.dataset.resize.split(',');
                    startHeights = sections.map(id => {
                        const el = document.getElementById(id);
                        return el ? el.offsetHeight : 100;
                    });
                    
                    document.body.style.cursor = 'ns-resize';
                    document.body.style.userSelect = 'none';
                    
                    const onMouseMove = (e) => {
                        if (!isResizing) return;
                        
                        const delta = e.clientY - startY;
                        const sections = resizer.dataset.resize.split(',');
                        
                        const topSection = document.getElementById(sections[0]);
                        const bottomSection = document.getElementById(sections[1]);
                        
                        if (topSection && bottomSection) {
                            const newTopHeight = Math.max(60, startHeights[0] + delta);
                            const newBottomHeight = Math.max(60, startHeights[1] - delta);
                            
                            topSection.style.flex = 'none';
                            bottomSection.style.flex = 'none';
                            topSection.style.height = newTopHeight + 'px';
                            bottomSection.style.height = newBottomHeight + 'px';
                        }
                    };
                    
                    const onMouseUp = () => {
                        isResizing = false;
                        document.body.style.cursor = '';
                        document.body.style.userSelect = '';
                        document.removeEventListener('mousemove', onMouseMove);
                        document.removeEventListener('mouseup', onMouseUp);
                    };
                    
                    document.addEventListener('mousemove', onMouseMove);
                    document.addEventListener('mouseup', onMouseUp);
                });
            });
        })();
        
        // Manager Override - allows manager to authorize actions
        function showManagerOverride() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'managerOverrideModal';
            modal.innerHTML = `
                <div class="modal" style="max-width:350px;">
                    <div class="modal-header">
                        <h3>Manager Override</h3>
                        <button onclick="this.closest('.modal-overlay').remove()" class="close-btn">&times;</button>
                    </div>
                    <div class="modal-body" style="padding:20px;">
                        <p style="margin-bottom:15px;color:#666;">Enter manager PIN to authorize:</p>
                        <input type="password" id="managerPin" placeholder="Manager PIN" maxlength="4" 
                            style="width:100%;padding:15px;font-size:24px;text-align:center;border:1px solid #ddd;border-radius:4px;letter-spacing:8px;">
                        <button onclick="verifyManagerOverride()" 
                            style="width:100%;margin-top:15px;padding:12px;background:#4CAF50;color:#fff;border:none;border-radius:4px;font-size:14px;font-weight:600;cursor:pointer;">
                            Authorize
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            document.getElementById('managerPin').focus();
        }
        
        function verifyManagerOverride() {
            const pin = document.getElementById('managerPin').value;
            const managers = (JSON.parse(localStorage.getItem('gc_employees') || '[]'))
                .filter(e => e.role === 'manager' || e.role === 'admin');
            
            const matched = managers.find(m => m.pin === pin);
            if (matched) {
                document.getElementById('managerOverrideModal')?.remove();
                showToast(`Override authorized by ${matched.name}`, 'success');
                // Could set a temporary override flag here
                window.managerOverrideActive = true;
                setTimeout(() => { window.managerOverrideActive = false; }, 300000); // 5 min
            } else {
                showToast('Invalid manager PIN', 'error');
            }
        }
        
        // Close register
        function closeRegister() {
            if (!hasPermission('canCloseRegister')) {
                showToast('Permission denied', 'error');
                return;
            }
            if (confirm('Close register for the day? This will generate end-of-day report.')) {
                showToast('Register closed. Generating report...', 'success');
                // TODO: Implement EOD report
            }
        }
        
        // Show user menu
        function showUserMenu() {
            if (!currentUser) {
                checkLogin();
                return;
            }
            
            const perms = rolePermissions[currentUser.role] || {};
            let menuHtml = '<div style="padding:15px;">';
            menuHtml += '<div style="text-align:center;margin-bottom:15px;">';
            menuHtml += '<div style="width:60px;height:60px;border-radius:50%;background:' + currentUser.color + ';color:#fff;display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:600;margin:0 auto 10px;">' + currentUser.name.split(' ').map(n => n[0]).join('') + '</div>';
            menuHtml += '<div style="font-weight:600;">' + currentUser.name + '</div>';
            menuHtml += '<div style="font-size:12px;color:#888;text-transform:capitalize;">' + currentUser.role + '</div>';
            menuHtml += '<div style="font-size:11px;color:#27ae60;margin-top:4px;"><i class="fas fa-clock"></i> Logged in ' + formatLoginTime() + '</div>';
            menuHtml += '</div>';
            
            // Permissions summary
            menuHtml += '<div style="background:#f8f9fa;border-radius:8px;padding:10px;margin-bottom:15px;font-size:11px;">';
            menuHtml += '<div style="font-weight:600;margin-bottom:6px;color:#666;">Permissions</div>';
            menuHtml += '<div style="display:flex;flex-wrap:wrap;gap:4px;">';
            if (perms.canVoid) menuHtml += '<span style="background:#e8f5e9;color:#27ae60;padding:2px 6px;border-radius:4px;">Void</span>';
            if (perms.canDiscount) menuHtml += '<span style="background:#e8f5e9;color:#27ae60;padding:2px 6px;border-radius:4px;">Discount (' + perms.maxDiscount + '%)</span>';
            if (perms.canRefund) menuHtml += '<span style="background:#e8f5e9;color:#27ae60;padding:2px 6px;border-radius:4px;">Refund</span>';
            if (perms.canOpenDrawer) menuHtml += '<span style="background:#e8f5e9;color:#27ae60;padding:2px 6px;border-radius:4px;">Drawer</span>';
            if (perms.canViewReports) menuHtml += '<span style="background:#e8f5e9;color:#27ae60;padding:2px 6px;border-radius:4px;">Reports</span>';
            menuHtml += '</div></div>';
            
            menuHtml += '<div style="border-top:1px solid #eee;padding-top:15px;">';
            menuHtml += '<button onclick="clockOut()" style="width:100%;padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-bottom:10px;"><i class="fas fa-sign-out-alt"></i> Clock Out</button>';
            menuHtml += '<button onclick="switchUser()" style="width:100%;padding:12px;background:#3498db;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;"><i class="fas fa-exchange-alt"></i> Switch User</button>';
            
            if (perms.canManageStaff) {
                menuHtml += '<button onclick="showStaffManager()" style="width:100%;padding:12px;background:#9b59b6;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-top:10px;"><i class="fas fa-users-cog"></i> Manage Staff</button>';
            }
            menuHtml += '</div></div>';
            
            showModal('User Menu', menuHtml);
        }
        
        // Format login time
        function formatLoginTime() {
            if (!currentUser || !currentUser.loginTime) return 'Unknown';
            const loginDate = new Date(currentUser.loginTime);
            const now = new Date();
            const diffMs = now - loginDate;
            const diffMins = Math.floor(diffMs / 60000);
            if (diffMins < 1) return 'just now';
            if (diffMins < 60) return diffMins + ' min ago';
            const diffHrs = Math.floor(diffMins / 60);
            return diffHrs + 'h ' + (diffMins % 60) + 'm ago';
        }
        
        // Clock out
        function clockOut() {
            if (!currentUser) return;
            
            logTimeEntry('clockOut');
            showToast('Clocked out: ' + currentUser.name, 'success');
            
            currentUser = null;
            sessionStorage.removeItem('gc_currentUser');
            closeModal();
            checkLogin();
        }
        
        // Switch user (quick switch without full logout)
        function switchUser() {
            currentUser = null;
            sessionStorage.removeItem('gc_currentUser');
            closeModal();
            checkLogin();
        }
        
        // Log time entry - DISABLED: Timeclock feature temporarily removed
        function logTimeEntry(type) {
            // TODO: Re-enable when timeclock is moved to Firebase
            console.log('Timeclock disabled -', type, currentUser?.name);
        }
        
        // Check permission
        function hasPermission(permission) {
            if (!currentUser) return false;
            const perms = rolePermissions[currentUser.role] || {};
            return perms[permission] || false;
        }
        
        // Get current user's name
        function getCurrentUserName() {
            return currentUser ? currentUser.name : 'Staff';
        }
        
        // Show staff manager (managers only)
        function showStaffManager() {
            if (!hasPermission('canManageStaff')) {
                showToast('Permission denied', 'error');
                return;
            }
            
            let html = '<div style="padding:15px;">';
            html += '<table style="width:100%;border-collapse:collapse;">';
            html += '<tr style="background:#f5f6f8;"><th style="padding:10px;text-align:left;">Name</th><th style="padding:10px;">Role</th><th style="padding:10px;">PIN</th><th style="padding:10px;">Actions</th></tr>';
            
            staff.forEach(s => {
                html += '<tr style="border-bottom:1px solid #eee;">';
                html += '<td style="padding:10px;">' + s.name + '</td>';
                html += '<td style="padding:10px;text-align:center;text-transform:capitalize;">' + s.role + '</td>';
                html += '<td style="padding:10px;text-align:center;font-family:monospace;">' + s.pin + '</td>';
                html += '<td style="padding:10px;text-align:center;">';
                html += '<button onclick="editStaff(' + s.id + ')" style="padding:5px 10px;background:#3498db;color:#fff;border:none;border-radius:4px;cursor:pointer;margin-right:5px;"><i class="fas fa-edit"></i></button>';
                html += '<button onclick="resetPin(' + s.id + ')" style="padding:5px 10px;background:#f39c12;color:#fff;border:none;border-radius:4px;cursor:pointer;"><i class="fas fa-key"></i></button>';
                html += '</td></tr>';
            });
            
            html += '</table>';
            html += '<button onclick="addStaffMember()" style="width:100%;padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;margin-top:15px;"><i class="fas fa-plus"></i> Add Staff Member</button>';
            html += '</div>';
            
            closeModal();
            showModal('Staff Management', html, '600px');
        }
        
        // Add new staff member
        function addStaffMember() {
            const name = prompt('Enter staff name:');
            if (!name) return;
            
            const role = prompt('Enter role (manager, bartender, server):') || 'server';
            const pin = prompt('Enter 4-digit PIN:');
            
            if (pin && pin.length === 4 && /^\d+$/.test(pin)) {
                const colors = ['#3498db', '#e67e22', '#9b59b6', '#27ae60', '#e74c3c', '#1abc9c'];
                staff.push({
                    id: Date.now(),
                    name: name,
                    pin: pin,
                    role: role.toLowerCase(),
                    color: colors[staff.length % colors.length]
                });
                localStorage.setItem('gc_staff', JSON.stringify(staff));
                showStaffManager();
                showToast('Staff member added', 'success');
            } else {
                showToast('Invalid PIN - must be 4 digits', 'error');
            }
        }
        
        // Reset PIN
        function resetPin(id) {
            const newPin = prompt('Enter new 4-digit PIN:');
            if (newPin && newPin.length === 4 && /^\d+$/.test(newPin)) {
                const member = staff.find(s => s.id === id);
                if (member) {
                    member.pin = newPin;
                    localStorage.setItem('gc_staff', JSON.stringify(staff));
                    showStaffManager();
                    showToast('PIN updated', 'success');
                }
            } else {
                showToast('Invalid PIN - must be 4 digits', 'error');
            }
        }
        
        // ============ DATA ============
        // Use centralized product catalog from menu-data.js
        const defaultItems = window.GolfCoveMenu ? GolfCoveMenu.getAllItems() : [];
        
        // Clear old inventory data that might have emojis
        (function cleanupOldData() {
            const saved = localStorage.getItem('gc_inventory');
            if (saved && saved.includes('emoji')) {
                localStorage.removeItem('gc_inventory');
                console.log('[Sales] Cleared old inventory data with emoji references');
            }
        })();
        
        // Load items with saved inventory levels (merges with default catalog)
        let items = (function() {
            const saved = JSON.parse(localStorage.getItem('gc_inventory') || 'null');
            if (!saved) {
                // Initialize with default stock levels
                return defaultItems.map(item => ({
                    ...item,
                    stock: item.defaultStock || 0
                }));
            }
            // Merge saved inventory with current catalog - ALWAYS use catalog icons (not saved)
            return defaultItems.map(catItem => {
                const savedItem = saved.find(s => s.id === catItem.id);
                // Use catItem completely, only take stock from saved
                return { ...catItem, stock: savedItem?.stock ?? catItem.defaultStock ?? 0 };
            });
        })();
        
        // Save inventory function
        function saveInventory() {
            localStorage.setItem('gc_inventory', JSON.stringify(items));
            // Sync to Firebase
            syncInventoryToFirebase();
        }
        
        // Sync inventory to Firebase
        async function syncInventoryToFirebase() {
            try {
                // Only sync items that have stock tracking
                const inventoryData = items.filter(i => i.trackInventory).map(i => ({
                    id: i.id,
                    name: i.name,
                    stock: i.stock || 0,
                    lastUpdated: new Date().toISOString()
                }));
                
                await fetch(`${FIREBASE_URL}/inventory.json`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(inventoryData)
                });
                console.log('[Sales] Inventory synced to Firebase');
            } catch (e) {
                console.warn('[Sales] Failed to sync inventory to Firebase:', e);
            }
        }
        
        // Load inventory from Firebase
        async function loadInventoryFromFirebase() {
            try {
                const response = await fetch(`${FIREBASE_URL}/inventory.json`);
                if (response.ok) {
                    const data = await response.json();
                    if (data && Array.isArray(data)) {
                        // Merge Firebase stock levels with local items
                        data.forEach(fbItem => {
                            const localItem = items.find(i => i.id === fbItem.id);
                            if (localItem) {
                                localItem.stock = fbItem.stock;
                            }
                        });
                        localStorage.setItem('gc_inventory', JSON.stringify(items));
                        console.log('[Sales] Loaded inventory from Firebase');
                    }
                }
            } catch (e) {
                console.warn('[Sales] Failed to load inventory from Firebase:', e);
            }
        }
        
        // Deduct inventory on sale
        function deductInventory(saleItemList) {
            saleItemList.forEach(saleItem => {
                const item = items.find(i => i.name === saleItem.name);
                if (item && item.trackInventory && item.stock !== undefined) {
                    item.stock = Math.max(0, item.stock - saleItem.qty);
                }
            });
            saveInventory();
            checkLowStock();
        }
        
        // Add inventory (for returns or receiving)
        function addInventory(itemId, qty) {
            const item = items.find(i => i.id === itemId);
            if (item && item.trackInventory) {
                item.stock = (item.stock || 0) + qty;
                saveInventory();
            }
        }
        
        // Check for low stock items
        function checkLowStock() {
            const lowStock = items.filter(i => i.trackInventory && i.stock !== undefined && i.stock <= 5);
            if (lowStock.length > 0) {
                console.log('Low stock items:', lowStock.map(i => `${i.name}: ${i.stock}`));
            }
        }
        
        // State
        let saleItems = [];
        let isReturnMode = false;
        let transactions = JSON.parse(localStorage.getItem('gc_transactions') || '[]');
        let suspendedSales = JSON.parse(localStorage.getItem('gc_suspended') || '[]');
        
        // Firebase URL
        const FIREBASE_URL = 'https://golfcove-default-rtdb.firebaseio.com';
        
        // Save transactions to localStorage AND Firebase
        async function saveTransactions() {
            localStorage.setItem('gc_transactions', JSON.stringify(transactions));
        }
        
        // Sync a single transaction to Firebase
        async function syncTransactionToFirebase(transaction) {
            try {
                if (transaction._firebaseKey) {
                    // Update existing
                    await fetch(`${FIREBASE_URL}/transactions/${transaction._firebaseKey}.json`, {
                        method: 'PATCH',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(transaction)
                    });
                } else {
                    // Create new
                    const response = await fetch(`${FIREBASE_URL}/transactions.json`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(transaction)
                    });
                    if (response.ok) {
                        const { name } = await response.json();
                        transaction._firebaseKey = name;
                        saveTransactions();
                    }
                }
            } catch (e) {
                console.warn('[Sales] Failed to sync transaction to Firebase:', e);
                transaction._pendingSync = true;
                saveTransactions();
            }
        }
        
        // Load transactions from Firebase on startup
        async function loadTransactionsFromFirebase() {
            try {
                const response = await fetch(`${FIREBASE_URL}/transactions.json`);
                if (response.ok) {
                    const data = await response.json();
                    if (data) {
                        const firebaseTransactions = Object.entries(data).map(([key, val]) => ({
                            ...val,
                            _firebaseKey: key
                        }));
                        
                        // Merge with local (keep pending syncs from local)
                        const localPending = transactions.filter(t => t._pendingSync);
                        const merged = [...firebaseTransactions];
                        
                        // Add local pending that aren't in Firebase
                        for (const pending of localPending) {
                            if (!merged.find(t => t.id === pending.id)) {
                                merged.push(pending);
                                syncTransactionToFirebase(pending); // Try to sync
                            }
                        }
                        
                        transactions = merged.sort((a, b) => new Date(b.date) - new Date(a.date));
                        saveTransactions();
                        console.log('[Sales] Loaded', firebaseTransactions.length, 'transactions from Firebase');
                    }
                }
            } catch (e) {
                console.warn('[Sales] Failed to load transactions from Firebase:', e);
            }
        }
        
        // ============ DARK MODE ============
        function toggleDarkMode() {
            const body = document.body;
            const icon = document.getElementById('darkModeIcon');
            const isLight = body.classList.toggle('light-mode');
            
            // Update icon
            if (icon) {
                icon.className = isLight ? 'fas fa-sun' : 'fas fa-moon';
            }
            
            // Save preference
            localStorage.setItem('gc_light_mode', isLight ? 'true' : 'false');
        }
        
        function initDarkMode() {
            const isLight = localStorage.getItem('gc_light_mode') === 'true';
            if (isLight) {
                document.body.classList.add('light-mode');
                const icon = document.getElementById('darkModeIcon');
                if (icon) icon.className = 'fas fa-sun';
            }
        }
        
        // ============ FULLSCREEN ============
        function toggleFullscreen() {
            const icon = document.getElementById('fullscreenIcon');
            
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().then(() => {
                    if (icon) icon.className = 'fas fa-compress';
                }).catch(err => {
                    console.log('Fullscreen error:', err);
                });
            } else {
                document.exitFullscreen().then(() => {
                    if (icon) icon.className = 'fas fa-expand';
                });
            }
        }
        
        // Listen for fullscreen changes (e.g., user presses Escape)
        document.addEventListener('fullscreenchange', () => {
            const icon = document.getElementById('fullscreenIcon');
            if (icon) {
                icon.className = document.fullscreenElement ? 'fas fa-compress' : 'fas fa-expand';
            }
        });
        
        // ============ INIT ============
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize dark mode preference
            initDarkMode();
            
            // Load global settings from Firebase on startup
            await loadGlobalSettings();
            
            // Load transactions from Firebase
            await loadTransactionsFromFirebase();
            
            // Load inventory from Firebase
            await loadInventoryFromFirebase();
            
            // Initialize TabsSync first
            if (typeof TabsSync !== 'undefined') {
                TabsSync.init();
            }
            
            // Load customers from Stripe/cache
            await loadCustomers();
            
            // Update tax labels dynamically from config
            document.querySelectorAll('[data-tax-label]').forEach(el => {
                el.textContent = getTaxLabel();
            });
            
            // Migrate old insecure PINs (1234, 0000, etc.) to 9999
            migrateOldPins();
            
            checkLogin();
            renderTransactions();
            renderSuspended();
            renderOpenTabs();
            updateTabCount();
            
            // Listen for tab changes from other pages
            if (typeof TabsSync !== 'undefined') {
                TabsSync.addListener((event, data, allTabs) => {
                    renderOpenTabs();
                    updateTabCount();
                });
            }
        });
        
        // Migrate old/insecure PINs to new secure default
        function migrateOldPins() {
            const insecurePins = ['1234', '0000', '1111', '2222', '3333', '4444', '5555', '6666', '7777', '8888'];
            const employees = JSON.parse(localStorage.getItem('gc_employees') || '[]');
            let updated = false;
            
            employees.forEach(emp => {
                if (insecurePins.includes(emp.pin)) {
                    emp.pin = '9999';
                    updated = true;
                }
            });
            
            if (updated) {
                localStorage.setItem('gc_employees', JSON.stringify(employees));
                console.log('Migrated insecure PINs to 9999');
            }
        }
        
        function updateTabCount() {
            const count = TabsSync.getTabs().length;
            const el = document.getElementById('tabCount');
            if (el) el.textContent = count;
        }
        
        // ============ CATEGORY & ITEMS ============
        function selectCategory(category, btn) {
            document.querySelectorAll('.category-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            
            if (category === 'all') {
                showItemsModal('All Items', items);
            } else {
                const filtered = items.filter(i => i.category === category);
                const title = category.charAt(0).toUpperCase() + category.slice(1);
                showItemsModal(title, filtered);
            }
        }
        
        function showItemsModal(title, itemList) {
            document.getElementById('modalTitle').textContent = title;
            const grid = document.getElementById('itemsGrid');
            grid.innerHTML = itemList.map(item => {
                // Special styling for membership items
                if (item.isMembership) {
                    const color = item.color || '#9b59b6';
                    return `
                        <div class="item-card ${item.category}" onclick="showMembershipSaleModal('${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.memberType}', '${item.billingCycle}')" style="background:linear-gradient(135deg, ${color}22 0%, ${color}44 100%);border:2px solid ${color};">
                            <div class="item-name">${item.name}</div>
                            <div class="item-price" style="color:${color};font-weight:700;">$${item.price.toFixed(2)}${item.billingCycle === 'monthly' ? '/mo' : '/yr'}</div>
                        </div>
                    `;
                }
                return `
                    <div class="item-card ${item.category}" onclick="showItemOptions('${item.name.replace(/'/g, "\\'")}', ${item.price}, '${item.category}')">
                        <div class="item-name">${item.name}</div>
                        <div class="item-price">$${item.price.toFixed(2)}</div>
                    </div>
                `;
            }).join('');
            document.getElementById('itemsModal').classList.add('active');
        }
        
        // Show membership sale modal - requires customer selection
        function showMembershipSaleModal(name, price, memberType, billingCycle) {
            closeItemsModal();
            
            const tierColors = { 'par': '#3498db', 'birdie': '#9b59b6', 'eagle': '#d4a017', 'family_par': '#3498db', 'family_birdie': '#9b59b6', 'family_eagle': '#d4a017', 'corporate': '#2c3e50' };
            const tierNames = { 'par': 'Par', 'birdie': 'Birdie', 'eagle': 'Eagle', 'family_par': 'Family Par', 'family_birdie': 'Family Birdie', 'family_eagle': 'Family Eagle', 'corporate': 'Corporate' };
            const discounts = { 'par': 10, 'birdie': 10, 'eagle': 15, 'family_par': 10, 'family_birdie': 10, 'family_eagle': 15, 'corporate': 20 };
            
            const color = tierColors[memberType] || '#9b59b6';
            const tierName = tierNames[memberType] || memberType;
            const discount = discounts[memberType] || 10;
            
            let html = `
                <div style="padding:24px;">
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="width:60px;height:60px;background:linear-gradient(135deg, ${color} 0%, ${color}dd 100%);border-radius:50%;margin:0 auto 12px;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-crown" style="font-size:28px;color:#fff;"></i>
                        </div>
                        <h3 style="font-size:20px;margin-bottom:4px;">${name}</h3>
                        <p style="color:${color};font-weight:700;font-size:24px;">$${price.toFixed(2)}<span style="font-size:14px;color:#888;">/${billingCycle === 'monthly' ? 'month' : 'year'}</span></p>
                    </div>
                    
                    <div style="background:#f8f9fa;border-radius:12px;padding:16px;margin-bottom:20px;">
                        <h4 style="font-size:13px;color:#666;margin-bottom:10px;"><i class="fas fa-gift" style="margin-right:6px;"></i> Member Benefits</h4>
                        <ul style="list-style:none;font-size:13px;color:#333;">
                            <li style="padding:4px 0;"><i class="fas fa-check" style="color:#27ae60;margin-right:8px;"></i> ${discount}% discount on F&B</li>
                            <li style="padding:4px 0;"><i class="fas fa-check" style="color:#27ae60;margin-right:8px;"></i> Priority bay reservations</li>
                            <li style="padding:4px 0;"><i class="fas fa-check" style="color:#27ae60;margin-right:8px;"></i> Free billiards & ping pong</li>
                            ${memberType.includes('eagle') || memberType.includes('birdie') ? '<li style="padding:4px 0;"><i class="fas fa-check" style="color:#27ae60;margin-right:8px;"></i> Unlimited simulator access</li>' : ''}
                        </ul>
                    </div>
                    
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-size:13px;color:#666;margin-bottom:6px;">Customer (required for membership)</label>
                        <input type="text" id="membershipCustomerSearch" placeholder="Search customer name or email..." 
                            style="width:100%;padding:12px;border:2px solid #e0e0e0;border-radius:8px;font-size:14px;"
                            oninput="searchMembershipCustomer(this.value)">
                        <div id="membershipCustomerResults" style="max-height:150px;overflow-y:auto;margin-top:8px;"></div>
                    </div>
                    
                    <div id="selectedMembershipCustomer" style="display:none;background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);border-radius:8px;padding:12px;margin-bottom:20px;border:1px solid #27ae60;">
                        <div style="display:flex;align-items:center;justify-content:space-between;">
                            <div>
                                <strong id="membershipCustomerName">-</strong>
                                <div style="font-size:12px;color:#666;" id="membershipCustomerEmail">-</div>
                            </div>
                            <button onclick="clearMembershipCustomer()" style="background:#e74c3c;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:11px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div style="display:flex;gap:10px;">
                        <button onclick="closeMembershipModal()" style="flex:1;padding:14px;background:#f0f0f0;border:none;border-radius:8px;font-size:14px;cursor:pointer;">Cancel</button>
                        <button id="addMembershipBtn" onclick="addMembershipToSale('${name.replace(/'/g, "\\'")}', ${price}, '${memberType}', '${billingCycle}')" 
                            style="flex:2;padding:14px;background:linear-gradient(135deg, ${color} 0%, ${color}dd 100%);color:#fff;border:none;border-radius:8px;font-size:14px;cursor:pointer;font-weight:600;opacity:0.5;" disabled>
                            <i class="fas fa-shopping-cart"></i> Add Membership to Sale
                        </button>
                    </div>
                </div>
            `;
            
            const modal = document.createElement('div');
            modal.id = 'membershipSaleModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:1002;';
            modal.innerHTML = `<div style="background:#fff;border-radius:16px;width:90%;max-width:450px;box-shadow:0 20px 60px rgba(0,0,0,0.3);">${html}</div>`;
            document.body.appendChild(modal);
            
            // Store membership info for later
            window._pendingMembership = { name, price, memberType, billingCycle };
        }
        
        // Search for customer in membership modal
        let _membershipCustomerSelection = null;
        function searchMembershipCustomer(query) {
            const resultsDiv = document.getElementById('membershipCustomerResults');
            if (query.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            const matches = stripeCustomersCache.filter(c => {
                const fullName = `${c.firstName || ''} ${c.lastName || ''}`.toLowerCase();
                return fullName.includes(query.toLowerCase()) || (c.email && c.email.toLowerCase().includes(query.toLowerCase()));
            }).slice(0, 5);
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = '<div style="padding:12px;color:#888;text-align:center;font-size:13px;">No customers found</div>';
                return;
            }
            
            resultsDiv.innerHTML = matches.map((c, idx) => {
                const initials = ((c.firstName || '')[0] || '') + ((c.lastName || '')[0] || '');
                const alreadyMember = isActiveMember(c);
                return `
                    <div onclick="selectMembershipCustomer(${idx})" 
                        style="padding:10px;display:flex;align-items:center;gap:10px;cursor:pointer;border-radius:8px;transition:background 0.15s;${alreadyMember ? 'opacity:0.5;' : ''}"
                        onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
                        <div style="width:36px;height:36px;background:#4a90a4;color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:600;font-size:13px;">${initials.toUpperCase()}</div>
                        <div style="flex:1;">
                            <div style="font-weight:500;">${c.firstName || ''} ${c.lastName || ''}${alreadyMember ? ' <span style="color:#e74c3c;font-size:11px;">(Already Member)</span>' : ''}</div>
                            <div style="font-size:12px;color:#888;">${c.email || c.phone || ''}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Store matches for selection
            resultsDiv._matches = matches;
        }
        
        function selectMembershipCustomer(idx) {
            const resultsDiv = document.getElementById('membershipCustomerResults');
            const matches = resultsDiv._matches || [];
            const customer = matches[idx];
            
            if (!customer) return;
            
            // Check if already a member
            if (isActiveMember(customer)) {
                showToast('This customer already has an active membership', 'error');
                return;
            }
            
            _membershipCustomerSelection = customer;
            resultsDiv.innerHTML = '';
            document.getElementById('membershipCustomerSearch').style.display = 'none';
            
            const selectedDiv = document.getElementById('selectedMembershipCustomer');
            selectedDiv.style.display = 'block';
            document.getElementById('membershipCustomerName').textContent = `${customer.firstName} ${customer.lastName}`;
            document.getElementById('membershipCustomerEmail').textContent = customer.email || customer.phone || '';
            
            // Enable the add button
            const addBtn = document.getElementById('addMembershipBtn');
            addBtn.disabled = false;
            addBtn.style.opacity = '1';
        }
        
        function clearMembershipCustomer() {
            _membershipCustomerSelection = null;
            document.getElementById('membershipCustomerSearch').style.display = 'block';
            document.getElementById('membershipCustomerSearch').value = '';
            document.getElementById('selectedMembershipCustomer').style.display = 'none';
            document.getElementById('membershipCustomerResults').innerHTML = '';
            
            const addBtn = document.getElementById('addMembershipBtn');
            addBtn.disabled = true;
            addBtn.style.opacity = '0.5';
        }
        
        function closeMembershipModal() {
            const modal = document.getElementById('membershipSaleModal');
            if (modal) modal.remove();
            _membershipCustomerSelection = null;
            window._pendingMembership = null;
        }
        
        function addMembershipToSale(name, price, memberType, billingCycle) {
            if (!_membershipCustomerSelection) {
                showToast('Please select a customer for the membership', 'error');
                return;
            }
            
            // Add membership as a sale item with customer info attached
            const membershipItem = {
                name: name,
                price: price,
                qty: 1,
                discount: 0,
                category: 'membership',
                isMembership: true,
                memberType: memberType,
                billingCycle: billingCycle,
                customerId: _membershipCustomerSelection.id || _membershipCustomerSelection.stripeId,
                customerName: `${_membershipCustomerSelection.firstName} ${_membershipCustomerSelection.lastName}`,
                customerEmail: _membershipCustomerSelection.email
            };
            
            saleItems.push(membershipItem);
            renderSaleItems();
            updateTotals();
            
            closeMembershipModal();
            showToast(`${name} added for ${_membershipCustomerSelection.firstName} ${_membershipCustomerSelection.lastName}`, 'success');
        }
        
        function closeItemsModal() {
            document.getElementById('itemsModal').classList.remove('active');
        }
        
        function searchItems(query) {
            if (query.length < 2) return;
            const filtered = items.filter(i => i.name.toLowerCase().includes(query.toLowerCase()));
            if (filtered.length > 0) {
                showItemsModal('Search Results', filtered);
            }
        }
        
        // Add item quickly - no popup, direct add to active tab or current sale
        function showItemOptions(name, price, category) {
            // Close the items modal immediately for speed
            closeItemsModal();
            
            // If there's an active tab, add directly to it
            if (window.activeTabId) {
                addToTabDirect(window.activeTabId, name, price, category);
                return;
            }
            
            // Otherwise add to current sale
            addItem(name, price);
        }
        
        function closeItemOptionsModal() {
            const modal = document.getElementById('itemOptionsModal');
            if (modal) modal.remove();
        }
        
        function addItemAndClose(name, price) {
            closeItemOptionsModal();
            addItem(name, price);
        }
        
        async function addToTabDirect(tabId, name, price, category) {
            closeItemOptionsModal();
            closeItemsModal();
            
            const item = { name, price: parseFloat(price) || 0, qty: 1, category: category || 'misc' };
            const employeeName = getCurrentUserName();
            
            try {
                if (typeof TabsSync !== 'undefined' && TabsSync.addItemsToTab) {
                    await TabsSync.addItemsToTab(tabId, [item], employeeName);
                    const tab = TabsSync.getTab(tabId);
                    showToast(`Added ${name} to ${tab?.customer || 'Guest'}'s tab`, 'success');
                    
                    // If this is the active tab, also update local saleItems display
                    if (window.activeTabId && String(window.activeTabId) === String(tabId) && tab) {
                        saleItems = (tab.items || []).map((it, i) => ({
                            id: Date.now() + i,
                            name: it.name || 'Unknown Item',
                            price: parseFloat(it.price) || 0,
                            qty: parseInt(it.qty) || 1,
                            discount: 0,
                            category: it.category || 'misc'
                        }));
                        renderSaleItems();
                    }
                } else {
                    // Fallback: update localStorage directly
                    const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                    const tabIndex = tabs.findIndex(t => String(t.id) === String(tabId));
                    if (tabIndex >= 0) {
                        if (!tabs[tabIndex].items) tabs[tabIndex].items = [];
                        tabs[tabIndex].items.push(item);
                        tabs[tabIndex].total = (tabs[tabIndex].total || 0) + item.price;
                        tabs[tabIndex].amount = tabs[tabIndex].total;
                        localStorage.setItem('gc_tabs', JSON.stringify(tabs));
                        showToast(`Added ${name} to ${tabs[tabIndex].customer || 'Guest'}'s tab`, 'success');
                        
                        // If this is the active tab, also update local saleItems display
                        if (window.activeTabId && String(window.activeTabId) === String(tabId)) {
                            saleItems = (tabs[tabIndex].items || []).map((it, i) => ({
                                id: Date.now() + i,
                                name: it.name || 'Unknown Item',
                                price: parseFloat(it.price) || 0,
                                qty: parseInt(it.qty) || 1,
                                discount: 0,
                                category: it.category || 'misc'
                            }));
                            renderSaleItems();
                        }
                    } else {
                        showToast('Tab not found', 'error');
                    }
                }
                renderOpenTabs();
            } catch (error) {
                console.error('Error adding to tab:', error);
                showToast('Failed to add item to tab', 'error');
            }
        }
        
        // ============ SALE ITEMS ============
        function addItem(name, price) {
            const existing = saleItems.find(i => i.name === name);
            if (existing) {
                existing.qty++;
            } else {
                saleItems.push({ name, price, qty: 1, discount: 0, taxable: true });
            }
            renderSaleItems();
            showToast(`Added: ${name}`);
        }
        
        function removeItem(index) {
            const item = saleItems[index];
            saleItems.splice(index, 1);
            renderSaleItems();
            showToast(`Removed: ${item.name}`);
        }
        
        function changeQty(index, delta) {
            saleItems[index].qty += delta;
            if (saleItems[index].qty <= 0) {
                saleItems.splice(index, 1);
            }
            renderSaleItems();
        }
        
        function updateQty(index, value) {
            const qty = parseInt(value) || 1;
            if (qty <= 0) {
                saleItems.splice(index, 1);
            } else {
                saleItems[index].qty = qty;
            }
            renderSaleItems();
        }
        
        function updatePrice(index, value) {
            saleItems[index].price = Math.max(0, parseFloat(value) || 0);
            renderSaleItems();
        }
        
        function updateDiscount(index, value) {
            saleItems[index].discount = Math.max(0, Math.min(100, parseFloat(value) || 0));
            renderSaleItems();
        }
        
        function toggleItemTaxable(index) {
            saleItems[index].taxable = !saleItems[index].taxable;
            renderSaleItems();
        }
        
        function renderSaleItems() {
            const tbody = document.getElementById('saleItemsBody');
            
            if (saleItems.length === 0) {
                tbody.innerHTML = `
                    <tr class="empty-row">
                        <td colspan="6">
                            <div class="empty-sale">
                                <i class="fas fa-shopping-cart"></i>
                                <p>0 Items</p>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = saleItems.map((item, i) => {
                    const itemTotal = item.price * item.qty * (1 - item.discount / 100);
                    return `
                        <tr class="${item.taxable ? 'taxable-row' : ''}">
                            <td>
                                <div class="item-name-cell">
                                    <input type="checkbox" class="item-checkbox" ${item.taxable ? 'checked' : ''} 
                                           onclick="toggleItemTaxable(${i})" title="Taxable">
                                    <span class="item-name">${item.name}</span>
                                </div>
                            </td>
                            <td><input type="text" class="inline-input price-input" value="${item.price.toFixed(2)}" 
                                       onchange="updatePrice(${i}, this.value)" onclick="this.select()"></td>
                            <td><input type="text" class="inline-input qty-input" value="${item.qty}" 
                                       onchange="updateQty(${i}, this.value)" onclick="this.select()"></td>
                            <td><input type="text" class="inline-input disc-input" value="${item.discount}" 
                                       onchange="updateDiscount(${i}, this.value)" onclick="this.select()" placeholder="%"></td>
                            <td class="item-total">$${itemTotal.toFixed(2)}</td>
                            <td><button class="item-remove" onclick="removeItem(${i})" title="Remove">&times;</button></td>
                        </tr>
                    `;
                }).join('');
            }
            
            updateTotals();
        }
        
        function updateTotals() {
            const subtotal = saleItems.reduce((sum, item) => {
                return sum + (item.price * item.qty * (1 - item.discount / 100));
            }, 0);
            const tax = calculateTax(subtotal);
            const total = subtotal + tax;
            
            // Calculate member discount amount if applied
            const discountRow = document.getElementById('discountRow');
            if (memberDiscountApplied && selectedCustomer && isActiveMember(selectedCustomer)) {
                const originalSubtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
                const discountAmt = originalSubtotal - subtotal;
                const discountPercent = getMemberDiscount(selectedCustomer.memberType);
                
                if (discountRow) {
                    discountRow.style.display = 'flex';
                    document.getElementById('discountAmt').textContent = `-$${discountAmt.toFixed(2)} (${discountPercent}% ${getMemberTierName(selectedCustomer.memberType)})`;
                }
            } else if (discountRow) {
                // Check if any manual discounts are applied
                const hasManualDiscount = saleItems.some(i => i.discount > 0);
                if (hasManualDiscount) {
                    const originalSubtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty), 0);
                    const discountAmt = originalSubtotal - subtotal;
                    discountRow.style.display = discountAmt > 0 ? 'flex' : 'none';
                    document.getElementById('discountAmt').textContent = `-$${discountAmt.toFixed(2)}`;
                } else {
                    discountRow.style.display = 'none';
                }
            }
            
            document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('taxAmt').textContent = '$' + tax.toFixed(2);
            document.getElementById('totalDue').textContent = '$' + total.toFixed(2);
            // Also update the large total display
            const largeTotalEl = document.getElementById('totalDueLarge');
            if (largeTotalEl) largeTotalEl.textContent = '$' + total.toFixed(2);
        }
        
        // ============ MODE ============
        function setMode(mode, btn) {
            isReturnMode = (mode === 'return');
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('saleArea').classList.toggle('return-mode', isReturnMode);
            showToast(isReturnMode ? 'Return mode active' : 'Sale mode active', isReturnMode ? 'error' : 'success');
        }
        
        // ============ PAYMENT ============
        let pendingPaymentTotal = 0;
        let pendingPaymentCustomer = '';
        
        // Stripe Configuration
        const STRIPE_CONFIG = {
            publishableKey: localStorage.getItem('gc_stripe_pk') || '', // Set via settings
            terminalLocationId: localStorage.getItem('gc_stripe_location') || '',
            isTestMode: true
        };
        
        let stripeTerminal = null;
        let discoveredReaders = [];
        let connectedReader = null;
        
        // Initialize Stripe Terminal
        async function initStripeTerminal() {
            // Simulated readers work even without a publishable key for testing
            try {
                stripeTerminal = StripeTerminal.create({
                    onFetchConnectionToken: fetchConnectionToken,
                    onUnexpectedReaderDisconnect: handleDisconnect
                });
                console.log('Stripe Terminal initialized');
                showToast('Stripe Terminal initialized', 'success');
            } catch (e) {
                console.error('Stripe Terminal init failed:', e);
                showToast('Stripe Terminal init failed: ' + e.message, 'error');
            }
        }
        
        async function fetchConnectionToken() {
            // Calls Firebase function to get Stripe Terminal connection token
            try {
                const response = await fetch('https://us-central1-golfcove.cloudfunctions.net/createConnectionToken');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                console.log('Got connection token');
                return data.secret;
            } catch (e) {
                console.error('Failed to fetch connection token:', e);
                throw e;
            }
        }
        
        function handleDisconnect() {
            showToast('Card reader disconnected', 'error');
            connectedReader = null;
            updateReaderStatus();
        }
        
        async function discoverReaders() {
            if (!stripeTerminal) {
                // Try to initialize if not done yet
                await initStripeTerminal();
                if (!stripeTerminal) {
                    showToast('Stripe Terminal not available', 'error');
                    return;
                }
            }
            
            showToast('Searching for card readers...', 'info');
            const config = { simulated: STRIPE_CONFIG.isTestMode };
            console.log('Discovering readers with config:', config);
            
            try {
                const discoverResult = await stripeTerminal.discoverReaders(config);
                console.log('Discover result:', discoverResult);
                
                if (discoverResult.error) {
                    showToast('Reader discovery failed: ' + discoverResult.error.message, 'error');
                    return;
                }
                
                discoveredReaders = discoverResult.discoveredReaders;
                console.log('Found readers:', discoveredReaders);
                
                if (discoveredReaders.length === 0) {
                    showToast('No readers found', 'error');
                    return;
                }
                
                showReaderSelectionModal();
            } catch (e) {
                console.error('Discovery error:', e);
                showToast('Discovery error: ' + e.message, 'error');
            }
        }
        
        function showReaderSelectionModal() {
            const html = discoveredReaders.map((r, i) => 
                `<div style="padding:12px;border:1px solid #ddd;border-radius:8px;margin-bottom:8px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="connectReader(${i})">
                    <div><strong>${r.label || r.serial_number}</strong><br><small style="color:#888;">${r.device_type}</small></div>
                    <i class="fas fa-chevron-right"></i>
                </div>`
            ).join('');
            
            showGenericModal('Select Card Reader', html, 'readerModal');
        }
        
        async function connectReader(index) {
            const reader = discoveredReaders[index];
            hideGenericModal('readerModal');
            showToast('Connecting to reader...', 'info');
            
            try {
                // Connect to the reader (simulated readers don't need special config)
                console.log('Connecting to reader:', reader);
                
                const connectResult = await stripeTerminal.connectReader(reader);
                console.log('Connect result:', connectResult);
                
                if (connectResult.error) {
                    console.error('Connection error details:', connectResult.error);
                    showToast('Connection failed: ' + connectResult.error.message, 'error');
                    return;
                }
                
                connectedReader = connectResult.reader;
                showToast('Reader connected: ' + (connectedReader.label || connectedReader.serial_number), 'success');
                updateReaderStatus();
            } catch (e) {
                console.error('Connection exception:', e);
                showToast('Connection error: ' + e.message, 'error');
            }
        }
        
        function updateReaderStatus() {
            const indicator = document.getElementById('readerStatus');
            if (indicator) {
                indicator.innerHTML = connectedReader 
                    ? `<i class="fas fa-check-circle" style="color:#27ae60;"></i> ${connectedReader.label || 'Reader'}`
                    : '<i class="fas fa-times-circle" style="color:#e74c3c;"></i> No reader';
            }
        }
        
        function processPayment(method) {
            if (saleItems.length === 0) {
                return showToast('No items in sale', 'error');
            }
            
            const subtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty * (1 - item.discount / 100)), 0);
            const total = subtotal * (1 + getTaxRate());
            const customer = document.getElementById('customerName').value || 'Walk-in';
            pendingPaymentTotal = total;
            pendingPaymentCustomer = customer;
            
            // For cash, show cash tendering modal
            if (method === 'cash' && !isReturnMode) {
                showCashModal(total, customer);
                return;
            }
            
            // For card payments via Stripe Terminal
            if (method === 'card' && !isReturnMode) {
                processStripePayment(total, customer);
                return;
            }
            
            // For saved card payments (members only)
            if (method === 'saved' && !isReturnMode) {
                processSavedCardPayment(total, customer);
                return;
            }
            
            completePayment(method, customer, total);
        }
        
        // Process payment with saved card
        async function processSavedCardPayment(total, customerName) {
            // Find customer record
            const customerRecord = findCustomerRecord(customerName);
            
            if (!customerRecord) {
                showToast('Please select a member customer first', 'error');
                return;
            }
            
            if (!customerRecord.stripeCustomerId) {
                showToast('This customer has no saved cards. Add a card first.', 'info');
                return;
            }
            
            const amountCents = Math.round(total * 100);
            
            // Show saved cards checkout modal
            const hasCards = await SavedCards.showSavedCardsCheckout(
                customerRecord,
                amountCents,
                (result) => {
                    // Payment completed
                    completePayment('saved_card', customerName, total, result.paymentIntentId);
                }
            );
            
            if (!hasCards) {
                showToast('No saved cards for this customer', 'info');
            }
        }
        
        // Find customer record by name (uses Stripe cache first)
        function findCustomerRecord(customerName) {
            if (!customerName || customerName === 'Walk-in') return null;
            
            // If we have a selected customer already, use that
            if (selectedCustomer) return selectedCustomer;
            
            // Search in Stripe customers cache (loaded fresh from API)
            const customers = stripeCustomersCache;
            
            const nameParts = customerName.trim().split(' ');
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ');
            
            return customers.find(c => 
                (c.firstName || '').toLowerCase() === firstName?.toLowerCase() &&
                (c.lastName || '').toLowerCase() === lastName?.toLowerCase()
            );
        }
        
        // Add a card to current customer
        async function addCardToCustomer() {
            const customerName = document.getElementById('customerName').value;
            const customerRecord = findCustomerRecord(customerName);
            
            if (!customerRecord) {
                showToast('Please select a customer first (not Walk-in)', 'error');
                return;
            }
            
            SavedCards.showAddCardModal(customerRecord, (paymentMethodId) => {
                showToast(`Card saved to ${customerName}'s profile`, 'success');
            });
        }
        
        async function processStripePayment(total, customer) {
            // If no Stripe configured or no reader, fall back to manual
            if (!stripeTerminal || !connectedReader) {
                // Simulate/manual card entry
                showManualCardModal(total, customer);
                return;
            }
            
            showToast('Processing card payment...', 'info');
            
            try {
                // Create payment intent on backend (in production)
                // For demo, we simulate this
                const paymentIntentClientSecret = await createPaymentIntent(total, customer);
                
                // Collect payment method
                const collectResult = await stripeTerminal.collectPaymentMethod(paymentIntentClientSecret);
                if (collectResult.error) {
                    showToast('Card read failed: ' + collectResult.error.message, 'error');
                    return;
                }
                
                // Process the payment
                const processResult = await stripeTerminal.processPayment(collectResult.paymentIntent);
                if (processResult.error) {
                    showToast('Payment failed: ' + processResult.error.message, 'error');
                    return;
                }
                
                if (processResult.paymentIntent.status === 'succeeded') {
                    completePayment('card', customer, total, processResult.paymentIntent.id);
                } else {
                    // Capture on backend if needed
                    await capturePayment(processResult.paymentIntent.id);
                    completePayment('card', customer, total, processResult.paymentIntent.id);
                }
            } catch (e) {
                showToast('Payment error: ' + e.message, 'error');
            }
        }
        
        async function createPaymentIntent(amount, customer) {
            // In production, call your backend:
            // const response = await fetch('/api/stripe/create-payment-intent', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ amount: Math.round(amount * 100), customer })
            // });
            // const data = await response.json();
            // return data.client_secret;
            
            // For demo/testing without backend:
            console.log('Would create PaymentIntent for $' + amount.toFixed(2));
            return 'pi_demo_' + Date.now();
        }
        
        async function capturePayment(paymentIntentId) {
            // In production, call your backend to capture
            console.log('Would capture payment:', paymentIntentId);
        }
        
        function showManualCardModal(total, customer) {
            const modalHtml = `
                <div id="manualCardModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;">
                        <h3 style="margin:0 0 15px;color:#3498db;"><i class="fas fa-credit-card"></i> Card Payment</h3>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;">
                            <div style="font-size:1.5em;font-weight:700;">$${total.toFixed(2)}</div>
                            <div style="color:#888;font-size:0.9em;">${customer}</div>
                        </div>
                        <div style="margin-bottom:15px;padding:15px;background:#e3f2fd;border-radius:8px;text-align:center;">
                            <i class="fas fa-info-circle" style="color:#2196f3;"></i>
                            <span style="margin-left:8px;">Process card on external terminal or enter manually</span>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Last 4 digits (optional):</label>
                            <input type="text" id="cardLast4" maxlength="4" pattern="[0-9]*" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;" placeholder="0000">
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Auth Code (optional):</label>
                            <input type="text" id="authCode" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;" placeholder="Authorization code">
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeManualCardModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="submitManualCard('${customer}')" style="flex:1;padding:12px;border:none;background:#3498db;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Approve</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }
        
        function closeManualCardModal() {
            const modal = document.getElementById('manualCardModal');
            if (modal) modal.remove();
        }
        
        function submitManualCard(customer) {
            const last4 = document.getElementById('cardLast4').value || '****';
            const authCode = document.getElementById('authCode').value || '';
            closeManualCardModal();
            completePayment('card', customer, pendingPaymentTotal, null, { last4, authCode });
        }
        
        function showCashModal(total, customer) {
            const modalHtml = `
                <div id="cashModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;">
                        <h3 style="margin:0 0 15px;color:#27ae60;"><i class="fas fa-money-bill-wave"></i> Cash Payment</h3>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;font-size:1.3em;font-weight:700;">
                                <span>Total Due:</span><span>$${total.toFixed(2)}</span>
                            </div>
                        </div>
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Cash Tendered:</label>
                            <input type="number" id="cashTenderedInput" step="0.01" min="0" style="width:100%;padding:12px;font-size:1.2em;border:2px solid #ddd;border-radius:6px;box-sizing:border-box;" onkeyup="updateCashChange()" autofocus>
                        </div>
                        <div style="display:flex;gap:8px;margin-bottom:15px;">
                            <button onclick="setCashAmount(20)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$20</button>
                            <button onclick="setCashAmount(50)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$50</button>
                            <button onclick="setCashAmount(100)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">$100</button>
                            <button onclick="setCashAmount(${total.toFixed(2)})" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:4px;cursor:pointer;">Exact</button>
                        </div>
                        <div id="changeDisplay" style="display:none;background:#d4edda;padding:15px;border-radius:8px;margin-bottom:15px;text-align:center;">
                            <span style="font-size:0.9em;">Change Due:</span>
                            <span id="changeAmount" style="font-size:1.5em;font-weight:700;display:block;">$0.00</span>
                        </div>
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeCashModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="submitCashPayment('${customer}')" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Complete</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            document.getElementById('cashTenderedInput').focus();
        }
        
        function setCashAmount(amount) {
            document.getElementById('cashTenderedInput').value = parseFloat(amount).toFixed(2);
            updateCashChange();
        }
        
        function updateCashChange() {
            const tendered = parseFloat(document.getElementById('cashTenderedInput').value) || 0;
            const changeDisplay = document.getElementById('changeDisplay');
            if (tendered >= pendingPaymentTotal) {
                const change = tendered - pendingPaymentTotal;
                document.getElementById('changeAmount').textContent = '$' + change.toFixed(2);
                changeDisplay.style.display = 'block';
            } else {
                changeDisplay.style.display = 'none';
            }
        }
        
        function closeCashModal() {
            const modal = document.getElementById('cashModal');
            if (modal) modal.remove();
        }
        
        function submitCashPayment(customer) {
            const tendered = parseFloat(document.getElementById('cashTenderedInput').value) || 0;
            if (tendered < pendingPaymentTotal) {
                showToast('Insufficient cash tendered', 'error');
                return;
            }
            const change = tendered - pendingPaymentTotal;
            closeCashModal();
            completePayment('cash', customer, pendingPaymentTotal, null, { tendered, change });
        }
        
        function completePayment(method, customer, total, stripePaymentId = null, paymentDetails = {}) {
            const now = new Date();
            const subtotal = total / (1 + getTaxRate());
            const tax = total - subtotal;
            
            const transaction = {
                id: 26763 + transactions.length,
                customer: customer,
                amount: isReturnMode ? -total : total,
                subtotal: subtotal,
                tax: tax,
                method: method,
                time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: now.toISOString(),
                itemCount: saleItems.length,
                itemDetails: saleItems.map(i => ({ name: i.name, qty: i.qty, price: i.price, discount: i.discount })),
                isReturn: isReturnMode,
                stripePaymentId: stripePaymentId,
                paymentDetails: paymentDetails,
                register: localStorage.getItem('gc_register_id') || 'POS-1',
                employee: getCurrentUserName()
            };
            
            transactions.unshift(transaction);
            saveTransactions();
            
            // Sync to Firebase
            syncTransactionToFirebase(transaction);
            
            // Deduct inventory for sold items
            if (!isReturnMode) {
                deductInventory(saleItems);
            }
            
            // Update customer stats if not walk-in
            if (customer !== 'Walk-in') {
                updateCustomerStats(customer, total);
                // Award loyalty points for completed sales
                if (!isReturnMode) {
                    awardLoyaltyPoints(customer, total);
                }
            }
            
            // Update daily sales tracking
            updateDailySales(total, method);
            
            // Update cash drawer if cash payment
            if (method === 'cash' && !isReturnMode) {
                updateCashDrawer(total, 'in');
                // Kick physical drawer on cash sale
                if (window.CashDrawer) {
                    CashDrawer.kick();
                }
            } else if (method === 'cash' && isReturnMode) {
                updateCashDrawer(total, 'out');
                // Kick physical drawer on cash refund
                if (window.CashDrawer) {
                    CashDrawer.kick();
                }
            }
            
            const actionWord = isReturnMode ? 'Return' : 'Payment';
            showToast(`${actionWord} of $${total.toFixed(2)} processed via ${method}!`, 'success');
            
            // Show print receipt option
            if (!isReturnMode && confirm('Print receipt?')) {
                printReceipt(customer, total, method, [...saleItems], transaction.id);
            }
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderTransactions();
        }
        
        function updateCustomerStats(customerName, amount) {
            // Stats are tracked in Stripe metadata, not locally
            // This is a no-op now - stats should be updated via Stripe API if needed
            console.log(`[Sales] Customer stats: ${customerName} spent $${amount}`);
        }
        
        function updateDailySales(amount, method) {
            const today = new Date().toDateString();
            const dailyData = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            if (!dailyData[today]) {
                dailyData[today] = { total: 0, count: 0, cash: 0, card: 0, items: 0 };
            }
            dailyData[today].total += amount;
            dailyData[today].count += 1;
            dailyData[today][method] = (dailyData[today][method] || 0) + amount;
            localStorage.setItem('gc_daily_sales', JSON.stringify(dailyData));
        }
        
        function updateCashDrawer(amount, type) {
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            
            if (!drawer[today]) return; // Drawer not opened
            
            if (type === 'in') {
                drawer[today].cashIn = (drawer[today].cashIn || 0) + amount;
            } else {
                drawer[today].cashOut = (drawer[today].cashOut || 0) + amount;
            }
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
        }
        
        function printReceipt(customer, total, method, items, transId) {
            const subtotal = total / (1 + getTaxRate());
            const tax = total - subtotal;
            const now = new Date();
            
            // Get business info from centralized config
            const config = window.GolfCoveConfig || {};
            const business = config.business || {};
            const addr = business.address || {};
            const businessName = business.name || 'Golf Cove';
            const businessAddress = addr.street || '336 State Street';
            const businessCity = addr.city || 'North Haven';
            const businessState = addr.state || 'CT';
            const businessZip = addr.zip || '06473';
            const businessPhone = business.phone || '(203) 555-0100';
            const businessWebsite = (business.website || 'golfcove.com').replace('https://', '').replace('http://', '');
            
            const receiptWindow = window.open('', '_blank', 'width=350,height=600');
            var html = '<html><head><title>Receipt</title><style>';
            html += 'body { font-family: "Courier New", monospace; font-size: 12px; width: 280px; margin: 0 auto; padding: 10px; }';
            html += '.center { text-align: center; } .bold { font-weight: bold; }';
            html += '.line { border-top: 1px dashed #000; margin: 8px 0; }';
            html += '.row { display: flex; justify-content: space-between; margin: 3px 0; }';
            html += '.total-row { font-size: 14px; font-weight: bold; }';
            html += 'h2 { margin: 5px 0; font-size: 16px; }';
            html += '.trans-id { font-size: 10px; color: #666; margin-top: 5px; }';
            html += '</style></head><bo' + 'dy>';
            html += '<div class="center"><h2>⛳ ' + businessName.toUpperCase() + '</h2>';
            html += '<p>' + businessAddress + '<br>' + businessCity + ', ' + businessState + ' ' + businessZip + '<br>' + businessPhone + '</p></div>';
            html += '<div class="line"></div>';
            html += '<div class="row"><span>Trans #:</span><span>' + (transId || 'N/A') + '</span></div>';
            html += '<div class="row"><span>Date:</span><span>' + now.toLocaleDateString() + '</span></div>';
            html += '<div class="row"><span>Time:</span><span>' + now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) + '</span></div>';
            html += '<div class="row"><span>Customer:</span><span>' + customer + '</span></div>';
            html += '<div class="row"><span>Cashier:</span><span>' + (currentUser?.name || 'Staff') + '</span></div>';
            html += '<div class="line"></div>';
            items.forEach(function(item) {
                const itemTotal = (item.price * item.qty * (1 - (item.discount || 0)/100));
                html += '<div class="row"><span>' + item.name + ' x' + item.qty + '</span><span>$' + itemTotal.toFixed(2) + '</span></div>';
                if (item.discount > 0) html += '<div style="font-size:10px;color:#666;margin-left:10px;">(' + item.discount + '% disc)</div>';
            });
            html += '<div class="line"></div>';
            html += '<div class="row"><span>Subtotal:</span><span>$' + subtotal.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>' + getTaxLabel() + ':</span><span>$' + tax.toFixed(2) + '</span></div>';
            html += '<div class="line"></div>';
            html += '<div class="row total-row"><span>TOTAL:</span><span>$' + total.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>Paid:</span><span>' + method.toUpperCase() + '</span></div>';
            html += '<div class="line"></div>';
            html += '<div class="center" style="margin-top:10px;">';
            html += '<p>Thank you for visiting!</p>';
            html += '<p style="font-size:10px;">Visit us at ' + businessWebsite + '</p>';
            html += '<p style="font-size:10px;">⛳ See you on the greens! ⛳</p>';
            html += '</div>';
            html += '</bo' + 'dy></ht' + 'ml>';
            receiptWindow.document.write(html);
            receiptWindow.document.close();
            receiptWindow.print();
        }
        
        function applyDiscount() {
            if (saleItems.length === 0) return showToast('Add items first', 'error');
            
            // Check permission
            if (!hasPermission('canDiscount')) {
                return showToast('You do not have permission to apply discounts', 'error');
            }
            
            const maxDisc = rolePermissions[currentUser.role]?.maxDiscount || 0;
            const pct = prompt('Enter discount percentage (max ' + maxDisc + '%):');
            if (pct === null) return;
            
            let discPct = Math.max(0, parseFloat(pct) || 0);
            if (discPct > maxDisc) {
                showToast('Max discount for your role is ' + maxDisc + '%', 'error');
                discPct = maxDisc;
            }
            
            saleItems.forEach(item => item.discount = discPct);
            renderSaleItems();
            showToast(discPct + '% discount applied to all items');
        }
        
        function clearSale() {
            if (saleItems.length === 0) return;
            saleItems = [];
            selectedCustomer = null;
            memberDiscountApplied = false;
            document.getElementById('customerName').value = '';
            renderSaleItems();
            showToast('Sale cleared');
        }
        
        // ============ SUSPEND / RESUME ============
        function suspendSale() {
            if (saleItems.length === 0) return showToast('No items to suspend', 'error');
            
            const customer = document.getElementById('customerName').value || 'Walk-in';
            const subtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty * (1 - item.discount / 100)), 0);
            
            suspendedSales.push({
                id: Date.now(),
                customer: customer,
                amount: subtotal * (1 + getTaxRate()),
                items: [...saleItems],
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })
            });
            localStorage.setItem('gc_suspended', JSON.stringify(suspendedSales));
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderSuspended();
            showToast('Sale suspended');
        }
        
        function resumeSale(id) {
            const sale = suspendedSales.find(s => s.id === id);
            if (sale) {
                saleItems = sale.items.map(i => ({ ...i }));
                document.getElementById('customerName').value = sale.customer;
                suspendedSales = suspendedSales.filter(s => s.id !== id);
                localStorage.setItem('gc_suspended', JSON.stringify(suspendedSales));
                renderSaleItems();
                renderSuspended();
                showToast('Sale resumed');
            }
        }
        
        // ============ TAB ============
        async function startTab() {
            if (saleItems.length === 0) return showToast('Add items first', 'error');
            
            const customerName = document.getElementById('customerName').value || prompt('Customer name for tab:');
            if (!customerName) return;
            
            // Get customer info for member status
            const customer = selectedCustomer || findCustomerByName(customerName);
            const customerId = customer?.id || customer?.stripeId || null;
            
            // Format items for TabsSync
            const items = saleItems.map(item => ({
                name: item.name,
                price: (parseFloat(item.price) || 0) * (1 - (item.discount || 0) / 100),
                qty: parseInt(item.qty) || 1,
                category: item.category || 'misc'
            }));
            
            const employeeName = getCurrentUserName();
            
            try {
                if (typeof TabsSync !== 'undefined') {
                    // Use TabsSync for global tab management
                    const existingTab = TabsSync.getTabByCustomer ? TabsSync.getTabByCustomer(customerName) : null;
                    
                    if (existingTab) {
                        // Add to existing tab
                        await TabsSync.addItemsToTab(existingTab.id, items, employeeName);
                        showToast(`Added ${items.length} item(s) to ${customerName}'s tab`);
                    } else {
                        // Create new tab with customer ID for member lookup
                        // Also pass member info directly as options
                        const options = {};
                        if (customer) {
                            options.isMember = isActiveMember(customer);
                            options.memberType = customer.memberType;
                            options.isLeague = customer.isLeague;
                        }
                        await TabsSync.createTab(customerName, customerId, items, employeeName, options);
                        showToast(`Tab started for ${customerName}`);
                    }
                } else {
                    // Fallback: store in localStorage
                    const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                    const existingIndex = tabs.findIndex(t => t.customer && t.customer.toLowerCase() === customerName.toLowerCase());
                    
                    if (existingIndex >= 0) {
                        // Add to existing tab
                        if (!tabs[existingIndex].items) tabs[existingIndex].items = [];
                        tabs[existingIndex].items.push(...items);
                        const itemsTotal = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                        tabs[existingIndex].total = (tabs[existingIndex].total || 0) + itemsTotal;
                        tabs[existingIndex].amount = tabs[existingIndex].total;
                        showToast(`Added ${items.length} item(s) to ${customer}'s tab`);
                    } else {
                        // Create new tab
                        const itemsTotal = items.reduce((sum, i) => sum + (i.price * i.qty), 0);
                        const newTab = {
                            id: Date.now().toString(),
                            customer: customer,
                            items: items,
                            total: itemsTotal,
                            amount: itemsTotal,
                            createdAt: new Date().toISOString(),
                            openedAt: new Date().toISOString(),
                            openedBy: employeeName
                        };
                        tabs.push(newTab);
                        showToast(`Tab started for ${customer}`);
                    }
                    localStorage.setItem('gc_tabs', JSON.stringify(tabs));
                }
                
                saleItems = [];
                document.getElementById('customerName').value = '';
                renderSaleItems();
                renderOpenTabs();
            } catch (error) {
                console.error('Error starting tab:', error);
                showToast('Failed to start tab', 'error');
            }
        }
        
        // Quick Add to Tab (for single item)
        async function quickAddToTab(itemName, itemPrice, category) {
            // Show tab selector modal - get tabs with fallback
            let tabs = [];
            if (typeof TabsSync !== 'undefined') {
                tabs = TabsSync.getTabs() || [];
            } else {
                try {
                    tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                } catch (e) {
                    tabs = [];
                }
            }
            
            let html = '<div style="padding:20px;">';
            html += '<h3 style="margin-bottom:15px;">Add to Tab</h3>';
            html += '<div style="margin-bottom:15px;padding:10px;background:#f5f5f5;border-radius:8px;">';
            html += `<strong>${itemName}</strong> - $${(parseFloat(itemPrice) || 0).toFixed(2)}`;
            html += '</div>';
            
            if (tabs.length > 0) {
                html += '<div style="margin-bottom:15px;">';
                html += '<label style="font-size:13px;color:#666;">Select Tab:</label>';
                html += '<select id="tabSelect" style="width:100%;padding:10px;margin-top:5px;border:1px solid #ddd;border-radius:6px;font-size:14px;">';
                tabs.forEach(t => {
                    const tabTotal = t.total || t.amount || 0;
                    html += `<option value="${t.id}">${t.customer || 'Guest'} - $${tabTotal.toFixed(2)} (${t.items?.length||0} items)</option>`;
                });
                html += '<option value="new">+ New Tab</option>';
                html += '</select></div>';
            }
            
            html += '<div style="margin-bottom:15px;" id="newTabNameDiv"' + (tabs.length > 0 ? ' style="display:none;"' : '') + '>';
            html += '<label style="font-size:13px;color:#666;">Customer Name:</label>';
            html += '<input type="text" id="newTabName" placeholder="Customer name" style="width:100%;padding:10px;margin-top:5px;border:1px solid #ddd;border-radius:6px;font-size:14px;">';
            html += '</div>';
            
            html += '<div style="display:flex;gap:10px;">';
            html += '<button onclick="closeQuickTabModal()" style="flex:1;padding:12px;background:#f0f0f0;border:none;border-radius:6px;cursor:pointer;">Cancel</button>';
            html += `<button onclick="confirmAddToTab('${itemName}', ${itemPrice}, '${category || 'misc'}')" style="flex:1;padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">Add to Tab</button>`;
            html += '</div></div>';
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'quickTabModal';
            modal.style.cssText = 'position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;';
            modal.innerHTML = `<div style="background:#fff;border-radius:12px;width:90%;max-width:400px;">${html}</div>`;
            document.body.appendChild(modal);
            
            // Handle select change
            const select = document.getElementById('tabSelect');
            if (select) {
                select.onchange = () => {
                    document.getElementById('newTabNameDiv').style.display = select.value === 'new' ? 'block' : 'none';
                };
            }
        }
        
        function closeQuickTabModal() {
            const modal = document.getElementById('quickTabModal');
            if (modal) modal.remove();
        }
        
        async function confirmAddToTab(itemName, itemPrice, category) {
            const select = document.getElementById('tabSelect');
            const tabId = select ? select.value : 'new';
            const item = { name: itemName, price: parseFloat(itemPrice) || 0, qty: 1, category: category || 'misc' };
            const employeeName = getCurrentUserName();
            
            try {
                if (tabId === 'new') {
                    const customerName = document.getElementById('newTabName').value.trim();
                    if (!customerName) return showToast('Enter customer name', 'error');
                    
                    if (typeof TabsSync !== 'undefined' && TabsSync.createTab) {
                        await TabsSync.createTab(customerName, null, [item], employeeName);
                    } else {
                        // Fallback: create tab in localStorage
                        const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                        const newTab = {
                            id: Date.now().toString(),
                            customer: customerName,
                            items: [item],
                            total: item.price,
                            amount: item.price,
                            createdAt: new Date().toISOString(),
                            openedAt: new Date().toISOString(),
                            openedBy: employeeName
                        };
                        tabs.push(newTab);
                        localStorage.setItem('gc_tabs', JSON.stringify(tabs));
                    }
                    showToast(`Tab started for ${customerName}`);
                } else {
                    if (typeof TabsSync !== 'undefined' && TabsSync.addItemsToTab) {
                        await TabsSync.addItemsToTab(tabId, [item], employeeName);
                        const tab = TabsSync.getTab(tabId);
                        showToast(`Added to ${tab?.customer || 'Guest'}'s tab`);
                    } else {
                        // Fallback: update localStorage directly
                        const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                        const tabIndex = tabs.findIndex(t => String(t.id) === String(tabId));
                        if (tabIndex >= 0) {
                            if (!tabs[tabIndex].items) tabs[tabIndex].items = [];
                            tabs[tabIndex].items.push(item);
                            tabs[tabIndex].total = (tabs[tabIndex].total || 0) + item.price;
                            tabs[tabIndex].amount = tabs[tabIndex].total;
                            localStorage.setItem('gc_tabs', JSON.stringify(tabs));
                            showToast(`Added to ${tabs[tabIndex].customer || 'Guest'}'s tab`);
                        }
                    }
                }
                
                closeQuickTabModal();
                renderOpenTabs();
            } catch (error) {
                console.error('Error adding to tab:', error);
                showToast('Failed to add to tab', 'error');
            }
        }
        
        // Render Open Tabs
        function renderOpenTabs() {
            const container = document.getElementById('openTabsList');
            if (!container) return;
            
            // Get tabs - with fallback to localStorage if TabsSync not available
            let tabs = [];
            if (typeof TabsSync !== 'undefined') {
                tabs = TabsSync.getTabs() || [];
            } else {
                try {
                    tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                } catch (e) {
                    console.error('Error loading tabs:', e);
                    tabs = [];
                }
            }
            
            if (tabs.length === 0) {
                container.innerHTML = '<div class="empty-list">No open tabs</div>';
                return;
            }
            
            // Helper to normalize tier from any input (handles raw product IDs, nicknames, etc.)
            const normalizeTier = (type) => {
                if (!type) return null;
                const lower = type.toLowerCase();
                if (lower.includes('eagle')) return lower.includes('family') ? 'family_eagle' : 'eagle';
                if (lower.includes('birdie')) return lower.includes('family') ? 'family_birdie' : 'birdie';
                if (lower.includes('par')) return lower.includes('family') ? 'family_par' : 'par';
                if (lower.includes('corporate') || lower.includes('corp')) return 'corporate';
                if (lower.includes('league')) return 'league';
                if (lower === 'member' || lower.startsWith('prod_') || lower.startsWith('price_')) return 'par'; // Default unknown to par
                return lower; // Return as-is if already normalized
            };
            
            // Tier styling maps (matching tee sheet style) - with light backgrounds for readability
            const tierColors = { 'par': '#3498db', 'birdie': '#9b59b6', 'eagle': '#d4a017', 'family_par': '#3498db', 'family_birdie': '#9b59b6', 'family_eagle': '#d4a017', 'corporate': '#2c3e50', 'member': '#3498db' };
            const tierBgColors = { 'par': '#ebf5fb', 'birdie': '#f5eef8', 'eagle': '#fef9e7', 'family_par': '#ebf5fb', 'family_birdie': '#f5eef8', 'family_eagle': '#fef9e7', 'corporate': '#f8f9fa', 'member': '#ebf5fb' };
            const tierNames = { 'par': 'PAR', 'birdie': 'BIRDIE', 'eagle': 'EAGLE', 'family_par': 'FAM PAR', 'family_birdie': 'FAM BIRDIE', 'family_eagle': 'FAM EAGLE', 'corporate': 'CORP', 'member': 'MEMBER' };
            const tierDiscounts = { 'par': '10%', 'birdie': '10%', 'eagle': '15%', 'family_par': '10%', 'family_birdie': '10%', 'family_eagle': '15%', 'corporate': '20%', 'member': '10%' };
            
            container.innerHTML = tabs.map(t => {
                // Determine tab class and badges based on member/league status
                let tabClass = 'tab-item';
                let memberBadge = '';
                let leagueBadge = '';
                let tabStyle = '';
                
                if (t.isMember && t.memberType) {
                    // Normalize the tier type
                    const normalizedTier = normalizeTier(t.memberType);
                    const tierColor = tierColors[normalizedTier] || '#3498db';
                    const tierBg = tierBgColors[normalizedTier] || '#f5f5f5';
                    const tierName = tierNames[normalizedTier] || 'MEMBER';
                    const discount = tierDiscounts[normalizedTier] || '10%';
                    const isEagle = normalizedTier?.includes('eagle');
                    const isBirdie = normalizedTier?.includes('birdie');
                    
                    tabClass += ' member';
                    // All members get light background with colored left border - EXPLICIT dark text for visibility
                    tabStyle = `background:linear-gradient(135deg, ${tierBg} 0%, ${tierBg}ee 100%);border-left:4px solid ${tierColor};color:#2c3e50 !important;`;
                    
                    // Badge styling varies by tier
                    memberBadge = `
                        <span style="display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg, ${tierColor} 0%, ${tierColor}dd 100%);color:#fff;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;margin-left:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                            ${(isEagle || isBirdie) ? '<i class="fas fa-crown" style="font-size:8px;"></i>' : '<i class="fas fa-star" style="font-size:8px;"></i>'}
                            ${tierName}
                            <span style="background:rgba(255,255,255,0.3);padding:1px 4px;border-radius:6px;font-size:8px;">${discount}</span>
                        </span>`;
                } else if (t.isVIP) {
                    tabClass += ' vip';
                    tabStyle = 'background:linear-gradient(135deg, #f5eef8 0%, #e8daef 100%);border-left:4px solid #9b59b6;color:#2c3e50 !important;';
                    memberBadge = `
                        <span style="display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);color:#fff;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;margin-left:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-crown" style="font-size:8px;"></i>
                            VIP
                        </span>`;
                }
                
                // Add league badge if applicable
                if (t.isLeague) {
                    leagueBadge = `
                        <span style="display:inline-flex;align-items:center;gap:3px;background:linear-gradient(135deg, #27ae60 0%, #1e8449 100%);color:#fff;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;margin-left:4px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-golf-ball" style="font-size:8px;"></i>
                            LEAGUE
                        </span>`;
                    if (!tabStyle) {
                        tabStyle = 'background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);border-left:4px solid #27ae60;color:#2c3e50 !important;';
                    }
                }
                
                const bayInfo = t.bayNumber ? ` • Bay ${t.bayNumber}` : '';
                const tableInfo = t.table && t.table !== 'Tab' ? ` • ${t.table}` : '';
                const tabTotal = t.total || t.amount || 0;
                const itemCount = t.items?.length || 0;
                
                // Build explicit text color styles for child elements
                const textStyle = tabStyle ? 'color:#2c3e50;' : '';
                const infoStyle = tabStyle ? 'color:#555;' : '';
                const totalStyle = tabStyle ? 'color:#2c3e50;font-weight:700;' : '';
                
                return `
                <div class="${tabClass}" onclick="selectTab('${t.id}')" style="${tabStyle}">
                    <div class="tab-left">
                        <div class="tab-customer" style="display:flex;align-items:center;flex-wrap:wrap;${textStyle}">${t.customer || 'Guest'}${memberBadge}${leagueBadge}</div>
                        <div class="tab-info" style="${infoStyle}">${itemCount} item${itemCount !== 1 ? 's' : ''}${bayInfo}${tableInfo}</div>
                    </div>
                    <div class="tab-right">
                        <div class="tab-total" style="${totalStyle}">$${tabTotal.toFixed(2)}</div>
                    </div>
                </div>
            `}).join('');
        }
        
        // Select/View Tab
        function selectTab(tabId) {
            let tab = null;
            
            // Try to get tab from TabsSync first, then fallback to localStorage
            if (typeof TabsSync !== 'undefined') {
                tab = TabsSync.getTab(tabId);
            }
            
            if (!tab) {
                // Fallback: try localStorage directly
                try {
                    const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                    tab = tabs.find(t => String(t.id) === String(tabId));
                } catch (e) {
                    console.error('Error loading tab:', e);
                }
            }
            
            if (!tab) {
                showToast('Tab not found', 'error');
                return;
            }
            
            // Load tab items into current sale
            saleItems = (tab.items || []).map((item, i) => ({
                id: Date.now() + i,
                name: item.name || 'Unknown Item',
                price: parseFloat(item.price) || 0,
                qty: parseInt(item.qty) || 1,
                discount: 0,
                category: item.category || 'misc'
            }));
            
            document.getElementById('customerName').value = tab.customer || 'Guest';
            renderSaleItems();
            
            // Store active tab ID for closing
            window.activeTabId = String(tabId);
            
            // Use shared banner function
            showTabBanner(tab.customer || 'Guest', tab.isMember, tab.memberType, tab.isLeague);
            
            showToast(`Loaded ${tab.customer || 'Guest'}'s tab`);
        }
        
        // Clear active tab without closing it
        function clearActiveTab() {
            window.activeTabId = null;
            selectedCustomer = null;
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            
            // Hide active tab banner
            hideTabBanner();
            
            showToast('Tab cleared from current sale');
        }
        
        // Close Tab (pay and complete)
        async function closeActiveTab(paymentMethod = 'card', tip = 0) {
            if (!window.activeTabId) {
                showToast('No active tab selected', 'warning');
                return;
            }
            
            try {
                const employeeName = getCurrentUserName();
                
                if (typeof TabsSync !== 'undefined' && TabsSync.closeTab) {
                    await TabsSync.closeTab(window.activeTabId, paymentMethod, tip, employeeName);
                } else {
                    // Fallback: remove from localStorage directly
                    const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                    const updatedTabs = tabs.filter(t => String(t.id) !== String(window.activeTabId));
                    localStorage.setItem('gc_tabs', JSON.stringify(updatedTabs));
                }
                
                window.activeTabId = null;
                saleItems = [];
                document.getElementById('customerName').value = '';
                
                // Hide active tab banner
                const banner = document.getElementById('activeTabBanner');
                if (banner) banner.style.display = 'none';
                
                renderSaleItems();
                renderOpenTabs();
                showToast('Tab closed successfully');
            } catch (error) {
                console.error('Error closing tab:', error);
                showToast('Failed to close tab', 'error');
            }
        }
        
        // ============ RENDER PANELS ============
        function renderTransactions() {
            const container = document.getElementById('recentTrans');
            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-list">No transactions yet</div>';
                return;
            }
            container.innerHTML = transactions.slice(0, 8).map(t => `
                <div class="trans-item ${t.isReturn ? 'return' : ''}" onclick="viewTransaction(${t.id})">
                    <div class="trans-left">
                        <div class="trans-time">${t.time}</div>
                        <div class="trans-customer">${t.customer}</div>
                    </div>
                    <div class="trans-right">
                        <div class="trans-amount">${t.isReturn ? '-' : ''}$${Math.abs(t.amount).toFixed(2)}</div>
                        <div class="trans-id">#${t.id}</div>
                    </div>
                </div>
            `).join('');
        }
        
        function renderSuspended() {
            const container = document.getElementById('suspendedSales');
            if (suspendedSales.length === 0) {
                container.innerHTML = '<div class="empty-list">No suspended sales</div>';
                return;
            }
            container.innerHTML = suspendedSales.map(s => `
                <div class="suspended-item" onclick="resumeSale(${s.id})">
                    <div class="susp-header">
                        <span class="susp-name">${s.time}</span>
                        <span class="susp-amount">$${s.amount.toFixed(2)}</span>
                    </div>
                    <div class="susp-customer">${s.customer} • ${s.items.length} item${s.items.length !== 1 ? 's' : ''}</div>
                </div>
            `).join('');
        }
        
        function viewTransaction(id) {
            const t = transactions.find(tr => tr.id === id);
            if (t) {
                const detailHtml = `
                    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                        <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;" onclick="event.stopPropagation()">
                            <h3 style="margin:0 0 15px;border-bottom:2px solid #4a90a4;padding-bottom:10px;"><i class="fas fa-receipt" style="color:#4a90a4;"></i> Transaction #${t.id}</h3>
                            <div style="display:grid;gap:10px;">
                                <div style="display:flex;justify-content:space-between;"><strong>Customer:</strong><span>${t.customer}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Type:</strong><span style="color:${t.isReturn ? '#e74c3c' : '#27ae60'};font-weight:600;">${t.isReturn ? 'RETURN' : 'SALE'}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Amount:</strong><span style="font-size:1.2em;font-weight:700;">$${Math.abs(t.amount).toFixed(2)}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Time:</strong><span>${t.time}</span></div>
                                <div style="display:flex;justify-content:space-between;"><strong>Items:</strong><span>${t.items || 'N/A'}</span></div>
                            </div>
                            <div style="display:flex;gap:10px;margin-top:20px;">
                                <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                                <button onclick="printTransactionReceipt(${t.id})" style="flex:1;padding:12px;border:none;background:#4a90a4;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Print</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', detailHtml);
            }
        }
        
        function printTransactionReceipt(id) {
            const t = transactions.find(tr => tr.id === id);
            if (!t) return;
            const w = window.open('', '_blank', 'width=400,height=500');
            var html = '<html><head><title>Receipt #' + t.id + '</title><style>body{font-family:monospace;padding:20px;max-width:300px;margin:0 auto;}</style></head><bo' + 'dy>';
            html += '<div style="text-align:center;"><h2>GOLF COVE</h2><p>Indoor Golf & Bar</p></div><hr>';
            html += '<p><strong>Receipt #' + t.id + '</strong></p>';
            html += '<p>Customer: ' + t.customer + '</p>';
            html += '<p>Type: ' + (t.isReturn ? 'RETURN' : 'SALE') + '</p>';
            html += '<p style="font-size:1.3em;"><strong>Total: $' + Math.abs(t.amount).toFixed(2) + '</strong></p>';
            html += '<p>Time: ' + t.time + '</p><hr><p style="text-align:center;">Thank you!</p>';
            html += '<scr' + 'ipt>window.print();setTimeout(()=>window.close(),500);</scr' + 'ipt>';
            html += '</bo' + 'dy></ht' + 'ml>';
            w.document.write(html);
            w.document.close();
        }
        
        // ============ REGISTER FUNCTIONS ============
        async function openDrawer() {
            showToast('Cash drawer opened');
            // Kick physical USB drawer if connected
            if (window.CashDrawer) {
                await CashDrawer.kick();
            }
        }
        
        function closeRegister() {
            // Calculate summary
            const today = new Date().toDateString();
            const todayTransactions = transactions.filter(t => {
                // Check if transaction is from today (approximate by checking recent)
                return true; // In production, would filter by actual date
            });
            
            const sales = todayTransactions.filter(t => !t.isReturn);
            const returns = todayTransactions.filter(t => t.isReturn);
            const salesTotal = sales.reduce((sum, t) => sum + t.amount, 0);
            const returnsTotal = returns.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netTotal = salesTotal - returnsTotal;
            
            const cashSales = todayTransactions.filter(t => t.method === 'cash' && !t.isReturn);
            const cardSales = todayTransactions.filter(t => t.method !== 'cash' && !t.isReturn);
            const cashTotal = cashSales.reduce((sum, t) => sum + t.amount, 0);
            const cardTotal = cardSales.reduce((sum, t) => sum + t.amount, 0);
            
            // Calculate tax collected
            const taxCollected = netTotal - (netTotal / (1 + getTaxRate()));
            
            // Calculate average transaction
            const avgTransaction = sales.length > 0 ? salesTotal / sales.length : 0;
            
            const reportHtml = `
                <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 15px;border-bottom:2px solid #4a90a4;padding-bottom:10px;"><i class="fas fa-cash-register" style="color:#4a90a4;"></i> Register Close Report</h3>
                        <p style="color:#666;margin-bottom:15px;">${new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' })} at ${new Date().toLocaleTimeString()}</p>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;color:#333;">Transaction Summary</h4>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Sales (${sales.length}):</span><span style="color:#27ae60;">+$${salesTotal.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Returns (${returns.length}):</span><span style="color:#e74c3c;">-$${returnsTotal.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #ddd;margin-top:5px;font-weight:700;font-size:1.1em;"><span>Net Total:</span><span>$${netTotal.toFixed(2)}</span></div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;color:#333;">Payment Breakdown</h4>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span><i class="fas fa-money-bill-wave" style="color:#27ae60;"></i> Cash:</span><span>$${cashTotal.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span><i class="fas fa-credit-card" style="color:#4a90a4;"></i> Card:</span><span>$${cardTotal.toFixed(2)}</span></div>
                        </div>
                        
                        <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;color:#2e7d32;">Additional Details</h4>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Tax Collected (${getTaxRatePercent()}%):</span><span>$${taxCollected.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Avg Transaction:</span><span>$${avgTransaction.toFixed(2)}</span></div>
                            <div style="display:flex;justify-content:space-between;padding:5px 0;"><span>Items Sold:</span><span>${sales.reduce((sum, t) => sum + (t.items || 0), 0)}</span></div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="printCloseReport();this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#4a90a4;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Print</button>
                            <button onclick="confirmCloseRegister();this.closest('div[style*=fixed]').remove()" style="flex:1;padding:12px;border:none;background:#e74c3c;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-door-closed"></i> Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', reportHtml);
        }
        
        function printCloseReport() {
            const sales = transactions.filter(t => !t.isReturn);
            const returns = transactions.filter(t => t.isReturn);
            const salesTotal = sales.reduce((sum, t) => sum + t.amount, 0);
            const returnsTotal = returns.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netTotal = salesTotal - returnsTotal;
            const taxCollected = netTotal - (netTotal / (1 + getTaxRate()));
            
            const w = window.open('', '_blank', 'width=400,height=600');
            var html = '<html><head><title>Register Close Report</title>';
            html += '<style>body{font-family:monospace;padding:20px;max-width:300px;margin:0 auto;font-size:12px;}';
            html += 'h2{text-align:center;margin-bottom:5px;}hr{border:none;border-top:1px dashed #333;margin:10px 0;}';
            html += '.row{display:flex;justify-content:space-between;padding:3px 0;}</style></head>';
            html += '<bo' + 'dy>';
            html += '<h2>GOLF COVE</h2>';
            html += '<p style="text-align:center;margin-bottom:15px;">Register Close Report</p>';
            html += '<p style="text-align:center;">' + new Date().toLocaleDateString() + ' ' + new Date().toLocaleTimeString() + '</p>';
            html += '<hr>';
            html += '<div class="row"><span>Sales (' + sales.length + '):</span><span>$' + salesTotal.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>Returns (' + returns.length + '):</span><span>-$' + returnsTotal.toFixed(2) + '</span></div>';
            html += '<hr>';
            html += '<div class="row" style="font-weight:bold;"><span>NET TOTAL:</span><span>$' + netTotal.toFixed(2) + '</span></div>';
            html += '<div class="row"><span>Tax Collected:</span><span>$' + taxCollected.toFixed(2) + '</span></div>';
            html += '<hr>';
            html += '<p style="text-align:center;margin-top:20px;">Employee: ' + getCurrentUserName() + '</p>';
            html += '<scr' + 'ipt>window.print();setTimeout(()=>window.close(),500);</scr' + 'ipt>';
            html += '</bo' + 'dy></ht' + 'ml>';
            w.document.write(html);
            w.document.close();
        }
        
        function confirmCloseRegister() {
            // In a real system, this would finalize the register close
            showToast('Register closed for the day', 'success');
            // Could clear transactions or save end-of-day report
        }
        
        function managerOverride() {
            const pin = prompt('Enter manager PIN:');
            if (!pin) return false;
            
            // Validate against actual manager PINs from localStorage
            const employees = JSON.parse(localStorage.getItem('gc_employees') || '[]');
            const manager = employees.find(e => e.pin === pin && (e.role === 'manager' || e.role === 'admin'));
            
            if (manager) {
                showToast('Manager override granted', 'success');
                return true;
            } else {
                showToast('Invalid PIN', 'error');
                return false;
            }
        }
        
        function issueRaincheck() {
            const customer = prompt('Customer name for raincheck:');
            if (customer) {
                showToast(`Raincheck issued to ${customer}`);
            }
        }
        
        async function addNewCustomer() {
            const firstName = prompt('First name:');
            if (!firstName) return;
            const lastName = prompt('Last name:');
            if (!lastName) return;
            
            const phone = prompt('Phone number (optional):');
            const email = prompt('Email (optional):');
            
            // Create customer in Stripe
            try {
                const FUNCTIONS_URL = window.GolfCoveConfig?.stripe?.functionsUrl || 'https://us-central1-golfcove.cloudfunctions.net';
                const response = await fetch(`${FUNCTIONS_URL}/createStripeCustomer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: `${firstName.trim()} ${lastName.trim()}`,
                        email: email || undefined,
                        phone: phone || undefined
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    // Add to local cache
                    const newCustomer = {
                        id: data.customerId,
                        stripeId: data.customerId,
                        firstName: firstName.trim(),
                        lastName: lastName.trim(),
                        email: email || '',
                        phone: phone || '',
                        isMember: false,
                        memberType: null
                    };
                    stripeCustomersCache.push(newCustomer);
                    document.getElementById('customerName').value = `${firstName} ${lastName}`;
                    showToast(`Customer "${firstName} ${lastName}" created`);
                } else {
                    throw new Error('Failed to create customer');
                }
            } catch (e) {
                console.error('Error creating customer:', e);
                showToast('Failed to create customer', 'error');
            }
        }
        
        // ============ CUSTOMER AUTOCOMPLETE ============
        const customerInput = document.getElementById('customerName');
        const customerAutocomplete = document.getElementById('customerAutocomplete');
        
        customerInput.addEventListener('input', function() {
            const val = this.value.toLowerCase().trim();
            if (val.length < 1) {
                customerAutocomplete.classList.remove('show');
                selectedCustomer = null; // Clear selection when typing
                return;
            }
            
            // Use Stripe customers cache (loaded fresh from API)
            const matches = stripeCustomersCache.filter(c => {
                const fullName = `${c.firstName || ''} ${c.lastName || ''}`.toLowerCase();
                const emailPrefix = c.email ? c.email.split('@')[0].toLowerCase() : '';
                return fullName.includes(val) || 
                       emailPrefix.includes(val) ||
                       (c.email && c.email.toLowerCase().includes(val)) || 
                       (c.phone && c.phone.includes(val));
            }).slice(0, 10);
            
            if (matches.length === 0) {
                customerAutocomplete.innerHTML = `
                    <div style="padding:15px;text-align:center;color:#888;">
                        <i class="fas fa-user-slash" style="font-size:20px;margin-bottom:8px;display:block;"></i>
                        No customers found for "${val}"<br>
                        <button onclick="addNewCustomer()" style="margin-top:10px;padding:8px 16px;background:#4a90a4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
                            <i class="fas fa-plus"></i> Create New Customer
                        </button>
                    </div>
                `;
                customerAutocomplete.classList.add('show');
                return;
            }
            
            customerAutocomplete.innerHTML = matches.map((c, idx) => {
                const isMember = isActiveMember(c);
                const isLeague = c.isLeague || (c.memberType && c.memberType.includes('league'));
                
                // Get display name - use firstName/lastName if available, otherwise use email prefix
                const displayName = (c.firstName || c.lastName) 
                    ? `${c.firstName || ''} ${c.lastName || ''}`.trim()
                    : (c.email ? c.email.split('@')[0] : 'Customer');
                
                // Get initials from display name
                const nameParts = displayName.split(' ');
                const initials = nameParts.length >= 2 
                    ? (nameParts[0][0] || '') + (nameParts[1][0] || '')
                    : (displayName[0] || 'C') + (displayName[1] || '');
                
                const discount = isMember ? getMemberDiscount(c.memberType) : 0;
                const tierName = isMember ? getMemberTierName(c.memberType) : '';
                const tierColor = isMember ? getMemberTierColor(c.memberType) : '';
                const isVIP = c.memberType && (c.memberType.includes('eagle') || c.memberType.includes('birdie'));
                
                let memberBadge = '';
                let leagueBadge = '';
                let avatarClass = 'avatar';
                
                if (isMember) {
                    avatarClass += ' member';
                    memberBadge = `
                        <span style="display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg, ${tierColor} 0%, ${tierColor}dd 100%);color:#fff;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;margin-left:6px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-crown" style="font-size:8px;${isVIP ? 'color:#f1c40f;' : ''}"></i>
                            ${tierName}
                            <span style="background:rgba(255,255,255,0.3);padding:1px 4px;border-radius:6px;font-size:8px;">${discount}%</span>
                        </span>`;
                }
                
                if (isLeague) {
                    leagueBadge = `
                        <span style="display:inline-flex;align-items:center;gap:3px;background:linear-gradient(135deg, #27ae60 0%, #1e8449 100%);color:#fff;padding:3px 8px;border-radius:12px;font-size:10px;font-weight:700;text-transform:uppercase;margin-left:4px;box-shadow:0 2px 4px rgba(0,0,0,0.2);">
                            <i class="fas fa-golf-ball" style="font-size:8px;"></i>
                            LEAGUE
                        </span>`;
                }
                
                const subtitle = isMember 
                    ? `${tierName} Member - ${discount}% discount` 
                    : isLeague 
                        ? 'League Player'
                        : (c.email || c.phone || 'Customer');
                
                return `
                    <div class="autocomplete-item" data-customer-index="${idx}" onmousedown="selectCustomerFromList(${idx})" style="${isMember ? `border-left:3px solid ${tierColor};background:linear-gradient(135deg, #fef9e7 0%, #f8f4e8 100%);` : isLeague ? 'border-left:3px solid #27ae60;background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);' : ''}">
                        <div class="${avatarClass}" ${isMember ? `style="background:linear-gradient(135deg, ${tierColor} 0%, ${tierColor}dd 100%);"` : isLeague ? 'style="background:linear-gradient(135deg, #27ae60 0%, #1e8449 100%);"' : ''}>${initials.toUpperCase()}</div>
                        <div class="info">
                            <div class="name">${displayName}${memberBadge}${leagueBadge}</div>
                            <div class="meta">${subtitle}</div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Store matches for selection
            customerAutocomplete._matches = matches;
            customerAutocomplete.classList.add('show');
        });
        
        // Use event delegation for customer selection (more reliable than inline handlers)
        customerAutocomplete.addEventListener('mousedown', function(e) {
            // Find the autocomplete-item parent
            const item = e.target.closest('.autocomplete-item');
            if (item) {
                e.preventDefault(); // Prevent blur from firing
                const index = parseInt(item.dataset.customerIndex);
                if (!isNaN(index)) {
                    selectCustomerFromList(index);
                }
            }
        });
        
        customerInput.addEventListener('blur', function() {
            // Longer delay to allow click events to fire first
            setTimeout(() => customerAutocomplete.classList.remove('show'), 300);
        });
        
        // Select customer from autocomplete list (stores full customer object)
        async function selectCustomerFromList(index) {
            console.log('[Sales] selectCustomerFromList called with index:', index);
            
            const matches = customerAutocomplete._matches || [];
            const customer = matches[index];
            
            if (!customer) {
                console.error('[Sales] Customer not found at index:', index);
                showToast('Customer not found', 'error');
                return;
            }
            
            console.log('[Sales] Selected customer:', customer);
            selectedCustomer = customer;
            
            // Get display name - use firstName/lastName if available, otherwise use email prefix
            const displayName = (customer.firstName || customer.lastName) 
                ? `${customer.firstName || ''} ${customer.lastName || ''}`.trim()
                : (customer.email ? customer.email.split('@')[0] : 'Customer');
            
            // Clear search and hide autocomplete immediately
            customerInput.value = displayName;
            customerAutocomplete.innerHTML = '';
            customerAutocomplete.classList.remove('show');
            
            // Check if customer has an existing open tab
            let existingTab = null;
            if (typeof TabsSync !== 'undefined') {
                console.log('[Sales] Checking for existing tab...');
                existingTab = TabsSync.getTabByCustomerId(customer.id) || TabsSync.getTabByCustomer(displayName);
                console.log('[Sales] Existing tab found:', existingTab);
            }
            
            if (existingTab) {
                // Load their existing tab - selectTab handles everything including banner
                console.log('[Sales] Loading existing tab:', existingTab.id);
                selectTab(existingTab.id);
                showToast(`Loaded ${displayName}'s existing tab`, 'info');
                return;
            }
            
            // No existing tab - create one for this customer
            console.log('[Sales] Creating new tab for:', displayName);
            const isMember = isActiveMember(customer);
            
            try {
                if (typeof TabsSync !== 'undefined') {
                    const employeeName = getCurrentUserName();
                    // createTab signature: (customerName, customerId, items, employeeName, options)
                    const newTab = await TabsSync.createTab(displayName, customer.id, [], employeeName, {
                        isMember: isMember,
                        memberType: customer.memberType,
                        isLeague: customer.isLeague
                    });
                    
                    if (newTab && newTab.id) {
                        window.activeTabId = String(newTab.id);
                        console.log('[Sales] Tab created, activeTabId:', window.activeTabId);
                        renderOpenTabs();
                        
                        // Use shared banner function
                        showTabBanner(displayName, isMember, customer.memberType, customer.isLeague);
                        
                        // Apply member discount if applicable
                        if (isMember && customer.memberType) {
                            memberDiscountApplied = true;
                            const tierName = getMemberTierName(customer.memberType);
                            const discountPct = getMemberDiscount(customer.memberType);
                            showToast(`${tierName} Member tab started (${discountPct}% off)`, 'success');
                        } else {
                            showToast(`Tab started for ${displayName}`, 'success');
                        }
                    } else {
                        console.warn('[Sales] Tab creation returned no tab object');
                        // Tab creation returned no ID - still show banner
                        showTabBanner(displayName, isMember, customer.memberType, customer.isLeague);
                        showToast(`Selected: ${displayName}`, 'success');
                    }
                } else {
                    console.warn('[Sales] TabsSync not available');
                    // TabsSync not available - just show banner
                    showTabBanner(displayName, isMember, customer.memberType, customer.isLeague);
                    showToast(`Selected: ${displayName}`, 'success');
                }
            } catch (e) {
                console.error('[Sales] Error creating tab:', e);
                // Error creating tab - still show banner
                showTabBanner(displayName, isMember, customer.memberType, customer.isLeague);
                showToast(`Selected: ${displayName}`, 'success');
            }
        }
        
        // ============ SHARED TAB BANNER FUNCTION ============
        // Single source of truth for displaying the tab/customer banner
        function showTabBanner(customerName, isMember, memberType, isLeague) {
            const banner = document.getElementById('activeTabBanner');
            const tabNameEl = document.getElementById('activeTabName');
            const tabBadge = document.getElementById('activeTabBadge');
            
            if (!banner || !tabNameEl) {
                console.error('[Sales] Banner elements not found!');
                return;
            }
            
            // Set the tab name
            tabNameEl.textContent = `Tab: ${customerName}`;
            
            // Helper to normalize tier from any input (handles raw product IDs, nicknames, etc.)
            const normalizeTier = (type) => {
                if (!type) return null;
                const lower = type.toLowerCase();
                if (lower.includes('eagle')) return lower.includes('family') ? 'family_eagle' : 'eagle';
                if (lower.includes('birdie')) return lower.includes('family') ? 'family_birdie' : 'birdie';
                if (lower.includes('par')) return lower.includes('family') ? 'family_par' : 'par';
                if (lower.includes('corporate') || lower.includes('corp')) return 'corporate';
                if (lower.includes('league')) return 'league';
                if (lower === 'member' || lower.startsWith('prod_') || lower.startsWith('price_')) return 'par';
                return lower;
            };
            
            // Tier styling maps
            const tierColors = { 
                'par': '#3498db', 'birdie': '#9b59b6', 'eagle': '#d4a017', 
                'family_par': '#3498db', 'family_birdie': '#9b59b6', 'family_eagle': '#d4a017', 
                'corporate': '#2c3e50', 'member': '#3498db'
            };
            const tierNames = { 
                'par': 'PAR', 'birdie': 'BIRDIE', 'eagle': 'EAGLE', 
                'family_par': 'FAM PAR', 'family_birdie': 'FAM BIRDIE', 'family_eagle': 'FAM EAGLE', 
                'corporate': 'CORP', 'member': 'MEMBER'
            };
            const tierDiscounts = { 
                'par': '10%', 'birdie': '10%', 'eagle': '15%', 
                'family_par': '10%', 'family_birdie': '10%', 'family_eagle': '15%', 
                'corporate': '20%', 'member': '10%'
            };
            
            // Normalize the memberType
            const normalizedTier = normalizeTier(memberType);
            
            // Apply styling based on member/league status
            if (isMember && normalizedTier) {
                const tierColor = tierColors[normalizedTier] || '#3498db';
                const tierNameLabel = tierNames[normalizedTier] || 'MEMBER';
                const discount = tierDiscounts[normalizedTier] || '10%';
                banner.style.background = `linear-gradient(135deg, ${tierColor} 0%, ${tierColor}dd 100%)`;
                
                if (tabBadge) {
                    tabBadge.style.display = 'inline-flex';
                    tabBadge.innerHTML = `
                        <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;">
                            <i class="fas fa-crown" style="font-size:10px;"></i>
                            ${tierNameLabel} (${discount} OFF)
                        </span>
                    `;
                }
            } else if (isLeague) {
                banner.style.background = 'linear-gradient(135deg, #27ae60 0%, #1e8449 100%)';
                if (tabBadge) {
                    tabBadge.style.display = 'inline-flex';
                    tabBadge.innerHTML = `
                        <span style="display:inline-flex;align-items:center;gap:4px;background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:11px;font-weight:700;">
                            <i class="fas fa-golf-ball" style="font-size:10px;"></i>
                            LEAGUE
                        </span>
                    `;
                }
            } else {
                banner.style.background = 'linear-gradient(135deg, #3498db, #2980b9)';
                if (tabBadge) {
                    tabBadge.style.display = 'none';
                    tabBadge.innerHTML = '';
                }
            }
            
            // CRITICAL: Show the banner
            banner.style.display = 'flex';
            console.log('[Sales] Banner shown for:', customerName);
        }
        
        // Hide the tab banner
        function hideTabBanner() {
            const banner = document.getElementById('activeTabBanner');
            if (banner) banner.style.display = 'none';
        }
        
        // Legacy function for backwards compatibility
        function selectCustomerAutocomplete(name, isMember) {
            customerInput.value = name;
            customerAutocomplete.classList.remove('show');
            
            // Find full customer object from Stripe cache
            const nameParts = name.trim().split(' ');
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ');
            
            selectedCustomer = stripeCustomersCache.find(c =>
                (c.firstName || '').toLowerCase() === firstName.toLowerCase() &&
                (c.lastName || '').toLowerCase() === lastName.toLowerCase()
            ) || null;
            
            if (isMember && selectedCustomer) {
                const discount = getMemberDiscount(selectedCustomer.memberType);
                showToast(`Member: ${name} - ${discount}% discount applied!`, 'success');
                saleItems.forEach(item => {
                    if (item.discount < discount) item.discount = discount;
                });
                memberDiscountApplied = true;
                renderSaleItems();
            }
        }
        
        // ============ START TAB (MEMBER-AWARE) ============
        async function startTab() {
            const customerName = document.getElementById('customerName').value.trim() || 'Walk-in';
            const tabName = prompt('Tab name:', customerName);
            if (!tabName) return;
            
            // Get customer object for member info
            const customer = selectedCustomer || findCustomerByName(customerName);
            const isMember = customer ? isActiveMember(customer) : false;
            const memberType = customer?.memberType || null;
            const memberDiscount = isMember ? getMemberDiscount(memberType) / 100 : 0; // As decimal
            
            // Format items for tab
            const tabItems = saleItems.map(item => ({
                name: item.name,
                price: (parseFloat(item.price) || 0) * (1 - (item.discount || 0) / 100),
                qty: parseInt(item.qty) || 1,
                category: item.category || 'misc'
            }));
            
            const employeeName = getCurrentUserName();
            const itemsTotal = tabItems.reduce((sum, i) => sum + (i.price * i.qty), 0);
            
            try {
                if (typeof TabsSync !== 'undefined' && TabsSync.createTab) {
                    // Use TabsSync for synced tabs - pass customer object for member info
                    await TabsSync.createTab(tabName, customer?.stripeId || customer?.stripeCustomerId, tabItems, employeeName);
                    showToast(`Tab started for ${tabName}${isMember ? ` (${getMemberTierName(memberType)} - ${Math.round(memberDiscount * 100)}% discount)` : ''}`);
                } else {
                    // Fallback: create tab in localStorage with member info
                    const tabs = JSON.parse(localStorage.getItem('gc_tabs') || '[]');
                    tabs.push({
                        id: Date.now().toString(),
                        customer: tabName,
                        customerId: customer?.id || null,
                        stripeCustomerId: customer?.stripeId || customer?.stripeCustomerId || null,
                        employee: employeeName,
                        openedBy: employeeName,
                        amount: itemsTotal,
                        total: itemsTotal,
                        subtotal: itemsTotal,
                        items: tabItems,
                        table: 'Tab',
                        isMember: isMember,
                        memberType: memberType,
                        memberDiscount: memberDiscount,
                        createdAt: new Date().toISOString(),
                        openedAt: new Date().toISOString()
                    });
                    localStorage.setItem('gc_tabs', JSON.stringify(tabs));
                    showToast(`Tab started for ${tabName}${isMember ? ` (${getMemberTierName(memberType)} Member)` : ''}`);
                }
                
                // Clear sale
                saleItems = [];
                selectedCustomer = null;
                memberDiscountApplied = false;
                document.getElementById('customerName').value = '';
                renderSaleItems();
                renderOpenTabs();
            } catch (error) {
                console.error('Error creating tab:', error);
                showToast('Failed to create tab', 'error');
            }
        }
        
        // Helper to find customer by name
        function findCustomerByName(name) {
            if (!name || name === 'Walk-in') return null;
            
            const nameParts = name.trim().split(' ');
            const firstName = nameParts[0];
            const lastName = nameParts.slice(1).join(' ');
            
            return stripeCustomersCache.find(c =>
                (c.firstName || '').toLowerCase() === firstName.toLowerCase() &&
                (c.lastName || '').toLowerCase() === lastName.toLowerCase()
            ) || null;
        }
        
        // ============ TOAST ============
        function showToast(message, type = 'success') {
            const existing = document.querySelector('.toast');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // Close modal on background click
        document.getElementById('itemsModal').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeItemsModal();
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeItemsModal();
                closeCashModal();
                closeManualCardModal();
            }
            if (e.key === 'F9') { e.preventDefault(); processPayment('card'); }
            if (e.key === 'F8') { e.preventDefault(); processPayment('cash'); }
            if (e.key === 'F2') { e.preventDefault(); document.getElementById('itemSearch').focus(); }
            if (e.key === 'F4') { e.preventDefault(); clearSale(); }
            if (e.key === 'F7') { e.preventDefault(); applyDiscount(); }
            // Ctrl+N for new customer
            if (e.ctrlKey && e.key === 'n') { e.preventDefault(); addNewCustomer(); }
            // F6 for open price item
            if (e.key === 'F6') { e.preventDefault(); addOpenPriceItem(); }
            // F10 for settings
            if (e.key === 'F10') { e.preventDefault(); showSettings(); }
        });
        
        // Open Price Item (misc charge)
        function addOpenPriceItem() {
            const name = prompt('Item description:');
            if (!name) return;
            const price = parseFloat(prompt('Enter price:'));
            if (isNaN(price) || price <= 0) return showToast('Invalid price', 'error');
            
            saleItems.push({
                id: Date.now(),
                name: name,
                price: price,
                qty: 1,
                discount: 0,
                isCustom: true
            });
            renderSaleItems();
            showToast(`Added: ${name} - $${price.toFixed(2)}`);
        }
        
        // ============ STRIPE SETTINGS ============
        const FUNCTIONS_URL = 'https://us-central1-golfcove.cloudfunctions.net';
        
        // Global settings are loaded from localStorage (set via admin panel)
        // The getGlobalSettings endpoint doesn't exist, so we skip the network call
        async function loadGlobalSettings() {
            // Use locally cached settings
            const pk = localStorage.getItem('gc_stripe_pk');
            const location = localStorage.getItem('gc_stripe_location');
            if (pk && typeof STRIPE_CONFIG !== 'undefined') {
                STRIPE_CONFIG.publishableKey = pk;
            }
            if (location && typeof STRIPE_CONFIG !== 'undefined') {
                STRIPE_CONFIG.terminalLocationId = location;
            }
            return { stripePublishableKey: pk, stripeTerminalLocation: location };
        }
        
        async function showSettings() {
            // Try to load from Firebase first, fall back to localStorage
            let currentPK = localStorage.getItem('gc_stripe_pk') || '';
            let currentLocation = localStorage.getItem('gc_stripe_location') || '';
            const registerId = localStorage.getItem('gc_register_id') || 'POS-1';
            
            // Fetch latest from Firebase
            const globalSettings = await loadGlobalSettings();
            if (globalSettings) {
                currentPK = globalSettings.stripePublishableKey || currentPK;
                currentLocation = globalSettings.stripeTerminalLocation || currentLocation;
            }
            
            const html = `
                <div id="settingsModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:90%;">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-cog"></i> POS Settings</h3>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Register ID:</label>
                            <input type="text" id="settingsRegisterId" value="${registerId}" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;">
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 15px;color:#6772e5;"><i class="fab fa-stripe"></i> Stripe Configuration</h4>
                            <p style="font-size:12px;color:#666;margin-bottom:15px;"><i class="fas fa-cloud"></i> These settings are saved globally and shared across all devices.</p>
                            
                            <div style="margin-bottom:10px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;">Publishable Key:</label>
                                <input type="text" id="settingsStripePK" value="${currentPK}" placeholder="pk_test_..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;font-size:12px;">
                            </div>
                            
                            <div style="margin-bottom:10px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;font-size:13px;">Terminal Location ID:</label>
                                <input type="text" id="settingsStripeLocation" value="${currentLocation}" placeholder="tml_..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:monospace;font-size:12px;">
                            </div>
                            
                            <button onclick="discoverReaders()" style="width:100%;padding:10px;border:none;background:#6772e5;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">
                                <i class="fas fa-bluetooth"></i> Discover Readers
                            </button>
                        </div>
                        
                        <div style="background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 15px;color:#2e7d32;"><i class="fas fa-database"></i> Data Import/Export</h4>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;">
                                <button onclick="closeSettings();showDataImportModal()" style="flex:1;padding:10px;border:1px solid #27ae60;background:#fff;color:#27ae60;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-upload"></i> Import Data</button>
                                <button onclick="exportAllData()" style="flex:1;padding:10px;border:1px solid #27ae60;background:#fff;color:#27ae60;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-download"></i> Export All</button>
                            </div>
                            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
                                <button onclick="backupToJSON()" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;"><i class="fas fa-save"></i> Backup</button>
                                <button onclick="restoreFromJSON()" style="flex:1;padding:8px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-size:12px;"><i class="fas fa-undo"></i> Restore</button>
                            </div>
                        </div>
                        
                        <div style="background:#e3f2fd;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 15px;color:#1976d2;"><i class="fas fa-cash-register"></i> Cash Drawer</h4>
                            <div id="drawerStatus" style="margin-bottom:10px;font-size:13px;">
                                ${window.CashDrawer?.isConnected ? '<span style="color:#27ae60;"><i class="fas fa-check-circle"></i> Connected</span>' : '<span style="color:#666;"><i class="fas fa-circle"></i> Not Connected</span>'}
                            </div>
                            <button onclick="connectCashDrawer()" style="width:100%;padding:10px;border:1px solid #1976d2;background:#fff;color:#1976d2;border-radius:6px;cursor:pointer;font-weight:600;">
                                <i class="fas fa-plug"></i> ${window.CashDrawer?.isConnected ? 'Reconnect Drawer' : 'Connect USB Drawer'}
                            </button>
                            <p style="font-size:11px;color:#666;margin-top:8px;margin-bottom:0;">USB cash drawer required. Works with Chrome, Edge, Opera.</p>
                        </div>
                        
                        <div style="background:#fff3cd;padding:12px;border-radius:8px;margin-bottom:15px;font-size:13px;">
                            <i class="fas fa-info-circle" style="color:#856404;"></i>
                            For production, you'll need a Stripe account with Terminal enabled. 
                            <a href="https://stripe.com/terminal" target="_blank" style="color:#856404;">Learn more</a>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeSettings()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="saveSettings()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-save"></i> Save</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.remove();
        }
        
        async function saveSettings() {
            const pk = document.getElementById('settingsStripePK').value.trim();
            const location = document.getElementById('settingsStripeLocation').value.trim();
            const registerId = document.getElementById('settingsRegisterId').value.trim();
            
            // Save locally for immediate use
            localStorage.setItem('gc_stripe_pk', pk);
            localStorage.setItem('gc_stripe_location', location);
            localStorage.setItem('gc_register_id', registerId);
            
            STRIPE_CONFIG.publishableKey = pk;
            STRIPE_CONFIG.terminalLocationId = location;
            
            // Save to Firebase for global persistence
            try {
                const response = await fetch(`${FUNCTIONS_URL}/saveGlobalSettings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        stripePublishableKey: pk,
                        stripeTerminalLocation: location
                    })
                });
                const data = await response.json();
                if (data.success) {
                    showToast('Settings saved globally! Reinitializing Stripe...', 'success');
                } else {
                    showToast('Settings saved locally. Firebase save failed.', 'warning');
                }
            } catch (e) {
                console.error('Failed to save to Firebase:', e);
                showToast('Settings saved locally. Firebase unavailable.', 'warning');
            }
            
            closeSettings();
            
            if (pk) {
                initStripeTerminal();
            }
        }
        
        // Connect USB cash drawer
        async function connectCashDrawer() {
            if (typeof CashDrawer === 'undefined') {
                showToast('Cash drawer module not loaded', 'error');
                return;
            }
            
            try {
                await CashDrawer.connect();
                // Update status in modal
                const status = document.getElementById('drawerStatus');
                if (status) {
                    status.innerHTML = '<span style="color:#27ae60;"><i class="fas fa-check-circle"></i> Connected</span>';
                }
            } catch (err) {
                showToast('Failed to connect: ' + err.message, 'error');
            }
        }
        
        // ============ REFUNDS ============
        function processRefund(transactionId) {
            const trans = transactions.find(t => t.id === transactionId);
            if (!trans) return showToast('Transaction not found', 'error');
            if (trans.isReturn) return showToast('Cannot refund a return', 'error');
            
            if (!confirm(`Refund $${trans.amount.toFixed(2)} to ${trans.customer}?`)) return;
            
            // If Stripe payment, process refund through Stripe
            if (trans.stripePaymentId && trans.method === 'card') {
                processStripeRefund(trans);
            } else {
                completeRefund(trans);
            }
        }
        
        async function processStripeRefund(trans) {
            showToast('Processing Stripe refund...', 'info');
            
            // In production, call your backend:
            // const response = await fetch('/api/stripe/refund', {
            //     method: 'POST',
            //     headers: { 'Content-Type': 'application/json' },
            //     body: JSON.stringify({ paymentIntentId: trans.stripePaymentId, amount: Math.round(trans.amount * 100) })
            // });
            
            // For demo:
            console.log('Would refund Stripe payment:', trans.stripePaymentId);
            completeRefund(trans);
        }
        
        function completeRefund(originalTrans) {
            const refundTrans = {
                id: 26763 + transactions.length,
                customer: originalTrans.customer,
                amount: -originalTrans.amount,
                method: originalTrans.method,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: new Date().toISOString(),
                isReturn: true,
                refundOf: originalTrans.id,
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            };
            
            transactions.unshift(refundTrans);
            saveTransactions();
            syncTransactionToFirebase(refundTrans);
            renderTransactions();
            showToast(`Refund of $${originalTrans.amount.toFixed(2)} processed`, 'success');
        }
        
        // ============ INVENTORY MANAGEMENT ============
        function showInventory() {
            const trackedItems = items.filter(i => i.trackInventory);
            const lowStock = trackedItems.filter(i => i.stock <= 5);
            const outOfStock = trackedItems.filter(i => i.stock === 0);
            const totalValue = trackedItems.reduce((sum, i) => sum + (i.stock * i.price), 0);
            
            let html = `
                <div id="inventoryModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px;">
                    <div style="background:#fff;border-radius:16px;max-width:900px;width:100%;max-height:90vh;display:flex;flex-direction:column;overflow:hidden;box-shadow:0 20px 60px rgba(0,0,0,0.3);">
                        
                        <!-- Header -->
                        <div style="background:linear-gradient(135deg, #4a9eb4 0%, #3d8a9a 100%);color:#fff;padding:20px 25px;display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <h2 style="margin:0;font-size:22px;font-weight:600;"><i class="fas fa-boxes"></i> Inventory Management</h2>
                                <p style="margin:5px 0 0;opacity:0.9;font-size:14px;">Track and manage your stock levels</p>
                            </div>
                            <button onclick="closeInventory()" style="background:rgba(255,255,255,0.2);border:none;color:#fff;width:40px;height:40px;border-radius:50%;cursor:pointer;font-size:18px;transition:background 0.2s;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <!-- Stats Cards -->
                        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:15px;padding:20px 25px;background:#f8f9fa;border-bottom:1px solid #e9ecef;">
                            <div style="background:#fff;padding:15px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                                <div style="font-size:28px;font-weight:700;color:#4a9eb4;">${trackedItems.length}</div>
                                <div style="font-size:12px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">Products</div>
                            </div>
                            <div style="background:#fff;padding:15px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);">
                                <div style="font-size:28px;font-weight:700;color:#27ae60;">$${totalValue.toFixed(0)}</div>
                                <div style="font-size:12px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">Total Value</div>
                            </div>
                            <div style="background:#fff;padding:15px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);${lowStock.length > 0 ? 'border:2px solid #f39c12;' : ''}">
                                <div style="font-size:28px;font-weight:700;color:#f39c12;">${lowStock.length}</div>
                                <div style="font-size:12px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">Low Stock</div>
                            </div>
                            <div style="background:#fff;padding:15px;border-radius:10px;text-align:center;box-shadow:0 2px 8px rgba(0,0,0,0.06);${outOfStock.length > 0 ? 'border:2px solid #e74c3c;' : ''}">
                                <div style="font-size:28px;font-weight:700;color:#e74c3c;">${outOfStock.length}</div>
                                <div style="font-size:12px;color:#666;text-transform:uppercase;letter-spacing:0.5px;">Out of Stock</div>
                            </div>
                        </div>
                        
                        ${lowStock.length > 0 ? `
                            <div style="background:#fff3cd;padding:12px 25px;border-bottom:1px solid #ffeeba;display:flex;align-items:center;gap:10px;">
                                <i class="fas fa-exclamation-triangle" style="color:#856404;"></i>
                                <span style="color:#856404;font-size:14px;"><strong>Low Stock:</strong> ${lowStock.map(i => `${i.name} (${i.stock})`).join(', ')}</span>
                            </div>
                        ` : ''}
                        
                        <!-- Search & Filter -->
                        <div style="padding:15px 25px;background:#fff;border-bottom:1px solid #e9ecef;display:flex;gap:12px;flex-wrap:wrap;">
                            <div style="flex:1;min-width:200px;position:relative;">
                                <i class="fas fa-search" style="position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#999;"></i>
                                <input type="text" id="invSearch" placeholder="Search items..." style="width:100%;padding:10px 10px 10px 38px;border:1px solid #ddd;border-radius:8px;font-size:14px;" oninput="filterInventory(this.value)">
                            </div>
                            <select id="invCategory" style="padding:10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;min-width:150px;background:#fff;cursor:pointer;" onchange="filterInventory(document.getElementById('invSearch').value)">
                                <option value="">All Categories</option>
                                <option value="food">Food</option>
                                <option value="beer">Beer</option>
                                <option value="wine">Wine</option>
                                <option value="beverage">Beverages</option>
                                <option value="merch">Merchandise</option>
                            </select>
                            <select id="invStockFilter" style="padding:10px 15px;border:1px solid #ddd;border-radius:8px;font-size:14px;min-width:140px;background:#fff;cursor:pointer;" onchange="filterInventory(document.getElementById('invSearch').value)">
                                <option value="">All Stock Levels</option>
                                <option value="low">Low Stock (5 or less)</option>
                                <option value="out">Out of Stock</option>
                                <option value="ok">In Stock</option>
                            </select>
                        </div>
                        
                        <!-- Table -->
                        <div style="flex:1;overflow-y:auto;padding:0;">
                            <table style="width:100%;border-collapse:collapse;" id="invTable">
                                <thead style="position:sticky;top:0;background:#f8f9fa;z-index:10;">
                                    <tr>
                                        <th style="padding:12px 15px;text-align:left;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;border-bottom:2px solid #e9ecef;">Item</th>
                                        <th style="padding:12px 15px;text-align:center;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;border-bottom:2px solid #e9ecef;">Category</th>
                                        <th style="padding:12px 15px;text-align:center;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;border-bottom:2px solid #e9ecef;">Price</th>
                                        <th style="padding:12px 15px;text-align:center;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;border-bottom:2px solid #e9ecef;">Stock</th>
                                        <th style="padding:12px 15px;text-align:center;font-weight:600;font-size:12px;text-transform:uppercase;color:#666;border-bottom:2px solid #e9ecef;width:180px;">Adjust</th>
                                    </tr>
                                </thead>
                                <tbody id="invBody">
                                    ${renderInventoryRows(trackedItems)}
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Footer Actions -->
                        <div style="padding:15px 25px;background:#f8f9fa;border-top:1px solid #e9ecef;display:flex;gap:10px;justify-content:flex-end;">
                            <button onclick="exportInventory()" style="padding:10px 20px;border:1px solid #3498db;background:#fff;color:#3498db;border-radius:8px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:8px;transition:all 0.2s;">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                            <button onclick="resetInventory()" style="padding:10px 20px;border:1px solid #e74c3c;background:#fff;color:#e74c3c;border-radius:8px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:8px;transition:all 0.2s;">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button onclick="closeInventory()" style="padding:10px 25px;border:none;background:#4a9eb4;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.2s;">
                                Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function renderInventoryRows(itemList) {
            if (itemList.length === 0) {
                return `<tr><td colspan="5" style="padding:40px;text-align:center;color:#999;"><i class="fas fa-box-open" style="font-size:40px;margin-bottom:10px;display:block;"></i>No items found</td></tr>`;
            }
            return itemList.map(item => {
                let statusBadge = '';
                let rowStyle = '';
                if (item.stock === 0) {
                    statusBadge = '<span style="background:#e74c3c;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">OUT</span>';
                    rowStyle = 'background:#fff5f5;';
                } else if (item.stock <= 5) {
                    statusBadge = '<span style="background:#f39c12;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">LOW</span>';
                    rowStyle = 'background:#fffbf0;';
                } else {
                    statusBadge = `<span style="background:#27ae60;color:#fff;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:600;">${item.stock}</span>`;
                }
                
                return `
                    <tr data-category="${item.category}" data-name="${item.name.toLowerCase()}" data-stock="${item.stock}" style="${rowStyle}transition:background 0.2s;">
                        <td style="padding:12px 15px;border-bottom:1px solid #eee;">
                            <div style="font-weight:500;">${item.name}</div>
                        </td>
                        <td style="padding:12px 15px;border-bottom:1px solid #eee;text-align:center;">
                            <span style="background:#f0f0f0;padding:4px 10px;border-radius:6px;font-size:13px;text-transform:capitalize;">${item.category}</span>
                        </td>
                        <td style="padding:12px 15px;border-bottom:1px solid #eee;text-align:center;font-weight:500;">$${item.price.toFixed(2)}</td>
                        <td style="padding:12px 15px;border-bottom:1px solid #eee;text-align:center;">${statusBadge}</td>
                        <td style="padding:12px 15px;border-bottom:1px solid #eee;text-align:center;">
                            <div style="display:flex;align-items:center;justify-content:center;gap:6px;">
                                <button onclick="adjustStock(${item.id}, -5)" style="width:32px;height:32px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-weight:600;color:#e74c3c;" title="-5">-5</button>
                                <button onclick="adjustStock(${item.id}, -1)" style="width:32px;height:32px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-weight:600;color:#e74c3c;">-</button>
                                <input type="number" value="${item.stock}" onchange="setStockDirect(${item.id}, this.value)" style="width:50px;text-align:center;padding:6px;border:1px solid #ddd;border-radius:6px;font-weight:600;" min="0">
                                <button onclick="adjustStock(${item.id}, 1)" style="width:32px;height:32px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-weight:600;color:#27ae60;">+</button>
                                <button onclick="adjustStock(${item.id}, 5)" style="width:32px;height:32px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;font-weight:600;color:#27ae60;" title="+5">+5</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function filterInventory(query) {
            const category = document.getElementById('invCategory').value;
            const stockFilter = document.getElementById('invStockFilter')?.value || '';
            const rows = document.querySelectorAll('#invBody tr');
            rows.forEach(row => {
                const name = row.dataset.name;
                const cat = row.dataset.category;
                const stock = parseInt(row.dataset.stock) || 0;
                const matchesSearch = !query || name.includes(query.toLowerCase());
                const matchesCategory = !category || cat === category;
                let matchesStock = true;
                if (stockFilter === 'low') matchesStock = stock > 0 && stock <= 5;
                else if (stockFilter === 'out') matchesStock = stock === 0;
                else if (stockFilter === 'ok') matchesStock = stock > 5;
                row.style.display = matchesSearch && matchesCategory && matchesStock ? '' : 'none';
            });
        }
        
        function adjustStock(itemId, delta) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                item.stock = Math.max(0, (item.stock || 0) + delta);
                saveInventory();
                refreshInventoryTable();
                showToast(`${item.name}: ${delta > 0 ? '+' : ''}${delta} (now ${item.stock})`, delta > 0 ? 'success' : 'warning');
            }
        }
        
        function setStockDirect(itemId, value) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            const qty = parseInt(value);
            if (isNaN(qty) || qty < 0) return;
            item.stock = qty;
            saveInventory();
            refreshInventoryTable();
            showToast(`${item.name} stock set to ${qty}`, 'success');
        }
        
        function refreshInventoryTable() {
            const trackedItems = items.filter(i => i.trackInventory);
            document.getElementById('invBody').innerHTML = renderInventoryRows(trackedItems);
            filterInventory(document.getElementById('invSearch')?.value || '');
        }
        
        function setStock(itemId) {
            const item = items.find(i => i.id === itemId);
            if (!item) return;
            const newStock = prompt(`Set stock for ${item.name}:`, item.stock);
            if (newStock === null) return;
            const qty = parseInt(newStock);
            if (isNaN(qty) || qty < 0) return showToast('Invalid quantity', 'error');
            item.stock = qty;
            saveInventory();
            refreshInventoryTable();
            showToast(`${item.name} stock set to ${qty}`, 'success');
        }
        
        function closeInventory() {
            const modal = document.getElementById('inventoryModal');
            if (modal) modal.remove();
        }
        
        function exportInventory() {
            const trackedItems = items.filter(i => i.trackInventory);
            let csv = 'Item,Category,Stock,Price\n';
            trackedItems.forEach(i => {
                csv += `"${i.name}","${i.category}",${i.stock},${i.price}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Inventory exported', 'success');
        }
        
        function resetInventory() {
            if (!confirm('Reset all inventory to default levels? This cannot be undone.')) return;
            localStorage.removeItem('gc_inventory');
            items = [...defaultItems];
            closeInventory();
            showInventory();
            showToast('Inventory reset to defaults', 'success');
        }
        
        // ============ DATA IMPORT/EXPORT ============
        function showDataImportModal() {
            const html = `
                <div id="dataImportModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:800px;width:95%;max-height:90vh;overflow-y:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h3 style="margin:0;"><i class="fas fa-upload"></i> Import Data</h3>
                            <button onclick="closeDataImport()" style="border:none;background:none;font-size:20px;cursor:pointer;">×</button>
                        </div>
                        
                        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:15px;margin-bottom:20px;">
                            <div class="import-type-card" onclick="selectImportType('products')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-products">
                                <i class="fas fa-box" style="font-size:30px;color:#3498db;margin-bottom:10px;display:block;"></i>
                                <strong>Products</strong>
                                <div style="font-size:12px;color:#666;">Menu items, merchandise</div>
                            </div>
                            <div class="import-type-card" onclick="selectImportType('inventory')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-inventory">
                                <i class="fas fa-warehouse" style="font-size:30px;color:#27ae60;margin-bottom:10px;display:block;"></i>
                                <strong>Inventory</strong>
                                <div style="font-size:12px;color:#666;">Stock levels only</div>
                            </div>
                            <div class="import-type-card" onclick="selectImportType('transactions')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-transactions">
                                <i class="fas fa-receipt" style="font-size:30px;color:#9b59b6;margin-bottom:10px;display:block;"></i>
                                <strong>Transactions</strong>
                                <div style="font-size:12px;color:#666;">Historical sales</div>
                            </div>
                            <div class="import-type-card" onclick="selectImportType('customers')" style="padding:20px;border:2px solid #ddd;border-radius:10px;text-align:center;cursor:pointer;transition:all 0.2s;" id="import-customers">
                                <i class="fas fa-users" style="font-size:30px;color:#e67e22;margin-bottom:10px;display:block;"></i>
                                <strong>Customers</strong>
                                <div style="font-size:12px;color:#666;">Customer list</div>
                            </div>
                        </div>
                        
                        <div id="importUploadArea" style="display:none;">
                            <div style="border:2px dashed #ccc;border-radius:10px;padding:40px;text-align:center;margin-bottom:15px;" 
                                 ondrop="handleFileDrop(event)" ondragover="event.preventDefault();this.style.borderColor='#27ae60'" ondragout="this.style.borderColor='#ccc'">
                                <i class="fas fa-cloud-upload-alt" style="font-size:40px;color:#ccc;margin-bottom:10px;"></i>
                                <div style="margin-bottom:10px;">Drag & drop CSV or JSON file here</div>
                                <input type="file" id="importFileInput" accept=".csv,.json" style="display:none;" onchange="handleFileSelect(event)">
                                <button onclick="document.getElementById('importFileInput').click()" style="padding:10px 20px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">
                                    <i class="fas fa-folder-open"></i> Choose File
                                </button>
                            </div>
                            
                            <div id="importFieldMapping" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                                <h4 style="margin:0 0 10px;">Field Mapping</h4>
                                <div id="fieldMappingContent"></div>
                            </div>
                            
                            <div id="importPreview" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;max-height:300px;overflow:auto;">
                                <h4 style="margin:0 0 10px;">Preview</h4>
                                <div id="previewContent"></div>
                            </div>
                            
                            <div style="display:flex;gap:10px;margin-bottom:15px;">
                                <label style="flex:1;display:flex;align-items:center;gap:5px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateAction" value="skip" checked> Skip duplicates
                                </label>
                                <label style="flex:1;display:flex;align-items:center;gap:5px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateAction" value="update"> Update existing
                                </label>
                                <label style="flex:1;display:flex;align-items:center;gap:5px;padding:10px;background:#fff;border:1px solid #ddd;border-radius:6px;cursor:pointer;">
                                    <input type="radio" name="duplicateAction" value="create"> Create all new
                                </label>
                            </div>
                        </div>
                        
                        <div id="importTemplates" style="display:none;background:#e8f5e9;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <h4 style="margin:0 0 10px;"><i class="fas fa-file-download"></i> Download Template</h4>
                            <button onclick="downloadTemplate()" style="padding:8px 15px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;">
                                <i class="fas fa-download"></i> Download CSV Template
                            </button>
                            <span style="font-size:12px;color:#666;margin-left:10px;">Use this template to format your data correctly</span>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeDataImport()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button id="executeImportBtn" onclick="executeDataImport()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;display:none;">
                                <i class="fas fa-check"></i> Import Data
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        let selectedImportType = null;
        let pendingImportData = null;
        let detectedMapping = {};
        
        function selectImportType(type) {
            selectedImportType = type;
            document.querySelectorAll('.import-type-card').forEach(c => c.style.borderColor = '#ddd');
            document.getElementById('import-' + type).style.borderColor = '#27ae60';
            document.getElementById('importUploadArea').style.display = 'block';
            document.getElementById('importTemplates').style.display = 'block';
            document.getElementById('importFieldMapping').style.display = 'none';
            document.getElementById('importPreview').style.display = 'none';
            document.getElementById('executeImportBtn').style.display = 'none';
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) processImportFile(file);
        }
        
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) processImportFile(file);
        }
        
        function processImportFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let data;
                if (file.name.endsWith('.json')) {
                    try {
                        data = JSON.parse(content);
                        if (!Array.isArray(data)) data = [data];
                    } catch (err) {
                        return showToast('Invalid JSON file', 'error');
                    }
                } else {
                    data = parseImportCSV(content);
                }
                
                if (!data || data.length === 0) {
                    return showToast('No data found in file', 'error');
                }
                
                pendingImportData = data;
                detectAndShowMapping(data);
            };
            reader.readAsText(file);
        }
        
        function parseImportCSV(content) {
            const lines = content.trim().split('\n');
            if (lines.length < 2) return [];
            
            const headers = parseCSVLine(lines[0]);
            const rows = [];
            
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((h, idx) => {
                    row[h.trim().toLowerCase().replace(/\s+/g, '_')] = values[idx] || '';
                });
                rows.push(row);
            }
            return rows;
        }
        
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        function detectAndShowMapping(data) {
            const sample = data[0];
            const keys = Object.keys(sample);
            
            // Expected fields by import type
            const expectedFields = {
                products: ['name', 'price', 'category', 'stock', 'sku', 'description'],
                inventory: ['name', 'sku', 'stock', 'min_stock', 'reorder_qty'],
                transactions: ['date', 'time', 'customer', 'amount', 'method', 'items', 'tax', 'discount'],
                customers: ['first_name', 'last_name', 'email', 'phone', 'member', 'member_type']
            };
            
            detectedMapping = {};
            const expected = expectedFields[selectedImportType] || [];
            
            // Auto-detect mappings
            expected.forEach(field => {
                const found = keys.find(k => {
                    const kLower = k.toLowerCase();
                    return kLower === field || 
                           kLower.includes(field) || 
                           field.includes(kLower) ||
                           kLower.replace(/_/g, '') === field.replace(/_/g, '');
                });
                if (found) detectedMapping[field] = found;
            });
            
            // Show mapping UI
            let mappingHTML = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">';
            expected.forEach(field => {
                mappingHTML += `
                    <div style="display:flex;align-items:center;gap:10px;">
                        <label style="min-width:100px;font-weight:600;">${field}:</label>
                        <select id="map_${field}" style="flex:1;padding:8px;border:1px solid #ddd;border-radius:4px;">
                            <option value="">-- Skip --</option>
                            ${keys.map(k => `<option value="${k}" ${detectedMapping[field] === k ? 'selected' : ''}>${k}</option>`).join('')}
                        </select>
                    </div>
                `;
            });
            mappingHTML += '</div>';
            
            document.getElementById('fieldMappingContent').innerHTML = mappingHTML;
            document.getElementById('importFieldMapping').style.display = 'block';
            
            // Show preview
            showImportPreview(data.slice(0, 5));
            document.getElementById('executeImportBtn').style.display = 'block';
        }
        
        function showImportPreview(data) {
            if (!data.length) return;
            
            let html = `<div style="font-size:12px;color:#666;margin-bottom:5px;">Showing ${data.length} of ${pendingImportData.length} records</div>`;
            html += '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
            html += '<tr style="background:#e9ecef;">' + Object.keys(data[0]).map(k => `<th style="padding:5px;border:1px solid #ddd;">${k}</th>`).join('') + '</tr>';
            data.forEach(row => {
                html += '<tr>' + Object.values(row).map(v => `<td style="padding:5px;border:1px solid #ddd;">${String(v).substring(0, 30)}</td>`).join('') + '</tr>';
            });
            html += '</table>';
            
            document.getElementById('previewContent').innerHTML = html;
            document.getElementById('importPreview').style.display = 'block';
        }
        
        function executeDataImport() {
            if (!pendingImportData || !selectedImportType) {
                return showToast('No data to import', 'error');
            }
            
            const duplicateAction = document.querySelector('input[name="duplicateAction"]:checked').value;
            
            // Gather mapping
            const expectedFields = {
                products: ['name', 'price', 'category', 'stock', 'sku', 'description'],
                inventory: ['name', 'sku', 'stock', 'min_stock', 'reorder_qty'],
                transactions: ['date', 'time', 'customer', 'amount', 'method', 'items', 'tax', 'discount'],
                customers: ['first_name', 'last_name', 'email', 'phone', 'member', 'member_type']
            };
            
            const mapping = {};
            (expectedFields[selectedImportType] || []).forEach(field => {
                const sel = document.getElementById('map_' + field);
                if (sel && sel.value) mapping[field] = sel.value;
            });
            
            let imported = 0, skipped = 0, updated = 0;
            
            if (selectedImportType === 'products') {
                pendingImportData.forEach(row => {
                    const name = row[mapping.name] || '';
                    if (!name) return skipped++;
                    
                    const existing = items.findIndex(i => i.name.toLowerCase() === name.toLowerCase());
                    
                    if (existing >= 0) {
                        if (duplicateAction === 'skip') return skipped++;
                        if (duplicateAction === 'update') {
                            items[existing] = {
                                ...items[existing],
                                price: parseFloat(row[mapping.price]) || items[existing].price,
                                category: row[mapping.category] || items[existing].category,
                                stock: parseInt(row[mapping.stock]) || items[existing].stock,
                                sku: row[mapping.sku] || items[existing].sku
                            };
                            return updated++;
                        }
                    }
                    
                    items.push({
                        name: name,
                        price: parseFloat(row[mapping.price]) || 0,
                        category: row[mapping.category] || 'misc',
                        stock: parseInt(row[mapping.stock]) || 0,
                        trackInventory: true,
                        sku: row[mapping.sku] || ''
                    });
                    imported++;
                });
                saveInventory();
                renderInventoryRows(items);
            }
            
            else if (selectedImportType === 'inventory') {
                pendingImportData.forEach(row => {
                    const name = row[mapping.name] || row[mapping.sku] || '';
                    if (!name) return skipped++;
                    
                    const existing = items.findIndex(i => 
                        i.name.toLowerCase() === name.toLowerCase() ||
                        (i.sku && i.sku.toLowerCase() === name.toLowerCase())
                    );
                    
                    if (existing >= 0) {
                        items[existing].stock = parseInt(row[mapping.stock]) || 0;
                        updated++;
                    } else {
                        skipped++;
                    }
                });
                saveInventory();
            }
            
            else if (selectedImportType === 'transactions') {
                pendingImportData.forEach(row => {
                    const trans = {
                        id: 26763 + transactions.length + imported,
                        customer: row[mapping.customer] || 'Imported',
                        amount: parseFloat(row[mapping.amount]) || 0,
                        method: row[mapping.method] || 'cash',
                        time: row[mapping.time] || '12:00 PM',
                        date: row[mapping.date] || new Date().toISOString(),
                        imported: true,
                        importDate: new Date().toISOString(),
                        register: 'IMPORT'
                    };
                    
                    if (row[mapping.items]) {
                        try {
                            trans.itemList = JSON.parse(row[mapping.items]);
                        } catch (e) {
                            trans.itemList = row[mapping.items];
                        }
                    }
                    
                    transactions.push(trans);
                    syncTransactionToFirebase(trans);
                    imported++;
                });
                saveTransactions();
                renderTransactions();
            }
            
            else if (selectedImportType === 'customers') {
                let customers = JSON.parse(localStorage.getItem('gc_customers') || '[]');
                pendingImportData.forEach(row => {
                    const firstName = row[mapping.first_name] || '';
                    const lastName = row[mapping.last_name] || '';
                    const email = row[mapping.email] || '';
                    const phone = row[mapping.phone] || '';
                    
                    if (!firstName && !lastName && !email) return skipped++;
                    
                    const fullName = `${firstName} ${lastName}`.trim();
                    const existing = customers.findIndex(c => {
                        const cFullName = c.firstName ? `${c.firstName} ${c.lastName}` : c.name || '';
                        return cFullName.toLowerCase() === fullName.toLowerCase() ||
                            (email && c.email && c.email.toLowerCase() === email.toLowerCase());
                    });
                    
                    if (existing >= 0) {
                        if (duplicateAction === 'skip') return skipped++;
                        if (duplicateAction === 'update') {
                            customers[existing] = {
                                ...customers[existing],
                                firstName: firstName || customers[existing].firstName,
                                lastName: lastName || customers[existing].lastName,
                                email: email || customers[existing].email,
                                phone: phone || customers[existing].phone,
                                isMember: row[mapping.member] === 'true' || row[mapping.member] === '1' || customers[existing].isMember
                            };
                            return updated++;
                        }
                    }
                    
                    customers.push({
                        id: Date.now() + imported,
                        firstName: firstName,
                        lastName: lastName,
                        email: email,
                        phone: phone,
                        isMember: row[mapping.member] === 'true' || row[mapping.member] === '1',
                        memberType: row[mapping.member_type] || null,
                        priceClass: 'Regular',
                        visitCount: 0,
                        totalSpent: 0,
                        passes: [],
                        imported: true,
                        importDate: new Date().toISOString(),
                        createdAt: new Date().toISOString()
                    });
                    imported++;
                });
                localStorage.setItem('gc_customers', JSON.stringify(customers));
            }
            
            // Log import to history
            const history = JSON.parse(localStorage.getItem('gc_import_history') || '[]');
            history.unshift({
                type: selectedImportType,
                date: new Date().toISOString(),
                imported: imported,
                skipped: skipped,
                updated: updated,
                total: pendingImportData.length
            });
            localStorage.setItem('gc_import_history', JSON.stringify(history.slice(0, 50)));
            
            closeDataImport();
            showToast(`Import complete: ${imported} added, ${updated} updated, ${skipped} skipped`, 'success');
        }
        
        function downloadTemplate() {
            const templates = {
                products: 'name,price,category,stock,sku,description\n"Hot Dog",4.50,"food",100,"HD001","Classic hot dog"\n"Draft Beer",6.00,"beer",50,"BER001","16oz draft"',
                inventory: 'name,sku,stock,min_stock,reorder_qty\n"Hot Dog","HD001",100,10,50\n"Draft Beer","BER001",50,20,30',
                transactions: 'date,time,customer,amount,method,items,tax,discount\n"2024-01-15","10:30 AM","John Doe",45.75,"card","[]",2.75,0',
                customers: 'first_name,last_name,email,phone,member,member_type\n"John","Doe","john@email.com","555-1234","true","Gold"\n"Jane","Smith","jane@email.com","555-5678","false",""'
            };
            
            const content = templates[selectedImportType] || '';
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${selectedImportType}_template.csv`;
            a.click();
            showToast('Template downloaded', 'success');
        }
        
        function closeDataImport() {
            const modal = document.getElementById('dataImportModal');
            if (modal) modal.remove();
            pendingImportData = null;
            selectedImportType = null;
            detectedMapping = {};
        }
        
        function exportAllData() {
            const allData = {
                exportDate: new Date().toISOString(),
                version: '1.0',
                products: items,
                transactions: transactions,
                customers: stripeCustomersCache,
                tabs: JSON.parse(localStorage.getItem('gc_tabs') || '[]'),
                bookings: JSON.parse(localStorage.getItem('gc_bookings') || '[]'),
                settings: {
                    stripePK: localStorage.getItem('gc_stripe_pk'),
                    stripeLocation: localStorage.getItem('gc_stripe_location'),
                    registerId: localStorage.getItem('gc_register_id')
                }
            };
            
            const blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `golf_cove_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            showToast('All data exported', 'success');
        }
        
        function backupToJSON() {
            exportAllData();
        }
        
        function restoreFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(evt) {
                    try {
                        const data = JSON.parse(evt.target.result);
                        
                        if (!confirm(`This will restore data from ${data.exportDate || 'backup'}. Current data will be replaced. Continue?`)) return;
                        
                        if (data.products) {
                            items = data.products;
                            saveInventory();
                            renderInventoryRows(items);
                        }
                        if (data.transactions) {
                            transactions = data.transactions;
                            saveTransactions();
                            // Sync all restored transactions to Firebase
                            transactions.forEach(t => syncTransactionToFirebase(t));
                            renderTransactions();
                        }
                        if (data.customers) {
                            localStorage.setItem('gc_customers', JSON.stringify(data.customers));
                        }
                        if (data.tabs) {
                            localStorage.setItem('gc_tabs', JSON.stringify(data.tabs));
                        }
                        if (data.bookings) {
                            localStorage.setItem('gc_bookings', JSON.stringify(data.bookings));
                        }
                        if (data.settings) {
                            if (data.settings.stripePK) localStorage.setItem('gc_stripe_pk', data.settings.stripePK);
                            if (data.settings.stripeLocation) localStorage.setItem('gc_stripe_location', data.settings.stripeLocation);
                            if (data.settings.registerId) localStorage.setItem('gc_register_id', data.settings.registerId);
                        }
                        
                        showToast('Data restored successfully', 'success');
                    } catch (err) {
                        showToast('Invalid backup file', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // ============ HELPER FUNCTIONS ============
        function showGenericModal(title, content, id) {
            const html = `
                <div id="${id}" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="hideGenericModal('${id}')">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:90%;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 15px;">${title}</h3>
                        ${content}
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function hideGenericModal(id) {
            const modal = document.getElementById(id);
            if (modal) modal.remove();
        }
        
        // Last receipt reprint
        let lastReceiptData = null;
        
        function reprintLastReceipt() {
            if (!lastReceiptData) return showToast('No receipt to reprint', 'error');
            printReceipt(lastReceiptData.customer, lastReceiptData.total, lastReceiptData.method, lastReceiptData.items);
        }
        
        // Initialize Stripe on load (if configured)
        if (STRIPE_CONFIG.publishableKey) {
            initStripeTerminal();
        }
        
        // Check low stock on load
        checkLowStock();
        const lowStockItems = items.filter(i => i.trackInventory && i.stock !== undefined && i.stock <= 5);
        if (lowStockItems.length > 0) {
            setTimeout(() => showToast(`⚠️ ${lowStockItems.length} item(s) low on stock`, 'warning'), 2000);
        }
        
        // Show keyboard shortcuts hint on load
        setTimeout(() => {
            showToast('F1: Help | F2: Search | F7: Split Pay | F8: Cash | F9: Card | F10: Settings', 'success');
        }, 1000);
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F1') { e.preventDefault(); showKeyboardHelp(); }
            if (e.key === 'F2') { e.preventDefault(); document.getElementById('itemSearch').focus(); }
            if (e.key === 'F7') { e.preventDefault(); showSplitPaymentModal(); }
            if (e.key === 'F8') { e.preventDefault(); processPayment('cash'); }
            if (e.key === 'F9') { e.preventDefault(); processPayment('card'); }
            if (e.key === 'F10') { e.preventDefault(); showSettings(); }
            if (e.key === 'F12') { e.preventDefault(); showEndOfDayReport(); }
            if (e.key === 'Escape') { closeAllModals(); }
        });
        
        function closeAllModals() {
            ['itemsModal', 'settingsModal', 'inventoryModal', 'dataImportModal', 'cashModal', 'manualCardModal'].forEach(id => {
                const modal = document.getElementById(id);
                if (modal) modal.classList.remove('active') || modal.remove();
            });
        }
        
        function showKeyboardHelp() {
            const html = `
                <div id="helpModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:90%;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-keyboard"></i> Keyboard Shortcuts</h3>
                        <table style="width:100%;border-collapse:collapse;">
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F1</kbd></td><td>Show this help</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F2</kbd></td><td>Search items</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F7</kbd></td><td>Split payment</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F8</kbd></td><td>Pay with cash</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F9</kbd></td><td>Pay with card</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F10</kbd></td><td>Settings</td></tr>
                            <tr><td style="padding:8px;border-bottom:1px solid #eee;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">F12</kbd></td><td>End of day report</td></tr>
                            <tr><td style="padding:8px;"><kbd style="background:#e9ecef;padding:3px 8px;border-radius:4px;">Esc</kbd></td><td>Close modals</td></tr>
                        </table>
                        <button onclick="this.parentElement.parentElement.remove()" style="width:100%;margin-top:15px;padding:12px;background:#4a90a4;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        // ============ SPLIT PAYMENT ============
        function showSplitPaymentModal() {
            if (saleItems.length === 0) return showToast('No items in sale', 'error');
            
            const subtotal = saleItems.reduce((sum, item) => sum + (item.price * item.qty * (1 - item.discount / 100)), 0);
            const total = subtotal * (1 + getTaxRate());
            const customer = document.getElementById('customerName').value || 'Walk-in';
            
            const html = `
                <div id="splitPayModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:500px;width:95%;">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-divide"></i> Split Payment</h3>
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;text-align:center;">
                            <div style="font-size:24px;font-weight:700;">$${total.toFixed(2)}</div>
                            <div style="color:#666;">${customer}</div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Card Amount:</label>
                            <input type="number" id="splitCardAmt" step="0.01" min="0" max="${total.toFixed(2)}" value="${(total/2).toFixed(2)}" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;" onkeyup="updateSplitCash()">
                        </div>
                        <div style="margin-bottom:20px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Cash Amount:</label>
                            <input type="number" id="splitCashAmt" step="0.01" min="0" value="${(total/2).toFixed(2)}" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;background:#f8f9fa;" readonly>
                        </div>
                        
                        <div style="display:flex;gap:10px;margin-bottom:15px;">
                            <button onclick="setSplitRatio(0.5)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;">50/50</button>
                            <button onclick="setSplitRatio(0.25)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;">25/75</button>
                            <button onclick="setSplitRatio(0.75)" style="flex:1;padding:10px;border:1px solid #ddd;background:#fff;border-radius:6px;cursor:pointer;">75/25</button>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeSplitPayModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="processSplitPayment()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Process Split</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            window.splitPaymentTotal = total;
            window.splitPaymentCustomer = customer;
        }
        
        function updateSplitCash() {
            const cardAmt = parseFloat(document.getElementById('splitCardAmt').value) || 0;
            const cashAmt = Math.max(0, window.splitPaymentTotal - cardAmt);
            document.getElementById('splitCashAmt').value = cashAmt.toFixed(2);
        }
        
        function setSplitRatio(cardRatio) {
            const cardAmt = window.splitPaymentTotal * cardRatio;
            document.getElementById('splitCardAmt').value = cardAmt.toFixed(2);
            updateSplitCash();
        }
        
        function closeSplitPayModal() {
            const modal = document.getElementById('splitPayModal');
            if (modal) modal.remove();
        }
        
        function processSplitPayment() {
            const cardAmt = parseFloat(document.getElementById('splitCardAmt').value) || 0;
            const cashAmt = parseFloat(document.getElementById('splitCashAmt').value) || 0;
            
            if (Math.abs((cardAmt + cashAmt) - window.splitPaymentTotal) > 0.01) {
                return showToast('Split amounts must equal total', 'error');
            }
            
            closeSplitPayModal();
            
            // Process as split payment
            const now = new Date();
            const transaction = {
                id: 26763 + transactions.length,
                customer: window.splitPaymentCustomer,
                amount: window.splitPaymentTotal,
                method: 'split',
                splitDetails: { card: cardAmt, cash: cashAmt },
                time: now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: now.toISOString(),
                itemCount: saleItems.length,
                itemDetails: saleItems.map(i => ({ name: i.name, qty: i.qty, price: i.price, discount: i.discount })),
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            };
            
            transactions.unshift(transaction);
            saveTransactions();
            syncTransactionToFirebase(transaction);
            
            if (!isReturnMode) deductInventory(saleItems);
            updateDailySales(cardAmt, 'card');
            updateDailySales(cashAmt, 'cash');
            
            showToast(`Split payment: $${cardAmt.toFixed(2)} card + $${cashAmt.toFixed(2)} cash`, 'success');
            
            saleItems = [];
            document.getElementById('customerName').value = '';
            renderSaleItems();
            renderTransactions();
        }
        
        // ============ END OF DAY REPORT ============
        function showEndOfDayReport() {
            const today = new Date().toDateString();
            const todaysTrans = transactions.filter(t => new Date(t.date).toDateString() === today);
            
            const sales = todaysTrans.filter(t => !t.isReturn);
            const returns = todaysTrans.filter(t => t.isReturn);
            
            const totalSales = sales.reduce((sum, t) => sum + t.amount, 0);
            const totalReturns = returns.reduce((sum, t) => sum + Math.abs(t.amount), 0);
            const netSales = totalSales - totalReturns;
            
            const cashSales = sales.filter(t => t.method === 'cash').reduce((sum, t) => sum + t.amount, 0);
            const cardSales = sales.filter(t => t.method === 'card').reduce((sum, t) => sum + t.amount, 0);
            const splitSales = sales.filter(t => t.method === 'split').reduce((sum, t) => sum + t.amount, 0);
            
            const html = `
                <div id="eodModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;" onclick="this.remove()">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:600px;width:95%;max-height:90vh;overflow-y:auto;" onclick="event.stopPropagation()">
                        <h3 style="margin:0 0 20px;"><i class="fas fa-chart-bar"></i> End of Day Report</h3>
                        <div style="text-align:center;color:#666;margin-bottom:20px;">${new Date().toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                        
                        <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:15px;margin-bottom:20px;">
                            <div style="background:#e8f5e9;padding:20px;border-radius:10px;text-align:center;">
                                <div style="font-size:28px;font-weight:700;color:#27ae60;">$${totalSales.toFixed(2)}</div>
                                <div style="font-size:12px;color:#666;">Gross Sales</div>
                            </div>
                            <div style="background:#ffebee;padding:20px;border-radius:10px;text-align:center;">
                                <div style="font-size:28px;font-weight:700;color:#e74c3c;">-$${totalReturns.toFixed(2)}</div>
                                <div style="font-size:12px;color:#666;">Returns</div>
                            </div>
                            <div style="background:#e3f2fd;padding:20px;border-radius:10px;text-align:center;">
                                <div style="font-size:28px;font-weight:700;color:#3498db;">$${netSales.toFixed(2)}</div>
                                <div style="font-size:12px;color:#666;">Net Sales</div>
                            </div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <h4 style="margin:0 0 15px;"><i class="fas fa-money-bill-wave"></i> Payment Breakdown</h4>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Cash:</span><strong>$${cashSales.toFixed(2)}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Card:</span><strong>$${cardSales.toFixed(2)}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;"><span>Split:</span><strong>$${splitSales.toFixed(2)}</strong></div>
                        </div>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <h4 style="margin:0 0 15px;"><i class="fas fa-receipt"></i> Transaction Summary</h4>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Total Transactions:</span><strong>${todaysTrans.length}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;"><span>Sales:</span><strong>${sales.length}</strong></div>
                            <div style="display:flex;justify-content:space-between;padding:8px 0;"><span>Returns:</span><strong>${returns.length}</strong></div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="printEODReport()" style="flex:1;padding:12px;border:none;background:#3498db;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Print</button>
                            <button onclick="exportEODReport()" style="flex:1;padding:12px;border:none;background:#27ae60;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-download"></i> Export</button>
                            <button onclick="this.closest('#eodModal').remove()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function printEODReport() {
            window.print();
        }
        
        function exportEODReport() {
            const today = new Date().toDateString();
            const todaysTrans = transactions.filter(t => new Date(t.date).toDateString() === today);
            
            let csv = 'Transaction ID,Time,Customer,Amount,Method,Items\n';
            todaysTrans.forEach(t => {
                csv += `${t.id},"${t.time}","${t.customer}",${t.amount.toFixed(2)},${t.method},${t.itemCount}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `eod_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showToast('Report exported', 'success');
        }
        
        // ============ GIFT CARD SYSTEM ============
        function redeemGiftCard() {
            const html = `
                <div id="giftCardModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:450px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#9b59b6;"><i class="fas fa-gift"></i> Redeem Gift Card</h3>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Gift Card Number:</label>
                            <input type="text" id="giftCardNumber" placeholder="Enter or scan gift card" style="width:100%;padding:12px;border:2px solid #ddd;border-radius:6px;font-size:16px;font-family:monospace;" autofocus>
                        </div>
                        
                        <div id="giftCardInfo" style="display:none;background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                <span>Balance:</span>
                                <strong id="gcBalance" style="color:#27ae60;">$0.00</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;">
                                <span>Issued:</span>
                                <span id="gcIssued">-</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <label style="display:block;margin-bottom:5px;font-weight:600;">Amount to Redeem:</label>
                            <input type="number" id="redeemAmount" step="0.01" min="0" placeholder="0.00" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;">
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="closeGiftCardModal()" style="flex:1;padding:12px;border:none;background:#95a5a6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                            <button onclick="lookupGiftCard()" style="flex:1;padding:12px;border:none;background:#3498db;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-search"></i> Lookup</button>
                            <button onclick="applyGiftCard()" style="flex:1;padding:12px;border:none;background:#9b59b6;color:#fff;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-check"></i> Redeem</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeGiftCardModal() {
            const modal = document.getElementById('giftCardModal');
            if (modal) modal.remove();
        }
        
        async function lookupGiftCard() {
            const cardNum = document.getElementById('giftCardNumber').value.trim();
            if (!cardNum) return showToast('Enter gift card number', 'error');
            
            // Use GolfCoveGiftCards module if available
            if (typeof GolfCoveGiftCards !== 'undefined') {
                const result = await GolfCoveGiftCards.checkBalance(cardNum);
                if (!result.success) {
                    showToast(result.error || 'Gift card not found', 'error');
                    document.getElementById('giftCardInfo').style.display = 'none';
                    return;
                }
                
                document.getElementById('gcBalance').textContent = '$' + result.balance.toFixed(2);
                document.getElementById('gcIssued').textContent = new Date(result.card.purchaseDate || result.card.createdAt).toLocaleDateString();
                document.getElementById('giftCardInfo').style.display = 'block';
                document.getElementById('redeemAmount').max = result.balance;
                return;
            }
            
            // Fallback: Load gift cards from storage
            const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '{}');
            const card = giftCards[cardNum];
            
            if (!card) {
                showToast('Gift card not found', 'error');
                document.getElementById('giftCardInfo').style.display = 'none';
                return;
            }
            
            document.getElementById('gcBalance').textContent = '$' + card.balance.toFixed(2);
            document.getElementById('gcIssued').textContent = new Date(card.issued).toLocaleDateString();
            document.getElementById('giftCardInfo').style.display = 'block';
            document.getElementById('redeemAmount').max = card.balance;
        }
        
        async function applyGiftCard() {
            const cardNum = document.getElementById('giftCardNumber').value.trim();
            const amount = parseFloat(document.getElementById('redeemAmount').value) || 0;
            
            if (!cardNum || amount <= 0) return showToast('Enter card number and amount', 'error');
            
            // Use GolfCoveGiftCards module if available
            if (typeof GolfCoveGiftCards !== 'undefined') {
                const result = await GolfCoveGiftCards.redeem(cardNum, amount, 'POS Redemption');
                if (!result.success) {
                    showToast(result.error || 'Redemption failed', 'error');
                    return;
                }
                
                closeGiftCardModal();
                showToast(`Gift card redeemed: $${amount.toFixed(2)} (Remaining: $${result.remainingBalance.toFixed(2)})`, 'success');
                
                // Add as negative line item to reduce total
                saleItems.push({
                    name: `Gift Card Redemption (${cardNum.slice(-4)})`,
                    price: -amount,
                    qty: 1,
                    discount: 0,
                    isGiftCard: true
                });
                renderSaleItems();
                return;
            }
            
            // Fallback: Use localStorage
            const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '{}');
            const card = giftCards[cardNum];
            
            if (!card) return showToast('Gift card not found', 'error');
            if (amount > card.balance) return showToast('Amount exceeds balance', 'error');
            
            // Apply as payment/discount
            card.balance -= amount;
            card.redemptions = card.redemptions || [];
            card.redemptions.push({
                amount: amount,
                date: new Date().toISOString(),
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            });
            
            giftCards[cardNum] = card;
            localStorage.setItem('gc_gift_cards', JSON.stringify(giftCards));
            
            // Sync to Firebase
            syncGiftCardToFirebase(cardNum, card);
            
            closeGiftCardModal();
            showToast(`Gift card redeemed: $${amount.toFixed(2)} (Remaining: $${card.balance.toFixed(2)})`, 'success');
            
            // Add as negative line item to reduce total
            saleItems.push({
                name: `Gift Card Redemption (${cardNum.slice(-4)})`,
                price: -amount,
                qty: 1,
                discount: 0,
                isGiftCard: true
            });
            renderSaleItems();
        }
        
        // Sync gift card to Firebase
        async function syncGiftCardToFirebase(cardNum, card) {
            try {
                await fetch('https://golfcove-default-rtdb.firebaseio.com/gift_cards/' + cardNum + '.json', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(card)
                });
            } catch (e) {
                console.warn('[Sales] Failed to sync gift card to Firebase:', e);
            }
        }
        
        // Generate gift card when sold
        async function generateGiftCard(amount) {
            // Use GolfCoveGiftCards module if available
            if (typeof GolfCoveGiftCards !== 'undefined') {
                const result = await GolfCoveGiftCards.create({
                    amount: amount,
                    purchasedBy: 'POS Sale',
                    paymentMethod: 'card'
                });
                
                if (result.success) {
                    showToast(`Gift Card Created: ${result.card.code}`, 'success');
                    
                    if (confirm('Print gift card?')) {
                        printGiftCard(result.card.code, amount);
                    }
                    
                    return result.card.code;
                }
            }
            
            // Fallback: Generate locally
            const cardNum = 'GC' + Date.now().toString(36).toUpperCase() + Math.random().toString(36).substring(2, 6).toUpperCase();
            const giftCards = JSON.parse(localStorage.getItem('gc_gift_cards') || '{}');
            
            const card = {
                balance: amount,
                originalAmount: amount,
                issued: new Date().toISOString(),
                redemptions: []
            };
            
            giftCards[cardNum] = card;
            localStorage.setItem('gc_gift_cards', JSON.stringify(giftCards));
            
            // Sync to Firebase
            syncGiftCardToFirebase(cardNum, card);
            
            // Show the card number
            showToast(`Gift Card Created: ${cardNum}`, 'success');
            
            // Print gift card receipt
            if (confirm('Print gift card?')) {
                printGiftCard(cardNum, amount);
            }
            
            return cardNum;
        }
        
        function printGiftCard(cardNum, amount) {
            const w = window.open('', '_blank', 'width=350,height=400');
            var html = '<html><head><title>Gift Card</title><style>';
            html += 'body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }';
            html += '.card { border: 2px solid #9b59b6; border-radius: 12px; padding: 30px; max-width: 280px; margin: 0 auto; }';
            html += '.logo { font-size: 24px; font-weight: bold; color: #4a90a4; margin-bottom: 10px; }';
            html += '.amount { font-size: 36px; font-weight: bold; color: #27ae60; margin: 20px 0; }';
            html += '.number { font-family: monospace; font-size: 18px; background: #f8f9fa; padding: 10px; border-radius: 6px; letter-spacing: 2px; }';
            html += '.footer { margin-top: 20px; font-size: 12px; color: #666; }';
            html += '</style></head><bo' + 'dy>';
            html += '<div class="card">';
            html += '<div class="logo">⛳ GOLF COVE</div>';
            html += '<div style="color:#9b59b6;font-size:14px;">GIFT CARD</div>';
            html += '<div class="amount">$' + amount.toFixed(2) + '</div>';
            html += '<div class="number">' + cardNum + '</div>';
            html += '<div class="footer">Present this card at checkout<br>No expiration</div>';
            html += '</div></bo' + 'dy></ht' + 'ml>';
            w.document.write(html);
            w.document.close();
            w.print();
        }
        
        // ============ QUICK ACTIONS ============
        function issueRaincheck() {
            const customer = prompt('Customer name for raincheck:');
            if (!customer) return;
            
            const reason = prompt('Reason for raincheck:');
            const value = prompt('Value of raincheck ($):');
            
            if (!value || isNaN(parseFloat(value))) return showToast('Invalid value', 'error');
            
            const rainchecks = JSON.parse(localStorage.getItem('gc_rainchecks') || '[]');
            const raincheck = {
                id: 'RC' + Date.now().toString(36).toUpperCase(),
                customer: customer,
                reason: reason || 'Weather',
                value: parseFloat(value),
                issued: new Date().toISOString(),
                redeemed: false,
                issuedBy: 'Staff'
            };
            
            rainchecks.push(raincheck);
            localStorage.setItem('gc_rainchecks', JSON.stringify(rainchecks));
            
            showToast(`Raincheck ${raincheck.id} issued for $${raincheck.value.toFixed(2)}`, 'success');
            
            if (confirm('Print raincheck?')) {
                const w = window.open('', '_blank', 'width=350,height=400');
                var html = '<html><head><title>Raincheck</title><style>';
                html += 'body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }';
                html += '.card { border: 2px dashed #3498db; border-radius: 12px; padding: 30px; max-width: 280px; margin: 0 auto; }';
                html += '.amount { font-size: 32px; font-weight: bold; color: #3498db; margin: 15px 0; }';
                html += '</style></head><bo' + 'dy>';
                html += '<div class="card">';
                html += '<div style="font-size:24px;font-weight:bold;color:#4a90a4;">⛳ GOLF COVE</div>';
                html += '<div style="color:#e74c3c;font-size:16px;margin:10px 0;">RAINCHECK</div>';
                html += '<div class="amount">$' + raincheck.value.toFixed(2) + '</div>';
                html += '<div style="font-family:monospace;font-size:14px;">' + raincheck.id + '</div>';
                html += '<div style="margin-top:15px;font-size:13px;">';
                html += '<strong>' + customer + '</strong><br>';
                html += (reason || 'Weather') + '<br>';
                html += new Date().toLocaleDateString();
                html += '</div>';
                html += '<div style="margin-top:15px;font-size:11px;color:#666;">Valid for 90 days</div>';
                html += '</div></bo' + 'dy></ht' + 'ml>';
                w.document.write(html);
                w.document.close();
                w.print();
            }
        }
        
        // ============ LOYALTY POINTS SYSTEM ============
        function showLoyaltyModal() {
            const currentName = document.getElementById('customerName').value;
            
            // Find customer from Stripe cache
            let customer = stripeCustomersCache.find(c =>
                `${c.firstName} ${c.lastName}`.toLowerCase() === currentName.toLowerCase()
            );
            
            if (!customer && currentName) {
                showToast('Customer not found in system', 'warning');
            }
            
            const points = customer?.loyaltyPoints || 0;
            const pointsValue = (points / 100).toFixed(2); // 100 points = $1
            
            const html = `
                <div id="loyaltyModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:450px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#9b59b6;"><i class="fas fa-star"></i> Loyalty Points</h3>
                        
                        ${customer ? `
                            <div style="background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff;padding:20px;border-radius:10px;margin-bottom:20px;text-align:center;">
                                <div style="font-size:14px;opacity:0.9;">${customer.firstName} ${customer.lastName}</div>
                                <div style="font-size:36px;font-weight:700;margin:10px 0;">${points.toLocaleString()}</div>
                                <div style="font-size:13px;">points = $${pointsValue} value</div>
                            </div>
                            
                            <div style="margin-bottom:15px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;">Redeem Points:</label>
                                <div style="display:flex;gap:10px;">
                                    <input type="number" id="redeemPoints" max="${points}" placeholder="0" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    <button onclick="redeemLoyaltyPoints(${customer.id})" style="background:#9b59b6;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;">Redeem</button>
                                </div>
                                <div style="font-size:12px;color:#666;margin-top:5px;">100 points = $1.00 off</div>
                            </div>
                            
                            <div style="margin-bottom:15px;">
                                <label style="display:block;margin-bottom:5px;font-weight:600;">Add Points Manually:</label>
                                <div style="display:flex;gap:10px;">
                                    <input type="number" id="addPoints" placeholder="0" style="flex:1;padding:10px;border:1px solid #ddd;border-radius:6px;">
                                    <button onclick="addLoyaltyPoints(${customer.id})" style="background:#27ae60;color:#fff;border:none;padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:600;">Add</button>
                                </div>
                            </div>
                        ` : `
                            <div style="text-align:center;padding:30px;color:#666;">
                                <i class="fas fa-user-slash" style="font-size:48px;color:#ddd;margin-bottom:15px;"></i>
                                <p>Select a customer to view/redeem loyalty points</p>
                            </div>
                        `}
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px;">
                            <div style="font-size:13px;color:#666;margin-bottom:10px;"><strong>How Points Work:</strong></div>
                            <ul style="font-size:12px;color:#666;margin:0;padding-left:20px;">
                                <li>Earn 1 point per $1 spent</li>
                                <li>Members earn 2x points</li>
                                <li>100 points = $1.00 redemption value</li>
                                <li>Points never expire</li>
                            </ul>
                        </div>
                        
                        <button onclick="closeLoyaltyModal()" style="width:100%;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeLoyaltyModal() {
            const modal = document.getElementById('loyaltyModal');
            if (modal) modal.remove();
        }
        
        function redeemLoyaltyPoints(customerId) {
            const points = parseInt(document.getElementById('redeemPoints').value) || 0;
            if (points <= 0) return showToast('Enter points to redeem', 'error');
            
            const customer = stripeCustomersCache.find(c => c.id === customerId);
            
            if (!customer) return showToast('Customer not found', 'error');
            if (points > (customer.loyaltyPoints || 0)) return showToast('Insufficient points', 'error');
            
            const dollarValue = points / 100;
            
            // Note: In production, this should update Stripe metadata
            customer.loyaltyPoints = (customer.loyaltyPoints || 0) - points;
            
            // Add discount to cart
            saleItems.push({
                name: `Loyalty Points Redemption (${points} pts)`,
                price: -dollarValue,
                qty: 1,
                discount: 0,
                isLoyalty: true
            });
            renderSaleItems();
            
            closeLoyaltyModal();
            showToast(`Redeemed ${points} points for $${dollarValue.toFixed(2)} off!`, 'success');
        }
        
        function addLoyaltyPoints(customerId) {
            const points = parseInt(document.getElementById('addPoints').value) || 0;
            if (points <= 0) return showToast('Enter points to add', 'error');
            
            const customer = stripeCustomersCache.find(c => c.id === customerId);
            
            if (!customer) return showToast('Customer not found', 'error');
            
            // Note: In production, this should update Stripe metadata
            customer.loyaltyPoints = (customer.loyaltyPoints || 0) + points;
            
            closeLoyaltyModal();
            showLoyaltyModal();
            showToast(`Added ${points} loyalty points`, 'success');
        }
        
        // Auto-award points on completed sales
        function awardLoyaltyPoints(customerName, total) {
            if (!customerName || customerName === 'Walk-in') return;
            
            const customer = stripeCustomersCache.find(c =>
                `${c.firstName} ${c.lastName}`.toLowerCase() === customerName.toLowerCase()
            );
            
            if (customer) {
                const basePoints = Math.floor(total);
                const multiplier = customer.isMember ? 2 : 1;
                const earnedPoints = basePoints * multiplier;
                
                // Note: In production, this should update Stripe metadata
                customer.loyaltyPoints = (customer.loyaltyPoints || 0) + earnedPoints;
                
                console.log(`Awarded ${earnedPoints} loyalty points to ${customerName}`);
            }
        }
        
        // ============ CASH DRAWER MANAGEMENT ============
        function showDrawerManagement() {
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            const todayDrawer = drawer[today] || { openingAmount: 0, currentAmount: 0, opened: false };
            
            const html = `
                <div id="drawerModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:450px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#27ae60;"><i class="fas fa-cash-register"></i> Cash Drawer</h3>
                        
                        ${!todayDrawer.opened ? `
                            <div style="background:#e8f5e9;padding:20px;border-radius:10px;margin-bottom:20px;">
                                <div style="font-size:14px;font-weight:600;margin-bottom:15px;">Open Drawer</div>
                                <div style="margin-bottom:15px;">
                                    <label style="display:block;margin-bottom:5px;">Starting Cash Amount:</label>
                                    <input type="number" id="openingCash" step="0.01" value="200.00" style="width:100%;padding:12px;border:1px solid #ddd;border-radius:6px;font-size:16px;">
                                </div>
                                <button onclick="openDrawer()" style="width:100%;padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-lock-open"></i> Open Drawer</button>
                            </div>
                        ` : `
                            <div style="background:#f8f9fa;padding:20px;border-radius:10px;margin-bottom:20px;">
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Opening Amount:</span>
                                    <strong>$${todayDrawer.openingAmount.toFixed(2)}</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Cash Sales Today:</span>
                                    <strong style="color:#27ae60;">+$${(todayDrawer.cashIn || 0).toFixed(2)}</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Cash Returns:</span>
                                    <strong style="color:#e74c3c;">-$${(todayDrawer.cashOut || 0).toFixed(2)}</strong>
                                </div>
                                <div style="display:flex;justify-content:space-between;margin-bottom:10px;">
                                    <span>Pay-ins/Pay-outs:</span>
                                    <span>$${((todayDrawer.payIns || 0) - (todayDrawer.payOuts || 0)).toFixed(2)}</span>
                                </div>
                                <hr style="border:none;border-top:1px solid #ddd;margin:15px 0;">
                                <div style="display:flex;justify-content:space-between;font-size:18px;">
                                    <span>Expected in Drawer:</span>
                                    <strong style="color:#2c3e50;">$${(todayDrawer.openingAmount + (todayDrawer.cashIn || 0) - (todayDrawer.cashOut || 0) + (todayDrawer.payIns || 0) - (todayDrawer.payOuts || 0)).toFixed(2)}</strong>
                                </div>
                            </div>
                            
                            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:20px;">
                                <button onclick="showPayInOut('in')" style="padding:12px;background:#27ae60;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-plus"></i> Pay In</button>
                                <button onclick="showPayInOut('out')" style="padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-minus"></i> Pay Out</button>
                            </div>
                            
                            <button onclick="closeDrawer()" style="width:100%;padding:12px;background:#e67e22;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-bottom:10px;"><i class="fas fa-lock"></i> Close & Count Drawer</button>
                        `}
                        
                        <button onclick="closeDrawerModal()" style="width:100%;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Cancel</button>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function closeDrawerModal() {
            const modal = document.getElementById('drawerModal');
            if (modal) modal.remove();
        }
        
        async function openDrawer() {
            const amount = parseFloat(document.getElementById('openingCash').value) || 0;
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            
            drawer[today] = {
                opened: true,
                openingAmount: amount,
                cashIn: 0,
                cashOut: 0,
                payIns: 0,
                payOuts: 0,
                openedAt: new Date().toISOString(),
                openedBy: 'Staff'
            };
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
            closeDrawerModal();
            showToast('Drawer opened', 'success');
            showDrawerManagement();
            
            // Kick physical USB drawer if connected
            if (window.CashDrawer) {
                await CashDrawer.kick();
            }
        }
        
        function showPayInOut(type) {
            const amount = prompt(`Enter ${type === 'in' ? 'Pay In' : 'Pay Out'} amount:`);
            if (!amount || isNaN(parseFloat(amount))) return;
            
            const reason = prompt('Reason:') || 'No reason provided';
            
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            
            if (!drawer[today]) return showToast('Drawer not open', 'error');
            
            if (type === 'in') {
                drawer[today].payIns = (drawer[today].payIns || 0) + parseFloat(amount);
            } else {
                drawer[today].payOuts = (drawer[today].payOuts || 0) + parseFloat(amount);
            }
            
            // Log the transaction
            if (!drawer[today].log) drawer[today].log = [];
            drawer[today].log.push({
                type: type === 'in' ? 'Pay In' : 'Pay Out',
                amount: parseFloat(amount),
                reason: reason,
                time: new Date().toISOString()
            });
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
            closeDrawerModal();
            showDrawerManagement();
            showToast(`${type === 'in' ? 'Pay In' : 'Pay Out'} recorded`, 'success');
        }
        
        function closeDrawer() {
            const counted = prompt('Enter actual cash counted in drawer:');
            if (!counted || isNaN(parseFloat(counted))) return;
            
            const drawer = JSON.parse(localStorage.getItem('gc_cash_drawer') || '{}');
            const today = new Date().toDateString();
            const todayDrawer = drawer[today];
            
            if (!todayDrawer) return showToast('Drawer not open', 'error');
            
            const expected = todayDrawer.openingAmount + (todayDrawer.cashIn || 0) - (todayDrawer.cashOut || 0) + (todayDrawer.payIns || 0) - (todayDrawer.payOuts || 0);
            const countedAmount = parseFloat(counted);
            const variance = countedAmount - expected;
            
            todayDrawer.closedAt = new Date().toISOString();
            todayDrawer.countedAmount = countedAmount;
            todayDrawer.expectedAmount = expected;
            todayDrawer.variance = variance;
            todayDrawer.closed = true;
            
            localStorage.setItem('gc_cash_drawer', JSON.stringify(drawer));
            
            closeDrawerModal();
            
            // Show summary
            alert(`DRAWER CLOSED\n\nExpected: $${expected.toFixed(2)}\nCounted: $${countedAmount.toFixed(2)}\nVariance: $${variance.toFixed(2)} ${variance < 0 ? '(SHORT)' : variance > 0 ? '(OVER)' : '(BALANCED)'}`);
            
            showToast('Drawer closed', 'success');
        }
        
        // ============ TRANSACTION LOOKUP ============
        function showTransactionLookup() {
            const html = `
                <div id="transLookupModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:600px;width:95%;max-height:80vh;overflow:auto;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                            <h3 style="margin:0;color:#3498db;"><i class="fas fa-search"></i> Transaction Lookup</h3>
                            <button onclick="closeTransLookup()" style="background:none;border:none;font-size:20px;cursor:pointer;">&times;</button>
                        </div>
                        
                        <div style="display:flex;gap:10px;margin-bottom:20px;">
                            <input type="text" id="transSearchInput" placeholder="Search by ID, customer, or amount..." style="flex:1;padding:12px;border:1px solid #ddd;border-radius:6px;" onkeyup="searchTransactions()">
                            <select id="transDateFilter" onchange="searchTransactions()" style="padding:12px;border:1px solid #ddd;border-radius:6px;">
                                <option value="today">Today</option>
                                <option value="week">This Week</option>
                                <option value="month">This Month</option>
                                <option value="all">All Time</option>
                            </select>
                        </div>
                        
                        <div id="transSearchResults" style="max-height:400px;overflow:auto;">
                            <p style="color:#666;text-align:center;">Enter search term</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
            searchTransactions(); // Show today's transactions by default
        }
        
        function closeTransLookup() {
            const modal = document.getElementById('transLookupModal');
            if (modal) modal.remove();
        }
        
        function searchTransactions() {
            const query = document.getElementById('transSearchInput').value.toLowerCase();
            const dateFilter = document.getElementById('transDateFilter').value;
            
            const now = new Date();
            let filtered = transactions.filter(t => {
                const tDate = new Date(t.date);
                
                switch(dateFilter) {
                    case 'today':
                        if (tDate.toDateString() !== now.toDateString()) return false;
                        break;
                    case 'week':
                        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        if (tDate < weekAgo) return false;
                        break;
                    case 'month':
                        if (tDate.getMonth() !== now.getMonth() || tDate.getFullYear() !== now.getFullYear()) return false;
                        break;
                }
                
                if (query) {
                    return t.id.toString().includes(query) || 
                           t.customer.toLowerCase().includes(query) ||
                           t.amount.toFixed(2).includes(query);
                }
                return true;
            });
            
            const results = document.getElementById('transSearchResults');
            
            if (filtered.length === 0) {
                results.innerHTML = '<p style="color:#666;text-align:center;">No transactions found</p>';
                return;
            }
            
            results.innerHTML = filtered.slice(0, 50).map(t => `
                <div style="display:flex;align-items:center;padding:12px;border-bottom:1px solid #eee;cursor:pointer;" onclick="selectTransaction(${t.id})">
                    <div style="flex:1;">
                        <div style="font-weight:600;">#${t.id} - ${t.customer}</div>
                        <div style="font-size:12px;color:#666;">${new Date(t.date).toLocaleDateString()} ${t.time} | ${t.method} | ${t.itemCount} items</div>
                    </div>
                    <div style="font-weight:700;${t.isReturn ? 'color:#e74c3c;' : 'color:#27ae60;'}">
                        ${t.isReturn ? '-' : ''}$${Math.abs(t.amount).toFixed(2)}
                    </div>
                    <button onclick="event.stopPropagation();processRefund(${t.id})" style="margin-left:10px;background:#e74c3c;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px;" ${t.isReturn ? 'disabled style="opacity:0.5;cursor:not-allowed;"' : ''}>Refund</button>
                </div>
            `).join('');
        }
        
        function selectTransaction(id) {
            const t = transactions.find(tr => tr.id === id);
            if (!t) return;
            
            closeTransLookup();
            
            // Show transaction details
            const html = `
                <div id="transDetailModal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:9999;">
                    <div style="background:#fff;padding:25px;border-radius:12px;max-width:400px;width:95%;">
                        <h3 style="margin:0 0 20px;color:#3498db;">Transaction #${t.id}</h3>
                        
                        <div style="background:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:15px;">
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>Customer:</span><strong>${t.customer}</strong>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>Date:</span><span>${new Date(t.date).toLocaleDateString()} ${t.time}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;margin-bottom:8px;">
                                <span>Method:</span><span>${t.method.toUpperCase()}</span>
                            </div>
                            <div style="display:flex;justify-content:space-between;font-size:18px;font-weight:700;margin-top:10px;padding-top:10px;border-top:1px solid #ddd;">
                                <span>Total:</span><span style="${t.isReturn ? 'color:#e74c3c;' : 'color:#27ae60;'}">${t.isReturn ? '-' : ''}$${Math.abs(t.amount).toFixed(2)}</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom:15px;">
                            <strong>Items:</strong>
                            <div style="max-height:150px;overflow:auto;margin-top:8px;">
                                ${t.itemDetails ? t.itemDetails.map(item => `
                                    <div style="display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid #eee;font-size:13px;">
                                        <span>${item.name} x${item.qty}</span>
                                        <span>$${(item.price * item.qty).toFixed(2)}</span>
                                    </div>
                                `).join('') : '<p style="color:#666;">Item details not available</p>'}
                            </div>
                        </div>
                        
                        <div style="display:flex;gap:10px;">
                            <button onclick="this.closest('#transDetailModal').remove()" style="flex:1;padding:12px;background:#95a5a6;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;">Close</button>
                            <button onclick="reprintReceipt(${t.id})" style="flex:1;padding:12px;background:#3498db;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-print"></i> Reprint</button>
                            ${!t.isReturn ? `<button onclick="processRefund(${t.id})" style="flex:1;padding:12px;background:#e74c3c;color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;"><i class="fas fa-undo"></i> Refund</button>` : ''}
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }
        
        function processRefund(transId) {
            const t = transactions.find(tr => tr.id === transId);
            if (!t || t.isReturn) return;
            
            if (!confirm(`Process full refund of $${t.amount.toFixed(2)} for ${t.customer}?`)) return;
            
            // Close any open modals
            document.querySelectorAll('#transDetailModal, #transLookupModal').forEach(m => m.remove());
            
            // Create refund transaction
            const refund = {
                id: 26763 + transactions.length,
                customer: t.customer,
                amount: -t.amount,
                subtotal: -t.subtotal,
                tax: -t.tax,
                method: t.method,
                time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
                date: new Date().toISOString(),
                itemCount: t.itemCount,
                itemDetails: t.itemDetails,
                isReturn: true,
                originalTransactionId: t.id,
                register: localStorage.getItem('gc_register_id') || 'POS-1'
            };
            
            transactions.unshift(refund);
            saveTransactions();
            syncTransactionToFirebase(refund);
            
            // Update daily sales
            const dailySales = JSON.parse(localStorage.getItem('gc_daily_sales') || '{}');
            const today = new Date().toDateString();
            if (dailySales[today]) {
                dailySales[today].total -= t.amount;
                dailySales[today][t.method] = (dailySales[today][t.method] || 0) - t.amount;
            }
            localStorage.setItem('gc_daily_sales', JSON.stringify(dailySales));
            
            // Mark original as refunded
            t.refunded = true;
            t.refundedAt = new Date().toISOString();
            saveTransactions();
            syncTransactionToFirebase(t);
            
            renderTransactions();
            showToast(`Refund of $${t.amount.toFixed(2)} processed`, 'success');
            
            if (confirm('Print refund receipt?')) {
                printReceipt(t.customer, t.amount, t.method + ' REFUND', t.itemDetails || [], refund.id);
            }
        }
        
        function reprintReceipt(transId) {
            const t = transactions.find(tr => tr.id === transId);
            if (!t) return;
            
            printReceipt(t.customer, Math.abs(t.amount), t.method + (t.isReturn ? ' REFUND' : ''), t.itemDetails || [], t.id);
        }
    </script>
</body>
</html>