<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enter Score - Golf Cove League</title>
    <link rel="icon" type="image/png" href="images/golfcovelogo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: #37b24a;
            color: #fff;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 20px;
            margin-bottom: 5px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .player-select {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #e0e0e0;
        }
        .player-select label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 600;
        }
        .player-select select {
            width: 100%;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            background: #fff;
            -webkit-appearance: none;
        }
        .player-select select:focus {
            border-color: #37b24a;
            outline: none;
        }
        .hole-nav {
            display: flex;
            gap: 8px;
            padding: 15px;
            background: #fff;
            overflow-x: auto;
            border-bottom: 1px solid #e0e0e0;
        }
        .hole-btn {
            min-width: 44px;
            height: 44px;
            border: 2px solid #e0e0e0;
            background: #fff;
            border-radius: 50%;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            flex-shrink: 0;
        }
        .hole-btn.current {
            border-color: #37b24a;
            color: #37b24a;
        }
        .hole-btn.scored {
            background: #37b24a;
            border-color: #37b24a;
            color: #fff;
        }
        .hole-btn.over {
            background: #ffebee;
            border-color: #ef5350;
            color: #c62828;
        }
        .hole-btn.under {
            background: #e8f5e9;
            border-color: #66bb6a;
            color: #2e7d32;
        }
        .scoring-area {
            padding: 30px 20px;
        }
        .current-hole {
            text-align: center;
            margin-bottom: 30px;
        }
        .hole-number {
            font-size: 48px;
            font-weight: 700;
            color: #333;
        }
        .hole-par {
            font-size: 16px;
            color: #666;
        }
        .score-display {
            text-align: center;
            margin-bottom: 30px;
        }
        .score-value {
            font-size: 80px;
            font-weight: 700;
            color: #333;
            line-height: 1;
        }
        .score-status {
            font-size: 16px;
            font-weight: 600;
            margin-top: 10px;
        }
        .score-status.eagle { color: #ffd700; }
        .score-status.birdie { color: #37b24a; }
        .score-status.par { color: #666; }
        .score-status.bogey { color: #ff9800; }
        .score-status.double { color: #f44336; }
        .score-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 30px;
        }
        .score-btn {
            width: 80px;
            height: 80px;
            border: none;
            border-radius: 50%;
            font-size: 40px;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        .score-btn.minus {
            background: #f44336;
            color: #fff;
        }
        .score-btn.plus {
            background: #37b24a;
            color: #fff;
        }
        .quick-scores {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        .quick-btn {
            padding: 18px;
            border: 2px solid #e0e0e0;
            background: #fff;
            border-radius: 10px;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
        }
        .quick-btn.active {
            background: #37b24a;
            border-color: #37b24a;
            color: #fff;
        }
        .scorecard {
            margin: 20px;
            background: #fff;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        .scorecard-header {
            background: #333;
            color: #fff;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
        }
        .scorecard-header h3 {
            font-size: 16px;
        }
        .total {
            font-size: 24px;
            font-weight: 700;
        }
        .scorecard-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            text-align: center;
            font-size: 13px;
        }
        .scorecard-grid > div {
            padding: 12px 5px;
            border-bottom: 1px solid #eee;
            border-right: 1px solid #eee;
        }
        .scorecard-grid > div:nth-child(9n) {
            border-right: none;
        }
        .scorecard-grid .hole-num {
            background: #f5f5f5;
            font-weight: 600;
            color: #666;
        }
        .scorecard-grid .par-cell {
            background: #fafafa;
            color: #888;
        }
        .scorecard-grid .score-cell {
            font-weight: 600;
            font-size: 15px;
        }
        .scorecard-grid .under { color: #37b24a; }
        .scorecard-grid .over { color: #f44336; }
        .submit-area {
            padding: 20px;
            margin: 20px;
            background: #fff;
            border-radius: 12px;
            text-align: center;
        }
        .submit-btn {
            width: 100%;
            padding: 20px;
            background: #37b24a;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }
        .submit-btn:disabled {
            background: #ccc;
        }
        .leaderboard-link {
            display: block;
            text-align: center;
            padding: 15px;
            color: #37b24a;
            font-weight: 600;
            text-decoration: none;
        }
        .submitted-state {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            margin: 20px;
        }
        .submitted-state i {
            font-size: 48px;
            margin-bottom: 15px;
        }
        .error-state {
            text-align: center;
            padding: 60px 20px;
        }
        .error-state i {
            font-size: 64px;
            color: #ddd;
            margin-bottom: 20px;
        }
        .syncing {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            display: none;
        }
        .syncing.show {
            display: block;
        }
        .nav-arrows {
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            margin-top: 20px;
        }
        .nav-arrow {
            padding: 15px 30px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            color: #333;
        }
        .nav-arrow:disabled {
            opacity: 0.3;
        }
        .nav-arrow i {
            margin: 0 5px;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Loaded by JS -->
    </div>
    <div class="syncing" id="sync"><i class="fas fa-sync fa-spin"></i> Saving...</div>

    <script>
        const scoring = {
            league: null,
            roundId: null,
            round: null,
            playerId: null,
            currentHole: 1,

            init() {
                const params = new URLSearchParams(window.location.search);
                this.roundId = params.get('r');
                this.playerId = params.get('p');

                this.league = JSON.parse(localStorage.getItem('golfcove_league') || 'null');

                if (!this.league) {
                    this.showError('League not found', 'No active league exists.');
                    return;
                }

                this.round = this.league.rounds.find(r => r.id === this.roundId);
                if (!this.round) {
                    // If no round specified, try to find active round
                    this.round = this.league.rounds.find(r => !this.isRoundComplete(r.id));
                    if (this.round) {
                        this.roundId = this.round.id;
                    } else {
                        this.showError('No active round', 'There is no round currently open for scoring.');
                        return;
                    }
                }

                this.render();
            },

            showError(title, msg) {
                document.getElementById('app').innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h2>${title}</h2>
                        <p style="color: #666;">${msg}</p>
                    </div>
                `;
            },

            isRoundComplete(roundId) {
                const scores = this.league.scores[roundId] || {};
                return this.league.players.every(p => scores[p.id]?.submitted);
            },

            getPlayerScores() {
                if (!this.playerId) return {};
                return this.league.scores[this.roundId]?.[this.playerId] || {};
            },

            getScore(hole) {
                return this.getPlayerScores()[hole] || null;
            },

            isSubmitted() {
                return this.getPlayerScores().submitted === true;
            },

            getPar(hole) {
                return this.league.course.pars[hole - 1] || 4;
            },

            setScore(score) {
                if (!this.playerId || this.isSubmitted()) return;

                if (!this.league.scores[this.roundId]) {
                    this.league.scores[this.roundId] = {};
                }
                if (!this.league.scores[this.roundId][this.playerId]) {
                    this.league.scores[this.roundId][this.playerId] = {};
                }

                this.league.scores[this.roundId][this.playerId][this.currentHole] = score;
                this.save();
                this.render();
            },

            adjustScore(delta) {
                if (this.isSubmitted()) return;
                const current = this.getScore(this.currentHole) || this.getPar(this.currentHole);
                const newScore = Math.max(1, Math.min(12, current + delta));
                this.setScore(newScore);
            },

            save() {
                localStorage.setItem('golfcove_league', JSON.stringify(this.league));
                const sync = document.getElementById('sync');
                sync.classList.add('show');
                setTimeout(() => sync.classList.remove('show'), 800);
            },

            goToHole(h) {
                this.currentHole = h;
                this.render();
            },

            prevHole() {
                if (this.currentHole > 1) {
                    this.currentHole--;
                    this.render();
                }
            },

            nextHole() {
                if (this.currentHole < this.league.course.holes) {
                    this.currentHole++;
                    this.render();
                }
            },

            selectPlayer(id) {
                this.playerId = id;
                const url = new URL(window.location);
                url.searchParams.set('p', id);
                window.history.pushState({}, '', url);
                this.render();
            },

            getScoreLabel(hole) {
                const score = this.getScore(hole);
                if (!score) return '';
                const par = this.getPar(hole);
                const diff = score - par;
                
                if (diff <= -2) return '<span class="score-status eagle">Eagle!</span>';
                if (diff === -1) return '<span class="score-status birdie">Birdie</span>';
                if (diff === 0) return '<span class="score-status par">Par</span>';
                if (diff === 1) return '<span class="score-status bogey">Bogey</span>';
                return '<span class="score-status double">+' + diff + '</span>';
            },

            getTotalScore() {
                const scores = this.getPlayerScores();
                return Object.keys(scores)
                    .filter(k => !isNaN(k))
                    .reduce((sum, h) => sum + scores[h], 0);
            },

            submit() {
                const holes = this.league.course.holes;
                const scores = this.getPlayerScores();
                const completed = Object.keys(scores).filter(k => !isNaN(k)).length;

                if (completed < holes) {
                    if (!confirm(`You've scored ${completed}/${holes} holes. Submit anyway?`)) return;
                }

                this.league.scores[this.roundId][this.playerId].submitted = true;
                this.league.scores[this.roundId][this.playerId].submittedAt = new Date().toISOString();
                this.save();
                
                window.location.href = `league-standings.html?r=${this.roundId}`;
            },

            render() {
                const l = this.league;
                const holes = l.course.holes;

                document.getElementById('app').innerHTML = `
                    <div class="header">
                        <h1>${l.name}</h1>
                        <p>${this.round.name} • ${l.course.name}</p>
                    </div>

                    <div class="player-select">
                        <label>Who are you?</label>
                        <select onchange="scoring.selectPlayer(this.value)">
                            <option value="">Select your name...</option>
                            ${l.players.map(p => `
                                <option value="${p.id}" ${p.id === this.playerId ? 'selected' : ''}>
                                    ${p.name} (HCP: ${p.handicap})
                                </option>
                            `).join('')}
                        </select>
                    </div>

                    ${this.playerId ? this.renderScoring() : ''}
                `;
            },

            renderScoring() {
                const l = this.league;
                const holes = l.course.holes;
                const submitted = this.isSubmitted();

                if (submitted) {
                    return `
                        <div class="submitted-state">
                            <i class="fas fa-check-circle"></i>
                            <h2>Score Submitted!</h2>
                            <p>Your round has been recorded.</p>
                            <p style="font-size: 32px; font-weight: 700; margin-top: 15px;">${this.getTotalScore()}</p>
                        </div>
                        <a href="league-standings.html?r=${this.roundId}" class="leaderboard-link">
                            <i class="fas fa-trophy"></i> View Leaderboard
                        </a>
                    `;
                }

                return `
                    <div class="hole-nav">
                        ${Array.from({length: holes}, (_, i) => {
                            const h = i + 1;
                            const score = this.getScore(h);
                            const par = this.getPar(h);
                            let cls = '';
                            if (h === this.currentHole) cls = 'current';
                            else if (score) {
                                if (score < par) cls = 'under';
                                else if (score > par) cls = 'over';
                                else cls = 'scored';
                            }
                            return `<button class="hole-btn ${cls}" onclick="scoring.goToHole(${h})">${h}</button>`;
                        }).join('')}
                    </div>

                    <div class="scoring-area">
                        <div class="current-hole">
                            <div class="hole-number">Hole ${this.currentHole}</div>
                            <div class="hole-par">Par ${this.getPar(this.currentHole)}</div>
                        </div>

                        <div class="score-display">
                            <div class="score-value">${this.getScore(this.currentHole) || '-'}</div>
                            ${this.getScoreLabel(this.currentHole)}
                        </div>

                        <div class="score-buttons">
                            <button class="score-btn minus" onclick="scoring.adjustScore(-1)">−</button>
                            <button class="score-btn plus" onclick="scoring.adjustScore(1)">+</button>
                        </div>

                        <div class="quick-scores">
                            ${[1,2,3,4,5,6,7,8,9,10].map(n => `
                                <button class="quick-btn ${this.getScore(this.currentHole) === n ? 'active' : ''}" 
                                        onclick="scoring.setScore(${n})">${n}</button>
                            `).join('')}
                        </div>

                        <div class="nav-arrows">
                            <button class="nav-arrow" onclick="scoring.prevHole()" ${this.currentHole === 1 ? 'disabled' : ''}>
                                <i class="fas fa-arrow-left"></i> Prev
                            </button>
                            <button class="nav-arrow" onclick="scoring.nextHole()" ${this.currentHole === holes ? 'disabled' : ''}>
                                Next <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    ${this.renderScorecard()}

                    <div class="submit-area">
                        <button class="submit-btn" onclick="scoring.submit()">
                            Submit Score
                        </button>
                        <a href="league-standings.html?r=${this.roundId}" class="leaderboard-link">
                            <i class="fas fa-trophy"></i> View Live Standings
                        </a>
                    </div>
                `;
            },

            renderScorecard() {
                const holes = this.league.course.holes;
                const front = Math.min(9, holes);
                
                let html = `<div class="scorecard">
                    <div class="scorecard-header">
                        <h3>Scorecard</h3>
                        <div class="total">${this.getTotalScore() || '-'}</div>
                    </div>
                    <div class="scorecard-grid">`;

                // Front 9 (or less)
                for (let i = 1; i <= front; i++) {
                    html += `<div class="hole-num">${i}</div>`;
                }
                for (let i = 1; i <= front; i++) {
                    html += `<div class="par-cell">${this.getPar(i)}</div>`;
                }
                for (let i = 1; i <= front; i++) {
                    const s = this.getScore(i);
                    const p = this.getPar(i);
                    const cls = s ? (s < p ? 'under' : s > p ? 'over' : '') : '';
                    html += `<div class="score-cell ${cls}">${s || '-'}</div>`;
                }

                html += '</div>';

                // Back 9 if 18 holes
                if (holes > 9) {
                    html += '<div class="scorecard-grid">';
                    for (let i = 10; i <= holes; i++) {
                        html += `<div class="hole-num">${i}</div>`;
                    }
                    for (let i = 10; i <= holes; i++) {
                        html += `<div class="par-cell">${this.getPar(i)}</div>`;
                    }
                    for (let i = 10; i <= holes; i++) {
                        const s = this.getScore(i);
                        const p = this.getPar(i);
                        const cls = s ? (s < p ? 'under' : s > p ? 'over' : '') : '';
                        html += `<div class="score-cell ${cls}">${s || '-'}</div>`;
                    }
                    html += '</div>';
                }

                html += '</div>';
                return html;
            }
        };

        document.addEventListener('DOMContentLoaded', () => scoring.init());
    </script>
</body>
</html>
