<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Enter Score - Golf Cove</title>
    <link rel="icon" type="image/png" href="images/golfcovelogo.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: #37b24a;
            color: #fff;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        .player-select {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .player-select label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .player-select select {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .player-select select:focus {
            border-color: #37b24a;
            outline: none;
        }
        
        /* Divider */
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #999;
            font-size: 13px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }
        .divider span { padding: 0 15px; }
        
        /* Register button */
        .register-btn {
            width: 100%;
            padding: 14px;
            background: #fff;
            border: 2px dashed #37b24a;
            border-radius: 8px;
            color: #37b24a;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .register-btn:hover {
            background: #37b24a;
            color: #fff;
            border-style: solid;
        }
        
        /* Profile card */
        .profile-card {
            background: #fff;
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .profile-avatar {
            font-size: 40px;
            color: #37b24a;
        }
        .profile-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .profile-meta {
            display: flex;
            gap: 15px;
            font-size: 13px;
            color: #666;
            margin-top: 3px;
        }
        .profile-meta i { color: #37b24a; margin-right: 4px; }
        .switch-btn {
            background: none;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
            cursor: pointer;
        }
        .switch-btn:hover { background: #f5f5f5; }
        
        /* Registration form */
        .registration-form {
            background: #fff;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .registration-form h2 {
            color: #333;
            font-size: 20px;
            margin-bottom: 5px;
        }
        .registration-form h2 i { color: #37b24a; }
        .form-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: #555;
            margin-bottom: 6px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 14px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #37b24a;
            outline: none;
        }
        .cancel-btn {
            width: 100%;
            padding: 14px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
        }
        .cancel-btn:hover { background: #eee; }
        
        /* Welcome Screen */
        .welcome-screen {
            background: #fff;
            border-radius: 12px;
            padding: 30px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .welcome-screen h2 {
            color: #333;
            font-size: 22px;
            margin-bottom: 5px;
            text-align: center;
        }
        .welcome-desc {
            color: #666;
            font-size: 14px;
            text-align: center;
            margin-bottom: 25px;
        }
        .option-card {
            display: flex;
            align-items: center;
            padding: 18px;
            background: #f9f9f9;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-card:hover {
            border-color: #37b24a;
            background: #f0fff0;
        }
        .option-card.secondary {
            background: #fff;
            border-style: dashed;
        }
        .option-icon {
            width: 45px;
            height: 45px;
            background: #37b24a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 18px;
            margin-right: 15px;
        }
        .option-card.secondary .option-icon {
            background: #e0e0e0;
            color: #666;
        }
        .option-text { flex: 1; }
        .option-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .option-desc {
            font-size: 13px;
            color: #888;
            margin-top: 2px;
        }
        .option-card > i.fa-chevron-right {
            color: #ccc;
            font-size: 14px;
        }
        
        /* PIN Entry & Confirmation */
        .error-msg {
            color: #e74c3c;
            font-size: 13px;
            margin-bottom: 15px;
            padding: 10px;
            background: #fdeaea;
            border-radius: 6px;
        }
        .pin-confirmation {
            background: #fff;
            border-radius: 12px;
            padding: 30px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            text-align: center;
        }
        .pin-confirmation .success-icon {
            font-size: 60px;
            color: #37b24a;
            margin-bottom: 15px;
        }
        .pin-confirmation h2 {
            color: #333;
            font-size: 22px;
            margin-bottom: 10px;
        }
        .pin-confirmation p {
            color: #666;
            font-size: 14px;
        }
        .pin-display {
            background: #f5f5f5;
            border-radius: 12px;
            padding: 25px;
            margin: 25px 0;
        }
        .pin-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        .pin-number {
            font-size: 48px;
            font-weight: 800;
            color: #37b24a;
            letter-spacing: 8px;
        }
        .pin-hint {
            font-size: 12px;
            color: #888;
            margin-top: 15px;
        }
        .pin-hint i { margin-right: 5px; }
        
        /* Browse Players */
        .browse-players {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .browse-players h2 {
            color: #333;
            font-size: 18px;
            margin-bottom: 15px;
        }
        .browse-players h2 i { color: #37b24a; margin-right: 8px; }
        .players-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .team-group {
            margin-bottom: 15px;
        }
        .team-name {
            font-size: 13px;
            font-weight: 600;
            color: #37b24a;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .team-name i { margin-right: 6px; }
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 10px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: background 0.15s;
        }
        .player-item:hover {
            background: #f0fff0;
        }
        .player-item span:first-child {
            font-size: 15px;
            color: #333;
        }
        .player-item .hcp {
            font-size: 12px;
            color: #888;
            background: #f0f0f0;
            padding: 3px 8px;
            border-radius: 10px;
        }
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }
        .empty-state i {
            font-size: 40px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        .scores-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .scores-header {
            background: #333;
            color: #fff;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
        }
        .hole-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .hole-row:last-child {
            border-bottom: none;
        }
        .hole-info {
            display: flex;
            flex-direction: column;
        }
        .hole-label {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }
        .hole-par {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        .score-input {
            width: 60px;
            padding: 10px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .score-input:focus {
            border-color: #37b24a;
            outline: none;
        }
        .score-input.under-par {
            border-color: #37b24a;
            background: #e8f5e9;
            color: #2e7d32;
        }
        .score-input.over-par {
            border-color: #ff9800;
            background: #fff3e0;
            color: #e65100;
        }
        .score-input.double-over {
            border-color: #f44336;
            background: #ffebee;
            color: #c62828;
        }
        .totals {
            display: flex;
            justify-content: space-between;
            padding: 18px 20px;
            background: #f8f9fa;
            font-weight: 600;
            font-size: 16px;
        }
        .totals .value {
            color: #37b24a;
            font-size: 20px;
        }
        .section-header {
            background: #333;
            color: #fff;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
        }
        .section-header .subtotal {
            font-weight: 700;
        }
        .score-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #e0e0e0;
            margin-top: 1px;
        }
        .score-summary.nine-holes {
            grid-template-columns: repeat(3, 1fr);
        }
        .score-summary .item {
            background: #fff;
            padding: 15px 10px;
            text-align: center;
        }
        .score-summary .item .label {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .score-summary .item .value {
            font-size: 24px;
            font-weight: 700;
        }
        .score-summary .item .value.net {
            color: #37b24a;
        }
        .submit-btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
            box-shadow: 0 4px 15px rgba(55,178,74,0.3);
        }
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(55,178,74,0.4);
        }
        .submit-btn:active {
            transform: translateY(0);
        }
        .submit-btn:disabled {
            background: #ccc;
            box-shadow: none;
            transform: none;
        }
        .back-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #37b24a;
            text-decoration: none;
            font-weight: 500;
        }
        .message {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        .message i {
            font-size: 48px;
            color: #ddd;
            margin-bottom: 15px;
        }
        .submitted {
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
            border-radius: 16px;
            padding: 40px 20px;
            text-align: center;
            animation: fadeInUp 0.5s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .submitted .checkmark {
            width: 60px;
            height: 60px;
            background: #37b24a;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            animation: scaleIn 0.4s ease;
        }
        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        .submitted .checkmark i {
            color: #fff;
            font-size: 28px;
        }
        .submitted h2 {
            color: #2e7d32;
            margin-bottom: 10px;
            font-size: 22px;
        }
        .submitted .score {
            font-size: 48px;
            font-weight: 700;
            color: #37b24a;
            margin: 20px 0;
        }
        .pin-section {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .pin-section label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
        .pin-input {
            width: 100%;
            padding: 14px;
            font-size: 24px;
            font-weight: 700;
            text-align: center;
            letter-spacing: 8px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .pin-input:focus {
            border-color: #37b24a;
            outline: none;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" style="display: inline-block; margin-bottom: 10px;">
            <img src="images/golfcovelogo.png" alt="Golf Cove" style="height: 40px; filter: brightness(0) invert(1);">
        </a>
        <h1 id="leagueName">Golf Cove League</h1>
        <p id="roundName">Loading...</p>
    </div>

    <div class="container" id="content">
        <div class="message"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8SH5Eh7OhIFLUkL2hjZS23uXkCsDJXGc",
            authDomain: "golfcove.firebaseapp.com",
            databaseURL: "https://golfcove-default-rtdb.firebaseio.com",
            projectId: "golfcove",
            storageBucket: "golfcove.firebasestorage.app",
            messagingSenderId: "284762891644",
            appId: "1:284762891644:web:424223b102f08a230f70f9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const leagueRef = db.ref('league');
        
        let league = null;
        let roundId = null;
        let playerId = null;
        
        // Profile management
        function getSavedProfile() {
            const saved = localStorage.getItem('golfcove_profile');
            return saved ? JSON.parse(saved) : null;
        }
        
        function saveProfile(id) {
            localStorage.setItem('golfcove_profile', JSON.stringify({ playerId: id }));
        }
        
        function clearProfile() {
            localStorage.removeItem('golfcove_profile');
            playerId = null;
            render();
        }

        function init() {
            // Listen for real-time updates from Firebase
            leagueRef.on('value', (snapshot) => {
                league = snapshot.val();
                
                if (!league) {
                    showMessage('No league found. Please set up a league first.', 'fa-exclamation-triangle');
                    return;
                }

                // Ensure arrays exist (Firebase returns undefined for empty arrays)
                league.players = league.players || [];
                league.rounds = league.rounds || [];
                league.teams = league.teams || [];
                league.scores = league.scores || {};

                const params = new URLSearchParams(window.location.search);
                roundId = params.get('r');
                const urlPlayerId = params.get('p');
                
                // Priority: URL param > saved profile
                if (urlPlayerId) {
                    playerId = urlPlayerId;
                    saveProfile(urlPlayerId);
                } else {
                    const savedProfile = getSavedProfile();
                    if (savedProfile && league.players.find(p => p.id === savedProfile.playerId)) {
                        playerId = savedProfile.playerId;
                    }
                }

                // Get current round if not specified
                if (!roundId && league.rounds.length > 0) {
                    roundId = league.rounds[league.rounds.length - 1].id;
                }

                const round = league.rounds.find(r => r.id === roundId);
                if (!round) {
                    showMessage('No active round. Ask admin to create one.', 'fa-flag');
                    return;
                }

                document.getElementById('leagueName').textContent = league.name;
                document.getElementById('roundName').textContent = round.name;

                render();
            });
        }

        function showMessage(msg, icon = 'fa-info-circle') {
            document.getElementById('content').innerHTML = `
                <div class="message">
                    <i class="fas ${icon}"></i>
                    <p>${msg}</p>
                </div>`;
        }

        function render() {
            const container = document.getElementById('content');
            const scores = getScores();
            const submitted = scores.submitted;
            const currentPlayer = league.players.find(p => p.id === playerId);
            
            // Show profile header if player is selected
            let profileHeader = '';
            if (currentPlayer) {
                const team = (league.teams || []).find(t => t.id === currentPlayer.teamId);
                profileHeader = `
                    <div class="profile-card">
                        <div class="profile-info">
                            <div class="profile-avatar"><i class="fas fa-user-circle"></i></div>
                            <div class="profile-details">
                                <div class="profile-name">${currentPlayer.name}</div>
                                <div class="profile-meta">
                                    ${team ? `<span><i class="fas fa-users"></i> ${team.name}</span>` : ''}
                                    <span><i class="fas fa-golf-ball"></i> HCP ${currentPlayer.handicap || 0}</span>
                                </div>
                            </div>
                        </div>
                        <button class="switch-btn" onclick="showPlayerSelect()"><i class="fas fa-exchange-alt"></i> Switch</button>
                    </div>
                `;
            }

            // Build player selection / registration
            let html = '';
            
            if (!playerId || document.getElementById('showingSelect')) {
                html = `
                    <div class="welcome-screen">
                        <h2>Welcome to ${league.name}</h2>
                        <p class="welcome-desc">How would you like to continue?</p>
                        
                        <div class="option-card" onclick="showPinEntry()">
                            <div class="option-icon"><i class="fas fa-key"></i></div>
                            <div class="option-text">
                                <div class="option-title">I have a PIN</div>
                                <div class="option-desc">Enter your 4-digit PIN to reconnect</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        
                        <div class="option-card" onclick="showRegistration()">
                            <div class="option-icon"><i class="fas fa-user-plus"></i></div>
                            <div class="option-text">
                                <div class="option-title">I'm New</div>
                                <div class="option-desc">Create your profile & join a team</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        
                        <div class="option-card secondary" onclick="showBrowsePlayers()">
                            <div class="option-icon"><i class="fas fa-list"></i></div>
                            <div class="option-text">
                                <div class="option-title">Browse Players</div>
                                <div class="option-desc">Find yourself in the list</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }
            
            html = profileHeader;

            if (submitted) {
                let out = 0, inScore = 0, total = 0;
                const frontNine = Math.min(9, league.course.holes);
                const backNine = league.course.holes > 9 ? league.course.holes - 9 : 0;
                
                for (let h = 1; h <= frontNine; h++) {
                    out += scores[h] || 0;
                }
                for (let h = frontNine + 1; h <= league.course.holes; h++) {
                    inScore += scores[h] || 0;
                }
                total = out + inScore;
                
                const player = league.players.find(p => p.id === playerId);
                const handicap = player?.handicap || 0;
                const net = total - handicap;
                const has18 = league.course.holes >= 18;
                
                html += `
                    <div class="submitted">
                        <div class="checkmark"><i class="fas fa-check"></i></div>
                        <h2>Score Submitted!</h2>
                        <p>Your round has been recorded.</p>
                        <div class="score-summary ${has18 ? '' : 'nine-holes'}" style="margin: 20px -20px; border-radius: 0;">
                            ${has18 ? `<div class="item"><div class="label">OUT</div><div class="value">${out}</div></div>` : ''}
                            ${has18 ? `<div class="item"><div class="label">IN</div><div class="value">${inScore}</div></div>` : ''}
                            <div class="item"><div class="label">TOT</div><div class="value">${total}</div></div>
                            <div class="item"><div class="label">HCP</div><div class="value">${handicap}</div></div>
                            <div class="item"><div class="label">NET</div><div class="value net">${net}</div></div>
                        </div>
                    </div>
                    <a href="tournaments.html" class="back-link"><i class="fas fa-trophy"></i> View Standings</a>
                `;
                container.innerHTML = html;
                return;
            }

            // Build score inputs
            const frontNine = Math.min(9, league.course.holes);
            const backNine = league.course.holes > 9 ? league.course.holes - 9 : 0;
            const has18 = league.course.holes >= 18;
            
            html += `<div class="scores-card">`;
            
            // Front 9 section
            if (has18) {
                html += `<div class="section-header"><span>Front 9</span><span class="subtotal" id="outTotal">OUT: -</span></div>`;
            } else {
                html += `<div class="section-header"><span>Scores</span></div>`;
            }
            
            let total = 0;
            let out = 0;
            let inScore = 0;
            let totalPar = 0;
            
            for (let h = 1; h <= frontNine; h++) {
                const val = scores[h] || '';
                const par = league.course.pars?.[h-1] || 4;
                totalPar += par;
                if (val) {
                    total += val;
                    out += val;
                }
                
                let inputClass = '';
                if (val) {
                    if (val < par) inputClass = 'under-par';
                    else if (val === par + 1) inputClass = 'over-par';
                    else if (val > par + 1) inputClass = 'double-over';
                }
                
                html += `
                    <div class="hole-row">
                        <div class="hole-info">
                            <span class="hole-label">Hole ${h}</span>
                            <span class="hole-par">Par ${par}</span>
                        </div>
                        <input type="number" class="score-input ${inputClass}" id="h${h}" 
                               value="${val}" min="1" max="15" inputmode="numeric"
                               data-par="${par}" data-section="front"
                               onchange="saveHole(${h}, this.value)" onfocus="this.select()">
                    </div>
                `;
            }
            
            // Back 9 section
            if (has18) {
                html += `<div class="section-header"><span>Back 9</span><span class="subtotal" id="inTotal">IN: -</span></div>`;
                
                for (let h = frontNine + 1; h <= league.course.holes; h++) {
                    const val = scores[h] || '';
                    const par = league.course.pars?.[h-1] || 4;
                    totalPar += par;
                    if (val) {
                        total += val;
                        inScore += val;
                    }
                    
                    let inputClass = '';
                    if (val) {
                        if (val < par) inputClass = 'under-par';
                        else if (val === par + 1) inputClass = 'over-par';
                        else if (val > par + 1) inputClass = 'double-over';
                    }
                    
                    html += `
                        <div class="hole-row">
                            <div class="hole-info">
                                <span class="hole-label">Hole ${h}</span>
                                <span class="hole-par">Par ${par}</span>
                            </div>
                            <input type="number" class="score-input ${inputClass}" id="h${h}" 
                                   value="${val}" min="1" max="15" inputmode="numeric"
                                   data-par="${par}" data-section="back"
                                   onchange="saveHole(${h}, this.value)" onfocus="this.select()">
                        </div>
                    `;
                }
            }
            
            const player = league.players.find(p => p.id === playerId);
            const handicap = player?.handicap || 0;
            const net = total - handicap;
            
            // Score summary matching Excel format: OUT | IN | TOT | HCP | NET
            html += `
                <div class="score-summary ${has18 ? '' : 'nine-holes'}">
                    ${has18 ? `<div class="item"><div class="label">OUT</div><div class="value" id="outVal">${out || '-'}</div></div>` : ''}
                    ${has18 ? `<div class="item"><div class="label">IN</div><div class="value" id="inVal">${inScore || '-'}</div></div>` : ''}
                    <div class="item"><div class="label">TOT</div><div class="value" id="total">${total || '-'}</div></div>
                    <div class="item"><div class="label">HCP</div><div class="value">${handicap}</div></div>
                    <div class="item"><div class="label">NET</div><div class="value net" id="netVal">${total ? net : '-'}</div></div>
                </div>
            </div>
            <button class="submit-btn" onclick="submit()">Submit Score</button>
            <a href="tournaments.html" class="back-link">View Standings</a>
            `;

            container.innerHTML = html;
        }

        function selectPlayer(id) {
            playerId = id;
            if (id) {
                saveProfile(id);
                const url = new URL(window.location);
                url.searchParams.set('p', id);
                window.history.pushState({}, '', url);
            }
            render();
        }
        
        function showPlayerSelect() {
            playerId = null;
            render();
        }
        
        function showPinEntry() {
            const container = document.getElementById('content');
            container.innerHTML = `
                <div class="registration-form">
                    <h2><i class="fas fa-key"></i> Enter Your PIN</h2>
                    <p class="form-desc">Your 4-digit PIN was shown when you registered</p>
                    <form onsubmit="loginWithPin(event)">
                        <div class="form-group">
                            <input type="text" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]{4}" 
                                   inputmode="numeric" placeholder="••••" autocomplete="off" required>
                        </div>
                        <div id="pinError" class="error-msg" style="display:none"></div>
                        <button type="submit" class="submit-btn"><i class="fas fa-sign-in-alt"></i> Continue</button>
                        <button type="button" class="cancel-btn" onclick="render()"><i class="fas fa-arrow-left"></i> Back</button>
                    </form>
                </div>
            `;
            document.getElementById('pinInput').focus();
        }
        
        function loginWithPin(e) {
            e.preventDefault();
            const pin = document.getElementById('pinInput').value;
            const player = league.players.find(p => p.pin === pin);
            
            if (player) {
                selectPlayer(player.id);
            } else {
                const errorEl = document.getElementById('pinError');
                errorEl.textContent = 'PIN not found. Please try again or create a new profile.';
                errorEl.style.display = 'block';
                document.getElementById('pinInput').value = '';
                document.getElementById('pinInput').focus();
            }
        }
        
        function showBrowsePlayers() {
            const container = document.getElementById('content');
            const playersByTeam = {};
            const noTeam = [];
            
            league.players.forEach(p => {
                if (p.teamId) {
                    if (!playersByTeam[p.teamId]) playersByTeam[p.teamId] = [];
                    playersByTeam[p.teamId].push(p);
                } else {
                    noTeam.push(p);
                }
            });
            
            let playersHtml = '';
            
            league.teams.forEach(team => {
                const teamPlayers = playersByTeam[team.id] || [];
                if (teamPlayers.length > 0) {
                    playersHtml += `<div class="team-group"><div class="team-name"><i class="fas fa-users"></i> ${team.name}</div>`;
                    teamPlayers.forEach(p => {
                        playersHtml += `<div class="player-item" onclick="selectPlayer('${p.id}')"><span>${p.name}</span><span class="hcp">HCP ${p.handicap || 0}</span></div>`;
                    });
                    playersHtml += `</div>`;
                }
            });
            
            if (noTeam.length > 0) {
                playersHtml += `<div class="team-group"><div class="team-name"><i class="fas fa-user"></i> Individual Players</div>`;
                noTeam.forEach(p => {
                    playersHtml += `<div class="player-item" onclick="selectPlayer('${p.id}')"><span>${p.name}</span><span class="hcp">HCP ${p.handicap || 0}</span></div>`;
                });
                playersHtml += `</div>`;
            }
            
            if (league.players.length === 0) {
                playersHtml = `<div class="empty-state"><i class="fas fa-users-slash"></i><p>No players yet. Be the first to register!</p></div>`;
            }
            
            container.innerHTML = `
                <div class="browse-players">
                    <h2><i class="fas fa-list"></i> Select Your Name</h2>
                    <div class="players-list">${playersHtml}</div>
                    <button type="button" class="cancel-btn" onclick="render()"><i class="fas fa-arrow-left"></i> Back</button>
                </div>
            `;
        }
        
        function showRegistration() {
            const container = document.getElementById('content');
            container.innerHTML = `
                <div class="registration-form">
                    <h2><i class="fas fa-user-plus"></i> Create Profile</h2>
                    <p class="form-desc">Register to start entering your scores</p>
                    <form onsubmit="registerPlayer(event)">
                        <div class="form-group">
                            <label>Your Name</label>
                            <input type="text" id="regName" required placeholder="John Smith" autocomplete="name">
                        </div>
                        <div class="form-group">
                            <label>Handicap</label>
                            <input type="number" id="regHandicap" value="0" min="0" max="54">
                        </div>
                        <div class="form-group">
                            <label>Team</label>
                            <select id="regTeam" onchange="toggleNewTeam(this.value)">
                                <option value="">-- No Team --</option>
                                ${(league.teams || []).map(t => `<option value="${t.id}">${t.name}</option>`).join('')}
                                <option value="__new__">➕ Create New Team</option>
                            </select>
                        </div>
                        <div class="form-group" id="newTeamGroup" style="display:none">
                            <label>New Team Name</label>
                            <input type="text" id="newTeamName" placeholder="The Eagles">
                        </div>
                        <div id="regError" class="error-msg" style="display:none"></div>
                        <button type="submit" class="submit-btn"><i class="fas fa-check"></i> Create Profile</button>
                        <button type="button" class="cancel-btn" onclick="render()"><i class="fas fa-arrow-left"></i> Back</button>
                    </form>
                </div>
            `;
        }
        
        function toggleNewTeam(value) {
            const newTeamGroup = document.getElementById('newTeamGroup');
            newTeamGroup.style.display = value === '__new__' ? 'block' : 'none';
            if (value === '__new__') {
                document.getElementById('newTeamName').focus();
            }
        }
        
        function generatePin() {
            // Generate unique 4-digit PIN
            const existingPins = new Set(league.players.map(p => p.pin));
            let pin;
            let attempts = 0;
            do {
                pin = Math.floor(1000 + Math.random() * 9000).toString();
                attempts++;
            } while (existingPins.has(pin) && attempts < 100);
            return pin;
        }
        
        function registerPlayer(e) {
            e.preventDefault();
            const name = document.getElementById('regName').value.trim();
            const handicap = parseInt(document.getElementById('regHandicap').value) || 0;
            let teamId = document.getElementById('regTeam').value || null;
            const errorEl = document.getElementById('regError');
            
            if (!name) return;
            
            // Check for duplicate name
            const existingPlayer = league.players.find(p => p.name.toLowerCase() === name.toLowerCase());
            if (existingPlayer) {
                errorEl.innerHTML = `A player named "${existingPlayer.name}" already exists. If that's you, use "I have a PIN" to reconnect.`;
                errorEl.style.display = 'block';
                return;
            }
            
            // Create new team if requested
            if (teamId === '__new__') {
                const newTeamName = document.getElementById('newTeamName').value.trim();
                if (!newTeamName) {
                    errorEl.textContent = 'Please enter a team name';
                    errorEl.style.display = 'block';
                    return;
                }
                // Check for duplicate team name
                const existingTeam = (league.teams || []).find(t => t.name.toLowerCase() === newTeamName.toLowerCase());
                if (existingTeam) {
                    errorEl.textContent = `Team "${existingTeam.name}" already exists. Select it from the dropdown.`;
                    errorEl.style.display = 'block';
                    return;
                }
                const newTeam = {
                    id: 't' + Date.now(),
                    name: newTeamName
                };
                league.teams = league.teams || [];
                league.teams.push(newTeam);
                teamId = newTeam.id;
            }
            
            const pin = generatePin();
            const newPlayer = {
                id: 'p' + Date.now(),
                name,
                handicap,
                teamId,
                pin
            };
            
            league.players.push(newPlayer);
            leagueRef.set(league);
            
            // Show PIN to user before continuing
            showPinConfirmation(newPlayer);
        }
        
        function showPinConfirmation(player) {
            const container = document.getElementById('content');
            const team = (league.teams || []).find(t => t.id === player.teamId);
            container.innerHTML = `
                <div class="pin-confirmation">
                    <div class="success-icon"><i class="fas fa-check-circle"></i></div>
                    <h2>Welcome, ${player.name}!</h2>
                    <p>Your profile has been created${team ? ` on team <strong>${team.name}</strong>` : ''}.</p>
                    
                    <div class="pin-display">
                        <div class="pin-label">Your PIN</div>
                        <div class="pin-number">${player.pin}</div>
                        <div class="pin-hint"><i class="fas fa-info-circle"></i> Save this PIN to reconnect next time</div>
                    </div>
                    
                    <button class="submit-btn" onclick="selectPlayer('${player.id}')"><i class="fas fa-golf-ball"></i> Start Entering Scores</button>
                    <a href="tournaments.html" class="back-link"><i class="fas fa-trophy"></i> View Leaderboard</a>
                </div>
            `;
        }

        function getScores() {
            if (!playerId || !roundId) return {};
            return league.scores?.[roundId]?.[playerId] || {};
        }

        function saveHole(hole, value) {
            const score = parseInt(value) || 0;
            
            if (!league.scores) league.scores = {};
            if (!league.scores[roundId]) league.scores[roundId] = {};
            if (!league.scores[roundId][playerId]) league.scores[roundId][playerId] = {};

            if (score > 0) {
                league.scores[roundId][playerId][hole] = score;
            } else {
                delete league.scores[roundId][playerId][hole];
            }

            leagueRef.set(league);
            
            // Update input styling
            const input = document.getElementById('h' + hole);
            const par = parseInt(input.dataset.par) || 4;
            input.classList.remove('under-par', 'over-par', 'double-over');
            if (score > 0) {
                if (score < par) input.classList.add('under-par');
                else if (score === par + 1) input.classList.add('over-par');
                else if (score > par + 1) input.classList.add('double-over');
            }
            
            updateTotal();
        }

        function updateTotal() {
            const scores = getScores();
            const frontNine = Math.min(9, league.course.holes);
            const has18 = league.course.holes >= 18;
            
            let out = 0, inScore = 0, total = 0;
            
            for (let h = 1; h <= frontNine; h++) {
                out += scores[h] || 0;
            }
            
            if (has18) {
                for (let h = frontNine + 1; h <= league.course.holes; h++) {
                    inScore += scores[h] || 0;
                }
            }
            
            total = out + inScore;
            
            const player = league.players.find(p => p.id === playerId);
            const handicap = player?.handicap || 0;
            const net = total - handicap;
            
            // Update displays
            document.getElementById('total').textContent = total || '-';
            if (has18) {
                document.getElementById('outVal').textContent = out || '-';
                document.getElementById('inVal').textContent = inScore || '-';
                document.getElementById('outTotal').textContent = 'OUT: ' + (out || '-');
                document.getElementById('inTotal').textContent = 'IN: ' + (inScore || '-');
            }
            document.getElementById('netVal').textContent = total ? net : '-';
        }

        function submit() {
            const scores = getScores();
            let filled = 0;
            for (let h = 1; h <= league.course.holes; h++) {
                if (scores[h]) filled++;
            }

            if (filled < league.course.holes) {
                if (!confirm(`You entered ${filled}/${league.course.holes} holes. Submit anyway?`)) {
                    return;
                }
            }

            league.scores[roundId][playerId].submitted = true;
            league.scores[roundId][playerId].submittedAt = new Date().toISOString();
            leagueRef.set(league).then(() => {
                window.location.href = 'tournaments.html';
            });
        }

        init();
    </script>
</body>
</html>
