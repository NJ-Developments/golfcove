<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Enter Score - Golf Cove</title>
    <link rel="icon" type="image/png" href="images/golfcovelogo.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: #37b24a;
            color: #fff;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            font-size: 20px;
            margin-bottom: 4px;
        }
        .header p {
            font-size: 14px;
            opacity: 0.9;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }
        .player-select {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .player-select label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .player-select select {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .player-select select:focus {
            border-color: #37b24a;
            outline: none;
        }
        .scores-card {
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .scores-header {
            background: #333;
            color: #fff;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
        }
        .hole-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            border-bottom: 1px solid #f0f0f0;
        }
        .hole-row:last-child {
            border-bottom: none;
        }
        .hole-info {
            display: flex;
            flex-direction: column;
        }
        .hole-label {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }
        .hole-par {
            font-size: 12px;
            color: #888;
            margin-top: 2px;
        }
        .score-input {
            width: 60px;
            padding: 10px;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
        }
        .score-input:focus {
            border-color: #37b24a;
            outline: none;
        }
        .score-input.under-par {
            border-color: #37b24a;
            background: #e8f5e9;
            color: #2e7d32;
        }
        .score-input.over-par {
            border-color: #ff9800;
            background: #fff3e0;
            color: #e65100;
        }
        .score-input.double-over {
            border-color: #f44336;
            background: #ffebee;
            color: #c62828;
        }
        .totals {
            display: flex;
            justify-content: space-between;
            padding: 18px 20px;
            background: #f8f9fa;
            font-weight: 600;
            font-size: 16px;
        }
        .totals .value {
            color: #37b24a;
            font-size: 20px;
        }
        .submit-btn {
            width: 100%;
            padding: 16px;
            margin-top: 20px;
            background: #37b24a;
            color: #fff;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        .submit-btn:hover {
            background: #2d9440;
        }
        .back-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: #37b24a;
            text-decoration: none;
            font-weight: 500;
        }
        .message {
            text-align: center;
            padding: 50px 20px;
            color: #666;
        }
        .submitted {
            background: #e8f5e9;
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
        }
        .submitted h2 {
            color: #2e7d32;
            margin-bottom: 10px;
        }
        .submitted .score {
            font-size: 48px;
            font-weight: 700;
            color: #37b24a;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="leagueName">Golf Cove League</h1>
        <p id="roundName">Loading...</p>
    </div>

    <div class="container" id="content">
        <div class="message">Loading...</div>
    </div>

    <script>
        let league = null;
        let roundId = null;
        let playerId = null;

        function init() {
            league = JSON.parse(localStorage.getItem('golfcove_league') || 'null');
            
            if (!league) {
                showMessage('No league found. Please set up a league first.');
                return;
            }

            const params = new URLSearchParams(window.location.search);
            roundId = params.get('r');
            playerId = params.get('p');

            // Get current round if not specified
            if (!roundId && league.rounds.length > 0) {
                roundId = league.rounds[league.rounds.length - 1].id;
            }

            const round = league.rounds.find(r => r.id === roundId);
            if (!round) {
                showMessage('No active round. Ask admin to create one.');
                return;
            }

            document.getElementById('leagueName').textContent = league.name;
            document.getElementById('roundName').textContent = round.name;

            render();
        }

        function showMessage(msg) {
            document.getElementById('content').innerHTML = `<div class="message">${msg}</div>`;
        }

        function render() {
            const container = document.getElementById('content');
            const scores = getScores();
            const submitted = scores.submitted;

            // Build player dropdown
            let html = `
                <div class="player-select">
                    <label>Select Your Name</label>
                    <select id="playerSelect" onchange="selectPlayer(this.value)">
                        <option value="">-- Choose --</option>
                        ${league.players.map(p => `
                            <option value="${p.id}" ${p.id === playerId ? 'selected' : ''}>${p.name}</option>
                        `).join('')}
                    </select>
                </div>
            `;

            if (!playerId) {
                container.innerHTML = html;
                return;
            }

            if (submitted) {
                let total = 0;
                for (let h = 1; h <= league.course.holes; h++) {
                    total += scores[h] || 0;
                }
                html += `
                    <div class="submitted">
                        <h2>✓ Score Submitted</h2>
                        <p>Your round has been recorded.</p>
                        <div class="score">${total}</div>
                    </div>
                    <a href="tournaments.html" class="back-link">View Standings →</a>
                `;
                container.innerHTML = html;
                return;
            }

            // Build score inputs
            html += `<div class="scores-card"><div class="scores-header">Scores</div>`;
            
            let total = 0;
            let totalPar = 0;
            for (let h = 1; h <= league.course.holes; h++) {
                const val = scores[h] || '';
                const par = league.course.pars?.[h-1] || 4;
                totalPar += par;
                if (val) total += val;
                
                let inputClass = '';
                if (val) {
                    if (val < par) inputClass = 'under-par';
                    else if (val === par + 1) inputClass = 'over-par';
                    else if (val > par + 1) inputClass = 'double-over';
                }
                
                html += `
                    <div class="hole-row">
                        <div class="hole-info">
                            <span class="hole-label">Hole ${h}</span>
                            <span class="hole-par">Par ${par}</span>
                        </div>
                        <input type="number" class="score-input ${inputClass}" id="h${h}" 
                               value="${val}" min="1" max="15" inputmode="numeric"
                               data-par="${par}"
                               onchange="saveHole(${h}, this.value)" onfocus="this.select()">
                    </div>
                `;
            }

            const vsPar = total ? total - totalPar : null;
            const vsParDisplay = vsPar !== null ? (vsPar === 0 ? 'E' : (vsPar > 0 ? '+' + vsPar : vsPar)) : '';
            
            html += `
                <div class="totals">
                    <span>Total ${vsParDisplay ? '(' + vsParDisplay + ')' : ''}</span>
                    <span class="value" id="total">${total || '-'}</span>
                </div>
            </div>
            <button class="submit-btn" onclick="submit()">Submit Score</button>
            <a href="tournaments.html" class="back-link">View Standings</a>
            `;

            container.innerHTML = html;
        }

        function selectPlayer(id) {
            playerId = id;
            if (id) {
                const url = new URL(window.location);
                url.searchParams.set('p', id);
                window.history.pushState({}, '', url);
            }
            render();
        }

        function getScores() {
            if (!playerId || !roundId) return {};
            return league.scores?.[roundId]?.[playerId] || {};
        }

        function saveHole(hole, value) {
            const score = parseInt(value) || 0;
            
            if (!league.scores) league.scores = {};
            if (!league.scores[roundId]) league.scores[roundId] = {};
            if (!league.scores[roundId][playerId]) league.scores[roundId][playerId] = {};

            if (score > 0) {
                league.scores[roundId][playerId][hole] = score;
            } else {
                delete league.scores[roundId][playerId][hole];
            }

            localStorage.setItem('golfcove_league', JSON.stringify(league));
            
            // Update input styling
            const input = document.getElementById('h' + hole);
            const par = parseInt(input.dataset.par) || 4;
            input.classList.remove('under-par', 'over-par', 'double-over');
            if (score > 0) {
                if (score < par) input.classList.add('under-par');
                else if (score === par + 1) input.classList.add('over-par');
                else if (score > par + 1) input.classList.add('double-over');
            }
            
            updateTotal();
        }

        function updateTotal() {
            const scores = getScores();
            let total = 0;
            for (let h = 1; h <= league.course.holes; h++) {
                total += scores[h] || 0;
            }
            document.getElementById('total').textContent = total || '-';
        }

        function submit() {
            const scores = getScores();
            let filled = 0;
            for (let h = 1; h <= league.course.holes; h++) {
                if (scores[h]) filled++;
            }

            if (filled < league.course.holes) {
                if (!confirm(`You entered ${filled}/${league.course.holes} holes. Submit anyway?`)) {
                    return;
                }
            }

            league.scores[roundId][playerId].submitted = true;
            league.scores[roundId][playerId].submittedAt = new Date().toISOString();
            localStorage.setItem('golfcove_league', JSON.stringify(league));

            window.location.href = 'tournaments.html';
        }

        init();
    </script>
</body>
</html>
