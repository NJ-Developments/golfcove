<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Golf Cove - New Haven</title>
    <link rel="icon" type="image/png" href="images/golfCoveLogo6.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #2f3439;
            color: #e9ecef;
            min-height: 100vh;
        }
        
        /* Header */
        .header {
            background: #ffffff;
            color: #222;
            padding: 18px 16px 8px;
            text-align: center;
            border-bottom: 1px solid #e5e5e5;
        }
        .header a { position: relative; z-index: 1; display: inline-block; }
        .header h1 {
            font-size: 20px;
            margin-bottom: 4px;
            font-weight: 700;
            position: relative;
            z-index: 1;
            color: #2f3439;
        }
        .header p {
            font-size: 13px;
            opacity: 0.8;
            position: relative;
            z-index: 1;
            color: #2f3439;
        }
        
        .container {
            max-width: 520px;
            margin: 0 auto;
            padding: 16px;
            padding-bottom: 40px;
        }

        /* Hero summary */
        .hero-card {
            background: #3c4146;
            color: #fff;
            border-radius: 18px;
            padding: 22px 18px 18px;
            text-align: center;
            box-shadow: 0 14px 30px rgba(0,0,0,0.35);
            border: 1px solid #1fa34a;
            margin-bottom: 18px;
        }
        .hero-title {
            font-size: 32px;
            font-weight: 800;
            line-height: 1.15;
        }
        .hero-subtitle {
            font-size: 18px;
            font-weight: 700;
            margin-top: 8px;
            margin-bottom: 6px;
        }
        .hero-meta {
            font-size: 15px;
            color: #cbd5e1;
            margin-bottom: 6px;
        }
        .hero-date {
            font-size: 13px;
            color: #9ca3af;
        }
        .hero-switch {
            margin-top: 10px;
            width: 100%;
            background: #10a0b6;
            color: #fff;
            border: none;
        }
        .hero-switch:hover {
            background: #0c90a5;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 35px 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .welcome-screen h2 {
            color: #1a1a2e;
            font-size: 24px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 700;
        }
        .welcome-desc {
            color: #666;
            font-size: 15px;
            text-align: center;
            margin-bottom: 30px;
        }
        .option-card {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            background: #fff;
            border: 2px solid #e8e8e8;
            border-radius: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .option-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(55,178,74,0.1), transparent);
            transition: left 0.5s;
        }
        .option-card:hover::before {
            left: 100%;
        }
        .option-card:hover {
            border-color: #37b24a;
            transform: translateX(5px);
            box-shadow: 0 5px 20px rgba(55,178,74,0.15);
        }
        .option-card.secondary {
            background: linear-gradient(145deg, #f8f9fa 0%, #fff 100%);
            border-style: dashed;
        }
        .option-icon {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 20px;
            margin-right: 16px;
            box-shadow: 0 4px 12px rgba(55,178,74,0.3);
        }
        .option-card.secondary .option-icon {
            background: linear-gradient(135deg, #e0e0e0 0%, #bdbdbd 100%);
            color: #666;
            box-shadow: none;
        }
        .option-text { flex: 1; }
        .option-title {
            font-size: 16px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .option-desc {
            font-size: 13px;
            color: #888;
            margin-top: 3px;
        }
        .option-card > i.fa-chevron-right {
            color: #37b24a;
            font-size: 14px;
            opacity: 0;
            transform: translateX(-10px);
            transition: all 0.3s;
        }
        .option-card:hover > i.fa-chevron-right {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Profile card */
        .profile-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .profile-avatar {
            width: 55px;
            height: 55px;
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(55,178,74,0.3);
        }
        .profile-avatar i {
            font-size: 24px;
            color: #fff;
        }
        .profile-name {
            font-size: 18px;
            font-weight: 700;
            color: #1a1a2e;
        }
        .profile-meta {
            display: flex;
            gap: 12px;
            font-size: 13px;
            color: #666;
            margin-top: 4px;
        }
        .profile-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .profile-meta i { color: #37b24a; }
        .switch-btn {
            background: linear-gradient(145deg, #f5f5f5 0%, #e8e8e8 100%);
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }
        .switch-btn:hover { 
            background: linear-gradient(145deg, #e8e8e8 0%, #ddd 100%);
            transform: scale(1.05);
        }
        
        /* Scores Card */
        .scores-card {
            background: #2d3137;
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0,0,0,0.35);
            overflow: hidden;
            border: 2px solid #1fa34a;
            margin-top: 12px;
        }
        .section-header {
            background: #16a34a;
            color: #fff;
            padding: 14px 18px;
            font-size: 16px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 8px;
            letter-spacing: 0.2px;
        }
        .section-header .section-subtitle { font-weight: 700; font-size: 13px; opacity: 0.95; }
        .section-header .subtotal {
            display: none;
        }
        .hole-card {
            background: #2d3137;
            border: 1px solid #1fa34a;
            border-radius: 10px;
            overflow: hidden;
            margin: 12px 14px;
            box-shadow: 0 6px 16px rgba(0,0,0,0.35);
        }
        .hole-title {
            background: #12a7bf;
            color: #fff;
            text-align: center;
            padding: 12px;
            font-size: 18px;
            font-weight: 800;
            letter-spacing: 0.3px;
        }
        .hole-input-wrap {
            background: #f7f9fc;
            padding: 12px;
        }
        .score-input {
            width: 100%;
            height: 52px;
            padding: 0;
            font-size: 22px;
            font-weight: 800;
            text-align: center;
            border: 2px solid #d9e2ec;
            border-radius: 8px;
            background: #fff;
            transition: all 0.2s;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }
        .score-input::-webkit-inner-spin-button,
        .score-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .score-input:focus {
            border-color: #37b24a;
            outline: none;
            box-shadow: 0 0 0 4px rgba(55,178,74,0.15);
            transform: scale(1.05);
        }
        
        /* Responsive tweaks */
        @media (max-width: 520px) {
            .container { padding: 12px; }
            .hero-card { padding: 18px 14px 14px; }
            .hero-title { font-size: 26px; }
            .hero-subtitle { font-size: 16px; }
            .hero-meta { font-size: 14px; }
            .hero-date { font-size: 12px; }
            .scores-card { margin-top: 12px; border-radius: 12px; }
            .section-header { padding: 12px 14px; font-size: 14px; }
            .hole-card { margin: 10px 10px; }
            .hole-title { font-size: 16px; padding: 10px; }
            .hole-input-wrap { padding: 10px; }
            .score-input { height: 48px; font-size: 20px; }
        }

        @media (max-width: 380px) {
            .hero-title { font-size: 22px; }
            .hero-subtitle { font-size: 15px; }
            .hole-title { font-size: 15px; }
        }
        
        /* Score Summary */
        .score-summary {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            background: #ffffff;
            border: 2px solid #333;
            border-radius: 8px;
        }
        .score-summary.nine-holes {
            grid-template-columns: repeat(3, 1fr);
        }
        .score-summary .item {
            padding: 18px 8px;
            text-align: center;
            border-right: 2px solid #333;
        }
        .score-summary .item:last-child {
            border-right: none;
        }
        .score-summary .item .label {
            font-size: 10px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }
        .score-summary .item .value {
            font-size: 26px;
            font-weight: 800;
            color: #333;
        }
        .score-summary .item .value.net {
            color: #37b24a;
            text-shadow: none;
        }
        
        /* Submit Button */
        .submit-btn {
            width: 100%;
            padding: 18px;
            margin-top: 25px;
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            color: #fff;
            border: none;
            border-radius: 14px;
            font-size: 17px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(55,178,74,0.4);
            position: relative;
            overflow: hidden;
        }
        .submit-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .submit-btn:hover::before {
            left: 100%;
        }
        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(55,178,74,0.5);
        }
        .submit-btn:active {
            transform: translateY(0);
        }
        .submit-btn:disabled {
            background: linear-gradient(135deg, #ccc 0%, #aaa 100%);
            box-shadow: none;
            transform: none;
        }
        .submit-btn i { margin-right: 8px; }
        
        .back-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 20px;
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-weight: 600;
            font-size: 14px;
            transition: color 0.2s;
        }
        .back-link:hover {
            color: #37b24a;
        }
        
        /* Submitted State */
        .submitted {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 50px 25px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: fadeInUp 0.5s ease;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .submitted .checkmark {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            animation: scaleIn 0.4s ease, pulse 2s infinite 0.5s;
            box-shadow: 0 8px 30px rgba(55,178,74,0.4);
        }
        @keyframes scaleIn {
            from { transform: scale(0); }
            to { transform: scale(1); }
        }
        @keyframes pulse {
            0%, 100% { box-shadow: 0 8px 30px rgba(55,178,74,0.4); }
            50% { box-shadow: 0 8px 50px rgba(55,178,74,0.6); }
        }
        .submitted .checkmark i {
            color: #fff;
            font-size: 36px;
        }
        .submitted h2 {
            color: #1a1a2e;
            margin-bottom: 10px;
            font-size: 26px;
            font-weight: 700;
        }
        .submitted p {
            color: #666;
            font-size: 15px;
        }
        .submitted .score-summary {
            margin: 25px -25px;
            border-radius: 0;
        }
        
        /* Registration Form */
        .registration-form {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .registration-form h2 {
            color: #1a1a2e;
            font-size: 22px;
            margin-bottom: 5px;
            font-weight: 700;
        }
        .registration-form h2 i { color: #37b24a; margin-right: 10px; }
        .form-desc {
            color: #666;
            font-size: 14px;
            margin-bottom: 25px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 700;
            color: #555;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .form-group input, .form-group select {
            width: 100%;
            padding: 14px 16px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            background: #fff;
            transition: all 0.2s;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #37b24a;
            outline: none;
            box-shadow: 0 0 0 4px rgba(55,178,74,0.1);
        }
        .cancel-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(145deg, #f5f5f5 0%, #e8e8e8 100%);
            border: none;
            border-radius: 12px;
            color: #666;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 12px;
            transition: all 0.2s;
        }
        .cancel-btn:hover { 
            background: linear-gradient(145deg, #e8e8e8 0%, #ddd 100%);
        }
        
        /* Error Message */
        .error-msg {
            color: #c62828;
            font-size: 13px;
            margin-bottom: 15px;
            padding: 12px 15px;
            background: linear-gradient(145deg, #ffebee 0%, #ffcdd2 100%);
            border-radius: 10px;
            border-left: 4px solid #f44336;
        }
        
        /* PIN Confirmation */
        .pin-confirmation {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 40px 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            text-align: center;
        }
        .pin-confirmation .success-icon {
            font-size: 70px;
            color: #37b24a;
            margin-bottom: 20px;
            animation: scaleIn 0.5s ease;
        }
        .pin-confirmation h2 {
            color: #1a1a2e;
            font-size: 24px;
            margin-bottom: 10px;
            font-weight: 700;
        }
        .pin-confirmation p {
            color: #666;
            font-size: 15px;
        }
        .pin-display {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 16px;
            padding: 30px;
            margin: 30px 0;
        }
        .pin-label {
            font-size: 11px;
            color: rgba(255,255,255,0.6);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 12px;
        }
        .pin-number {
            font-size: 52px;
            font-weight: 800;
            color: #37b24a;
            letter-spacing: 12px;
            text-shadow: 0 0 30px rgba(55,178,74,0.5);
        }
        .pin-hint {
            font-size: 12px;
            color: rgba(255,255,255,0.5);
            margin-top: 15px;
        }
        .pin-hint i { margin-right: 5px; color: #37b24a; }
        
        /* PIN Input */
        .pin-input {
            width: 100%;
            padding: 18px;
            font-size: 32px;
            font-weight: 800;
            text-align: center;
            letter-spacing: 12px;
            border: 3px solid #e0e0e0;
            border-radius: 14px;
            background: #fff;
            transition: all 0.2s;
        }
        .pin-input:focus {
            border-color: #37b24a;
            outline: none;
            box-shadow: 0 0 0 4px rgba(55,178,74,0.15);
        }
        
        /* Browse Players */
        .browse-players {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .browse-players h2 {
            color: #1a1a2e;
            font-size: 20px;
            margin-bottom: 20px;
            font-weight: 700;
        }
        .browse-players h2 i { color: #37b24a; margin-right: 10px; }
        .players-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .team-group {
            margin-bottom: 15px;
        }
        .team-name {
            font-size: 12px;
            font-weight: 700;
            color: #37b24a;
            padding: 10px 0;
            border-bottom: 2px solid #e8f5e9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .team-name i { margin-right: 8px; }
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 12px;
            border-bottom: 1px solid #f5f5f5;
            cursor: pointer;
            transition: all 0.2s;
            border-radius: 8px;
            margin: 2px 0;
        }
        .player-item:hover {
            background: linear-gradient(145deg, #e8f5e9 0%, #c8e6c9 100%);
            transform: translateX(5px);
        }
        .player-item span:first-child {
            font-size: 15px;
            font-weight: 600;
            color: #333;
        }
        .player-item .hcp {
            font-size: 12px;
            color: #fff;
            background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 600;
        }
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }
        .empty-state i {
            font-size: 50px;
            margin-bottom: 15px;
            color: #ddd;
        }
        
        /* Message */
        .message {
            text-align: center;
            padding: 60px 20px;
            color: rgba(255,255,255,0.7);
        }
        .message i {
            font-size: 50px;
            color: #37b24a;
            margin-bottom: 15px;
        }
        
        /* Divider - keeping for compatibility */
        .divider {
            display: flex;
            align-items: center;
            margin: 20px 0;
            color: #999;
            font-size: 13px;
        }
        .divider::before, .divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #e0e0e0;
        }
        .divider span { padding: 0 15px; }
        
        /* Register button - keeping for compatibility */
        .register-btn {
            width: 100%;
            padding: 14px;
            background: #fff;
            border: 2px dashed #37b24a;
            border-radius: 8px;
            color: #37b24a;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .register-btn:hover {
            background: #37b24a;
            color: #fff;
            border-style: solid;
        }
        
        /* Player select - keeping for compatibility */
        .player-select {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .player-select label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .player-select select {
            width: 100%;
            padding: 14px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            background: #fff;
        }
        .player-select select:focus {
            border-color: #37b24a;
            outline: none;
        }
        
        /* Totals - keeping for compatibility */
        .totals {
            display: flex;
            justify-content: space-between;
            padding: 18px 20px;
            background: #f8f9fa;
            font-weight: 600;
            font-size: 16px;
        }
        .totals .value {
            color: #37b24a;
            font-size: 20px;
        }
        
        /* Scores header - keeping for compatibility */
        .scores-header {
            background: #333;
            color: #fff;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 600;
        }
        
        /* Pin section - keeping for compatibility */
        .pin-section {
            background: #fff;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .pin-section label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
    <div class="header">
        <a href="index.html" style="display: inline-block; margin-bottom: 10px;">
            <img src="images/golfCoveLogo6.png" alt="Golf Cove" style="height: 60px;">
        </a>
        <h1 id="leagueName">Golf Cove League</h1>
        <p id="roundName">Loading...</p>
    </div>

    <div class="container" id="content">
        <div class="message"><i class="fas fa-spinner fa-spin"></i><p>Loading...</p></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyB8SH5Eh7OhIFLUkL2hjZS23uXkCsDJXGc",
            authDomain: "golfcove.firebaseapp.com",
            databaseURL: "https://golfcove-default-rtdb.firebaseio.com",
            projectId: "golfcove",
            storageBucket: "golfcove.firebasestorage.app",
            messagingSenderId: "284762891644",
            appId: "1:284762891644:web:424223b102f08a230f70f9"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const leagueRef = db.ref('league');
        const auth = firebase.auth();
        let authPromise = null;

        // Auth is disabled for demo; bypass sign-in so the app runs without Anonymous Auth
        function ensureAuth() {
            return Promise.resolve(auth.currentUser || null);
        }
        
        let league = null;
        let roundId = null;
        let playerId = null;
        let isEnteringScores = false; // Flag to prevent re-render during score entry
        
        // Profile management
        function getSavedProfile() {
            const saved = localStorage.getItem('golfcove_profile');
            return saved ? JSON.parse(saved) : null;
        }
        
        function saveProfile(id) {
            const player = league.players.find(p => p.id === id);
            const team = player && player.teamId ? league.teams.find(t => t.id === player.teamId) : null;
            localStorage.setItem('golfcove_profile', JSON.stringify({ 
                playerId: id,
                teamId: player?.teamId || null,
                teamName: team?.name || null,
                playerName: player?.name || null,
                lastVisit: new Date().toISOString()
            }));
        }
        
        function getSavedTeam() {
            const profile = getSavedProfile();
            if (!profile || !profile.teamId) return null;
            // Verify team still exists
            const team = (league.teams || []).find(t => t.id === profile.teamId);
            if (!team) return null;
            const players = (league.players || []).filter(p => p.teamId === profile.teamId);
            if (players.length === 0) return null;
            return { team, players, profile };
        }
        
        function toggleMenu() {
            const nav = document.getElementById('mobileNav');
            nav.classList.toggle('open');
        }

        // Close mobile nav when clicking outside
        document.addEventListener('click', (e) => {
            const nav = document.getElementById('mobileNav');
            const btn = document.querySelector('.menu-btn');
            if (!nav || !btn) return;
            if (!nav.classList.contains('open')) return;
            if (!nav.contains(e.target) && !btn.contains(e.target)) {
                nav.classList.remove('open');
            }
        });
        
        function clearProfile() {
            localStorage.removeItem('golfcove_profile');
            playerId = null;
            render();
        }

        async function init() {
            // Listen for real-time updates from Firebase
            leagueRef.on('value', (snapshot) => {
                league = snapshot.val();
                
                if (!league) {
                    showMessage('‚ö†Ô∏è League not set up yet. Admin needs to configure league first.', 'fa-exclamation-triangle');
                    return;
                }

                // Ensure arrays exist and convert Firebase objects to arrays
                // Firebase stores as objects when using .set() with keys
                league.players = Array.isArray(league.players) ? league.players : 
                    (league.players ? Object.values(league.players) : []);
                league.rounds = Array.isArray(league.rounds) ? league.rounds : 
                    (league.rounds ? Object.values(league.rounds) : []);
                league.teams = Array.isArray(league.teams) ? league.teams : 
                    (league.teams ? Object.values(league.teams) : []);
                league.scores = league.scores || {};

                const params = new URLSearchParams(window.location.search);
                roundId = params.get('r');
                const urlPlayerId = params.get('p');
                const urlTeamId = params.get('t');  // Team-specific QR code
                
                // Store team filter if provided in URL
                if (urlTeamId) {
                    window.teamFilter = urlTeamId;
                }
                
                // Priority: URL param > saved profile
                if (urlPlayerId) {
                    playerId = urlPlayerId;
                    saveProfile(urlPlayerId);
                } else {
                    const savedProfile = getSavedProfile();
                    if (savedProfile && league.players.find(p => p.id === savedProfile.playerId)) {
                        playerId = savedProfile.playerId;
                    }
                }

                // Get current round based on today's date if not specified
                if (!roundId && league.rounds.length > 0) {
                    const today = new Date();
                    today.setHours(12, 0, 0, 0); // Use noon to avoid timezone edge cases
                    
                    // Helper to parse date strings safely (handles YYYY-MM-DD format)
                    function parseDate(dateStr) {
                        if (!dateStr) return null;
                        // If it's already a date object or timestamp
                        if (dateStr instanceof Date) return dateStr;
                        // Parse YYYY-MM-DD format without timezone issues
                        const parts = dateStr.split('-');
                        if (parts.length === 3) {
                            return new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]), 12, 0, 0);
                        }
                        return new Date(dateStr);
                    }
                    
                    // Find round that matches today's date
                    let currentRound = null;
                    for (const r of league.rounds) {
                        if (r.startDate && r.endDate) {
                            const start = parseDate(r.startDate);
                            const end = parseDate(r.endDate);
                            start.setHours(0, 0, 0, 0);
                            end.setHours(23, 59, 59, 999);
                            if (today >= start && today <= end) {
                                currentRound = r;
                                break;
                            }
                        }
                    }
                    
                    // If no current round, find next upcoming round
                    if (!currentRound) {
                        const upcomingRounds = league.rounds.filter(r => {
                            if (!r.startDate) return false;
                            const start = parseDate(r.startDate);
                            start.setHours(0, 0, 0, 0);
                            return start > today;
                        }).sort((a, b) => parseDate(a.startDate) - parseDate(b.startDate));
                        
                        console.log('Upcoming rounds:', upcomingRounds.map(r => r.name + ' - ' + r.startDate));
                        
                        if (upcomingRounds.length > 0) {
                            currentRound = upcomingRounds[0];
                        } else {
                            // Fall back to most recent round
                            currentRound = league.rounds[league.rounds.length - 1];
                        }
                    }
                    
                    console.log('Selected round:', currentRound?.name, currentRound?.startDate);
                    roundId = currentRound.id;
                }

                const round = league.rounds.find(r => r.id === roundId);
                if (!round) {
                    showMessage('No active round. Ask admin to create one.', 'fa-flag');
                    return;
                }

                document.getElementById('leagueName').textContent = league.name;
                document.getElementById('roundName').textContent = round.name;

                // Don't re-render if user is actively entering scores
                if (!isEnteringScores) {
                    render();
                }
            }, (error) => {
                // Handle Firebase errors (permissions, network, etc.)
                console.error('Firebase error:', error);
                if (error.code === 'PERMISSION_DENIED') {
                    showMessage('üîí Access denied. Database security rules may not be deployed yet. Contact admin.', 'fa-lock');
                } else {
                    showMessage('‚ùå Connection error: ' + error.message + '. Check your internet connection.', 'fa-exclamation-circle');
                }
            });
        }

        function showMessage(msg, icon = 'fa-info-circle') {
            document.getElementById('content').innerHTML = `
                <div class="message">
                    <i class="fas ${icon}"></i>
                    <p>${msg}</p>
                </div>`;
        }

        function render() {
            const container = document.getElementById('content');
            const scores = getScores();
            const submitted = scores.submitted;
            const currentPlayer = league.players.find(p => p.id === playerId);
            
            // Hero summary
            let profileHeader = '';
            if (league) {
                const holes = 9; // Front 9 only
                const round = league.rounds.find(r => r.id === roundId) || league.rounds[league.rounds.length - 1] || null;
                let roundDate = '';
                
                // Helper to format date without timezone issues
                function formatDateSafe(dateStr) {
                    if (!dateStr) return '';
                    const parts = dateStr.split('-');
                    if (parts.length === 3) {
                        const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                        return `${months[parseInt(parts[1]) - 1]} ${parseInt(parts[2])}, ${parts[0]}`;
                    }
                    return new Date(dateStr).toLocaleDateString();
                }
                
                if (round?.startDate && round?.endDate) {
                    const start = formatDateSafe(round.startDate);
                    const end = formatDateSafe(round.endDate);
                    roundDate = `${start} - ${end}`;
                } else if (round?.date) {
                    roundDate = formatDateSafe(round.date);
                }
                const team = currentPlayer ? (league.teams || []).find(t => t.id === currentPlayer.teamId) : null;
                const teamMembers = currentPlayer && currentPlayer.teamId 
                    ? league.players.filter(p => p.teamId === currentPlayer.teamId) 
                    : [currentPlayer].filter(Boolean);
                const teamMemberNames = teamMembers.map(p => p.name).join(' & ');
                const combinedHandicap = teamMembers.reduce((sum, p) => sum + (p.handicap || 0), 0);
                
                let playerMeta = '';
                if (currentPlayer) {
                    if (team && teamMembers.length > 1) {
                        // Team scorecard mode
                        playerMeta = `
                            <div class="hero-meta" style="background: rgba(55,178,74,0.15); padding: 8px 12px; border-radius: 8px; margin-top: 8px;">
                                <i class="fas fa-users" style="color:#37b24a;"></i> <strong>${team.name}</strong>
                            </div>
                            <div class="hero-meta" style="margin-top: 4px;">
                                ${teamMemberNames} ‚Ä¢ Combined HCP: ${combinedHandicap}
                            </div>
                            <div style="font-size: 11px; color: #9ca3af; margin-top: 4px;"><i class="fas fa-info-circle"></i> Team Scorecard - scores apply to both players</div>
                            <button class="switch-btn hero-switch" onclick="showExistingTeams()" style="margin-top: 8px;"><i class="fas fa-exchange-alt"></i> Switch Team</button>`;
                    } else {
                        // Individual player (no team) - redirect to team selection
                        playerMeta = `<div class="hero-meta">Player: ${currentPlayer.name} ‚Ä¢ HCP ${currentPlayer.handicap || 0}</div>
                           <button class="switch-btn hero-switch" onclick="showExistingTeams()"><i class="fas fa-exchange-alt"></i> Switch Team</button>`;
                    }
                }
                profileHeader = `
                    <div class="hero-card">
                        <div class="hero-title">${league.name || 'League'}</div>
                        <div class="hero-subtitle">${league.course?.name || ''} &nbsp; Front 9</div>
                        <div class="hero-date">${round ? round.name : ''}${roundDate ? ' ‚Ä¢ ' + roundDate : ''}</div>
                        ${playerMeta}
                    </div>
                `;
            }

            // Build player selection / registration
            let html = '';
            
            if (!playerId || document.getElementById('showingSelect')) {
                // Check if returning player has a saved team
                const savedTeam = getSavedTeam();
                let continueAsHtml = '';
                
                if (savedTeam) {
                    const { team, players, profile } = savedTeam;
                    const playerNames = players.map(p => p.name).join(' & ');
                    const combinedHcp = players.reduce((sum, p) => sum + (p.handicap || 0), 0);
                    // Check submission status for current round
                    const isSubmitted = players.some(p => league.scores?.[roundId]?.[p.id]?.submitted);
                    const hasScores = players.some(p => {
                        const scores = league.scores?.[roundId]?.[p.id];
                        return scores && Object.keys(scores).some(k => !isNaN(parseInt(k)));
                    });
                    
                    continueAsHtml = `
                        <div class="option-card" onclick="quickLoginTeam('${team.id}')" style="border-color: #37b24a; background: linear-gradient(145deg, #f0fff4 0%, #fff 100%);">
                            <div class="option-icon" style="background: linear-gradient(135deg, #37b24a 0%, #2d9440 100%);"><i class="fas fa-bolt"></i></div>
                            <div class="option-text">
                                <div class="option-title" style="color: #37b24a;">Continue as ${team.name}</div>
                                <div class="option-desc">${playerNames} ‚Ä¢ HCP ${combinedHcp}</div>
                                ${isSubmitted ? '<span style="background:#37b24a;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;margin-top:4px;display:inline-block;"><i class="fas fa-check"></i> Submitted</span>' : 
                                  hasScores ? '<span style="background:#f59e0b;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;margin-top:4px;display:inline-block;">In Progress</span>' : ''}
                            </div>
                            <i class="fas fa-chevron-right" style="opacity:1;transform:none;"></i>
                        </div>
                        
                        <div style="display:flex;align-items:center;gap:10px;margin:15px 0;">
                            <div style="flex:1;height:1px;background:#e8e8e8;"></div>
                            <span style="color:#888;font-size:12px;">or</span>
                            <div style="flex:1;height:1px;background:#e8e8e8;"></div>
                        </div>
                    `;
                }
                
                html = `
                    <div class="welcome-screen">
                        <h2>Welcome to ${league.name}</h2>
                        <p class="welcome-desc">2-Man Scramble - One Scorecard Per Team</p>
                        
                        ${continueAsHtml}
                        
                        <div class="option-card" onclick="showExistingTeams()">
                            <div class="option-icon"><i class="fas fa-users"></i></div>
                            <div class="option-text">
                                <div class="option-title">${savedTeam ? 'Switch Team' : 'Select Your Team'}</div>
                                <div class="option-desc">${savedTeam ? 'Choose a different team' : 'Login to enter scores for your team'}</div>
                            </div>
                            <i class="fas fa-chevron-right"></i>
                        </div>
                        
                        <p style="text-align: center; color: #888; font-size: 13px; margin-top: 20px;">
                            <i class="fas fa-info-circle"></i> Don't see your team? Contact an admin to create one.
                        </p>
                    </div>
                `;
                container.innerHTML = html;
                return;
            }
            
            html = profileHeader;

            if (submitted) {
                let total = 0;
                const frontNine = 9; // Front 9 only
                
                for (let h = 1; h <= frontNine; h++) {
                    total += scores[h] || 0;
                }
                
                const player = league.players.find(p => p.id === playerId);
                // For teams, use combined handicap
                const teamMembersSubmit = player && player.teamId 
                    ? league.players.filter(p => p.teamId === player.teamId) 
                    : [player].filter(Boolean);
                const handicap = teamMembersSubmit.reduce((sum, p) => sum + (p.handicap || 0), 0);
                const net = total - handicap;
                const isTeamSubmit = teamMembersSubmit.length > 1;
                const teamName = isTeamSubmit ? (league.teams || []).find(t => t.id === player.teamId)?.name : null;
                
                html += `
                    <div class="submitted">
                        <div class="checkmark"><i class="fas fa-check"></i></div>
                        <h2>${isTeamSubmit ? 'Team Score Submitted!' : 'Score Submitted!'}</h2>
                        <p>${isTeamSubmit ? `${teamName}'s round has been recorded for both players.` : 'Your round has been recorded.'}</p>
                        <div class="score-summary nine-holes" style="margin: 20px -20px; border-radius: 0;">
                            <div class="item"><div class="label">TOT</div><div class="value">${total}</div></div>
                            <div class="item"><div class="label">HCP</div><div class="value">${handicap}</div></div>
                            <div class="item"><div class="label">NET</div><div class="value net">${net}</div></div>
                        </div>
                    </div>
                    <a href="tournaments.html" class="back-link"><i class="fas fa-trophy"></i> View Standings</a>
                `;
                container.innerHTML = html;
                return;
            }

            // Build score inputs - Front 9 only
            const frontNine = 9;
            
            html += `<div class="scores-card">`;
            
            // Front 9 section
            html += `<div class="section-header"><span>Score Card - Front 9</span><span class="section-subtitle">click hole to edit score</span></div>`;
            
            let total = 0;
            let out = 0;
            let inScore = 0;
            
            for (let h = 1; h <= frontNine; h++) {
                const val = scores[h] || '';
                if (val) {
                    total += val;
                }
                
                html += `
                    <div class="hole-card">
                        <div class="hole-title">Hole ${h}</div>
                        <div class="hole-input-wrap">
                            <input type="number" class="score-input" id="h${h}" 
                                   value="${val}" min="1" max="15" inputmode="numeric"
                                   data-section="front"
                                   onchange="saveHole(${h}, this.value)" onfocus="this.select()">
                        </div>
                    </div>
                `;
            }
            
            const player = league.players.find(p => p.id === playerId);
            // For teams, use combined handicap
            const teamMembersForScore = player && player.teamId 
                ? league.players.filter(p => p.teamId === player.teamId) 
                : [player].filter(Boolean);
            const handicap = teamMembersForScore.reduce((sum, p) => sum + (p.handicap || 0), 0);
            const net = total - handicap;
            const isTeam = teamMembersForScore.length > 1;
            
            // Score summary - Front 9: TOT | HCP | NET
            html += `
                <div class="score-summary nine-holes">
                    <div class="item"><div class="label">TOT</div><div class="value" id="total">${total || '-'}</div></div>
                    <div class="item"><div class="label">${isTeam ? 'TEAM HCP' : 'HCP'}</div><div class="value" style="font-size: ${isTeam ? '14px' : '26px'};">${handicap}</div></div>
                    <div class="item"><div class="label">NET</div><div class="value net" id="netVal">${total ? net : '-'}</div></div>
                </div>
            </div>
            <button class="submit-btn" onclick="submit()">${isTeam ? '<i class="fas fa-users"></i> Submit Team Score' : 'Submit Score'}</button>
            <a href="tournaments.html" class="back-link">View Standings</a>
            `;

            container.innerHTML = html;
        }

        function selectPlayer(id) {
            playerId = id;
            if (id) {
                saveProfile(id);
                const url = new URL(window.location);
                url.searchParams.set('p', id);
                window.history.pushState({}, '', url);
            }
            render();
        }
        
        function showPlayerSelect() {
            // Show the browse players list (PIN required when selecting)
            showBrowsePlayers();
        }
        
        function showPinEntry() {
            const container = document.getElementById('content');
            container.innerHTML = `
                <div class="registration-form">
                    <h2><i class="fas fa-key"></i> Enter Your PIN</h2>
                    <p class="form-desc">Your 4-digit PIN was shown when you registered</p>
                    <form onsubmit="loginWithPin(event)">
                        <div class="form-group">
                            <input type="text" id="pinInput" class="pin-input" maxlength="4" pattern="[0-9]{4}" 
                                   inputmode="numeric" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" required>
                        </div>
                        <div id="pinError" class="error-msg" style="display:none"></div>
                        <button type="submit" class="submit-btn"><i class="fas fa-sign-in-alt"></i> Continue</button>
                        <button type="button" class="cancel-btn" onclick="render()"><i class="fas fa-arrow-left"></i> Back</button>
                    </form>
                </div>
            `;
            document.getElementById('pinInput').focus();
        }
        
        function loginWithPin(e) {
            e.preventDefault();
            const pin = document.getElementById('pinInput').value;
            const matches = (league.players || []).filter(p => p.pin === pin);
            
            if (matches.length === 1) {
                selectPlayer(matches[0].id);
                return;
            }
            
            if (matches.length > 1) {
                showPinSelectionModal(pin, matches);
                return;
            }
            
            const errorEl = document.getElementById('pinError');
            errorEl.textContent = 'PIN not found. If you were added by an admin, try "Browse Players" instead.';
            errorEl.style.display = 'block';
            document.getElementById('pinInput').value = '';
            document.getElementById('pinInput').focus();
        }

        function showPinSelectionModal(pin, matches) {
            const modal = document.createElement('div');
            modal.id = 'pinSelectionModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:12px;padding:25px;max-width:420px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.35);">
                    <h2 style="margin-bottom:10px;color:#1a1a2e;font-size:20px;"><i class="fas fa-users"></i> Who are you?</h2>
                    <p style="color:#555;margin-bottom:16px;font-size:14px;">PIN ${pin} matches multiple profiles. Pick your name:</p>
                    <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:12px;">
                        ${matches.map(p => `
                            <button onclick="selectPlayerFromPinModal('${p.id}')" style="display:flex;justify-content:space-between;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:12px 14px;background:#f9fafb;cursor:pointer;font-weight:600;color:#1f2937;">
                                <span>${p.name}</span>
                                <span style="font-size:12px;color:#666;">HCP ${p.handicap || 0}</span>
                            </button>
                        `).join('')}
                    </div>
                    <button onclick="closePinSelectionModal()" style="width:100%;background:#6c757d;color:#fff;border:none;padding:12px;border-radius:10px;font-weight:600;cursor:pointer;">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function closePinSelectionModal() {
            const modal = document.getElementById('pinSelectionModal');
            if (modal) modal.remove();
        }

        function selectPlayerFromPinModal(playerId) {
            closePinSelectionModal();
            selectPlayer(playerId);
        }
        
        function showBrowsePlayers() {
            const container = document.getElementById('content');
            const playersByTeam = {};
            const noTeam = [];
            
            league.players.forEach(p => {
                if (p.teamId) {
                    if (!playersByTeam[p.teamId]) playersByTeam[p.teamId] = [];
                    playersByTeam[p.teamId].push(p);
                } else {
                    noTeam.push(p);
                }
            });
            
            let playersHtml = '';
            
            league.teams.forEach(team => {
                const teamPlayers = playersByTeam[team.id] || [];
                if (teamPlayers.length > 0) {
                    playersHtml += `<div class="team-group"><div class="team-name"><i class="fas fa-users"></i> ${team.name}</div>`;
                    teamPlayers.forEach(p => {
                        playersHtml += `<div class="player-item" onclick="promptPinForPlayer('${p.id}', '${p.name.replace(/'/g, "\\'")}')"><span>${p.name}</span><span class="hcp">HCP ${p.handicap || 0}</span></div>`;
                    });
                    playersHtml += `</div>`;
                }
            });
            
            if (noTeam.length > 0) {
                playersHtml += `<div class="team-group"><div class="team-name"><i class="fas fa-user"></i> Individual Players</div>`;
                noTeam.forEach(p => {
                    playersHtml += `<div class="player-item" onclick="promptPinForPlayer('${p.id}', '${p.name.replace(/'/g, "\\'")}')"><span>${p.name}</span><span class="hcp">HCP ${p.handicap || 0}</span></div>`;
                });
                playersHtml += `</div>`;
            }
            
            if (league.players.length === 0) {
                playersHtml = `<div class="empty-state"><i class="fas fa-users-slash"></i><p>No players yet. Be the first to register!</p></div>`;
            }
            
            container.innerHTML = `
                <div class="browse-players">
                    <h2><i class="fas fa-list"></i> Select Your Name</h2>
                    <div class="players-list">${playersHtml}</div>
                    <button type="button" class="cancel-btn" onclick="render()"><i class="fas fa-arrow-left"></i> Back</button>
                </div>
            `;
        }
        
        function promptPinForPlayer(playerId, playerName) {
            const player = league.players.find(p => p.id === playerId);
            
            // If player has no PIN, allow them to select themselves without verification
            if (!player.pin) {
                selectPlayer(playerId);
                return;
            }
            
            const modal = document.createElement('div');
            modal.id = 'browsePinModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:12px;padding:30px;max-width:400px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <h2 style="color:#37b24a;margin-bottom:10px;font-size:22px;"><i class="fas fa-key"></i> Enter Your PIN</h2>
                    <p style="color:#666;margin-bottom:20px;font-size:14px;">Hi ${playerName}! Please enter your 4-digit PIN to continue</p>
                    <input type="text" id="browsePinInput" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" 
                           placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" 
                           style="width:100%;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:20px;text-align:center;letter-spacing:8px;margin-bottom:15px;">
                    <div id="browsePinError" style="display:none;color:#e74c3c;font-size:13px;margin-bottom:15px;padding:10px;background:#ffebee;border-radius:6px;"></div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="verifyBrowsePin('${playerId}')" style="flex:1;background:#37b24a;color:#fff;border:none;padding:12px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                        <button onclick="closeBrowsePinModal()" style="flex:1;background:#6c757d;color:#fff;border:none;padding:12px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('browsePinInput').focus(), 100);
        }
        
        function closeBrowsePinModal() {
            const modal = document.getElementById('browsePinModal');
            if (modal) modal.remove();
        }
        
        function verifyBrowsePin(expectedPlayerId) {
            const player = league.players.find(p => p.id === expectedPlayerId);
            
            // If player has no PIN, allow them through directly (no PIN creation needed yet)
            if (player && !player.pin) {
                closeBrowsePinModal();
                selectPlayer(player.id);
                return;
            }
            
            const pin = document.getElementById('browsePinInput').value;
            
            if (player && player.pin === pin) {
                closeBrowsePinModal();
                selectPlayer(player.id);
            } else {
                const errorEl = document.getElementById('browsePinError');
                errorEl.textContent = '‚ùå Incorrect PIN. Please try again.';
                errorEl.style.display = 'block';
                document.getElementById('browsePinInput').value = '';
                document.getElementById('browsePinInput').focus();
            }
        }
        
        function showCreatePinModalForSelection(playerId, playerName) {
            const modal = document.createElement('div');
            modal.id = 'createPinModalSelection';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:12px;padding:30px;max-width:450px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="width:60px;height:60px;background:#37b24a;border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-key" style="color:#fff;font-size:28px;"></i>
                        </div>
                        <h2 style="color:#37b24a;margin-bottom:10px;font-size:24px;">Create Your PIN</h2>
                        <p style="color:#666;font-size:14px;line-height:1.5;">Hi ${playerName}! You were added by an admin. Please create a 4-digit PIN to access your profile.</p>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;">Choose a 4-digit PIN:</label>
                        <input type="text" id="createPinInputSelection" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" 
                               style="width:100%;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:20px;text-align:center;letter-spacing:8px;">
                        <div style="margin-top:8px;font-size:12px;color:#888;">
                            <i class="fas fa-info-circle"></i> Make it memorable - you'll need it to enter scores
                        </div>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;">Confirm PIN:</label>
                        <input type="text" id="confirmPinInputSelection" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" 
                               style="width:100%;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:20px;text-align:center;letter-spacing:8px;">
                    </div>
                    <div id="createPinErrorSelection" style="display:none;color:#e74c3c;font-size:13px;margin-bottom:15px;padding:10px;background:#ffebee;border-radius:6px;text-align:center;"></div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="saveNewPinForSelection('${playerId}')" style="flex:1;background:#37b24a;color:#fff;border:none;padding:15px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">
                            <i class="fas fa-check"></i> Create PIN
                        </button>
                        <button onclick="closeCreatePinModalSelection()" style="background:#6c757d;color:#fff;border:none;padding:15px 20px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('createPinInputSelection').focus(), 100);
        }
        
        function closeCreatePinModalSelection() {
            const modal = document.getElementById('createPinModalSelection');
            if (modal) modal.remove();
        }
        
        function saveNewPinForSelection(playerId) {
            const pin = document.getElementById('createPinInputSelection').value;
            const confirmPin = document.getElementById('confirmPinInputSelection').value;
            const errorEl = document.getElementById('createPinErrorSelection');
            
            // Validation
            if (!pin || pin.length !== 4 || !/^[0-9]{4}$/.test(pin)) {
                errorEl.textContent = '‚ö†Ô∏è PIN must be exactly 4 digits';
                errorEl.style.display = 'block';
                return;
            }
            
            if (pin !== confirmPin) {
                errorEl.textContent = '‚ö†Ô∏è PINs do not match';
                errorEl.style.display = 'block';
                return;
            }
            // Save PIN to player
            const player = league.players.find(p => p.id === playerId);
            const playerIndex = league.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) {
                errorEl.textContent = 'Player not found. Please reload and try again.';
                errorEl.style.display = 'block';
                return;
            }
            player.pin = pin;
            
            const updates = {};
            updates[`players/${playerIndex}/pin`] = pin;
            
            ensureAuth().then(() => leagueRef.update(updates)).then(() => {
                // Close modal
                closeCreatePinModalSelection();
                
                // Show success message
                const successModal = document.createElement('div');
                successModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
                successModal.innerHTML = `
                    <div style="background:#fff;border-radius:12px;padding:40px;max-width:400px;text-align:center;">
                        <div style="width:80px;height:80px;background:#37b24a;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-check" style="color:#fff;font-size:40px;"></i>
                        </div>
                        <h2 style="color:#37b24a;margin-bottom:15px;">PIN Created!</h2>
                        <p style="color:#666;margin-bottom:10px;">Your PIN has been successfully created.</p>
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin:20px 0;">
                            <div style="font-size:13px;color:#888;margin-bottom:5px;">Your PIN</div>
                            <div style="font-size:28px;font-weight:700;color:#37b24a;letter-spacing:8px;">${pin}</div>
                        </div>
                        <p style="color:#e74c3c;font-size:13px;font-weight:600;margin-bottom:20px;">
                            <i class="fas fa-exclamation-triangle"></i> Save this PIN! You'll need it to enter scores in the future.
                        </p>
                        <button onclick="this.parentElement.parentElement.remove(); selectPlayer('${playerId}')" style="width:100%;background:#37b24a;color:#fff;border:none;padding:12px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;">
                            Continue to Score Entry
                        </button>
                    </div>
                `;
                document.body.appendChild(successModal);
            }).catch((error) => {
                console.error('Error saving PIN:', error);
                if (error?.code === 'PERMISSION_DENIED') {
                    errorEl.textContent = 'Access denied. Please contact an admin to adjust database permissions.';
                } else {
                    errorEl.textContent = '‚ùå Failed to save. Please check your connection and try again.';
                }
                errorEl.style.display = 'block';
            });
        }
        
        // Team creation requires payment - show message to users
        function showTeamScorecard() {
            const container = document.getElementById('content');
            container.innerHTML = `
                <div class="registration-form" style="text-align: center;">
                    <div style="width: 70px; height: 70px; background: #37b24a; border-radius: 50%; margin: 0 auto 20px; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-trophy" style="color: #fff; font-size: 30px;"></i>
                    </div>
                    <h2 style="color: #1a1a2e;"><i class="fas fa-users" style="color: #37b24a;"></i> Join the League</h2>
                    <p class="form-desc">To create or join a team, you need to purchase a league membership.</p>
                    <p style="color: #666; font-size: 14px; margin-bottom: 20px;">After purchasing, you'll be able to create your team or join an existing one with a PIN.</p>
                    <a href="membership-signup.html" class="submit-btn" style="display: inline-block; text-decoration: none;"><i class="fas fa-credit-card"></i> Purchase League Membership</a>
                    <button type="button" class="submit-btn" onclick="showExistingTeams()" style="background: #6b7280; margin-top: 10px;"><i class="fas fa-users"></i> I Already Have a Team</button>
                    <button type="button" class="cancel-btn" onclick="render()"><i class="fas fa-arrow-left"></i> Back</button>
                </div>
            `;
        }
        
        function showExistingTeams() {
            const container = document.getElementById('content');
            const teamsWithPlayers = (league.teams || []).map(team => {
                const players = (league.players || []).filter(p => p.teamId === team.id);
                return { ...team, players };
            }).filter(t => t.players.length > 0);
            
            let teamsHtml = '';
            if (teamsWithPlayers.length === 0) {
                teamsHtml = `<div class="empty-state"><i class="fas fa-users-slash"></i><p>No teams available yet.</p><p style="font-size: 13px; color: #888; margin-top: 10px;">Contact an admin to create your team.</p></div>`;
            } else {
                teamsWithPlayers.forEach(team => {
                    const playerNames = team.players.map(p => p.name).join(' & ');
                    const combinedHcp = team.players.reduce((sum, p) => sum + (p.handicap || 0), 0);
                    // Check if team has scores for current round
                    const hasScores = team.players.some(p => {
                        const scores = league.scores?.[roundId]?.[p.id];
                        return scores && Object.keys(scores).some(k => !isNaN(parseInt(k)));
                    });
                    const isSubmitted = team.players.some(p => league.scores?.[roundId]?.[p.id]?.submitted);
                    
                    teamsHtml += `
                        <div class="team-card" onclick="selectTeam('${team.id}')" style="cursor:pointer; background:#fff; border:2px solid ${isSubmitted ? '#37b24a' : '#e8e8e8'}; border-radius:12px; padding:16px; margin-bottom:12px; transition: all 0.2s;">
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <div>
                                    <div style="font-weight:700; color:#1a1a2e; font-size:16px;"><i class="fas fa-users" style="color:#37b24a;"></i> ${team.name}</div>
                                    <div style="color:#666; font-size:14px; margin-top:4px;">${playerNames}</div>
                                    <div style="color:#888; font-size:12px; margin-top:2px;">Combined HCP: ${combinedHcp}</div>
                                </div>
                                <div style="text-align:right;">
                                    ${isSubmitted ? '<span style="background:#37b24a; color:#fff; padding:4px 8px; border-radius:6px; font-size:11px;"><i class="fas fa-check"></i> Submitted</span>' : 
                                      hasScores ? '<span style="background:#f59e0b; color:#fff; padding:4px 8px; border-radius:6px; font-size:11px;">In Progress</span>' : 
                                      '<span style="background:#6b7280; color:#fff; padding:4px 8px; border-radius:6px; font-size:11px;">Not Started</span>'}
                                    <i class="fas fa-chevron-right" style="color:#ccc; margin-left:12px;"></i>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            // Add search if more than 5 teams
            const searchHtml = teamsWithPlayers.length > 5 ? `
                <input type="text" id="teamSearchInput" placeholder="Search teams or players..." 
                    oninput="filterTeams(this.value)"
                    style="width:100%;padding:12px 15px;border:2px solid #e8e8e8;border-radius:10px;font-size:14px;margin-bottom:15px;">
            ` : '';
            
            container.innerHTML = `
                <div class="browse-players">
                    <h2><i class="fas fa-list"></i> Select Your Team</h2>
                    ${searchHtml}
                    <div class="teams-list" id="teamsListContainer" style="margin-top:16px;">${teamsHtml}</div>
                    <button type="button" class="cancel-btn" onclick="render()"><i class="fas fa-arrow-left"></i> Back</button>
                </div>
            `;
            
            // Store teams data for filtering
            window.teamsForFilter = teamsWithPlayers;
        }
        
        function filterTeams(searchTerm) {
            const container = document.getElementById('teamsListContainer');
            const term = searchTerm.toLowerCase().trim();
            
            let filteredTeams = window.teamsForFilter || [];
            if (term) {
                filteredTeams = filteredTeams.filter(team => {
                    const teamName = team.name.toLowerCase();
                    const playerNames = team.players.map(p => p.name.toLowerCase()).join(' ');
                    return teamName.includes(term) || playerNames.includes(term);
                });
            }
            
            if (filteredTeams.length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:30px;color:#888;"><i class="fas fa-search" style="font-size:24px;margin-bottom:10px;display:block;"></i>No teams match "${searchTerm}"</div>`;
                return;
            }
            
            let teamsHtml = '';
            filteredTeams.forEach(team => {
                const playerNames = team.players.map(p => p.name).join(' & ');
                const combinedHcp = team.players.reduce((sum, p) => sum + (p.handicap || 0), 0);
                const hasScores = team.players.some(p => {
                    const scores = league.scores?.[roundId]?.[p.id];
                    return scores && Object.keys(scores).some(k => !isNaN(parseInt(k)));
                });
                const isSubmitted = team.players.some(p => league.scores?.[roundId]?.[p.id]?.submitted);
                
                teamsHtml += `
                    <div class="team-card" onclick="selectTeam('${team.id}')" style="cursor:pointer; background:#fff; border:2px solid ${isSubmitted ? '#37b24a' : '#e8e8e8'}; border-radius:12px; padding:16px; margin-bottom:12px; transition: all 0.2s;">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div>
                                <div style="font-weight:700; color:#1a1a2e; font-size:16px;"><i class="fas fa-users" style="color:#37b24a;"></i> ${team.name}</div>
                                <div style="color:#666; font-size:14px; margin-top:4px;">${playerNames}</div>
                                <div style="color:#888; font-size:12px; margin-top:2px;">Combined HCP: ${combinedHcp}</div>
                            </div>
                            <div style="text-align:right;">
                                ${isSubmitted ? '<span style="background:#37b24a; color:#fff; padding:4px 8px; border-radius:6px; font-size:11px;"><i class="fas fa-check"></i> Submitted</span>' : 
                                  hasScores ? '<span style="background:#f59e0b; color:#fff; padding:4px 8px; border-radius:6px; font-size:11px;">In Progress</span>' : 
                                  '<span style="background:#6b7280; color:#fff; padding:4px 8px; border-radius:6px; font-size:11px;">Not Started</span>'}
                                <i class="fas fa-chevron-right" style="color:#ccc; margin-left:12px;"></i>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = teamsHtml;
        }
        
        function selectTeam(teamId) {
            const team = (league.teams || []).find(t => t.id === teamId);
            const players = (league.players || []).filter(p => p.teamId === teamId);
            if (players.length > 0 && team) {
                // Require PIN verification before accessing team scorecard
                const playerNames = players.map(p => p.name).join(' & ');
                promptTeamPin(teamId, team, playerNames, players);
            }
        }
        
        function promptTeamPin(teamId, team, playerNames, players) {
            const teamName = team.name || 'Team';
            const modal = document.createElement('div');
            modal.id = 'teamPinModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:16px;padding:30px;max-width:420px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="width:60px;height:60px;background:linear-gradient(135deg, #37b24a 0%, #2d9440 100%);border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(55,178,74,0.3);">
                            <i class="fas fa-key" style="color:#fff;font-size:26px;"></i>
                        </div>
                        <h2 style="color:#1a1a2e;margin-bottom:8px;font-size:22px;">Enter Team PIN</h2>
                        <p style="color:#37b24a;font-weight:600;font-size:16px;margin-bottom:4px;">${teamName}</p>
                        <p style="color:#666;font-size:14px;">${playerNames}</p>
                    </div>
                    <div style="margin-bottom:20px;">
                        <input type="text" id="teamPinInput" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" 
                               style="width:100%;padding:18px;border:3px solid #e0e0e0;border-radius:12px;font-size:28px;text-align:center;letter-spacing:12px;font-weight:700;transition:all 0.2s;"
                               onkeyup="if(this.value.length===4) verifyTeamPin('${teamId}')">
                        <p style="text-align:center;font-size:12px;color:#888;margin-top:10px;">
                            <i class="fas fa-info-circle"></i> Enter your 4-digit team PIN
                        </p>
                    </div>
                    <div id="teamPinError" style="display:none;color:#e74c3c;font-size:13px;margin-bottom:15px;padding:12px;background:#ffebee;border-radius:8px;text-align:center;border-left:4px solid #f44336;"></div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="verifyTeamPin('${teamId}')" style="flex:1;background:linear-gradient(135deg, #37b24a 0%, #2d9440 100%);color:#fff;border:none;padding:14px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;box-shadow:0 4px 12px rgba(55,178,74,0.3);">
                            <i class="fas fa-sign-in-alt"></i> Enter Scorecard
                        </button>
                        <button onclick="closeTeamPinModal()" style="background:#f5f5f5;color:#666;border:none;padding:14px 20px;border-radius:10px;font-size:15px;font-weight:600;cursor:pointer;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p style="text-align:center;margin-top:15px;">
                        <a href="#" onclick="showForgotPin(event)" style="color:#888;font-size:12px;text-decoration:none;"><i class="fas fa-question-circle"></i> Forgot your PIN?</a>
                    </p>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Store team PIN for verification
            modal.dataset.teamPin = team.pin || '';
            
            setTimeout(() => {
                const input = document.getElementById('teamPinInput');
                input.focus();
                input.addEventListener('focus', function() {
                    this.style.borderColor = '#37b24a';
                    this.style.boxShadow = '0 0 0 4px rgba(55,178,74,0.15)';
                });
                input.addEventListener('blur', function() {
                    this.style.borderColor = '#e0e0e0';
                    this.style.boxShadow = 'none';
                });
            }, 100);
        }
        
        function showForgotPin(e) {
            e.preventDefault();
            const errorEl = document.getElementById('teamPinError');
            errorEl.innerHTML = '<i class="fas fa-info-circle"></i> Contact an admin or staff member to retrieve your team PIN.';
            errorEl.style.display = 'block';
            errorEl.style.color = '#1976d2';
            errorEl.style.background = '#e3f2fd';
            errorEl.style.borderLeftColor = '#1976d2';
        }
        
        function quickLoginTeam(teamId) {
            const team = (league.teams || []).find(t => t.id === teamId);
            const players = (league.players || []).filter(p => p.teamId === teamId);
            if (players.length > 0 && team) {
                const playerNames = players.map(p => p.name).join(' & ');
                promptTeamPin(teamId, team, playerNames, players);
            }
        }
        
        function closeTeamPinModal() {
            const modal = document.getElementById('teamPinModal');
            if (modal) modal.remove();
        }
        
        function verifyTeamPin(teamId) {
            const modal = document.getElementById('teamPinModal');
            const pin = document.getElementById('teamPinInput').value;
            const errorEl = document.getElementById('teamPinError');
            
            if (!pin || pin.length !== 4) {
                errorEl.textContent = '‚ö†Ô∏è Please enter a 4-digit PIN';
                errorEl.style.display = 'block';
                return;
            }
            
            // Get team PIN from modal data
            const teamPin = modal.dataset.teamPin || '';
            
            // Check if PIN matches team PIN
            if (pin === teamPin) {
                closeTeamPinModal();
                // Select the first player - scores apply to team
                const teamPlayers = (league.players || []).filter(p => p.teamId === teamId);
                if (teamPlayers.length > 0) {
                    selectPlayer(teamPlayers[0].id);
                }
            } else {
                errorEl.innerHTML = '<i class="fas fa-exclamation-circle"></i> Incorrect PIN. Please try again.';
                errorEl.style.display = 'block';
                document.getElementById('teamPinInput').value = '';
                document.getElementById('teamPinInput').focus();
            }
        }

        // Get all team members for the current player
        function getTeamMembers() {
            const currentPlayer = league.players.find(p => p.id === playerId);
            if (!currentPlayer || !currentPlayer.teamId) return [currentPlayer].filter(Boolean);
            return league.players.filter(p => p.teamId === currentPlayer.teamId);
        }
        
        // Get team info
        function getTeamInfo() {
            const currentPlayer = league.players.find(p => p.id === playerId);
            if (!currentPlayer || !currentPlayer.teamId) return null;
            const team = (league.teams || []).find(t => t.id === currentPlayer.teamId);
            const members = getTeamMembers();
            return { team, members };
        }

        function getScores() {
            if (!playerId || !roundId) {
                console.log('getScores: Missing playerId or roundId', { playerId, roundId });
                return {};
            }
            // For team scoring, check if any team member has scores
            const teamMembers = getTeamMembers();
            for (const member of teamMembers) {
                const scores = league.scores?.[roundId]?.[member.id];
                if (scores && Object.keys(scores).some(k => !isNaN(parseInt(k)))) {
                    console.log('getScores result (from team):', { playerId: member.id, roundId, scores });
                    return scores;
                }
            }
            // Fallback to current player's scores
            const scores = league.scores?.[roundId]?.[playerId] || {};
            console.log('getScores result:', { playerId, roundId, scores, leagueScores: league.scores });
            return scores;
        }

        function saveHole(hole, value) {
            const score = parseInt(value) || 0;
            const teamMembers = getTeamMembers();
            
            if (!league.scores) league.scores = {};
            if (!league.scores[roundId]) league.scores[roundId] = {};
            
            // Save score for ALL team members (team scorecard)
            const updates = {};
            teamMembers.forEach(member => {
                if (!league.scores[roundId][member.id]) league.scores[roundId][member.id] = {};
                
                if (score > 0) {
                    league.scores[roundId][member.id][hole] = score;
                } else {
                    delete league.scores[roundId][member.id][hole];
                }
                updates[`scores/${roundId}/${member.id}/${hole}`] = score > 0 ? score : null;
            });

            // Set flag to prevent re-render during score entry
            isEnteringScores = true;
            
            // Use update() instead of set() to avoid triggering full re-render
            ensureAuth().then(() => {
                return leagueRef.update(updates).then(() => {
                    // Reset flag after a short delay
                    setTimeout(() => {
                        isEnteringScores = false;
                    }, 500);
                });
            }).catch(error => {
                console.error('Error saving score:', error);
                if (error?.code === 'PERMISSION_DENIED') {
                    alert('Saving was blocked by database permissions. Please contact an admin.');
                } else {
                    alert('Could not save your score (auth or network issue). Please try again or contact admin.');
                }
                isEnteringScores = false;
            });
            
            updateTotal();
        }

        function updateTotal() {
            const scores = getScores();
            const frontNine = 9; // Front 9 only
            
            let total = 0;
            
            for (let h = 1; h <= frontNine; h++) {
                total += scores[h] || 0;
            }
            
            // For teams, use combined handicap
            const player = league.players.find(p => p.id === playerId);
            const teamMembers = player && player.teamId 
                ? league.players.filter(p => p.teamId === player.teamId) 
                : [player].filter(Boolean);
            const handicap = teamMembers.reduce((sum, p) => sum + (p.handicap || 0), 0);
            const net = total - handicap;
            
            // Update displays
            document.getElementById('total').textContent = total || '-';
            document.getElementById('netVal').textContent = total ? net : '-';
        }

        function submit() {
            // Validate we're within the round's date range
            const round = league.rounds.find(r => r.id === roundId);
            if (round && round.startDate && round.endDate) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const start = new Date(round.startDate);
                const end = new Date(round.endDate);
                start.setHours(0, 0, 0, 0);
                end.setHours(23, 59, 59, 999);
                
                if (today < start) {
                    const startFormatted = start.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    alert(`This round hasn't started yet. Score submission opens on ${startFormatted}.`);
                    return;
                }
                if (today > end) {
                    const endFormatted = end.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    alert(`This round has ended. Score submission closed on ${endFormatted}.`);
                    return;
                }
            }
            
            const scores = getScores();
            const requiredHoles = league.course?.holes || 9;
            
            // Count valid scores for each hole 1 through requiredHoles
            let filled = 0;
            const missingHoles = [];
            
            for (let h = 1; h <= requiredHoles; h++) {
                const score = scores[h] || scores[String(h)];
                const scoreValue = typeof score === 'string' ? parseInt(score) : score;
                
                if (scoreValue && !isNaN(scoreValue) && scoreValue > 0) {
                    filled++;
                } else {
                    missingHoles.push(h);
                }
            }

            console.log('Score validation:', { 
                scores, 
                filled, 
                requiredHoles,
                missingHoles,
                playerId,
                roundId
            });

            // Require ALL holes to be filled
            if (filled < requiredHoles) {
                if (missingHoles.length <= 3) {
                    alert(`Please enter scores for hole${missingHoles.length > 1 ? 's' : ''} ${missingHoles.join(', ')} before submitting.`);
                } else {
                    alert(`Please enter all ${requiredHoles} hole scores before submitting. You're missing ${missingHoles.length} holes.`);
                }
                return;
            }

            // Check if player needs to create a PIN
            const player = league.players.find(p => p.id === playerId);
            if (!player.pin) {
                showCreatePinModal();
                return;
            }

            // Mark as submitted for ALL team members
            const teamMembers = getTeamMembers();
            if (!league.scores) league.scores = {};
            if (!league.scores[roundId]) league.scores[roundId] = {};
            
            const updates = {};
            const submittedAt = new Date().toISOString();
            
            teamMembers.forEach(member => {
                if (!league.scores[roundId][member.id]) league.scores[roundId][member.id] = {};
                league.scores[roundId][member.id].submitted = true;
                league.scores[roundId][member.id].submittedAt = submittedAt;
                updates[`scores/${roundId}/${member.id}/submitted`] = true;
                updates[`scores/${roundId}/${member.id}/submittedAt`] = submittedAt;
            });
            
            ensureAuth().then(() => leagueRef.update(updates)).then(() => {
                window.location.href = 'tournaments.html';
            }).catch((error) => {
                console.error('Error submitting score:', error);
                alert('Failed to submit score. Please check your connection and try again.');
                teamMembers.forEach(member => {
                    league.scores[roundId][member.id].submitted = false;
                    delete league.scores[roundId][member.id].submittedAt;
                });
            });
        }
        
        function showCreatePinModal() {
            const player = league.players.find(p => p.id === playerId);
            const modal = document.createElement('div');
            modal.id = 'createPinModal';
            modal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;padding:20px;';
            modal.innerHTML = `
                <div style="background:#fff;border-radius:12px;padding:30px;max-width:450px;width:100%;box-shadow:0 10px 40px rgba(0,0,0,0.3);">
                    <div style="text-align:center;margin-bottom:20px;">
                        <div style="width:60px;height:60px;background:#37b24a;border-radius:50%;margin:0 auto 15px;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-key" style="color:#fff;font-size:28px;"></i>
                        </div>
                        <h2 style="color:#37b24a;margin-bottom:10px;font-size:24px;">Create Your PIN</h2>
                        <p style="color:#666;font-size:14px;line-height:1.5;">Hi ${player.name}! Before submitting your score, please create a 4-digit PIN. You'll need this PIN to access your scores in the future.</p>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;">Choose a 4-digit PIN:</label>
                        <input type="text" id="createPinInput" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" 
                               style="width:100%;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:20px;text-align:center;letter-spacing:8px;">
                        <div style="margin-top:8px;font-size:12px;color:#888;">
                            <i class="fas fa-info-circle"></i> Make it memorable - you'll need it to enter scores later
                        </div>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="display:block;font-weight:600;margin-bottom:8px;color:#333;">Confirm PIN:</label>
                        <input type="text" id="confirmPinInput" maxlength="4" pattern="[0-9]{4}" inputmode="numeric" 
                               placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="off" 
                               style="width:100%;padding:15px;border:2px solid #ddd;border-radius:8px;font-size:20px;text-align:center;letter-spacing:8px;">
                    </div>
                    <div id="createPinError" style="display:none;color:#e74c3c;font-size:13px;margin-bottom:15px;padding:10px;background:#ffebee;border-radius:6px;text-align:center;"></div>
                    <button onclick="saveNewPin()" style="width:100%;background:#37b24a;color:#fff;border:none;padding:15px;border-radius:8px;font-size:16px;font-weight:600;cursor:pointer;">
                        <i class="fas fa-check"></i> Create PIN & Submit Score
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
            setTimeout(() => document.getElementById('createPinInput').focus(), 100);
        }
        
        function saveNewPin() {
            const pin = document.getElementById('createPinInput').value;
            const confirmPin = document.getElementById('confirmPinInput').value;
            const errorEl = document.getElementById('createPinError');
            
            // Validation
            if (!pin || pin.length !== 4 || !/^[0-9]{4}$/.test(pin)) {
                errorEl.textContent = '‚ö†Ô∏è PIN must be exactly 4 digits';
                errorEl.style.display = 'block';
                return;
            }
            
            if (pin !== confirmPin) {
                errorEl.textContent = '‚ö†Ô∏è PINs do not match';
                errorEl.style.display = 'block';
                return;
            }
            // Save PIN to player
            const player = league.players.find(p => p.id === playerId);
            const playerIndex = league.players.findIndex(p => p.id === playerId);
            player.pin = pin;
            
            // Submit score
            if (!league.scores) league.scores = {};
            if (!league.scores[roundId]) league.scores[roundId] = {};
            if (!league.scores[roundId][playerId]) league.scores[roundId][playerId] = {};
            
            league.scores[roundId][playerId].submitted = true;
            league.scores[roundId][playerId].submittedAt = new Date().toISOString();
            
            // Use update instead of set to avoid overwriting other data
            const updates = {
                [`players/${playerIndex}/pin`]: pin,
                [`scores/${roundId}/${playerId}/submitted`]: true,
                [`scores/${roundId}/${playerId}/submittedAt`]: new Date().toISOString()
            };
            
            ensureAuth().then(() => leagueRef.update(updates)).then(() => {
                // Close modal
                const modal = document.getElementById('createPinModal');
                if (modal) modal.remove();
                
                // Show success message
                const successModal = document.createElement('div');
                successModal.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.9);display:flex;align-items:center;justify-content:center;z-index:10000;';
                successModal.innerHTML = `
                    <div style="background:#fff;border-radius:12px;padding:40px;max-width:400px;text-align:center;">
                        <div style="width:80px;height:80px;background:#37b24a;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;">
                            <i class="fas fa-check" style="color:#fff;font-size:40px;"></i>
                        </div>
                        <h2 style="color:#37b24a;margin-bottom:15px;">Success!</h2>
                        <p style="color:#666;margin-bottom:10px;">Your PIN has been created and your score has been submitted.</p>
                        <div style="background:#f0f0f0;padding:15px;border-radius:8px;margin:20px 0;">
                            <div style="font-size:13px;color:#888;margin-bottom:5px;">Your PIN</div>
                            <div style="font-size:28px;font-weight:700;color:#37b24a;letter-spacing:8px;">${pin}</div>
                        </div>
                        <p style="color:#e74c3c;font-size:13px;font-weight:600;margin-bottom:20px;">
                            <i class="fas fa-exclamation-triangle"></i> Save this PIN! You'll need it to enter scores in the future.
                        </p>
                        <button onclick="this.parentElement.parentElement.remove(); selectPlayer('${playerId}'); render();" style="width:100%;background:#37b24a;color:#fff;border:none;padding:12px;border-radius:8px;font-size:15px;font-weight:600;cursor:pointer;">
                            Back to Scorecard
                        </button>
                    </div>
                `;
                document.body.appendChild(successModal);
            }).catch((error) => {
                console.error('Error saving PIN and submitting score:', error);
                errorEl.textContent = '‚ùå Failed to save. Please check your connection and try again.';
                errorEl.style.display = 'block';
            });
        }

        init();
    </script>
</body>
</html>


